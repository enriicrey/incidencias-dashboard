<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard T√©cnico - Sistema de Incidencias ABC.xyz</title>
    <style>
        /* ========================================
           VARIABLES CSS Y RESET
        ======================================== */
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --success-color: #22c55e;
            --success-dark: #16a34a;
            --warning-color: #f59e0b;
            --warning-dark: #d97706;
            --danger-color: #ef4444;
            --danger-dark: #dc2626;
            --info-color: #3b82f6;
            --purple-color: #6f42c1;
            --purple-dark: #5a2d91;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-800: #1f2937;
            --border-radius: 12px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.15);
            --transition: all 0.3s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-800);
        }

        /* ========================================
           LOGIN COMPONENTS
        ======================================== */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow-md);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .input-group { margin-bottom: 20px; text-align: left; }

        .input-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--gray-800);
        }

        .input-field {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .verify-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .verify-btn:hover { transform: translateY(-2px); }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
        }

        .hidden { display: none !important; }

        /* ========================================
           DASHBOARD COMPONENTS
        ======================================== */
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px 0;
            box-shadow: var(--shadow-md);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo { font-size: 24px; font-weight: 700; }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .refresh-button {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .refresh-button:hover { background: rgba(255, 255, 255, 0.25); }

        /* ========================================
           MAIN CONTAINER
        ======================================== */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Stats Bar - Solo 3 estados reales */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .stat-card:hover { transform: translateY(-2px); }
        .stat-card.active { border-color: var(--primary-color); }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-number.pending { color: var(--warning-color); }
        .stat-number.working { color: var(--info-color); }
        .stat-number.seguimiento { color: #6b7280; }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ========================================
           INCIDENTS SECTION
        ======================================== */
        .incidents-section {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .section-header {
            background: var(--gray-50);
            padding: 20px 30px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-800);
        }

        .loading-spinner {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        /* Incident Cards */
        .incident-card {
            border-bottom: 1px solid #e5e7eb;
            padding: 24px 30px;
            transition: var(--transition);
        }

        .incident-card:hover { background: var(--gray-50); }
        .incident-card:last-child { border-bottom: none; }

        .incident-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .incident-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 4px;
        }

        .incident-meta {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .priority-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-critica { background: #fee2e2; color: #dc2626; }
        .priority-alta { background: #fed7aa; color: #ea580c; }
        .priority-media { background: #fef3c7; color: #d97706; }
        .priority-baja { background: #dcfce7; color: #16a34a; }

        .state-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .state-pending { background: #fef3c7; color: #92400e; }
        .state-working { background: #dbeafe; color: #1e40af; }
        .state-seguimiento { background: #f3f4f6; color: #6b7280; }

        /* SLA Timer */
        .sla-timer {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            color: #0c4a6e;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .sla-timer.danger {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }

        .working-timer {
            background: #f0fdf4;
            color: #166534;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Notification Badges */
        .notification-badges {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .notification-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        /* Action Buttons */
        .incident-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-success { background: var(--success-color); color: white; }
        .btn-success:hover { background: var(--success-dark); }

        .btn-danger { background: var(--danger-color); color: white; }
        .btn-danger:hover { background: var(--danger-dark); }

        .btn-warning { background: var(--warning-color); color: white; }
        .btn-warning:hover { background: var(--warning-dark); }

        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }

        .btn-purple { background: var(--purple-color); color: white; }
        .btn-purple:hover { background: var(--purple-dark); }

        .btn-info { background: var(--info-color); color: white; }
        .btn-secondary { background: #6b7280; color: white; }

        /* ========================================
           MODAL COMPONENTS
        ======================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 24px 30px 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-800);
        }

        .modal-body { padding: 24px 30px; }

        .modal-footer {
            padding: 20px 30px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .form-group { margin-bottom: 20px; }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--gray-800);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .reason-option {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .reason-option:hover { border-color: var(--primary-color); }
        .reason-option.selected { border-color: var(--primary-color); background: #f0f9ff; }

        .reason-icon { font-size: 20px; margin-right: 12px; }

        .no-incidents {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .no-incidents-icon { font-size: 48px; margin-bottom: 16px; }

        /* ========================================
           RESPONSIVE DESIGN
        ======================================== */
        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 16px; }
            .user-info { flex-direction: column; gap: 8px; }
            .stats-bar { grid-template-columns: 1fr; }
            .incident-header { flex-direction: column; gap: 12px; }
            .incident-actions { justify-content: center; }
            .modal { width: 95%; }
        }
    </style>
</head>
<body>
    <!-- LOGIN CONTAINER -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <h1 class="login-title">üîß Dashboard T√©cnico</h1>
            <p class="login-subtitle">Sistema de Incidencias ABC.xyz</p>

            <div class="input-group">
                <label class="input-label" for="emailInput">Email corporativo</label>
                <input type="email" id="emailInput" class="input-field" placeholder="tecnico@abc.xyz" autocomplete="email">
            </div>

            <button class="verify-btn" onclick="loginWithPIN()">Acceder con PIN</button>

            <div id="loginError" class="error-message hidden">
                Error de autenticaci√≥n. Verifica tus credenciales.
            </div>
        </div>
    </div>

    <!-- DASHBOARD PRINCIPAL -->
    <div id="dashboardContainer" class="hidden">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">üîß Dashboard T√©cnico - Sistema ABC.xyz</div>
                <div class="user-info">
                    <div id="technicianName">Cargando t√©cnico...</div>
                    <span id="userEmail">usuario@abc.xyz</span>
                    <span>|</span>
                    <span id="userRole">T√©cnico L0</span>
                    <button class="refresh-button" onclick="refreshDashboard()">üîÑ Actualizar</button>
                </div>
            </div>
        </header>

        <!-- Main Container -->
        <main class="main-container">
            <!-- Stats Bar -->
            <section class="stats-bar">
                <div class="stat-card active" onclick="filterByStatus('all', this)">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card" onclick="filterByStatus('pending', this)">
                    <div class="stat-number pending" id="pendingCount">0</div>
                    <div class="stat-label">Pendientes</div>
                </div>
                <div class="stat-card" onclick="filterByStatus('working', this)">
                    <div class="stat-number working" id="workingCount">0</div>
                    <div class="stat-label">Trabajando</div>
                </div>
                <div class="stat-card" onclick="filterByStatus('seguimiento', this)">
                    <div class="stat-number seguimiento" id="seguimientoCount">0</div>
                    <div class="stat-label">Seguimiento</div>
                </div>
            </section>

            <!-- Incidents Section -->
            <section class="incidents-section">
                <div class="section-header">
                    <h2>üìã Incidencias Asignadas</h2>
                </div>
                <div id="incidentsContainer">
                    <div class="loading-spinner">üîÑ Cargando incidencias...</div>
                </div>
            </section>
        </main>
    </div>

    <!-- ========================================
         MODALES
    ======================================== -->

    <!-- Modal de Motivo Rechazo -->
    <div id="reasonModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">‚ùå Motivo del Rechazo</h3>
            </div>
            <div class="modal-body">
                <div id="reasonOptions"></div>
                <div class="form-group">
                    <label for="customReasonText" class="form-label">Descripci√≥n adicional (opcional):</label>
                    <textarea id="customReasonText" class="form-control" rows="3" placeholder="Proporciona m√°s detalles si es necesario..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('reasonModal')">Cancelar</button>
                <button id="confirmBtn" class="btn btn-danger" onclick="confirmAction()">Confirmar Rechazo</button>
            </div>
        </div>
    </div>

    <!-- Modal de Resoluci√≥n -->
    <div id="resolverModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3>üîß Resolver Incidencia</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="solutionDescription" class="form-label">Descripci√≥n de la soluci√≥n:</label>
                    <textarea id="solutionDescription" class="form-control" rows="4" placeholder="Describe detalladamente c√≥mo se resolvi√≥ la incidencia..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="materialsUsed" class="form-label">Materiales utilizados (opcional):</label>
                    <textarea id="materialsUsed" class="form-control" rows="2" placeholder="Lista los materiales consumidos durante la reparaci√≥n..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('resolverModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmResolver()">üîß Resolver Incidencia</button>
            </div>
        </div>
    </div>

    <!-- Modal de Solicitar Materiales -->
    <div id="materialesModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3>üì¶ Solicitar Materiales</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="materialName" class="form-label">Material necesario:</label>
                    <input type="text" id="materialName" class="form-control" placeholder="Ej: Rodamiento SKF 6203" required>
                </div>
                <div class="form-group">
                    <label for="materialQuantity" class="form-label">Cantidad:</label>
                    <input type="number" id="materialQuantity" class="form-control" min="1" value="1" required>
                </div>
                <div class="form-group">
                    <label for="materialConsumptionType" class="form-label">Tipo de consumo:</label>
                    <select id="materialConsumptionType" class="form-control" required>
                        <option value="">-- Selecciona tipo --</option>
                        <option value="consumible">üî¥ Consumible (se resta stock al usar)</option>
                        <option value="repuesto">üü† Repuesto (se resta stock al instalar)</option>
                        <option value="reutilizable">üü¢ Reutilizable (no se resta stock)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="materialUrgency" class="form-label">Urgencia:</label>
                    <select id="materialUrgency" class="form-control" required>
                        <option value="critica">üî¥ Cr√≠tica - Producci√≥n parada</option>
                        <option value="alta">üü† Alta - Riesgo de parada</option>
                        <option value="media" selected>üü° Media - Planificada</option>
                        <option value="baja">üü¢ Baja - Preventiva</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="materialJustification" class="form-label">Justificaci√≥n:</label>
                    <textarea id="materialJustification" class="form-control" rows="3" placeholder="Explica por qu√© necesitas este material..." required></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="workCanContinue">
                        Puedo continuar trabajando mientras llegan los materiales
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('materialesModal')">Cancelar</button>
                <button class="btn btn-purple" onclick="confirmSolicitudMateriales()">üì¶ Solicitar Materiales</button>
            </div>
        </div>
    </div>

    <!-- Modal de Ayuda/Gestionar -->
    <div id="ayudaModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3>üõ†Ô∏è Ayuda y Gesti√≥n</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="tipoAyuda" class="form-label">Selecciona una opci√≥n:</label>
                    <select id="tipoAyuda" class="form-control" onchange="updateAyudaOptions()" required>
                        <option value="">-- Selecciona --</option>
                        <optgroup label="üìã Informaci√≥n y Seguimiento">
                            <option value="aportar_informacion">üìù Aportar informaci√≥n adicional</option>
                            <option value="revisar_materiales">üìä Revisar estado materiales solicitados</option>
                            <option value="revisar_historial">üîç Revisar historial del componente</option>
                        </optgroup>
                        <optgroup label="üîÑ Transferencias">
                            <option value="derivar_departamento">üè¢ Derivar a otro departamento</option>
                            <option value="fin_de_turno">üïê Fin de turno (‚â§ 15min restantes)</option>
                        </optgroup>
                        <optgroup label="üÜò Solicitar Apoyo">
                            <option value="apoyo_segundo_tecnico">üë• Solicitar segundo t√©cnico</option>
                            <option value="segunda_opinion">ü§î Necesito segunda opini√≥n</option>
                            <option value="apoyo_supervisor">üìû Apoyo directo supervisor</option>
                        </optgroup>
                    </select>
                </div>
                <div id="ayudaExtraFields"></div>
                <div class="form-group">
                    <label for="ayudaDescripcion" class="form-label">Descripci√≥n:</label>
                    <textarea id="ayudaDescripcion" class="form-control" rows="3" placeholder="Proporciona detalles sobre lo que necesitas..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('ayudaModal')">Cancelar</button>
                <button class="btn btn-warning" onclick="procesarAyuda()">üõ†Ô∏è Continuar</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        //  VARIABLES GLOBALES
        // ========================================
        let currentTechnician = null;
        let allIncidents = [];
        let currentStatusFilter = 'all';
        let pendingAction = null;
        let selectedReason = null;
        let currentIncidentId = null;

        // ========================================
        //  VARIABLES PARA ACCESO DIRECTO
        // ========================================
        let directIncidentId = null;
        let pendingActionData = {};

        // ========================================
        //  AUTENTICACI√ìN Y LOGIN
        // ========================================
        async function loginWithPIN() {
            const email = document.getElementById('emailInput').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            if (!email) {
                errorDiv.textContent = 'Ingresa tu email corporativo';
                errorDiv.classList.remove('hidden');
                return;
            }

            // Mostrar modal PIN
            showPINModal(email);
        }

        function showPINModal(email) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'pinModal';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>üîê Verificaci√≥n de Identidad</h3>
                    </div>
                    <div class="modal-body">
                        <p>Ingresa tu PIN de 4 d√≠gitos para confirmar tu identidad:</p>
                        <div class="form-group">
                            <label class="form-label">PIN:</label>
                            <input type="password" id="pinInput" class="form-control" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="text-align: center; font-size: 18px; letter-spacing: 4px;">
                        </div>
                        <div id="pinError" class="error-message hidden"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closePINModal()">Cancelar</button>
                        <button class="btn btn-primary" id="verifyPinBtn" onclick="verifyPIN('${email}')" disabled>Verificar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const pinInput = document.getElementById('pinInput');
            const verifyBtn = document.getElementById('verifyPinBtn');
            
            pinInput.focus();
            
            pinInput.oninput = function() {
                verifyBtn.disabled = this.value.length !== 4;
            };
            
            pinInput.onkeypress = function(e) {
                if (e.key === 'Enter' && this.value.length === 4) {
                    verifyPIN(email);
                }
                // Solo permitir n√∫meros
                if (!/[0-9]/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'Tab') {
                    e.preventDefault();
                }
            };
        }

        async function verifyPIN(email) {
            const pin = document.getElementById('pinInput').value;
            const pinError = document.getElementById('pinError');
            
            if (pin.length !== 4) {
                showPINError('PIN debe tener 4 d√≠gitos');
                return;
            }

            try {
                const response = await fetch('/api/webhook-respuesta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'validate_pin',
                        technician_email: email,
                        pin: pin
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    currentTechnician = {
                        email: email,
                        name: data.technician?.name || email.split('@')[0],
                        department: data.technician?.department || 'Mtto-Mec√°nico',
                        authenticated: true,
                        pin: pin // Guardar PIN para futuras acciones
                    };

                    // Actualizar UI
                    document.getElementById('technicianName').textContent = currentTechnician.name;
                    document.getElementById('userEmail').textContent = email;
                    document.getElementById('userRole').textContent = `${currentTechnician.department}`;
                    
                    // Cerrar modal PIN y login
                    closePINModal();
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('dashboardContainer').classList.remove('hidden');
                    
                    // Si hay acci√≥n pendiente (acceso directo), ejecutarla
                    if (pendingAction) {
                        await handleAction(pendingAction, directIncidentId, pendingActionData);
                        pendingAction = null;
                        directIncidentId = null;
                        pendingActionData = {};
                    }
                    
                    // Cargar incidencias
                    loadDashboard();
                } else {
                    showPINError(data.message || 'PIN incorrecto');
                }
            } catch (error) {
                console.error('Error verificando PIN:', error);
                showPINError('Error de conexi√≥n');
            }
        }

        function showPINError(message) {
            const pinError = document.getElementById('pinError');
            pinError.textContent = message;
            pinError.classList.remove('hidden');
        }

        function closePINModal() {
            const modal = document.getElementById('pinModal');
            if (modal) {
                modal.remove();
            }
        }

        // ========================================
        //  CARGA DE DATOS
        // ========================================
        async function loadDashboard() {
            if (!currentTechnician?.authenticated) return;

            showLoadingState();

            try {
                const response = await fetch(`/api/webhook-respuesta?action=get_assigned_incidents&technician_email=${encodeURIComponent(currentTechnician.email)}`);
                const data = await response.json();
                
                if (data.status === 'success' && data.incidents) {
                    allIncidents = data.incidents;
                    updateStatistics();
                    renderIncidents();
                } else {
                    throw new Error(data.message || 'Error al cargar incidencias');
                }
            } catch (error) {
                console.error('Error cargando dashboard:', error);
                showErrorState(error.message);
            }
        }

        function refreshDashboard() {
            loadDashboard();
        }

        // ========================================
        //  GESTI√ìN DE ESTADOS Y FILTROS
        // ========================================
        function getIncidentRealState(incident, technicianEmail) {
            const escalationLevel = parseInt(incident.escalation_level) || 0;
            const now = new Date();
            
            // Verificar si est√° asignado actualmente en alg√∫n nivel
            const currentAssignments = [
                { level: 0, tech: incident.l0_technician, response: incident.l0_response, sla: incident.sla_l0_end },
                { level: 1, tech: incident.l1_technician, response: incident.l1_response, sla: incident.sla_l1_backup_end },
                { level: 2, tech: incident.l2_technicians, response: incident.l2_responses, sla: incident.sla_l2_equipo_end }
            ];

            // Buscar asignaci√≥n actual
            const currentAssignment = currentAssignments.find(assign => 
                assign.level === escalationLevel && 
                (assign.tech === technicianEmail || (assign.tech && assign.tech.includes(technicianEmail)))
            );

            if (currentAssignment) {
                // Si acept√≥, est√° trabajando
                if (currentAssignment.response === 'acepto' || currentAssignment.response === '‚úÖ Acepto') {
                    return 'working';
                }
                
                // Si no ha respondido y SLA v√°lido
                if (currentAssignment.response === '‚≠ï Sin Respuesta' && currentAssignment.sla) {
                    const slaDeadline = new Date(currentAssignment.sla);
                    if (now <= slaDeadline) {
                        return 'pending';
                    }
                }
            }

            // Si fue asignado antes o rechaz√≥
            const wasAssignedBefore = currentAssignments.some(assign => 
                assign.tech === technicianEmail && assign.response && assign.response !== '‚≠ï Sin Respuesta'
            );

            return wasAssignedBefore ? 'seguimiento' : 'other';
        }

        function filterByStatus(status, element) {
            currentStatusFilter = status;
            
            // Actualizar estado activo
            document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));
            element.classList.add('active');
            
            renderIncidents();
        }

        function updateStatistics() {
            const technicianEmail = currentTechnician?.email || '';
            
            const relevantIncidents = allIncidents.filter(incident => {
                const state = getIncidentRealState(incident, technicianEmail);
                return ['pending', 'working', 'seguimiento'].includes(state);
            });

            const stats = {
                total: relevantIncidents.length,
                pending: relevantIncidents.filter(i => getIncidentRealState(i, technicianEmail) === 'pending').length,
                working: relevantIncidents.filter(i => getIncidentRealState(i, technicianEmail) === 'working').length,
                seguimiento: relevantIncidents.filter(i => getIncidentRealState(i, technicianEmail) === 'seguimiento').length
            };

            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('pendingCount').textContent = stats.pending;
            document.getElementById('workingCount').textContent = stats.working;
            document.getElementById('seguimientoCount').textContent = stats.seguimiento;
        }

        // ========================================
        //  RENDERIZADO DE INCIDENCIAS
        // ========================================
        function renderIncidents() {
            const container = document.getElementById('incidentsContainer');
            const technicianEmail = currentTechnician?.email || '';
            
            const relevantIncidents = allIncidents.filter(incident => {
                const state = getIncidentRealState(incident, technicianEmail);
                if (currentStatusFilter === 'all') {
                    return ['pending', 'working', 'seguimiento'].includes(state);
                }
                return state === currentStatusFilter;
            });

            if (relevantIncidents.length === 0) {
                container.innerHTML = `
                    <div class="no-incidents">
                        <div class="no-incidents-icon">üìã</div>
                        <h3>No hay incidencias</h3>
                        <p>No tienes incidencias ${currentStatusFilter === 'all' ? '' : 'en estado ' + currentStatusFilter} asignadas</p>
                    </div>
                `;
                return;
            }

            const incidentsHTML = relevantIncidents.map(incident => renderIncidentCard(incident, technicianEmail)).join('');
            container.innerHTML = incidentsHTML;
        }

        function renderIncidentCard(incident, technicianEmail) {
            const state = getIncidentRealState(incident, technicianEmail);
            const priorityClass = getPriorityClass(incident.priority);
            const priority = cleanPriority(incident.priority);
            
            return `
                <div class="incident-card" data-incident-id="${incident.id}">
                    <div class="incident-header">
                        <div>
                            <div class="incident-title">${incident.equipment || 'Equipo no especificado'}</div>
                            <div class="incident-meta">
                                <span>üìç ${incident.zone || 'Zona no especificada'}</span>
                                <span>üÜî ${incident.id}</span>
                                <span>üìÖ ${formatDate(incident.occurrence_date)}</span>
                                ${renderSLATimer(incident, state)}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div class="priority-badge priority-${priorityClass}">${priority}</div>
                            <div class="state-badge state-${state}">${getStateLabel(state)}</div>
                        </div>
                    </div>
                    <div class="incident-description" style="margin-bottom: 12px;">
                        ${incident.description || 'Sin descripci√≥n disponible'}
                    </div>
                    ${renderNotificationBadges(incident)}
                    ${renderActionButtons(incident, state)}
                </div>
            `;
        }

        function renderNotificationBadges(incident) {
            if (!incident.active_notifications || incident.active_notifications.length === 0) {
                return '';
            }

            const badgeTemplates = {
                // Materiales
                'material_approved': 'üü¢ Materiales autorizados',
                'material_rejected': 'üî¥ Materiales rechazados',
                'material_insufficient_stock': 'üìû Contactar almac√©n - Stock insuficiente',
                'material_pending_supervisor': 'üü° Pendiente validaci√≥n supervisor',
                
                // Derivaci√≥n
                'derivation_approved': '‚úÖ Derivaci√≥n aprobada',
                'derivation_rejected': '‚ùå Derivaci√≥n rechazada - Continuar',
                'derivation_pending': 'üü° Derivaci√≥n pendiente validaci√≥n',
                
                // Resoluci√≥n
                'resolution_blocked': 'üö´ No puede resolver - Materiales sin validar',
                'incident_closed': '‚úÖ Incidencia cerrada por supervisor',
                'solution_rejected': 'üîÑ Reabierta - Completar soluci√≥n'
            };

            const badges = incident.active_notifications.map(notif => `
                <div class="notification-badge" style="background: ${getNotificationColor(notif.type)};">
                    ${badgeTemplates[notif.type] || notif.message}
                </div>
            `).join('');

            return `<div class="notification-badges">${badges}</div>`;
        }

        function getNotificationColor(type) {
            const colors = {
                'material_approved': '#22c55e',
                'derivation_approved': '#22c55e',
                'incident_closed': '#22c55e',
                'material_rejected': '#ef4444',
                'derivation_rejected': '#ef4444',
                'solution_rejected': '#f59e0b',
                'material_insufficient_stock': '#dc2626',
                'material_pending_supervisor': '#f59e0b',
                'derivation_pending': '#f59e0b',
                'resolution_blocked': '#6b7280'
            };
            return colors[type] || '#6b7280';
        }

        function renderActionButtons(incident, state) {
            if (state === 'pending') {
                return `
                    <div class="incident-actions">
                        <button class="btn btn-success" onclick="handleAction('acepto', '${incident.id}')">‚úÖ ACEPTO</button>
                        <button class="btn btn-danger" onclick="showReasonModal('rechazo', '${incident.id}')">‚ùå RECHAZO</button>
                    </div>
                `;
            } else if (state === 'working') {
                return `
                    <div class="incident-actions">
                        <button class="btn btn-primary" onclick="showResolverModal('${incident.id}')">üîß RESOLVER</button>
                        <button class="btn btn-purple" onclick="showMaterialesModal('${incident.id}')">üì¶ MATERIALES</button>
                        <button class="btn btn-warning" onclick="showAyudaModal('${incident.id}')">üõ†Ô∏è AYUDA/GESTIONAR</button>
                    </div>
                `;
            } else if (state === 'seguimiento') {
                return `
                    <div class="incident-actions">
                        <button class="btn btn-info" onclick="handleAction('solicitar_asignacion', '${incident.id}')">üôã‚Äç‚ôÇÔ∏è SOLICITAR ASIGNACI√ìN</button>
                    </div>
                `;
            }
            return '';
        }

        // ========================================
        //  GESTI√ìN DE MODALES
        // ========================================
        function showReasonModal(action, incidentId) {
            currentIncidentId = incidentId;
            pendingAction = action;
            
            const modal = document.getElementById('reasonModal');
            const title = document.getElementById('modalTitle');
            const options = document.getElementById('reasonOptions');
            
            title.textContent = '‚ùå Motivo del Rechazo';
            
            const rejectReasons = [
                { id: 'no_herramientas', title: 'üîß No tengo herramientas necesarias', description: 'Faltan herramientas espec√≠ficas' },
                { id: 'no_conocimiento', title: 'üìö No tengo conocimiento t√©cnico', description: 'Requiere conocimientos especializados' },
                { id: 'fuera_horario', title: 'üïê Fuera de horario laboral', description: 'Asignada fuera del turno de trabajo' },
                { id: 'sobrecarga', title: 'üìä Sobrecarga de trabajo', description: 'Trabajando en m√∫ltiples incidencias' },
                { id: 'ubicacion_lejana', title: 'üìç Ubicaci√≥n lejana', description: 'Fuera de zona de cobertura' },
                { id: 'otro', title: 'üí¨ Otro motivo', description: 'Especificar motivo', requiresText: true }
            ];

            options.innerHTML = rejectReasons.map(reason => `
                <div class="reason-option" onclick="selectReason('${reason.id}')">
                    <div style="display: flex; align-items: center;">
                        <span class="reason-icon">${reason.title.split(' ')[0]}</span>
                        <div>
                            <div style="font-weight: 600;">${reason.title.substring(2)}</div>
                            <div style="font-size: 14px; color: #6b7280;">${reason.description}</div>
                        </div>
                    </div>
                </div>
            `).join('');

            modal.classList.remove('hidden');
        }

        function showResolverModal(incidentId) {
            currentIncidentId = incidentId;
            document.getElementById('resolverModal').classList.remove('hidden');
        }

        function showMaterialesModal(incidentId) {
            currentIncidentId = incidentId;
            document.getElementById('materialesModal').classList.remove('hidden');
        }

        function showAyudaModal(incidentId) {
            currentIncidentId = incidentId;
            document.getElementById('ayudaModal').classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            // Reset forms
            document.querySelectorAll(`#${modalId} input, #${modalId} textarea, #${modalId} select`).forEach(input => {
                if (input.type === 'checkbox') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });
            selectedReason = null;
            currentIncidentId = null;
        }

        function selectReason(reasonId) {
            selectedReason = reasonId;
            document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
            event.target.closest('.reason-option').classList.add('selected');
        }

        // ========================================
        //  ACCIONES PRINCIPALES CON PIN
        // ========================================
        async function handleAction(action, incidentId, extraData = {}) {
            if (!currentTechnician?.authenticated) {
                alert('Debes estar autenticado para realizar acciones');
                return;
            }

            // Si no hay PIN guardado, solicitarlo
            if (!currentTechnician.pin) {
                pendingAction = action;
                directIncidentId = incidentId;
                pendingActionData = extraData;
                
                // Solicitar PIN para la acci√≥n
                showActionPINModal(action, incidentId);
                return;
            }

            const payload = {
                action: action,
                incident_id: incidentId,
                technician_email: currentTechnician.email,
                pin: currentTechnician.pin,  // ‚úÖ Incluir PIN en todas las acciones
                timestamp: new Date().toISOString(),
                ...extraData
            };

            try {
                const response = await fetch('/api/webhook-respuesta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    showNotification(`‚úÖ ${getActionMessage(action)}`, 'success');
                    loadDashboard(); // Recargar datos
                } else {
                    showNotification(`‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Error en acci√≥n:', error);
                showNotification('‚ùå Error de conexi√≥n', 'error');
            }
        }

        function showActionPINModal(action, incidentId) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'actionPinModal';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>üîê Confirmar Acci√≥n</h3>
                    </div>
                    <div class="modal-body">
                        <p>Para realizar la acci√≥n <strong>${getActionMessage(action)}</strong>, confirma tu PIN:</p>
                        <div class="form-group">
                            <label class="form-label">PIN:</label>
                            <input type="password" id="actionPinInput" class="form-control" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="text-align: center; font-size: 18px; letter-spacing: 4px;">
                        </div>
                        <div id="actionPinError" class="error-message hidden"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeActionPINModal()">Cancelar</button>
                        <button class="btn btn-primary" id="confirmActionBtn" onclick="confirmActionWithPIN()" disabled>Confirmar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const pinInput = document.getElementById('actionPinInput');
            const confirmBtn = document.getElementById('confirmActionBtn');
            
            pinInput.focus();
            
            pinInput.oninput = function() {
                confirmBtn.disabled = this.value.length !== 4;
            };
            
            pinInput.onkeypress = function(e) {
                if (e.key === 'Enter' && this.value.length === 4) {
                    confirmActionWithPIN();
                }
                if (!/[0-9]/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'Tab') {
                    e.preventDefault();
                }
            };
        }

        async function confirmActionWithPIN() {
            const pin = document.getElementById('actionPinInput').value;
            
            if (pin.length !== 4) {
                document.getElementById('actionPinError').textContent = 'PIN debe tener 4 d√≠gitos';
                document.getElementById('actionPinError').classList.remove('hidden');
                return;
            }

            // Guardar PIN y ejecutar acci√≥n
            currentTechnician.pin = pin;
            closeActionPINModal();
            
            // Ejecutar acci√≥n pendiente
            await handleAction(pendingAction, directIncidentId, pendingActionData);
        }

        function closeActionPINModal() {
            const modal = document.getElementById('actionPinModal');
            if (modal) {
                modal.remove();
            }
        }

        function confirmAction() {
            if (!selectedReason || !currentIncidentId) return;
            
            const customText = document.getElementById('customReasonText').value.trim();
            
            handleAction(pendingAction, currentIncidentId, {
                reject_reason: selectedReason,
                custom_reason: customText
            });
            
            closeModal('reasonModal');
        }

        function confirmResolver() {
            const solution = document.getElementById('solutionDescription').value.trim();
            const materials = document.getElementById('materialsUsed').value.trim();
            
            if (!solution) {
                alert('Describe la soluci√≥n implementada');
                return;
            }

            // Verificar si hay materiales pendientes de validaci√≥n
            const incident = allIncidents.find(i => i.id === currentIncidentId);
            const hasPendingMaterials = incident?.active_notifications?.some(notif => 
                notif.type === 'material_pending_supervisor' || 
                notif.type === 'resolution_blocked'
            );

            if (hasPendingMaterials) {
                alert('‚ùå No puedes resolver la incidencia\n\nTienes materiales pendientes de validaci√≥n por el supervisor.\nEspera la aprobaci√≥n o contacta directamente al supervisor.');
                return;
            }
            
            handleAction('resolver', currentIncidentId, {
                solution_description: solution,
                materials_used: materials
            });
            
            closeModal('resolverModal');
        }

        function confirmSolicitudMateriales() {
            const material = document.getElementById('materialName').value.trim();
            const quantity = document.getElementById('materialQuantity').value;
            const urgency = document.getElementById('materialUrgency').value;
            const justification = document.getElementById('materialJustification').value.trim();
            const canContinue = document.getElementById('workCanContinue').checked;
            const consumptionType = document.getElementById('materialConsumptionType').value;
            
            if (!material || !quantity || !justification || !consumptionType) {
                alert('Completa todos los campos requeridos');
                return;
            }
            
            handleAction('solicitar_materiales', currentIncidentId, {
                material_name: material,
                quantity: parseInt(quantity),
                urgency: urgency,
                justification: justification,
                can_continue_working: canContinue,
                consumption_type: consumptionType
            });
            
            closeModal('materialesModal');
        }

        function updateAyudaOptions() {
            const tipoAyuda = document.getElementById('tipoAyuda').value;
            const extraFields = document.getElementById('ayudaExtraFields');
            
            // Campos espec√≠ficos seg√∫n el tipo de ayuda
            const fieldTemplates = {
                derivar_departamento: `
                    <div class="form-group">
                        <label class="form-label">Departamento destino:</label>
                        <select id="departamentoDestino" class="form-control" required>
                            <option value="">Selecciona departamento</option>
                            <option value="Mtto-Mec√°nico">Mantenimiento Mec√°nico</option>
                            <option value="Mtto-El√©ctrico">Mantenimiento El√©ctrico</option>
                            <option value="Instrumentaci√≥n">Instrumentaci√≥n</option>
                            <option value="Calidad">Control de Calidad</option>
                        </select>
                    </div>
                `,
                fin_de_turno: `
                    <div class="form-group">
                        <label class="form-label">Tiempo restante en turno:</label>
                        <select id="tiempoRestante" class="form-control" required>
                            <option value="5">5 minutos</option>
                            <option value="10">10 minutos</option>
                            <option value="15">15 minutos</option>
                        </select>
                        <small style="color: #dc2626; font-weight: 600;">‚ö†Ô∏è Solo disponible en los √∫ltimos 15 minutos del turno</small>
                        <div style="margin-top: 8px; padding: 8px; background: #f3f4f6; border-radius: 4px; font-size: 12px;">
                            <strong>Turnos:</strong> 6-14h | 14-22h | 22-6h
                        </div>
                    </div>
                `
            };
            
            extraFields.innerHTML = fieldTemplates[tipoAyuda] || '';
        }

        function procesarAyuda() {
            const tipoAyuda = document.getElementById('tipoAyuda').value;
            const descripcion = document.getElementById('ayudaDescripcion').value.trim();
            
            if (!tipoAyuda) {
                alert('Selecciona el tipo de ayuda');
                return;
            }

            // Acciones directas que abren Notion
            if (tipoAyuda === 'aportar_informacion') {
                const incident = allIncidents.find(i => i.id === currentIncidentId);
                if (incident?.url) {
                    window.open(incident.url, '_blank');
                }
                closeModal('ayudaModal');
                return;
            }

            if (tipoAyuda === 'revisar_materiales' || tipoAyuda === 'revisar_historial') {
                const incident = allIncidents.find(i => i.id === currentIncidentId);
                if (incident?.url) {
                    window.open(incident.url, '_blank');
                }
                closeModal('ayudaModal');
                return;
            }

            // Fin de turno - validar tiempo restante
            if (tipoAyuda === 'fin_de_turno') {
                const tiempoRestante = document.getElementById('tiempoRestante')?.value;
                if (!tiempoRestante) {
                    alert('Selecciona el tiempo restante de tu turno');
                    return;
                }

                // Validar que realmente est√© en los √∫ltimos 15 minutos
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                
                // Verificar si est√° en los √∫ltimos 15 minutos de alg√∫n turno
                const isNearEndOfShift = 
                    (currentHour === 13 && currentMinute >= 45) || // 6-14h
                    (currentHour === 21 && currentMinute >= 45) || // 14-22h  
                    (currentHour === 5 && currentMinute >= 45);    // 22-6h

                if (!isNearEndOfShift) {
                    alert('‚ùå Fin de turno solo disponible en los √∫ltimos 15 minutos del turno\n\nTurnos: 6-14h | 14-22h | 22-6h');
                    return;
                }

                handleAction('fin_de_turno', currentIncidentId, {
                    help_type: tipoAyuda,
                    tiempo_restante_minutos: tiempoRestante,
                    description: descripcion
                });
            }
            // Derivaci√≥n departamento
            else if (tipoAyuda === 'derivar_departamento') {
                const departamento = document.getElementById('departamentoDestino')?.value;
                if (!departamento) {
                    alert('Selecciona el departamento destino');
                    return;
                }

                handleAction('derivar_departamento', currentIncidentId, {
                    help_type: tipoAyuda,
                    target_department: departamento,
                    description: descripcion
                });
            }
            // Resto de ayudas est√°ndar
            else {
                handleAction('solicitar_apoyo', currentIncidentId, {
                    help_type: tipoAyuda,
                    description: descripcion
                });
            }
            
            closeModal('ayudaModal');
        }

        // ========================================
        //  UTILIDADES Y HELPERS
        // ========================================
        function formatDate(dateString) {
            if (!dateString) return 'Fecha no disponible';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', { 
                day: '2-digit', 
                month: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function getPriorityClass(priority) {
            if (!priority) return 'baja';
            const p = priority.toLowerCase();
            if (p.includes('cr√≠tica') || p.includes('üî¥')) return 'critica';
            if (p.includes('alta') || p.includes('üü†')) return 'alta';
            if (p.includes('media') || p.includes('üü°')) return 'media';
            return 'baja';
        }

        function cleanPriority(priority) {
            if (!priority) return 'BAJA';
            return priority.replace(/üî¥|üü†|üü°|üü¢/g, '').trim().toUpperCase();
        }

        function getStateLabel(state) {
            const labels = {
                'pending': '‚è≥ PENDIENTE',
                'working': '‚öôÔ∏è TRABAJANDO',
                'seguimiento': 'üëÅÔ∏è SEGUIMIENTO'
            };
            return labels[state] || state.toUpperCase();
        }

        function renderSLATimer(incident, state) {
            if (state !== 'pending') return '';
            
            const escalationLevel = parseInt(incident.escalation_level) || 0;
            let slaEnd = null;

            // Determinar SLA seg√∫n nivel
            switch (escalationLevel) {
                case 0: slaEnd = incident.sla_l0_end; break;
                case 1: slaEnd = incident.sla_l1_backup_end; break;
                case 2: slaEnd = incident.sla_l2_equipo_end; break;
            }

            if (!slaEnd) return '';

            const deadline = new Date(slaEnd);
            const now = new Date();
            const remainingMs = deadline - now;

            if (remainingMs <= 0) {
                return '<div class="sla-timer danger">‚ö†Ô∏è SLA VENCIDO</div>';
            }

            const remainingMinutes = Math.floor(remainingMs / 1000 / 60);
            const hours = Math.floor(remainingMinutes / 60);
            const minutes = remainingMinutes % 60;

            const isUrgent = remainingMinutes <= 30;
            return `
                <div class="sla-timer ${isUrgent ? 'danger' : ''}">
                    ‚è±Ô∏è SLA: ${hours}h ${minutes}m
                </div>
            `;
        }

        function getActionMessage(action) {
            const messages = {
                'acepto': 'Incidencia aceptada correctamente',
                'rechazo': 'Incidencia rechazada. Se escalar√° autom√°ticamente',
                'resolver': 'Incidencia resuelta. Pendiente cierre supervisor',
                'solicitar_materiales': 'Solicitud de materiales enviada al supervisor',
                'derivar_departamento': 'Solicitud de derivaci√≥n enviada al supervisor',
                'fin_de_turno': 'Incidencia transferida al siguiente turno',
                'solicitar_apoyo': 'Solicitud de apoyo enviada al supervisor',
                'solicitar_asignacion': 'Solicitud de asignaci√≥n enviada'
            };
            return messages[action] || `Acci√≥n ${action} procesada correctamente`;
        }

        function showLoadingState() {
            document.getElementById('incidentsContainer').innerHTML = `
                <div class="loading-spinner">üîÑ Cargando incidencias...</div>
            `;
        }

        function showErrorState(errorMessage) {
            document.getElementById('incidentsContainer').innerHTML = `
                <div class="no-incidents">
                    <div class="no-incidents-icon">‚ö†Ô∏è</div>
                    <h3>Error al cargar datos</h3>
                    <p>${errorMessage}</p>
                    <button class="btn btn-primary" onclick="loadDashboard()" style="margin-top: 16px;">
                        üîÑ Reintentar
                    </button>
                </div>
            `;
        }

        function showNotification(message, type = 'info') {
            // Crear notificaci√≥n temporal
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 20px;
                background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                border-radius: 8px;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 4000);
        }

        // ========================================
        //  INICIALIZACI√ìN Y ACCESO DIRECTO URL
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si hay acceso directo por URL
            checkDirectAccess();
            
            // Permitir login con Enter
            document.getElementById('emailInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') loginWithPIN();
            });
        });

        function checkDirectAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            const incidentId = urlParams.get('incident_id');
            const action = urlParams.get('action');
            
            if (incidentId) {
                directIncidentId = incidentId;
                
                // Mostrar mensaje de acceso directo
                const directAccessInfo = document.createElement('div');
                directAccessInfo.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: #17a2b8;
                    color: white;
                    padding: 12px 20px;
                    text-align: center;
                    z-index: 10001;
                    font-weight: 600;
                `;
                directAccessInfo.innerHTML = `
                    üìß Acceso directo a incidencia: <strong>${incidentId}</strong>
                    ${action ? ` | Acci√≥n: <strong>${action}</strong>` : ''}
                `;
                
                document.body.appendChild(directAccessInfo);
                
                // Si hay acci√≥n espec√≠fica, prepararla
                if (action) {
                    pendingAction = action;
                }
                
                // Auto-scroll a la incidencia despu√©s de cargar
                setTimeout(() => {
                    const incidentCard = document.querySelector(`[data-incident-id="${incidentId}"]`);
                    if (incidentCard) {
                        incidentCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        incidentCard.style.border = '3px solid #17a2b8';
                        incidentCard.style.boxShadow = '0 0 15px rgba(23, 162, 184, 0.3)';
                    }
                }, 2000);
            }
        }
    </script>
</body>
</html>
