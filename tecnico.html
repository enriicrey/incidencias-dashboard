<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard T√©cnico - Sistema de Incidencias ABC.xyz</title>
    <style>
        /* ========================================
           VARIABLES CSS Y RESET
        ======================================== */
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2c3e50;
        
            --success-color: #22c55e;
            --success-dark: #16a34a;
        
            --warning-color: #f59e0b;
            --warning-dark: #d97706;
        
            --danger-color: #ef4444;
            --danger-dark: #dc2626;
        
            --info-color: #3b82f6;
            --info-dark: #2563eb;
        
            --purple-color: #6f42c1;
            --purple-dark: #5a2d91;
        
            /* Escala de grises completa */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
        
            /* Radius y sombras */
            --border-radius: 12px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.15);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
        
            --transition: all 0.3s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-800);
        }

        /* ========================================
           LOGIN COMPONENTS
        ======================================== */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow-md);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .input-group { margin-bottom: 20px; text-align: left; }

        .input-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--gray-800);
        }

        .input-field {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .verify-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .verify-btn:hover { transform: translateY(-2px); }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
        }

        .hidden { display: none !important; }

        /* ========================================
           DASHBOARD COMPONENTS
        ======================================== */
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px 0;
            box-shadow: var(--shadow-md);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo { font-size: 24px; font-weight: 700; }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .refresh-button {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .refresh-button:hover { background: rgba(255, 255, 255, 0.25); }

        /* ========================================
           MAIN CONTAINER
        ======================================== */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

       .stats-bar {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 20px;
          margin-bottom: 30px;
        }
        @media (max-width: 900px) {
          .stats-bar { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 600px) {
          .stats-bar { grid-template-columns: 1fr; }
        }


        .stat-card {
            background: white;
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .stat-card:hover { transform: translateY(-2px); }
        .stat-card.active { border-color: var(--primary-color); }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-number.pending { color: var(--warning-color); }
        .stat-number.working { color: var(--info-color); }
        .stat-number.seguimiento { color: #6b7280; }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        /* ========================================
        FILTERS BAR - PRIORIDAD
        Barra de botones para filtrar incidencias
        por nivel de prioridad (Cr√≠tica, Alta, Media, Baja).
        ======================================== */
        .filters-bar {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-label {
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 14px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--gray-300);
            border-radius: 20px;
            background: white;
            color: var(--gray-500);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .filter-btn.active,
        .filter-btn:hover {
            background: var(--info-color);
            border-color: var(--info-color);
            color: white;
        }


        /* ========================================
           INCIDENTS SECTION
        ======================================== */
        .section-header {
            background: var(--gray-50);
            padding: 20px 30px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-800);
        }

        .loading-spinner {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        /* Incident Cards */
        .incident-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
       .incident-header-right{
          text-align:right;
          display:flex;
          flex-direction:column;
          gap:6px;
          align-items:flex-end;
        }
        .seguimiento-banner{
          margin-top:10px;
          padding:10px 12px;
          border-radius:10px;
          border:1px solid var(--gray-200);
          background:#fff7ed;
          color:#7c2d12;
          box-shadow:var(--shadow-sm);
          font-size:13px;
        }
        .materials-badge{
          display:inline-block;
          padding:6px 10px;
          border-radius:999px;
          font-size:12px;
          font-weight:700;
          border:1px solid var(--gray-200);
        }
        .materials-ok{ background:#e6f7ee; color:#166534; border-color:#a7f3d0; }
        .materials-pending{ background:#fff8e5; color:#92400e; border-color:#fde68a; }
        .sla-timer{ font-size:12px; padding:4px 8px; border-radius:8px; }
        .sla-good{ background:#eef2ff; }
        .sla-warning{ background:#fff7ed; }
        .sla-critical{ background:#fee2e2; }
        .incident-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 4px;
        }

        .incident-meta {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .priority-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-critica { background: #fee2e2; color: #dc2626; }
        .priority-alta { background: #fed7aa; color: #ea580c; }
        .priority-media { background: #fef3c7; color: #d97706; }
        .priority-baja { background: #dcfce7; color: #16a34a; }

        .state-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .state-pending { background: #fef3c7; color: #92400e; }
        .state-working { background: #dbeafe; color: #1e40af; }
        .state-seguimiento { background: #f3f4f6; color: #6b7280; }

        /* Action Buttons */
        .incident-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-success { background: var(--success-color); color: white; }
        .btn-success:hover { background: var(--success-dark); }

        .btn-danger { background: var(--danger-color); color: white; }
        .btn-danger:hover { background: var(--danger-dark); }

        .btn-warning { background: var(--warning-color); color: white; }
        .btn-warning:hover { background: var(--warning-dark); }

        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }

        .btn-purple { background: var(--purple-color); color: white; }
        .btn-purple:hover { background: var(--purple-dark); }

        .btn-info { background: var(--info-color); color: white; }
        .btn-secondary { background: #6b7280; color: white; }

        /* ========================================
           MODAL COMPONENTS
        ======================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 24px 30px 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-800);
        }

        .modal-body { padding: 24px 30px; }

        .modal-footer {
            padding: 20px 30px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .form-group { margin-bottom: 20px; }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--gray-800);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .reason-option {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .reason-option:hover { border-color: var(--primary-color); }
        .reason-option.selected { border-color: var(--primary-color); background: #f0f9ff; }

        .reason-icon { font-size: 20px; margin-right: 12px; }

        .no-incidents {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .no-incidents-icon { font-size: 48px; margin-bottom: 16px; }

        /* ========================================
           RESPONSIVE DESIGN
        ======================================== */
        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 16px; }
            .user-info { flex-direction: column; gap: 8px; }
            .incident-header { flex-direction: column; gap: 12px; }
            .incident-actions { justify-content: center; }
            .modal { width: 95%; }
        }
        /* ========================================
           MODAL DE AYUDA / GESTI√ìN - TARJETAS
        ======================================== */
        .ayuda-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }
        
        .ayuda-card {
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: var(--transition);
            background: white;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .ayuda-card:hover {
            border-color: var(--primary-color);
            background: var(--gray-50);
        }
        
        .ayuda-card.selected {
            border-color: var(--primary-color);
            background: #eff6ff;
        }
        
        .ayuda-extra {
            margin-top: 12px;
            display: none;
        }
        
        .ayuda-extra.active {
            display: block;
        }
        /* ========================================
           MODAL SOLICITAR MATERIALES
           Permite gestionar m√∫ltiples materiales
        ======================================== */
        .materials-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .material-item {
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 12px;
            background: var(--gray-50);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .material-actions {
            display: flex;
            justify-content: flex-end;
        }
        
        .material-actions button {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 10px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .material-actions button:hover {
            background: var(--danger-dark);
        }
        /* Bot√≥n usado en ‚ÄúFin de turno‚Äù */
        .btn-dark { background:#111827; color:#fff; }
        .btn-dark:hover { background:#0b1220; }
        
        /* Modales grandes (Ayuda / Materiales) */
        .modal.large-modal { max-width: 900px; }
        
        /* Grid del formulario de materiales */
        .form-grid{
          display:grid;
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap:12px;
        }
        @media (max-width: 640px){
          .form-grid{ grid-template-columns: 1fr; }
        }
        /* Chips unificados en el header (validaciones + notificaciones) */
        .chips-stack{ display:flex; flex-direction:column; gap:6px; align-items:flex-end; }
        .chip-sep{ height:2px; width:36px; background:var(--gray-200); border-radius:999px; }
        .notif-chip{
          display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px;
          font-weight:700; border:1px solid var(--gray-200);
        }
        .notif-ok{ background:#e6f7ee; color:#166534; border-color:#a7f3d0; }
        .notif-warn{ background:#fff8e5; color:#92400e; border-color:#fde68a; }
        .notif-bad{ background:#fee2e2; color:#991b1b; border-color:#fecaca; }

        /* GRID 1 col (m√≥vil) / 2 col (desktop) */
        .incidents-list{
          display:grid;
          grid-template-columns:1fr;
          gap:16px;
          padding: 10px 14px 18px;
        }
        @media(min-width:1024px){
          .incidents-list{ grid-template-columns:1fr 1fr; }
        }
        /* opcional: 3 columnas en pantallas muy anchas
        @media(min-width:1600px){
          .incidents-list{ grid-template-columns:1fr 1fr 1fr; }
        }
        */
        
        /* Tarjeta compacta (pasamos de "fila con separador" a "card") */
        .incident-card{
          border:1px solid #e5e7eb;
          border-radius:12px;
          padding:16px 18px;
          margin:0;
          background:#fff;
          box-shadow: var(--shadow-sm);
        }
        .incident-card:hover{ background:#fafafa; }
        /* Neutraliza la √∫ltima-regla de tu lista por filas */
        .incident-card:last-child{ border-bottom:1px solid #e5e7eb; }
        
        /* Densidad y micro-ajustes */
        .incident-header{ margin-bottom:10px; }
        .incident-title{ font-size:16px; margin-bottom:2px; }
        .incident-meta{ gap:10px; font-size:12px; margin-bottom:10px; }
        .incident-actions{ margin-top:12px; gap:8px; }
        .btn{ padding:8px 12px; font-size:13px; }
        
        /* Chips y badges */
        .chips{ display:flex; flex-wrap:wrap; gap:8px; }
        .chip{ background:#f3f4f6; border-radius:999px; padding:4px 10px; font-size:12px; white-space:nowrap; }
        .priority{ font-weight:600; }
        
        /* SLA mini dentro de la tarjeta */
        .sla-pill{ display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:6px 10px; border-radius:10px; background:#FFF5E8; color:#9A5B00; }
        
        /* Descripci√≥n con truncado y ‚Äúver m√°s‚Äù */
        .desc{
          margin:8px 0 10px; font-size:14px; color:#374151;
          display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;
        }
        
        /* Detalles colapsables nativos */
        details{ border-top:1px dashed #e5e7eb; margin-top:10px; padding-top:10px; }
        details > summary{ cursor:pointer; list-style:none; font-weight:600; display:flex; align-items:center; gap:8px; }
        details > summary::-webkit-details-marker{ display:none; }
        .detail-grid{ display:grid; grid-template-columns: 1fr; gap:10px; margin-top:8px; font-size:13px; color:#374151;}
        @media(min-width:640px){ .detail-grid{ grid-template-columns: 1fr 1fr; } }
        .muted{ color:#6b7280; }
        .log{ white-space:pre-line; background:#f9fafb; border-radius:8px; padding:8px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; }
        
        /* Bot√≥n ligero */
        .btn-link{ background:#eef2ff; color:#3730a3; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; font-size:12px; }
        .filters-bar{ display:none !important; } /*borramos filtro prioridad */
        .timeline{ list-style:none; margin:8px 0; padding:0; }
        .timeline li{
          display:grid; grid-template-columns: 110px 1fr; gap:10px;
          padding:8px 10px; border-radius:8px; background:#f9fafb; margin-bottom:6px;
          font-size:13px;
        }
        .timeline .t-time{ color:#6b7280; font-variant-numeric: tabular-nums; }
        .timeline .t-body{ color:#374151; }
    </style>
</head>
<body>
    <!-- LOGIN CONTAINER -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <h1 class="login-title">üîß Dashboard T√©cnico</h1>
            <p class="login-subtitle">Sistema de Incidencias ABC.xyz</p>

            <div class="input-group">
                <label class="input-label" for="emailInput">Email corporativo</label>
                <input type="email" id="emailInput" class="input-field" placeholder="tecnico@abc.xyz" autocomplete="email">
            </div>

            <button class="verify-btn" onclick="loginWithPIN()">Acceder con PIN</button>

            <div id="loginError" class="error-message hidden">
                Error de autenticaci√≥n. Verifica tus credenciales.
            </div>
        </div>
    </div>

    <!-- DASHBOARD PRINCIPAL -->
    <div id="dashboardContainer" class="hidden">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">üîß Dashboard T√©cnico - Sistema ABC.xyz</div>
                <div class="user-info">
                    <div id="technicianName">Cargando t√©cnico...</div>
                    <span id="userEmail">usuario@abc.xyz</span>
                    <span>|</span>
                    <span id="userRole">T√©cnico L0</span>
                    <button class="refresh-button" onclick="refreshDashboard()">üîÑ Actualizar</button>
                </div>
            </div>
        </header>

        <!-- Main Container -->
        <main class="main-container">
            <!-- Stats Bar -->
            <section class="stats-bar">
                <div class="stat-card active" onclick="filterByStatus('all', this)">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card" onclick="filterByStatus('pending', this)">
                    <div class="stat-number pending" id="pendingCount">0</div>
                    <div class="stat-label">Pendientes</div>
                </div>
                <div class="stat-card" onclick="filterByStatus('working', this)">
                    <div class="stat-number working" id="workingCount">0</div>
                    <div class="stat-label">Trabajando</div>
                </div>
                <div class="stat-card" onclick="filterByStatus('seguimiento', this)">
                    <div class="stat-number seguimiento" id="seguimientoCount">0</div>
                    <div class="stat-label">Seguimiento</div>
                </div>
            </section>
      
            <!-- Incidents Section -->
            <section class="incidents-section">
          <div class="section-header">
            <h2>üìã Incidencias Asignadas</h2>
          </div>
        
          <div id="incidentsContainer">
            <div class="loading-spinner">üîÑ Cargando incidencias...</div>
          </div>
         <div class="incidents-list"></div>
        </section>
            
        </main>
    </div>

    <!-- ========================================
         MODALES
    ======================================== -->

    <!-- Modal de Motivo Rechazo -->
    <div id="reasonModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">‚ùå Motivo del Rechazo</h3>
            </div>
            <div class="modal-body">
                <div id="reasonOptions"></div>
                <div class="form-group">
                    <label for="customReasonText" class="form-label">Descripci√≥n adicional (opcional):</label>
                    <textarea id="customReasonText" class="form-control" rows="3" placeholder="Proporciona m√°s detalles si es necesario..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('reasonModal')">Cancelar</button>
                <button id="confirmBtn" class="btn btn-danger" onclick="confirmAction()">Confirmar Rechazo</button>
            </div>
        </div>
    </div>

    <!-- Modal de Resoluci√≥n -->
    <div id="resolverModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3>üîß Resolver Incidencia</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="solutionDescription" class="form-label">Descripci√≥n de la soluci√≥n:</label>
                    <textarea id="solutionDescription" class="form-control" rows="4" placeholder="Describe detalladamente c√≥mo se resolvi√≥ la incidencia..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="materialsUsed" class="form-label">Materiales utilizados (opcional):</label>
                    <textarea id="materialsUsed" class="form-control" rows="2" placeholder="Lista los materiales consumidos durante la reparaci√≥n..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('resolverModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmResolver()">üîß Resolver Incidencia</button>
            </div>
        </div>
    </div>

    <!-- Modal de Solicitar Materiales -->
    <div id="materialesModal" class="modal-overlay hidden">
    <div class="modal large-modal">
        <div class="modal-header">
            <h3>üì¶ Solicitar Materiales</h3>
        </div>
        <div class="modal-body">
            <!-- Formulario de nuevo material -->
            <div class="form-grid">
                <input type="text" id="matNombre" placeholder="Nombre del material" class="form-control">
                <input type="number" id="matCantidad" placeholder="Cantidad" class="form-control">
                <select id="matTipo" class="form-control">
                    <option value="">-- Tipo --</option>
                    <option value="consumible">Consumible</option>
                    <option value="herramienta">Herramienta</option>
                    <option value="repuesto">Repuesto</option>
                </select>
                <select id="matUrgencia" class="form-control">
                    <option value="normal">Normal</option>
                    <option value="urgente">Urgente</option>
                </select>
                <input type="text" id="matJustificacion" placeholder="Justificaci√≥n" class="form-control">
            </div>
            <button class="btn btn-secondary" onclick="agregarMaterial()">‚ûï A√±adir a la lista</button>

            <!-- Lista de materiales a√±adidos -->
            <div class="materials-list" id="materialsList"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('materialesModal')">Cancelar</button>
            <button class="btn btn-success" onclick="enviarMateriales()">‚úÖ Enviar solicitud</button>
        </div>
    </div>
</div>


    <!-- Modal de Ayuda/Gestionar -->
        <div id="ayudaModal" class="modal-overlay hidden">
            <div class="modal large-modal">
                <div class="modal-header">
                    <h3>üõ†Ô∏è Ayuda y Gesti√≥n</h3>
                </div>
                <div class="modal-body">
                    <!-- Opciones principales como tarjetas -->
                    <div class="ayuda-options" id="ayudaOptions">
                        <!-- Se generar√°n din√°micamente con JS -->
                    </div>
        
                    <!-- Contenedor de campos adicionales -->
                    <div id="ayudaExtraFields"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('ayudaModal')">Cancelar</button>
                    <button class="btn btn-warning" onclick="procesarAyuda()">üõ†Ô∏è Continuar</button>
                </div>
            </div>
        </div>

    <script>
        // ========================================
        //  VARIABLES GLOBALES
        // ========================================
        let currentTechnician = null;
        let pendingAction = null;
        let selectedReason = null;
        let currentIncidentId = null;

        // ========================================
        //  VARIABLES PARA ACCESO DIRECTO
        // ========================================
        let directIncidentId = null;
        let directScrollDone = false; 
        let pendingActionData = {};

        // ========================================
        //  AUTENTICACI√ìN Y LOGIN
        // ========================================
        async function loginWithPIN() {
            const email = document.getElementById('emailInput').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            if (!email) {
                errorDiv.textContent = 'Ingresa tu email corporativo';
                errorDiv.classList.remove('hidden');
                return;
            }

            // Mostrar modal PIN
            showPINModal(email);
        }

        function showPINModal(email) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'pinModal';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>üîê Verificaci√≥n de Identidad</h3>
                    </div>
                    <div class="modal-body">
                        <p>Ingresa tu PIN de 4 d√≠gitos para confirmar tu identidad:</p>
                        <div class="form-group">
                            <label class="form-label">PIN:</label>
                            <input type="password" id="pinInput" class="form-control" maxlength="4" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="text-align: center; font-size: 18px; letter-spacing: 4px;">
                        </div>
                        <div id="pinError" class="error-message hidden"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closePINModal()">Cancelar</button>
                        <button class="btn btn-primary" id="verifyPinBtn" onclick="verifyPIN('${email}')" disabled>Verificar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const pinInput = document.getElementById('pinInput');
            const verifyBtn = document.getElementById('verifyPinBtn');
            
            pinInput.focus();
            
            pinInput.oninput = function() {
               this.value = this.value.replace(/\D/g, '').slice(0, 4);
               verifyBtn.disabled = this.value.length !== 4;
            };
            
            pinInput.onkeypress = function(e) {
                if (e.key === 'Enter' && this.value.length === 4) {
                    verifyPIN(email);
                }
                // Solo permitir n√∫meros
                if (!/[0-9]/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'Tab') {
                    e.preventDefault();
                }
            };
        }

        async function verifyPIN(email) {
            const pin = document.getElementById('pinInput').value;
            const pinError = document.getElementById('pinError');
            
            if (pin.length !== 4) {
                showPINError('PIN debe tener 4 d√≠gitos');
                return;
            }

            try {
                const response = await fetch('/api/webhook-respuesta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'validate_pin',
                        technician_email: email,
                        pin: pin
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    currentTechnician = {
                        email: email,
                        name: data.technician?.name || formatNameFromEmail(email),
                        department: data.technician?.department || 'Mtto-Mec√°nico',
                        authenticated: true,
                        pin: pin // Guardar PIN para futuras acciones
                    };

                    // Actualizar UI
                    document.getElementById('technicianName').textContent = currentTechnician.name;
                    document.getElementById('userEmail').textContent = email;
                    document.getElementById('userRole').textContent = `${currentTechnician.department}`;
                    
                    // Cerrar modal PIN y login
                    closePINModal();
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('dashboardContainer').classList.remove('hidden');
                    
                    // Si hay acci√≥n pendiente (acceso directo), ejecutarla
                    if (pendingAction) {
                        await handleAction(pendingAction, directIncidentId, pendingActionData);
                        pendingAction = null;
                        directIncidentId = null;
                        pendingActionData = {};
                    }
                    
                    // Cargar incidencias
                    loadDashboard();
                } else {
                    showPINError(data.message || 'PIN incorrecto');
                }
            } catch (error) {
                console.error('Error verificando PIN:', error);
                showPINError('Error de conexi√≥n');
            }
        }

        function showPINError(message) {
            const pinError = document.getElementById('pinError');
            pinError.textContent = message;
            pinError.classList.remove('hidden');
        }

        function closePINModal() {
            const modal = document.getElementById('pinModal');
            if (modal) {
                modal.remove();
            }
        }

        // ========================================
        //  CARGA DE DATOS
        // ========================================
        async function loadDashboard() {
            if (!currentTechnician?.authenticated) return;

            showLoadingState();

            try {
                const response = await fetch(`/api/webhook-respuesta?action=get_assigned_incidents&technician_email=${encodeURIComponent(currentTechnician.email)}`);
                const data = await response.json();
                
                if (data.status === 'success' && data.incidents) {
                    allIncidents = data.incidents;
                    updateStatistics();
                    applyFiltersAndRender();
                } else {
                    throw new Error(data.message || 'Error al cargar incidencias');
                }
            } catch (error) {
                console.error('Error cargando dashboard:', error);
                showErrorState(error.message);
            }
        }

        function refreshDashboard() {
            loadDashboard();
        }

        // ========================================
        //  GESTI√ìN DE ESTADOS Y FILTROS
        // ========================================
        function getIncidentRealState(incident, technicianEmail) {
          const level = parseInt(incident.escalation_level) || 0;
        
          // 0) Si el SLA del nivel actual est√° vencido, el t√©cnico ve la tarjeta en seguimiento.
          const end = getSlaEndForLevel(incident, level);
          const deadline = end ? Date.parse(end) : 0;
          if (deadline && Date.now() > deadline) {
            return 'seguimiento';
          }
        
          // 1) Preferir "Respuestas (log)"
          const respText = incident["Respuestas (log)"] || incident.respuestas_log || "";
          if (respText.trim()) {
            const rows = parseRespLog(respText);
        
            // ¬øqui√©n es el propietario vigente del nivel actual?
            const owner = rows
              .filter(r => r.level === level && r.ev === 'ASSIGNED')
              .slice(-1)[0]?.email?.toLowerCase();
        
            if (owner && owner === (technicianEmail || '').toLowerCase()) return 'working';
        
            const myEvents = rows.filter(r => r.level === level && r.email.toLowerCase() === (technicianEmail||'').toLowerCase());
            const lastMine = myEvents[myEvents.length - 1];
            if (lastMine?.ev?.startsWith('REJECTED') || lastMine?.ev === 'REASSIGN_FROM') return 'seguimiento';
        
            // Si no soy el titular y no he rechazado, quedo en seguimiento (estoy al tanto).
            return 'seguimiento';
          }
        
          // 2) Fallback (campos legados)
          const now = Date.now();
          const currentAssignments = [
            { level: 0, tech: incident.l0_technician, response: incident.l0_response, sla: incident.sla_l0_end },
            { level: 1, tech: incident.l1_technician, response: incident.l1_response, sla: incident.sla_l1_backup_end },
            { level: 2, tech: incident.l2_technicians, response: incident.l2_responses, sla: incident.sla_l2_equipo_end },
            { level: 3, tech: incident.l3_technician, response: incident.l3_response, sla: incident.sla_l3_responsable_end }
          ];
          const curr = currentAssignments.find(a =>
            a.level === level &&
            (a.tech === technicianEmail || (a.tech && String(a.tech).includes(technicianEmail)))
          );
          if (curr) {
            const slaOk = curr.sla ? (Date.parse(curr.sla) - now) > 0 : false;
            if (curr.response === 'acepto' || curr.response === '‚úÖ Acepto') return 'working';
            if (curr.response === '‚≠ï Sin Respuesta' && slaOk) return 'pending';
          }
            // --- Seguimiento por vencimiento y cambio de nivel (no soy el titular del nivel actual) ---
            const L = parseInt(incident.escalation_level)||0;
            const slaEnd = getSlaEndForLevel(incident, L);
            if (slaEnd && Date.now() > Date.parse(slaEnd)) {
              // Si el due√±o vigente del nivel actual no soy yo, lo veo en seguimiento
              const respText = incident["Respuestas (log)"] || incident.respuestas_log || "";
              if (respText.trim()){
                const rows = parseRespLog(respText);
                const owner = getCurrentOwnerByLevel(rows, L);
                if (!owner || owner.toLowerCase() !== (technicianEmail||'').toLowerCase()){
                  return 'seguimiento';
                }
              }
            }
            return 'seguimiento';
        }



        function updateStatistics() {
            const technicianEmail = currentTechnician?.email || '';
            
            const relevantIncidents = allIncidents.filter(incident => {
                const state = getIncidentRealState(incident, technicianEmail);
                return ['pending', 'working', 'seguimiento'].includes(state);
            });

            const stats = {
                total: relevantIncidents.length,
                pending: relevantIncidents.filter(i => getIncidentRealState(i, technicianEmail) === 'pending').length,
                working: relevantIncidents.filter(i => getIncidentRealState(i, technicianEmail) === 'working').length,
                seguimiento: relevantIncidents.filter(i => getIncidentRealState(i, technicianEmail) === 'seguimiento').length
            };

            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('pendingCount').textContent = stats.pending;
            document.getElementById('workingCount').textContent = stats.working;
            document.getElementById('seguimientoCount').textContent = stats.seguimiento;
        }

                function abrirAyuda(id){ showAyudaModal(id); }
                function abrirMateriales(id){ showMaterialesModal(id); }
                function abrirResolver(id){ showResolverModal(id); }
                
                function aceptarIncidencia(id){ handleAction('acepto', id); }
                function rechazarIncidencia(id){ showReasonModal('rechazo', id); }
                function solicitarAsignacion(id){ handleAction('solicitar_asignacion', id); }


        // ========================================
        //  GESTI√ìN DE MODALES
        // ========================================
        function showReasonModal(action, incidentId) {
            currentIncidentId = incidentId;
            pendingAction = action;
            
            const modal = document.getElementById('reasonModal');
            const title = document.getElementById('modalTitle');
            const options = document.getElementById('reasonOptions');
            
            title.textContent = '‚ùå Motivo del Rechazo';
            
            const rejectReasons = [
                { id: 'no_herramientas',   emoji: 'üîß', title: 'No tengo herramientas necesarias',   description: 'Faltan herramientas espec√≠ficas' },
                { id: 'no_conocimiento',   emoji: 'üìö', title: 'No tengo conocimiento t√©cnico',      description: 'Requiere conocimientos especializados' },
                { id: 'fuera_horario',     emoji: 'üïê', title: 'Fuera de horario laboral',          description: 'Asignada fuera del turno de trabajo' },
                { id: 'sobrecarga',        emoji: 'üìä', title: 'Sobrecarga de trabajo',             description: 'Trabajando en m√∫ltiples incidencias' },
                { id: 'ubicacion_lejana',  emoji: 'üìç', title: 'Ubicaci√≥n lejana',                  description: 'Fuera de zona de cobertura' },
                { id: 'otro',              emoji: 'üí¨', title: 'Otro motivo',                       description: 'Especificar motivo', requiresText: true }
            ];

                  options.innerHTML = rejectReasons.map(r => `
                  <div class="reason-option" onclick="selectReason('${r.id}', event)">
                    <div style="display:flex;align-items:center;">
                      <span class="reason-icon">${r.emoji}</span>
                      <div>
                        <div style="font-weight:600;">${r.title}</div>
                        <div style="font-size:14px;color:#6b7280;">${r.description}</div>
                      </div>
                    </div>
                  </div>
                `).join('');

            modal.classList.remove('hidden');
        }

        function showResolverModal(incidentId) {
            currentIncidentId = incidentId;
            document.getElementById('resolverModal').classList.remove('hidden');
        }

        function showMaterialesModal(incidentId) {
            currentIncidentId = incidentId;
            document.getElementById('materialesModal').classList.remove('hidden');
        }

        function showAyudaModal(incidentId) {
            currentIncidentId = incidentId;
            document.getElementById('ayudaModal').classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            // Reset forms
            document.querySelectorAll(`#${modalId} input, #${modalId} textarea, #${modalId} select`).forEach(input => {
                if (input.type === 'checkbox') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });
            selectedReason = null;
            currentIncidentId = null;
        }

        function selectReason(reasonId, ev) {
          selectedReason = reasonId;
          document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
          // Preferimos currentTarget (el div con el onclick)
          const card = ev?.currentTarget || ev?.target?.closest('.reason-option');
          if (card) card.classList.add('selected');
        }

        // ========================================
        //  ACCIONES PRINCIPALES CON PIN
        // ========================================
        async function handleAction(action, incidentId, extraData = {}) {
            if (!currentTechnician?.authenticated) {
                alert('Debes estar autenticado para realizar acciones');
                return;
            }

            // Si no hay PIN guardado, solicitarlo
            if (!currentTechnician.pin) {
                pendingAction = action;
                directIncidentId = incidentId;
                pendingActionData = extraData;
                
                // Solicitar PIN para la acci√≥n
                showActionPINModal(action, incidentId);
                return;
            }

            const payload = {
                action: action,
                incident_id: incidentId,
                technician_email: currentTechnician.email,
                pin: currentTechnician.pin,  // ‚úÖ Incluir PIN en todas las acciones
                timestamp: new Date().toISOString(),
                ...extraData
            };

            try {
                const response = await fetch('/api/webhook-respuesta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    showNotification(`‚úÖ ${getActionMessage(action)}`, 'success');
                    loadDashboard(); // Recargar datos
                } else {
                    showNotification(`‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Error en acci√≥n:', error);
                showNotification('‚ùå Error de conexi√≥n', 'error');
            }
        }

        function showActionPINModal(action, incidentId) {
          const modal = document.createElement('div');
          modal.className = 'modal-overlay';
          modal.id = 'actionPinModal';
          modal.innerHTML = `
            <div class="modal">
              <div class="modal-header">
                <h3>üîê Confirmar Acci√≥n</h3>
              </div>
              <div class="modal-body">
                <p>Para realizar la acci√≥n <strong>${getActionMessage(action)}</strong>, confirma tu PIN:</p>
                <div class="form-group">
                  <label class="form-label">PIN:</label>
                  <input type="password" id="actionPinInput" class="form-control" maxlength="4" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="text-align: center; font-size: 18px; letter-spacing: 4px;">
                </div>
                <div id="actionPinError" class="error-message hidden"></div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeActionPINModal()">Cancelar</button>
                <button class="btn btn-primary" id="confirmActionBtn" onclick="confirmActionWithPIN()" disabled>Confirmar</button>
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
          
          const pinInput = document.getElementById('actionPinInput');
          const confirmBtn = document.getElementById('confirmActionBtn');
        
          pinInput.focus();
        
          pinInput.oninput = function() {
            this.value = this.value.replace(/\D/g, '').slice(0, 4);
            confirmBtn.disabled = this.value.length !== 4;
          };
        
          pinInput.onkeypress = function(e) {
            if (e.key === 'Enter' && this.value.length === 4) {
              confirmActionWithPIN();
              return;
            }
            if (!/[0-9]/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'Tab') {
              e.preventDefault();
            }
          };
        }


        async function confirmActionWithPIN() {
            const pin = document.getElementById('actionPinInput').value;
            
            if (pin.length !== 4) {
                document.getElementById('actionPinError').textContent = 'PIN debe tener 4 d√≠gitos';
                document.getElementById('actionPinError').classList.remove('hidden');
                return;
            }

            // Guardar PIN y ejecutar acci√≥n
            currentTechnician.pin = pin;
            closeActionPINModal();
            
            // Ejecutar acci√≥n pendiente
            await handleAction(pendingAction, directIncidentId, pendingActionData);
        }

        function closeActionPINModal() {
            const modal = document.getElementById('actionPinModal');
            if (modal) {
                modal.remove();
            }
        }

        function confirmAction() {
            if (!selectedReason || !currentIncidentId) return;
            
            const customText = document.getElementById('customReasonText').value.trim();
            
            handleAction(pendingAction, currentIncidentId, {
                reject_reason: selectedReason,
                custom_reason: customText
            });
            
            closeModal('reasonModal');
        }

      function confirmResolver() {
      const solution = document.getElementById('solutionDescription').value.trim();
      const materials = document.getElementById('materialsUsed').value.trim();
      if (!solution) { alert('Describe la soluci√≥n implementada'); return; }
    
      const inc = allIncidents.find(i => i.id === currentIncidentId);
      // Bloquea si hay üì¶ Materiales en Validaciones Pendientes
      const pend = getPendingValidations(inc);
      if (pend.includes("üì¶ Materiales")) {
        alert('‚ùå No puedes resolver: hay materiales pendientes de validar.');
        return;
      }
    
      handleAction('resolver', currentIncidentId, {
        solution_description: solution,
        materials_used: materials
      });
      closeModal('resolverModal');
    }

        // ========================================
        //  UTILIDADES Y HELPERS
        // ========================================
      const formatNameFromEmail = (email) => email?.split('@')[0].split('.').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');

        function formatDate(dateString) {
            if (!dateString) return 'Fecha no disponible';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', { 
                day: '2-digit', 
                month: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
    
        function getPriorityClass(priority) {
            if (!priority) return 'baja';
            const p = priority.toLowerCase();
            if (p.includes('cr√≠tica') || p.includes('üî¥')) return 'critica';
            if (p.includes('alta') || p.includes('üü†')) return 'alta';
            if (p.includes('media') || p.includes('üü°')) return 'media';
            return 'baja';
        }

        function cleanPriority(priority) {
            if (!priority) return 'BAJA';
            return priority.replace(/üî¥|üü†|üü°|üü¢/g, '').trim().toUpperCase();
        }

        function getStateLabel(state) {
            const labels = {
                'pending': '‚è≥ PENDIENTE',
                'working': '‚öôÔ∏è TRABAJANDO',
                'seguimiento': 'üëÅÔ∏è SEGUIMIENTO'
            };
            return labels[state] || state.toUpperCase();
        }

        function getActionMessage(action) {
            const messages = {
                'acepto': 'Incidencia aceptada correctamente',
                'rechazo': 'Incidencia rechazada. Se escalar√° autom√°ticamente',
                'resolver': 'Incidencia resuelta. Pendiente cierre supervisor',
                'solicitar_materiales': 'Solicitud de materiales enviada al supervisor',
                'derivar_departamento': 'Solicitud de derivaci√≥n enviada al supervisor',
                'fin_de_turno': 'Incidencia transferida al siguiente turno',
                'solicitar_apoyo': 'Solicitud de apoyo enviada al supervisor',
                'solicitar_asignacion': 'Solicitud de asignaci√≥n enviada',
                'aportar_informacion': 'Informaci√≥n adicional registrada'
            };
            return messages[action] || `Acci√≥n ${action} procesada correctamente`;
        }

        function showLoadingState() {
            document.getElementById('incidentsContainer').innerHTML = `
                <div class="loading-spinner">üîÑ Cargando incidencias...</div>
            `;
        }

        function showErrorState(errorMessage) {
            document.getElementById('incidentsContainer').innerHTML = `
                <div class="no-incidents">
                    <div class="no-incidents-icon">‚ö†Ô∏è</div>
                    <h3>Error al cargar datos</h3>
                    <p>${errorMessage}</p>
                    <button class="btn btn-primary" onclick="loadDashboard()" style="margin-top: 16px;">
                        üîÑ Reintentar
                    </button>
                </div>
            `;
        }

        function showNotification(message, type = 'info') {
            // Crear notificaci√≥n temporal
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 20px;
                background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                border-radius: 8px;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 4000);
        }

        // --- Parsear log y agrupar por categor√≠a + request_id ---
        function parseSolicitudesLog(logText = "") {
          const lines = logText.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
          const out = []; // {when, cat, id, phase, meta}
          for (const line of lines) {
            const m = line.match(/^\[(.+?)\]\s+([A-Z]+)#([\w-]+)\|([A-Z]+)\|(.*)$/);
            if (!m) continue;
            const [, when, cat, reqId, phase, rest] = m;
            out.push({ when, cat, reqId, phase, meta: rest || "" });
          }
          return out;
        }
        
        function groupByRequest(logRows) {
          // { "MATERIAL|MAT-001": {cat, id, last: {phase, when}, phases: [...] } }
          const map = {};
          for (const r of logRows) {
            const key = `${r.cat}|${r.reqId}`;
            if (!map[key]) map[key] = { cat: r.cat, id: r.reqId, phases: [] };
            map[key].phases.push(r);
          }
          for (const k of Object.keys(map)) {
            map[k].phases.sort((a,b)=> new Date(a.when)-new Date(b.when));
            map[k].last = map[k].phases[map[k].phases.length - 1];
          }
          return map;
        }
          function renderSlaPillInHeader(inc, state){
          const L = getCurrentLevel(inc);
          const end = getSlaEndForLevel(inc, L);
          if (!end) return '';
          const ms = Date.parse(end) - Date.now();
          const cls = ms <= 0 ? 'sla-critical' : (ms <= 120*60000 ? 'sla-warning' : 'sla-good');
          const label = ms <= 0 ? `SLA vencido en L${L}` : `SLA en L${L} ¬∑ ${formatRemain(ms)}`;
          return `<span class="sla-timer ${cls}">‚è±Ô∏è ${label}</span>`;
        }
        
        // --- ¬øQu√© categor√≠as tienen pendientes? ---
        function getPendingCategoriesFromLog(logText="") {
          const rows = parseSolicitudesLog(logText);
          const grouped = groupByRequest(rows);
          const pendingCats = new Set();
          for (const k of Object.keys(grouped)) {
            const { cat, last } = grouped[k];
            if (last?.phase === "REQUEST") pendingCats.add(cat);
          }
          return pendingCats; // e.g. Set(["MATERIAL","APOYO"])
        }
        
        // --- Construir notificaciones compactas desde el log ---
        function buildNotificationsFromLog(incident) {
          const log = incident["Solicitudes (log)"] || incident.solicitudes_log || "";
          if (!log) return [];
        
          const rows = parseSolicitudesLog(log);
          const grouped = groupByRequest(rows);
        
          // contadores por cat/fase
          const counters = {
            MATERIAL: { APPROVED: 0, REJECTED: 0 },
            DERIVACION: { APPROVED: 0, REJECTED: 0 },
            APOYO: { APPROVED: 0, REJECTED: 0 },
          };
        
          for (const key of Object.keys(grouped)) {
            const { cat, last } = grouped[key];
            if (!counters[cat]) continue;
            if (last.phase === "APPROVED") counters[cat].APPROVED++;
            if (last.phase === "REJECTED") counters[cat].REJECTED++;
          }
        
          const out = [];
          // Materiales
          if (counters.MATERIAL.APPROVED) out.push({ type: "material_approved", message: `üü¢ Materiales aprobados (${counters.MATERIAL.APPROVED})` });
          if (counters.MATERIAL.REJECTED) out.push({ type: "material_rejected", message: `üî¥ Materiales rechazados (${counters.MATERIAL.REJECTED})` });
          // Derivaci√≥n
          if (counters.DERIVACION.APPROVED) out.push({ type: "derivation_approved", message: `üü¢ Derivaciones aprobadas (${counters.DERIVACION.APPROVED})` });
          if (counters.DERIVACION.REJECTED) out.push({ type: "derivation_rejected", message: `üî¥ Derivaciones rechazadas (${counters.DERIVACION.REJECTED})` });
          // Apoyo
          if (counters.APOYO.APPROVED) out.push({ type: "support_approved", message: `üü¢ Apoyos aprobados (${counters.APOYO.APPROVED})` });
          if (counters.APOYO.REJECTED) out.push({ type: "support_rejected", message: `üî¥ Apoyos rechazados (${counters.APOYO.REJECTED})` });
        
          return out;
        }
        
        // --- Chips de Validaciones Pendientes (robustos ante desfases) ---
         function renderPendingChips(incident) {
          // 1) Lo que dice Notion (campo multiselect)
          const vpField = incident["Validaciones Pendientes"] ?? incident.validaciones_pendientes ?? [];
          const notionSet = new Set(Array.isArray(vpField) ? vpField.map(s=>String(s).trim()) : []);
        
          // 2) Lo que dice el log (c√°lculo)
          const log = incident["Solicitudes (log)"] || incident.solicitudes_log || "";
          const pendingCats = getPendingCategoriesFromLog(log); // "MATERIAL","DERIVACION","APOYO"
        
          // Mapear categor√≠as ‚Üí etiqueta visible
          const labelByCat = {
            MATERIAL: "üì¶ Materiales",
            DERIVACION: "üè¢ Derivaci√≥n de departamento",
            APOYO: "üë• Apoyo segundo t√©cnico",
          };
        
          // Unificar
          const chips = new Set();
          pendingCats.forEach(cat => chips.add(labelByCat[cat]));
          notionSet.forEach(lbl => chips.add(lbl));
        
          if (chips.size === 0) {
            return `<span class="materials-badge materials-ok">‚úîÔ∏è Sin validaciones pendientes</span>`;
          }
          return Array.from(chips).map(lbl => `<span class="materials-badge materials-pending">${lbl}</span>`).join(" ");
        }

        function renderCurrentOwnerChip(inc){
          const level = parseInt(inc.escalation_level ?? 0, 10);
          // Prioridad: valor mapeado al nivel actual, y si no, campos legacy
          let owner = '';
          if (level === 0) owner = inc.l0_technician || inc.assigned_technician || '';
          if (level === 1) owner = inc.l1_technician || inc.assigned_technician || '';
          if (level === 2) owner = Array.isArray(inc.l2_technicians) ? inc.l2_technicians.join(', ') : (inc.l2_technicians || inc.assigned_technician || '');
          if (level === 3) owner = inc.l3_technician || inc.assigned_technician || '';
        
          const label = owner ? `üë§ Titular L${level}: ${owner}` : `üë§ Titular L${level}: ‚Äî`;
          return `<span class="chip">${label}</span>`;
        }

        // ==============================
        // RESPUESTAS (log) - Helpers
        // Campo Notion: "Respuestas (log)"
        // ==============================
        function parseRespLog(text = "") {
          const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
          const rows = [];
          for (const line of lines) {
            // [fecha] RESP#L<n>#<email>|<EVENTO>|<detalle>
            const m = line.match(/^\[(.+?)\]\s+RESP#L(\d)#([^|]+)\|([^|]+)\|?(.*)$/);
            if (!m) continue;
            const [, when, lvl, email, ev, detail] = m;
            rows.push({
              when: new Date(when),
              level: parseInt(lvl, 10),
              email: email.trim(),
              ev: ev.trim(),              // ASSIGNED | REASSIGN_TO | REASSIGN_FROM | REJECTED::<motivo> | NO_RESPONSE
              detail: (detail || "").trim()
            });
          }
          rows.sort((a,b)=> a.when - b.when);
          return rows;
        }
        
        // ¬øQui√©n es el titular vigente de un nivel?
       function getCurrentOwnerByLevel(respRows, level){
          // √∫ltimo evento ASSIGNED de ese nivel ‚Üí titular vigente
          const lastAssigned = respRows
            .filter(r => r.level === level && r.ev === 'ASSIGNED')
            .slice(-1)[0];
          return lastAssigned ? lastAssigned.email : null;
        }
        
        // √öltimo rechazo (motivo) por nivel, opcional
    function getLastRejectReasonByLevel(respRows, level){
          const lastRej = respRows
            .filter(r => r.level === level && r.phase === 'REJECTED')
            .slice(-1)[0];
          return lastRej ? lastRej.reason : '';
        }
        
        // ¬øC√≥mo va el t√©cnico logueado en este nivel?
        // Devuelve: 'working' | 'seguimiento' | 'pending'
        //   - working: si es titular vigente del nivel
        //   - seguimiento: si rechaz√≥ / fue reasignado / ya pas√≥ su respuesta
        //   - pending: si est√° notificado y sin respuesta en plazo (fallback con tus campos si hace falta)
        function getTechnicianStateByLevel(incident, respRows, level, technicianEmail) {
          const owner = getCurrentOwnerByLevel(respRows, level);
          if (owner && owner.toLowerCase() === (technicianEmail||"").toLowerCase()) return 'working';
        
          // ¬ørechaz√≥?
          const myEvents = respRows.filter(r => r.level === level && r.email.toLowerCase() === (technicianEmail||"").toLowerCase());
          const lastMine = myEvents[myEvents.length - 1];
          if (lastMine?.ev.startsWith("REJECTED")) return 'seguimiento';
          if (lastMine?.ev === "REASSIGN_FROM") return 'seguimiento';
        
          // Fallback ‚Äúpendiente‚Äù (si a√∫n usa campos antiguos):
          // ver si est√° asignado/notificado en este nivel y con SLA vigente y "‚≠ï Sin Respuesta"
          const now = Date.now();
          const slaEnd = getSlaEndForLevel(incident, level);
          const slaOk = slaEnd ? (Date.parse(slaEnd) - now) > 0 : false;
        
          if (level === 0) {
            if ((incident.l0_technician||"").includes(technicianEmail) && incident.l0_response === '‚≠ï Sin Respuesta' && slaOk) return 'pending';
          } else if (level === 1) {
            if ((incident.l1_technician||"").includes(technicianEmail) && incident.l1_response === '‚≠ï Sin Respuesta' && slaOk) return 'pending';
          } else if (level === 2) {
            if ((incident.l2_technicians||"").includes(technicianEmail) && (incident.l2_responses||"").includes('‚≠ï Sin Respuesta') && slaOk) return 'pending';
          } else if (level === 3) {
            if ((incident.l3_technician||"").includes(technicianEmail) && incident.l3_response === '‚≠ï Sin Respuesta' && slaOk) return 'pending';
          }
        
          return 'seguimiento';
        }
        
        // Fecha a mostrar en la tarjeta (occurrence si existe, si no, reporte)
        function getBestDate(incident) {
          const occ = incident["Fecha-Ocurrencia"] || incident.occurrence_date || incident.fecha_ocurrencia;
          const rep = incident["Fecha-Reporte"] || incident.report_date || incident.fecha_reporte;
          return occ || rep || incident.created_at || incident.timestamp || "";
        }

        // =============================
        // VALIDADORES DE L√çNEAS DE LOG
        // =============================
        
        // Regex estrictas (ISO con zona, categor√≠as/fases controladas)
        const RX_SOL = /^\[(?:\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?(?:Z|[+\-]\d{2}:\d{2}))\]\s+(?:MATERIAL|DERIVACION|APOYO)#[A-Za-z0-9_\-]+\|(REQUEST|APPROVED|REJECTED)\|.*$/;
        const RX_RESP = /^\[(?:\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?(?:Z|[+\-]\d{2}:\d{2}))\]\s+RESP#L[0-3]#[^|@\s]+@[^|@\s]+\.[^|@\s]+\|(ASSIGNED|REASSIGN_TO|REASSIGN_FROM|NO_RESPONSE|REJECTED::.+?)\|.*$/;
        
        function validateLogLines({ lines, kind }) {
          // kind: 'SOL' (Solicitudes) | 'RESP' (Respuestas)
          const rx = kind === 'SOL' ? RX_SOL : RX_RESP;
          const accepted = [];
          const rejected = [];
          for (let raw of (lines || [])) {
            const line = String(raw || "").trim();
            if (!line) continue;
            if (rx.test(line)) {
              accepted.push(line);
            } else {
              rejected.push({ line, reason: 'Formato inv√°lido para ' + (kind === 'SOL' ? 'Solicitudes' : 'Respuestas') });
            }
          }
          return { accepted, rejected };
        }
        
        // Genera el nuevo texto (append seguro) y devuelve tambi√©n las rechazadas
        function safeAppendLog({ currentText, newLines, kind }) {
          const { accepted, rejected } = validateLogLines({ lines: newLines, kind });
          const base = (currentText || "").trim();
          const joined = accepted.join("\n");
          const nextText = joined ? (base ? base + "\n" + joined : joined) : base;
          return { text: nextText, rejected };
        }

        // ===========================
        // VALIDACIONES PENDIENTES
        // ===========================
       // ===== Validaciones Pendientes (array con etiquetas + emoji) =====
        const VP = {
          MATERIALES: "üì¶ Materiales",
          DERIVACION: "üè¢ Derivaci√≥n de departamento",
          APOYO: "üë• Apoyo segundo t√©cnico",
        };
        
        function getPendingValidations(incident) {
          const arr = incident["Validaciones Pendientes"] ?? incident.validaciones_pendientes ?? [];
          return Array.isArray(arr) ? arr.map(x => String(x).trim()) : [];
        }
        function hasValidation(incident, label) {
          return getPendingValidations(incident).includes(label);
        }
        function canResolve(incident) {
          // Solo bloquea por Materiales
          return !hasValidation(incident, VP.MATERIALES);
        }
        
        // ===== SLA (solo en pending, si no vencido) =====
        function getCurrentLevel(incident) {
          return parseInt(incident.escalation_level ?? 0, 10);
        }
        function getSlaEndForLevel(incident, level) {
          if (level === 0) return incident.sla_l0_end || "";
          if (level === 1) return incident.sla_l1_backup_end || "";
          if (level === 2) return incident.sla_l2_equipo_end || "";
          if (level === 3) return incident.sla_l3_responsable_end || "";
          return "";
        }
        function formatRemain(ms) {
          const s = Math.max(0, Math.floor(ms / 1000));
          const h = Math.floor(s / 3600);
          const m = Math.floor((s % 3600) / 60);
          return h > 0 ? `${h}h ${m}m` : `${m}m`;
        }
        
        function renderSlaChipIfPending(incident, state) {
          if (state !== "pending") return "";
          const end = getSlaEndForLevel(incident, getCurrentLevel(incident));
          if (!end) return "";
          const delta = Date.parse(end) - Date.now();
          if (delta <= 0) return ""; // vencido ‚Üí no mostrar
          const mins = delta / 60000;
          const cls = mins <= 30 ? "sla-critical" : mins <= 120 ? "sla-warning" : "sla-good";
          return `<div class="sla-timer ${cls}">‚è±Ô∏è ${formatRemain(delta)}</div>`;
        }
        
        // ===== Banner para estado "seguimiento" =====
        function renderSeguimientoBanner(incident, state) {
          if (state !== "seguimiento") return "";
        
          const L = getCurrentLevel(incident);
          const end = getSlaEndForLevel(incident, L);
          const vencido = end ? (Date.now() > Date.parse(end)) : false;
        
          // Preferir motivo desde "Respuestas (log)"
          const respText = incident["Respuestas (log)"] || incident.respuestas_log || "";
          let reject = null;
          if (respText.trim()) {
            const rows = parseRespLog(respText);
            reject = getLastRejectReasonByLevel(rows, L);
          } else {
            // Fallback a tus campos antiguos
            reject =
              (L===0 && incident.l0_reject_reason) ||
              (L===1 && incident.l1_reject_reason) ||
              (L===2 && incident.l2_reject_reasons) ||
              "";
          }
        
          const finTxt = end ? new Date(end).toLocaleString() : "";
          if (vencido) return `<div class="seguimiento-banner">‚è∞ <strong>SLA vencido</strong> en L${L}${finTxt ? ` ¬∑ ${finTxt}` : ''}</div>`;
          if (reject)  return `<div class="seguimiento-banner">‚ùå <strong>Rechazado en L${L}</strong>${reject ? ` ‚Äî Motivo: ${reject}` : ""}</div>`;
          return `<div class="seguimiento-banner">‚ÑπÔ∏è En seguimiento en L${L}</div>`;
        }

        
        // ===== Botones por estado (usar SIEMPRE esta) =====
        function renderActionButtonsByState(state, incident) {
          const resolveDisabled = !canResolve(incident);
          const resolveTitle = resolveDisabled ? `title="Pendiente validar materiales"` : "";
        
          if (state === "pending") {
            return `
              <button class="btn btn-success" onclick="aceptarIncidencia('${incident.id}')">‚úÖ Aceptar</button>
              <button class="btn btn-danger" onclick="rechazarIncidencia('${incident.id}')">‚ùå Rechazar</button>
            `;
          }
        
          if (state === "working") {
            return `
              <button class="btn btn-secondary" onclick="abrirAyuda('${incident.id}')">üõ†Ô∏è Ayuda</button>
              <button class="btn btn-warning" onclick="abrirMateriales('${incident.id}')">üì¶ Materiales</button>
              <button class="btn btn-info" ${resolveDisabled ? "disabled" : ""} ${resolveTitle}
                      onclick="!this.disabled && abrirResolver('${incident.id}')">‚úÖ Resolver</button>
              <button class="btn btn-dark" onclick="finTurno('${incident.id}')">üïê Fin de turno</button>
            `;
          }
        
          // seguimiento
          return `
            <button class="btn btn-primary" onclick="solicitarAsignacion('${incident.id}')">üìå Solicitar asignaci√≥n</button>
          `;
        }

        // ========================================
        //  INICIALIZACI√ìN Y ACCESO DIRECTO URL
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si hay acceso directo por URL
            checkDirectAccess();
            
            // Permitir login con Enter
            document.getElementById('emailInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') loginWithPIN();
            });
        });

        function checkDirectAccess() {
          const urlParams = new URLSearchParams(window.location.search);
          const incidentId = urlParams.get('incident_id');
          const action = urlParams.get('action');
        
          if (incidentId) {
            directIncidentId = incidentId;
            directScrollDone = false; // aseg√∫rate de que haga scroll una sola vez tras render
        
            const directAccessInfo = document.createElement('div');
            directAccessInfo.style.cssText = `
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              background: #17a2b8;
              color: white;
              padding: 12px 20px;
              text-align: center;
              z-index: 10001;
              font-weight: 600;
            `;
            directAccessInfo.innerHTML = `
              üìß Acceso directo a incidencia: <strong>${incidentId}</strong>
              ${action ? ` | Acci√≥n: <strong>${action}</strong>` : ''}
            `;
            document.body.appendChild(directAccessInfo);
        
            if (action) pendingAction = action;
          }
        }


        // ========================================
        //  AYUDA / GESTI√ìN - TARJETAS EXPANDIBLES
        // ========================================
        const ayudaOptions = [
          { id: "aportar_informacion", title: "üìù Aportar informaci√≥n adicional",
            description: "Agrega m√°s detalles sobre la incidencia.",
            fields: `<textarea id="infoExtra" class="form-control" rows="3" placeholder="Describe la informaci√≥n adicional..."></textarea>`
          },
          { id: "revisar_materiales", title: "üìä Revisar estado materiales solicitados",
        description: "Abrir Notion con los materiales de la incidencia.",
        urlKey: "materials_url"
      },
      { id: "revisar_historial", title: "üîç Revisar historial del componente",
        description: "Abrir Notion con el historial de fallos.",
        urlKey: "history_url"
      },
      { id: "derivar_departamento", title: "üè¢ Derivar a otro departamento",
        description: "Transferir incidencia a otro departamento.",
        fields: `
          <label class="form-label">Departamento:</label>
          <select id="departamentoSelect" class="form-control">
            <option value="">-- Selecciona --</option>
            <option value="mecanica">Mec√°nica</option>
            <option value="electrica">El√©ctrica</option>
            <option value="it">IT</option>
          </select>
          <label class="form-label">Motivo:</label>
        <textarea id="motivoDerivacion" class="form-control" rows="3"></textarea>
        `
      },
      { id: "fin_de_turno", title: "üïê Fin de turno",
        description: "Ceder incidencia al siguiente turno.",
        fields: `<textarea id="detalleFinTurno" class="form-control" rows="3" placeholder="Detalles para el pr√≥ximo t√©cnico..."></textarea>`
      },
      { id: "apoyo_segundo_tecnico", title: "üë• Solicitar segundo t√©cnico",
        description: "Pide apoyo de otro t√©cnico.",
        fields: `<textarea id="detalleApoyo" class="form-control" rows="3" placeholder="Explica por qu√© necesitas apoyo."></textarea>`
      }
    ];
        
        let selectedAyuda = null;
        
        function loadAyudaOptions() {
          const container = document.getElementById('ayudaOptions');
          container.innerHTML = ayudaOptions.map(opt => `
            <div class="ayuda-card" data-id="${opt.id}" onclick="selectAyuda('${opt.id}', event)">
              <h4>${opt.title}</h4>
              <p>${opt.description}</p>
            </div>
          `).join('');
        }
        function finTurno(id){
          showAyudaModal(id);
          // preselecciona la tarjeta de ‚Äúfin_de_turno‚Äù
          setTimeout(() => {
            const card = document.querySelector('.ayuda-card[data-id="fin_de_turno"]');
            if (card) { card.click(); }
          }, 0);
        }

        
        // 2) Al seleccionar tarjeta, muestra bot√≥n que abre la URL espec√≠fica si existe
        function selectAyuda(id, ev) {
          selectedAyuda = ayudaOptions.find(opt => opt.id === id);
          document.querySelectorAll('.ayuda-card').forEach(c => c.classList.remove('selected'));
          ev.currentTarget.classList.add('selected');
        
          const extra = document.getElementById('ayudaExtraFields');
          if (selectedAyuda.fields) {
            extra.innerHTML = `<div class="ayuda-extra active">${selectedAyuda.fields}</div>`;
          } else if (selectedAyuda.urlKey) {
            const inc = allIncidents.find(i => i.id === currentIncidentId);
            const targetURL = inc?.[selectedAyuda.urlKey] || inc?.url || '#';
            extra.innerHTML = `<div class="ayuda-extra active">
              <a href="${targetURL}" target="_blank" class="btn btn-info">üåê Abrir en Notion</a>
            </div>`;
          } else {
            extra.innerHTML = '';
          }
        }
        
        function procesarAyuda() {
          if (!selectedAyuda) { alert("Selecciona una opci√≥n antes de continuar."); return; }
        
          const id = selectedAyuda.id;
            
         // 1) Tarjetas que abren URL (materiales / historial / lo que a√±adas con urlKey)
             if (selectedAyuda.urlKey) {
            const inc = allIncidents.find(i => i.id === currentIncidentId);
            const targetURL = inc?.[selectedAyuda.urlKey] || inc?.url;
            if (targetURL) window.open(targetURL, '_blank');
            closeModal('ayudaModal');
            return;
          }
        
          if (id === 'aportar_informacion') {
            const info = (document.getElementById('infoExtra')?.value || '').trim();
            handleAction('aportar_informacion', currentIncidentId, {
              description: info
            });
            closeModal('ayudaModal');
            return;
          }
        
          if (id === 'derivar_departamento') {
            const depto = document.getElementById('departamentoSelect')?.value;
            const motivo = (document.getElementById('motivoDerivacion')?.value || '').trim();
            if (!depto) { alert('Selecciona el departamento destino'); return; }
            handleAction('derivar_departamento', currentIncidentId, {
              help_type: 'derivar_departamento',
              target_department: depto,
              description: motivo
            });
            closeModal('ayudaModal');
            return;
          }
        
          if (id === 'apoyo_segundo_tecnico') {
            const motivo = (document.getElementById('detalleApoyo')?.value || '').trim();
            handleAction('solicitar_apoyo', currentIncidentId, {
              help_type: 'apoyo_segundo_tecnico',
              description: motivo
            });
            closeModal('ayudaModal');
            return;
          }
        
          if (id === 'fin_de_turno') {
            const detalle = (document.getElementById('detalleFinTurno')?.value || '').trim();
            // Validaci√≥n de ‚Äú√∫ltimos 15 minutos de turno‚Äù
            const now = new Date();
            const h = now.getHours(), m = now.getMinutes();
            const nearEnd = (h===13 && m>=45) || (h===21 && m>=45) || (h===5 && m>=45);
            if (!nearEnd) {
              alert('‚ùå Fin de turno solo disponible en los √∫ltimos 15 minutos del turno\n\nTurnos: 6-14h | 14-22h | 22-6h');
              return;
            }
            handleAction('fin_de_turno', currentIncidentId, {
              help_type: 'fin_de_turno',
              description: detalle
            });
            closeModal('ayudaModal');
            return;
          }
        }
        document.addEventListener("DOMContentLoaded", loadAyudaOptions);


        // ========================================
        //  SOLICITAR MATERIALES - MULTIPLE
        // ========================================
        let materialesTemp = [];
        
        function agregarMaterial() {
            const nombre = document.getElementById("matNombre").value.trim();
            const cantidad = document.getElementById("matCantidad").value;
            const tipo = document.getElementById("matTipo").value;
            const urgencia = document.getElementById("matUrgencia").value;
            const justificacion = document.getElementById("matJustificacion").value.trim();
        
            if (!nombre || !cantidad || !tipo) {
                alert("Por favor completa al menos nombre, cantidad y tipo.");
                return;
            }
        
            const nuevoMaterial = { nombre, cantidad, tipo, urgencia, justificacion };
            materialesTemp.push(nuevoMaterial);
        
            renderMaterialesList();
        
            // limpiar inputs
            document.getElementById("matNombre").value = "";
            document.getElementById("matCantidad").value = "";
            document.getElementById("matTipo").value = "";
            document.getElementById("matUrgencia").value = "normal";
            document.getElementById("matJustificacion").value = "";
        }
        
        function renderMaterialesList() {
            const container = document.getElementById("materialsList");
            if (materialesTemp.length === 0) {
                container.innerHTML = "<p>No hay materiales a√±adidos.</p>";
                return;
            }
        
            container.innerHTML = materialesTemp.map((mat, idx) => `
                <div class="material-item">
                    <strong>${mat.nombre}</strong> - Cantidad: ${mat.cantidad} (${mat.tipo}, ${mat.urgencia})
                    <p>${mat.justificacion || "Sin justificaci√≥n"}</p>
                    <div class="material-actions">
                        <button onclick="eliminarMaterial(${idx})">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
            `).join('');
        }
        
        function eliminarMaterial(index) {
            materialesTemp.splice(index, 1);
            renderMaterialesList();
        }
        
        function enviarMateriales() {
          if (materialesTemp.length === 0) {
            alert("No hay materiales para enviar.");
            return;
          }
          handleAction('solicitar_materiales', currentIncidentId, {
            materiales: materialesTemp // se env√≠a todo el array
          });
          materialesTemp = [];
          renderMaterialesList();
          closeModal("materialesModal");
        }


// Contenedor (grid 2 columnas)
const incidentsContainer = document.querySelector('.incidents-section .incidents-list');
        
// Estado en memoria
let allIncidents = [];
let currentStatusFilter = 'all';   // 'all' | 'nueva' | 'asignada' | 'escalado' | 'seguimiento'

// Spinner
    function showSpinner(){
      const el = document.getElementById('incidentsContainer');
      if (el) el.innerHTML = `<div class="loading-spinner">üîÑ Cargando incidencias...</div>`;
    }

    // Helpers existentes (SLA / seguimiento / safe / fecha)
    function safe(v){
      return (v === undefined || v === null || v === '{{emptystring}}') ? '' : v;
    }
    function dateVisible(inc){
      return safe(inc.occurrence_date) || safe(inc.report_date) || '';
    }
    function computeSlaText(inc){
      const arr = [inc.sla_l0_end, inc.sla_l1_backup_end, inc.sla_l2_equipo_end, inc.sla_l3_responsable_end];
      const pick = arr[inc.escalation_level] || null;
      if(!pick) return '';
      const now = new Date();
      const due = new Date(pick);
      const vencido = now > due ? 'SLA vencido' : 'SLA en curso';
      const nivel = `en L${inc.escalation_level}`;
      const fecha = due.toLocaleString();
      return `${vencido} ${nivel} ¬∑ ${fecha}`;
    }
    function computeSeguimiento(inc){
      // Regla que acordamos: chip ‚ÄúSEGUIMIENTO‚Äù cuando pausa=true O el estado no es "üö¶ Escalado"
      return inc.escalation_paused === true || inc.status !== 'üö¶ Escalado';
    }

    // Estado real calculado para *este* t√©cnico
    function computeCardState(inc){
      try{
        return getIncidentRealState(inc, currentTechnician?.email || '');
      }catch(e){
        // Fallback conservador
        return 'seguimiento';
      }
    }
    
    function matchesStatus(inc, status){
      if (status === 'all') return true;
      return computeCardState(inc) === status; // 'pending' | 'working' | 'seguimiento'
    }

        // ---------- Handlers de botones de filtro (llamados desde el HTML con onclick) ----------
        function filterByStatus(status, element){
          currentStatusFilter = status;
          document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));
          if (element) element.classList.add('active');
          applyFiltersAndRender();
        }
    

    // --------- RENDER NUEVO (no tocar) ----------
           function incidentCardHTML(inc) {
          const state = getIncidentRealState(inc, currentTechnician?.email || "");
          const slaChip = renderSlaPillInHeader(inc, state);
          const seguimientoBanner = renderSeguimientoBanner(inc, state);
          const validChipsHTML = renderPendingChips(inc);
          const notifList = buildNotificationsFromLog(inc);
        
          // Notificaciones ‚Üí chips
          const notifMap = {
            material_approved: 'üü¢ Materiales autorizados',
            material_rejected: 'üî¥ Materiales rechazados',
            derivation_approved: '‚úÖ Derivaci√≥n aprobada',
            derivation_rejected: '‚ùå Derivaci√≥n rechazada',
            support_approved: 'üë• Apoyo aprobado',
            support_rejected: 'üë• Apoyo rechazado',
            incident_closed: '‚úÖ Cerrada por supervisor',
            solution_rejected: 'üîÑ Soluci√≥n rechazada'
          };
          const notifChipCls = t => (
            t?.endsWith('approved') || t === 'incident_closed' ? 'notif-ok' :
            t?.endsWith('rejected') ? 'notif-bad' : 'notif-warn'
          );
          const notifChips = notifList.map(n =>
            `<span class="notif-chip ${notifChipCls(n.type)}">${notifMap[n.type] || n.message || 'Aviso'}</span>`
          ).join(" ");
        
          return `
            <div class="incident-card" data-incident-id="${safe(inc.id)}">
              ${seguimientoBanner}
              <div class="incident-header">
                <div>
                  <div class="incident-title">${safe(inc.id)} ‚Äî ${safe(inc.priority)}</div>
                  <div class="incident-meta">
                    <span>‚öôÔ∏è ${safe(inc.equipment)}</span>
                    <span>üìç ${safe(inc.zone)}</span>
                    <span>üìÖ ${dateVisible(inc)}</span>
                  </div>
                </div>
                <div class="incident-header-right">
                  <span class="state-badge">${getStateLabel(state)}</span>
                  ${slaChip || ""}
                </div>
              </div>
        
              <div class="chips">
                ${validChipsHTML}
                ${notifChips}
              </div>
        
              <div class="desc">${safe(inc.description)}</div>
        
              <div class="incident-actions">
                ${renderActionButtonsByState(state, inc)}
                <a class="btn btn-primary" href="${safe(inc.url)}" target="_blank">üîó Notion</a>
              </div>
        
              ${renderDetailsSection(inc)}
            </div>
          `;
        }

        function renderDetailsSection(inc) {
          return `
            <details>
              <summary>üìá Contactos</summary>
              ${renderContacts(inc)}
            </details>
            <details>
              <summary>üìù Acciones tomadas y notas</summary>
              <div class="detail-grid">
                <div><div class="muted">Acciones tomadas</div><div class="log">${safe(inc.actions_taken) || 'Sin acciones'}</div></div>
                <div><div class="muted">Notas de asignaci√≥n</div><div class="log">${safe(inc.assignment_notes) || '‚Äî'}</div></div>
              </div>
            </details>
            <details>
              <summary>üìà Historial de escalado</summary>
              ${renderEscalationHistory(inc)}
            </details>
            <details>
              <summary>üì¶ Solicitudes recientes</summary>
              ${renderSolicitudesResumen(inc)}
            </details>
          `;
        }

        
      function renderContacts(inc){
          const tel = v => v ? ` <a href="tel:${v}" class="btn-link">${v}</a>` : ' ‚Äî';
          const row = (label, name, phone) =>
            `<div><strong>${label}:</strong> ${safe(name) || '‚Äî'}${tel(safe(phone))}</div>`;
        
          return `
          <div class="detail-grid">
            <div>
              ${row('Supervisor', inc.supervisor, inc.supervisor_phone)}
              ${row('Encargado de zona', inc.zone_manager, inc.zone_manager_phone)}
              ${row('T√©cnico asignado', inc.assigned_technician, inc.assigned_technician_phone)}
            </div>
            <div>
              ${row('Reporta', inc.reporter, inc.reporter_phone)}
              <div><strong>Fecha ocurrencia:</strong> ${formatDate(inc.occurrence_date)}</div>
              <div><strong>Fecha reporte:</strong> ${formatDate(inc.report_date)}</div>
            </div>
          </div>`;
        }


        
        function renderEscalationHistory(inc){
          const t = inc["Respuestas (log)"] || inc.respuestas_log || '';
          if(!t.trim()) return `<div class="muted">Sin historial</div>`;
          const rows = parseRespLog(t).slice(-12);
          const items = rows.map(r => {
            const who = r.email;
            const ev  = r.ev.replace('REJECTED::','Rechazado: ');
            return `<li><span class="t-time">${r.when.toLocaleString()}</span>
                    <span class="t-body">L${r.level} ¬∑ ${ev} ¬∑ ${who}</span></li>`;
          }).join('');
          return `<ul class="timeline">${items}</ul>`;
        }
        
        function renderSolicitudesResumen(inc){
          const t = inc["Solicitudes (log)"] || inc.solicitudes_log || '';
          if(!t.trim()) return `<div class="muted">Sin solicitudes</div>`;
          const rows = parseSolicitudesLog(t);        // ya la tienes
          const grouped = groupByRequest(rows);       // ya la tienes
          // Orden por fecha de √∫ltimo evento
          const items = Object.values(grouped)
            .sort((a,b)=> new Date(b.last.when)-new Date(a.last.when))
            .slice(0,12)
            .map(g => {
              const badge = g.last.phase === 'APPROVED' ? '‚úÖ'
                         : g.last.phase === 'REJECTED' ? '‚ùå' : '‚è≥';
              return `<li><span class="t-time">${new Date(g.last.when).toLocaleString()}</span>
                      <span class="t-body">${badge} ${g.cat}#${g.id} ¬∑ ${g.last.phase}</span></li>`;
            }).join('');
          return `<ul class="timeline">${items}</ul>`;
        }




    function renderIncidents(incidents) {
      const legacy = document.getElementById('incidentsContainer');
      if (legacy) legacy.innerHTML = '';
    
      incidentsContainer.innerHTML = '';
      if (!Array.isArray(incidents) || incidents.length === 0) {
        incidentsContainer.innerHTML = `
          <div class="loading-spinner" style="padding:24px;">
            ‚úÖ No hay incidencias asignadas
          </div>`;
        return;
      }
    
      const frag = document.createDocumentFragment();
      incidents.forEach(inc => {
        const wrap = document.createElement('div');
        wrap.innerHTML = incidentCardHTML(inc);
        const card = wrap.firstElementChild;
    
        const btn = card.querySelector('.js-toggle-desc');
        const desc = card.querySelector('.desc');
        if (btn && desc) {
          btn.addEventListener('click', () => {
            const expanded = desc.style.webkitLineClamp === 'unset';
            if (expanded) {
              desc.style.display = '-webkit-box';
              desc.style.webkitLineClamp = '3';
              btn.textContent = 'Ver m√°s';
            } else {
              desc.style.display = 'block';
              desc.style.webkitLineClamp = 'unset';
              btn.textContent = 'Ver menos';
            }
          });
        }
    
        frag.appendChild(card);
      });
    
      incidentsContainer.appendChild(frag);
    }
    
    // ---------- Aplicar filtros y pintar ----------
    function applyFiltersAndRender() {
      const tech = currentTechnician?.email || '';
      const list = allIncidents.filter(inc => {
        const st = getIncidentRealState(inc, tech);
        if (currentStatusFilter === 'all') return true;
        return st === currentStatusFilter;
      });
      renderIncidents(list);
    }
    
    window.filterByStatus = function(status, element){
      currentStatusFilter = status; // 'all' | 'pending' | 'working' | 'seguimiento'
      document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
      if (element) element.classList.add('active');
      applyFiltersAndRender();
    };
    
    window.filterByPriority = function(priority, button) {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      if (button) button.classList.add('active');
      applyFiltersAndRender();
    };
    
    // Carga inicial
    showSpinner();
     // Expone funciones usadas por HTML inline
    window.loginWithPIN = loginWithPIN;
    window.verifyPIN = verifyPIN;
    window.showPINError = showPINError;
    window.closePINModal = closePINModal;
    
    window.loadDashboard = loadDashboard;
    window.refreshDashboard = refreshDashboard;
    
    window.filterByStatus = filterByStatus;
    window.filterByPriority = filterByPriority;
    
    window.handleAction = handleAction;
    window.showResolverModal = showResolverModal;
    window.showMaterialesModal = showMaterialesModal;
    window.showAyudaModal = showAyudaModal;
    window.closeModal = closeModal;
        
    </script>
</body>
</html>
