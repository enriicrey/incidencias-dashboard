<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard T√©cnico - Sistema de Incidencias ABC.xyz</title>
    
    <style>
        /* ==========================================
           üßπ CSS LIMPIO Y ORGANIZADO - SIN DUPLICADOS
           ========================================== */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* ==========================================
           üîê LOGIN SCREEN
           ========================================== */
        
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .verify-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .verify-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .verify-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .error-message {
            background: #fee;
            color: #c0392b;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
        }

        /* ==========================================
           üì± HEADER PRINCIPAL
           ========================================== */
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .refresh-button {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .refresh-button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.25);
        }

        .refresh-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ==========================================
           üìä MAIN CONTAINER
           ========================================== */
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
            background: #f8fafc;
            min-height: calc(100vh - 80px);
        }

        /* ==========================================
           üìà STATS BAR (FILTROS CLICABLES)
           ========================================== */
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .stat-card.active {
            border-color: #3498db;
            background: linear-gradient(135deg, #e3f2fd, #ffffff);
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-number.pending { color: #f39c12; }
        .stat-number.working { color: #27ae60; }
        .stat-number.expired { color: #e74c3c; }

        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
            font-weight: 500;
        }

        /* ==========================================
           üéõÔ∏è FILTERS BAR
           ========================================== */
        
        .filters-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            background: white;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active, .filter-btn:hover {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        /* ==========================================
           üìã LAYOUT 2 COLUMNAS - GRID PRINCIPAL
           ========================================== */
        
        .incidents-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)) !important;
            gap: 25px !important;
            padding: 0 !important;
            width: 100% !important;
        }

        /* ==========================================
           üé¥ INCIDENT CARDS - DISE√ëO LIMPIO
           ========================================== */
        
        .incident-card {
            background: white !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 16px !important;
            padding: 25px !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05) !important;
            transition: all 0.3s ease !important;
            position: relative;
            overflow: hidden;
            break-inside: avoid;
            min-width: 450px;
            width: 100%;
        }

        .incident-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1) !important;
            transform: translateY(-3px) !important;
            border-color: #3498db !important;
        }

        .incident-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f3f4f6;
        }

        .incident-title h4 {
            margin: 0 0 10px 0;
            color: #1f2937;
            font-size: 1.2rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .priority-badge {
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .incident-id {
            font-size: 13px;
            color: #6b7280;
            background: #f9fafb;
            padding: 6px 10px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .incident-body {
            margin-bottom: 20px;
        }

        .zone {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #374151;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            background: #f3f4f6;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .description {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 15px;
            background: #fafbfc;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #e5e7eb;
        }

        /* ==========================================
           ‚è±Ô∏è SLA TIMERS - DISE√ëO MEJORADO
           ========================================== */
        
        .sla-info {
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sla-timer.sla-good {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border: 1px solid #10b981;
        }

        .sla-timer.sla-warning {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .sla-timer.sla-critical {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #991b1b;
            border: 1px solid #ef4444;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .sla-expired {
            background: linear-gradient(135deg, #fef2f2, #fee2e2) !important;
            color: #991b1b !important;
            padding: 12px 16px !important;
            border-radius: 10px !important;
            font-weight: 700 !important;
            border: 2px solid #ef4444 !important;
            animation: pulse 2s infinite;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ==========================================
           üìû INFORMACI√ìN ADICIONAL - T√âCNICOS Y CONTACTOS
           ========================================== */
        
        .technician-info {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 12px 16px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 14px;
            border-left: 4px solid #0ea5e9;
        }

        .technician-info.current-tech {
            background: linear-gradient(135deg, #ecfdf5, #d1fae5) !important;
            border-left-color: #10b981 !important;
            color: #065f46 !important;
            font-weight: 600 !important;
        }

        .contacts-info {
            background: linear-gradient(135deg, #fefce8, #fef3c7);
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid #eab308;
        }

        .contacts-header {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contacts-header:hover {
            color: #78350f;
        }

        .contacts-list {
            margin-top: 10px;
        }

        .contacts-list div {
            margin: 6px 0;
            font-size: 13px;
            color: #713f12;
        }

        .contacts-list a {
            color: #2563eb;
            text-decoration: none;
            font-weight: 600;
        }

        .contacts-list a:hover {
            text-decoration: underline;
        }

        .time-elapsed {
            background: linear-gradient(135deg, #fdf4ff, #fae8ff);
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 8px;
            color: #7c2d92;
            font-size: 14px;
            border-left: 4px solid #a855f7;
        }

        .actions-taken {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            color: #166534;
            font-size: 14px;
            line-height: 1.4;
            border-left: 4px solid #22c55e;
        }

        /* ==========================================
           üìä HISTORIAL DE ESCALADO
           ========================================== */

        .escalation-history {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            margin: 15px 0;
            overflow: hidden;
        }

        .escalation-header {
            background: #e2e8f0;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #475569;
            transition: background 0.3s ease;
        }

        .escalation-header:hover {
            background: #cbd5e1;
        }

        .escalation-content {
            display: none;
            padding: 15px;
        }

        .escalation-level {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }

        .escalation-level.completed {
            background: #f0f9ff;
            border-left: 4px solid #10b981;
        }

        .escalation-level.current {
            background: #fff7ed;
            border-left: 4px solid #f59e0b;
        }

        .escalation-level.pending {
            background: #f8fafc;
            border-left: 4px solid #94a3b8;
        }

        .escalation-level.expired {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
        }

        .escalation-level.escalated {
            background: #f3f4f6;
            border-left: 4px solid #6b7280;
        }

        .level-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .level-details {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.4;
        }

        /* ==========================================
           üéØ BOTONES DE ACCI√ìN
           ========================================== */
        
        .incident-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f3f4f6;
        }

        .incident-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .incident-actions .btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(34, 197, 94, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(245, 158, 11, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(59, 130, 246, 0.3);
        }

        .no-action-info {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 8px;
            color: #64748b;
            font-style: italic;
            border: 1px solid #e2e8f0;
        }

        /* ==========================================
           üì± NO INCIDENTS MESSAGE
           ========================================== */
        
        .no-incidents {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .no-incidents-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .no-incidents h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #374151;
        }

        .no-incidents p {
            font-size: 16px;
            color: #6b7280;
        }

        /* ==========================================
           üì± RESPONSIVE DESIGN
           ========================================== */
        
        @media (max-width: 1200px) {
            .incidents-grid {
                grid-template-columns: 1fr !important;
            }
            
            .incident-card {
                min-width: auto;
                max-width: none;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 15px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .filters-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .incidents-grid {
                gap: 20px !important;
                padding: 10px !important;
            }
            
            .incident-card {
                padding: 20px !important;
            }
            
            .incident-actions {
                flex-direction: column;
            }
            
            .incident-actions .btn {
                min-width: auto;
            }
        }

        /* ==========================================
           üé® BADGES Y ESTADOS ADICIONALES
           ========================================== */
        
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }

        .bg-success { background: #22c55e; color: white; }
        .bg-warning { background: #f59e0b; color: white; }
        .bg-danger { background: #ef4444; color: white; }
        .bg-info { background: #3b82f6; color: white; }
        .bg-secondary { background: #6b7280; color: white; }
        .bg-light { background: #f3f4f6; color: #374151; }
        
        /* Estilos para las secciones colapsables */
        .toggle-icon {
            font-size: 14px;
            transition: transform 0.3s ease;
        }
        
        .escalation-header:hover .toggle-icon,
        .contacts-header:hover .toggle-icon {
            transform: scale(1.2);
        }

    </style>
</head>
<body>
    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <h1 class="login-title">
                <span>üîß</span>
                <span>Dashboard T√©cnico</span>
            </h1>
            <p class="login-subtitle">Accede con tu email para gestionar incidencias</p>
            <div class="input-group">
                <label class="input-label" for="emailInput">Email T√©cnico</label>
                <input type="email" class="input-field" id="emailInput" placeholder="ejemplo@empresa.com" autocomplete="email">
            </div>
            <button onclick="loginWithPIN()" class="verify-btn" id="loginBtn">
                üîê Acceder con PIN
            </button>
            <div id="loginError" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <!-- Header Principal -->
    <div class="header" id="mainHeader" style="display: none;">
        <div class="header-content">
            <div class="logo">
                <span>üîß</span>
                <span class="logo-text">ABC.xyz</span>
                <span id="dashboardTitle">Dashboard T√©cnico</span>
            </div>
            <div class="user-info">
                <div class="auth-status" id="authStatus">
                    <span id="authMessage">‚ö†Ô∏è Cargando...</span>
                </div>
                <button id="refreshBtn" class="refresh-button" onclick="refreshIncidents()">
                    üîÑ Actualizar
                </button>
                <p id="lastUpdate" class="last-update">--:--</p>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container" id="mainContainer" style="display: none;">
        <!-- Stats Bar (Clickeable como filtros) -->
        <div class="stats-bar">
            <div class="stat-card active" onclick="filterByStatus('all', this)">
                <div class="stat-number" id="totalCount" style="color: #6b7280;">0</div>
                <div class="stat-label">Todas</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('pending', this)">
                <div class="stat-number pending" id="pendingCount">0</div>
                <div class="stat-label">Pendientes</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('working', this)">
                <div class="stat-number working" id="workingCount">0</div>
                <div class="stat-label">Trabajando</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('expired', this)">
                <div class="stat-number expired" id="expiredCount">0</div>
                <div class="stat-label">Vencidas</div>
            </div>
        </div>

        <!-- Filters Bar - Solo Prioridad -->
        <div class="filters-bar">
            <div class="filter-group">
                <span class="filter-label">Prioridad:</span>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByPriority('all', this)">Todas</button>
                    <button class="filter-btn" onclick="filterByPriority('CR√çTICA', this)">üî¥ Cr√≠tica</button>
                    <button class="filter-btn" onclick="filterByPriority('ALTA', this)">üü† Alta</button>
                    <button class="filter-btn" onclick="filterByPriority('MEDIA', this)">üü° Media</button>
                    <button class="filter-btn" onclick="filterByPriority('BAJA', this)">üü¢ Baja</button>
                </div>
            </div>
        </div>

        <!-- Incidents Container -->
        <div id="incidentsContainer">
            <!-- Las incidencias se renderizan aqu√≠ -->
        </div>
    </div>

    <script>
        // ==========================================
        // üîß VARIABLES GLOBALES
        // ==========================================
        
        let allIncidents = [];
        let currentTechnician = null;
        let currentStatusFilter = 'all';
        let currentPriorityFilter = 'all';
        let refreshInterval = null;
        let slaTimerInterval = null;

        // URLs de la API - Compatible con Make
        const API_BASE_URL = 'https://hook.eu2.make.com/yfvnx6wuypyvqp8ph7cw7tkqlcnh6fpk';
        const API_RESPONSE = 'https://hook.eu2.make.com/7mh1bxlzb4mj6rjujhd99mqpf9kdmhfi';

        // ==========================================
        // üîê SISTEMA DE AUTENTICACI√ìN CORREGIDO
        // ==========================================
        
        async function loginWithPIN() {
            const emailInput = document.getElementById('emailInput');
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');
            
            const email = emailInput.value.trim();
            
            if (!email) {
                showLoginError('Ingresa tu email');
                return;
            }

            if (!email.includes('@')) {
                showLoginError('Email inv√°lido');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'üîê Verificando...';
            loginError.style.display = 'none';

            try {
                // Prompt para PIN
                const pin = prompt('Ingresa tu PIN de t√©cnico (4 d√≠gitos):');
                
                if (!pin || pin.trim() === '') {
                    showLoginError('PIN es obligatorio');
                    return;
                }

                if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                    showLoginError('PIN debe ser 4 d√≠gitos num√©ricos');
                    return;
                }

                // Validar con la API
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'verify_pin',
                        email: email,
                        pin: pin
                    })
                });

                // ‚úÖ CORRECCI√ìN: Manejo robusto de respuestas
                let data = null;
                try {
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                        data = await response.json();
                    } else {
                        const textResponse = await response.text();
                        console.warn('Respuesta no JSON:', textResponse);
                        throw new Error('Respuesta inv√°lida del servidor');
                    }
                } catch (parseError) {
                    console.error('Error parsing JSON:', parseError);
                    throw new Error('Error procesando respuesta del servidor');
                }
                
                // ‚úÖ CORRECCI√ìN: Validaci√≥n mejorada
                if (response.ok && data && data.success) {
                    currentTechnician = {
                        email: email,
                        name: data.technician?.name || email.split('@')[0],
                        department: data.technician?.department || 'Sin departamento',
                        level: data.technician?.level || 1,
                        hasFullAccess: Boolean(data.technician?.hasFullAccess)
                    };
                    
                    // Cargar dashboard
                    await loadDashboard();
                    
                    // Mostrar interfaz principal
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('mainHeader').style.display = 'block';
                    document.getElementById('mainContainer').style.display = 'block';
                    
                    // Iniciar actualizaci√≥n autom√°tica cada 30 segundos
                    refreshInterval = setInterval(loadDashboard, 30000);
                    
                } else {
                    const errorMessage = (data && data.message) || 'PIN incorrecto o error del servidor';
                    showLoginError(errorMessage);
                }
                
            } catch (error) {
                console.error('Error en login:', error);
                showLoginError('Error de conexi√≥n: ' + error.message);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'üîê Acceder con PIN';
            }
        }

        function showLoginError(message) {
            const loginError = document.getElementById('loginError');
            loginError.textContent = message;
            loginError.style.display = 'block';
        }

        // ==========================================
        // üìä CARGA DE DATOS CORREGIDA
        // ==========================================

        async function loadDashboard() {
            try {
                console.log('üîÑ Cargando dashboard...');
                
                if (!currentTechnician?.email) {
                    throw new Error('No hay t√©cnico autenticado');
                }
                
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'get_incidents',
                        technician_email: currentTechnician.email
                    })
                });

                // ‚úÖ CORRECCI√ìN: Manejo robusto de respuestas
                let data = null;
                try {
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                        data = await response.json();
                    } else {
                        console.warn('Respuesta no JSON en loadDashboard, usando datos vac√≠os');
                        data = { success: false, incidents: [] };
                    }
                } catch (parseError) {
                    console.error('Error parsing JSON en loadDashboard:', parseError);
                    data = { success: false, incidents: [] };
                }

                if (response.ok && data && data.success) {
                    allIncidents = adaptIncidentData(data);
                    renderIncidents();
                    updateStats();
                    
                    // ‚úÖ CORRECCI√ìN: Acceso seguro a propiedades
                    const hasFullAccess = currentTechnician?.hasFullAccess || false;
                    const technicianName = currentTechnician?.name || 'T√©cnico';
                    
                    // Actualizar informaci√≥n del header
                    document.getElementById('dashboardTitle').textContent = `Dashboard - ${technicianName}`;
                    document.getElementById('authMessage').textContent = hasFullAccess ? 
                        '‚úÖ Acceso completo' : 'üëÅÔ∏è Solo lectura';
                    document.getElementById('authMessage').style.color = hasFullAccess ? '#059669' : '#d97706';
                    
                    updateLastUpdateTime();
                } else {
                    console.error('Error en datos:', data?.message || 'Respuesta inv√°lida');
                    allIncidents = [];
                    renderIncidents();
                    updateStats();
                }
                
            } catch (error) {
                console.error('Error cargando dashboard:', error);
                // ‚úÖ CORRECCI√ìN: Manejo graceful de errores
                allIncidents = [];
                renderIncidents();
                updateStats();
                
                // Mostrar mensaje de error en UI
                const container = document.getElementById('incidentsContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="no-incidents">
                            <div class="no-incidents-icon">‚ö†Ô∏è</div>
                            <h3>Error de conexi√≥n</h3>
                            <p>No se pudieron cargar las incidencias. Verifica tu conexi√≥n.</p>
                            <button onclick="loadDashboard()" style="margin-top: 15px; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                üîÑ Reintentar
                            </button>
                        </div>
                    `;
                }
            }
        }

        async function refreshIncidents() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'üîÑ Actualizando...';
            
            await loadDashboard();
            
            refreshBtn.disabled = false;
            refreshBtn.textContent = 'üîÑ Actualizar';
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('lastUpdate').textContent = timeString;
        }

        // ==========================================
        // üîß FUNCI√ìN ADAPTADOR DE DATOS MEJORADA
        // ==========================================

        function adaptIncidentData(data) {
            // ‚úÖ CORRECCI√ìN: Validaci√≥n robusta de datos
            let incidents = [];
            
            try {
                if (data && data.incidents && Array.isArray(data.incidents)) {
                    incidents = data.incidents;
                } else if (data && data.data && Array.isArray(data.data)) {
                    incidents = data.data;
                } else if (Array.isArray(data)) {
                    incidents = data;
                } else {
                    console.warn('Formato de datos no reconocido:', data);
                    return [];
                }
                
                return incidents.map(incident => {
                    // ‚úÖ CORRECCI√ìN: Validaci√≥n de cada incidencia
                    if (!incident || typeof incident !== 'object') {
                        console.warn('Incidencia inv√°lida:', incident);
                        return null;
                    }
                    
                    return {
                        id: incident.id || incident.incident_id || `INC-${Date.now()}`,
                        equipment: incident.equipment || incident.component || incident.equipo_afectado || 'Equipo no especificado',
                        component: incident.component || incident.equipment || '',
                        zone: incident.zone || incident.zona || 'Sin zona',
                        description: incident.description || incident.descripcion || 'Sin descripci√≥n',
                        priority: incident.priority || incident.prioridad || 'MEDIA',
                        escalation_level: parseInt(incident.escalation_level || incident.nivel_escalado || 0),
                        escalation_paused: String(incident.escalation_paused || incident.escalado_pausado || 'false'),
                        
                        // T√©cnicos - con validaci√≥n
                        l0_technician: incident.l0_technician || incident.tecnico_l0 || '',
                        l1_technician: incident.l1_technician || incident.tecnico_l1_backup || '',
                        l2_technicians: incident.l2_technicians || incident.tecnicos_l2_equipo || '',
                        l3_supervisor: incident.l3_supervisor || incident.l3_responsable || '',
                        
                        // Respuestas
                        l0_response: incident.l0_response || incident.respuesta_tecnico_l0 || '',
                        l1_response: incident.l1_response || incident.respuesta_tecnico_l1 || '',
                        l2_response: incident.l2_response || incident.respuesta_tecnico_l2 || '',
                        l3_response: incident.l3_response || incident.respuesta_supervisor_l3 || '',
                        
                        // SLA - con validaci√≥n de fechas
                        sla_l0_end: validateDate(incident.sla_l0_end || incident.sla_l0),
                        sla_l1_backup_end: validateDate(incident.sla_l1_backup_end || incident.sla_l1_backup),
                        sla_l2_equipo_end: validateDate(incident.sla_l2_equipo_end || incident.sla_l2_equipo),
                        sla_l3_responsable_end: validateDate(incident.sla_l3_responsable_end || incident.sla_l3_responsable),
                        
                        // Fechas
                        l0_acceptance_date: validateDate(incident.l0_acceptance_date || incident.fecha_aceptacion_l0),
                        l0_rejection_date: validateDate(incident.l0_rejection_date || incident.fecha_rechazo_l0),
                        l1_acceptance_date: validateDate(incident.l1_acceptance_date || incident.fecha_aceptacion_l1),
                        l1_rejection_date: validateDate(incident.l1_rejection_date || incident.fecha_rechazo_l1),
                        l2_acceptance_date: validateDate(incident.l2_acceptance_date || incident.fecha_aceptacion_l2),
                        
                        // Motivos
                        l0_rejection_reason: incident.l0_rejection_reason || incident.motivo_rechazo_l0 || '',
                        l1_rejection_reason: incident.l1_rejection_reason || incident.motivo_rechazo_l1 || '',
                        
                        // Contactos
                        reporter: incident.reporter || incident.reportador || '',
                        reporter_phone: incident.reporter_phone || incident.telefono_reporta || '',
                        supervisor: incident.supervisor || incident.supervisor_nombre || '',
                        supervisor_phone: incident.supervisor_phone || incident.telefono_supervisor || '',
                        zone_manager: incident.zone_manager || incident.encargado_zona || '',
                        zone_manager_phone: incident.zone_manager_phone || incident.telefono_encargado || '',
                        
                        // Informaci√≥n adicional
                        time_elapsed: parseInt(incident.time_elapsed || incident.tiempo_transcurrido || 0),
                        actions_taken: incident.actions_taken || incident.acciones_tomadas || '',
                        occurrence_date: validateDate(incident.occurrence_date || incident.fecha_ocurrencia),
                        report_date: validateDate(incident.report_date || incident.fecha_reporte)
                    };
                }).filter(incident => incident !== null); // ‚úÖ CORRECCI√ìN: Filtrar nulos
                
            } catch (error) {
                console.error('Error adaptando datos:', error);
                return [];
            }
        }

        // ==========================================
        // üõ†Ô∏è FUNCI√ìN AUXILIAR PARA VALIDAR FECHAS
        // ==========================================

        function validateDate(dateString) {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return '';
                }
                return dateString;
            } catch (error) {
                console.warn('Fecha inv√°lida:', dateString);
                return '';
            }
        }

        // ==========================================
        // üé® FUNCI√ìN DE RENDERIZADO CON INFORMACI√ìN COMPLETA
        // ==========================================
        
        function renderIncidents() {
            const container = document.getElementById('incidentsContainer');
            const filteredIncidents = filterIncidents();
            const technicianEmail = currentTechnician?.email || '';
            
            console.log('üé® Renderizando', filteredIncidents.length, 'incidencias');
            
            if (filteredIncidents.length === 0) {
                container.innerHTML = `
                    <div class="no-incidents">
                        <div class="no-incidents-icon">üìã</div>
                        <h3>No hay incidencias</h3>
                        <p>No tienes incidencias ${currentStatusFilter === 'all' ? '' : 'con este estado'} en este momento.</p>
                    </div>
                `;
                return;
            }

            // ==========================================
            // üéØ RENDERIZADO CON INFORMACI√ìN COMPLETA
            // ==========================================
            const incidentsHTML = filteredIncidents.map(incident => {
                const realState = getIncidentRealState(incident, technicianEmail);
                const canRespond = canTechnicianRespond(incident, technicianEmail);
                const escalationLevel = parseInt(incident.escalation_level) || 0;
                
                // =======================================
                // ‚è±Ô∏è DETERMINAR SLA APROPIADO Y NIVEL
                // =======================================
                let slaEnd = null;
                let slaLabel = '';
                if (incident.l0_technician === technicianEmail && incident.sla_l0_end) {
                    slaEnd = incident.sla_l0_end;
                    slaLabel = 'SLA L0';
                } else if (incident.l1_technician === technicianEmail && incident.sla_l1_backup_end) {
                    slaEnd = incident.sla_l1_backup_end;
                    slaLabel = 'SLA L1';
                } else if (escalationLevel === 2 && incident.sla_l2_equipo_end) {
                    slaEnd = incident.sla_l2_equipo_end;
                    slaLabel = 'SLA L2';
                } else if (escalationLevel === 3 && incident.sla_l3_responsable_end) {
                    slaEnd = incident.sla_l3_responsable_end;
                    slaLabel = 'SLA L3';
                } else {
                    // Mostrar SLA del nivel actual aunque no sea nuestro
                    switch(escalationLevel) {
                        case 0: 
                            if (incident.sla_l0_end) {
                                slaEnd = incident.sla_l0_end; 
                                slaLabel = 'SLA L0';
                            }
                            break;
                        case 1: 
                            if (incident.sla_l1_backup_end) {
                                slaEnd = incident.sla_l1_backup_end; 
                                slaLabel = 'SLA L1';
                            }
                            break;
                        case 2: 
                            if (incident.sla_l2_equipo_end) {
                                slaEnd = incident.sla_l2_equipo_end; 
                                slaLabel = 'SLA L2';
                            }
                            break;
                        case 3: 
                            if (incident.sla_l3_responsable_end) {
                                slaEnd = incident.sla_l3_responsable_end; 
                                slaLabel = 'SLA L3';
                            }
                            break;
                    }
                }
                
                // =======================================
                // ‚è∞ CALCULAR TIEMPO SLA RESTANTE
                // =======================================
                let slaInfo = '';
                if (slaEnd) {
                    const now = new Date();
                    const endTime = new Date(slaEnd);
                    const diffMinutes = Math.floor((endTime - now) / 1000 / 60);
                    
                    if (diffMinutes < 0) {
                        slaInfo = `<div class="sla-expired">‚è∞ VENCIDO hace ${Math.abs(diffMinutes)} min (${slaLabel})</div>`;
                    } else {
                        const hours = Math.floor(diffMinutes / 60);
                        const minutes = diffMinutes % 60;
                        let slaClass = '';
                        if (diffMinutes <= 30) slaClass = 'sla-critical';
                        else if (diffMinutes <= 60) slaClass = 'sla-warning';
                        else slaClass = 'sla-good';
                        
                        slaInfo = `<div class="sla-timer ${slaClass}" data-end="${slaEnd}">‚è±Ô∏è ${hours}h ${minutes.toString().padStart(2, '0')}m (${slaLabel})</div>`;
                    }
                }
                
                // =======================================
                // üè∑Ô∏è DETERMINAR BADGE DE ESTADO
                // =======================================
                let stateBadge = '';
                if (realState === 'working') {
                    stateBadge = '<span class="badge bg-success">üîÑ Trabajando</span>';
                } else if (realState === 'pending') {
                    stateBadge = '<span class="badge bg-warning">‚è≥ Puedes responder</span>';
                } else if (realState === 'expired') {
                    stateBadge = '<span class="badge bg-danger">‚è∞ Vencida</span>';
                } else if (incident.escalation_paused === 'true') {
                    stateBadge = '<span class="badge bg-secondary">‚è∏Ô∏è Pausado</span>';
                } else {
                    stateBadge = `<span class="badge bg-info">L${escalationLevel} Activo</span>`;
                }
                
                // =======================================
                // üë®‚Äçüîß INFORMACI√ìN DE T√âCNICOS ASIGNADOS
                // =======================================
                let technicianInfo = '';
                if (incident.l0_technician) {
                    const isCurrentTech = incident.l0_technician === technicianEmail;
                    technicianInfo = `
                        <div class="technician-info ${isCurrentTech ? 'current-tech' : ''}">
                            üë®‚Äçüîß L0: <strong>${incident.l0_technician.split('@')[0]}</strong>
                            ${isCurrentTech ? ' (T√ö)' : ''}
                            ${incident.l0_response ? ` - ${incident.l0_response}` : ''}
                            ${incident.l0_acceptance_date ? ` - ${new Date(incident.l0_acceptance_date).toLocaleString('es-ES')}` : ''}
                        </div>
                    `;
                }
                
                if (escalationLevel >= 1 && incident.l1_technician) {
                    const isCurrentTech = incident.l1_technician === technicianEmail;
                    technicianInfo += `
                        <div class="technician-info ${isCurrentTech ? 'current-tech' : ''}">
                            üë®‚Äçüîß L1: <strong>${incident.l1_technician.split('@')[0]}</strong>
                            ${isCurrentTech ? ' (T√ö)' : ''}
                            ${incident.l1_response ? ` - ${incident.l1_response}` : ''}
                            ${incident.l1_acceptance_date ? ` - ${new Date(incident.l1_acceptance_date).toLocaleString('es-ES')}` : ''}
                        </div>
                    `;
                }
                
                if (escalationLevel >= 2 && incident.l2_technicians) {
                    const l2Techs = incident.l2_technicians.split(',');
                    const isCurrentInL2 = l2Techs.some(tech => tech.trim() === technicianEmail);
                    technicianInfo += `
                        <div class="technician-info ${isCurrentInL2 ? 'current-tech' : ''}">
                            üë• L2: <strong>${l2Techs.map(t => t.split('@')[0]).join(', ')}</strong>
                            ${isCurrentInL2 ? ' (INCLUYE A TI)' : ''}
                            ${incident.l2_response ? ` - ${incident.l2_response}` : ''}
                        </div>
                    `;
                }
                
                // =======================================
                // üìû INFORMACI√ìN DE CONTACTOS (COLAPSABLE)
                // =======================================
                let contactsInfo = '';
                if (incident.supervisor_phone || incident.reporter_phone || incident.zone_manager_phone) {
                    contactsInfo = `
                        <div class="contacts-info">
                            <div class="contacts-header" onclick="toggleContacts('${incident.id}')">
                                üìû Contactos <span class="toggle-icon">‚ñº</span>
                            </div>
                            <div class="contacts-list" id="contacts-${incident.id}" style="display: none;">
                                ${incident.reporter && incident.reporter_phone ? 
                                    `<div>üìã Reportador: <strong>${incident.reporter}</strong> - <a href="tel:${incident.reporter_phone}">${incident.reporter_phone}</a></div>` : ''}
                                ${incident.supervisor && incident.supervisor_phone ? 
                                    `<div>üë®‚Äçüíº Supervisor: <strong>${incident.supervisor}</strong> - <a href="tel:${incident.supervisor_phone}">${incident.supervisor_phone}</a></div>` : ''}
                                ${incident.zone_manager && incident.zone_manager_phone ? 
                                    `<div>üè¢ Encargado Zona: <strong>${incident.zone_manager}</strong> - <a href="tel:${incident.zone_manager_phone}">${incident.zone_manager_phone}</a></div>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                // =======================================
                // ‚è±Ô∏è TIEMPO TRANSCURRIDO
                // =======================================
                let timeInfo = '';
                if (incident.time_elapsed !== undefined && incident.time_elapsed !== null) {
                    const elapsed = parseInt(incident.time_elapsed) || 0;
                    const hours = Math.floor(elapsed / 60);
                    const minutes = elapsed % 60;
                    timeInfo = `<div class="time-elapsed">üïí Tiempo transcurrido: ${hours}h ${minutes}m</div>`;
                }
                
                // =======================================
                // üìä HISTORIAL COMPLETO DE ESCALADO
                // =======================================
                let escalationHistory = '';
                
                // Construir historial de todos los niveles
                const historyLevels = [];
                
                // L0
                let l0Status = 'pending';
                if (incident.l0_response === 'acepto') l0Status = 'completed';
                else if (incident.l0_response === 'rechazo' || incident.l0_response === 'ayuda') l0Status = 'escalated';
                else if (escalationLevel > 0) l0Status = 'expired';
                
                historyLevels.push({
                    level: 'L0',
                    technician: incident.l0_technician,
                    status: l0Status,
                    response: incident.l0_response,
                    sla_end: incident.sla_l0_end,
                    acceptance_date: incident.l0_acceptance_date,
                    rejection_date: incident.l0_rejection_date,
                    reason: incident.l0_rejection_reason
                });
                
                // L1
                if (escalationLevel >= 1) {
                    let l1Status = escalationLevel === 1 ? 'current' : 'completed';
                    if (incident.l1_response === 'acepto') l1Status = 'completed';
                    else if (incident.l1_response === 'rechazo' || incident.l1_response === 'ayuda') l1Status = 'escalated';
                    else if (escalationLevel > 1) l1Status = 'expired';
                    
                    historyLevels.push({
                        level: 'L1',
                        technician: incident.l1_technician,
                        status: l1Status,
                        response: incident.l1_response,
                        sla_end: incident.sla_l1_backup_end,
                        acceptance_date: incident.l1_acceptance_date,
                        rejection_date: incident.l1_rejection_date,
                        reason: incident.l1_rejection_reason
                    });
                }
                
                // L2
                if (escalationLevel >= 2) {
                    let l2Status = escalationLevel === 2 ? 'current' : 'completed';
                    if (incident.l2_response) l2Status = 'completed';
                    else if (escalationLevel > 2) l2Status = 'expired';
                    
                    historyLevels.push({
                        level: 'L2',
                        technician: incident.l2_technicians,
                        status: l2Status,
                        response: incident.l2_response,
                        sla_end: incident.sla_l2_equipo_end,
                        acceptance_date: incident.l2_acceptance_date
                    });
                }
                
                // L3
                if (escalationLevel >= 3) {
                    historyLevels.push({
                        level: 'L3',
                        technician: incident.l3_supervisor,
                        status: 'current',
                        response: incident.l3_response,
                        sla_end: incident.sla_l3_responsable_end
                    });
                }
                
                // Generar HTML del historial
                const historyHTML = historyLevels.map(level => {
                    const isCurrentTech = level.technician === technicianEmail || 
                                         (level.technician && level.technician.includes && level.technician.includes(technicianEmail));
                    
                    let statusClass = level.status;
                    let statusText = '';
                    switch(level.status) {
                        case 'completed': statusText = '‚úÖ Completado'; break;
                        case 'current': statusText = 'üîÑ Activo'; break;
                        case 'expired': statusText = '‚è∞ Vencido'; break;
                        case 'escalated': statusText = 'üì§ Escalado'; break;
                        case 'pending': statusText = '‚è≥ Pendiente'; break;
                    }
                    
                    return `
                        <div class="escalation-level ${statusClass}">
                            <div class="level-header">
                                ${level.level} - ${statusText} ${isCurrentTech ? '(T√ö)' : ''}
                            </div>
                            <div class="level-details">
                                <strong>T√©cnico:</strong> ${level.technician ? level.technician.split('@')[0] : 'No asignado'}<br>
                                ${level.response ? `<strong>Respuesta:</strong> ${level.response}<br>` : ''}
                                ${level.reason ? `<strong>Motivo:</strong> ${level.reason}<br>` : ''}
                                ${level.sla_end ? `<strong>SLA:</strong> ${new Date(level.sla_end).toLocaleString('es-ES')}<br>` : ''}
                                ${level.acceptance_date ? `<strong>Fecha aceptaci√≥n:</strong> ${new Date(level.acceptance_date).toLocaleString('es-ES')}<br>` : ''}
                                ${level.rejection_date ? `<strong>Fecha rechazo:</strong> ${new Date(level.rejection_date).toLocaleString('es-ES')}` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                escalationHistory = `
                    <div class="escalation-history">
                        <div class="escalation-header" onclick="toggleEscalationHistory('${incident.id}')">
                            üìä Historial de Escalado <span class="toggle-icon">‚ñº</span>
                        </div>
                        <div class="escalation-content" id="escalation-${incident.id}">
                            ${historyHTML}
                        </div>
                    </div>
                `;
                
                // =======================================
                // üé® COLOR DE PRIORIDAD
                // =======================================
                let priorityColor = '#6c757d';
                const priority = incident.priority.replace(/üî¥|üü†|üü°|üü¢/g, '').trim();
                switch (priority) {
                    case 'CR√çTICA': priorityColor = '#dc3545'; break;
                    case 'ALTA': priorityColor = '#fd7e14'; break;
                    case 'MEDIA': priorityColor = '#ffc107'; break;
                    case 'BAJA': priorityColor = '#28a745'; break;
                }
                
                // =======================================
                // üéØ BOTONES DE ACCI√ìN - PREPARADO PARA MAKE
                // =======================================
                let actionButtons = '';
                
                if (canRespond) {
                    // ESTADO PENDIENTE - Botones iniciales
                    actionButtons = `
                        <div class="incident-actions">
                            <button class="btn btn-success" onclick="handleAction('acepto', '${incident.id}')">
                                ‚úÖ Acepto
                            </button>
                            <button class="btn btn-danger" onclick="handleAction('rechazo', '${incident.id}')">
                                ‚ùå Rechazo
                            </button>
                            <button class="btn btn-warning" onclick="handleAction('ayuda', '${incident.id}')">
                                üÜò Ayuda
                            </button>
                        </div>
                    `;
                } else if (realState === 'working') {
                    // ESTADO TRABAJANDO - Botones de progreso (preparado para Make)
                    actionButtons = `
                        <div class="incident-actions">
                            <button class="btn btn-success" onclick="handleAction('completar', '${incident.id}')">
                                ‚úÖ Completar
                            </button>
                            <button class="btn btn-warning" onclick="handleAction('solicitar_apoyo', '${incident.id}')">
                                üÜò Solicitar Apoyo
                            </button>
                            <button class="btn btn-info" onclick="handleAction('transferir', '${incident.id}')">
                                üîÑ Transferir
                            </button>
                        </div>
                    `;
                } else {
                    // OTROS ESTADOS - Sin acci√≥n posible
                    let reason = '';
                    if (realState === 'expired') {
                        reason = '‚è∞ SLA vencido - Contactar por tel√©fono';
                    } else if (realState === 'not_mine') {
                        reason = `üë§ No es tu responsabilidad (L${escalationLevel})`;
                    } else if (realState === 'paused') {
                        reason = '‚è∏Ô∏è Escalado pausado por supervisor';
                    } else if (realState === 'escalated') {
                        reason = 'üì§ Ya escalado - Esperando siguiente nivel';
                    }
                    
                    actionButtons = `
                        <div class="no-action-info">
                            <span class="badge bg-light">${reason}</span>
                        </div>
                    `;
                }
                
                // =======================================
                // üìù RENDERIZADO FINAL DE LA CARD
                // =======================================
                return `
                    <div class="incident-card">
                        <div class="incident-header">
                            <div class="incident-title">
                                <h4>${incident.equipment || incident.component || 'Equipo no especificado'}</h4>
                                <div class="badges">
                                    <span class="priority-badge" style="background-color: ${priorityColor}; color: white;">${priority}</span>
                                    ${stateBadge}
                                </div>
                            </div>
                            <div class="incident-id">${incident.id}</div>
                        </div>
                        
                        <div class="incident-body">
                            <div class="zone">üìç <strong>${incident.zone}</strong></div>
                            <div class="description">${incident.description}</div>
                            
                            ${technicianInfo}
                            ${slaInfo}
                            ${timeInfo}
                            
                            ${incident.actions_taken && incident.actions_taken !== 'Sin acciones' && incident.actions_taken !== '' ? 
                                `<div class="actions-taken">üîß <strong>Acciones tomadas:</strong> ${incident.actions_taken}</div>` : ''
                            }
                            
                            ${contactsInfo}
                            ${escalationHistory}
                        </div>
                        
                        <div class="incident-footer">
                            ${actionButtons}
                        </div>
                    </div>
                `;
            }).join('');
            
            // =======================================
            // üé® APLICAR LAYOUT DE 2 COLUMNAS
            // =======================================
            container.innerHTML = `
                <div class="incidents-grid">
                    ${incidentsHTML}
                </div>
            `;
            
            // =======================================
            // ‚è±Ô∏è INICIAR TIMERS SLA EN TIEMPO REAL
            // =======================================
            startSLATimers();
        }

        // ==========================================
        // üéØ FUNCIONES DE TOGGLE PARA SECCIONES COLAPSABLES
        // ==========================================

        function toggleContacts(incidentId) {
            const contactsList = document.getElementById(`contacts-${incidentId}`);
            if (!contactsList) return;
            
            const toggleIcon = contactsList.parentElement.querySelector('.toggle-icon');
            const isVisible = contactsList.style.display !== 'none';
            
            contactsList.style.display = isVisible ? 'none' : 'block';
            if (toggleIcon) {
                toggleIcon.textContent = isVisible ? '‚ñº' : '‚ñ≤';
            }
        }

        function toggleEscalationHistory(incidentId) {
            const historyContent = document.getElementById(`escalation-${incidentId}`);
            if (!historyContent) return;
            
            const toggleIcon = historyContent.parentElement.querySelector('.toggle-icon');
            const isVisible = historyContent.style.display !== 'none';
            
            historyContent.style.display = isVisible ? 'none' : 'block';
            if (toggleIcon) {
                toggleIcon.textContent = isVisible ? '‚ñº' : '‚ñ≤';
            }
        }

        // ==========================================
        // ‚è±Ô∏è SISTEMA DE TIMERS SLA EN TIEMPO REAL
        // ==========================================

        function startSLATimers() {
            // Limpiar interval anterior si existe
            if (slaTimerInterval) {
                clearInterval(slaTimerInterval);
            }
            
            slaTimerInterval = setInterval(() => {
                const timers = document.querySelectorAll('.sla-timer[data-end]');
                
                timers.forEach(timer => {
                    const endTime = new Date(timer.dataset.end);
                    const now = new Date();
                    const diffMinutes = Math.floor((endTime - now) / 1000 / 60);
                    
                    if (diffMinutes < 0) {
                        // SLA vencido
                        const expiredMinutes = Math.abs(diffMinutes);
                        timer.className = 'sla-expired';
                        timer.innerHTML = `‚è∞ VENCIDO hace ${expiredMinutes} min`;
                    } else {
                        // SLA activo
                        const hours = Math.floor(diffMinutes / 60);
                        const minutes = diffMinutes % 60;
                        
                        // Actualizar clase seg√∫n tiempo restante
                        timer.className = 'sla-timer sla-info ';
                        if (diffMinutes <= 30) {
                            timer.className += 'sla-critical';
                        } else if (diffMinutes <= 60) {
                            timer.className += 'sla-warning';
                        } else {
                            timer.className += 'sla-good';
                        }
                        
                        timer.innerHTML = `‚è±Ô∏è ${hours}h ${minutes.toString().padStart(2, '0')}m restantes`;
                    }
                });
            }, 60000); // Actualizar cada minuto
        }

        // ==========================================
        // üéõÔ∏è FUNCIONES DE FILTRADO
        // ==========================================
        
        function filterIncidents() {
            return allIncidents.filter(incident => {
                // Filtro por estado
                if (currentStatusFilter !== 'all') {
                    const realState = getIncidentRealState(incident, currentTechnician.email);
                    if (realState !== currentStatusFilter) {
                        return false;
                    }
                }
                
                // Filtro por prioridad
                if (currentPriorityFilter !== 'all') {
                    const priority = incident.priority.replace(/üî¥|üü†|üü°|üü¢/g, '').trim();
                    if (priority !== currentPriorityFilter) {
                        return false;
                    }
                }
                
                return true;
            });
        }

        function filterByStatus(status, element) {
            currentStatusFilter = status;
            
            // Actualizar UI de filtros
            document.querySelectorAll('.stat-card').forEach(card => {
                card.classList.remove('active');
            });
            element.classList.add('active');
            
            renderIncidents();
        }

        function filterByPriority(priority, element) {
            currentPriorityFilter = priority;
            
            // Actualizar UI de filtros
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            element.classList.add('active');
            
            renderIncidents();
        }

        // ==========================================
        // üéØ L√ìGICA DE ESTADOS Y PERMISOS
        // ==========================================
        
        function getIncidentRealState(incident, technicianEmail) {
            const escalationLevel = parseInt(incident.escalation_level) || 0;
            
            // Si est√° pausado
            if (incident.escalation_paused === 'true') {
                return 'paused';
            }
            
            // Verificar si el t√©cnico ya respondi√≥
            if (escalationLevel === 0 && incident.l0_technician === technicianEmail) {
                if (incident.l0_response === 'acepto') return 'working';
                if (incident.l0_response === 'rechazo' || incident.l0_response === 'ayuda') return 'escalated';
            }
            
            if (escalationLevel === 1 && incident.l1_technician === technicianEmail) {
                if (incident.l1_response === 'acepto') return 'working';
                if (incident.l1_response === 'rechazo' || incident.l1_response === 'ayuda') return 'escalated';
            }
            
            if (escalationLevel === 2 && incident.l2_technicians && incident.l2_technicians.includes(technicianEmail)) {
                if (incident.l2_response === 'acepto') return 'working';
                if (incident.l2_response === 'rechazo' || incident.l2_response === 'ayuda') return 'escalated';
            }
            
            // Verificar SLA
            let slaEnd = null;
            if (escalationLevel === 0 && incident.l0_technician === technicianEmail) {
                slaEnd = incident.sla_l0_end;
            } else if (escalationLevel === 1 && incident.l1_technician === technicianEmail) {
                slaEnd = incident.sla_l1_backup_end;
            } else if (escalationLevel === 2 && incident.l2_technicians?.includes(technicianEmail)) {
                slaEnd = incident.sla_l2_equipo_end;
            } else if (escalationLevel === 3 && incident.l3_supervisor === technicianEmail) {
                slaEnd = incident.sla_l3_responsable_end;
            }
            
            if (slaEnd) {
                const now = new Date();
                const endTime = new Date(slaEnd);
                
                if (now > endTime) {
                    return 'expired';
                } else {
                    return 'pending';
                }
            }
            
            return 'not_mine';
        }

        function canTechnicianRespond(incident, technicianEmail) {
            const state = getIncidentRealState(incident, technicianEmail);
            return state === 'pending';
        }

        // ==========================================
        // üìä ACTUALIZAR ESTAD√çSTICAS
        // ==========================================
        
        function updateStats() {
            const technicianEmail = currentTechnician?.email || '';
            
            let pendingCount = 0;
            let workingCount = 0;
            let expiredCount = 0;
            
            allIncidents.forEach(incident => {
                const state = getIncidentRealState(incident, technicianEmail);
                switch (state) {
                    case 'pending':
                        pendingCount++;
                        break;
                    case 'working':
                        workingCount++;
                        break;
                    case 'expired':
                        expiredCount++;
                        break;
                }
            });
            
            document.getElementById('totalCount').textContent = allIncidents.length;
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('workingCount').textContent = workingCount;
            document.getElementById('expiredCount').textContent = expiredCount;
        }

        // ==========================================
        // üéØ MANEJO DE ACCIONES CORREGIDO - PREPARADO PARA MAKE
        // ==========================================
        
        async function handleAction(action, incidentId) {
            // ‚úÖ CORRECCI√ìN: Validaci√≥n de par√°metros
            if (!action || !incidentId) {
                alert('Error: Datos de acci√≥n inv√°lidos');
                return;
            }
            
            if (!currentTechnician?.email) {
                alert('Error: Sesi√≥n no v√°lida');
                return;
            }

            const motivo = prompt(`¬øCu√°l es el motivo del ${action}?`);
            
            if (!motivo || motivo.trim() === '') {
                alert('El motivo es obligatorio');
                return;
            }

            // Validar longitud del motivo
            if (motivo.trim().length < 10) {
                alert('El motivo debe tener al menos 10 caracteres');
                return;
            }

            try {
                const response = await fetch(API_RESPONSE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        incident_id: incidentId,
                        technician_email: currentTechnician.email,
                        technician_name: currentTechnician.name,
                        action: action,
                        reason: motivo.trim(),
                        timestamp: new Date().toISOString()
                    })
                });

                // ‚úÖ CORRECCI√ìN: Manejo robusto de respuestas
                let data = null;
                try {
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                        data = await response.json();
                    } else {
                        throw new Error('Respuesta no es JSON v√°lido');
                    }
                } catch (parseError) {
                    console.error('Error parsing respuesta de acci√≥n:', parseError);
                    throw new Error('Error procesando respuesta del servidor');
                }
                
                if (response.ok && data && data.success) {
                    const successMessages = {
                        'acepto': '‚úÖ Incidencia aceptada correctamente. ¬°Puedes empezar a trabajar!',
                        'rechazo': '‚ùå Incidencia rechazada. Se escalar√° autom√°ticamente.',
                        'ayuda': 'üÜò Ayuda solicitada. Un supervisor se pondr√° en contacto.',
                        'completar': '‚úÖ Incidencia completada exitosamente.',
                        'transferir': 'üîÑ Incidencia transferida correctamente.',
                        'solicitar_apoyo': 'üÜò Apoyo solicitado. Un supervisor gestionar√° tu petici√≥n.'
                    };
                    
                    alert(successMessages[action] || `${action.toUpperCase()} registrado correctamente`);
                    await loadDashboard(); // Recargar datos
                } else {
                    const errorMsg = (data && data.message) || `Error ${response.status}: No se pudo registrar la respuesta`;
                    alert(errorMsg);
                }
                
            } catch (error) {
                console.error('Error enviando respuesta:', error);
                alert('Error de conexi√≥n: ' + error.message);
            }
        }

        // ==========================================
        // üöÄ INICIALIZACI√ìN AL CARGAR LA P√ÅGINA
        // ==========================================
        
        window.addEventListener('DOMContentLoaded', function() {
            console.log('üîß ABC.xyz Dashboard T√©cnico iniciado');
            
            // Verificar par√°metros URL para login autom√°tico
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('tecnico') || urlParams.get('technician_email');
            
            if (email) {
                document.getElementById('emailInput').value = email;
                document.getElementById('emailInput').focus();
            } else {
                document.getElementById('emailInput').focus();
            }
            
            // Enter key en el campo email
            document.getElementById('emailInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loginWithPIN();
                }
            });
        });

        // Limpiar intervals al cerrar la p√°gina
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) clearInterval(refreshInterval);
            if (slaTimerInterval) clearInterval(slaTimerInterval);
        });
    </script>
</body>
</html>
