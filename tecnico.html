<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Dashboard T√©cnico - Sistema de Incidencias</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #2c3e50;
        }

        /* === LOADING === */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* === LOGIN OVERLAY === */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-container h2 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .verify-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }

        .verify-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .error-message {
            background: #e74c3c;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 14px;
        }

        /* === MAIN DASHBOARD === */
        .main-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            display: none;
        }

        .dashboard-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .dashboard-header h1 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .dashboard-header .subtitle {
            color: #7f8c8d;
            font-size: 16px;
        }

        /* === SLA TIMER === */
        .sla-timer {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: center;
            border: 3px solid #17a2b8;
        }

        .sla-timer.warning {
            border-color: #ffc107;
            background: rgba(255, 243, 205, 0.95);
        }

        .sla-timer.critical {
            border-color: #dc3545;
            background: rgba(248, 215, 218, 0.95);
        }

        .sla-timer.expired {
            border-color: #6c757d;
            background: rgba(226, 227, 229, 0.95);
        }

        .timer-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .timer-label {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .timer-display {
            font-size: 36px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .timer-subtitle {
            font-size: 14px;
            color: #6c757d;
        }

        .timer-warning {
            color: #856404;
            font-weight: 600;
        }

        /* === INCIDENT DETAILS === */
        .incident-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .incident-header {
            padding: 25px;
            border-bottom: 2px solid #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .incident-header h2 {
            color: #2c3e50;
            font-size: 24px;
            font-family: 'Courier New', monospace;
        }

        .priority-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .priority-cr√≠tica {
            background: #dc3545;
            color: white;
        }

        .priority-alta {
            background: #fd7e14;
            color: white;
        }

        .priority-media {
            background: #ffc107;
            color: #212529;
        }

        .priority-baja {
            background: #28a745;
            color: white;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 25px;
        }

        .detail-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .detail-item strong {
            display: block;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .detail-item span {
            color: #495057;
            font-size: 16px;
        }

        .level-badge {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .level-inicial {
            background: #17a2b8;
        }

        .level-backup {
            background: #ffc107;
            color: #212529;
        }

        .level-equipo {
            background: #fd7e14;
        }

        /* === DESCRIPTION === */
        .description-section {
            padding: 25px;
            border-top: 2px solid #f8f9fa;
        }

        .description-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .description-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
            line-height: 1.6;
            color: #495057;
        }

        /* === CONTACTS === */
        .contact-section {
            padding: 25px;
            border-top: 2px solid #f8f9fa;
        }

        .contact-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .contact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .contact-card {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #17a2b8;
        }

        .contact-card strong {
            display: block;
            color: #0c5460;
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .contact-card div {
            color: #495057;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .phone-link {
            color: #17a2b8;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
        }

        .phone-link:hover {
            color: #0c5460;
            text-decoration: underline;
        }

        /* === RESPONSE SECTION === */
        .response-section {
            padding: 25px;
            border-top: 2px solid #f8f9fa;
            text-align: center;
        }

        .response-question h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .auth-notice {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #ffeaa7;
        }

        .response-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 25px 0;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-accept {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-reject {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .btn-help {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn.locked {
            opacity: 0.6;
            cursor: not-allowed;
            position: relative;
        }

        .btn.locked:hover {
            transform: none;
            box-shadow: none;
        }

        .alternative-actions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }

        /* === RESPONSE SUCCESS === */
        .response-success {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
        }

        .success-icon {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .success-message {
            font-size: 18px;
            color: #0c5460;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .success-reason {
            background: rgba(23, 162, 184, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
            font-size: 14px;
            color: #0c5460;
        }

        .success-timestamp {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 20px;
        }

        .success-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* === PIN MODAL === */
        .pin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }

        .pin-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .pin-modal-content {
            position: relative;
            background: white;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .pin-modal-header {
            padding: 25px 25px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pin-modal-header h3 {
            color: #2c3e50;
            margin: 0;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #e74c3c;
        }

        .pin-modal-body {
            padding: 25px;
        }

        .pin-input-group {
            margin-bottom: 20px;
        }

        .pin-input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .pin-input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .pin-input-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .pin-input-group input[readonly] {
            background: #f8f9fa;
            color: #6c757d;
        }

        .pin-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            margin-top: 10px;
        }

        .pin-modal-footer {
            padding: 0 25px 25px;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
            }

            .incident-header {
                flex-direction: column;
                text-align: center;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .contact-grid {
                grid-template-columns: 1fr;
            }

            .response-buttons {
                gap: 10px;
            }

            .success-actions {
                flex-direction: column;
            }

            .timer-display {
                font-size: 28px;
            }

            .pin-modal-footer {
                flex-direction: column;
            }
        }

        /* === REASON MODAL === */
        .reason-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1600;
        }

        .reason-modal-content {
            position: relative;
            background: white;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .reason-modal-header {
            padding: 25px;
            border-bottom: 2px solid #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reason-modal-header h3 {
            color: #2c3e50;
            margin: 0;
            font-size: 20px;
        }

        .reason-options {
            padding: 25px;
        }

        .reason-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .reason-option:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }

        .reason-option.selected {
            border-color: #3498db;
            background: #e7f3ff;
        }

        .reason-option .icon {
            font-size: 24px;
            margin-right: 15px;
            width: 40px;
            text-align: center;
        }

        .reason-option .text {
            flex: 1;
        }

        .reason-option .title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .reason-option .description {
            font-size: 14px;
            color: #6c757d;
            line-height: 1.4;
        }

        .reason-actions {
            padding: 25px;
            border-top: 2px solid #f8f9fa;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* === INCIDENT DASHBOARD GRID === */
        .incidents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .incident-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .incident-item:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .incident-item.pending {
            border-left: 5px solid #e74c3c;
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
        }

        .incident-item.working {
            border-left: 5px solid #28a745;
            background: linear-gradient(135deg, #f0fff4 0%, #ffffff 100%);
        }

        .incident-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .incident-item-header strong {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #2c3e50;
        }

        .incident-item-content {
            margin-bottom: 12px;
        }

        .incident-item-content > div:first-child {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .incident-meta {
            font-size: 12px;
            color: #6c757d;
            line-height: 1.4;
        }

        .incident-action {
            padding-top: 10px;
            border-top: 1px solid #f8f9fa;
        }

        .action-required {
            color: #e74c3c;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .working-status {
            color: #28a745;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .incident-section {
            margin-bottom: 25px;
        }

        .incident-section h3 {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div id="loadingMessage">Cargando...</div>
        </div>
    </div>

    <!-- Login Overlay (Modo B - Dashboard completo) -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-container">
            <h2>üîß Acceso T√©cnico</h2>
            <div class="form-group">
                <label for="technicianEmail">Email:</label>
                <input type="email" id="technicianEmail" placeholder="tu.email@empresa.com">
            </div>
            <div class="form-group">
                <label for="technicianPin">PIN:</label>
                <input type="password" id="technicianPin" maxlength="4" placeholder="4 d√≠gitos">
            </div>
            <button onclick="verifyTechnicianLogin()" class="verify-btn">
                üîê Acceder al Dashboard
            </button>
            <div id="loginError" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <!-- Main Dashboard Container -->
    <div class="main-container" id="mainContainer">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <h1 id="dashboardTitle">üîß Dashboard T√©cnico</h1>
            <div class="subtitle" id="dashboardSubtitle">Sistema de Respuesta a Incidencias</div>
        </div>

        <!-- SLA Timer -->
        <div class="sla-timer" id="slaTimer" style="display: none;">
            <!-- Se llena din√°micamente -->
        </div>

        <!-- Incident Details -->
        <div class="incident-card" id="incidentCard" style="display: none;">
            <!-- Se llena din√°micamente -->
        </div>
    </div>

    <script>
        // === VARIABLES GLOBALES ===
        let currentIncident = null;
        let currentTechnician = null;
        let isAuthenticated = false;
        let intendedAction = null;
        let selectedReason = null;

        // === MOTIVOS DE RESPUESTA ===
        const rejectReasons = [
            { id: 'ocupado_otra', icon: 'üîß', title: 'Ocupado con otra incidencia', description: 'Ya estoy resolviendo otra incidencia cr√≠tica' },
            { id: 'fuera_especialidad', icon: '‚ùì', title: 'Fuera de mi especialidad', description: 'No tengo experiencia con este tipo de equipo' },
            { id: 'no_disponible', icon: '‚è∞', title: 'No disponible ahora', description: 'Estoy en pausa, reuni√≥n o fuera de turno' },
            { id: 'falta_herramientas', icon: 'üî®', title: 'Faltan herramientas/repuestos', description: 'No tengo las herramientas necesarias disponibles' },
            { id: 'ubicacion_lejos', icon: 'üìç', title: 'Muy lejos de mi ubicaci√≥n', description: 'Estoy muy lejos de la zona de la incidencia' },
            { id: 'sobrecarga_trabajo', icon: '‚ö°', title: 'Sobrecarga de trabajo', description: 'Ya tengo demasiadas incidencias asignadas' }
        ];

        const helpReasons = [
            { id: 'apoyo_tecnico', icon: 'üë•', title: 'Necesito apoyo t√©cnico', description: 'Requiero asistencia de otro t√©cnico especializado' },
            { id: 'consulta_supervisor', icon: 'üéØ', title: 'Consulta con supervisor', description: 'Necesito autorizaci√≥n o gu√≠a del supervisor' },
            { id: 'herramientas_especiales', icon: 'üîß', title: 'Herramientas especiales', description: 'Requiero herramientas que no tengo disponibles' },
            { id: 'procedimiento_dudas', icon: 'üìã', title: 'Dudas sobre procedimiento', description: 'No estoy seguro del procedimiento correcto' },
            { id: 'seguridad_riesgo', icon: '‚ö†Ô∏è', title: 'Problema de seguridad', description: 'Hay riesgos de seguridad que debo consultar' },
            { id: 'repuestos_urgentes', icon: 'üì¶', title: 'Repuestos urgentes', description: 'Necesito repuestos que no est√°n disponibles' }
        ];

        // === INICIALIZACI√ìN ===
        window.addEventListener('load', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const incidentId = urlParams.get('id');
            const technicianEmail = urlParams.get('tech');

            if (incidentId && technicianEmail) {
                // MODO A: Vista espec√≠fica de incidencia
                currentTechnician = technicianEmail;
                await loadIncidentReadOnly(incidentId);
            } else {
                // MODO B: Dashboard completo - Requiere login
                showTechnicianLogin();
            }
        });

        // === MODO A: CARGAR INCIDENCIA ESPEC√çFICA (SIN AUTH) ===
        async function loadIncidentReadOnly(incidentId) {
            try {
                showLoading('Cargando incidencia...');

                const response = await fetch('/api/webhook-respuesta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'get_incident_details',
                        incident_id: incidentId,
                        read_only: true
                    })
                });

                const data = await response.json();

                if (data.status === 'success' && data.incident) {
                    currentIncident = data.incident;
                    renderIncidentDetails(data.incident);
                    initSLATimer(data.incident);
                    showResponseActions();
                    document.getElementById('mainContainer').style.display = 'block';
                } else {
                    showError(data.message || 'Incidencia no encontrada');
                }

            } catch (error) {
                console.error('Error cargando incidencia:', error);
                showError('Error de conexi√≥n. Int√©ntalo m√°s tarde.');
            } finally {
                hideLoading();
            }
        }

        // === RENDERIZAR DETALLES DE INCIDENCIA ===
        function renderIncidentDetails(incident) {
            const incidentCard = document.getElementById('incidentCard');
            
            // Determinar nivel de escalado
            const escalationLevel = parseInt(incident.escalation_level) || 0;
            let levelText, levelClass;
            
            switch(escalationLevel) {
                case 0: levelText = 'inicial'; levelClass = 'level-inicial'; break;
                case 1: levelText = 'backup'; levelClass = 'level-backup'; break;
                case 2: levelText = 'equipo'; levelClass = 'level-equipo'; break;
                default: levelText = 'supervisor'; levelClass = 'level-supervisor'; break;
            }

            incidentCard.innerHTML = `
                <div class="incident-header">
                    <h2>${incident.id}</h2>
                    <div class="priority-badge priority-${incident.priority?.toLowerCase() || 'media'}">
                        ${incident.priority || 'MEDIA'}
                    </div>
                </div>

                <div class="detail-grid">
                    <div class="detail-item">
                        <strong>üè≠ Equipo Afectado:</strong>
                        <span>${incident.equipment || 'No especificado'}</span>
                    </div>
                    <div class="detail-item">
                        <strong>üìç Zona:</strong>
                        <span>${incident.zone || 'No especificada'}</span>
                    </div>
                    <div class="detail-item">
                        <strong>‚è∞ Reportado:</strong>
                        <span>${incident.created_date ? new Date(incident.created_date).toLocaleString() : 'No disponible'}</span>
                    </div>
                    <div class="detail-item">
                        <strong>üë§ Nivel Asignado:</strong>
                        <span class="level-badge ${levelClass}">${levelText.toUpperCase()}</span>
                    </div>
                </div>

                <div class="description-section">
                    <h3>üìã Descripci√≥n del Problema</h3>
                    <div class="description-box">
                        ${incident.description || 'Sin descripci√≥n disponible'}
                    </div>
                </div>

                <div class="contact-section">
                    <h3>üìû Contactos de Apoyo</h3>
                    <div class="contact-grid">
                        <div class="contact-card">
                            <strong>Encargado de Zona</strong>
                            <div>${incident.zone_manager || incident.encargado_zona || 'No asignado'}</div>
                            ${incident.zone_manager_phone || incident.telefono_encargado ? `<a href="tel:${incident.zone_manager_phone || incident.telefono_encargado}" class="phone-link">${incident.zone_manager_phone || incident.telefono_encargado}</a>` : ''}
                        </div>
                        <div class="contact-card">
                            <strong>Supervisor</strong>
                            <div>${incident.supervisor || 'No asignado'}</div>
                            ${incident.supervisor_phone || incident.telefono_supervisor ? `<a href="tel:${incident.supervisor_phone || incident.telefono_supervisor}" class="phone-link">${incident.supervisor_phone || incident.telefono_supervisor}</a>` : ''}
                        </div>
                    </div>
                </div>

                <div class="response-section" id="responseSection">
                    <!-- Se llena din√°micamente -->
                </div>
            `;

            incidentCard.style.display = 'block';
        }

        // === TIMER SLA ===
        function initSLATimer(incident) {
            const escalationLevel = parseInt(incident.escalation_level) || 0;
            let slaEndDate, slaLabel;

            // Determinar SLA seg√∫n nivel actual
            switch(escalationLevel) {
                case 0:
                    slaEndDate = incident.sla_l0_end ? new Date(incident.sla_l0_end) : null;
                    slaLabel = "SLA NIVEL INICIAL";
                    break;
                case 1:
                    slaEndDate = incident.sla_l1_backup_end ? new Date(incident.sla_l1_backup_end) : null;
                    slaLabel = "SLA BACKUP";
                    break;
                case 2:
                    slaEndDate = incident.sla_l2_equipo_end ? new Date(incident.sla_l2_equipo_end) : null;
                    slaLabel = "SLA EQUIPO";
                    break;
                case 3:
                    showEscalatedState();
                    return;
            }

            if (slaEndDate) {
                startSLACountdown(slaEndDate, slaLabel);
            } else {
                // Si no hay fecha SLA, mostrar estado sin timer
                document.getElementById('slaTimer').innerHTML = `
                    <div class="timer-icon">‚è±Ô∏è</div>
                    <div class="timer-label">${slaLabel}</div>
                    <div class="timer-display">SIN L√çMITE</div>
                    <div class="timer-subtitle">No hay l√≠mite de tiempo configurado</div>
                `;
                document.getElementById('slaTimer').style.display = 'block';
            }
        }

        function startSLACountdown(endDate, label) {
            const timerElement = document.getElementById('slaTimer');
            timerElement.style.display = 'block';

            const updateTimer = () => {
                const now = new Date();
                const timeLeft = endDate - now;

                if (timeLeft <= 0) {
                    // SLA vencido
                    timerElement.innerHTML = `
                        <div class="timer-icon">‚è∞</div>
                        <div class="timer-label">${label}</div>
                        <div class="timer-display">VENCIDO</div>
                        <div class="timer-warning">‚ö†Ô∏è Se escalar√° autom√°ticamente</div>
                    `;
                    timerElement.className = 'sla-timer expired';
                    return;
                }

                // Calcular tiempo restante
                const totalMinutes = Math.floor(timeLeft / (1000 * 60));
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                // Formato display
                let display;
                if (hours > 0) {
                    display = `${hours}h ${minutes}m`;
                } else if (minutes > 0) {
                    display = `${minutes}m ${seconds}s`;
                } else {
                    display = `${seconds}s`;
                }

                // Determinar estado del timer
                let timerClass, urgencyMessage;
                if (timeLeft > 30 * 60 * 1000) { // > 30 min
                    timerClass = 'sla-timer';
                    urgencyMessage = 'Tiempo suficiente para responder';
                } else if (timeLeft > 10 * 60 * 1000) { // > 10 min
                    timerClass = 'sla-timer warning';
                    urgencyMessage = 'Tiempo limitado - Responder pronto';
                } else {
                    timerClass = 'sla-timer critical';
                    urgencyMessage = '‚ö†Ô∏è URGENTE - Responder ahora';
                }

                timerElement.innerHTML = `
                    <div class="timer-icon">‚è±Ô∏è</div>
                    <div class="timer-label">${label}</div>
                    <div class="timer-display">${display}</div>
                    <div class="timer-subtitle">${urgencyMessage}</div>
                `;
                timerElement.className = timerClass;
            };

            updateTimer();
            setInterval(updateTimer, 1000);
        }

        function showEscalatedState() {
            const timerElement = document.getElementById('slaTimer');
            timerElement.innerHTML = `
                <div class="timer-icon">üö®</div>
                <div class="timer-label">ESCALADO AL SUPERVISOR</div>
                <div class="timer-display">NIVEL 3</div>
                <div class="timer-subtitle">La incidencia ha sido escalada al supervisor</div>
            `;
            timerElement.className = 'sla-timer expired';
            timerElement.style.display = 'block';
        }

        // === MOSTRAR ACCIONES DE RESPUESTA ===
        function showResponseActions() {
            const responseSection = document.getElementById('responseSection');

            responseSection.innerHTML = `
                <div class="response-question">
                    <h3>¬øPuedes hacerte cargo de esta incidencia?</h3>
                    <div class="auth-notice" id="authNotice">
                        Para responder, necesitas introducir tu PIN de t√©cnico
                    </div>
                </div>

                <div class="response-buttons">
                    <button class="btn btn-accept locked" onclick="requestAuthentication('acepto')">
                        üîí ‚úÖ ACEPTO LA INCIDENCIA
                    </button>

                    <button class="btn btn-reject locked" onclick="requestAuthentication('rechazo')">
                        üîí ‚ùå NO PUEDO HACERME CARGO
                    </button>

                    <button class="btn btn-help locked" onclick="requestAuthentication('ayuda')">
                        üîí üÜò NECESITO AYUDA
                    </button>
                </div>

                <div class="alternative-actions">
                    <button class="btn btn-secondary" onclick="showTechnicianDashboard()">
                        üìã Ver Mis Otras Incidencias
                    </button>
                </div>
            `;
        }

        // === SOLICITAR AUTENTICACI√ìN ===
        function requestAuthentication(action) {
            if (isAuthenticated) {
                // Ya autenticado, proceder con la acci√≥n
                if (action === 'acepto') {
                    handleResponse('acepto');
                } else {
                    showReasonModal(action);
                }
                return;
            }

            // Mostrar modal de PIN
            intendedAction = action;
            showPINModal();
        }

        function showPINModal() {
            const modal = document.createElement('div');
            modal.className = 'pin-modal';
            modal.id = 'pinModal';

            modal.innerHTML = `
                <div class="pin-modal-overlay" onclick="closePINModal()"></div>
                <div class="pin-modal-content">
                    <div class="pin-modal-header">
                        <h3>üîê Autenticaci√≥n de T√©cnico</h3>
                        <button onclick="closePINModal()" class="close-btn">‚úï</button>
                    </div>

                    <div class="pin-modal-body">
                        <p>Para responder a incidencias, introduce tu PIN de t√©cnico:</p>

                        <div class="pin-input-group">
                            <label>Email:</label>
                            <input type="email" id="technicianEmailInput" value="${currentTechnician}" readonly>
                        </div>

                        <div class="pin-input-group">
                            <label>PIN:</label>
                            <input type="password" id="technicianPINInput" maxlength="4" placeholder="4 d√≠gitos">
                        </div>

                        <div class="pin-error" id="pinError" style="display: none;"></div>
                    </div>

                    <div class="pin-modal-footer">
                        <button onclick="closePINModal()" class="btn btn-secondary">Cancelar</button>
                        <button onclick="verifyTechnicianPIN()" class="btn btn-primary">Verificar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.getElementById('technicianPINInput').focus();

            // Permitir Enter para verificar
            document.getElementById('technicianPINInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') verifyTechnicianPIN();
            });
        }

        // === VERIFICAR PIN ===
        async function verifyTechnicianPIN() {
            const email = document.getElementById('technicianEmailInput').value;
            const pin = document.getElementById('technicianPINInput').value;

            if (!pin || pin.length !== 4) {
                showPINError('Introduce un PIN de 4 d√≠gitos');
                return;
            }

            try {
                const response = await fetch('/api/webhook-respuesta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'validate_pin',
                        technician_email: email,
                        pin: pin
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // PIN v√°lido
                    isAuthenticated = true;
                    closePINModal();
                    unlockResponseActions();

                    // Proceder con la acci√≥n original
                    if (intendedAction === 'acepto') {
                        handleResponse('acepto');
                    } else {
                        showReasonModal(intendedAction);
                    }

                } else {
                    showPINError(data.message || 'PIN incorrecto');
                }

            } catch (error) {
                console.error('Error verificando PIN:', error);
                showPINError('Error de conexi√≥n. Int√©ntalo m√°s tarde.');
            }
        }

        // === DESBLOQUEAR ACCIONES ===
        function unlockResponseActions() {
            const buttons = document.querySelectorAll('.response-buttons .btn');
            buttons.forEach(btn => {
                btn.classList.remove('locked');
                btn.innerHTML = btn.innerHTML.replace('üîí ', '');
            });

            document.getElementById('authNotice').innerHTML = 
                '‚úÖ <strong>Autenticado correctamente</strong> - Puedes responder a la incidencia';
            document.getElementById('authNotice').style.background = '#d4edda';
            document.getElementById('authNotice').style.color = '#155724';
            document.getElementById('authNotice').style.border = '1px solid #c3e6cb';
        }

        // === MODAL DE MOTIVOS ===
        function showReasonModal(action) {
            const modal = document.createElement('div');
            modal.className = 'reason-modal';
            modal.id = 'reasonModal';

            const reasons = action === 'rechazo' ? rejectReasons : helpReasons;
            const title = action === 'rechazo' ? '‚ùå ¬øPor qu√© no puedes hacerte cargo?' : 'üÜò ¬øQu√© tipo de ayuda necesitas?';

            modal.innerHTML = `
                <div class="pin-modal-overlay" onclick="closeReasonModal()"></div>
                <div class="reason-modal-content">
                    <div class="reason-modal-header">
                        <h3>${title}</h3>
                        <button onclick="closeReasonModal()" class="close-btn">‚úï</button>
                    </div>

                    <div class="reason-options" id="reasonOptions">
                        ${reasons.map(reason => `
                            <div class="reason-option" onclick="selectReason('${reason.id}', this)">
                                <div class="icon">${reason.icon}</div>
                                <div class="text">
                                    <div class="title">${reason.title}</div>
                                    <div class="description">${reason.description}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="reason-actions">
                        <button onclick="closeReasonModal()" class="btn btn-secondary">Cancelar</button>
                        <button onclick="confirmReason('${action}')" class="btn btn-primary" id="confirmReasonBtn" disabled>
                            Confirmar
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function selectReason(reasonId, element) {
            // Deseleccionar todos
            document.querySelectorAll('.reason-option').forEach(option => {
                option.classList.remove('selected');
            });

            // Seleccionar el actual
            element.classList.add('selected');
            selectedReason = reasonId;

            // Habilitar bot√≥n de confirmar
            document.getElementById('confirmReasonBtn').disabled = false;
        }

        function confirmReason(action) {
            if (selectedReason) {
                closeReasonModal();
                handleResponse(action, selectedReason);
            }
        }

        // === MANEJO DE RESPUESTAS ===
        async function handleResponse(action, reason = null) {
            if (!isAuthenticated) {
                requestAuthentication(action);
                return;
            }

            try {
                showLoading(`Enviando respuesta: ${action}...`);

                const response = await fetch('/api/webhook-respuesta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: action,
                        id: currentIncident.id,
                        tecnico: currentTechnician,
                        reason: reason
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showSuccessResponse(action, reason);
                } else {
                    showError(data.message || 'Error procesando respuesta');
                }

            } catch (error) {
                console.error('Error enviando respuesta:', error);
                showError('Error de conexi√≥n. Int√©ntalo m√°s tarde.');
            } finally {
                hideLoading();
            }
        }

        // === MOSTRAR CONFIRMACI√ìN ===
        function showSuccessResponse(action, reason) {
            const responseSection = document.getElementById('responseSection');

            let message, nextStep, color;

            switch(action) {
                case 'acepto':
                    message = '‚úÖ Incidencia Aceptada';
                    nextStep = 'Te has asignado a esta incidencia. Puedes empezar a trabajar en ella.';
                    color = '#28a745';
                    break;

                case 'rechazo':
                    message = '‚ùå Incidencia Rechazada';
                    nextStep = 'La incidencia se escalar√° autom√°ticamente al siguiente nivel disponible.';
                    color = '#dc3545';
                    break;

                case 'ayuda':
                    message = 'üÜò Ayuda Solicitada';
                    nextStep = 'El escalado se ha pausado. Un supervisor se pondr√° en contacto contigo.';
                    color = '#ffc107';
                    break;
            }

            responseSection.innerHTML = `
                <div class="response-success" style="border-color: ${color};">
                    <div class="success-icon" style="color: ${color};">${message}</div>
                    <div class="success-message">${nextStep}</div>
                    ${reason ? `<div class="success-reason"><strong>Motivo:</strong> ${formatReason(reason)}</div>` : ''}
                    <div class="success-timestamp">
                        Respondido el ${new Date().toLocaleString()}
                    </div>

                    <div class="success-actions">
                        <button class="btn btn-secondary" onclick="location.reload()">
                            üîÑ Ver Estado Actual
                        </button>
                        <button class="btn btn-primary" onclick="showTechnicianDashboard()">
                            üìã Mis Otras Incidencias
                        </button>
                    </div>
                </div>
            `;
        }

        // === MODO B: DASHBOARD COMPLETO ===
        function showTechnicianLogin() {
            document.getElementById('loginOverlay').style.display = 'flex';
        }

        async function verifyTechnicianLogin() {
            const email = document.getElementById('technicianEmail').value;
            const pin = document.getElementById('technicianPin').value;

            if (!email || !email.includes('@')) {
                showLoginError('Introduce un email v√°lido');
                return;
            }

            if (!pin || pin.length !== 4) {
                showLoginError('Introduce un PIN de 4 d√≠gitos');
                return;
            }

            try {
                const response = await fetch('/api/webhook-respuesta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'validate_pin',
                        technician_email: email,
                        pin: pin
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // PIN v√°lido - Cargar dashboard completo
                    currentTechnician = email;
                    isAuthenticated = true;
                    document.getElementById('loginOverlay').style.display = 'none';
                    await loadTechnicianDashboard(email);
                } else {
                    showLoginError(data.message || 'PIN incorrecto');
                }

            } catch (error) {
                console.error('Error verificando login:', error);
                showLoginError('Error de conexi√≥n. Int√©ntalo m√°s tarde.');
            }
        }

        async function loadTechnicianDashboard(email) {
            try {
                showLoading('Cargando tus incidencias...');

                const response = await fetch('/api/webhook-respuesta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'get_assigned_incidents',
                        technician_email: email
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // Clasificar incidencias en frontend
                    const classifiedIncidents = classifyIncidents(data.incidents || [], email);
                    renderTechnicianDashboard(classifiedIncidents, email);
                    document.getElementById('mainContainer').style.display = 'block';
                } else {
                    showError(data.message || 'Error cargando dashboard');
                }

            } catch (error) {
                console.error('Error cargando dashboard:', error);
                showError('Error de conexi√≥n. Int√©ntalo m√°s tarde.');
            } finally {
                hideLoading();
            }
        }

        // === CLASIFICAR INCIDENCIAS EN FRONTEND ===
        function classifyIncidents(incidents, technicianEmail) {
            const pending = [];
            const working = [];

            incidents.forEach(incident => {
                if (incident.assigned_technician === technicianEmail) {
                    // Ya asignada - Est√° trabajando en ella
                    working.push({
                        ...incident,
                        type: 'working',
                        can_request_help: true,
                        requires_response: false
                    });
                } else {
                    // Pendiente de respuesta - Determinar nivel
                    let assignedLevel = 'desconocido';
                    let slaEnd = null;

                    if (incident.l0_technician === technicianEmail) {
                        assignedLevel = 'inicial';
                        slaEnd = incident.sla_l0_end;
                    } else if (incident.l1_technician === technicianEmail) {
                        assignedLevel = 'backup';
                        slaEnd = incident.sla_l1_backup_end;
                    } else if (incident.l2_technicians_notified?.includes?.(technicianEmail) || 
                               (typeof incident.l2_technicians_notified === 'string' && 
                                incident.l2_technicians_notified.includes(technicianEmail))) {
                        assignedLevel = 'equipo';
                        slaEnd = incident.sla_l2_equipo_end;
                    }

                    pending.push({
                        ...incident,
                        type: 'pending',
                        assigned_level: assignedLevel,
                        sla_end: slaEnd,
                        requires_response: true,
                        can_request_help: false
                    });
                }
            });

            return {
                pending_incidents: pending,
                working_incidents: working,
                technician: {
                    email: technicianEmail,
                    name: technicianEmail.split('@')[0]
                }
            };
        }

        function renderTechnicianDashboard(data, email) {
            const totalPending = data.pending_incidents?.length || 0;
            const totalWorking = data.working_incidents?.length || 0;
            
            document.getElementById('dashboardTitle').textContent = `üîß Dashboard de ${email.split('@')[0]}`;
            document.getElementById('dashboardSubtitle').textContent = `${totalPending} pendiente(s) ‚Ä¢ ${totalWorking} trabajando`;

            const incidentCard = document.getElementById('incidentCard');
            
            if (totalPending === 0 && totalWorking === 0) {
                incidentCard.innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                        <h3>‚úÖ Sin Incidencias</h3>
                        <p>No tienes incidencias pendientes ni asignadas en este momento</p>
                    </div>
                `;
            } else {
                incidentCard.innerHTML = `
                    <div class="incident-header">
                        <h2>üìã Mis Incidencias</h2>
                    </div>
                    <div style="padding: 25px;">
                        ${totalPending > 0 ? `
                        <div class="incident-section">
                            <h3 style="color: #e74c3c; margin-bottom: 15px; font-size: 18px;">
                                ‚è∞ Pendientes de Respuesta (${totalPending})
                            </h3>
                            <div class="incidents-grid">
                                ${data.pending_incidents.map(incident => `
                                    <div class="incident-item pending" onclick="loadSpecificIncident('${incident.id}')">
                                        <div class="incident-item-header">
                                            <strong>${incident.id}</strong>
                                            <span class="priority-badge priority-${incident.priority?.toLowerCase() || 'media'}">${incident.priority || 'MEDIA'}</span>
                                        </div>
                                        <div class="incident-item-content">
                                            <div>${incident.equipment || 'Equipo no especificado'}</div>
                                            <div class="incident-meta">
                                                üìç ${incident.zone || 'Sin zona'} ‚Ä¢ 
                                                üéØ Nivel ${incident.assigned_level || 'inicial'} ‚Ä¢
                                                ‚è∞ ${incident.sla_end ? `SLA: ${formatSLATime(incident.sla_end)}` : 'Sin l√≠mite'}
                                            </div>
                                        </div>
                                        <div class="incident-action">
                                            <span class="action-required">‚ö° REQUIERE RESPUESTA</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${totalWorking > 0 ? `
                        <div class="incident-section" ${totalPending > 0 ? 'style="margin-top: 30px; padding-top: 30px; border-top: 2px solid #f8f9fa;"' : ''}>
                            <h3 style="color: #28a745; margin-bottom: 15px; font-size: 18px;">
                                üîß Trabajando (${totalWorking})
                            </h3>
                            <div class="incidents-grid">
                                ${data.working_incidents.map(incident => `
                                    <div class="incident-item working" onclick="loadSpecificIncident('${incident.id}')">
                                        <div class="incident-item-header">
                                            <strong>${incident.id}</strong>
                                            <span class="priority-badge priority-${incident.priority?.toLowerCase() || 'media'}">${incident.priority || 'MEDIA'}</span>
                                        </div>
                                        <div class="incident-item-content">
                                            <div>${incident.equipment || 'Equipo no especificado'}</div>
                                            <div class="incident-meta">
                                                üìç ${incident.zone || 'Sin zona'} ‚Ä¢ 
                                                üìÖ Asignada: ${incident.assigned_date ? new Date(incident.assigned_date).toLocaleDateString() : 'Hoy'} ‚Ä¢
                                                üìä ${incident.status || 'En proceso'}
                                            </div>
                                        </div>
                                        <div class="incident-action">
                                            <span class="working-status">‚úÖ ASIGNADA - Puedes solicitar ayuda si necesario</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            incidentCard.style.display = 'block';
        }

        function loadSpecificIncident(incidentId) {
            window.location.href = `/tecnico?id=${incidentId}&tech=${currentTechnician}`;
        }

        function showTechnicianDashboard() {
            if (currentTechnician && isAuthenticated) {
                loadTechnicianDashboard(currentTechnician);
            } else {
                showTechnicianLogin();
            }
        }

        // === UTILIDADES ===
        function formatSLATime(slaEndDate) {
            const now = new Date();
            const endDate = new Date(slaEndDate);
            const timeLeft = endDate - now;
            
            if (timeLeft <= 0) {
                return 'VENCIDO';
            }
            
            const totalMinutes = Math.floor(timeLeft / (1000 * 60));
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }

        function formatReason(reason) {
            const reasons = {
                'ocupado_otra': 'Ocupado con otra incidencia',
                'fuera_especialidad': 'Fuera de especialidad',
                'no_disponible': 'No disponible',
                'falta_herramientas': 'Faltan herramientas/repuestos',
                'ubicacion_lejos': 'Muy lejos de ubicaci√≥n',
                'sobrecarga_trabajo': 'Sobrecarga de trabajo',
                'apoyo_tecnico': 'Necesita apoyo t√©cnico',
                'consulta_supervisor': 'Consulta con supervisor',
                'herramientas_especiales': 'Herramientas especiales',
                'procedimiento_dudas': 'Dudas sobre procedimiento',
                'seguridad_riesgo': 'Problema de seguridad',
                'repuestos_urgentes': 'Repuestos urgentes'
            };

            return reasons[reason] || reason;
        }

        function showLoading(message = 'Cargando...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showError(message) {
            alert('‚ùå ' + message);
        }

        function showPINError(message) {
            const errorDiv = document.getElementById('pinError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function closePINModal() {
            const modal = document.getElementById('pinModal');
            if (modal) modal.remove();
        }

        function closeReasonModal() {
            const modal = document.getElementById('reasonModal');
            if (modal) modal.remove();
            selectedReason = null;
        }

        // Permitir Enter en campos de login
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('technicianPin').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') verifyTechnicianLogin();
            });
        });
    </script>
</body>
</html>
