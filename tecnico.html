<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🔧 Dashboard Técnico</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
min-height: 100vh;
color: #333;
}

/* Full Screen Layout like Supervisor */
.main-container {
display: none;
min-height: 100vh;
padding: 20px;
max-width: 1400px;
margin: 0 auto;
}

.dashboard-header {
background: rgba(255,255,255,0.95);
backdrop-filter: blur(10px);
border-radius: 20px;
padding: 25px 40px;
margin-bottom: 25px;
text-align: center;
box-shadow: 0 8px 32px rgba(0,0,0,0.1);
border: 1px solid rgba(255,255,255,0.2);
}

.dashboard-title {
font-size: 28px;
color: #1a237e;
margin-bottom: 8px;
font-weight: 700;
}

.dashboard-subtitle {
color: #5c6bc0;
font-size: 16px;
font-weight: 500;
}

/* Filters & Controls */
.controls-bar {
background: rgba(255,255,255,0.95);
backdrop-filter: blur(10px);
border-radius: 16px;
padding: 20px;
margin-bottom: 25px;
box-shadow: 0 4px 20px rgba(0,0,0,0.1);
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
gap: 15px;
}

.filters-section {
display: flex;
gap: 15px;
align-items: center;
flex-wrap: wrap;
}

.filter-group {
display: flex;
align-items: center;
gap: 8px;
}

.filter-label {
font-size: 14px;
font-weight: 600;
color: #424242;
}

.filter-select {
background: white;
border: 2px solid #e0e0e0;
border-radius: 8px;
padding: 8px 12px;
font-size: 14px;
cursor: pointer;
transition: all 0.3s;
}

.filter-select:focus {
outline: none;
border-color: #667eea;
}

.auth-status {
padding: 12px 20px;
border-radius: 12px;
font-size: 14px;
font-weight: 600;
}

.auth-status.authenticated {
background: linear-gradient(135deg, #4caf50, #388e3c);
color: white;
}

.auth-status.read-only {
background: linear-gradient(135deg, #ff9800, #f57c00);
color: white;
}

/* Stats Bar */
.stats-bar {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 20px;
margin-bottom: 25px;
}

.stat-card {
background: rgba(255,255,255,0.95);
backdrop-filter: blur(10px);
border-radius: 16px;
padding: 20px;
text-align: center;
box-shadow: 0 4px 20px rgba(0,0,0,0.1);
transition: transform 0.3s;
}

.stat-card:hover {
transform: translateY(-2px);
}

.stat-number {
font-size: 32px;
font-weight: 800;
margin-bottom: 5px;
}

.stat-number.pending { color: #ff9800; }
.stat-number.working { color: #4caf50; }
.stat-number.expired { color: #f44336; }

.stat-label {
font-size: 14px;
color: #666;
font-weight: 600;
text-transform: uppercase;
letter-spacing: 0.5px;
}

/* Incidents Grid */
.incidents-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
gap: 25px;
}

.incident-card {
background: rgba(255,255,255,0.98);
backdrop-filter: blur(10px);
border-radius: 20px;
padding: 30px;
box-shadow: 0 8px 32px rgba(0,0,0,0.12);
border: 1px solid rgba(255,255,255,0.2);
transition: all 0.3s ease;
position: relative;
overflow: hidden;
}

.incident-card::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 4px;
background: linear-gradient(135deg, #667eea, #764ba2);
}

.incident-card.pending::before {
background: linear-gradient(135deg, #ff9800, #f57c00);
}

.incident-card.working::before {
background: linear-gradient(135deg, #4caf50, #388e3c);
}

.incident-card.expired::before {
background: linear-gradient(135deg, #f44336, #d32f2f);
animation: pulse 2s infinite;
}

@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.7; }
}

.incident-card:hover {
transform: translateY(-4px);
box-shadow: 0 12px 40px rgba(0,0,0,0.15);
}

.incident-header {
display: flex;
justify-content: space-between;
align-items: flex-start;
margin-bottom: 20px;
}

.incident-id {
background: linear-gradient(135deg, #e8eaf6, #c5cae9);
color: #1a237e;
padding: 10px 18px;
border-radius: 12px;
font-weight: 700;
font-size: 15px;
border: 1px solid #9fa8da;
}

.priority-badge {
padding: 8px 16px;
border-radius: 20px;
font-size: 12px;
font-weight: 700;
text-transform: uppercase;
letter-spacing: 0.5px;
}

.priority-critica {
background: linear-gradient(135deg, #f44336, #d32f2f);
color: white;
box-shadow: 0 2px 8px rgba(244,67,54,0.3);
}

.priority-alta {
background: linear-gradient(135deg, #ff9800, #f57c00);
color: white;
box-shadow: 0 2px 8px rgba(255,152,0,0.3);
}

.priority-media {
background: linear-gradient(135deg, #ffc107, #ff8f00);
color: white;
box-shadow: 0 2px 8px rgba(255,193,7,0.3);
}

.priority-baja {
background: linear-gradient(135deg, #4caf50, #388e3c);
color: white;
box-shadow: 0 2px 8px rgba(76,175,80,0.3);
}

.incident-content {
margin-bottom: 25px;
}

.incident-title {
font-size: 20px;
font-weight: 700;
color: #1565c0;
margin-bottom: 12px;
line-height: 1.3;
}

.incident-zone {
color: #666;
font-size: 15px;
margin-bottom: 12px;
background: #f5f5f5;
padding: 8px 14px;
border-radius: 8px;
display: inline-block;
}

.incident-description {
color: #555;
font-size: 15px;
line-height: 1.6;
margin-bottom: 18px;
background: #fafafa;
padding: 15px;
border-radius: 10px;
border-left: 3px solid #e0e0e0;
}

/* Info Sections */
.info-section {
margin: 18px 0;
}

.info-row {
display: flex;
justify-content: space-between;
align-items: center;
padding: 10px 15px;
margin: 8px 0;
border-radius: 10px;
font-size: 14px;
}

.info-row.status {
background: linear-gradient(135deg, #e3f2fd, #bbdefb);
color: #0d47a1;
font-weight: 600;
}

.info-row.assigned {
background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
color: #1b5e20;
font-weight: 600;
}

.info-row.response {
background: linear-gradient(135deg, #fff3e0, #ffe0b2);
color: #e65100;
font-weight: 600;
}

.info-row.escalation {
background: linear-gradient(135deg, #ffebee, #ffcdd2);
color: #c62828;
font-weight: 600;
}

/* SLA Timer */
.sla-section {
background: linear-gradient(135deg, #f8f9ff, #e8eaf6);
border-radius: 16px;
padding: 25px;
text-align: center;
margin: 18px 0;
border: 2px solid #c5cae9;
}

.sla-time {
font-size: 28px;
font-weight: 800;
margin-bottom: 8px;
font-family: 'Courier New', monospace;
}

.sla-time.good { color: #4caf50; }
.sla-time.warning { color: #ff9800; }
.sla-time.critical { color: #f44336; animation: blink 1s infinite; }

@keyframes blink {
0%, 50% { opacity: 1; }
51%, 100% { opacity: 0.5; }
}

.sla-label {
font-size: 13px;
color: #666;
font-weight: 600;
}

.sla-level {
background: linear-gradient(135deg, #667eea, #764ba2);
color: white;
padding: 6px 15px;
border-radius: 12px;
font-size: 12px;
font-weight: 700;
margin-top: 10px;
display: inline-block;
}

/* Expired Timer */
.expired-section {
background: linear-gradient(135deg, #ffebee, #ffcdd2);
border-radius: 16px;
padding: 25px;
text-align: center;
margin: 18px 0;
border: 2px solid #ef5350;
}

.expired-time {
font-size: 22px;
font-weight: 800;
color: #d32f2f;
margin-bottom: 8px;
}

.expired-label {
font-size: 13px;
color: #d32f2f;
font-weight: 700;
}

.escalation-info {
background: linear-gradient(135deg, #fff3e0, #ffe0b2);
padding: 15px;
border-radius: 10px;
margin: 12px 0;
font-size: 14px;
color: #e65100;
font-weight: 600;
text-align: center;
}

/* Action Buttons */
.actions-section {
margin-top: 25px;
}

.action-buttons {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 15px;
margin-bottom: 15px;
}

.action-btn {
padding: 15px 25px;
border: none;
border-radius: 12px;
font-size: 15px;
font-weight: 700;
cursor: pointer;
transition: all 0.3s;
text-transform: uppercase;
letter-spacing: 0.5px;
}

.action-btn.locked {
opacity: 0.6;
cursor: not-allowed;
background: #9e9e9e !important;
}

.btn-accept {
background: linear-gradient(135deg, #4caf50, #388e3c);
color: white;
}

.btn-reject {
background: linear-gradient(135deg, #f44336, #d32f2f);
color: white;
}

.btn-help {
background: linear-gradient(135deg, #ff9800, #f57c00);
color: white;
grid-column: 1 / -1;
}

.action-btn:hover:not(.locked) {
transform: translateY(-2px);
box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

/* Phone Buttons */
.phone-section {
display: grid;
grid-template-columns: 1fr;
gap: 12px;
margin-top: 18px;
}

.phone-btn {
background: linear-gradient(135deg, #2196f3, #1976d2);
color: white;
padding: 15px 25px;
border: none;
border-radius: 12px;
font-weight: 700;
text-decoration: none;
text-align: center;
transition: all 0.3s;
font-size: 15px;
}

.phone-btn.supervisor {
background: linear-gradient(135deg, #9c27b0, #7b1fa2);
}

.phone-btn:hover {
transform: translateY(-2px);
box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

.contact-info {
background: #e8f5e8;
padding: 12px;
border-radius: 8px;
margin: 10px 0;
text-align: center;
font-size: 14px;
color: #2e7d32;
font-weight: 600;
}

/* Single Incident View */
.single-incident {
max-width: 900px;
margin: 0 auto;
}

.single-incident .incident-card {
background: rgba(255,255,255,0.98);
padding: 50px;
}

.single-incident .incident-title {
font-size: 28px;
margin-bottom: 20px;
}

.single-incident .incident-description {
font-size: 18px;
padding: 25px;
}

/* Loading */
.loading {
text-align: center;
padding: 60px;
color: white;
}

.spinner {
width: 50px;
height: 50px;
border: 4px solid rgba(255,255,255,0.3);
border-top-color: white;
border-radius: 50%;
animation: spin 1s linear infinite;
margin: 0 auto 30px;
}

@keyframes spin {
to { transform: rotate(360deg); }
}

/* Login Container */
.login-container {
background: rgba(255,255,255,0.95);
backdrop-filter: blur(10px);
border-radius: 20px;
padding: 40px;
text-align: center;
box-shadow: 0 20px 60px rgba(0,0,0,0.15);
max-width: 500px;
margin: 50px auto;
}

.login-title {
font-size: 28px;
color: #1a237e;
margin-bottom: 15px;
font-weight: 700;
}

.login-subtitle {
color: #5c6bc0;
margin-bottom: 30px;
font-size: 16px;
}

.input-group {
margin-bottom: 25px;
text-align: left;
}

.input-label {
display: block;
margin-bottom: 8px;
font-weight: 600;
color: #424242;
}

.input-field {
width: 100%;
padding: 15px;
border: 2px solid #e0e0e0;
border-radius: 12px;
font-size: 16px;
transition: border-color 0.3s;
}

.input-field:focus {
outline: none;
border-color: #667eea;
}

.verify-btn, .quick-access-btn {
width: 100%;
padding: 15px;
border: none;
border-radius: 12px;
font-size: 16px;
font-weight: 700;
cursor: pointer;
margin-bottom: 15px;
transition: all 0.3s;
}

.verify-btn {
background: linear-gradient(135deg, #667eea, #764ba2);
color: white;
}

.quick-access-btn {
background: rgba(102,126,234,0.1);
color: #667eea;
border: 2px solid #667eea;
display: none; /* OCULTO - no tiene sentido sin ID específico */
}

.verify-btn:hover, .quick-access-btn:hover {
transform: translateY(-2px);
box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* No incidents */
.no-incidents {
background: rgba(255,255,255,0.95);
backdrop-filter: blur(10px);
border-radius: 20px;
padding: 60px;
text-align: center;
box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}

.no-incidents-icon {
font-size: 80px;
margin-bottom: 25px;
}

.no-incidents-title {
font-size: 24px;
color: #1a237e;
margin-bottom: 15px;
font-weight: 700;
}

.no-incidents-description {
color: #5c6bc0;
font-size: 16px;
}

/* Responsive */
@media (max-width: 768px) {
.incidents-grid {
grid-template-columns: 1fr;
}

.controls-bar {
flex-direction: column;
align-items: stretch;
}

.stats-bar {
grid-template-columns: repeat(3, 1fr);
}

.action-buttons {
grid-template-columns: 1fr;
}

.main-container {
padding: 15px;
}

.single-incident .incident-card {
padding: 30px 20px;
}
}

/* Modals */
.modal-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.7);
display: flex;
align-items: center;
justify-content: center;
z-index: 1000;
opacity: 0;
visibility: hidden;
transition: all 0.3s;
}

.modal-overlay.active {
opacity: 1;
visibility: visible;
}

.modal-content, .pin-modal {
background: white;
border-radius: 20px;
padding: 30px;
max-width: 500px;
width: 90%;
max-height: 80vh;
overflow-y: auto;
transform: scale(0.8);
transition: transform 0.3s;
}

.modal-overlay.active .modal-content,
.modal-overlay.active .pin-modal {
transform: scale(1);
}

.modal-title, .pin-modal-title {
font-size: 20px;
color: #1a237e;
margin-bottom: 20px;
text-align: center;
font-weight: 700;
}

.reason-options {
display: flex;
flex-direction: column;
gap: 12px;
margin-bottom: 25px;
}

.reason-option {
padding: 15px;
border: 2px solid #e0e0e0;
border-radius: 12px;
cursor: pointer;
transition: all 0.3s;
display: flex;
align-items: center;
gap: 12px;
}

.reason-option:hover {
border-color: #667eea;
background: rgba(102,126,234,0.05);
}

.reason-option.selected {
border-color: #667eea;
background: rgba(102,126,234,0.1);
}

.reason-icon {
font-size: 24px;
min-width: 30px;
}

.reason-text {
flex: 1;
}

.reason-title {
font-weight: 600;
color: #1a237e;
margin-bottom: 3px;
}

.reason-description {
font-size: 13px;
color: #666;
}

.modal-actions, .pin-actions {
display: flex;
gap: 15px;
}

.modal-btn, .pin-btn {
flex: 1;
padding: 15px;
border: none;
border-radius: 12px;
font-size: 16px;
font-weight: 700;
cursor: pointer;
transition: all 0.3s;
}

.btn-cancel, .pin-btn-cancel {
background: #f5f5f5;
color: #666;
}

.btn-confirm, .pin-btn-verify {
background: linear-gradient(135deg, #667eea, #764ba2);
color: white;
}

.pin-input {
width: 100%;
padding: 15px;
border: 2px solid #e0e0e0;
border-radius: 12px;
font-size: 18px;
text-align: center;
letter-spacing: 8px;
margin-bottom: 20px;
}

.error-message {
background: #ffebee;
color: #c62828;
padding: 12px;
border-radius: 8px;
margin-top: 15px;
}
</style>
</head>
<body>
<!-- Login Container -->
<div class="container" id="loginContainer">
<div class="login-container">
<h1 class="login-title">🔧 Dashboard Técnico</h1>
<p class="login-subtitle">Accede con tu email para gestionar incidencias</p>

<div class="input-group">
<label class="input-label" for="emailInput">Email Técnico</label>
<input type="email" class="input-field" id="emailInput" placeholder="ejemplo@empresa.com" autocomplete="email">
</div>

<button onclick="loginWithPIN()" class="verify-btn" id="loginBtn">
🔒 Acceder con PIN (Dashboard Completo)
</button>

<div id="loginError" class="error-message" style="display: none;"></div>
</div>
</div>

<!-- Main Dashboard Container -->
<div class="main-container" id="mainContainer">
<!-- Dashboard Header -->
<div class="dashboard-header">
<h1 class="dashboard-title" id="dashboardTitle">🔧 Dashboard Técnico</h1>
<div class="dashboard-subtitle" id="dashboardSubtitle">Sistema de Respuesta a Incidencias</div>
</div>

<!-- Controls Bar -->
<div class="controls-bar">
<div class="filters-section">
<div class="filter-group">
<span class="filter-label">Estado:</span>
<select class="filter-select" id="statusFilter" onchange="applyFilters()">
<option value="">Todos</option>
<option value="pending">Pendientes</option>
<option value="working">Trabajando</option>
<option value="expired">Vencidas</option>
</select>
</div>
<div class="filter-group">
<span class="filter-label">Prioridad:</span>
<select class="filter-select" id="priorityFilter" onchange="applyFilters()">
<option value="">Todas</option>
<option value="CRÍTICA">Crítica</option>
<option value="ALTA">Alta</option>
<option value="MEDIA">Media</option>
<option value="BAJA">Baja</option>
</select>
</div>
<button onclick="refreshIncidents()" class="verify-btn" style="width: auto; padding: 10px 20px; margin: 0;">
🔄 Actualizar
</button>
</div>
<div class="auth-status" id="authStatus">
<span id="authMessage">⚠️ Solo lectura</span>
</div>
</div>

<!-- Stats Bar -->
<div class="stats-bar">
<div class="stat-card">
<div class="stat-number pending" id="pendingCount">0</div>
<div class="stat-label">Pendientes</div>
</div>
<div class="stat-card">
<div class="stat-number working" id="workingCount">0</div>
<div class="stat-label">Trabajando</div>
</div>
<div class="stat-card">
<div class="stat-number expired" id="expiredCount">0</div>
<div class="stat-label">Vencidas</div>
</div>
</div>

<!-- Incidents Grid -->
<div class="incidents-grid" id="incidentsContainer">
<!-- Se llena dinámicamente -->
</div>
</div>

<!-- PIN Modal -->
<div class="modal-overlay" id="pinModal">
<div class="pin-modal">
<h3 class="pin-modal-title">🔐 Verificación de Seguridad</h3>
<p style="text-align: center; color: #666; margin-bottom: 25px;">Introduce tu PIN de 4 dígitos</p>
<input type="password" class="pin-input" id="pinInput" maxlength="4" placeholder="••••" autocomplete="off">
<div class="pin-actions">
<button class="pin-btn pin-btn-cancel" onclick="closePINModal()">Cancelar</button>
<button class="pin-btn pin-btn-verify" id="verifyPinBtn" onclick="verifyPIN()" disabled>Verificar</button>
</div>
<div id="pinError" class="error-message" style="display: none;"></div>
</div>
</div>

<!-- Reason Modal -->
<div class="modal-overlay" id="reasonModal">
<div class="modal-content">
<h3 class="modal-title" id="modalTitle">Selecciona el motivo</h3>
<div class="reason-options" id="reasonOptions"></div>
<div class="modal-actions">
<button class="modal-btn btn-cancel" onclick="closeReasonModal()">Cancelar</button>
<button class="modal-btn btn-confirm" id="confirmBtn" onclick="confirmAction()" disabled>Confirmar</button>
</div>
</div>
</div>

<script>
// Variables globales
let currentIncident = null;
let currentTechnician = null;
let isAuthenticated = false;
let pendingAction = null;
let selectedReason = null;
let accessMode = 'none';
let allIncidents = [];
let filteredIncidents = [];

// Motivos de respuesta
const rejectReasons = [
{ id: 'ocupado_otra', icon: '⚡', title: 'Ocupado con otra incidencia', description: 'Ya estoy resolviendo otra incidencia crítica' },
{ id: 'fuera_especialidad', icon: '❓', title: 'Fuera de mi especialidad', description: 'No tengo experiencia con este tipo de equipo' },
{ id: 'no_disponible', icon: '⏰', title: 'No disponible ahora', description: 'Estoy en pausa, reunión o fuera de turno' },
{ id: 'falta_herramientas', icon: '🔧', title: 'Faltan herramientas/repuestos', description: 'No tengo las herramientas necesarias disponibles' },
{ id: 'ubicacion_lejos', icon: '📍', title: 'Muy lejos de mi ubicación', description: 'Estoy muy lejos de la zona de la incidencia' },
{ id: 'sobrecarga_trabajo', icon: '⚡', title: 'Sobrecarga de trabajo', description: 'Ya tengo demasiadas incidencias asignadas' }
];

const helpReasons = [
{ id: 'apoyo_tecnico', icon: '🤝', title: 'Necesito apoyo técnico', description: 'Requiero asistencia de otro técnico especializado' },
{ id: 'consulta_supervisor', icon: '👨', title: 'Consulta con supervisor', description: 'Necesito autorización o guía del supervisor' },
{ id: 'herramientas_especiales', icon: '🔧', title: 'Herramientas especiales', description: 'Requiero herramientas específicas no disponibles' },
{ id: 'procedimiento_dudas', icon: '📖', title: 'Dudas sobre procedimiento', description: 'No estoy seguro del procedimiento correcto' },
{ id: 'seguridad_riesgo', icon: '⚠️', title: 'Problema de seguridad', description: 'Hay riesgos de seguridad que requieren evaluación' },
{ id: 'repuestos_urgentes', icon: '📦', title: 'Repuestos urgentes', description: 'Necesito repuestos específicos urgentemente' }
];

// === INICIALIZACIÓN ===
window.addEventListener('DOMContentLoaded', function() {
console.log('🔧 Dashboard Técnico iniciado');

// Verificar si hay parámetros en la URL (acceso desde email)
const urlParams = new URLSearchParams(window.location.search);
const email = urlParams.get('tecnico') || urlParams.get('technician_email');
const nombre = urlParams.get('nombre') || urlParams.get('technician_name');
const incidentId = urlParams.get('id') || urlParams.get('incident_id');

if (email) {
document.getElementById('emailInput').value = email;

// Guardar nombre si viene en URL
if (nombre) {
currentTechnician = {
email: email,
name: decodeURIComponent(nombre)
};
}

// Si hay ID específico, acceso directo automático
if (incidentId) {
console.log('🔧 Acceso directo a incidencia:', incidentId);
accessMode = 'read_only';
loadTechnicianDashboard(email, false);
}
}
});

// === FUNCIONES DE LOGIN ===
async function loginWithPIN() {
const email = document.getElementById('emailInput').value.trim();

if (!email || !email.includes('@')) {
showError('Por favor ingresa un email válido', document.getElementById('loginError'));
return;
}

// Mostrar modal de PIN para acceso completo
showPINModal('dashboard');
}

function showPINModal(purpose = 'action') {
const modal = document.getElementById('pinModal');
const pinInput = document.getElementById('pinInput');
const verifyBtn = document.getElementById('verifyPinBtn');

pinInput.value = '';
verifyBtn.disabled = true;
modal.classList.add('active');
pinInput.focus();

pinInput.oninput = function() {
verifyBtn.disabled = this.value.length !== 4;
};

pinInput.onkeypress = function(e) {
if (e.key === 'Enter' && this.value.length === 4) {
verifyPIN();
}
};
}

function closePINModal() {
document.getElementById('pinModal').classList.remove('active');
pendingAction = null;
}

async function verifyPIN() {
const pin = document.getElementById('pinInput').value;
const email = document.getElementById('emailInput').value;
const verifyBtn = document.getElementById('verifyPinBtn');

if (pin.length !== 4) {
showError('Introduce un PIN de 4 dígitos', document.getElementById('pinError'));
return;
}

verifyBtn.disabled = true;
verifyBtn.textContent = '🔄 Verificando...';

try {
const response = await fetch('/api/webhook-respuesta', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
action: 'validate_technician_pin',
technician_email: email,
technician_name: currentTechnician?.name || email.split('@')[0],
pin: pin
})
});

const data = await response.json();

if (data.status === 'success') {
isAuthenticated = true;
accessMode = 'full_access';
closePINModal();

currentTechnician = {
email: email,
name: data.technician.name,
department: data.technician.department,
level: data.technician.level
};

if (pendingAction) {
if (pendingAction === 'acepto') {
confirmAction();
} else {
showReasonModal(pendingAction);
}
} else {
await loadTechnicianDashboard(email, true);
updateAuthStatus();
}
} else {
showError(data.message || 'PIN incorrecto', document.getElementById('pinError'));
}

} catch (error) {
console.error('Error verificando PIN:', error);
showError('Error de conexión. Inténtalo más tarde.', document.getElementById('pinError'));
} finally {
verifyBtn.disabled = false;
verifyBtn.textContent = 'Verificar';
}
}

// === CARGA DEL DASHBOARD ===
async function loadTechnicianDashboard(email, useFullAccess = false) {
try {
showLoading('Cargando tus incidencias...');

const response = await fetch('/api/webhook-respuesta', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
action: 'get_assigned_incidents',
technician_email: email,
technician_name: currentTechnician?.name || email.split('@')[0],
read_only: !useFullAccess
})
});

const data = await response.json();
console.log('📋 Respuesta del servidor:', data);

if (data.status === 'success') {
if (!currentTechnician) {
currentTechnician = {
email: email,
name: data.technician?.name || email.split('@')[0]
};
}

allIncidents = data.incidents || [];
document.getElementById('loginContainer').style.display = 'none';
document.getElementById('mainContainer').style.display = 'block';

document.getElementById('dashboardTitle').textContent = '🔧 Dashboard de ' + currentTechnician.name;
updateAuthStatus();
applyFilters();
} else {
throw new Error(data.message || 'Error cargando dashboard');
}

} catch (error) {
console.error('Error cargando dashboard:', error);
showError('Error de conexión. Inténtalo más tarde.', document.getElementById('loginError'));
} finally {
hideLoading();
}
}

function updateAuthStatus() {
const statusDiv = document.getElementById('authStatus');
const messageDiv = document.getElementById('authMessage');

if (accessMode === 'full_access') {
statusDiv.className = 'auth-status authenticated';
messageDiv.textContent = '✅ Autenticado - Puedes responder a incidencias';
} else if (accessMode === 'read_only') {
statusDiv.className = 'auth-status read-only';
messageDiv.textContent = '👁️ Solo lectura - Introduce PIN para responder';
} else {
statusDiv.className = 'auth-status';
messageDiv.textContent = '⚠️ Sin autenticar';
}
}

// === FILTROS Y CLASIFICACIÓN ===
function applyFilters() {
const statusFilter = document.getElementById('statusFilter').value;
const priorityFilter = document.getElementById('priorityFilter').value;
const urlParams = new URLSearchParams(window.location.search);
const specificIncidentId = urlParams.get('id') || urlParams.get('incident_id');

// Si hay ID específico en URL, mostrar solo esa incidencia
if (specificIncidentId) {
const specificIncident = allIncidents.find(inc => inc.id === specificIncidentId);
if (specificIncident) {
renderSingleIncident(specificIncident);
return;
} else {
document.getElementById('incidentsContainer').innerHTML = 
createNoIncidentsHTML('Incidencia No Encontrada', '❓', 'La incidencia ' + specificIncidentId + ' no existe o no está asignada a ti');
return;
}
}

// Clasificar y filtrar incidencias
const classified = classifyIncidents(allIncidents);
let incidentsToShow = [];

if (statusFilter === 'pending') incidentsToShow = classified.pending;
else if (statusFilter === 'working') incidentsToShow = classified.working;
else if (statusFilter === 'expired') incidentsToShow = classified.expired;
else incidentsToShow = [...classified.pending, ...classified.working, ...classified.expired];

if (priorityFilter) {
incidentsToShow = incidentsToShow.filter(inc => 
inc.priority && inc.priority.includes(priorityFilter)
);
}

// Actualizar stats
updateStats(classified);

// Renderizar incidencias
renderIncidentsGrid(incidentsToShow, classified);
}

function classifyIncidents(incidents) {
const pending = [];
const working = [];
const expired = [];

incidents.forEach(incident => {
if (!isAssignedToMe(incident)) return;

// Verificar si ya está trabajando (asignado definitivamente)
if (incident.assigned_technician && incident.assigned_technician !== 'Sin asignar' &&
incident.assigned_technician !== '' && incident.assigned_technician === currentTechnician.name) {
working.push(incident);
} else {
// Verificar si SLA vencido o escalado
const timeElapsed = incident.time_elapsed || 0;
const escalationLevel = incident.escalation_level || 0;
const escalationPaused = incident.escalation_paused === 'true';

let isExpired = false;
if (!escalationPaused) {
let slaMinutes = 30; // Default L0
if (getIncidentLevel(incident) === 'L1') slaMinutes = 45;
if (getIncidentLevel(incident) === 'L2') slaMinutes = 60;
isExpired = timeElapsed > slaMinutes;
}

// Verificar si ya ha respondido
let hasResponded = false;
const level = getIncidentLevel(incident);
if (level === 'L0' && incident.l0_response && incident.l0_response !== '⭕ Sin Respuesta') {
hasResponded = true;
} else if (level === 'L1' && incident.l1_response && incident.l1_response !== '⭕ Sin Respuesta') {
hasResponded = true;
} else if (level === 'L2' && incident.l2_responses && incident.l2_responses !== '') {
hasResponded = true;
}

if (hasResponded || isExpired || escalationLevel > getCurrentEscalationLevel(incident)) {
expired.push(incident);
} else {
pending.push(incident);
}
}
});

return { pending, working, expired };
}

function isAssignedToMe(incident) {
const email = currentTechnician?.email;
if (!email) return false;

return (
incident.l0_technician === email ||
incident.l1_technician === email ||
(incident.l2_technicians_notified && incident.l2_technicians_notified.includes(email)) ||
(incident.l2_technicians && incident.l2_technicians.includes(email)) ||
incident.assigned_technician === email
);
}

function getIncidentLevel(incident) {
const email = currentTechnician?.email;
if (!email) return 'L0';

if (incident.l0_technician === email) return 'L0';
if (incident.l1_technician === email) return 'L1';
if (incident.l2_technicians_notified && incident.l2_technicians_notified.includes(email)) return 'L2';
if (incident.l2_technicians && incident.l2_technicians.includes(email)) return 'L2';
return 'L0';
}

function getCurrentEscalationLevel(incident) {
const email = currentTechnician?.email;
if (incident.l0_technician === email) return 0;
if (incident.l1_technician === email) return 1;
if (incident.l2_technicians_notified && incident.l2_technicians_notified.includes(email)) return 2;
if (incident.l2_technicians && incident.l2_technicians.includes(email)) return 2;
return 0;
}

function updateStats(classified) {
document.getElementById('pendingCount').textContent = classified.pending.length;
document.getElementById('workingCount').textContent = classified.working.length;
document.getElementById('expiredCount').textContent = classified.expired.length;

// Actualizar subtitle
const total = classified.pending.length + classified.working.length + classified.expired.length;
document.getElementById('dashboardSubtitle').textContent = 
`${classified.pending.length} pendiente(s) • ${classified.working.length} trabajando • ${classified.expired.length} vencida(s) • Total: ${total}`;
}

// === RENDERIZADO ===
function renderIncidentsGrid(incidents, classified) {
const container = document.getElementById('incidentsContainer');

if (incidents.length === 0) {
container.innerHTML = createNoIncidentsHTML('Sin Incidencias', '✅', 'No hay incidencias que coincidan con los filtros aplicados');
return;
}

let html = '';
incidents.forEach(incident => {
const type = classified.pending.includes(incident) ? 'pending' :
classified.working.includes(incident) ? 'working' : 'expired';
html += renderIncidentCard(incident, type);
});

container.innerHTML = html;
startAllSLATimers();
}

function renderSingleIncident(incident) {
const container = document.getElementById('incidentsContainer');
currentIncident = incident;

const classified = classifyIncidents([incident]);
const type = classified.pending.includes(incident) ? 'pending' :
classified.working.includes(incident) ? 'working' : 'expired';

container.innerHTML = `<div class="single-incident">${renderIncidentCard(incident, type)}</div>`;
startAllSLATimers();
}

function renderIncidentCard(incident, type) {
const priorityClass = getPriorityClass(incident.priority);
const level = getIncidentLevel(incident);

// Información de respuesta según el nivel
let responseInfo = '';
if (level === 'L0' && incident.l0_response && incident.l0_response !== '⭕ Sin Respuesta') {
responseInfo += `<div class="info-row response"><span>Respuesta L0:</span><span>${incident.l0_response}</span></div>`;
if (incident.l0_response.includes('Rechazado') && incident.l0_reject_reason !== 'Sin motivo') {
responseInfo += `<div class="info-row"><span>Motivo:</span><span>${incident.l0_reject_reason}</span></div>`;
}
} else if (level === 'L1' && incident.l1_response && incident.l1_response !== '⭕ Sin Respuesta') {
responseInfo += `<div class="info-row response"><span>Respuesta L1:</span><span>${incident.l1_response}</span></div>`;
if (incident.l1_response.includes('Rechazado') && incident.l1_reject_reason !== 'Sin motivo') {
responseInfo += `<div class="info-row"><span>Motivo:</span><span>${incident.l1_reject_reason}</span></div>`;
}
} else if (level === 'L2' && incident.l2_responses && incident.l2_responses !== '') {
responseInfo += `<div class="info-row response"><span>Respuestas L2:</span><span>${incident.l2_responses}</span></div>`;
}

// SLA o información de vencimiento
let timerContent = '';
if (type === 'pending') {
const slaEnd = getSlaEndTime(incident);
if (slaEnd) {
timerContent = `
<div class="sla-section">
<div class="sla-time" id="timer-${incident.id}">--:--</div>
<div class="sla-label">Tiempo restante para responder</div>
<div class="sla-level">NIVEL ${level}</div>
</div>`;
}
} else if (type === 'expired') {
const timeElapsed = incident.time_elapsed || 0;
const hoursElapsed = Math.floor(timeElapsed / 60);
const minutesElapsed = timeElapsed % 60;

timerContent = `
<div class="expired-section">
<div class="expired-time">⏰ Hace ${hoursElapsed}h ${minutesElapsed}m</div>
<div class="expired-label">VENCIDA - SLA SUPERADO</div>
</div>`;

// Información de escalado
const escalationLevel = incident.escalation_level || 0;
const escalationPaused = incident.escalation_paused === 'true';

let escalationInfo = '';
if (escalationPaused) {
escalationInfo = '🚦 Escalado pausado por supervisor';
} else if (escalationLevel > 0) {
escalationInfo = `⚠️ Escalado a nivel L${escalationLevel} - Contacta por teléfono para coordinar`;
} else {
escalationInfo = '⚠️ Incidencia vencida - Contacta por teléfono para coordinar';
}

if (escalationInfo) {
timerContent += `<div class="escalation-info">${escalationInfo}</div>`;
}
}

// Botones de acción
let actionContent = '';
if (type === 'pending') {
const canRespond = (accessMode === 'full_access');
const lockClass = canRespond ? '' : ' locked';
const acceptText = canRespond ? '✅ ACEPTO' : '🔒 ACEPTO';
const rejectText = canRespond ? '❌ RECHAZO' : '🔒 RECHAZO';
const helpText = canRespond ? '🆘 SOLICITAR AYUDA' : '🔒 SOLICITAR AYUDA';

actionContent = `
<div class="actions-section">
<div class="action-buttons">
<button class="action-btn btn-accept${lockClass}" onclick="handleAction('acepto', '${incident.id}')">
${acceptText}
</button>
<button class="action-btn btn-reject${lockClass}" onclick="handleAction('rechazo', '${incident.id}')">
${rejectText}
</button>
</div>
<button class="action-btn btn-help${lockClass}" onclick="handleAction('ayuda', '${incident.id}')">
${helpText}
</button>
</div>`;
} else if (type === 'working') {
const canRespond = (accessMode === 'full_access');
const lockClass = canRespond ? '' : ' locked';
const helpText = canRespond ? '🆘 SOLICITAR AYUDA' : '🔒 SOLICITAR AYUDA';

actionContent = `
<div class="actions-section">
<button class="action-btn btn-help${lockClass}" onclick="handleAction('ayuda', '${incident.id}')">
${helpText}
</button>
</div>`;
} else if (type === 'expired') {
actionContent = '<div class="phone-section">';

if (incident.supervisor_phone && incident.supervisor_phone !== 'Sin teléfono') {
actionContent += `<a href="tel:${incident.supervisor_phone}" class="phone-btn supervisor">📞 SUPERVISOR</a>`;
}
if (incident.manager_phone && incident.manager_phone !== 'Sin teléfono') {
actionContent += `<a href="tel:${incident.manager_phone}" class="phone-btn">📞 ENCARGADO</a>`;
}

if (incident.supervisor && incident.supervisor !== 'Sin supervisor') {
actionContent += `<div class="contact-info">👤 Supervisor: ${incident.supervisor}</div>`;
}
if (incident.reporter && incident.reporter !== 'Sin reportador') {
actionContent += `<div class="contact-info">📋 Reportador: ${incident.reporter}</div>`;
}

actionContent += '</div>';
}

// Información adicional
let additionalInfo = '';
if (incident.status && incident.status !== '🆕 Nueva') {
additionalInfo += `<div class="info-row status"><span>Estado:</span><span>${incident.status}</span></div>`;
}
if (incident.assigned_technician && incident.assigned_technician !== 'Sin asignar' && incident.assigned_technician !== '') {
additionalInfo += `<div class="info-row assigned"><span>👤 Asignado a:</span><span>${incident.assigned_technician}</span></div>`;
}
if (incident.escalation_level && incident.escalation_level > 0) {
additionalInfo += `<div class="info-row escalation"><span>⚡ Escalado:</span><span>Nivel L${incident.escalation_level}</span></div>`;
}

return `
<div class="incident-card ${type}" data-incident-id="${incident.id}">
<div class="incident-header">
<div class="incident-id">${incident.id}</div>
<div class="priority-badge priority-${priorityClass}">${incident.priority || 'MEDIA'}</div>
</div>

<div class="incident-content">
<div class="incident-title">${incident.equipment || 'Equipo no especificado'}</div>
<div class="incident-zone">📍 ${incident.zone || 'Sin zona'}</div>
<div class="incident-description">${incident.description || 'Sin descripción disponible'}</div>

<div class="info-section">
${additionalInfo}
${responseInfo}
</div>
</div>

${timerContent}
${actionContent}
</div>`;
}

function getPriorityClass(priority) {
if (!priority) return 'media';
const p = priority.toLowerCase();
if (p.includes('crítica') || p.includes('critical')) return 'critica';
if (p.includes('alta') || p.includes('high')) return 'alta';
if (p.includes('media') || p.includes('medium')) return 'media';
if (p.includes('baja') || p.includes('low')) return 'baja';
return 'media';
}

function getSlaEndTime(incident) {
const level = getIncidentLevel(incident);
if (level === 'L0') return incident.sla_l0_end;
if (level === 'L1') return incident.sla_l1_backup_end;
if (level === 'L2') return incident.sla_l2_equipo_end;
return incident.sla_l0_end;
}

// === TIMERS SLA ===
function startAllSLATimers() {
document.querySelectorAll('[id^="timer-"]').forEach(timer => {
const incidentId = timer.id.replace('timer-', '');
const incident = allIncidents.find(inc => inc.id === incidentId);
if (incident) {
const slaEnd = getSlaEndTime(incident);
if (slaEnd) {
startSLATimer(slaEnd, timer.id);
}
}
});
}

function startSLATimer(slaEndTime, timerId) {
function updateTimer() {
const now = new Date();
const end = new Date(slaEndTime);
const diff = end - now;

const timerElement = document.getElementById(timerId);
if (!timerElement) return;

if (diff <= 0) {
timerElement.textContent = '00:00';
timerElement.className = 'sla-time critical';
return;
}

const totalMinutes = Math.floor(diff / 60000);
const hours = Math.floor(totalMinutes / 60);
const minutes = totalMinutes % 60;
const seconds = Math.floor((diff % 60000) / 1000);

let timeText;
if (hours > 0) {
timeText = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
} else {
timeText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

timerElement.textContent = timeText;

// Calcular porcentaje de tiempo restante
const totalSLATime = 30 * 60 * 1000; // 30 minutos en ms
const percentage = (diff / totalSLATime) * 100;

if (percentage > 50) {
timerElement.className = 'sla-time good';
} else if (percentage > 20) {
timerElement.className = 'sla-time warning';
} else {
timerElement.className = 'sla-time critical';
}
}

updateTimer();
setInterval(updateTimer, 1000);
}

// === ACCIONES ===
function handleAction(action, incidentId) {
currentIncident = allIncidents.find(inc => inc.id === incidentId);
if (!currentIncident) {
console.error('Incidencia no encontrada:', incidentId);
return;
}

if (accessMode !== 'full_access') {
pendingAction = action;
showPINModal('action');
return;
}

if (action === 'acepto') {
confirmAction();
} else {
showReasonModal(action);
}
}

function showReasonModal(action) {
pendingAction = action;
selectedReason = null;

const modal = document.getElementById('reasonModal');
const title = document.getElementById('modalTitle');
const options = document.getElementById('reasonOptions');
const confirmBtn = document.getElementById('confirmBtn');

let reasons = [];
switch(action) {
case 'rechazo':
title.textContent = '❌ Motivo del Rechazo';
reasons = rejectReasons;
confirmBtn.textContent = 'Rechazar';
break;
case 'ayuda':
title.textContent = '🆘 Tipo de Ayuda Requerida';
reasons = helpReasons;
confirmBtn.textContent = 'Solicitar Ayuda';
break;
}

options.innerHTML = reasons.map(reason => `
<div class="reason-option" onclick="selectReason('${reason.id}')">
<div class="reason-icon">${reason.icon}</div>
<div class="reason-text">
<div class="reason-title">${reason.title}</div>
<div class="reason-description">${reason.description}</div>
</div>
</div>
`).join('');

confirmBtn.disabled = true;
modal.classList.add('active');
}

function selectReason(reasonId) {
selectedReason = reasonId;

document.querySelectorAll('.reason-option').forEach(option => {
option.classList.remove('selected');
});

event.currentTarget.classList.add('selected');
document.getElementById('confirmBtn').disabled = false;
}

function closeReasonModal() {
document.getElementById('reasonModal').classList.remove('active');
pendingAction = null;
selectedReason = null;
}

async function confirmAction() {
if (!pendingAction || !currentIncident) return;

const confirmBtn = document.getElementById('confirmBtn');
const originalText = confirmBtn?.textContent || 'Confirmar';

try {
if (confirmBtn) {
confirmBtn.disabled = true;
confirmBtn.textContent = '🔄 Procesando...';
}

const response = await fetch('/api/webhook-respuesta', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
action: pendingAction,
incident_id: currentIncident.id,
technician_email: currentTechnician.email,
technician_name: currentTechnician.name,
reason: selectedReason,
escalation_level: getCurrentEscalationLevel(currentIncident)
})
});

const data = await response.json();
console.log('✅ Respuesta enviada:', data);

if (data.status === 'success') {
closeReasonModal();
showSuccessAndReload(data);
} else {
throw new Error(data.message || 'Error procesando respuesta');
}

} catch (error) {
console.error('Error enviando respuesta:', error);
showError('Error de conexión. Inténtalo más tarde.');
} finally {
if (confirmBtn) {
confirmBtn.disabled = false;
confirmBtn.textContent = originalText;
}
}
}

function showSuccessAndReload(data) {
const messages = {
'acepto': '✅ Incidencia aceptada correctamente. ¡Puedes empezar a trabajar!',
'rechazo': '❌ Incidencia rechazada. Se escalará automáticamente.',
'ayuda': '🆘 Ayuda solicitada. Un supervisor se pondrá en contacto contigo.'
};

const actionIcon = pendingAction === 'acepto' ? '✅' : pendingAction === 'rechazo' ? '❌' : '🆘';

document.getElementById('incidentsContainer').innerHTML = `
<div class="no-incidents">
<div class="no-incidents-icon">${actionIcon}</div>
<h3 class="no-incidents-title">Acción Completada</h3>
<p class="no-incidents-description">${messages[pendingAction]}</p>
<button onclick="refreshIncidents()" class="verify-btn" style="margin-top: 20px;">
🔄 Actualizar Dashboard
</button>
</div>`;

setTimeout(() => {
refreshIncidents();
}, 3000);
}

// === UTILIDADES ===
async function refreshIncidents() {
if (currentTechnician) {
await loadTechnicianDashboard(currentTechnician.email, accessMode === 'full_access');
}
}

function showLoading(message = 'Cargando...') {
document.getElementById('incidentsContainer').innerHTML = `
<div class="loading">
<div class="spinner"></div>
<div>${message}</div>
</div>`;
}

function hideLoading() {
// Se oculta cuando se renderiza contenido
}

function createNoIncidentsHTML(title, icon, description) {
return `
<div class="no-incidents">
<div class="no-incidents-icon">${icon}</div>
<h3 class="no-incidents-title">${title}</h3>
<p class="no-incidents-description">${description}</p>
</div>`;
}

function showError(message, element) {
if (element) {
element.textContent = message;
element.style.display = 'block';
} else {
console.error('Error:', message);
}
}

// === EVENTOS ===
document.addEventListener('keydown', function(e) {
if (e.key === 'Enter' && document.getElementById('loginContainer').style.display !== 'none') {
const emailInput = document.getElementById('emailInput');
if (emailInput.value.trim()) {
loginWithPIN();
}
}

if (e.key === 'Escape') {
closeReasonModal();
closePINModal();
}
});

// Cerrar modales al hacer click fuera
document.getElementById('reasonModal').addEventListener('click', function(e) {
if (e.target === this) {
closeReasonModal();
}
});

document.getElementById('pinModal').addEventListener('click', function(e) {
if (e.target === this) {
closePINModal();
}
});
</script>
</body>
</html>
