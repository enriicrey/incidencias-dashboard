<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard TÃ©cnico - Sistema de Incidencias ABC.xyz</title>
    <style>
        /* ========================================
           VARIABLES CSS Y RESET
        ======================================== */
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2c3e50;
            --success-color: #22c55e;
            --success-dark: #16a34a;
            --warning-color: #f59e0b;
            --warning-dark: #d97706;
            --danger-color: #ef4444;
            --danger-dark: #dc2626;
            --info-color: #3b82f6;
            --info-dark: #2563eb;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --border-radius: 12px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.15);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-800);
        }

        /* ========================================
           LOGIN COMPONENTS
        ======================================== */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow-lg);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: var(--gray-500);
            margin-bottom: 30px;
            font-size: 16px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 14px;
        }

        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--gray-200);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .verify-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .verify-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .verify-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .error-message {
            background: #fee;
            color: var(--danger-color);
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
        }

        /* ========================================
           HEADER
        ======================================== */
        .header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 20px 0;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .refresh-button {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .refresh-button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.25);
        }

        .refresh-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ========================================
           MAIN CONTAINER
        ======================================== */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
            background: #f8fafc;
            min-height: calc(100vh - 80px);
        }

        /* ========================================
           STATS BAR
        ======================================== */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-card.active {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, #e3f2fd, #ffffff);
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-number.pending { color: var(--warning-color); }
        .stat-number.working { color: var(--success-color); }
        .stat-number.expired { color: var(--danger-color); }
        .stat-number.seguimiento { color: var(--info-color); }

        .stat-label {
            color: var(--gray-500);
            font-size: 14px;
            font-weight: 500;
        }

        /* ========================================
           FILTERS BAR
        ======================================== */
        .filters-bar {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-label {
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 14px;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--gray-300);
            border-radius: 20px;
            background: white;
            color: var(--gray-500);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-btn.active,
        .filter-btn:hover {
            background: var(--info-color);
            border-color: var(--info-color);
            color: white;
        }

        /* ========================================
           INCIDENTS GRID
        ======================================== */
        .incidents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            width: 100%;
        }

        /* ========================================
           INCIDENT CARDS
        ======================================== */
        .incident-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            min-width: 450px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .incident-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-3px);
            border-color: var(--primary-color);
        }

         .incident-header {
            background: linear-gradient(135deg, var(--gray-50), #ffffff);
            border: 1px solid var(--gray-200);
            border-radius: 15px 15px 0 0;
            padding: 20px;
            position: relative;
        }
        
        .incident-title {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 8px; /* â REDUCIDO DE 15px A 8px */
        }
        .timer-container {
            margin-top: 8px;
            margin-bottom: 4px;
        }
        
        .sla-timer, .working-timer {
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 8px 0;
        }
        
       .working-timer {
            background: linear-gradient(135deg, #e0f2fe, #b3e5fc);
            color: #01579b;
            border: 1px solid #29b6f6;
            font-weight: 500; /* â Menos impacto que bold */
        }
        
        .sla-timer.sla-good, .sla-timer.sla-warning {
            font-weight: 500; /* â Consistente con working */
        }
        
        .sla-timer.sla-critical, .sla-expired {
            font-weight: 700; /* â Mantener bold solo para crÃ­tico/vencido */
        }
        
        .sla-timer.sla-good {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c8);
            color: #1b5e20;
            border: 1px solid #4caf50;
        }
        
        .sla-timer.sla-warning {
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
            color: #e65100;
            border: 1px solid #ff9800;
        }
        
        .sla-timer.sla-critical {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: #b71c1c;
            border: 1px solid #f44336;
            animation: pulse-sla 2s infinite;
        }
        
        .sla-expired {
            background: linear-gradient(135deg, #ffebee, #ef9a9a);
            color: #b71c1c;
            padding: 10px 14px;
            border-radius: 8px;
            font-weight: 700;
            border: 2px solid #f44336;
            animation: pulse-sla 1.5s infinite;
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 8px 0;
        }
        
        @keyframes pulse-sla {
            0%, 100% { transform: scale(1); box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3); }
            50% { transform: scale(1.02); box-shadow: 0 4px 12px rgba(244, 67, 54, 0.5); }
        }

        .badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .priority-badge {
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .incident-id {
            font-size: 13px;
            color: var(--gray-500);
            background: var(--gray-50);
            padding: 6px 10px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .incident-body {
            margin-bottom: 20px;
        }

        .zone {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray-700);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            background: var(--gray-100);
            padding: 8px 12px;
            border-radius: 8px;
        }

        .description {
            color: var(--gray-500);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 15px;
            background: #fafbfc;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid var(--gray-200);
        }

        /* ========================================
           INFO COMPONENTS
        ======================================== */
        .technician-info {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 12px 16px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 14px;
            border-left: 4px solid #0ea5e9;
        }

        .technician-info.current-tech {
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            border-left-color: var(--success-color);
            color: #065f46;
            font-weight: 600;
        }

       .contacts-info {
            margin: 15px 0;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .contacts-header {
            background: linear-gradient(135deg, var(--gray-100), #f8f9fa);
            padding: 12px 16px;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .contacts-header:hover {
            background: linear-gradient(135deg, var(--gray-200), #e9ecef);
            color: var(--gray-800);
        }
        
        .contacts-list {
            background: white;
            padding: 0;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .contact-item {
            padding: 10px 16px;
            border-bottom: 1px solid var(--gray-100);
            font-size: 14px;
            line-height: 1.4;
        }
        
        .contact-item:last-child {
            border-bottom: none;
        }
        
        .phone-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .phone-link:hover {
            background: var(--primary-color);
            color: white;
            text-decoration: none;
        }
        
        .toggle-icon {
            float: right;
            font-size: 12px;
            transition: transform 0.2s ease;
            display: inline-block;
        }
        .time-elapsed {
            background: linear-gradient(135deg, #fdf4ff, #fae8ff);
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 8px;
            color: #7c2d92;
            font-size: 14px;
            border-left: 4px solid #a855f7;
        }

        .actions-taken {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            color: #166534;
            font-size: 14px;
            line-height: 1.4;
            border-left: 4px solid var(--success-color);
        }

        /* ========================================
           ESCALATION HISTORY
        ======================================== */
        .escalation-history {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            margin: 15px 0;
            overflow: hidden;
        }

        .escalation-header {
            background: #e2e8f0;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #475569;
            transition: background 0.3s ease;
        }

        .escalation-header:hover {
            background: #cbd5e1;
        }

        .escalation-content {
            display: none;
            padding: 15px;
        }

        .escalation-level {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }

        .escalation-level.completed {
            background: #f0f9ff;
            border-left: 4px solid var(--success-color);
        }

        .escalation-level.current {
            background: #fff7ed;
            border-left: 4px solid var(--warning-color);
        }

        .escalation-level.pending {
            background: #f8fafc;
            border-left: 4px solid #94a3b8;
        }

        .escalation-level.expired {
            background: #fef2f2;
            border-left: 4px solid var(--danger-color);
        }

        .escalation-level.escalated {
            background: #f3f4f6;
            border-left: 4px solid var(--gray-500);
        }

        .level-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--gray-700);
        }

        .level-details {
            font-size: 14px;
            color: var(--gray-500);
            line-height: 1.4;
        }

        /* ========================================
           SLA TIMERS
        ======================================== */
        .sla-timer {
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sla-timer.sla-good {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border: 1px solid var(--success-color);
        }

        .sla-timer.sla-warning {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border: 1px solid var(--warning-color);
        }

        .sla-timer.sla-critical {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #991b1b;
            border: 1px solid var(--danger-color);
            animation: pulse 2s infinite;
        }

        .sla-expired {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            color: #991b1b;
            padding: 12px 16px;
            border-radius: 10px;
            font-weight: 700;
            border: 2px solid var(--danger-color);
            animation: pulse 2s infinite;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* ========================================
           ACTION BUTTONS
        ======================================== */
        .incident-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-100);
        }

        .incident-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .incident-actions .btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), var(--success-dark));
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(34, 197, 94, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), var(--danger-dark));
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), var(--warning-dark));
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(245, 158, 11, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color), var(--info-dark));
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(59, 130, 246, 0.3);
        }

        .no-action-info {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 8px;
            color: #64748b;
            font-style: italic;
            border: 1px solid var(--gray-200);
        }

        /* ========================================
           NO INCIDENTS MESSAGE
        ======================================== */
        .no-incidents {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-500);
        }

        .no-incidents-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .no-incidents h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--gray-700);
        }

        .no-incidents p {
            font-size: 16px;
            color: var(--gray-500);
        }

        /* ========================================
           MODALS
        ======================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content,
        .pin-modal {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.8);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal-content,
        .modal-overlay.active .pin-modal {
            transform: scale(1);
        }

        .modal-title,
        .pin-modal-title {
            font-size: 20px;
            color: var(--gray-800);
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
        }

        .reason-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }

        .reason-option {
            padding: 15px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .reason-option:hover {
            border-color: var(--gray-700);
            background: var(--gray-50);
        }

        .reason-option.selected {
            border-color: var(--info-color);
            background: #eff6ff;
        }

        .reason-icon {
            font-size: 24px;
            min-width: 30px;
        }

        .reason-text {
            flex: 1;
        }

        .reason-title {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 3px;
        }

        .reason-description {
            font-size: 13px;
            color: var(--gray-500);
        }

        .custom-reason-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            margin-top: 10px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .custom-reason-input:focus {
            outline: none;
            border-color: var(--info-color);
        }

        .modal-actions,
        .pin-actions {
            display: flex;
            gap: 15px;
        }

        .modal-btn,
        .pin-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-cancel,
        .pin-btn-cancel {
            background: var(--gray-50);
            color: var(--gray-500);
            border: 1px solid var(--gray-300);
        }

        .btn-confirm,
        .pin-btn-verify {
            background: var(--gray-700);
            color: white;
        }

        .btn-confirm:disabled,
        .pin-btn-verify:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }

        .pin-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            font-size: 18px;
            text-align: center;
            letter-spacing: 8px;
            margin-bottom: 20px;
        }

        .pin-input:focus {
            outline: none;
            border-color: var(--info-color);
        }

        /* ========================================
           SUCCESS OVERLAY
        ======================================== */
        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .success-message {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .success-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .success-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 10px;
        }

        .success-description {
            color: var(--gray-500);
            margin-bottom: 20px;
        }

        .countdown {
            font-size: 14px;
            color: var(--gray-400);
        }

        /* ========================================
           BADGES
        ======================================== */
        .badge {
            padding: 4px 8px;
            border-radius: var(--border-radius);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }

        .bg-success { background: var(--success-color); color: white; }
        .bg-warning { background: var(--warning-color); color: white; }
        .bg-danger { background: var(--danger-color); color: white; }
        .bg-info { background: var(--info-color); color: white; }
        .bg-secondary { background: var(--gray-500); color: white; }
        .bg-light { background: var(--gray-100); color: var(--gray-700); }

        .toggle-icon {
            font-size: 14px;
            transition: transform 0.3s ease;
        }

        .escalation-header:hover .toggle-icon,
        .contacts-header:hover .toggle-icon {
            transform: scale(1.2);
        }

        .sla-badge {
            padding: 4px 8px;
            border-radius: var(--border-radius);
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }

        .sla-badge.sla-good {
            background: var(--success-color);
            color: white;
        }

        .sla-badge.sla-warning {
            background: var(--warning-color);
            color: white;
        }

        .sla-badge.sla-critical {
            background: var(--danger-color);
            color: white;
            animation: pulse 1s infinite;
        }

        /* ========================================
           RESPONSIVE DESIGN
        ======================================== */
        @media (max-width: 1200px) {
            .incidents-grid {
                grid-template-columns: 1fr;
            }

            .incident-card {
                min-width: auto;
                max-width: none;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 15px;
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .filters-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .incidents-grid {
                gap: 20px;
            }

            .incident-card {
                padding: 20px;
            }

            .incident-actions {
                flex-direction: column;
            }

            .incident-actions .btn {
                min-width: auto;
            }
        }

        /* ========================================
           UTILITY CLASSES
        ======================================== */
        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .text-center {
            text-align: center;
        }

        .mt-4 { margin-top: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .p-4 { padding: 1rem; }

                    /* ========================================
               MODALES DE MATERIALES
            ======================================== */
            
            .large-modal {
                width: 90%;
                max-width: 800px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .form-group {
                margin-bottom: 20px;
            }
            
            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: var(--text-primary);
            }
            
            .form-control {
                width: 100%;
                padding: 10px 12px;
                border: 2px solid var(--border-color);
                border-radius: 8px;
                font-size: 14px;
                transition: border-color 0.3s ease;
                box-sizing: border-box;
            }
            
            .form-control:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }
            
            /* ========================================
               SECCIÃN MATERIALES
            ======================================== */
            
            .materials-section {
                background: var(--bg-secondary);
                border-radius: 12px;
                padding: 20px;
                border: 2px solid var(--border-light);
            }
            
            .add-material-form {
                margin-bottom: 20px;
            }
            
            .material-inputs {
                display: grid;
                grid-template-columns: 2fr 1fr 2fr auto;
                gap: 12px;
                align-items: end;
                margin-bottom: 12px;
            }
            
            @media (max-width: 768px) {
                .material-inputs {
                    grid-template-columns: 1fr;
                    gap: 8px;
                }
            }
            
            .selected-materials {
                max-height: 200px;
                overflow-y: auto;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 12px;
            }
            
            .material-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px;
                background: white;
                border: 1px solid var(--border-light);
                border-radius: 8px;
                margin-bottom: 8px;
            }
            
            .material-item:last-child {
                margin-bottom: 0;
            }
            
            .material-info {
                flex: 1;
            }
            
            .material-info strong {
                display: block;
                color: var(--text-primary);
                font-size: 14px;
            }
            
            .material-details {
                display: block;
                color: var(--text-secondary);
                font-size: 12px;
                margin-top: 4px;
            }
            
            .btn-remove-material {
                background: var(--danger-color);
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 6px;
                font-size: 12px;
                cursor: pointer;
                transition: background-color 0.3s ease;
            }
            
            .btn-remove-material:hover {
                background: #dc2626;
            }
            
            .no-materials {
                text-align: center;
                color: var(--text-secondary);
                font-style: italic;
                margin: 0;
                padding: 20px;
            }
            
            /* ========================================
               SOLICITUD DE MATERIALES
            ======================================== */
            
            .request-material-form {
                background: var(--bg-secondary);
                border-radius: 12px;
                padding: 20px;
                border: 2px solid var(--border-light);
            }
            
            .material-request-inputs {
                display: grid;
                grid-template-columns: 2fr 1fr 1fr;
                gap: 12px;
                margin-bottom: 12px;
            }
            
            @media (max-width: 768px) {
                .material-request-inputs {
                    grid-template-columns: 1fr;
                }
            }
            
            .requested-materials-list {
                max-height: 300px;
                overflow-y: auto;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 12px;
            }
            
            .material-request-item {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                padding: 16px;
                background: white;
                border: 1px solid var(--border-light);
                border-radius: 8px;
                margin-bottom: 12px;
            }
            
            .material-request-item:last-child {
                margin-bottom: 0;
            }
            
            .request-info {
                flex: 1;
            }
            
            .request-info strong {
                display: block;
                color: var(--text-primary);
                font-size: 15px;
                margin-bottom: 6px;
            }
            
            .request-details {
                display: flex;
                gap: 16px;
                margin-bottom: 8px;
            }
            
            .quantity {
                color: var(--text-secondary);
                font-size: 13px;
            }
            
            .urgency {
                font-size: 12px;
                font-weight: 600;
                padding: 2px 8px;
                border-radius: 12px;
            }
            
            .urgency-baja { background: #dcfce7; color: #166534; }
            .urgency-media { background: #fef3c7; color: #92400e; }
            .urgency-alta { background: #fed7aa; color: #c2410c; }
            .urgency-critica { background: #fecaca; color: #dc2626; }
            
            .justification {
                color: var(--text-secondary);
                font-size: 13px;
                line-height: 1.4;
                font-style: italic;
            }
            
            /* ========================================
               CHECKBOX PERSONALIZADO
            ======================================== */
            
            .checkbox-group {
                margin: 16px 0;
            }
            
            .checkbox-label {
                display: flex;
                align-items: center;
                cursor: pointer;
                font-size: 14px;
                color: var(--text-primary);
            }
            
            .checkbox-label input[type="checkbox"] {
                display: none;
            }
            
            .checkmark {
                width: 20px;
                height: 20px;
                border: 2px solid var(--border-color);
                border-radius: 4px;
                margin-right: 10px;
                position: relative;
                transition: all 0.3s ease;
            }
            
            .checkbox-label input[type="checkbox"]:checked + .checkmark {
                background: var(--primary-color);
                border-color: var(--primary-color);
            }
            
            .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
                content: 'â';
                position: absolute;
                color: white;
                font-size: 14px;
                font-weight: bold;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }
            
            /* ========================================
               SCROLL PERSONALIZADO
            ======================================== */
            
            .selected-materials::-webkit-scrollbar,
            .requested-materials-list::-webkit-scrollbar {
                width: 6px;
            }
            
            .selected-materials::-webkit-scrollbar-track,
            .requested-materials-list::-webkit-scrollbar-track {
                background: var(--bg-secondary);
            }
            
            .selected-materials::-webkit-scrollbar-thumb,
            .requested-materials-list::-webkit-scrollbar-thumb {
                background: var(--border-color);
                border-radius: 3px;
            }
            
            .selected-materials::-webkit-scrollbar-thumb:hover,
            .requested-materials-list::-webkit-scrollbar-thumb:hover {
                background: var(--text-secondary);
            }
            .current-escalation-info {
            background: linear-gradient(135deg, #fff3cd, #fef7e3);
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin: 15px 0;
        }
        
        .escalation-badge {
            font-weight: 700;
            color: #856404;
            font-size: 13px;
            margin-bottom: 8px;
        }
        
        .escalation-details {
            font-size: 14px;
            color: #6c757d;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <!-- LOGIN CONTAINER -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <h1 class="login-title">
                <span>ð§</span>
                <span>Dashboard TÃ©cnico</span>
            </h1>
            <p class="login-subtitle">Sistema de Incidencias ABC.xyz</p>

            <div class="input-group">
                <label class="input-label" for="emailInput">Email corporativo</label>
                <input 
                    type="email" 
                    id="emailInput" 
                    class="input-field" 
                    placeholder="tecnico@abc.xyz"
                    autocomplete="email"
                >
            </div>

            <button class="verify-btn" id="loginBtn" onclick="loginWithPIN()">
                Acceder con PIN
            </button>

            <div id="loginError" class="error-message hidden">
                Error de autenticaciÃ³n. Verifica tus credenciales.
            </div>
        </div>
    </div>

    <!-- DASHBOARD PRINCIPAL -->
    <div id="dashboardContainer" class="hidden">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">ð§ Dashboard TÃ©cnico - Sistema ABC.xyz</div>
                <div class="user-info">
                <div class="user-name" id="technicianName">Cargando tÃ©cnico...</div>
                    <span id="userEmail">usuario@abc.xyz</span>
                    <span>|</span>
                    <span id="userRole">TÃ©cnico L0</span>
                    <button class="refresh-button" id="refreshBtn" onclick="refreshDashboard()">
                        ð Actualizar
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Container -->
        <main class="main-container">
            <!-- Stats Bar -->
            <section class="stats-bar">
                <div class="stat-card active" onclick="filterByStatus('all', this)">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card" onclick="filterByStatus('pending', this)">
                    <div class="stat-number pending" id="pendingCount">0</div>
                    <div class="stat-label">Pendientes</div>
                </div>
                <div class="stat-card" onclick="filterByStatus('working', this)">
                    <div class="stat-number working" id="workingCount">0</div>
                    <div class="stat-label">Trabajando</div>
                </div>
                <div class="stat-card" onclick="filterByStatus('expired', this)">
                    <div class="stat-number expired" id="expiredCount">0</div>
                    <div class="stat-label">Vencidas</div>
                </div>
                <div class="stat-card" onclick="filterByStatus('seguimiento', this)">
                    <div class="stat-number seguimiento" id="seguimientoCount">0</div>
                    <div class="stat-label">Seguimiento</div>
                </div>
            </section>

            <!-- Filters Bar -->
            <section class="filters-bar">
                <div class="filter-group">
                    <span class="filter-label">Prioridad:</span>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterByPriority('all', this)">Todas</button>
                        <button class="filter-btn" onclick="filterByPriority('CRÃTICA', this)">CrÃ­tica</button>
                        <button class="filter-btn" onclick="filterByPriority('ALTA', this)">Alta</button>
                        <button class="filter-btn" onclick="filterByPriority('MEDIA', this)">Media</button>
                        <button class="filter-btn" onclick="filterByPriority('BAJA', this)">Baja</button>
                    </div>
                </div>
            </section>

            <!-- Incidents Container -->
            <section id="incidentsContainer">
                <div class="no-incidents">
                    <div class="no-incidents-icon">ð</div>
                    <h3>Cargando incidencias...</h3>
                    <p>Por favor, espera mientras se cargan tus incidencias.</p>
                </div>
            </section>
        </main>
    </div>

    <!-- MODAL PARA MOTIVOS -->
    <div class="modal-overlay" id="reasonModal">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">Selecciona un motivo</h3>
            <div class="reason-options" id="reasonOptions">
                <!-- Opciones generadas dinÃ¡micamente -->
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeReasonModal()">Cancelar</button>
                <button class="modal-btn btn-confirm" id="confirmBtn" onclick="confirmAction()" disabled>Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PIN -->
    <div class="modal-overlay" id="pinModal">
        <div class="pin-modal">
            <h3 class="pin-modal-title">VerificaciÃ³n de Identidad</h3>
            <p style="text-align: center; color: var(--gray-500); margin-bottom: 20px;">
                Ingresa tu PIN de 4 dÃ­gitos para continuar
            </p>
            <input type="password" class="pin-input" id="pinInput" maxlength="4" placeholder="â¢â¢â¢â¢">
            <div class="pin-actions">
                <button class="pin-btn pin-btn-cancel" onclick="closePINModal()">Cancelar</button>
                <button class="pin-btn pin-btn-verify" id="verifyPinBtn" onclick="verifyPIN()" disabled>Verificar</button>
            </div>
            <div id="pinError" class="error-message hidden">PIN incorrecto. Intenta de nuevo.</div>
        </div>
    </div>

    
            <!-- MODAL RESOLVER INCIDENCIA (Extendido con materiales) -->
            <div class="modal-overlay" id="resolverModal">
                <div class="modal-content large-modal">
                    <h3 class="modal-title">ð§ Resolver Incidencia</h3>
                    
                    <!-- DescripciÃ³n de la soluciÃ³n -->
                    <div class="form-group">
                        <label for="solutionDescription">DescripciÃ³n de la soluciÃ³n *</label>
                        <textarea id="solutionDescription" class="form-control" rows="4" 
                            placeholder="Describe detalladamente cÃ³mo se resolviÃ³ la incidencia..." required></textarea>
                    </div>
                    
                    <!-- Tiempo invertido -->
                    <div class="form-group">
                        <label for="timeInvested">Tiempo invertido *</label>
                        <input type="text" id="timeInvested" class="form-control" 
                            placeholder="ej: 2h 30min" required>
                    </div>
                    
                    <!-- Materiales utilizados -->
                    <div class="form-group">
                        <label>Materiales utilizados (opcional)</label>
                        <div class="materials-section">
                            <div class="add-material-form">
                                <div class="material-inputs">
                                    <select id="materialSelect" class="form-control">
                                        <option value="">Seleccionar material...</option>
                                    </select>
                                    <input type="number" id="materialQuantity" class="form-control" 
                                        placeholder="Cantidad" min="0.1" step="0.1">
                                    <select id="materialReason" class="form-control">
                                        <option value="">Motivo...</option>
                                        <option value="reparacion_correctiva">ReparaciÃ³n correctiva</option>
                                        <option value="reparacion_preventiva">ReparaciÃ³n preventiva</option>
                                        <option value="sustitucion_componente">SustituciÃ³n de componente</option>
                                        <option value="mejora_sistema">Mejora del sistema</option>
                                    </select>
                                    <button type="button" class="btn btn-secondary" onclick="addMaterial()">
                                        â Agregar
                                    </button>
                                </div>
                            </div>
                            
                            <div id="selectedMaterials" class="selected-materials">
                                <p class="no-materials">No hay materiales seleccionados</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Acciones preventivas -->
                    <div class="form-group">
                        <label for="preventiveActions">Acciones preventivas recomendadas</label>
                        <textarea id="preventiveActions" class="form-control" rows="3" 
                            placeholder="Recomendaciones para evitar que se repita la incidencia..."></textarea>
                    </div>
                    
                    <div class="modal-actions">
                        <button class="modal-btn btn-cancel" onclick="closeResolverModal()">Cancelar</button>
                        <button class="modal-btn btn-confirm" onclick="confirmMateriales()">ð§ Resolver Incidencia</button>
                    </div>
                </div>
            </div>
            
            <!-- MODAL SOLICITAR MATERIALES -->
            <div class="modal-overlay" id="solicitudMaterialesModal">
                <div class="modal-content large-modal">
                    <h3 class="modal-title">ð¦ Solicitar Materiales</h3>
                    
                    <!-- Agregar material a solicitud -->
                    <div class="form-group">
                        <label>Agregar material a la solicitud</label>
                        <div class="request-material-form">
                            <div class="material-request-inputs">
                                <input type="text" id="requestMaterialName" class="form-control" 
                                    placeholder="Nombre del material o componente">
                                <input type="text" id="requestQuantity" class="form-control" 
                                    placeholder="Cantidad (ej: 2 unidades, 5L)">
                                <select id="requestUrgency" class="form-control">
                                    <option value="">Urgencia...</option>
                                    <option value="baja">ð¢ Baja - No crÃ­tico</option>
                                    <option value="media">ð¡ Media - Planificable</option>
                                    <option value="alta">ð  Alta - Prioritario</option>
                                    <option value="critica">ð´ CrÃ­tica - Inmediato</option>
                                </select>
                            </div>
                            <textarea id="requestJustification" class="form-control" rows="2" 
                                placeholder="JustificaciÃ³n: Â¿por quÃ© necesitas este material?"></textarea>
                            <button type="button" class="btn btn-primary" onclick="addMaterialRequest()">
                                â Agregar a Solicitud
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista de materiales solicitados -->
                    <div class="form-group">
                        <label>Materiales en la solicitud</label>
                        <div id="requestedMaterialsList" class="requested-materials-list">
                            <p class="no-materials">No hay materiales en la solicitud</p>
                        </div>
                    </div>
                    
                    <!-- InformaciÃ³n adicional -->
                    <div class="form-group">
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="workCanContinue" checked>
                                <span class="checkmark"></span>
                                Puedo continuar trabajando mientras llegan los materiales
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="impactDescription">Impacto si se retrasa la entrega</label>
                        <textarea id="impactDescription" class="form-control" rows="2" 
                            placeholder="Describe el impacto en la producciÃ³n o seguridad si no llegan los materiales..."></textarea>
                    </div>
                    
                    <div class="modal-actions">
                        <button class="modal-btn btn-cancel" onclick="closeSolicitarMaterialesModal()">Cancelar</button>
                        <button class="modal-btn btn-confirm" id="sendMaterialRequestBtn" 
                            onclick="confirmSolicitudMateriales()" disabled>ð¦ Enviar Solicitud</button>
                    </div>
                </div>
            </div>
    
    <!-- MODAL DERIVAR DEPARTAMENTO -->
    <div id="derivarModal" class="modal-overlay">
        <div class="modal-content">
            <h2>ð Derivar Departamento</h2>
            <select id="targetDepartment">
                <option value="ElÃ©ctrico">ElÃ©ctrico</option>
                <option value="MecÃ¡nico">MecÃ¡nico</option>
                <option value="ProducciÃ³n">ProducciÃ³n</option>
                <option value="IT">IT</option>
            </select>
            <textarea id="derivationReason" placeholder="Â¿Por quÃ© necesita derivarse?"></textarea>
            <textarea id="technicalNotes" placeholder="Notas tÃ©cnicas para el nuevo departamento"></textarea>
            <div class="modal-actions">
                <button onclick="closeModal()">Cancelar</button>
                <button onclick="confirmDerivar()">ð Derivar</button>
            </div>
        </div>
    </div>

    <!-- SUCCESS OVERLAY -->
    <div class="success-overlay" id="successOverlay" style="display: none;">
        <div class="success-message">
            <div class="success-icon" id="successIcon">â</div>
            <div class="success-title" id="successTitle">AcciÃ³n Completada</div>
            <div class="success-description" id="successDescription">La operaciÃ³n se ha realizado correctamente.</div>
            <div class="countdown" id="countdown">Actualizando en 3 segundos...</div>
        </div>
    </div>

    <script>
        /* ========================================
           CONFIGURACIÃN GLOBAL Y CONSTANTES
        ======================================== */
        const CONFIG = {
            API_INCIDENTS: '/api/webhook-respuesta',
            API_RESPONSE: '/api/webhook-respuesta',
            REFRESH_INTERVAL: 300000,
            SLA_UPDATE_INTERVAL: 30000,
            MAX_RETRY_ATTEMPTS: 2,
            RETRY_DELAY: 1000
        };

        // Variables globales
        let allIncidents = [];
        let currentTechnician = null;
        let currentStatusFilter = 'all';
        let currentPriorityFilter = 'all';
        let refreshInterval = null;
        let slaTimerInterval = null;
        let pendingAction = null;
        let currentIncident = null;
        let selectedReason = null;
        let customText = '';
        let accessMode = 'full';

        /* ========================================
           CONFIGURACIÃN DE MOTIVOS
        ======================================== */
        const rejectReasons = [
            {
                id: 'no_tengo_herramientas',
                icon: 'ð§',
                title: 'No tengo las herramientas necesarias',
                description: 'Requiere herramientas especÃ­ficas que no estÃ¡n disponibles'
            },
            {
                id: 'no_tengo_conocimiento',
                icon: 'ð',
                title: 'No tengo el conocimiento tÃ©cnico',
                description: 'La incidencia requiere conocimientos especializados'
            },
            {
                id: 'fuera_de_horario',
                icon: 'ð',
                title: 'EstÃ¡ fuera de mi horario laboral',
                description: 'La incidencia se asignÃ³ fuera del horario de trabajo'
            },
            {
                id: 'sobrecarga_trabajo',
                icon: 'ð',
                title: 'Tengo sobrecarga de trabajo',
                description: 'Actualmente trabajando en mÃºltiples incidencias crÃ­ticas'
            },
            {
                id: 'ubicacion_lejana',
                icon: 'ð',
                title: 'UbicaciÃ³n muy lejana',
                description: 'La ubicaciÃ³n estÃ¡ fuera de mi zona de cobertura'
            },
            {
                id: 'otro_motivo_rechazo',
                icon: 'ð¬',
                title: 'Otro motivo',
                description: 'Especifica el motivo del rechazo',
                requiresText: true
            }
        ];

        const helpReasonsInitial = [
            {
                id: 'dudas_diagnostico',
                icon: 'ð',
                title: 'Tengo dudas sobre el diagnÃ³stico',
                description: 'Necesito orientaciÃ³n para identificar la causa'
            },
            {
                id: 'procedimiento_complejo',
                icon: 'âï¸',
                title: 'El procedimiento es muy complejo',
                description: 'Requiero supervisiÃ³n para realizar la reparaciÃ³n'
            },
            {
                id: 'componente_desconocido',
                icon: 'â',
                title: 'No conozco este componente',
                description: 'Es la primera vez que trabajo con este equipo'
            },
            {
                id: 'riesgo_seguridad',
                icon: 'â ï¸',
                title: 'Hay riesgos de seguridad',
                description: 'La intervenciÃ³n presenta riesgos que requieren supervisiÃ³n'
            },
            {
                id: 'otra_ayuda_inicial',
                icon: 'ð¬',
                title: 'Otro tipo de ayuda',
                description: 'Especifica quÃ© tipo de ayuda necesitas',
                requiresText: true
            }
        ];

        const transferReasons = [
            {
                id: 'especialista_requerido',
                icon: 'ð¨âð¬',
                title: 'Se requiere un especialista',
                description: 'La incidencia necesita conocimientos especÃ­ficos'
            },
            {
                id: 'equipo_especializado',
                icon: 'ð§',
                title: 'Se necesita equipo especializado',
                description: 'Requiere herramientas que no estÃ¡n disponibles'
            },
            {
                id: 'fuera_de_competencia',
                icon: 'ð«',
                title: 'Fuera de mi Ã¡rea de competencia',
                description: 'No tengo las habilidades necesarias'
            },
            {
                id: 'escalacion_necesaria',
                icon: 'ð',
                title: 'Requiere escalaciÃ³n inmediata',
                description: 'La criticidad requiere atenciÃ³n de nivel superior'
            },
            {
                id: 'otro_motivo_transferir',
                icon: 'ð¬',
                title: 'Otro motivo',
                description: 'Especifica el motivo de la transferencia',
                requiresText: true
            }
        ];

        const supportReasonsWorking = [
            {
                id: 'repuesto_no_disponible',
                icon: 'ð¦',
                title: 'Repuesto no disponible',
                description: 'Se necesita autorizar/conseguir un repuesto especÃ­fico'
            },
            {
                id: 'segunda_opinion',
                icon: 'ð¥',
                title: 'Necesito una segunda opiniÃ³n',
                description: 'Quiero confirmar el diagnÃ³stico con un supervisor'
            },
            {
                id: 'acceso_restringido',
                icon: 'ð',
                title: 'Ãrea de acceso restringido',
                description: 'Necesito autorizaciÃ³n para acceder a la zona'
            },
            {
                id: 'tiempo_insuficiente',
                icon: 'â°',
                title: 'Tiempo insuficiente para completar',
                description: 'La reparaciÃ³n tomarÃ¡ mÃ¡s tiempo del estimado'
            },
            {
                id: 'otro_apoyo_trabajo',
                icon: 'ð¬',
                title: 'Otro tipo de apoyo',
                description: 'Especifica quÃ© apoyo necesitas',
                requiresText: true
            }
        ];

        /* ========================================
           SISTEMA DE AUTENTICACIÃN
        ======================================== */
        async function loginWithPIN() {
            const email = document.getElementById('emailInput').value.trim();
            
            if (!email) {
                showLoginError('Por favor, ingresa tu email corporativo');
                return;
            }

            if (!isValidEmail(email)) {
                showLoginError('Email no vÃ¡lido');
                return;
            }

            currentTechnician = { email: email, name: email.split('@')[0], authenticated: false };
            showPINModal();
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function showLoginError(message) {
            const errorElement = document.getElementById('loginError');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            setTimeout(() => {
                errorElement.classList.add('hidden');
            }, 5000);
        }

        function showPINModal() {
            const modal = document.getElementById('pinModal');
            const pinInput = document.getElementById('pinInput');
            const verifyBtn = document.getElementById('verifyPinBtn');
            const pinError = document.getElementById('pinError');

            pinInput.value = '';
            verifyBtn.disabled = true;
            pinError.classList.add('hidden');

            modal.classList.add('active');
            setTimeout(() => pinInput.focus(), 100);

            pinInput.oninput = function() {
                verifyBtn.disabled = this.value.length !== 4;
            };

            pinInput.onkeypress = function(e) {
                if (e.key === 'Enter' && this.value.length === 4) {
                    verifyPIN();
                }
                if (!/[0-9]/.test(e.key) && e.key !== 'Backspace') {
                    e.preventDefault();
                }
            };
        }

        function closePINModal() {
            document.getElementById('pinModal').classList.remove('active');
        }

        async function verifyPIN() {
            const pin = document.getElementById('pinInput').value;
            const pinError = document.getElementById('pinError');

            if (pin.length !== 4) {
                showPINError('PIN debe tener 4 dÃ­gitos');
                return;
            }
            if (!currentTechnician) {
                    showPINError('Error de sesiÃ³n. Intenta nuevamente.');
                    return;
                }

            try {
                const isValid = await validatePIN(currentTechnician.email, pin);
                
                if (isValid) {
                    currentTechnician.authenticated = true;
                    document.getElementById('pinModal').classList.remove('active');
                    showDashboard();
                    await loadDashboard();
                } else {
                    showPINError('PIN incorrecto');
                    document.getElementById('pinInput').value = '';
                    document.getElementById('verifyPinBtn').disabled = true;
                }
            } catch (error) {
                console.error('Error validando PIN:', error);
                showPINError('Error de conexiÃ³n');
            }
        }

        async function validatePIN(email, pin) {
                try {
                    const response = await fetch('/api/webhook-respuesta', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'validate_pin',
                            technician_email: email,
                            pin: pin
                        })
                    });
                    
                    const data = await response.json();
                    return data.status === 'success';
                } catch (error) {
                    console.error('Error validating PIN:', error);
                    return false;
                }
            }

        function showPINError(message) {
            const pinError = document.getElementById('pinError');
            pinError.textContent = message;
            pinError.classList.remove('hidden');
            setTimeout(() => {
                pinError.classList.add('hidden');
            }, 3000);
        }

        function showDashboard() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('dashboardContainer').classList.remove('hidden');
            document.getElementById('userEmail').textContent = currentTechnician.email;
        }

        /* ========================================
           CARGA Y GESTIÃN DE DATOS
        ======================================== */
        async function loadDashboard() {
            if (!currentTechnician?.authenticated) {
                console.error('Usuario no autenticado');
                return;
            }
        
            showLoadingState();
        
            try {
                const response = await fetchWithRetry(
                    `/api/webhook-respuesta?action=get_assigned_incidents&technician_email=${encodeURIComponent(currentTechnician.email)}`
                );
                
                const data = await response.json();
                
                if (data && data.incidents && Array.isArray(data.incidents)) {
                    allIncidents = data.incidents;
                    console.log(`ð Cargadas ${allIncidents.length} incidencias`);
                    
                    // â AÃADIR AQUÃ: Actualizar header con datos existentes
                    updateHeaderInfo();
                    
                    updateStatistics();
                    renderIncidents();
                    startSLATimers();
                } else {
                    throw new Error('Datos invÃ¡lidos recibidos del servidor');
                }
            } catch (error) {
                console.error('Error cargando dashboard:', error);
                showErrorState(error.message);
            }
        }
        
        // â AÃADIR ESTA FUNCIÃN NUEVA:
            function updateHeaderInfo() {
                if (currentTechnician && currentTechnician.email) {
                    // Obtener nombre del tÃ©cnico (de URL params o login)
                    const urlParams = new URLSearchParams(window.location.search);
                    const nameFromUrl = urlParams.get('nombre'); // Del correo
                    const nameFromLogin = currentTechnician.name; // Del login
                    
                    const displayName = nameFromUrl || nameFromLogin || currentTechnician.email.split('@')[0];
                    
                    document.getElementById('userEmail').textContent = displayName;
                    document.getElementById('userRole').textContent = currentTechnician.email;
                }
            }

        async function fetchWithRetry(url, options = {}, attempt = 1) {
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return response;
            } catch (error) {
                if (attempt < CONFIG.MAX_RETRY_ATTEMPTS) {
                    console.warn(`Intento ${attempt} fallÃ³, reintentando en ${CONFIG.RETRY_DELAY * attempt}ms...`);
                    await delay(CONFIG.RETRY_DELAY * attempt);
                    return fetchWithRetry(url, options, attempt + 1);
                }
                throw error;
            }
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function showLoadingState() {
            const container = document.getElementById('incidentsContainer');
            container.innerHTML = `
                <div class="no-incidents">
                    <div class="no-incidents-icon">â³</div>
                    <h3>Cargando incidencias...</h3>
                    <p>Obteniendo los datos mÃ¡s recientes del servidor...</p>
                </div>
            `;
        }

        function showErrorState(errorMessage = 'Error desconocido') {
            const container = document.getElementById('incidentsContainer');
            container.innerHTML = `
                <div class="no-incidents">
                    <div class="no-incidents-icon">â</div>
                    <h3>Error al cargar datos</h3>
                    <p>No se pudieron cargar las incidencias: ${errorMessage}</p>
                    <button class="btn btn-info mt-4" onclick="loadDashboard()" style="padding: 10px 20px; border-radius: 8px;">
                        ð Reintentar
                    </button>
                </div>
            `;
        }

        /* ========================================
           GESTIÃN DE ESTADÃSTICAS
        ======================================== */
        function updateStatistics() {
            const stats = calculateStatistics();
            
            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('pendingCount').textContent = stats.pending;
            document.getElementById('workingCount').textContent = stats.working;
            document.getElementById('expiredCount').textContent = stats.expired;
            document.getElementById('seguimientoCount').textContent = stats.seguimiento;
        }

        function calculateStatistics() {
            const technicianEmail = currentTechnician?.email || '';
            
            const relevantIncidents = allIncidents.filter(incident => {
                const state = getIncidentRealState(incident, technicianEmail);
                return ['pending', 'working', 'expired', 'seguimiento'].includes(state);
            });

            return {
                total: relevantIncidents.length,
                pending: relevantIncidents.filter(i => getIncidentRealState(i, technicianEmail) === 'pending').length,
                working: relevantIncidents.filter(i => getIncidentRealState(i, technicianEmail) === 'working').length,
                expired: relevantIncidents.filter(i => getIncidentRealState(i, technicianEmail) === 'expired').length,
                seguimiento: relevantIncidents.filter(i => getIncidentRealState(i, technicianEmail) === 'seguimiento').length
            };
        }
         function getIncidentRealState(incident, technicianEmail) {
            const now = new Date();
            
            // ð DETERMINAR TODAS LAS ASIGNACIONES DEL TÃCNICO
            let assignments = [];
            let wasAssignedBefore = false;
            
            // Verificar L0
            if (incident.l0_technician === technicianEmail) {
                if (incident.escalation_level === 0) {
                    assignments.push({
                        level: 0,
                        response: incident.l0_response,
                        sla_end: incident.sla_l0_end,
                        isCurrent: true
                    });
                } else {
                    wasAssignedBefore = true;
                }
            }
            
            // Verificar L1  
            if (incident.l1_technician === technicianEmail) {
                if (incident.escalation_level === 1) {
                    assignments.push({
                        level: 1,
                        response: incident.l1_response,
                        sla_end: incident.sla_l1_backup_end,
                        isCurrent: true
                    });
                } else if (incident.escalation_level > 1) {
                    wasAssignedBefore = true;
                }
            }
            
            // â MEJORA: Verificar L2 - permitir asignaciÃ³n mÃºltiple
         if (incident.l2_technicians && incident.l2_technicians.split(',').map(email => email.trim()).includes(technicianEmail)) {
            if (incident.escalation_level === 2) {
                assignments.push({  // â Usa el array assignments
                    level: 2,
                    response: incident.l2_responses,
                    sla_end: incident.sla_l2_equipo_end,
                    isCurrent: true
                });
            } else if (incident.escalation_level > 2) {
                wasAssignedBefore = true;
            }
        }
            
            // ð« Si no tiene relaciÃ³n, no la ve
            if (assignments.length === 0 && !wasAssignedBefore) {
                return null;
            }
            
            // â PRIORIDAD: Evaluar asignaciÃ³n actual (el nivel activo de escalado)
            const currentAssignment = assignments.find(a => a.isCurrent);
            
            if (currentAssignment) {
                // 1. TRABAJANDO - AceptÃ³ en su nivel actual
                if (currentAssignment.response === "â Acepto") {
                    return 'working';
                }
                
                // 2. PENDIENTE - Asignado actualmente, sin responder, SLA vÃ¡lido
                if (currentAssignment.response === "â­ Sin Respuesta" && 
                    currentAssignment.sla_end) {
                    
                    const slaDeadline = new Date(currentAssignment.sla_end);
                    if (now <= slaDeadline) {
                        return 'pending';
                    }
                    
                    // 3. VENCIDA - Su SLA expirÃ³ sin responder EN EL NIVEL ACTUAL
                    if (now > slaDeadline) {
                        return 'expired';
                    }
                }
                
                // Si rechazÃ³ en el nivel actual
                if (currentAssignment.response === "â Rechazo") {
                    return 'seguimiento';
                }
            }
            
            // 4. SEGUIMIENTO - Fue asignado antes en otros niveles
            if (wasAssignedBefore) {
                return 'seguimiento';
            }
            
            return 'other';
        }

        // ð FUNCIÃN PARA RENDERIZAR DESPUÃS DE REFRESH
        function handleActionResponse(actionType, incidentId, response) {
            if (response.status === 'success') {
                // Mostrar notificaciÃ³n
                showNotification(`â ${actionType} procesado correctamente`, 'success');
                
                // Nota al usuario sobre refresh
                showNotification(`ð Haz refresh para ver los cambios actualizados`, 'info', 8000);
                
                // Opcional: Auto-refresh despuÃ©s de 3 segundos
                setTimeout(() => {
                    console.log('ð Auto-refresh despuÃ©s de acciÃ³n exitosa');
                    refreshDashboard();
                }, 3000);
            } else {
                showNotification(`â Error: ${response.message}`, 'error');
            }
        }
        
        // ð¯ ACCIONES PENDIENTES POR IMPLEMENTAR:
        
        const PENDING_ACTIONS = {
            // YA IMPLEMENTADAS:
            'acepto': 'â Implementada',
            'rechazo': 'â Implementada',
            
            // PENDIENTES:
            'resolver': 'ð§ Pendiente - Completar incidencia con soluciÃ³n',
            'solicitar_materiales': 'ð§ Pendiente - Pedir materiales al almacÃ©n', 
            'derivar_departamento': 'ð§ Pendiente - Transferir a otro departamento',
            'solicitar_traspaso': 'ð§ Pendiente - Pedir asignaciÃ³n de incidencia ajena',
            'aportar_informacion': 'ð§ Pendiente - Enviar info Ãºtil a tÃ©cnico actual',
            'solicitar_asignacion': 'ð§ Pendiente - Pedir hacerse cargo de vencida'
        };
        
        // ð BOTONES POR ESTADO (para validar renderizado)
        const BUTTONS_BY_STATE = {
            'pending': [
                { text: 'â ACEPTO', action: 'acepto', class: 'btn-success' },
                { text: 'â RECHAZO', action: 'rechazo', class: 'btn-danger' }
            ],
            
            'working': [
                { text: 'ð§ RESOLVER', action: 'resolver', class: 'btn-primary' },
                { text: 'ð¦ MATERIALES', action: 'solicitar_materiales', class: 'btn-purple' },
                { text: 'ð DERIVAR', action: 'derivar_departamento', class: 'btn-secondary' },
                { text: 'ð PEDIR AYUDA', action: 'ayuda', class: 'btn-warning' }
            ],
            
            'seguimiento': [
                { text: 'ðï¸ VER PROGRESO', action: 'ver_progreso', class: 'btn-info', readonly: true },
                { text: 'ð SOLICITAR', action: 'solicitar_asignacion', class: 'btn-secondary' },
                { text: 'ð¬ APORTAR INFO', action: 'aportar_informacion', class: 'btn-light' }
            ],
            
            'expired': [
                { text: 'ð SOLICITAR', action: 'solicitar_asignacion', class: 'btn-secondary' }
            ]
        };
        /* ========================================
           LÃGICA DE ESTADOS DE INCIDENCIAS
        ======================================== */
        
        
         function getUserLevel(technicianEmail, incident) {
            // Determinar en quÃ© nivel estÃ¡ este tÃ©cnico para esta incidencia
            if (incident.tecnico_l0 === technicianEmail) return 0;
            if (incident.tecnico_l1 === technicianEmail) return 1;
            if (incident.tecnico_l2?.includes && incident.tecnico_l2.includes(technicianEmail)) return 2;
            return null;
        }
        
         // FunciÃ³n closeModal que falta
        function closeModal() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.remove('active');
            });
        }
    
        function filterIncidents(filter, buttonElement = null) {
                currentStatusFilter = filter;
                if (buttonElement) {
                document.querySelectorAll('.filter-btn, .stat-card').forEach(btn => btn.classList.remove('active'));
                buttonElement.classList.add('active');
            }
            
            renderIncidents(); // Llamar sin parÃ¡metros
        }

         function checkCurrentAssignment(incident, technicianEmail, level) {
                switch (level) {
                    case 0: return incident.l0_technician === technicianEmail;
                    case 1: return incident.l1_technician === technicianEmail;
                    case 2: return incident.l2_technicians && incident.l2_technicians.split(',').map(email => email.trim()).includes(technicianEmail);
                    case 3: return incident.l3_supervisor === technicianEmail;
                    default: return false;
                }
            }

        function hasAcceptedAtLevel(incident, technicianEmail, level) {
            switch (level) {
                case 0: return incident.l0_response === 'acepto' && incident.l0_technician === technicianEmail;
                case 1: return incident.l1_response === 'acepto' && incident.l1_technician === technicianEmail;
                case 2: return incident.l2_responses && incident.l2_responses.includes('acepto');
                case 3: return incident.l3_response === 'acepto';
                default: return false;
            }
        }

        function hasRejectedAtLevel(incident, technicianEmail, level) {
            switch (level) {
                case 0: return ['rechazo', 'solicitar_ayuda'].includes(incident.l0_response) && incident.l0_technician === technicianEmail;
                case 1: return ['rechazo', 'solicitar_ayuda'].includes(incident.l1_response) && incident.l1_technician === technicianEmail;
                case 2: return incident.l2_responses && (incident.l2_responses.includes('rechazo') || incident.l2_responses.includes('solicitar_ayuda'));
                default: return false;
            }
        }

        function hasParticipatedBefore(incident, technicianEmail) {
            return (incident.l0_technician === technicianEmail && incident.l0_response !== 'â­ Sin Respuesta') ||
                   (incident.l1_technician === technicianEmail && incident.l1_response !== 'â­ Sin Respuesta');
        }

        function getCurrentLevelSLA(incident, escalationLevel) {
            const technicianEmail = currentTechnician.email;
            const state = getIncidentRealState(incident, technicianEmail);
            
            // Si estÃ¡ trabajando, NO mostrar SLA
            if (state === 'working') return null;
            
            // â SOLO mostrar SLA del nivel ACTUAL donde puede responder
            if (state === 'pending') {
                // Verificar segÃºn el nivel actual de escalado
                switch (incident.escalation_level) {
                    case 0:
                        if (incident.l0_technician === technicianEmail) {
                            return incident.sla_l0_end;
                        }
                        break;
                    case 1:
                        if (incident.l1_technician === technicianEmail) {
                            return incident.sla_l1_backup_end;
                        }
                        break;
                    case 2:
                        if (incident.l2_technicians && incident.l2_technicians.split(',').map(email => email.trim()).includes(technicianEmail)) {
                            return incident.sla_l2_equipo_end;
                        }
                        break;
                    case 3:
                        if (incident.l3_technician === technicianEmail) {
                            return incident.sla_l3_responsable_end;
                        }
                        break;
                }
            }
            
            return null;
        }
        console.log('L2 technicians string:', incident.l2_technicians);
        console.log('L2 array:', incident.l2_technicians.split(',').map(email => email.trim()));
        console.log('Fernando incluido?:', incident.l2_technicians.split(',').map(email => email.trim()).includes('fernando.castro@empresa.com'));

        function canTechnicianRespond(incident, technicianEmail) {
            const state = getIncidentRealState(incident, technicianEmail);
            return state === 'pending';
        }

        /* ========================================
           FUNCIONES DE RENDERIZADO
        ======================================== */
        function executeAction() {
                if (!pendingAction) return;
                
                if (pendingAction === 'acepto') {
                    confirmAction();
                } else if (pendingAction === 'completar') {
                    showCompletionModal();
                } else {
                    showReasonModal(pendingAction);
                }
            }
            
        
    function renderIncidents(incidentsToRender = null) {
            let filteredIncidents;
            
            if (incidentsToRender) {
                // Si se pasan incidencias especÃ­ficas, usarlas
                filteredIncidents = incidentsToRender;
            } else {
                // Empezar con todas las incidencias
                filteredIncidents = allIncidents;
                
                // ð¯ APLICAR FILTRO POR ESTADO
                if (currentStatusFilter && currentStatusFilter !== 'all') {
                    filteredIncidents = filteredIncidents.filter(incident => {
                        const state = getIncidentRealState(incident, currentTechnician.email);
                        
                        switch(currentStatusFilter) {
                            case 'pending': return state === 'pending';
                            case 'working': return state === 'working';
                            case 'expired': return state === 'expired';
                            case 'seguimiento': return state === 'seguimiento';
                            default: return true;
                        }
                    });
                }
                
                // ð§ APLICAR FILTRO POR PRIORIDAD
                if (currentPriorityFilter && currentPriorityFilter !== 'all') {
                    filteredIncidents = filteredIncidents.filter(incident => {
                        // Extraer prioridad sin emojis
                        const incidentPriority = incident.priority 
                            ? incident.priority.replace(/ð´|ð |ð¡|ð¢|âª/g, '').trim().toUpperCase()
                            : 'MEDIA';
                        
                        return incidentPriority === currentPriorityFilter.toUpperCase();
                    });
                }
            }
            
            // Mostrar mensaje si no hay incidencias
            if (filteredIncidents.length === 0) {
                showNoIncidentsMessage();
                return;
            }
            
            // Renderizar las incidencias filtradas
            const incidentsHTML = filteredIncidents.map(incident => renderIncidentCard(incident)).join('');
            
            document.getElementById('incidentsContainer').innerHTML = `
                <div class="incidents-grid">
                    ${incidentsHTML}
                </div>
            `;
            
            startSLATimers();
        }
        function renderWorkingTimer(incident) {
            const technicianEmail = currentTechnician.email;
            const state = getIncidentRealState(incident, technicianEmail);
            
            if (state !== 'working') return '';
            
            let acceptanceDate = null;
            
            if (incident.l0_technician === technicianEmail && incident.l0_acceptance_date) {
                acceptanceDate = new Date(incident.l0_acceptance_date);
            } else if (incident.l1_technician === technicianEmail && incident.l1_acceptance_date) {
                acceptanceDate = new Date(incident.l1_acceptance_date);
            } else if (incident.l2_acceptance_date) {
                acceptanceDate = new Date(incident.l2_acceptance_date);
            }
            
            if (!acceptanceDate) return '';
            
            const now = new Date();
            const workingMinutes = Math.floor((now - acceptanceDate) / 1000 / 60);
            const hours = Math.floor(workingMinutes / 60);
            const minutes = workingMinutes % 60;
            
            return `<div class="working-timer">âï¸ Trabajando: ${hours}h ${minutes}m</div>`;
        }
        
        // ð¯ FUNCIÃN AUXILIAR para mostrar mensaje cuando no hay incidencias
        function showNoIncidentsMessage() {
            document.getElementById('incidentsContainer').innerHTML = `
                <div class="no-incidents">
                    <div class="no-incidents-icon">ð</div>
                    <h3>No hay incidencias que mostrar</h3>
                    <p>Todas las incidencias estÃ¡n filtradas o no hay incidencias asignadas.</p>
                </div>
            `;
        }

               function renderIncidentCard(incident) {
            const technicianEmail = currentTechnician?.email || '';
            const realState = getIncidentRealState(incident, technicianEmail);
            const escalationLevel = parseInt(incident.escalation_level) || 0;
            
            const priorityColor = getPriorityColor(incident.priority);
            const priority = incident.priority.replace(/ð´|ð |ð¡|ð¢/g, '').trim();
            
            return `
                <div class="incident-card" data-incident-id="${incident.id}">
                    ${renderIncidentHeader(incident, priority, priorityColor, escalationLevel, realState)}
                    ${renderIncidentBody(incident, technicianEmail, escalationLevel)}
                    ${renderIncidentFooter(incident, realState, technicianEmail)}
                </div>
            `;
        }

            function renderIncidentHeader(incident, priority, priorityColor, escalationLevel, realState) {
                const slaTimer = renderSLATimer(incident, escalationLevel);
                const workingTimer = renderWorkingTimer(incident);
                
                return `
                    <div class="incident-header">
                        <div class="incident-title">
                            <h4>${incident.equipment || incident.component || 'Equipo no especificado'}</h4>
                            <div class="badges">
                                <span class="priority-badge" style="background-color: ${priorityColor};">${priority}</span>
                                <span class="badge bg-info">L${escalationLevel} ACTIVO</span>
                                ${getStateBadge(realState)}
                            </div>
                        </div>
                        <!-- â TIMER ÃNICO EN HEADER -->
                        <div class="timer-container">
                            ${workingTimer || slaTimer}
                        </div>
                    </div>
                `;
            }

            function renderIncidentBody(incident, technicianEmail, escalationLevel) {
                return `
                    <div class="incident-body">
                        <div class="zone">ð <strong>${incident.zone}</strong></div>
                        <div class="description">${incident.description}</div>
                        
                        ${renderCurrentEscalationInfo(incident, technicianEmail, escalationLevel)}
                        ${renderTechnicianInfo(incident, technicianEmail)}
                        ${renderAssignmentNotes(incident)}
                        ${renderActionsTaken(incident)}
                        ${renderContactsInfo(incident)}
                        ${renderEscalationHistory(incident, technicianEmail)}
                    </div>
                `;
            }
        function renderCurrentEscalationInfo(incident, technicianEmail, escalationLevel) {
            if (escalationLevel === 0) return ''; // Sin escalado
            
            const currentLevelInfo = getCurrentLevelInfo(incident, escalationLevel);
            
            if (!currentLevelInfo) return '';
            
            return `
                <div class="current-escalation-info">
                    <div class="escalation-badge">
                        ðº ESCALADO NIVEL ${escalationLevel}
                    </div>
                    <div class="escalation-details">
                        <strong>TÃ©cnico actual:</strong> ${currentLevelInfo.technician || 'Buscando tÃ©cnico...'}
                        ${currentLevelInfo.sla_end ? `<br><strong>SLA:</strong> ${new Date(currentLevelInfo.sla_end).toLocaleString('es-ES')}` : ''}
                        ${currentLevelInfo.response && currentLevelInfo.response !== 'â­ Sin Respuesta' ? `<br><strong>Estado:</strong> ${currentLevelInfo.response}` : ''}
                    </div>
                </div>
            `;
        }

        function getCurrentLevelInfo(incident, escalationLevel) {
            switch (escalationLevel) {
                case 0:
                    return {
                        technician: incident.l0_technician,
                        response: incident.l0_response,
                        sla_end: incident.sla_l0_end
                    };
                case 1:
                    return {
                        technician: incident.l1_technician,
                        response: incident.l1_response,
                        sla_end: incident.sla_l1_backup_end
                    };
                case 2:
                    const l2Techs = incident.l2_technicians ? incident.l2_technicians.split(',').map(t => t.trim()) : [];
                    return {
                        technician: l2Techs.length > 1 ? `Equipo L2 (${l2Techs.length} tÃ©cnicos)` : l2Techs[0],
                        response: incident.l2_responses,
                        sla_end: incident.sla_l2_equipo_end,
                        team: l2Techs
                    };
                case 3:
                    return {
                        technician: incident.l3_technician,
                        response: incident.l3_response,
                        sla_end: incident.sla_l3_responsable_end
                    };
                default:
                    return null;
            }
        }
        

        function renderIncidentFooter(incident, realState, technicianEmail) {
            return `
                <div class="incident-footer">
                    ${renderActionButtons(incident, realState, technicianEmail)}
                </div>
            `;
        }

        function getPriorityColor(priority) {
            const priorityText = priority.replace(/ð´|ð |ð¡|ð¢/g, '').trim();
            const colors = {
                'CRÃTICA': '#dc3545',
                'ALTA': '#fd7e14',
                'MEDIA': '#ffc107',
                'BAJA': '#28a745'
            };
            return colors[priorityText] || '#6c757d';
        }

        function getStateBadge(state) {
            const badges = {
                'pending': { text: 'PUEDES RESPONDER', class: 'bg-warning' },
                'working': { text: 'TRABAJANDO', class: 'bg-success' },
                'expired': { text: 'VENCIDA', class: 'bg-danger' },
                'seguimiento': { text: 'SEGUIMIENTO', class: 'bg-info' }
            };
            const config = badges[state] || { text: 'DESCONOCIDO', class: 'bg-secondary' };
            return `<span class="badge ${config.class}">${config.text}</span>`;
        }

        function renderSLABadge(incident, escalationLevel) {
            const now = new Date();
            const technicianEmail = currentTechnician.email;
            const state = getIncidentRealState(incident, technicianEmail);
            
            // Si estÃ¡ TRABAJANDO - mostrar tiempo trabajando, NO SLA
            if (state === 'working') {
                let acceptanceDate = null;
                
                // Buscar fecha de aceptaciÃ³n segÃºn el nivel
                if (incident.l0_technician === technicianEmail && incident.l0_acceptance_date) {
                    acceptanceDate = new Date(incident.l0_acceptance_date);
                } else if (incident.l1_technician === technicianEmail && incident.l1_acceptance_date) {
                    acceptanceDate = new Date(incident.l1_acceptance_date);
                } else if (incident.l2_acceptance_date) {
                    acceptanceDate = new Date(incident.l2_acceptance_date);
                }
                
                if (acceptanceDate) {
                    const workingMinutes = Math.floor((now - acceptanceDate) / 1000 / 60);
                    const hours = Math.floor(workingMinutes / 60);
                    const minutes = workingMinutes % 60;
                    
                    return `<span class="badge working-time">âï¸ Trabajando: ${hours}h ${minutes}m</span>`;
                }
            }
            
            // Si estÃ¡ PENDIENTE - mostrar SLA restante
            if (state === 'pending') {
                let slaDeadline = null;
                
                // Buscar SLA segÃºn el nivel asignado
                if (incident.l0_technician === technicianEmail && incident.sla_l0_end) {
                    slaDeadline = new Date(incident.sla_l0_end);
                } else if (incident.l1_technician === technicianEmail && incident.sla_l1_backup_end) {
                    slaDeadline = new Date(incident.sla_l1_backup_end);
                } else if (incident.sla_l2_equipo_end) {
                    slaDeadline = new Date(incident.sla_l2_equipo_end);
                }
                
                if (slaDeadline) {
                    const remainingMinutes = Math.floor((slaDeadline - now) / 1000 / 60);
                    
                    if (remainingMinutes > 0) {
                        const hours = Math.floor(remainingMinutes / 60);
                        const minutes = remainingMinutes % 60;
                        
                        if (remainingMinutes < 30) {
                            return `<span class="badge sla-critical">â° ${hours > 0 ? hours + 'h ' : ''}${minutes}m restantes</span>`;
                        } else {
                            return `<span class="badge sla-normal">â° ${hours > 0 ? hours + 'h ' : ''}${minutes}m restantes</span>`;
                        }
                    } else {
                        return `<span class="badge sla-expired">â° VENCIDO</span>`;
                    }
                }
            }
            
            // Si estÃ¡ VENCIDO
            if (state === 'expired') {
                return `<span class="badge sla-expired">â° SLA VENCIDO</span>`;
            }
            
            // Si estÃ¡ en SEGUIMIENTO
            if (state === 'seguimiento') {
                return `<span class="badge seguimiento">ðï¸ SEGUIMIENTO</span>`;
            }
            
            return '';
        }

        function renderTechnicianInfo(incident, userEmail) {
            // â Info de tÃ©cnicos solo en historial de escalado (desplegable)
            // La tarjeta se mantiene limpia para foco en la acciÃ³n
            return '';
        }

        function renderSLATimer(incident, escalationLevel) {
            const slaEnd = getCurrentLevelSLA(incident, escalationLevel);
            if (!slaEnd) return '';
            
            const slaClass = getSLAClass(slaEnd);
            const slaText = getSLAText(slaEnd);
            
            return `
                <div class="sla-timer ${slaClass}" data-end="${slaEnd}">
                    â° ${slaText}
                </div>
            `;
        }

        function getSLAClass(slaEnd) {
            if (!slaEnd) return 'sla-good';
            const diffMinutes = Math.floor((new Date(slaEnd) - new Date()) / 60000);
            if (diffMinutes <= 30) return 'sla-critical';
            if (diffMinutes <= 60) return 'sla-warning';
            return 'sla-good';
        }

        function getSLAText(slaEnd) {
            if (!slaEnd) return '';
            const diffMinutes = Math.floor((new Date(slaEnd) - new Date()) / 60000);
            
            // â Si vencido, solo "VENCIDO" sin tiempo
            if (diffMinutes < 0) return 'VENCIDO';
            
            const hours = Math.floor(diffMinutes / 60);
            const minutes = diffMinutes % 60;
            return hours > 0 ? `${hours}h ${minutes}m restantes` : `${minutes}m restantes`;
        }

        function renderAssignmentNotes(incident) {
            if (!incident.assignment_notes || !incident.assignment_notes.trim()) return '';
            
            return `
                <div class="actions-taken">
                    ð <strong>Notas de asignaciÃ³n:</strong> ${incident.assignment_notes}
                </div>
            `;
        }

        function renderActionsTaken(incident) {
            if (!incident.actions_taken || incident.actions_taken === 'Sin acciones' || !incident.actions_taken.trim()) return '';
            
            return `
                <div class="actions-taken">
                    ð§ <strong>Acciones tomadas:</strong> ${incident.actions_taken}
                </div>
            `;
        }

        function renderContactsInfo(incident) {
            if (!incident.supervisor_phone && !incident.reporter_phone && !incident.zone_manager_phone) {
                return '';
            }
            
            let contacts = '';
            if (incident.reporter && incident.reporter_phone) {
                contacts += `<div class="contact-item">ð <strong>Reportador:</strong> ${incident.reporter} - <a href="tel:${incident.reporter_phone}" class="phone-link">${incident.reporter_phone}</a></div>`;
            }
            if (incident.supervisor && incident.supervisor_phone) {
                contacts += `<div class="contact-item">ð¨âð¼ <strong>Supervisor:</strong> ${incident.supervisor} - <a href="tel:${incident.supervisor_phone}" class="phone-link">${incident.supervisor_phone}</a></div>`;
            }
            if (incident.zone_manager && incident.zone_manager_phone) {
                contacts += `<div class="contact-item">ð¢ <strong>Encargado Zona:</strong> ${incident.zone_manager} - <a href="tel:${incident.zone_manager_phone}" class="phone-link">${incident.zone_manager_phone}</a></div>`;
            }
            
            return `
                <div class="contacts-info">
                    <div class="contacts-header" onclick="toggleContacts('${incident.id}')" style="cursor: pointer;">
                        ð Contactos <span class="toggle-icon" id="contacts-toggle-${incident.id}">â¼</span>
                    </div>
                    <div class="contacts-list" id="contacts-${incident.id}" style="display: none;">
                        ${contacts}
                    </div>
                </div>
            `;
        }

        function renderEscalationHistory(incident, userEmail) {
            const historyLevels = buildEscalationHistory(incident, userEmail);
            const historyHTML = historyLevels.map(level => renderEscalationLevel(level, userEmail)).join('');
            
            return `
                <div class="escalation-history">
                    <div class="escalation-header" onclick="toggleEscalationHistory('${incident.id}')">
                        ð Historial de Escalado <span class="toggle-icon">â¼</span>
                    </div>
                    <div class="escalation-content" id="escalation-${incident.id}">
                        ${historyHTML}
                    </div>
                </div>
            `;
        }

        function buildEscalationHistory(incident, userEmail) {
            const historyLevels = [];
            const currentLevel = parseInt(incident.escalation_level) || 0;
            
            // L0
            let l0Status = 'pending';
            if (incident.l0_response === 'acepto') l0Status = 'completed';
            else if (['rechazo', 'solicitar_ayuda'].includes(incident.l0_response)) l0Status = 'escalated';
            else if (currentLevel > 0) l0Status = 'expired';
            
            historyLevels.push({
                level: 'L0',
                technician: incident.l0_technician,
                status: l0Status,
                response: incident.l0_response,
                sla_end: incident.sla_l0_end,
                acceptance_date: incident.l0_acceptance_date,
                rejection_date: incident.l0_rejection_date,
                reason: incident.l0_rejection_reason
            });
            
            // L1, L2, L3 similar logic...
            if (currentLevel >= 1) {
                let l1Status = currentLevel === 1 ? 'current' : 'completed';
                if (incident.l1_response === 'acepto') l1Status = 'completed';
                else if (['rechazo', 'solicitar_ayuda'].includes(incident.l1_response)) l1Status = 'escalated';
                else if (currentLevel > 1) l1Status = 'expired';
                
                historyLevels.push({
                    level: 'L1',
                    technician: incident.l1_technician,
                    status: l1Status,
                    response: incident.l1_response,
                    sla_end: incident.sla_l1_backup_end,
                    acceptance_date: incident.l1_acceptance_date,
                    rejection_date: incident.l1_rejection_date,
                    reason: incident.l1_rejection_reason
                });
            }
            
            return historyLevels;
        }

        function renderEscalationLevel(level, userEmail) {
            const isCurrentTech = level.technician === userEmail || 
                                 (level.technician && level.technician.includes && level.technician.includes(userEmail));
            
            let statusClass = level.status;
            let statusText = '';
            switch(level.status) {
                case 'completed': statusText = 'â Completado'; break;
                case 'current': statusText = 'ð Activo'; break;
                case 'expired': statusText = 'â° Vencido'; break;
                case 'escalated': statusText = 'ð¼ Escalado'; break;
                case 'pending': statusText = 'â³ Pendiente'; break;
            }
            
            return `
                <div class="escalation-level ${statusClass}">
                    <div class="level-header">
                        ${level.level} - ${statusText} ${isCurrentTech ? '(TÃ)' : ''}
                    </div>
                    <div class="level-details">
                        <strong>TÃ©cnico:</strong> ${level.technician ? level.technician.split('@')[0] : 'No asignado'}<br>
                        ${level.response ? `<strong>Respuesta:</strong> ${level.response}<br>` : ''}
                        ${level.reason ? `<strong>Motivo:</strong> ${level.reason}<br>` : ''}
                        ${level.sla_end ? `<strong>SLA:</strong> ${new Date(level.sla_end).toLocaleString('es-ES')}<br>` : ''}
                        ${level.acceptance_date ? `<strong>Fecha aceptaciÃ³n:</strong> ${new Date(level.acceptance_date).toLocaleString('es-ES')}<br>` : ''}
                        ${level.rejection_date ? `<strong>Fecha rechazo:</strong> ${new Date(level.rejection_date).toLocaleString('es-ES')}` : ''}
                    </div>
                </div>
            `;
        }

        function renderActionButtons(incident, state, userEmail) {
            const realState = getIncidentRealState(incident, userEmail);
            
            if (realState === 'pending') {
                return `
                    <div class="incident-actions">
                        <button class="btn btn-success" onclick="handleAction('acepto', '${incident.id}')">â Acepto</button>
                        <button class="btn btn-danger" onclick="handleAction('rechazo', '${incident.id}')">â Rechazo</button>
                        <button class="btn btn-warning" onclick="handleAction('solicitar_ayuda', '${incident.id}')">ð Ayuda</button>
                    </div>
                `;
            } else if (realState === 'working') {
                return `
                    <div class="incident-actions">
                        <button class="btn btn-primary" onclick="showResolverModal('${incident.id}')">ð§ RESOLVER</button>
                        <button class="btn btn-purple" onclick="showSolicitarMaterialesModal('${incident.id}')">ð¦ MATERIALES</button>
                        <button class="btn btn-secondary" onclick="handleAction('derivar_departamento', '${incident.id}')">ð DERIVAR</button>
                        <button class="btn btn-warning" onclick="handleAction('solicitar_apoyo', '${incident.id}')">ð PEDIR AYUDA</button>
                    </div>
                `;
            } else if (realState === 'seguimiento' || realState === 'expired') {
                return `
                    <div class="incident-actions">
                        <button class="btn btn-info" onclick="handleAction('solicitar_cargo', '${incident.id}')">ðââï¸ SOLICITAR HACERSE CARGO</button>
                    </div>
                `;
            } else {
                return '<div class="no-action-info"><span class="badge bg-light">Sin acciones disponibles</span></div>';
            }
        }

        function showNoIncidentsMessage() {
            const container = document.getElementById('incidentsContainer');
            container.innerHTML = `
                <div class="no-incidents">
                    <div class="no-incidents-icon">ð</div>
                    <h3>No hay incidencias</h3>
                    <p>No tienes incidencias ${currentStatusFilter === 'all' ? '' : 'con este estado'} en este momento.</p>
                </div>
            `;
        }

        /* ========================================
           MANEJO DE ACCIONES
        ======================================== */
        function handleAction(action, incidentId) {
            currentIncident = allIncidents.find(inc => inc.id === incidentId);
            if (!currentIncident) {
                console.error('Incidencia no encontrada:', incidentId);
                return;
            }
            if (!currentTechnician?.authenticated) {
                pendingAction = action;
                showPINModal();
                return;
            }
            if (action === 'acepto') {
                pendingAction = action;
                confirmAction();
            } else if (action === 'completar') {
                showCompletionModal();
            } else if (action === 'solicitar_materiales') {
                document.getElementById('materialesModal').classList.add('active');
            } else if (action === 'derivar_departamento') {
                document.getElementById('derivarModal').classList.add('active');
            } else {
                showReasonModal(action);
            }
        }

        function showReasonModal(action) {
            pendingAction = action;
            selectedReason = null;
            customText = '';

            const modal = document.getElementById('reasonModal');
            const title = document.getElementById('modalTitle');
            const options = document.getElementById('reasonOptions');
            const confirmBtn = document.getElementById('confirmBtn');

            let reasons = [];
            let modalTitle = '';
            let buttonText = '';

            switch(action) {
                case 'rechazo':
                    modalTitle = 'â Motivo del Rechazo';
                    buttonText = 'Rechazar';
                    reasons = rejectReasons;
                    break;
                case 'solicitar_ayuda':
                    modalTitle = 'ð Tipo de Ayuda Inicial';
                    buttonText = 'Solicitar Ayuda';
                    reasons = helpReasonsInitial;
                    break;
                case 'transferir':
                    modalTitle = 'ð Motivo de Transferencia';
                    buttonText = 'Transferir';
                    reasons = transferReasons;
                    break;
                case 'solicitar_apoyo':
                    modalTitle = 'ð Tipo de Apoyo en Trabajo';
                    buttonText = 'Solicitar Apoyo';
                    reasons = supportReasonsWorking;
                    break;
                default:
                    console.error('AcciÃ³n no reconocida:', action);
                    return;
            }

            title.textContent = modalTitle;
            confirmBtn.textContent = buttonText;
            confirmBtn.disabled = true;

            const reasonsHTML = reasons.map(reason => {
                return `
                    <div class="reason-option" onclick="selectReason('${reason.id}', ${reason.requiresText || false})">
                        <div class="reason-icon">${reason.icon}</div>
                        <div class="reason-text">
                            <div class="reason-title">${reason.title}</div>
                            <div class="reason-description">${reason.description}</div>
                        </div>
                    </div>
                `;
            }).join('');

            options.innerHTML = reasonsHTML;
            modal.classList.add('active');
        }

        function selectReason(reasonId, requiresText = false) {
            selectedReason = reasonId;
            customText = '';
            
            document.querySelectorAll('.reason-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            const options = document.getElementById('reasonOptions');
            const existingTextarea = options.querySelector('.custom-reason-input');
            if (existingTextarea) {
                existingTextarea.remove();
            }
            
            if (requiresText) {
                const textarea = document.createElement('textarea');
                textarea.className = 'custom-reason-input';
                textarea.placeholder = 'Especifica los detalles...';
                textarea.oninput = () => {
                    customText = textarea.value.trim();
                    updateConfirmButton();
                };
                options.appendChild(textarea);
                textarea.focus();
            } else {
                updateConfirmButton();
            }
        }

        function updateConfirmButton() {
            const confirmBtn = document.getElementById('confirmBtn');
            const requiresText = selectedReason && selectedReason.includes('otro');
            
            if (selectedReason) {
                if (requiresText) {
                    confirmBtn.disabled = customText.length < 10;
                } else {
                    confirmBtn.disabled = false;
                }
            } else {
                confirmBtn.disabled = true;
            }
        }

        function closeReasonModal() {
            document.getElementById('reasonModal').classList.remove('active');
            selectedReason = null;
            customText = '';
            pendingAction = null;
        }

        function showCompletionModal() {
            const modal = document.getElementById('reasonModal');
            const title = document.getElementById('modalTitle');
            const options = document.getElementById('reasonOptions');
            const confirmBtn = document.getElementById('confirmBtn');

            title.textContent = 'â Completar Incidencia';
            confirmBtn.textContent = 'Completar';
            
            options.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #374151; font-weight: 600; margin-bottom: 10px;">
                        Describe las acciones realizadas para resolver la incidencia:
                    </p>
                    <textarea 
                        class="custom-reason-input" 
                        placeholder="Ejemplo: Reemplazada bomba defectuosa, verificado funcionamiento correcto, sistema operativo..." 
                        maxlength="500"
                        oninput="updateCompletionText(this.value)"
                        style="height: 120px;"></textarea>
                    <div style="text-align: right; font-size: 12px; color: #6b7280; margin-top: 5px;">
                        MÃ­nimo 20 caracteres
                    </div>
                </div>
            `;

            confirmBtn.disabled = true;
            modal.classList.add('active');
            
            setTimeout(() => {
                const textarea = options.querySelector('textarea');
                if (textarea) textarea.focus();
            }, 100);
        }

        function updateCompletionText(text) {
            customText = text.trim();
            document.getElementById('confirmBtn').disabled = customText.length < 20;
        }

        async function confirmAction() {
            if (!pendingAction || !currentIncident) {
                console.error('No hay acciÃ³n pendiente o incidencia seleccionada');
                return;
            }

            function confirmMateriales() {
                const materials = [];
                document.querySelectorAll('.material-item').forEach(item => {
                    const name = item.querySelector('.material-name').value;
                    const qty = item.querySelector('.material-qty').value;
                    const urgency = item.querySelector('.material-urgency').value;
                    const reason = item.querySelector('.material-reason').value;
                    
                    if (name && qty && reason) {
                        materials.push({
                            material: name,
                            quantity: parseInt(qty),
                            urgency: urgency,
                            justification: reason
                        });
                    }
                });
            
                if (materials.length === 0) {
                    alert('AÃ±ade al menos un material');
                    return;
                }
            
                executeAction('solicitar_materiales', { materials_requested: materials });
            }
            
            function confirmDerivar() {
                const target = document.getElementById('targetDepartment').value;
                const reason = document.getElementById('derivationReason').value;
                const notes = document.getElementById('technicalNotes').value;
                
                if (!reason) {
                    alert('Indica el motivo de la derivaciÃ³n');
                    return;
                }
                
                executeAction('derivar_departamento', {
                    target_department: target,
                    derivation_reason: reason,
                    technical_notes: notes
                });
            }
            
            function addMaterial() {
                const container = document.getElementById('materialesList');
                const newItem = document.querySelector('.material-item').cloneNode(true);
                newItem.querySelectorAll('input, textarea, select').forEach(el => el.value = '');
                container.appendChild(newItem);
            }
            
            function executeAction(action, extraData = {}) {
                fetch('/api/webhook-respuesta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: action,
                        incident_id: currentIncident.id,
                        technician_email: currentTechnician.email,
                        ...extraData
                    })
                }).then(response => response.json())
                  .then(data => {
                      if (data.status === 'success') {
                          showSuccessOverlay(`${action} procesado correctamente`);
                          closeModal();
                          loadDashboard();
                      } else {
                          alert('Error: ' + data.message);
                      }
                  });
            }

            const reasonText = selectedReason ? 
                (customText || selectedReason.replace(/_/g, ' ')) : 
                (customText || 'Confirmado');

            try {
               const response = await fetch('/api/webhook-respuesta', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        incident_id: pendingAction,
                        technician_email: currentTechnician.email,
                        technician_name: currentTechnician.name,
                        action: pendingAction,
                        reason: reasonText,
                        timestamp: new Date().toISOString()
                    })
                });

                let data = null;
                try {
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                        data = await response.json();
                    } else {
                        throw new Error('Respuesta no es JSON vÃ¡lido');
                    }
                } catch (parseError) {
                    console.error('Error parsing respuesta de acciÃ³n:', parseError);
                    throw new Error('Error procesando respuesta del servidor');
                }
                
                if (response.ok && data && data.status === 'success') {
                    const successMessages = {
                        'acepto': 'â Incidencia aceptada correctamente. Â¡Puedes empezar a trabajar!',
                        'rechazo': 'â Incidencia rechazada. Se escalarÃ¡ automÃ¡ticamente.',
                        'solicitar_ayuda': 'ð Ayuda solicitada. Un supervisor se pondrÃ¡ en contacto.',
                        'completar': 'â Incidencia completada exitosamente.',
                        'transferir': 'ð Incidencia transferida correctamente.',
                        'solicitar_apoyo': 'ð Apoyo solicitado. Un supervisor gestionarÃ¡ tu peticiÃ³n.'
                    };
                    
                    showSuccessOverlay(
                        successMessages[pendingAction] || `${pendingAction.toUpperCase()} registrado correctamente`,
                        pendingAction === 'acepto' ? 'ð' : 'â'
                    );
                    
                    closeReasonModal();
                    await loadDashboard();
                } else {
                    const errorMsg = (data && data.message) || `Error ${response.status}: No se pudo registrar la respuesta`;
                    alert(errorMsg);
                }
                
            } catch (error) {
                console.error('Error enviando respuesta:', error);
                alert('Error de conexiÃ³n: ' + error.message);
            } finally {
                pendingAction = null;
                currentIncident = null;
                selectedReason = null;
                customText = '';
            }
        }

        function showSuccessOverlay(message, icon = 'â') {
            const overlay = document.getElementById('successOverlay');
            const iconEl = document.getElementById('successIcon');
            const titleEl = document.getElementById('successTitle');
            const descEl = document.getElementById('successDescription');
            const countdownEl = document.getElementById('countdown');
            
            iconEl.textContent = icon;
            titleEl.textContent = 'AcciÃ³n Completada';
            descEl.textContent = message;
            
            overlay.style.display = 'flex';
            
            let seconds = 3;
            countdownEl.textContent = `Actualizando en ${seconds} segundos...`;
            
            const countdown = setInterval(() => {
                seconds--;
                if (seconds > 0) {
                    countdownEl.textContent = `Actualizando en ${seconds} segundos...`;
                } else {
                    clearInterval(countdown);
                    overlay.style.display = 'none';
                }
            }, 1000);
        }

        /* ========================================
           FUNCIONES DE UTILIDAD Y EVENTOS
        ======================================== */
        function filterByStatus(status, element) {
            currentStatusFilter = status;
            
            document.querySelectorAll('.stat-card').forEach(card => {
                card.classList.remove('active');
            });
            element.classList.add('active');
            
            renderIncidents();
        }

        function filterByPriority(priority, element) {
            currentPriorityFilter = priority;
            document.querySelectorAll('.filter-btn, .stat-card').forEach(btn => {
                btn.classList.remove('active');
            });
            element.classList.add('active');
            
            renderIncidents();
        }

        function toggleContacts(incidentId) {
            const contactsContent = document.getElementById(`contacts-${incidentId}`);
            const toggleIcon = document.getElementById(`contacts-toggle-${incidentId}`);
            
            console.log('ð toggleContacts llamado:', incidentId);
            console.log('ð contactsContent:', contactsContent);
            console.log('ð½ toggleIcon:', toggleIcon);
            
            if (contactsContent) {
                const isHidden = contactsContent.style.display === 'none';
                
                if (isHidden) {
                    contactsContent.style.display = 'block';
                    contactsContent.style.maxHeight = '200px';
                    contactsContent.style.opacity = '1';
                    if (toggleIcon) toggleIcon.textContent = 'â²';
                } else {
                    contactsContent.style.display = 'none';
                    contactsContent.style.maxHeight = '0';
                    contactsContent.style.opacity = '0';
                    if (toggleIcon) toggleIcon.textContent = 'â¼';
                }
            } else {
                console.error('â No se encontrÃ³ elemento contacts-' + incidentId);
            }
        }

        function toggleEscalationHistory(incidentId) {
            const historyContent = document.getElementById(`escalation-${incidentId}`);
            if (!historyContent) return;
            
            const toggleIcon = historyContent.parentElement.querySelector('.toggle-icon');
            const isVisible = historyContent.style.display !== 'none';  
            
             historyContent.style.display = isVisible ? 'none' : 'block';
            if (toggleIcon) {
                toggleIcon.textContent = isVisible ? 'â¼' : 'â²';
            }
        }

        function refreshDashboard() {
            const refreshBtn = document.getElementById('refreshBtn');
            const originalText = refreshBtn.innerHTML;
            
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = 'ð Actualizando...';
            
            loadDashboard().finally(() => {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = originalText;
            });
        }
        
        function startAutoRefresh() {
                    console.log('â ï¸ Auto-refresh deshabilitado para evitar consumo excesivo');
            // No hacer nada - solo refresh manual
        }
            

        function startSLATimers() {
            if (slaTimerInterval) {
                clearInterval(slaTimerInterval);
            }
            
            slaTimerInterval = setInterval(function() {
                const slaElements = document.querySelectorAll('.sla-timer[data-end]');
                
                slaElements.forEach(function(element) {
                    const endTime = new Date(element.dataset.end);
                    const now = new Date();
                    const diffMinutes = Math.floor((endTime - now) / 1000 / 60);
                    
                    if (diffMinutes < 0) {
                        element.className = 'sla-expired';
                        element.innerHTML = `â° VENCIDO hace ${Math.abs(diffMinutes)} min`;
                    } else {
                        const hours = Math.floor(diffMinutes / 60);
                        const minutes = diffMinutes % 60;
                        
                        let slaClass = 'sla-timer ';
                        if (diffMinutes <= 30) slaClass += 'sla-critical';
                        else if (diffMinutes <= 60) slaClass += 'sla-warning';
                        else slaClass += 'sla-good';
                        
                        element.className = slaClass;
                        element.innerHTML = `â° ${hours}h ${minutes.toString().padStart(2, '0')}m restantes`;
                    }
                });
            }, CONFIG.SLA_UPDATE_INTERVAL);
            
            console.log('â° Timers SLA iniciados - actualizaciÃ³n cada 30 segundos');
        }

        function validateDate(dateString) {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return '';
                }
                return dateString;
            } catch (error) {
                console.warn('Fecha invÃ¡lida:', dateString);
                return '';
            }
        }

        /* ========================================
           INICIALIZACIÃN DE LA APLICACIÃN
        ======================================== */
        function initializeApp() {
            console.log('ð§ Dashboard TÃ©cnico ABC.xyz iniciado');
            
            // Configurar parÃ¡metros URL
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('tecnico') || urlParams.get('technician_email');
            const nombre = urlParams.get('nombre') || urlParams.get('technician_name');
            const incidentId = urlParams.get('id') || urlParams.get('incident_id');
            
            if (email) {
                document.getElementById('emailInput').value = email;
                if (nombre) {
                    currentTechnician = { 
                        email: email, 
                        name: decodeURIComponent(nombre),
                        authenticated: false
                    };
                }
                if (incidentId) {
                    accessMode = 'read_only';
                }
            }

            // Configurar eventos del login
            const emailInput = document.getElementById('emailInput');
            const loginBtn = document.getElementById('loginBtn');

            emailInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loginWithPIN();
                }
            });

            emailInput.addEventListener('input', () => {
                loginBtn.disabled = !emailInput.value.trim();
            });

            // Eventos globales
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeReasonModal();
                    closePINModal();
                }
                if (e.key === 'Enter' && document.getElementById('loginContainer').style.display !== 'none') {
                    const input = document.getElementById('emailInput');
                    if (input.value.trim()) loginWithPIN();
                }
            });

            // Eventos de modales
            document.getElementById('reasonModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeReasonModal();
            });

            document.getElementById('pinModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closePINModal();
            });

            // Limpieza al cerrar la ventana
            window.addEventListener('beforeunload', () => {
                if (refreshInterval) clearInterval(refreshInterval);
                if (slaTimerInterval) clearInterval(slaTimerInterval);
            });

            // Auto-foco en el input de email
            emailInput.focus();

            console.log('â InicializaciÃ³n de la aplicaciÃ³n completa');
            console.log('ð Motivos configurados:', {
                rechazo: rejectReasons.length,
                ayuda_inicial: helpReasonsInitial.length,
                transferir: transferReasons.length,
                apoyo_trabajo: supportReasonsWorking.length
            });
        }
       
        /* ========================================
           GESTIÃN DE MATERIALES
        ======================================== */
        
        let selectedMaterials = []; // Array global para materiales seleccionados
        
        // Agregar material al modal resolver
        function addMaterial() {
            const materialSelect = document.getElementById('materialSelect');
            const quantityInput = document.getElementById('materialQuantity');
            const reasonSelect = document.getElementById('materialReason');
            
            const materialId = materialSelect.value;
            const materialName = materialSelect.options[materialSelect.selectedIndex].text;
            const quantity = parseFloat(quantityInput.value);
            const reason = reasonSelect.value;
            const reasonText = reasonSelect.options[reasonSelect.selectedIndex].text;
            
            // Validaciones
            if (!materialId) {
                alert('Selecciona un material');
                return;
            }
            
            if (!quantity || quantity <= 0) {
                alert('Ingresa una cantidad vÃ¡lida');
                return;
            }
            
            if (!reason) {
                alert('Selecciona un motivo de consumo');
                return;
            }
            
            // Verificar si el material ya existe
            const existingIndex = selectedMaterials.findIndex(m => m.materialId === materialId);
            if (existingIndex !== -1) {
                // Actualizar cantidad si ya existe
                selectedMaterials[existingIndex].quantity += quantity;
            } else {
                // Agregar nuevo material
                selectedMaterials.push({
                    materialId: materialId,
                    materialName: materialName,
                    quantity: quantity,
                    reason: reason,
                    reasonText: reasonText
                });
            }
            
            // Limpiar inputs
            materialSelect.value = '';
            quantityInput.value = '';
            reasonSelect.value = '';
            
            // Actualizar vista
            updateMaterialsList();
        }
        
        // Actualizar lista de materiales seleccionados
        function updateMaterialsList() {
            const container = document.getElementById('selectedMaterials');
            
            if (selectedMaterials.length === 0) {
                container.innerHTML = '<p class="no-materials">No hay materiales seleccionados</p>';
                return;
            }
            
            const materialsHTML = selectedMaterials.map((material, index) => `
                <div class="material-item">
                    <div class="material-info">
                        <strong>${material.materialName}</strong>
                        <span class="material-details">
                            Cantidad: ${material.quantity} | Motivo: ${material.reasonText}
                        </span>
                    </div>
                    <button type="button" class="btn-remove-material" onclick="removeMaterial(${index})">
                        â Quitar
                    </button>
                </div>
            `).join('');
            
            container.innerHTML = materialsHTML;
        }
        
        // Remover material de la lista
        function removeMaterial(index) {
            selectedMaterials.splice(index, 1);
            updateMaterialsList();
        }
        
        // Confirmar materiales en modal resolver
        function confirmMateriales() {
            const solutionDescription = document.getElementById('solutionDescription').value.trim();
            const timeInvested = document.getElementById('timeInvested').value.trim();
            const preventiveActions = document.getElementById('preventiveActions').value.trim();
            
            // Validaciones
            if (!solutionDescription || solutionDescription.length < 10) {
                alert('La descripciÃ³n de la soluciÃ³n debe tener al menos 10 caracteres');
                return;
            }
            
            if (!timeInvested) {
                alert('Ingresa el tiempo invertido');
                return;
            }
            
            // Preparar payload
            const payload = {
                action: 'resolver',
                incident_id: currentIncidentId,
                technician_email: currentTechnician.email,
                level: getCurrentTechnicianLevel(),
                solution_description: solutionDescription,
                time_invested: timeInvested,
                preventive_actions: preventiveActions,
                materials_used: selectedMaterials
            };
            
            console.log('ð§ Enviando resoluciÃ³n:', payload);
            
            // Enviar a webhook
            sendActionToWebhook(payload);
        }
        
        /* ========================================
           MODAL SOLICITAR MATERIALES
        ======================================== */
        
        let requestedMaterials = []; // Array para materiales solicitados
        let currentIncidentId = null; //declarar la variable global
        
        // Mostrar modal solicitar materiales
        function showSolicitarMaterialesModal(incidentId) {
            currentIncidentId = incidentId;   // ð¹ Guardamos la incidencia actual
            requestedMaterials = []; // Limpiar array
            document.getElementById('solicitudMaterialesModal').classList.add('active');
            updateRequestedMaterialsList();
        }

        function showResolverModal(incidentId) {
            currentIncidentId = incidentId;
            document.getElementById('resolverModal').classList.add('active');
            
            // Limpiar campos
            document.getElementById('solutionDescription').value = '';
            document.getElementById('timeInvested').value = '';
            document.getElementById('preventiveActions').value = '';
            selectedMaterials = [];
            updateMaterialsList();
            
            // Cargar materiales disponibles
            loadAvailableMaterials();
        }
        // Cerrar modal resolver
        function closeResolverModal() {
            document.getElementById('resolverModal').classList.remove('active');
            selectedMaterials = [];
            currentIncidentId = null;
        }
        // FunciÃ³n para cerrar todos los modales
        function closeAllModals() {
            // Cerrar todos los modales posibles
            const modals = [
                'reasonModal',
                'resolverModal', 
                'solicitudMaterialesModal',
                'derivarModal',
                'ayudaModal',
                'solicitarAsignacionModal',
                'aportarInfoModal'
            ];
                modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('active');
                }
            });
        }
        // Cerrar modal solicitar materiales  
        function closeSolicitarMaterialesModal() {
            document.getElementById('solicitudMaterialesModal').classList.remove('active');
            requestedMaterials = [];
        }
        
        // Agregar material a solicitud
        function addMaterialRequest() {
            const materialName = document.getElementById('requestMaterialName').value.trim();
            const quantity = document.getElementById('requestQuantity').value.trim();
            const urgency = document.getElementById('requestUrgency').value;
            const justification = document.getElementById('requestJustification').value.trim();
            
            // Validaciones
            if (!materialName) {
                alert('Ingresa el nombre del material');
                return;
            }
            
            if (!quantity) {
                alert('Ingresa la cantidad');
                return;
            }
            
            if (!urgency) {
                alert('Selecciona la urgencia');
                return;
            }
            
            if (!justification || justification.length < 10) {
                alert('La justificaciÃ³n debe tener al menos 10 caracteres');
                return;
            }
            
            // Agregar a array
            requestedMaterials.push({
                material: materialName,
                quantity: quantity,
                urgency: urgency,
                justification: justification
            });
            
            // Limpiar inputs
            document.getElementById('requestMaterialName').value = '';
            document.getElementById('requestQuantity').value = '';
            document.getElementById('requestUrgency').value = '';
            document.getElementById('requestJustification').value = '';
            
            updateRequestedMaterialsList();
        }
        
        // Actualizar lista de materiales solicitados
        function updateRequestedMaterialsList() {
            const container = document.getElementById('requestedMaterialsList');
            
            if (requestedMaterials.length === 0) {
                container.innerHTML = '<p class="no-materials">No hay materiales en la solicitud</p>';
                return;
            }
            
            const materialsHTML = requestedMaterials.map((material, index) => `
                <div class="material-request-item">
                    <div class="request-info">
                        <strong>${material.material}</strong>
                        <div class="request-details">
                            <span class="quantity">Cantidad: ${material.quantity}</span>
                            <span class="urgency urgency-${material.urgency}">Urgencia: ${material.urgency.toUpperCase()}</span>
                        </div>
                        <div class="justification">${material.justification}</div>
                    </div>
                    <button type="button" class="btn-remove-material" onclick="removeRequestedMaterial(${index})">
                        â Quitar
                    </button>
                </div>
            `).join('');
            
            container.innerHTML = materialsHTML;
            
            // Habilitar/deshabilitar botÃ³n enviar
            const sendButton = document.getElementById('sendMaterialRequestBtn');
            sendButton.disabled = requestedMaterials.length === 0;
        }
        
        // Remover material solicitado
        function removeRequestedMaterial(index) {
            requestedMaterials.splice(index, 1);
            updateRequestedMaterialsList();
        }
        
        // Confirmar solicitud de materiales
        function confirmSolicitudMateriales() {
            const workCanContinue = document.getElementById('workCanContinue').checked;
            const impactDescription = document.getElementById('impactDescription').value.trim();
            
            if (requestedMaterials.length === 0) {
                alert('Agrega al menos un material a la solicitud');
                return;
            }
            
            // Preparar payload
            const payload = {
                action: 'solicitar_materiales',
                incident_id: currentIncidentId,
                technician_email: currentTechnician.email,
                level: getCurrentTechnicianLevel(),
                materials_requested: requestedMaterials,
                work_can_continue: workCanContinue,
                impact_if_delayed: impactDescription || 'Sin impacto especificado'
            };
            
            console.log('ð¦ Enviando solicitud de materiales:', payload);
            
            // Enviar a webhook
            sendActionToWebhook(payload);
            
            // Cerrar modal
            closeSolicitarMaterialesModal();
        }
        
        /* ========================================
           FUNCIONES AUXILIARES
        ======================================== */
                    // Mostrar loader
            function showLoading(message = 'Cargando...') {
                // Si quieres usar overlay existente:
                const overlay = document.getElementById('successOverlay');
                if (overlay) {
                    overlay.style.display = 'flex';
                    document.getElementById('successTitle').innerText = message;
                    document.getElementById('successDescription').innerText = 'Por favor espera...';
                    document.getElementById('countdown').innerText = '';
                }
                // O simplemente cambiar el cursor:
                document.body.style.cursor = 'wait';
            }
            
            // Ocultar loader
            function hideLoading() {
                const overlay = document.getElementById('successOverlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
                document.body.style.cursor = 'default';
            }
                async function sendActionToWebhook(payload) {
            try {
                showLoading('Procesando acciÃ³n...');
                
                const response = await fetch('/api/webhook-respuesta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.status === 'success') {
                    showNotification('â AcciÃ³n procesada correctamente', 'success');
                    // Cerrar modales
                    closeAllModals();
                    // Refresh despuÃ©s de 2 segundos
                    setTimeout(refreshDashboard, 2000);
                } else {
                    showNotification(`â Error: ${data.message}`, 'error');
                }
            } catch (error) {
                hideLoading();
                showNotification('â Error de conexiÃ³n', 'error');
                console.error('Error:', error);
            }
        }
        
            // Obtener nivel actual del tÃ©cnico
            function getCurrentTechnicianLevel() {
                // Esta lÃ³gica deberÃ­a basarse en los datos reales del tÃ©cnico
                // Por ahora, extraer del nivel del tÃ©cnico actual o defaultear a L0
                
                if (currentTechnician && currentTechnician.level) {
                    if (currentTechnician.level.includes('L2') || currentTechnician.level.includes('Senior')) {
                        return 'L2';
                    } else if (currentTechnician.level.includes('L1') || currentTechnician.level.includes('Intermedio')) {
                        return 'L1';
                    }
                }
                
                return 'L0'; // Default
            }
        
        // Cargar lista de materiales disponibles (para select)
            async function loadAvailableMaterials() {
                try {
                    // En una implementaciÃ³n real, esto cargarÃ­a desde Notion
                    // Por ahora, usar datos de ejemplo mÃ¡s realistas
                    const materials = [
                        { id: 'filtro-hidraulico-fh445', name: 'Filtro HidrÃ¡ulico FH-445' },
                        { id: 'aceite-hidraulico-sae32', name: 'Aceite HidrÃ¡ulico SAE 32' },
                        { id: 'bomba-centrifuga-5hp', name: 'Bomba CentrÃ­fuga 5HP' },
                        { id: 'motor-asincrono-3hp', name: 'Motor AsÃ­ncrono 3HP' },
                        { id: 'rodamiento-6204', name: 'Rodamiento 6204-2RS' },
                        { id: 'correa-a38', name: 'Correa Trapezoidal A38' },
                        { id: 'contactor-lc1d09', name: 'Contactor LC1D09' },
                        { id: 'fusible-10a', name: 'Fusible 10A' }
                    ];
                    
                    const selectElement = document.getElementById('materialSelect');
                    if (selectElement) {
                        selectElement.innerHTML = '<option value="">Seleccionar material...</option>' +
                            materials.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
                    }
                        
                } catch (error) {
                    console.error('Error cargando materiales:', error);
                }
            }

                    // Derivar departamento
            function showDerivarModal(incidentId) {
                currentIncidentId = incidentId;
                document.getElementById('derivarModal').classList.add('active');
            }

            function confirmDerivarDepartamento() {
        const targetDepartment = document.getElementById('targetDepartment').value;
        const derivationReason = document.getElementById('derivationReason').value;
        const technicalNotes = document.getElementById('technicalNotes').value;
        
                    if (!targetDepartment || !derivationReason) {
                        alert('Departamento destino y motivo son obligatorios');
                        return;
                    }
                     const payload = {
                    action: 'derivar_departamento',
                    incident_id: currentIncidentId,
                    technician_email: currentTechnician.email,
                    level: getCurrentTechnicianLevel(),
                    current_department: currentTechnician.department || 'Sin especificar',
                    target_department: targetDepartment,
                    derivation_reason: derivationReason,
                    technical_notes: technicalNotes
                };
                
                sendActionToWebhook(payload);
                document.getElementById('derivarModal').classList.remove('active');
            }
        // Solicitar ayuda (desde trabajando)
        function showAyudaModal(incidentId) {
            currentIncidentId = incidentId;
            document.getElementById('ayudaModal').classList.add('active');
        }
        
        function confirmSolicitarAyuda() {
            const helpType = document.getElementById('helpType').value;
            const helpDescription = document.getElementById('helpDescription').value;
            const urgency = document.getElementById('helpUrgency').value;
            
            if (!helpType || !helpDescription) {
                alert('Tipo de ayuda y descripciÃ³n son obligatorios');
                return;
            }
            
            const payload = {
                action: 'ayuda',
                incident_id: currentIncidentId,
                technician_email: currentTechnician.email,
                level: getCurrentTechnicianLevel(),
                help_type: helpType,
                help_description: helpDescription,
                urgency: urgency || 'media'
            };
            
            sendActionToWebhook(payload);
            document.getElementById('ayudaModal').classList.remove('active');
        }
        
        // Solicitar asignaciÃ³n
        function showSolicitarAsignacionModal(incidentId) {
            currentIncidentId = incidentId;
            document.getElementById('solicitarAsignacionModal').classList.add('active');
        }

        function confirmSolicitarAsignacion() {
            const requestReason = document.getElementById('requestReason').value;
            const requestJustification = document.getElementById('requestJustification').value;
            
            if (!requestReason || !requestJustification) {
                alert('Motivo y justificaciÃ³n son obligatorios');
                return;
            }
            
            const payload = {
                action: 'solicitar_asignacion',
                incident_id: currentIncidentId,
                technician_email: currentTechnician.email,
                level: getCurrentTechnicianLevel(),
                request_reason: requestReason,
                request_justification: requestJustification
            };
            
            sendActionToWebhook(payload);
            document.getElementById('solicitarAsignacionModal').classList.remove('active');
        }

        
        // Inicializar al cargar la pÃ¡gina
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableMaterials();
        });

                /* ========================================
           FUNCIONES DE EVENTOS GLOBALES
        ======================================== */
        document.addEventListener('DOMContentLoaded', initializeApp);
        // ExposiciÃ³n de funciones globalmente
        window.loginWithPIN = loginWithPIN;
        window.refreshDashboard = refreshDashboard;
        window.filterByStatus = filterByStatus;
        window.filterByPriority = filterByPriority;
        window.handleAction = handleAction;
        window.toggleEscalationHistory = toggleEscalationHistory;
        window.closeReasonModal = closeReasonModal;
        window.closePINModal = closePINModal;
        window.confirmAction = confirmAction;
        window.selectReason = selectReason;
        window.updateCompletionText = updateCompletionText;
        window.verifyPIN = verifyPIN;
        window.addMaterial = addMaterial;
        window.confirmMateriales = confirmMateriales;
        window.removeMaterial = removeMaterial;
        window.showSolicitarMaterialesModal = showSolicitarMaterialesModal;
        window.closeSolicitarMaterialesModal = closeSolicitarMaterialesModal;
        window.addMaterialRequest = addMaterialRequest;
        window.removeRequestedMaterial = removeRequestedMaterial;
        window.confirmSolicitudMateriales = confirmSolicitudMateriales;
        window.showResolverModal = showResolverModal;
        window.closeResolverModal = closeResolverModal;
        window.showDerivarModal = showDerivarModal;
        window.confirmDerivarDepartamento = confirmDerivarDepartamento;
        window.showAyudaModal = showAyudaModal;
        window.confirmSolicitarAyuda = confirmSolicitarAyuda;
        window.showSolicitarAsignacionModal = showSolicitarAsignacionModal;
        window.confirmSolicitarAsignacion = confirmSolicitarAsignacion;
        window.toggleContacts = toggleContacts;

        console.log('ð§ Dashboard ABC.xyz - VersiÃ³n Completa Reorganizada cargada');
       
        if (typeof refreshInterval !== 'undefined' && refreshInterval) {
            clearInterval(refreshInterval);
            console.log('ð§¹ Interval de auto-refresh limpiado');
        }
        
      
    </script>
</body>
</html>   
