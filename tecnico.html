<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/favicon.ico">
    <title>Dashboard Técnico - Sistema de Incidencias ABC.xyz</title>
    <style>
        /* ========================================
           VARIABLES CSS Y RESET
        ======================================== */
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2c3e50;
        
            --success-color: #22c55e;
            --success-dark: #16a34a;
        
            --warning-color: #f59e0b;
            --warning-dark: #d97706;
        
            --danger-color: #ef4444;
            --danger-dark: #dc2626;
        
            --info-color: #3b82f6;
            --info-dark: #2563eb;
        
            --purple-color: #6f42c1;
            --purple-dark: #5a2d91;
        
            /* Escala de grises completa */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
        
            /* Radius y sombras */
            --border-radius: 12px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.15);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
        
            --transition: all 0.3s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-800);
        }

        /* ========================================
           LOGIN COMPONENTS
        ======================================== */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow-md);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .input-group { margin-bottom: 20px; text-align: left; }

        .input-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--gray-800);
        }

        .input-field {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .verify-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .verify-btn:hover { transform: translateY(-2px); }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
        }

        .hidden { display: none !important; }

        /* ========================================
           DASHBOARD COMPONENTS
        ======================================== */
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px 0;
            box-shadow: var(--shadow-md);
        }

        .header-content {
            max-width: 1120px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo { font-size: 24px; font-weight: 700; }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .tech-name {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .user-meta {
            display: flex;
            gap: 8px;
            font-size: 14px;
            opacity: 0.9;
        }

        .refresh-button {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .refresh-button:hover { background: rgba(255, 255, 255, 0.25); }

        /* ========================================
           MAIN CONTAINER
        ======================================== */
       .main-container{
          max-width:1120px;
          margin:0 auto;
          padding:30px 20px 20px; /* 30px top ya cubre el 24px del pulido */
        }

       .stats-bar {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 20px;
          margin-bottom: 30px;
        }
        @media (max-width: 900px) {
          .stats-bar { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 600px) {
          .stats-bar { grid-template-columns: 1fr; }
        }


        .stat-card {
            background: white;
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .stat-card:hover { transform: translateY(-2px); }
        .stat-card.active { border-color: var(--primary-color); }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-number.pending { color: var(--warning-color); }
        .stat-number.working { color: var(--info-color); }
        .stat-number.seguimiento { color: #6b7280; }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        /* ========================================
           INCIDENTS SECTION
        ======================================== */
        .section-header h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-800);
        }
        
        /* Encabezado de tarjeta */
        .incident-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
       .incident-header-right{
          text-align:right;
          display:flex;
          flex-direction:column;
          gap:6px;
          align-items:flex-end;
        }
        .incident-header-right .state-sla{
          display:flex;
          flex-wrap: nowrap;
          gap:6px;
          justify-content:flex-end;
          align-items:center;
        }
        .badge{ padding:2px 6px; border-radius:999px; font-size:12px; font-weight:600; color:white; }
        .badge-notes{ background:#3b82f6; }
        .badge-escalations{ background:#f59e0b; }
        .badge-solicitudes{ background:#10b981; }
        .incident-title {
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 16px;
          font-weight: 600;
          color: var(--gray-800);
        }
        .inc-title-id {
          max-width: 360px;          /* ajusta si quieres más/menos */
          overflow: hidden;
          white-space: nowrap;
          text-overflow: ellipsis;
        }
        @media (max-width: 640px){
          .inc-title-id { max-width: 220px; }
        }

        .priority-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-critica { background: #fee2e2; color: #dc2626; }
        .priority-alta { background: #fed7aa; color: #ea580c; }
        .priority-media { background: #fef3c7; color: #d97706; }
        .priority-baja { background: #dcfce7; color: #16a34a; }
        
        /* Metas, badges, estados */
        .incident-meta {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }
      .state-badge {
          background: #eef2ff;
          color: #1e40af;
          border-radius: 999px;
          padding: 4px 10px;
          font-size: 12px;
          font-weight: 700;
        }
        .sla-timer{
          display:inline-flex;
          align-items:center;
          font-size:18px;
          padding:10px 16px;
          border-radius:12px;
          background:#fff7ed;
          color:#7c2d12;
          font-weight:600;
          display:inline-flex;
          align-items:center;
          white-space:nowrap;
        }
        @keyframes blink {
          0% { opacity: 1; }
          50% { opacity: 0.6; }
          100% { opacity: 1; }
        }
        .sla-timer.active {
          animation: blink 1.8s ease-in-out infinite;
        }
        .sla-good{ background:#16a34a; color:#ffffff; }
        .incident-banner{
          width:100%;
          display:block;
          margin-bottom:6px;
        }
        .seguimiento-banner{
          display:block;
          margin:10px 0;
          padding:8px 12px;
          border-radius:10px;
          border:1px solid var(--gray-200);
          background:#fff7ed;
          color:#7c2d12;
          box-shadow:var(--shadow-sm);
          font-size:14px;
          font-weight:600;
        }
        .sla-warning{ background:#d97706; color:#ffffff; }
        .sla-critical{ background:#dc2626; color:#ffffff; }
        
        .materials-badge{
          display:inline-block;
          padding:6px 10px;
          border-radius:999px;
          font-size:12px;
          font-weight:700;
          border:1px solid var(--gray-200);
          white-space: nowrap;
        }
        .materials-ok{ background:#e6f7ee; color:#166534; border-color:#a7f3d0; }
        .materials-pending{ background:#fff8e5; color:#92400e; border-color:#fde68a; }

        .materials-table{
          width:100%;
          border-collapse: collapse;
          font-size:14px;
        }
        .materials-table th,
        .materials-table td{
          border:1px solid var(--gray-200);
          padding:8px 10px;
          text-align:left;
          vertical-align: middle;
        }
        .materials-table th{ background: var(--gray-100); font-weight:700; }
        .materials-table td.num{ text-align:right; }
        .materials-table td.nowrap{ white-space:nowrap; }
        .materials-table td.ellipsis{ max-width:280px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }


        .chips{ display:flex; flex-wrap:nowrap; gap:6px; overflow-x:auto; scrollbar-width:thin; }

        .req-chips{display:flex;align-items:center;flex-wrap:wrap;gap:8px;max-height:calc(2 * 34px);overflow-y:auto;scrollbar-width:thin;}
        .chips::-webkit-scrollbar,
        .req-chips::-webkit-scrollbar{ height:6px; }
        .chips::-webkit-scrollbar-thumb,
        .req-chips::-webkit-scrollbar-thumb{ background:var(--gray-300); border-radius:999px; }
        .chips::-webkit-scrollbar-track,
        .req-chips::-webkit-scrollbar-track{ background:transparent; }

        .req-chip{
          padding:6px 10px;
          border-radius:9999px;
          border:1px solid #e5e7eb;
          font-weight:600;
          background:#f9fafb;
          box-shadow: 0 1px 0 rgba(0,0,0,.04);
        }
        .req-chip.approved{background:#e8f5e9;border-color:#c8e6c9;}
        .req-chip.rejected{background:#ffebee;border-color:#ffcdd2;}
        .req-chip.pending{background:#fff8e1;border-color:#ffe0b2;}
        
        .chip-request{
          display:inline-flex;
          align-items:center;
          gap:6px;
          padding:6px 12px;
          border-radius:9999px;
          border:1px solid var(--gray-200);
          background:#ffffff;
          box-shadow: 0 1px 0 rgba(0,0,0,.06), 0 0 0 1px rgba(0,0,0,.03) inset;
          color:var(--gray-700);
          font-weight:600;
          font-size:13px;
          line-height:1.2;
          cursor:default;
          white-space:nowrap;
          transition:var(--transition);
        }

        .chip-request.cat-material {
          background:#fff7ed;
          border-color:#f97316;
          color:#9a3412;
        }
        .chip-request.cat-apoyo {
          background:#ecfeff;
          border-color:#22d3ee;
          color:#0e7490;
        }
        .chip-request.cat-derivacion {
          background:#eff6ff;
          border-color:#60a5fa;
          color:#1d4ed8;
        }
        .chip-request.cat-traspaso {
          background:#f5f3ff;
          border-color:#a855f7;
          color:#6b21a8;
        }
        .chip-request.cat-reasignacion {
          background:#fdf2f8;
          border-color:#f472b6;
          color:#9d174d;
        }
        .chip-request:hover{background:var(--gray-100);}
        .chip-request:focus{outline:none;box-shadow:0 0 0 2px rgba(52,152,219,0.2);}

        .state-pending { background: #fef3c7; color: #92400e; }
        .state-working { background: #dbeafe; color: #1e40af; }
        .state-seguimiento { background: #f3f4f6; color: #6b7280; }

        /* Botones */
        .incident-actions {
            margin-top: auto;
        }

        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .receiver-actions-wrapper {
            flex-basis: 100%;
            width: 100%;
            order: 10;
            margin-top: 8px;
            background: #f8fafc;
            border: 1px solid rgba(37, 99, 235, 0.15);
            border-radius: 10px;
            padding: 12px 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .receiver-actions-wrapper.blink {
            animation: blink 1.2s ease-in-out infinite;
            box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.15);
            border-color: rgba(220, 38, 38, 0.35);
        }

        .receiver-actions-wrapper.expired {
            background: #fef2f2;
            border-color: rgba(220, 38, 38, 0.45);
        }

        .receiver-actions-wrapper.expired .countdown {
            color: #b91c1c;
        }

        .receiver-actions-wrapper .countdown {
            font-variant-numeric: tabular-nums;
            font-weight: 600;
        }

        .receiver-actions-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .receiver-action-item {
            background: #ffffff;
            border-radius: 8px;
            padding: 10px 12px;
            box-shadow: inset 0 0 0 1px rgba(37, 99, 235, 0.12);
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-start;
        }

        .receiver-action-main {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            flex: 1 1 220px;
        }

        .receiver-action-icon {
            font-size: 20px;
            line-height: 1;
        }

        .receiver-action-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .receiver-action-label {
            font-weight: 600;
            color: var(--gray-800);
            font-size: 14px;
        }

        .receiver-action-detail {
            font-size: 13px;
            color: var(--gray-600);
        }

        .receiver-action-meta {
            font-size: 12px;
            color: var(--gray-500);
        }

        .receiver-action-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .receiver-action-buttons .btn {
            font-size: 12px;
            padding: 6px 10px;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:disabled {
            background: var(--gray-300);
            color: var(--gray-500);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }

        .btn-success { background: var(--success-color); color: white; }
        .btn-success:hover { background: var(--success-dark); }

        .btn-danger { background: var(--danger-color); color: white; }
        .btn-danger:hover { background: var(--danger-dark); }

        .btn-warning { background: var(--warning-color); color: white; }
        .btn-warning:hover { background: var(--warning-dark); }

        .btn-info { background: var(--info-color); color: white; }
        .btn-secondary { background: #6b7280; color: white; }

        .btn-help { background: var(--warning-color); color: white; }
        .btn-help:hover { background: var(--warning-dark); }

        .btn-resource { background: var(--info-color); color: white; }
        .btn-resource:hover { background: var(--info-dark); }
        
        .btn-dark { background:#111827; color:#fff; }
        .btn-dark:hover { background:#0b1220; }

        .btn-purple { background: var(--purple-color); color: white; }
        .btn-purple:hover { background: var(--purple-dark); }

        /* ========================================
           MODAL COMPONENTS
        ======================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 24px 30px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-800);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            line-height: 1;
            cursor: pointer;
            color: var(--gray-500);
            transition: var(--transition);
        }

        .modal-close:hover { color: var(--gray-700); }

        .modal-body { padding: 24px 30px; }

        .modal-footer {
            padding: 20px 30px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        #materialesModal .mat-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(140px, 1fr));
            gap: 12px;
            align-items: end;
        }

        #materialesModal .mat-grid .form-group {
            margin-bottom: 0;
        }

        #materialesModal .mat-grid .mat-action {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        #materialesModal .mat-grid .mat-action .form-label {
            visibility: hidden;
            margin-bottom: 8px;
        }

        #materialesModal .mat-grid .mat-action .btn {
            width: 100%;
        }

        @media (max-width: 768px) {
            #materialesModal .mat-grid {
                grid-template-columns: repeat(2, minmax(160px, 1fr));
            }
        }

        .materials-table.compact th,
        .materials-table.compact td {
            padding: 6px 8px;
            font-size: 13px;
        }

        #matList .empty td {
            text-align: center;
            color: var(--gray-500);
        }

        #matList button[data-remove] {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: var(--danger-color);
        }

        #matList button[data-remove]:hover {
            color: var(--danger-dark);
        }

        .form-group { margin-bottom: 20px; }

        .no-link {
            color: var(--gray-500);
            margin: 8px 0;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--gray-800);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .reason-option {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .reason-option:hover { border-color: var(--primary-color); }
        .reason-option.selected { border-color: var(--primary-color); background: #f0f9ff; }

        .reason-icon { font-size: 20px; margin-right: 12px; }

        .no-incidents-icon { font-size: 48px; margin-bottom: 16px; color: var(--gray-400); }

        /* ========================================
           RESPONSIVE DESIGN
        ======================================== */
        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 16px; }
            .user-info { flex-direction: column; gap: 8px; align-items: flex-start; }
            .incident-header { flex-direction: column; gap: 12px; }
            .incident-actions { justify-content: center; }
            .modal { width: 95%; }
        }
        /* ========================================
           MODAL DE AYUDA / GESTIÓN - TARJETAS
        ======================================== */
        .ayuda-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }
        
        .ayuda-card {
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: var(--transition);
            background: white;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .ayuda-card:hover {
            border-color: var(--primary-color);
            background: var(--gray-50);
        }
        
        .ayuda-card.selected {
            border-color: var(--primary-color);
            background: #eff6ff;
        }
        
        .ayuda-extra {
            margin-top: 12px;
            display: none;
        }
        
        .ayuda-extra.active {
            display: block;
        }
        /* ========================================
           MODAL DE REFERENCIAS
        ======================================== */
        .referencias-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
       
        /* Modales grandes (Solicitar ayuda / Materiales) */
        .modal.large-modal { max-width: 900px; }
        
       /* Masonry definitivo */
        .incident-card{
          display:flex;
          flex-direction:column;
          margin:0 0 16px;
          border:1px solid #e5e7eb;
          border-radius:12px;
          padding:16px 18px;
          background:#fff;
          box-shadow:var(--shadow-sm);
        }
        .incident-card:hover{ background:#fafafa; }
        .incidents-list{
          display:grid;
          grid-template-columns: repeat(2, minmax(340px, 1fr));
          gap:16px;
          padding:0 12px 18px;
        }
        @media (max-width: 1100px){
          .incidents-list{ grid-template-columns: 1fr; }
        }
        
        .incident-card{ display:flex; flex-direction:column; }

    
        /* Densidad y micro-ajustes */
        .incident-title{ font-size:16px; margin-bottom:2px; }
        .incident-meta{ gap:10px; font-size:12px; margin-bottom:10px; }
        
        /* Chips y badges */
        .chip{ background:#f3f4f6; border-radius:999px; padding:4px 10px; font-size:12px; white-space:nowrap; }
        .priority{ font-weight:600; }
        .chip-small{ font-size:11px; padding:2px 8px; }
        .chip-muted{ background:#f3f4f6; color:#374151; border:1px solid #e5e7eb; }
        .chip-approved{ background:#e8f5e9; color:#166534; border:1px solid #a7f3d0; }
        .chip-warning{ background:#fffbea; color:#92400e; border:1px solid #fde68a; }

        
        /* Descripción y detalles */
        .section-title{
          display:block; margin:8px 0 4px;
          font-size:13px; font-weight:600;
        }
        .section-text,
        .actions-taken{
          margin:8px 0 10px; font-size:14px; color:#374151;
          overflow-wrap:anywhere; word-break:break-word;
        }
        details{ border-top:1px dashed #e5e7eb; margin-top:10px; padding-top:10px; }
        details > summary{ cursor:pointer; list-style:none; font-weight:600; display:flex; align-items:center; gap:8px; }
        .notes-summary .badge{ margin-left:auto; }
        .detail-grid{
          display:grid;
          grid-template-columns:1fr 1fr;
          gap:12px;
          margin-top:8px;
          font-size:13px;
          color:#374151;
          grid-template-columns: minmax(0,1fr) minmax(0,1fr);
        }
        .muted{ color:#6b7280; }
        .log{ white-space:pre-line; background:#f9fafb; border-radius:8px; padding:8px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; }
        
        /* Lista tipo timeline */
        .timeline{display:flex;flex-direction:column;gap:6px;margin:6px 0;}
        .timeline li{display:flex;gap:8px;align-items:center;
                     padding:6px 8px;border-radius:8px;white-space:nowrap;overflow:hidden;}
        .timeline .t-time{flex:0 0 130px;color:#6b7280;}
        .timeline .t-body{flex:1 1 auto;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .timeline .note-item .t-body{white-space:normal;max-height:120px;overflow:auto;}
        .note-author{display:inline-flex;gap:6px;align-items:center;font-weight:600;}
        .timeline li.level-0{ border-left:4px solid #6366f1; }
        .timeline li.level-1{ border-left:4px solid #3b82f6; }
        .timeline li.level-2{ border-left:4px solid #f59e0b; }
        .timeline li.level-3{ border-left:4px solid #ef4444; }
        .timeline li.phase-approved{ background:#eafaf1; border-left:4px solid #10b981; }
        .timeline li.phase-rejected{ background:#fdecea; border-left:4px solid #ef4444; }
        .timeline li.phase-request, .timeline li.phase-pending{ background:#fffbea; border-left:4px solid #f59e0b; }
        .timeline li.phase-transfer{ background:#e0f2fe; border-left:4px solid #9ca3af; }
        .timeline li.phase-derivation{ background:#ede9fe; border-left:4px solid #9ca3af; }
        .timeline li.phase-support{ background:#f1f5f9; border-left:4px solid #6b7280; }
        .timeline li.phase-unassign{ background:#f3f4f6; border-left:4px solid #9ca3af; }
        .timeline li.phase-reassign{ background:#f3f4f6; border-left:4px solid #9ca3af; }
        
        /* --- CONTACTOS: enlaces de teléfono sin “pill” y sin solapes --- */
        
        /* fuerza que las etiquetas del bloque contactos no colisionen con el teléfono */
        .contact-row {
          display: flex;
          flex-wrap: wrap;
          align-items: baseline;
          gap: 8px;
        }
        .contact-row .label {
          flex: 0 0 auto;
          font-weight: 700;
        }
        .contact-row .value {
          flex: 1 1 auto;
          min-width: 0;             /* habilita ellipsis dentro */
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .contact-card{
          background:#fff;
          border:1px solid var(--gray-200);
          border-radius:8px;
          padding:8px 12px;
          display:flex;
          flex-direction:column;
          gap:4px;
        }

        .contact-card .contact-title{
          font-weight:600;
          margin-bottom:4px;
          display:flex;
          align-items:center;
          gap:4px;
        }

        .btn-tel{
          display:inline-block;
          margin-left:4px;
          padding:2px 6px;
          border-radius:4px;
          background:var(--primary-color);
          color:#fff;
          text-decoration:none;
          font-size:12px;
        }
        
        /* ==== Pulido de contenedor y alineaciones ==== */
        .incidents-section{ background:#fff; border-radius:12px; box-shadow:var(--shadow-sm); margin-top:8px; }
        .section-header{ background:transparent; padding:20px 24px 8px; box-shadow:none; border-radius:12px; }
        
        
        /* ==== IDs largas seguras ==== */
        .incident-title .incident-id {
          font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
          font-weight: 700;
          overflow-wrap: anywhere;     /* permite cortar en cualquier punto seguro */
          word-break: break-word;      /* evita que rompa el layout */
        }
        
        /* ==== Barrita SLA fija arriba ==== */ /* SLA sticky */
        .sla-sticky {
          position: sticky; top: 0; z-index: 40;
          backdrop-filter: blur(6px);
          background: rgba(255,255,255,0.8);
          border-bottom: 1px solid var(--gray-200);
          display: flex; justify-content: center; gap:12px; align-items:center;
          padding: 10px 14px;
        }
        .sla-sticky .badge {
          font-weight: 700;
          font-size: 12px;
          padding: 6px 10px;
          border-radius: 999px;
          display: inline-flex;
          align-items: center;
          gap: 6px;
          background: #fff;
          color: var(--gray-700);
          border: 1px solid var(--gray-300);
        }
        .sla-sticky .badge.sla-good {
          background: #16a34a;
          color: #fff;
          border-color: transparent;
        }
        .sla-sticky .badge.sla-warning {
          background: #d97706;
          color: #fff;
          border-color: transparent;
        }
        .sla-sticky .badge.sla-critical {
          background: #dc2626;
          color: #fff;
          border-color: transparent;
        }
        .sla-sticky .badge.active {
          animation: blink 1.2s ease-in-out infinite;
    
        }
        .sla-sticky .cta {
          padding:8px 12px; border-radius:8px; border:0; cursor:pointer;
          background: var(--primary-color); color:#fff; font-weight:600;
        }
        
         /* ==== Tarjetas/errores ==== */
        .loading-spinner, .error-card {
          background:#fff; border-radius:12px; box-shadow:var(--shadow-sm);
        }

        .error-card {
          background: #fee2e2;
          color: var(--danger-dark);
          border: 1px solid var(--danger-dark);
          border-radius:12px;
          box-shadow:var(--shadow-sm);
          padding:24px;
          margin:12px;
          text-align:center;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .no-incidents {
          background:#fff;
          border-radius:12px;
          box-shadow:var(--shadow-sm);
          padding:24px;
          margin:12px;
          text-align:center;
          color:var(--gray-600);
        }
        .no-incidents h3 {
          font-size:20px;
          margin-bottom:8px;
          font-weight:600;
        }
        .no-incidents p {
          font-size:14px;
          color:var(--gray-500);
        }

        .retry-button {
          background: var(--danger-color);
          color: white;
          padding: 12px 20px;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          margin-top: 16px;
          transition: var(--transition);
        }

        .retry-button:hover { background: var(--danger-dark); }

        /* Toast notifications */
        .toast {
          position: fixed;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: var(--danger-color);
          color: #fff;
          padding: 12px 20px;
          border-radius: var(--border-radius);
          box-shadow: var(--shadow-md);
          opacity: 0;
          transition: opacity 0.3s ease;
          z-index: 9999;
        }

        .toast.show {
          opacity: 1;
        }
        tr.row-ok td { background: #f0fdf4; }       
        tr.row-warn td { background: #fffbea; }     

    </style>
</head>
<body>
    <!-- LOGIN CONTAINER -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <h1 class="login-title">🔧 Dashboard Técnico</h1>
            <p class="login-subtitle">Sistema de Incidencias ABC.xyz</p>

            <div class="input-group">
                <label class="input-label" for="emailInput">Email corporativo</label>
                <input type="email" id="emailInput" class="input-field" placeholder="tecnico@abc.xyz" autocomplete="email">
            </div>
            <button class="verify-btn" id="loginBtn" type="button">Acceder con PIN</button>
            <div id="loginError" class="error-message hidden">
                Error de autenticación. Verifica tus credenciales.
            </div>
        </div>
    </div>

    <!-- DASHBOARD PRINCIPAL -->
    <div id="dashboardContainer" class="hidden">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">🔧 Dashboard Técnico - Sistema ABC.xyz</div>
                <div class="user-info">
                   <div class="user-details">
                        <div id="technicianName" class="tech-name">Cargando técnico...</div>
                        <div class="user-meta">
                            <span id="userEmail">usuario@abc.xyz</span>
                            <span id="userRole">Técnico L0</span>
                        </div>
                    </div>
                    <button class="refresh-button" onclick="refreshDashboard()">🔄 Actualizar</button>
                </div>
            </div>
        </header>

        <!-- Main Container -->
        <main class="main-container">
            <!-- Stats Bar -->
            <section class="stats-bar">
                <div class="stat-card active" onclick="filterByStatus('all', this)">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card" onclick="filterByStatus('pending', this)">
                    <div class="stat-number pending" id="pendingCount">0</div>
                    <div class="stat-label">Pendientes</div>
                </div>
                <div class="stat-card" onclick="filterByStatus('working', this)">
                    <div class="stat-number working" id="workingCount">0</div>
                    <div class="stat-label">Trabajando</div>
                </div>
                <div class="stat-card" onclick="filterByStatus('seguimiento', this)">
                    <div class="stat-number seguimiento" id="seguimientoCount">0</div>
                    <div class="stat-label">Seguimiento</div>
                </div>
            </section>
      
            <!-- Incidents Section -->
           <section class="incidents-section">
              <div class="section-header">
                <h2>📋 Incidencias Asignadas</h2>
              </div>
              <!-- Barrita SLA sticky -->
              <div id="slaSticky" class="sla-sticky hidden"></div>
            
              <div class="section-body">
                <div id="incidentsContainer">
                  <div class="loading-spinner">🔄 Cargando incidencias...</div>
                </div>
                <div class="incidents-list"></div>
              </div>
            </section>
        </main>
    </div>

    <!-- ========================================
         MODALES
    ======================================== -->

    <!-- Modal de Motivo Rechazo -->
    <div id="reasonModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">❌ Motivo del Rechazo</h3>
                <button class="modal-close" onclick="closeModal('reasonModal')">×</button>
            </div>
            <div class="modal-body">
                <div id="reasonOptions"></div>
                <div class="form-group">
                    <label for="customReasonText" class="form-label">Descripción adicional (opcional):</label>
                    <textarea id="customReasonText" class="form-control" rows="3" placeholder="Proporciona más detalles si es necesario..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('reasonModal')">Cancelar</button>
                <button id="confirmBtn" class="btn btn-danger" onclick="confirmAction()">Confirmar Rechazo</button>
            </div>
        </div>
    </div>

    <!-- Modal de Resolución -->
    <div id="resolverModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3>🔧 Resolver Incidencia</h3>
                <button class="modal-close" onclick="closeModal('resolverModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="solutionDescription" class="form-label">Descripción de la solución:</label>
                    <textarea id="solutionDescription" class="form-control" rows="4" placeholder="Describe detalladamente cómo se resolvió la incidencia..." required></textarea>
                </div>
                <div class="form-group" id="materialesResultadoSection">
                    <label class="form-label">📦 Materiales solicitados:</label>
                    <div id="materialesResultadoWrapper"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('resolverModal')">Cancelar</button>
                <button id="resolverSubmitBtn" class="btn btn-primary" onclick="confirmResolver()" disabled>🔧 Resolver Incidencia</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Recursos de referencia -->
    <div id="referenciasModal" class="modal-overlay hidden">
        <div class="modal large-modal">
            <div class="modal-header">
                 <h3 class="modal-title">📚 Recursos de referencia</h3>
                <button class="modal-close" onclick="closeModal('referenciasModal')">×</button>
            </div>
            <div class="modal-body">
                <div id="referenciasList" class="referencias-options"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('referenciasModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Solicitar Materiales -->
    <div id="materialesModal" class="modal-overlay hidden">
    <div class="modal large-modal">
            <div class="modal-header">
                <h3 class="modal-title">📦 Solicitar materiales</h3>
                <button class="modal-close" onclick="closeModal('materialesModal')">×</button>
            </div>
           <div class="modal-body">
                <div class="mat-grid">
                    <div class="form-group">
                        <label for="matFamily" class="form-label">Familia</label>
                        <select id="matFamily" class="form-control">
                            <option value="">Todas las familias</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="matSearch" class="form-label">Material</label>
                        <input id="matSearch" class="form-control" list="matOptions" placeholder="Busca por nombre o código">
                        <datalist id="matOptions"></datalist>
                    </div>
                    <div class="form-group">
                        <label for="matCode" class="form-label">Código</label>
                        <input id="matCode" class="form-control" placeholder="Selecciona un material">
                    </div>
                    <div class="form-group">
                        <label for="matUnit" class="form-label">Unidad</label>
                        <input id="matUnit" class="form-control" placeholder="Ej: ud">
                    </div>
                    <div class="form-group">
                        <label for="matQty" class="form-label">Cantidad</label>
                        <input type="number" id="matQty" class="form-control" min="0" step="0.01" placeholder="0">
                    </div>
                    <div class="form-group mat-action">
                        <label class="form-label">&nbsp;</label>
                        <button id="addMat" class="btn btn-secondary" type="button" disabled>+ Añadir</button>
                    </div>
                </div>
            <table id="matList" class="materials-table compact">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Unidad</th>
                            <th>Cantidad</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="empty">
                            <td colspan="4">Sin materiales añadidos.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('materialesModal')">Cancelar</button>
                <button id="sendMatReq" class="btn btn-success" disabled>✅ Enviar solicitud</button>
            </div>
        </div>
    </div>


        <!-- Modal de Solicitar ayuda -->
        <div id="ayudaModal" class="modal-overlay hidden">
            <div class="modal large-modal">
                <div class="modal-header">
                    <h3 class="modal-title">🛠️ Solicitar ayuda</h3>
                    <button class="modal-close" onclick="closeModal('ayudaModal')">×</button>
                </div>
                <div class="modal-body">
                    <!-- Opciones principales como tarjetas -->
                    <div class="ayuda-options" id="ayudaOptions">
                        <!-- Se generarán dinámicamente con JS -->
                    </div>
        
                    <!-- Contenedor de campos adicionales -->
                    <div id="ayudaExtraFields"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('ayudaModal')">Cancelar</button>
                    <button class="btn btn-warning" onclick="procesarAyuda()">🛠️ Continuar</button>
                </div>
            </div>
        </div>
    <script id="inventory-seed" type="application/json">
        [
  {"code":"BCT","name":"Bomba centrífuga","unit":"ud","consumo":"Reutilizable","family":"Bombas y Repuestos"},
  {"code":"BSM","name":"Bomba sumergible","unit":"ud","consumo":"Reutilizable","family":"Bombas y Repuestos"},
  {"code":"BAQ","name":"Bomba de achique","unit":"ud","consumo":"Reutilizable","family":"Bombas y Repuestos"},
  {"code":"BDS","name":"Bomba dosificadora","unit":"ud","consumo":"Reutilizable","family":"Bombas y Repuestos"},
  {"code":"SLM-A","name":"Sello mecánico Bomba tipo A","unit":"ud","consumo":"Consumible","family":"Bombas y Repuestos"},
  {"code":"SLM-B","name":"Sello mecánico Bomba tipo B","unit":"ud","consumo":"Consumible","family":"Bombas y Repuestos"},
  {"code":"RDT-150","name":"Rodete Ø150 mm","unit":"ud","consumo":"Consumible","family":"Bombas y Repuestos"},
  {"code":"RDT-200","name":"Rodete Ø200 mm","unit":"ud","consumo":"Consumible","family":"Bombas y Repuestos"},
  {"code":"VRT-100","name":"Válvula de retención DN100","unit":"ud","consumo":"Consumible","family":"Válvulas y Accesorios de Maniobra"},
  {"code":"VCP-50","name":"Válvula de compuerta DN50","unit":"ud","consumo":"Consumible","family":"Válvulas y Accesorios de Maniobra"},
  {"code":"VCP-100","name":"Válvula de compuerta DN100","unit":"ud","consumo":"Consumible","family":"Válvulas y Accesorios de Maniobra"},
  {"code":"VES-25","name":"Válvula de esfera DN25","unit":"ud","consumo":"Consumible","family":"Válvulas y Accesorios de Maniobra"},
  {"code":"VES-50","name":"Válvula de esfera DN50","unit":"ud","consumo":"Consumible","family":"Válvulas y Accesorios de Maniobra"},
  {"code":"VMP","name":"Válvula de mariposa","unit":"ud","consumo":"Consumible","family":"Válvulas y Accesorios de Maniobra"},
  {"code":"ACT-100","name":"Actuador eléctrico válvula DN100","unit":"ud","consumo":"Consumible","family":"Válvulas y Accesorios de Maniobra"},
  {"code":"CDO-50","name":"Codo PVC Ø50","unit":"ud","consumo":"Consumible","family":"Tuberías y Accesorios Hidráulicos"},
  {"code":"CDO-100","name":"Codo PVC Ø100","unit":"ud","consumo":"Consumible","family":"Tuberías y Accesorios Hidráulicos"},
  {"code":"TEE-50","name":"Tee PVC Ø50","unit":"ud","consumo":"Consumible","family":"Tuberías y Accesorios Hidráulicos"},
  {"code":"BRD-100","name":"Brida DN100","unit":"ud","consumo":"Consumible","family":"Tuberías y Accesorios Hidráulicos"},
  {"code":"JNT-50","name":"Junta plana DN50","unit":"ud","consumo":"Consumible","family":"Tuberías y Accesorios Hidráulicos"},
  {"code":"JNT-100","name":"Junta plana DN100","unit":"ud","consumo":"Consumible","family":"Tuberías y Accesorios Hidráulicos"},
  {"code":"ABR-50","name":"Abrazadera Ø50","unit":"ud","consumo":"Consumible","family":"Tuberías y Accesorios Hidráulicos"},
  {"code":"ABR-100","name":"Abrazadera Ø100","unit":"ud","consumo":"Consumible","family":"Tuberías y Accesorios Hidráulicos"},
  {"code":"FLC-5M","name":"Cartucho filtrante 5 micras","unit":"ud","consumo":"Consumible","family":"Filtración y Membranas"},
  {"code":"FLC-20M","name":"Cartucho filtrante 20 micras","unit":"ud","consumo":"Consumible","family":"Filtración y Membranas"},
  {"code":"BFL-1","name":"Bolsa filtrante Nº1","unit":"ud","consumo":"Consumible","family":"Filtración y Membranas"},
  {"code":"MOI-4040","name":"Membrana ósmosis inversa 4040","unit":"ud","consumo":"Consumible","family":"Filtración y Membranas"},
  {"code":"MOI-8040","name":"Membrana ósmosis inversa 8040","unit":"ud","consumo":"Consumible","family":"Filtración y Membranas"},
  {"code":"ARN-25","name":"Arena de filtro (saco 25 kg)","unit":"ud","consumo":"Consumible","family":"Filtración y Membranas"},
  {"code":"CAB-25","name":"Carbón activo (saco 25 kg)","unit":"ud","consumo":"Consumible","family":"Filtración y Membranas"},
  {"code":"CDM-50","name":"Caudalímetro DN50","unit":"ud","consumo":"Consumible","family":"Instrumentación y Sensores"},
  {"code":"CDM-100","name":"Caudalímetro DN100","unit":"ud","consumo":"Consumible","family":"Instrumentación y Sensores"},
  {"code":"SNL-SUM","name":"Sonda de nivel sumidero","unit":"ud","consumo":"Consumible","family":"Instrumentación y Sensores"},
  {"code":"SNL-DEP","name":"Sonda de nivel depósito","unit":"ud","consumo":"Consumible","family":"Instrumentación y Sensores"},
  {"code":"SPR-10B","name":"Sensor de presión 0-10 bar","unit":"ud","consumo":"Consumible","family":"Instrumentación y Sensores"},
  {"code":"SPR-25B","name":"Sensor de presión 0-25 bar","unit":"ud","consumo":"Consumible","family":"Instrumentación y Sensores"},
  {"code":"PHM-STD","name":"Electrodo pH estándar","unit":"ud","consumo":"Consumible","family":"Instrumentación y Sensores"},
  {"code":"TRB","name":"Turbidímetro","unit":"ud","consumo":"Consumible","family":"Instrumentación y Sensores"},
  {"code":"CTC-32","name":"Contactor 32 A","unit":"ud","consumo":"Consumible","family":"Eléctrico y Control"},
  {"code":"CTC-63","name":"Contactor 63 A","unit":"ud","consumo":"Consumible","family":"Eléctrico y Control"},
  {"code":"FUS-10","name":"Fusible 10 A","unit":"ud","consumo":"Consumible","family":"Eléctrico y Control"},
  {"code":"FUS-25","name":"Fusible 25 A","unit":"ud","consumo":"Consumible","family":"Eléctrico y Control"},
  {"code":"RTM-40","name":"Relé térmico 25-40 A","unit":"ud","consumo":"Consumible","family":"Eléctrico y Control"},
  {"code":"VFD-2K","name":"Variador frecuencia 2.2 kW","unit":"ud","consumo":"Consumible","family":"Eléctrico y Control"},
  {"code":"VFD-7K","name":"Variador frecuencia 7.5 kW","unit":"ud","consumo":"Consumible","family":"Eléctrico y Control"},
  {"code":"PLC-IN16","name":"Módulo PLC I/O 16 entradas","unit":"ud","consumo":"Consumible","family":"Eléctrico y Control"},
  {"code":"PLC-OUT16","name":"Módulo PLC I/O 16 salidas","unit":"ud","consumo":"Consumible","family":"Eléctrico y Control"},
  {"code":"JTR-20","name":"Junta tórica Ø20","unit":"ud","consumo":"Consumible","family":"Consumibles y Material Auxiliar"},
  {"code":"JTR-50","name":"Junta tórica Ø50","unit":"ud","consumo":"Consumible","family":"Consumibles y Material Auxiliar"},
  {"code":"JTR-100","name":"Junta tórica Ø100","unit":"ud","consumo":"Consumible","family":"Consumibles y Material Auxiliar"},
  {"code":"LUB-1","name":"Lubricante graso (1 L)","unit":"l","consumo":"Consumible","family":"Consumibles y Material Auxiliar"},
  {"code":"LUB-5","name":"Lubricante graso (5 L)","unit":"l","consumo":"Consumible","family":"Consumibles y Material Auxiliar"},
  {"code":"TRN-M8-40","name":"Tornillo M8x40","unit":"ud","consumo":"Consumible","family":"Consumibles y Material Auxiliar"},
  {"code":"TRN-M12-60","name":"Tornillo M12x60","unit":"ud","consumo":"Consumible","family":"Consumibles y Material Auxiliar"},
  {"code":"TEF","name":"Cinta teflón","unit":"ud","consumo":"Consumible","family":"Consumibles y Material Auxiliar"},
  {"code":"SLC","name":"Silicona sellante","unit":"ud","consumo":"Consumible","family":"Consumibles y Material Auxiliar"},
  {"code":"EPI-GUA","name":"Guantes de protección","unit":"ud","consumo":"Reutilizable","family":"Seguridad y EPIs"},
  {"code":"EPI-GAF","name":"Gafas de seguridad","unit":"ud","consumo":"Reutilizable","family":"Seguridad y EPIs"},
  {"code":"EPI-MAS","name":"Mascarillas","unit":"ud","consumo":"Reutilizable","family":"Seguridad y EPIs"},
  {"code":"EPI-BOT","name":"Botas de seguridad","unit":"ud","consumo":"Reutilizable","family":"Seguridad y EPIs"},
  {"code":"EPI-CHA","name":"Chaleco reflectante","unit":"ud","consumo":"Reutilizable","family":"Seguridad y EPIs"},
  {"code":"EPI-CAS","name":"Casco de seguridad","unit":"ud","consumo":"Reutilizable","family":"Seguridad y EPIs"},
  {"code":"LLF-13","name":"Llave fija 13 mm","unit":"ud","consumo":"Reutilizable","family":"Herramientas y Útiles"},
  {"code":"LLF-17","name":"Llave fija 17 mm","unit":"ud","consumo":"Reutilizable","family":"Herramientas y Útiles"},
  {"code":"LLA-ING","name":"Llave inglesa","unit":"ud","consumo":"Reutilizable","family":"Herramientas y Útiles"},
  {"code":"LLA-TUB","name":"Llave de tubo","unit":"ud","consumo":"Reutilizable","family":"Herramientas y Útiles"},
  {"code":"ALI-UNI","name":"Alicates universales","unit":"ud","consumo":"Reutilizable","family":"Herramientas y Útiles"},
  {"code":"TEN-GRI","name":"Tenaza grip","unit":"ud","consumo":"Reutilizable","family":"Herramientas y Útiles"},
  {"code":"DES-PLA","name":"Destornillador plano","unit":"ud","consumo":"Reutilizable","family":"Herramientas y Útiles"},
  {"code":"DES-EST","name":"Destornillador estrella","unit":"ud","consumo":"Reutilizable","family":"Herramientas y Útiles"},
  {"code":"MAR-HER","name":"Martillo","unit":"ud","consumo":"Reutilizable","family":"Herramientas y Útiles"},
  {"code":"TAL-ELC","name":"Taladro eléctrico","unit":"ud","consumo":"Reutilizable","family":"Herramientas y Útiles"},
  {"code":"BRO-MET","name":"Brocas metálicas","unit":"ud","consumo":"Consumible","family":"Herramientas y Útiles"},
  {"code":"BRO-HOR","name":"Brocas hormigón","unit":"ud","consumo":"Reutilizable","family":"Herramientas y Útiles"},
  {"code":"SIE-MAN","name":"Sierra manual","unit":"ud","consumo":"Reutilizable","family":"Herramientas y Útiles"},
  {"code":"RAD-ELC","name":"Radial / amoladora","unit":"ud","consumo":"Reutilizable","family":"Herramientas y Útiles"},
  {"code":"DIS-MET","name":"Disco corte metálico","unit":"ud","consumo":"Consumible","family":"Herramientas y Útiles"},
  {"code":"DIS-PIE","name":"Disco corte piedra","unit":"ud","consumo":"Reutilizable","family":"Herramientas y Útiles"},
  {"code":"SOL-POR","name":"Soldadora portátil","unit":"ud","consumo":"Reutilizable","family":"Herramientas y Útiles"},
  {"code":"ELE-SOL","name":"Electrodo soldadura","unit":"ud","consumo":"Consumible","family":"Herramientas y Útiles"},
  {"code":"GUA-PRO","name":"Guantes protección","unit":"ud","consumo":"Reutilizable","family":"Seguridad y EPIs"},
  {"code":"GAF-SEG","name":"Gafas seguridad","unit":"ud","consumo":"Reutilizable","family":"Seguridad y EPIs"},
  {"code":"CAS-AUD","name":"Cascos auditivos","unit":"ud","consumo":"Reutilizable","family":"Seguridad y EPIs"},
  {"code":"HIP-SOD","name":"Hipoclorito sódico","unit":"l","consumo":"Consumible","family":"Químicos de Proceso"},
  {"code":"SUL-ALU","name":"Sulfato de aluminio","unit":"kg","consumo":"Consumible","family":"Químicos de Proceso"},
  {"code":"CL2-GAS","name":"Cloro gas","unit":"kg","consumo":"Consumible","family":"Químicos de Proceso"},
  {"code":"PAC-COA","name":"Policloruro de aluminio","unit":"kg","consumo":"Consumible","family":"Químicos de Proceso"},
  {"code":"CAL-VIV","name":"Cal viva","unit":"kg","consumo":"Consumible","family":"Químicos de Proceso"},
  {"code":"CAL-HID","name":"Cal hidratada","unit":"kg","consumo":"Consumible","family":"Químicos de Proceso"},
  {"code":"ACI-SUL","name":"Ácido sulfúrico","unit":"kg","consumo":"Consumible","family":"Químicos de Proceso"},
  {"code":"ACI-HCL","name":"Ácido clorhídrico","unit":"l","consumo":"Consumible","family":"Químicos de Proceso"},
  {"code":"ACI-NIT","name":"Ácido nítrico","unit":"l","consumo":"Consumible","family":"Químicos de Proceso"},
  {"code":"SOS-CAU","name":"Hidróxido sódico / sosa cáustica","unit":"l","consumo":"Consumible","family":"Químicos de Proceso"},
  {"code":"CAR-ACT","name":"Carbón activo granular","unit":"kg","consumo":"Consumible","family":"Químicos de Proceso"},
  {"code":"CAP-POW","name":"Carbón activo en polvo","unit":"kg","consumo":"Consumible","family":"Químicos de Proceso"},
  {"code":"POL-CAT","name":"Polielectrolito catiónico","unit":"kg","consumo":"Consumible","family":"Químicos de Proceso"},
  {"code":"POL-ANI","name":"Polielectrolito aniónico","unit":"kg","consumo":"Consumible","family":"Químicos de Proceso"},
  {"code":"ANT-ESP","name":"Antiespumante","unit":"l","consumo":"Consumible","family":"Químicos de Proceso"},
  {"code":"BIO-CID","name":"Biocida","unit":"l","consumo":"Consumible","family":"Químicos de Proceso"},
  {"code":"INH-COR","name":"Inhibidor de corrosión","unit":"l","consumo":"Consumible","family":"Químicos de Proceso"},
  {"code":"NEU-PH","name":"Neutralizante pH","unit":"l","consumo":"Consumible","family":"Químicos de Proceso"}
]

    </script>
    <script>
        // ========================================
        //  VARIABLES GLOBALES
        // ========================================
        let currentTechnician = null;
        let pendingAction = null;
        let selectedReason = null;
        let currentIncidentId = null;
        let inventory = null;
        let inventoryLoadedOk = false;
        let allIncidents = [];

        const MAX_LOG_ENTRIES = (() => {
            const v = Number(window?.MAX_LOG_ENTRIES);
            return Number.isFinite(v) ? v : Infinity;
        })();
        
         let loginEmail = '';
         let lastSeen = new Date(localStorage.getItem('lastSeen') || Date.now());

         async function callWebhook(action, data = {}) {
           const payload = {
               action,
               technician_email: data.technician_email || currentTechnician?.email,
               pin: data.pin || currentTechnician?.pin,
               ...data
           };
           return fetch('/api/webhook-respuesta', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify(payload)
           });
       }

        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        // Codifica texto en UTF-8 antes de aplicar base64
        function b64EncodeUnicode(str) {
            return btoa(encodeURIComponent(str));
        }
        
        function normalizeUnit(unit) {
            const map = {
                'metros': 'm',
                'metro': 'm',
                'm': 'm',
                'pieza': 'ud',
                'piezas': 'ud',
                'unidad': 'ud',
                'unidades': 'ud',
                'ud': 'ud',
                'kilogramo': 'kg',
                'kilogramos': 'kg',
                'kg': 'kg',
                'litro': 'l',
                'litros': 'l',
                'l': 'l'
            };
            return map[(unit || '').toLowerCase()] || unit;
        }

        async function loadInventoryLight(force = false) {
            if (!force && Array.isArray(inventory) && inventory.length) return inventory;
            const seed = document.getElementById('inventory-seed');
            if (seed) {
                try {
                    inventory = JSON.parse(seed.textContent).map(i => ({...i, unit: normalizeUnit(i.unit)}));
                } catch (err) {
                    console.error('Error al parsear inventario:', err);
                    inventory = [];
                    showToast('❌ Error cargando inventario local');
                }
            } else {
                inventory = [];
                showToast('❌ Error cargando inventario local');
            }
            return inventory;
        }

        function updateTechnicianHeader(technician) {
            const tech = technician || currentTechnician || {};
            const nameEl = document.getElementById('technicianName');
            const emailEl = document.getElementById('userEmail');
            const roleEl = document.getElementById('userRole');

            const email = tech.email || loginEmail || '';
            const department = tech.department || tech.departamento || tech.role || '';

            if (nameEl) nameEl.textContent = tech.name || tech.full_name || tech.nombre || '';
            if (emailEl) emailEl.textContent = email;
            if (roleEl) roleEl.textContent = department;
        }

        // ========================================
        //  VARIABLES PARA ACCESO DIRECTO
        // ========================================
        let directIncidentId = null;
        let directScrollDone = false;
        let pendingActionData = {};

        // ========================================
        //  AUTENTICACIÓN Y LOGIN
        // ========================================
        async function loginWithPIN() {
            const email = document.getElementById('emailInput').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            if (!email) {
                errorDiv.textContent = 'Ingresa tu email corporativo';
                errorDiv.classList.remove('hidden');
                return;
            }
            loginEmail = email;

            // Mostrar modal PIN
            showPINModal(email);
        }

        function showPINModal(email) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'pinModal';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>🔐 Verificación de Identidad</h3>
                    </div>
                    <div class="modal-body">
                        <p>Ingresa tu PIN de 4 dígitos para confirmar tu identidad:</p>
                        <div class="form-group">
                            <label class="form-label">PIN:</label>
                            <input type="password" id="pinInput" class="form-control" maxlength="4" inputmode="numeric" placeholder="••••" style="text-align: center; font-size: 18px; letter-spacing: 4px;">
                        </div>
                        <div id="pinError" class="error-message hidden"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closePINModal()">Cancelar</button>
                        <button class="btn btn-primary" id="verifyPinBtn" onclick="verifyPIN('${email}')" disabled>Verificar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const pinInput = document.getElementById('pinInput');
            const verifyBtn = document.getElementById('verifyPinBtn');
            
            pinInput.focus();
            
            pinInput.oninput = function() {
               this.value = this.value.replace(/\D/g, '').slice(0, 4);
               verifyBtn.disabled = this.value.length !== 4;
            };
            
            pinInput.onkeypress = function(e) {
                if (e.key === 'Enter' && this.value.length === 4) {
                    verifyPIN(email);
                }
                // Solo permitir números
                if (!/[0-9]/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'Tab') {
                    e.preventDefault();
                }
            };
        }

        async function verifyPIN(email) {
          const pin = document.getElementById('pinInput').value;
          const pinError = document.getElementById('pinError');
        
          if (pin.length !== 4) {
            showPINError('PIN debe tener 4 dígitos');
            return;
          }
        
          try {
            const resp = await callWebhook('validate_pin', {
              technician_email: email,
              pin
            });
        
            const raw = await resp.text();
            let data;
            try { data = JSON.parse(raw); } catch { data = { status: 'error', message: raw.slice(0, 200) }; }
            if (resp.ok && data.status === 'success') {
              currentTechnician = data.technician || {};
              currentTechnician.pin = pin;
              currentTechnician.authenticated = true;
              if (!currentTechnician.email) currentTechnician.email = loginEmail;
              updateTechnicianHeader(currentTechnician);
              document.getElementById('loginContainer').classList.add('hidden');
              document.getElementById('dashboardContainer').classList.remove('hidden');
              closePINModal();
              loadDashboard();
              showNotification('✅ Acceso autorizado', 'success');
            } else {
              showPINError(data.message || 'PIN incorrecto');
            }
          } catch (e) {
            console.error('Error verificando PIN:', e);
            showPINError('Error de conexión');
          }
        }

        function showPINError(message) {
            const pinError = document.getElementById('pinError');
            pinError.textContent = message;
            pinError.classList.remove('hidden');
        }

        function closePINModal() {
            const modal = document.getElementById('pinModal');
            if (modal) {
                modal.remove();
            }
        }

        // ========================================
        //  CARGA DE DATOS
        // ========================================
        async function loadDashboard() {
            if (!currentTechnician?.authenticated) return;
             updateTechnicianHeader(currentTechnician);

            showLoadingState();

            try {
                const response = await callWebhook('get_assigned_incidents');
                const raw = await response.text();
                 let data;
                 try {
                   data = JSON.parse(raw);
                 } catch {
                   throw new Error(`Respuesta no-JSON del servidor (${response.status}): ${raw.slice(0,200)}`);
                 }
                
                if (data.status === 'success' && data.incidents) {
                  // 1) Inventario primero
                  try {
                    const inv = await loadInventoryLight();
                    inventoryLoadedOk = Array.isArray(inv) && inv.length > 0;
                    if (!inventoryLoadedOk) {
                      showToast('❌ Inventario no disponible. Ingresa los datos manualmente.');
                    }
                  } catch (err) {
                    console.error('Error cargando inventario:', err);
                    inventoryLoadedOk = false;
                    showToast('❌ Inventario no disponible. Ingresa los datos manualmente.');
                  }
                
                  // 2) Incidencias y render (ya con inventoryLoadedOk listo)
                  allIncidents = data.incidents;
                  updateStatistics();
                  applyFiltersAndRender();
                  updateTechnicianHeader(currentTechnician);
                
                  // 3) Habilitar botones "📦 Materiales" en caliente si procede
                  document.querySelectorAll('button[aria-label="Solicitar materiales"]')
                    .forEach(btn => btn.disabled = false);
                  lastSeen = new Date();
                  localStorage.setItem('lastSeen', lastSeen.toISOString());
                } else {
                    let msg = data.message || 'Error al cargar incidencias';
                    const extras = [];
                    if (data.make_status) extras.push(`make_status: ${data.make_status}`);
                    if (data.body_snippet) extras.push(`body_snippet: ${data.body_snippet}`);
                    if (extras.length) msg += ` (Detalles: ${extras.join(' | ')})`;
                    throw new Error(msg);
                }
            } catch (error) {
                const errorId = new Date().toISOString();
                console.error('Error cargando dashboard:', error, 'ID:', errorId);
                showErrorState(`${error.message} (ID: ${errorId}). Puedes reintentar o contactar soporte con este identificador.`);
            }
        }

        function refreshDashboard() {
            loadDashboard();
        }

        // ========================================
        //  GESTIÓN DE ESTADOS Y FILTROS
        // ========================================
         function computeCycleState(incident, technicianEmail) {
          const email = String(technicianEmail || "").trim().toLowerCase();
          if (!incident || !email) return "seguimiento";

          const split = getSplitContext(incident);
          const currentResponses = Array.isArray(split?.current) ? split.current : [];
          const currBodies = currentResponses.map(entry => entry?.body || entry?.raw || "");
          const emailEscaped = escapeRegExp(email);
          const acceptedRegex = new RegExp(`RESP#L\\d#${emailEscaped}\\|ACCEPTED\\|`, "i");
          const assignedRegex = new RegExp(`RESP#L\\d#${emailEscaped}\\|ASSIGNED\\|`, "i");

          const acceptedByTech = currBodies.some(line => acceptedRegex.test(line));
          const assignedToTech = currBodies.some(line => assignedRegex.test(line));

          const requestEntries = split?.requests?.current || [];
          const requestText = requestEntries.map(entry => entry?.raw || "").filter(Boolean).join("\n");
          const pendingForTech = getPendingRequestsForTechnician(requestText, email) || [];
          const hasPendingDirected = pendingForTech.length > 0;

          if (hasPendingDirected) return "pending";
          if (acceptedByTech) return "working";
          if (assignedToTech) return "pending";
          return "seguimiento";
        }
        function getIncidentRealState(incident, technicianEmail) {
            const computedState = computeCycleState(incident, technicianEmail);
          if (computedState !== undefined && computedState !== null) {
            return computedState;
          }
          const level = parseInt(incident.escalation_level) || 0;
          const email = (technicianEmail || '').toLowerCase();

          // Si algún nivel inferior ya fue aceptado, no consultamos niveles superiores
          for (let prev = 0; prev < level; prev++) {
            let resp, tech;
            if (prev === 2) {
              resp = incident.l2_responses;
              tech = incident.l2_technicians;
            } else {
              resp = incident[`l${prev}_response`];
              tech = incident[`l${prev}_technician`];
            }
            const respStr = Array.isArray(resp) ? resp.join(' ').toLowerCase() : String(resp || '').toLowerCase();
            if (respStr.includes('acepto')) {
              const techStr = Array.isArray(tech) ? tech.join(',').toLowerCase() : String(tech || '').toLowerCase();
              if (techStr.includes(email)) return 'working';
              return 'seguimiento';
            }
          }
        
          // SLA del nivel actual
          const slaEnd = getSlaEndForLevel(incident, level);
          const withinSla = slaEnd ? Date.now() <= Date.parse(slaEnd) : false;
        
          // 1) Preferir "Respuestas (log)"
          let respText = ensureLogString(incident["Respuestas (log)"] || incident.respuestas_log);
          if (respText !== "{{emptystring}}") {
            let rows = parseRespLog(respText, incident).filter(r => r.level === level);
            const derivation = getLastDerivation(rows);
            if (derivation) {
              rows = rows.filter(r => r.when >= derivation.when);
              const hasActivity = rows.some(r => r.email && r.email.toLowerCase() === email && r.ev !== 'UNASSIGN');
              if (!hasActivity) return 'seguimiento';
            }
            const transfer = getLastTransferFor(rows, email);
            const myRows = rows.filter(r => r.email && r.email.toLowerCase() === email);
            const lastMine = myRows[myRows.length - 1];
            const lastAccepted = rows.filter(r => r.ev === 'ACCEPTED').slice(-1)[0];

            // Traspaso: quien entrega pasa a seguimiento
            if (transfer && transfer.type === 'from') return 'seguimiento';

            // Receptor del traspaso sin respuesta todavía
            if (transfer && transfer.type === 'to' && !lastMine) {
              return withinSla ? 'pending' : 'seguimiento';
            }

            if (lastMine) {
              if (lastMine.ev === 'ACCEPTED') return 'working';
              if (lastMine.ev === 'REJECTED' || lastMine.ev === 'NO_RESPONSE' || lastMine.ev === 'REASSIGN_FROM' || lastMine.ev === 'UNASSIGN') return 'seguimiento';
              if (lastMine.ev === 'ASSIGNED') {
                // Apoyo aceptado: si cualquiera aceptó, ambos trabajan
                if (lastAccepted) return 'working';
                return withinSla ? 'pending' : 'seguimiento';
              }
            }

            // Receptor de traspaso que aún no acepta
            if (transfer && transfer.type === 'to') return withinSla ? 'pending' : 'seguimiento';

            // Otro técnico aceptó → este queda en seguimiento
            if (lastAccepted && lastAccepted.email.toLowerCase() !== email) return 'seguimiento';

            const assigned = rows.some(r => r.ev === 'ASSIGNED' && r.email.toLowerCase() === email);
            if (assigned) return withinSla ? 'pending' : 'seguimiento';

            if (!withinSla) return 'seguimiento';
        
          } else {
            // 2) Fallback (campos legados)
            const assignments = [
              { level: 0, tech: incident.l0_technician, respText: incident.l0_response, sla: incident.sla_l0_end },
              { level: 1, tech: incident.l1_technician, respText: incident.l1_response, sla: incident.sla_l1_backup_end },
              { level: 2, tech: incident.l2_technicians, respText: incident.l2_responses, sla: incident.sla_l2_equipo_end },
              { level: 3, tech: incident.l3_technician, respText: incident.l3_response, sla: incident.sla_l3_responsable_end }
            ];

            const curr = assignments.find(a =>
              a.level === level &&
              (Array.isArray(a.tech)
                ? a.tech.map(t => String(t).toLowerCase()).includes(email)
                : String(a.tech || '').toLowerCase().includes(email))
            );
            if (curr) {
              const withinSla = curr.sla ? Date.now() <= Date.parse(curr.sla) : false;
              const resp = Array.isArray(curr.respText)
                ? curr.respText.join(' ').toLowerCase()
                : String(curr.respText || '').toLowerCase();
              if (resp.includes('rechazo')) return 'seguimiento';
              if (resp.includes('acepto')) return 'working';
              if (!resp || resp.includes('sin respuesta')) return withinSla ? 'pending' : 'seguimiento';
            }
          }
           return 'seguimiento';
        }



        function updateStatistics() {
            const technicianEmail = currentTechnician?.email || '';
            const annotated = allIncidents
              .map(incident => {
                const state = getIncidentRealState(incident, technicianEmail);
                const directed = hasDirectedPendingRequests(incident);
                return { incident, state, directed };
              })
              .filter(item => ['pending', 'working', 'seguimiento'].includes(item.state));

            const stats = {
                total: annotated.length,
                pending: annotated.filter(item => item.state === 'pending' || item.directed).length,
                working: annotated.filter(item => item.state === 'working').length,
                seguimiento: annotated.filter(item => item.state === 'seguimiento' && !item.directed).length
            };

            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('pendingCount').textContent = stats.pending;
            document.getElementById('workingCount').textContent = stats.working;
            document.getElementById('seguimientoCount').textContent = stats.seguimiento;
        }
           function nearestPendingSla(incidents, email) {
          // sólo incidencias en 'pending' para este técnico
          const list = (incidents || []).map(inc => {
            const st = getIncidentRealState(inc, email);
            const directed = hasDirectedPendingRequests(inc);
            if (st !== 'pending' && !directed) return null;
            const end = getSlaEndForLevel(inc, getCurrentLevel(inc));
            if (!end) return null;
            const t = Date.parse(end);
            return isNaN(t) ? null : { inc, t };
          }).filter(Boolean);
          if (!list.length) return null;
          list.sort((a,b)=> a.t - b.t);
          return list[0];
        }
        
        function renderSlaStickyBar() {
          const bar = document.getElementById('slaSticky');
          if (!bar) return;
          const email = currentTechnician?.email || '';
          const next = nearestPendingSla(allIncidents, email);
          if (!next) { bar.classList.add('hidden'); bar.innerHTML = ''; return; }
        
          const ms = next.t - Date.now();
          const severity = ms <= 30*60000 ? 'sla-critical' : (ms <= 120*60000 ? 'sla-warning' : 'sla-good');
          const blink = ms <= 2*60000 ? 'active' : '';
          const countdownClasses = ['badge', severity, blink].filter(Boolean).join(' ');
          const left = formatRemain(ms);
          bar.classList.remove('hidden');
          bar.innerHTML = `
            <span class="${countdownClasses}">⏱️ Próxima respuesta: ${left}</span>
            <span class="badge">Inc: ${safe(next.inc.id)}</span>
            <button class="cta" onclick="scrollToIncident('${safe(next.inc.id)}')">Ir a la tarjeta</button>
          `;
        }
        
        function scrollToIncident(id){
          const el = document.querySelector(
          `.incident-card[data-incident-id="${CSS.escape(id)}"]`
        );
          if (el) el.scrollIntoView({ behavior:'smooth', block:'start' });
        }

        async function receiverDecision(incidentId, encodedRequest, decision) {
          if (!incidentId || !encodedRequest || !decision) return;
          let payload = null;
          try {
            payload = JSON.parse(decodeURIComponent(atob(encodedRequest)));
          } catch (error) {
            console.error('receiverDecision decode error', error);
            showToast('No se pudo interpretar la solicitud. Inténtalo nuevamente.');
            return;
          }
          if (!payload || typeof payload !== 'object') {
            showToast('Solicitud inválida.');
            return;
          }

          const extra = {
            receiver_decision: decision,
            request_category: payload.cat || '',
            request_id: payload.id || '',
            request_req: payload.req || '',
            request_level: payload.level,
            request_when: payload.when || '',
            request_meta: payload.meta || {},
            request_meta_raw: payload.metaRaw || '',
            request_summary: payload.summary || ''
          };

          if (decision === 'reject') {
            const reason = prompt('Describe el motivo del rechazo:');
            if (reason === null) return;
            if (!reason.trim()) {
              showToast('Debes indicar un motivo para rechazar la solicitud.');
              return;
            }
            extra.reason = reason.trim();
          }

          const action = decision === 'accept'
            ? 'receiver_accept_request'
            : 'receiver_reject_request';

          const ok = await handleAction(action, incidentId, extra, { skipReload: true });
          if (ok) {
            if (typeof loadDashboard === 'function') {
              loadDashboard();
            } else if (typeof location !== 'undefined' && typeof location.reload === 'function') {
              location.reload();
            }
          }
        }

                function abrirAyuda(id){ showAyudaModal(id); }
                function abrirMateriales(id){ showMaterialesModal(id); }
                function abrirResolver(id){ showResolverModal(id); }
                
                function aceptarIncidencia(id){ handleAction('acepto', id); }
                function rechazarIncidencia(id){ showReasonModal('rechazo', id); }
                async function solicitarAsignacion(id){
                  const nota = prompt('Ingresa una nota para la solicitud:') || '';
                  await handleAction('solicitar_asignacion', id, {
                    request_reason: 'Solicitud de asignación',
                    request_justification: nota.trim()
                  });
                }


        // ========================================
        //  GESTIÓN DE MODALES
        // ========================================
        function showReasonModal(action, incidentId) {
            currentIncidentId = incidentId;
            pendingAction = action;
            
            const modal = document.getElementById('reasonModal');
            const title = document.getElementById('modalTitle');
            const options = document.getElementById('reasonOptions');
            
            title.textContent = '❌ Motivo del Rechazo';
            
            const rejectReasons = [
                { id: 'no_herramientas',   emoji: '🔧', title: 'No tengo herramientas necesarias',   description: 'Faltan herramientas específicas' },
                { id: 'no_conocimiento',   emoji: '📚', title: 'No tengo conocimiento técnico',      description: 'Requiere conocimientos especializados' },
                { id: 'fuera_horario',     emoji: '🕐', title: 'Fuera de horario laboral',          description: 'Asignada fuera del turno de trabajo' },
                { id: 'sobrecarga',        emoji: '📊', title: 'Sobrecarga de trabajo',             description: 'Trabajando en múltiples incidencias' },
                { id: 'ubicacion_lejana',  emoji: '📍', title: 'Ubicación lejana',                  description: 'Fuera de zona de cobertura' },
                { id: 'otro',              emoji: '💬', title: 'Otro motivo',                       description: 'Especificar motivo', requiresText: true }
            ];

                  options.innerHTML = rejectReasons.map(r => `
                  <div class="reason-option" onclick="selectReason('${r.id}', event)">
                    <div style="display:flex;align-items:center;">
                      <span class="reason-icon">${r.emoji}</span>
                      <div>
                        <div style="font-weight:600;">${r.title}</div>
                        <div style="font-size:14px;color:#6b7280;">${r.description}</div>
                      </div>
                    </div>
                  </div>
                `).join('');

            modal.classList.remove('hidden');
        }

        function showResolverModal(incidentId) {
          currentIncidentId = incidentId;
        
          // Oculta "Solicitudes recientes" dentro del modal si existiera
          const container = document.getElementById('resolverRequests');
          if (container) {
            container.innerHTML = '';
            container.closest('.form-group')?.classList.add('hidden');
          }
        
          const inc = allIncidents.find(i => i.id === incidentId) || {};
          const approvedItems = deriveApprovedItemsFromLog(inc);
          renderMaterialesResultado(approvedItems);
        
          document.getElementById('resolverModal').classList.remove('hidden');
          updateResolverValidation();
        }
        // ——— Helpers para "Resolver" ———

        // Lee "Solicitudes (log)" y agrupa por MATERIAL, sacando cantidad solicitada/aprobada
        function deriveApprovedItemsFromLog(inc = {}) {
          const text = ensureLogString(inc["Solicitudes (log)"] || inc.solicitudes_log || "");
          const rows = parseSolicitudesLog(text);
          if (!rows.length) return [];
        
          const grouped = groupByRequest(rows);
        
          const mats = Object.values(grouped).filter(g => (g?.cat || '').toUpperCase() === 'MATERIAL');
        
          const byKey = {};
          for (const g of mats) {
            const reqPhase = g.phases.find(p => p.phase === 'REQUEST') || g.phases[0] || {};
            const mR = reqPhase.meta || {};
            const code = String(mR.code || g.id || '').trim();
            const name = String(mR.name || 'Material').trim();
            const unit = normalizeUnit(mR.unit || 'ud');
            const qtyReq = Number(mR.qty || 0) || 0;

            const approvedPhases = g.phases.filter(p => p.phase === 'APPROVED');
            let qtyApr = 0;
            for (const ap of approvedPhases) {
              const m = ap.meta || {};
              let rawQty = m.qty;
              if (rawQty === undefined || rawQty === null || rawQty === "") rawQty = m.qty_approved;
              if (rawQty === undefined || rawQty === null || rawQty === "") rawQty = m.approved;
              if (rawQty === undefined || rawQty === null || rawQty === "") rawQty = mR.qty;
              if (rawQty === undefined || rawQty === null || rawQty === "") rawQty = reqPhase?.meta?.qty;
              qtyApr += Number(rawQty) || 0;
            }
            const key = [code||name, unit].join('||');
            if (!byKey[key]) byKey[key] = { code, name, unit, qty_solicitada: 0, qty_aprobada: 0 };
            byKey[key].qty_solicitada += qtyReq;
            byKey[key].qty_aprobada  += qtyApr;
          }
          return Object.values(byKey).filter(it => Number(it.qty_aprobada) > 0);
        }

        function nameFromEmail(email=""){
          const raw = String(email).split("@")[0].replace(/\d+/g,"");
          if (!raw) return "";
          return raw.split(/[._-]+/).filter(Boolean).map(s => s[0].toUpperCase()+s.slice(1)).join(" ");
        }
        function metaName(meta, who){
          return (meta?.[`${who}_name`] || meta?.[who] && nameFromEmail(meta[who]) || "").trim();
        }

        function showMaterialesModal(incidentId) {
           currentIncidentId = incidentId;

        if (!inventory || inventory.length === 0) {
                showToast('⚠️ Inventario no disponible. Ingresa los datos manualmente.');
            }

            renderTmpMat();
            resetMatForm();
            updateMatControls();

            const modal = document.getElementById('materialesModal');
            if (modal) {
                modal.classList.remove('hidden');
            }

            const codeInput = document.getElementById('matCode');
            if (codeInput) {
                codeInput.focus();
            }
        }

        function unitAllowsDecimal(u) {
          const unit = (u || '').toLowerCase().trim();
          return unit === 'm' || unit === 'kg' || unit === 'l';
        }

        function renderMaterialesResultado(items = []) {
          const wrap = document.getElementById('materialesResultadoWrapper');
          if (!wrap) return;
        
         if (!Array.isArray(items) || !items.length) {
            wrap.innerHTML = '<div class="muted">No hay materiales aprobados. Solicita y espera aprobación antes de resolver.</div>';
            updateResolverValidation();
            return;
          }
        
          wrap.innerHTML = `
            <table class="materials-table">
              <thead>
                <tr>
                  <th>Código</th><th>Nombre</th><th>Unidad</th>
                  <th>Solicitado</th><th>Aprobado</th>
                  <th>Consumido</th><th>Devuelto</th><th>Desechado</th><th>Estado</th>
                </tr>
              </thead>
              <tbody id="materialesResultadoBody"></tbody>
            </table>
          `;
        
          const tbody = wrap.querySelector('#materialesResultadoBody');
          items.forEach(it => {
            const step = unitAllowsDecimal(it.unit) ? '0.01' : '1';
            const tr = document.createElement('tr');
            tr.dataset.req = it.req || '';
            tr.dataset.code = it.code || '';
            tr.dataset.name = it.name || '';
            tr.dataset.unit = it.unit || 'ud';
            tr.dataset.qty_aprobada = Number(it.qty_aprobada || 0);
            tr.dataset.qty_solicitada = Number(it.qty_solicitada || 0);

            tr.innerHTML = `
              <td class="nowrap">${safe(it.code || '')}</td>
              <td class="ellipsis" title="${safe(it.name || '')}">${safe(it.name || '')}</td>
              <td class="nowrap">${safe(it.unit || 'ud')}</td>
              <td class="num">${Number(it.qty_solicitada || 0)}</td>
              <td class="num">${Number(it.qty_aprobada || 0)}</td>
              <td><input type="number" min="0" step="${step}" class="consumida-input form-control" placeholder="0"></td>
              <td><input type="number" min="0" step="${step}" class="devuelta-input form-control"  placeholder="0"></td>
              <td><input type="number" min="0" step="${step}" class="desechada-input form-control" placeholder="0"></td>
              <td class="nowrap"><span class="chip chip-small chip-muted">Pendiente</span></td>
            `;
            tbody.appendChild(tr);
          });

          tbody.querySelectorAll('input').forEach(inp => {
            inp.addEventListener('input', updateResolverValidation);
          });
          updateResolverValidation();
        }

        function updateResolverValidation() {
          const btn = document.getElementById('resolverSubmitBtn');
          const wrap = document.getElementById('materialesResultadoWrapper');
          const tbody = wrap?.querySelector('#materialesResultadoBody');
          const hasTable = !!tbody;

          let allOk = true;

          if (hasTable) {
            tbody.querySelectorAll('tr').forEach(tr => {
              const approved = Number(tr.dataset.qty_aprobada || 0);
              const used     = Number(tr.querySelector('.consumida-input')?.value || 0);
              const returned = Number(tr.querySelector('.devuelta-input')?.value  || 0);
              const scrap    = Number(tr.querySelector('.desechada-input')?.value || 0);
              const ok = Math.abs((used + returned + scrap) - approved) < 0.0001;

              tr.classList.remove('row-ok','row-warn');
               const statusCell = tr.querySelector('td:last-child');

              if (ok) {
                tr.classList.add('row-ok');
                if (statusCell) {
                  statusCell.innerHTML = '<span class="chip chip-small chip-approved">OK</span>';
                }
              } else {
                allOk = false;
                tr.classList.add('row-warn');
                if (statusCell) {
                  statusCell.innerHTML = '<span class="chip chip-small chip-warning">Revisa</span>';
                }
              }
            });
          }

          const hasDescription = (document.getElementById('solutionDescription')?.value || '').trim().length > 0;
          if (btn) btn.disabled = !(allOk && hasDescription);
        }

        function showAyudaModal(incidentId) {
            currentIncidentId = incidentId;
            document.getElementById('ayudaModal').classList.remove('hidden');
        }

        document.getElementById('solutionDescription').addEventListener('input', updateResolverValidation);

        function openResourcesModal(incident) {
          currentIncidentId = incident.id;
          const state = getIncidentRealState(incident, currentTechnician?.email || "");
        
          const enc = s => encodeURI(String(s || ""));
          const pill = (label, href, prim=false) =>
            href
              ? `<a class="btn ${prim ? 'btn-resource' : 'btn-secondary'}" href="${enc(href)}" target="_blank" rel="noopener noreferrer">${label}</a>`
              : `<span class="btn btn-secondary" style="opacity:.5;pointer-events:none;">${label} no disponible</span>`;
        
          const matUrl = state === 'working' ? incident.materials_url : null;
        
          const html = `
            <div class="action-buttons" style="justify-content:flex-start;gap:12px;flex-wrap:wrap">
              ${pill('🔗 Incidencia', incident.url, true)}
              ${pill('📊 Estado de materiales', matUrl)}
              ${pill('🔍 Historial del componente', incident.history_url)}
            </div>`;
        
          const list = document.getElementById('referenciasList');
          if (list) list.innerHTML = html;
          document.getElementById('referenciasModal')?.classList.remove('hidden');
        }


        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            // Reset forms
            document.querySelectorAll(`#${modalId} input, #${modalId} textarea, #${modalId} select`).forEach(input => {
                if (input.type === 'checkbox') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });
            selectedReason = null;
            currentIncidentId = null;
            if (modalId === 'materialesModal') {
                tmpMat = [];
                renderTmpMat();
                resetMatForm();
                updateMatControls();
            }
        }

        function selectReason(reasonId, ev) {
          selectedReason = reasonId;
          document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
          // Preferimos currentTarget (el div con el onclick)
          const card = ev?.currentTarget || ev?.target?.closest('.reason-option');
          if (card) card.classList.add('selected');
        }

        // ========================================
        //  ACCIONES PRINCIPALES CON PIN
        // ========================================
        async function handleAction(action, incidentId, extraData = {}, options = {}) {
            if (!currentTechnician?.authenticated) {
                showNotification('Debes estar autenticado para realizar acciones', 'error');
                return;
            }

            const { skipReload = false } = options || {};

            // Si no hay PIN guardado, solicitarlo
            if (!currentTechnician.pin) {
                pendingAction = action;
                directIncidentId = incidentId;
                pendingActionData = extraData;
                
                // Solicitar PIN para la acción
                showActionPINModal(action, incidentId);
                return;
            }

            const payload = {
                incident_id: incidentId,
                pin: currentTechnician.pin,  // ✅ Incluir PIN en todas las acciones
                timestamp: new Date().toISOString(),
                ...extraData
            };

            try {
                const response = await callWebhook(action, payload);

                const data = await response.json();
                
                if (data.status === 'success') {
                    showNotification(`✅ ${getActionMessage(action)}`, 'success');
                if (!skipReload) {
                        if (typeof loadDashboard === 'function') {
                            loadDashboard();
                        } else if (typeof location !== 'undefined' && typeof location.reload === 'function') {
                            location.reload();
                        }
                    }
                    return true;
                } else {
                    let msg = data.message || 'Acción no completada';
                    if (action === 'resolver' && /pendientes? de materiales/i.test(msg)) {
                        msg = 'No puedes resolver: hay validaciones pendientes de materiales.';
                    }
                    showToast(`❌ ${msg}`);
                    return false;
                }
            } catch (error) {
                console.error('Error en acción:', error);
                showNotification('❌ Error de conexión', 'error');
                return false;
            }
        }

        function showActionPINModal(action, incidentId) {
          const modal = document.createElement('div');
          modal.className = 'modal-overlay';
          modal.id = 'actionPinModal';
          modal.innerHTML = `
            <div class="modal">
              <div class="modal-header">
                <h3>🔐 Confirmar Acción</h3>
              </div>
              <div class="modal-body">
                <p>Para realizar la acción <strong>${getActionMessage(action)}</strong>, confirma tu PIN:</p>
                <div class="form-group">
                  <label class="form-label">PIN:</label>
                  <input type="password" id="actionPinInput" class="form-control" maxlength="4" inputmode="numeric" placeholder="••••" style="text-align: center; font-size: 18px; letter-spacing: 4px;">
                </div>
                <div id="actionPinError" class="error-message hidden"></div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeActionPINModal()">Cancelar</button>
                <button class="btn btn-primary" id="confirmActionBtn" onclick="confirmActionWithPIN()" disabled>Confirmar</button>
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
          
          const pinInput = document.getElementById('actionPinInput');
          const confirmBtn = document.getElementById('confirmActionBtn');
        
          pinInput.focus();
        
          pinInput.oninput = function() {
            this.value = this.value.replace(/\D/g, '').slice(0, 4);
            confirmBtn.disabled = this.value.length !== 4;
          };
        
          pinInput.onkeypress = function(e) {
            if (e.key === 'Enter' && this.value.length === 4) {
              confirmActionWithPIN();
              return;
            }
            if (!/[0-9]/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'Tab') {
              e.preventDefault();
            }
          };
        }


        async function confirmActionWithPIN() {
            const pin = document.getElementById('actionPinInput').value;
            
            if (pin.length !== 4) {
                document.getElementById('actionPinError').textContent = 'PIN debe tener 4 dígitos';
                document.getElementById('actionPinError').classList.remove('hidden');
                return;
            }

            // Guardar PIN y ejecutar acción
            currentTechnician.pin = pin;
            closeActionPINModal();
            
            // Ejecutar acción pendiente
            await handleAction(pendingAction, directIncidentId, pendingActionData);
        }

        function closeActionPINModal() {
            const modal = document.getElementById('actionPinModal');
            if (modal) {
                modal.remove();
            }
        }

        function confirmAction() {
            if (!selectedReason || !currentIncidentId) return;
            
            const customText = document.getElementById('customReasonText').value.trim();
            
            handleAction(pendingAction, currentIncidentId, {
                reason: customText ? `${selectedReason}::${customText}` : selectedReason,
                notify_next: true
            });
            
            closeModal('reasonModal');
        }

      async function confirmResolver() {
          const inc = allIncidents.find(i => i.id === currentIncidentId);
          if (!inc) { showToast('Incidencia no encontrada'); return; }
          
          const solution = (document.getElementById('solutionDescription')?.value || '').trim();
          if (!solution) {
            showToast('Describe la solución aplicada antes de continuar');
            return;
          }
        
          const body = document.getElementById('materialesResultadoBody');
          const materiales_resultado = [];
        
          if (body) {
            for (const row of body.querySelectorAll('tr')) {
              const qtyAprobada = Number(row.dataset.qty_aprobada || 0) || 0;
              const qtySolicitada = Number(row.dataset.qty_solicitada || 0) || 0;
              const qtyConsumida = Number(row.querySelector('.consumida-input')?.value || 0) || 0;
              const qtyDevuelta = Number(row.querySelector('.devuelta-input')?.value || 0) || 0;
              const qtyDesechada = Number(row.querySelector('.desechada-input')?.value || 0) || 0;
              const total = qtyConsumida + qtyDevuelta + qtyDesechada;

              if (total > 0) {
                if (Math.abs(total - qtyAprobada) > 0.0001) {
                  const label = row.dataset.code || row.dataset.name || 'material';
                  showToast(`Revisa ${label}: ${total} ≠ aprobado ${qtyAprobada}`);
                  return;
                }

                materiales_resultado.push({
                  req: row.dataset.req || null,
                  code: row.dataset.code || '',
                  name: row.dataset.name || '',
                  unit: row.dataset.unit || 'ud',
                  qty_solicitada: qtySolicitada,
                  qty_aprobada: qtyAprobada,
                  qty_consumida: qtyConsumida,
                  qty_devuelta: qtyDevuelta,
                  qty_desechada: qtyDesechada
                });
              }
            }
          }
          // Si no hay tabla o no hay filas con totales > 0, permitimos resolver solo con descripción.
            if (!body || body.querySelectorAll('tr').length === 0) {
              // materiales_resultado ya es [] -> resolver solo con solution_description
            }
          const result = await handleAction('resolver', currentIncidentId, {
            solution_description: solution,
            materiales_resultado
          });
          if (result) {
            closeModal('resolverModal');
            showToast('✔️ Enviado para cierre del supervisor', 3500);
            loadDashboard();
          }
        }

    
        // ========================================
        //  UTILIDADES Y HELPERS
        // ========================================
      const formatNameFromEmail = (email) => email?.split('@')[0].split('.').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');

        function formatDate(dateString) {
            if (!dateString) return 'Fecha no disponible';
            const date = new Date(dateString);
            return date.toLocaleString("es-ES", {
                day: "2-digit",
                month: "2-digit",
                year: "numeric",
                hour: "2-digit",
                minute: "2-digit",
                hour12: false
            });
        }

        function formatTimeOrDate(dateString) {
            if (!dateString) return 'Fecha no disponible';
            const date = new Date(dateString);
            const today = new Date();
            const sameDay = date.getFullYear() === today.getFullYear() &&
                date.getMonth() === today.getMonth() &&
                date.getDate() === today.getDate();
            if (sameDay) {
                return date.toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            }
            return formatDate(dateString);
        }
    
        function getPriorityClass(priority) {
            if (!priority) return 'baja';
            const p = priority.toLowerCase();
            if (p.includes('crítica') || p.includes('🔴')) return 'critica';
            if (p.includes('alta') || p.includes('🟠')) return 'alta';
            if (p.includes('media') || p.includes('🟡')) return 'media';
            return 'baja';
        }

        function cleanPriority(priority) {
            if (!priority) return 'BAJA';
            return priority.replace(/🔴|🟠|🟡|🟢/g, '').trim().toUpperCase();
        }

        function getStateLabel(state) {
            const labels = {
                'pending': '⏳ PENDIENTE',
                'working': '⚙️ TRABAJANDO',
                'seguimiento': '👁️ SEGUIMIENTO'
            };
            return labels[state] || state.toUpperCase();
        }

        function getActionMessage(action) {
            const messages = {
                'acepto': 'Incidencia aceptada correctamente',
                'rechazo': 'Incidencia rechazada. Se escalará automáticamente',
                'resolver': 'Incidencia resuelta. Pendiente cierre supervisor',
                'request_materials': 'Solicitud de materiales enviada al supervisor',
                'derivar_departamento': 'Solicitud de derivación enviada al supervisor',
                'solicitar_traspaso': 'Solicitud de traspaso enviada al supervisor',
                'solicitar_apoyo': 'Solicitud de apoyo enviada al supervisor',
                'solicitar_asignacion': 'Solicitud de asignación enviada',
                'notes': 'Notas agregadas a la incidencia',
                'receiver_accept_request': 'Respuesta enviada: has aceptado la solicitud',
                'receiver_reject_request': 'Respuesta enviada: has rechazado la solicitud'
            };
            return messages[action] || `Acción ${action} procesada correctamente`;
        }

        function showLoadingState() {
            document.getElementById('incidentsContainer').innerHTML = `
                <div class="loading-spinner">🔄 Cargando incidencias...</div>
            `;
        }

        function showErrorState(errorMessage) {
            document.getElementById('incidentsContainer').innerHTML = `
                <div class="error-card">
                    <div class="error-icon">❌</div>
                    <h3>Error al cargar datos</h3>
                    <p>${errorMessage}</p>
                    <button class="retry-button" onclick="loadDashboard()">
                        🔄 Reintentar
                    </button>
                </div>
            `;
        }
        
        // Permite mostrar el botón "Solicitar traspaso" solo en ventanas horarias concretas
        function shouldShowSolicitarTraspaso() {
            const now = new Date();
            const minutes = now.getHours() * 60 + now.getMinutes();
            // Ventanas: 05:45-06:15, 13:45-14:15 y 21:45-22:15
            const windows = [
                [5 * 60 + 45, 6 * 60 + 15],
                [13 * 60 + 45, 14 * 60 + 15],
                [21 * 60 + 45, 22 * 60 + 15]
            ];
            return windows.some(([start, end]) => minutes >= start && minutes < end);
        }

        function showNotification(message, type = 'info') {
            // Crear notificación temporal
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 20px;
                background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                border-radius: 8px;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 4000);
        }

        const REQUEST_CAT_INFO = {
          MATERIAL: { icon: "📦", label: "Material" },
          APOYO: { icon: "🤝", label: "Apoyo" },
          DERIVACION: { icon: "↪️", label: "Derivación" },
          TRASPASO: { icon: "🔄", label: "Traspaso" },
          REASIGNACION: { icon: "♻️", label: "Reasignación" },
        };

        // --- Parsear log y agrupar por categoría + request_id ---
        function parseSolicitudesLog(logText = "") {
          if (Array.isArray(logText)) {
            logText = logText.join("\n");
          } else if (logText === null || logText === undefined) {
            logText = "";
          } else if (typeof logText === 'object') {
            logText = JSON.stringify(logText);
          }
          const text = String(logText);
          if (!text.trim()) return [];
          const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
          const out = []; // {when, cat, id, phase, meta, metaRaw, req}
          for (const line of lines) {
            const m = line.match(/^\[(.+?)\]\s+([A-Z]+)#([\w-]+)\|(REQUEST|APPROVED|REJECTED)\|(.*)$/i);
            if (!m) continue;
            const [, when, catRaw, reqId, phaseRaw, rest] = m;
            const cat = catRaw.toUpperCase();
            const phase = phaseRaw.toUpperCase();
            const meta = parseMetaKV(rest || "");
            const req = meta.req || reqId;
            out.push({
              when,
              cat,
              reqId,
              phase,
              meta,
              metaRaw: rest || "",
              req
            });
          }
          out.sort((a, b) => new Date(a.when) - new Date(b.when));
          return out;
        }
        
        function groupByRequest(logRows) {
          // { "MATERIAL|REQ|MAT-001" or "MATERIAL|ID|123": {cat, id, req, last: {phase, when}, phases: [...], level, status} }
          const map = {};
          for (const r of logRows) {
            const idKey = `${r.cat}|ID|${r.reqId}`;
            const reqKey = r.req ? `${r.cat}|REQ|${r.req}` : null;
            if (reqKey && map[idKey] && !map[reqKey]) {
              map[reqKey] = map[idKey];
              delete map[idKey];
            }
            const key = reqKey || idKey;
            if (!map[key]) {
              map[key] = { cat: r.cat, id: r.reqId, req: r.req || null, phases: [] };
            } else if (r.req && (!map[key].req || map[key].req === map[key].id)) {
              map[key].req = r.req;
            }
            map[key].phases.push(r);
          }
          for (const k of Object.keys(map)) {
            const g = map[k];
            g.phases.sort((a,b)=> new Date(a.when)-new Date(b.when));
            g.last = g.phases[g.phases.length - 1];
            // Derivar nivel desde el ultimo meta que contenga "Lx"
            const lvlPhase = [...g.phases].reverse().find(p => /L\d/i.test(p.metaRaw || ""));
            const lvlMatch = lvlPhase ? (lvlPhase.metaRaw || "").match(/L(\d+)/i) : null;
            g.level = lvlMatch ? parseInt(lvlMatch[1], 10) : null;
            // Estado segun la ultima fase
            g.status = g.last.phase === 'APPROVED' ? 'approved'
                      : g.last.phase === 'REJECTED' ? 'rejected'
                      : 'pending';
          }
          return map;
        }
          function renderSlaPillInHeader(inc, state, card) {
              const L = getCurrentLevel(inc);
              const end = getSlaEndForLevel(inc, L);
              if (!end) return "";
            
              // Si está trabajando, enseñamos banner “Trabajando”
            if (state === "working") {
            let acept = "";
            const split = getSplitContext(inc);
            const respText = (split?.current || []).map(entry => entry.raw).join("\n");
            if (respText.trim()) {
              const rows = parseRespLog(respText, inc);
              const lastAccepted = rows.filter(r => r.level === L && r.ev === "ACCEPTED").slice(-1)[0];
              if (lastAccepted) acept = new Date(lastAccepted.when).toLocaleString();
            }
            return `<span class="sla-timer active">Trabajando L${L}${acept ? ` · ${acept}` : ""}</span>`;
          }
            
              // Solo mostrar temporizador si está PENDING y no ha vencido
              if (state !== "pending") return "";
              const ms = Date.parse(end) - Date.now();
              if (ms <= 0) return ""; // nada si ya venció
            
              const severity = ms <= 30*60000 ? "sla-critical" : ms <= 120*60000 ? "sla-warning" : "sla-good";
              const blink = ms <= 2*60000 ? "active" : "";
              const classes = ["sla-timer", severity, blink].filter(Boolean).join(" ");
              return `<span class="${classes}">⏱️ ${formatRemain(ms)}</span>`;
            }

        
        // --- ¿Qué categorías tienen pendientes? ---
        function getPendingCategoriesFromLog(logText="") {
          logText = ensureLogString(logText);
          if (logText === "{{emptystring}}") return new Set();
          const rows = parseSolicitudesLog(logText);
          const grouped = groupByRequest(rows);
          const pendingCats = new Set();
          for (const k of Object.keys(grouped)) {
            const { cat, last } = grouped[k];
            if (last?.phase === "REQUEST") pendingCats.add(cat);
          }
          return pendingCats; // e.g. Set(["MATERIAL","APOYO"])
        }
        
        // --- Construir notificaciones compactas desde el log ---
        function buildNotificationsFromLog(incident) {
          let log = ensureLogString(incident["Solicitudes (log)"] || incident.solicitudes_log);
          if (log === "{{emptystring}}") return [];
        
          const rows = parseSolicitudesLog(log);
          const grouped = groupByRequest(rows);
        
          // contadores por cat/fase
          const counters = {
            MATERIAL: { APPROVED: 0, REJECTED: 0 },
            DERIVACION: { APPROVED: 0, REJECTED: 0 },
            APOYO: { APPROVED: 0, REJECTED: 0 },
            TRASPASO: { APPROVED: 0, REJECTED: 0 },
            REASIGNACION: { APPROVED: 0, REJECTED: 0 },
          };
        
          for (const key of Object.keys(grouped)) {
            const { cat, last } = grouped[key];
            if (!counters[cat]) continue;
            if (last.phase === "APPROVED") counters[cat].APPROVED++;
            if (last.phase === "REJECTED") counters[cat].REJECTED++;
          }
        
          const out = [];
          // Materiales
          if (counters.MATERIAL.APPROVED) out.push({ type: "material_approved", message: `🟢 Materiales aprobados (${counters.MATERIAL.APPROVED})` });
          if (counters.MATERIAL.REJECTED) out.push({ type: "material_rejected", message: `🔴 Materiales rechazados (${counters.MATERIAL.REJECTED})` });
          // Derivación
          if (counters.DERIVACION.APPROVED) out.push({ type: "derivation_approved", message: `🟢 Derivaciones aprobadas (${counters.DERIVACION.APPROVED})` });
          if (counters.DERIVACION.REJECTED) out.push({ type: "derivation_rejected", message: `🔴 Derivaciones rechazadas (${counters.DERIVACION.REJECTED})` });
          // Apoyo
          if (counters.APOYO.APPROVED) out.push({ type: "support_approved", message: `🟢 Apoyos aprobados (${counters.APOYO.APPROVED})` });
          if (counters.APOYO.REJECTED) out.push({ type: "support_rejected", message: `🔴 Apoyos rechazados (${counters.APOYO.REJECTED})` });
          // Traspaso
          if (counters.TRASPASO.APPROVED) out.push({ type: "traspaso_approved", message: `🟢 Traspasos aprobados (${counters.TRASPASO.APPROVED})` });
          if (counters.TRASPASO.REJECTED) out.push({ type: "traspaso_rejected", message: `🔴 Traspasos rechazados (${counters.TRASPASO.REJECTED})` });
          // Reasignación
          if (counters.REASIGNACION.APPROVED) out.push({ type: "reasignacion_approved", message: `🟢 Reasignaciones aprobadas (${counters.REASIGNACION.APPROVED})` });
          if (counters.REASIGNACION.REJECTED) out.push({ type: "reasignacion_rejected", message: `🔴 Reasignaciones rechazadas (${counters.REASIGNACION.REJECTED})` });
        
          return out;
        }

        function renderCurrentOwnerChip(inc){
          const level = parseInt(inc.escalation_level ?? 0, 10);
          // Prioridad: valor mapeado al nivel actual, y si no, campos legacy
          let owner = '';
          if (level === 0) owner = inc.l0_technician || inc.assigned_technician || '';
          if (level === 1) owner = inc.l1_technician || inc.assigned_technician || '';
          if (level === 2) owner = Array.isArray(inc.l2_technicians) ? inc.l2_technicians.join(', ') : (inc.l2_technicians || inc.assigned_technician || '');
          if (level === 3) owner = inc.l3_technician || inc.assigned_technician || '';
        
          const label = owner ? `👤 Titular L${level}: ${owner}` : `👤 Titular L${level}: —`;
          return `<span class="chip">${label}</span>`;
        }
        
        function ensureLogString(val){
          if (Array.isArray(val)) val = val.join("\n");
          else if (typeof val !== 'string') val = JSON.stringify(val ?? '');
          val = String(val || '');
          return val.trim() ? val : '{{emptystring}}';
        }
        function toPlainLogString(val) {
          if (Array.isArray(val)) val = val.join("\n");
          if (val === undefined || val === null) return "";
          if (typeof val === "string") {
            const trimmed = val.trim();
            return trimmed === "{{emptystring}}" ? "" : val;
          }
          try {
            const str = String(val || "");
            return str === "{{emptystring}}" ? "" : str;
          } catch (err) {
            return "";
          }
        }

        function parseLines(raw){
          const text = toPlainLogString(raw);
          if (!text) return [];
          return text
            .split(/\r?\n/)
            .map(line => String(line || "").trim())
            .filter(Boolean)
            .map(line => {
              const m = line.match(/^\[(.+?)\]\s+(\S+)/);
              const tsRaw = m ? Date.parse(m[1]) : NaN;
              const ts = Number.isFinite(tsRaw) ? tsRaw : 0;
              const body = line.replace(/^\[[^\]]+\]\s*/, "").trim();
              return { ts, raw: line, body };
            })
            .sort((a, b) => a.ts - b.ts);
        }

        function splitCycles(respuestasRaw, solicitudesRaw){
          const resp = parseLines(respuestasRaw);
          const reqs = parseLines(solicitudesRaw);
          const cut = reqs
            .filter(r => /^(TRASPASO|DERIVACION)#.+\|APPROVED/i.test(r.body || ""))
            .pop();
          if (!cut) {
            return {
              current: resp,
              previous: [],
              requests: { current: reqs, previous: [] },
              cutTimestamp: null
            };
          }
          const cutTs = cut.ts;
          const currentResp = resp.filter(r => r.ts >= cutTs);
          const previousResp = resp.filter(r => r.ts < cutTs);
          const currentReq = reqs.filter(r => r.ts >= cutTs);
          const previousReq = reqs.filter(r => r.ts < cutTs);
          return {
            current: currentResp,
            previous: previousResp,
            requests: { current: currentReq, previous: previousReq },
            cutTimestamp: cutTs
          };
        }

        function getSplitContext(incident) {
          if (!incident) {
            return {
              current: [],
              previous: [],
              requests: { current: [], previous: [] },
              cutTimestamp: null
            };
          }
          if (!incident.__splitCyclesCache) {
            let responsesRaw = toPlainLogString(incident.respuestas_log_full);
            if (!responsesRaw) {
              responsesRaw = toPlainLogString(incident["Respuestas (log)"]);
            }
            if (!responsesRaw) {
              responsesRaw = toPlainLogString(incident.respuestas_log);
            }

            let requestsRaw = toPlainLogString(incident["Solicitudes (log)"]);
            if (!requestsRaw) {
              requestsRaw = toPlainLogString(incident.solicitudes_log);
            }
            incident.__splitCyclesCache = splitCycles(responsesRaw, requestsRaw);
          }
          return incident.__splitCyclesCache;
        }

        function escapeRegExp(str) {
          return String(str || "").replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function cleanLevelTags(str){
          return String(str || '')
            .replace(/\]\]L\d+\)?/gi, '')   // quita "]]L0", "]]L1)", etc.
            .replace(/\bL\d\b/gi, '')       // quita " L0 " suelto, en cualquier caso
            .replace(/\s{2,}/g, ' ')
            .trim();
        }


        function parseMetaKV(str = "") {
          const obj = {};
          String(str || "")
            .split(/[,;]+/)
            .map(s => s.trim())
            .filter(Boolean)
            .forEach(part => {
              const [k, v] = part.split(/=/);
              if (!k) return;
              obj[k.trim()] = (v || "").trim();
            });
          return obj;
        }

        function renderRequestChips(logText, mount) {
          if (!mount) return;
          mount.innerHTML = "";

          const normalized = ensureLogString(logText);
          if (normalized === "{{emptystring}}") return;

          const rows = parseSolicitudesLog(normalized);
          if (!rows.length) return;
          const grouped = groupByRequest(rows);
          const toTimestamp = when => {
            const value = when ? Date.parse(when) : NaN;
            return Number.isNaN(value) ? 0 : value;
          };
          const requests = Object.values(grouped)
            .filter(req => req.status === "pending")
            .sort((a, b) => toTimestamp(b.last?.when) - toTimestamp(a.last?.when));

          if (!requests.length) return;

          const frag = document.createDocumentFragment();
          const pick = (...vals) => {
            for (const val of vals) {
              if (val === undefined || val === null) continue;
              const str = String(val).trim();
              if (!str || str === "{{emptystring}}") continue;
              return str;
            }
            return "";
          };

          for (const req of requests) {
            const info = REQUEST_CAT_INFO[req.cat] || { icon: "", label: req.cat };
            const meta = req.last?.meta || {};
            let detail = "";
            if (req.cat === "MATERIAL") {
              const name = pick(meta.name, meta.material, meta.item);
              const qty = pick(meta.qty);
              const unit = pick(meta.unit, meta.units, meta.unidad);
              const qtyUnit = qty ? ` ×${qty}${unit ? ` ${unit}` : ""}` : "";
              detail = `${name || ""}${qtyUnit}`;
            } else if (req.cat === "APOYO") {
              detail = pick(meta.detail, meta.detalle, meta.reason, meta.comment, meta.notes);
            } else if (req.cat === "DERIVACION" || req.cat === "TRASPASO" || req.cat === "REASIGNACION") {
              const destination = pick(meta.to, meta.dest, meta.destino, meta.target, meta.detail, meta.detalle, meta.name);
              const reason = pick(meta.reason, meta.detail, meta.detalle);
              detail = [destination, reason].filter(Boolean).join(" · ");
            } else {
              detail = [pick(meta.name), pick(meta.to), pick(meta.detail, meta.detalle, meta.reason)]
                .filter(Boolean)
                .join(" · ");
            }
            detail = detail.replace(/\s+/g, " ").trim();

            const baseLabel = (info.label || req.cat || "").trim();
            let text = baseLabel;
            if (detail) text += ` · ${detail}`;
            if (info.icon) text = `${info.icon} ${text}`;

            if (!text.trim()) continue;

            detail = cleanLevelTags(detail);

            const base = (info.icon ? `${info.icon} ` : "") + (info.label || req.cat || "");
            let displayText = base;
            if (detail) displayText += ` · ${detail}`;
            const requesterRaw = req.last?.meta?.req_by || req.last?.meta?.requested_by || req.last?.meta?.by || req.last?.meta?.from || '';
            const requesterName = req.last?.meta?.req_by_name || req.last?.meta?.by_name || '';
            const requester = requesterName || (requesterRaw ? nameFromEmail(String(requesterRaw)) : '');
            const approverRaw = req.last?.meta?.by || '';
            const approverName = req.last?.meta?.by_name || (approverRaw ? nameFromEmail(String(approverRaw)) : '');
            if (requester) displayText += ` · 👤 Solicitó: ${requester}`;
            if ((req.last?.phase || '').toUpperCase() === 'APPROVED' && (approverName || approverRaw)) {
              displayText += ` · ✅ Aprobó: ${approverName || nameFromEmail(String(approverRaw))}`;
            }
            displayText = cleanLevelTags(displayText);
            
            const chip = document.createElement("button");
            chip.type = "button";
            chip.className = "chip-request";
            chip.textContent = displayText.trim();
            if (req.last?.metaRaw) chip.title = req.last.metaRaw;
            chip.classList.add(`cat-${(req.cat||'').toLowerCase()}`);
            frag.appendChild(chip);
          }

          if (frag.childNodes.length) {
            mount.appendChild(frag);
          }
        }

        // ==============================
        // RESPUESTAS (log) - Helpers
        // Campo Notion: "Respuestas (log)"
        // ==============================
        function parseRespLog(text = "", incident = null) {
          if (!text) return [];
          const lines = String(text).split(/\r?\n/).map(s => s.trim()).filter(Boolean);
          const rows = [];
          for (const line of lines) {
          // [fecha] RESP#APOYO#<email>|ASSIGNED|ACCEPTED
            let m = line.match(/^\[(.+?)\]\s+RESP#APOYO#([^|]+)\|(ASSIGNED|ACCEPTED)$/);
            if (m) {
              const [, when, email, ev] = m;
              rows.push({
                when: new Date(when),
                level: parseInt(incident?.escalation_level) || 0,
                email: email.trim(),
                ev: `APOYO_${ev.trim()}`
              });
              continue;
            }
            // [fecha] RESP#TRANSFER|from=...;to=...;reason=...
            m = line.match(/^\[(.+?)\]\s+RESP#TRANSFER\|from=([^;]+);to=([^;]+);reason=(.*)$/);
            if (m) {
              const [, when, from, to, reason] = m;
              rows.push({
                when: new Date(when),
                level: parseInt(incident?.escalation_level) || 0,
                email: "",
                ev: 'TRANSFER',
                detail: (reason || "").trim(),
                reason: (reason || "").trim(),
                from: from.trim(),
                to: to.trim()
              });
              continue;
            }
            // [fecha] RESP#UNASSIGN#<email>|<TIPO>|<motivo>
            m = line.match(/^\[(.+?)\]\s+RESP#UNASSIGN#([^|]+)\|([^|]+)\|?(.*)$/);
            if (m) {
              const [, when, email, type, detail] = m;
              rows.push({
                when: new Date(when),
                level: parseInt(incident?.escalation_level) || 0,
                email: email.trim(),
                ev: 'UNASSIGN',
                type: (type || '').trim(),
                detail: (detail || '').trim()
              });
              continue;
            }
            // [fecha] RESP#DERIVATION|from=...;to=...;reason=...
            m = line.match(/^\[(.+?)\]\s+RESP#DERIVATION\|from=([^;]+);to=([^;]+);reason=(.*)$/);
            if (m) {
              const [, when, from, to, reason] = m;
              rows.push({
                when: new Date(when),
                level: parseInt(incident?.escalation_level) || 0,
                email: "",
                ev: 'DERIVATION',
                detail: (reason || "").trim(),
                reason: (reason || "").trim(),
                from: from.trim(),
                to: to.trim()
              });
              continue;
            }
            // [fecha] RESP#L<n>#<email>|<EVENTO>|<detalle>
            m = line.match(/^\[(.+?)\]\s+RESP#L(\d)#([^|]+)\|(ASSIGNED|ACCEPTED|REASSIGN_TO|REASSIGN_FROM|NO_RESPONSE|REJECTED::[^|]+)\|?(.*)$/);
            if (!m) continue;
            const [, when, lvl, email, ev, detail] = m;
            rows.push({
              when: new Date(when),
              level: parseInt(lvl, 10),
              email: email.trim(),
              ev: ev.trim(),              // ASSIGNED | ACCEPTED | REASSIGN_TO | REASSIGN_FROM | REJECTED::<motivo> | NO_RESPONSE
              detail: (detail || "").trim()
            });
          }

          // Asegurar eventos ASSIGNED para L2 según técnicos notificados
          if (incident?.l2_technicians_notified) {
            const notified = String(incident.l2_technicians_notified)
              .split(',')
              .map(s => s.trim().toLowerCase())
              .filter(Boolean);
            const ts = incident["Fecha-Reporte"] || incident.report_date || incident.created_at || incident.timestamp || new Date().toISOString();
            for (const tech of notified) {
              const exists = rows.some(r => r.level === 2 && r.ev === 'ASSIGNED' && r.email.toLowerCase() === tech);
              if (!exists) {
                rows.push({
                  when: new Date(ts),
                  level: 2,
                  email: tech,
                  ev: 'ASSIGNED',
                  detail: ''
                });
              }
            }
          }
          rows.sort((a,b)=> a.when - b.when);
          return rows;
        }

                // Detecta solicitudes pendientes dirigidas explícitamente al técnico indicado
        function getPendingRequestsForTechnician(logText = "", technicianEmail = "") {
          const normalizedLog = ensureLogString(logText);
          if (normalizedLog === "{{emptystring}}") return [];

          const collectTokens = (value) => {
            if (value === undefined || value === null) return [];
            if (Array.isArray(value)) {
              return value.flatMap(collectTokens).filter(Boolean);
            }
            if (typeof value === "object") {
              return Object.values(value).flatMap(collectTokens).filter(Boolean);
            }
            const raw = String(value).trim();
            if (!raw || raw === "{{emptystring}}") return [];

            const tokens = new Set();
            tokens.add(raw.toLowerCase());

            const parts = raw.split(/[;,]/);
            if (parts.length > 1) {
              for (const part of parts) {
                const cleaned = part.trim().toLowerCase();
                if (cleaned) tokens.add(cleaned);
              }
            }

            const emailMatches = raw.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/gi);
            if (emailMatches) {
              for (const mail of emailMatches) {
                tokens.add(mail.trim().toLowerCase());
              }
            }

            return Array.from(tokens).filter(Boolean);
          };

          const targetTokens = new Set(collectTokens(technicianEmail));
          if (!targetTokens.size) return [];

          const rows = parseSolicitudesLog(normalizedLog);
          if (!rows.length) return [];

          const grouped = groupByRequest(rows);
          const out = [];
          const candidateFields = [
            "to",
            "dest",
            "destino",
            "target",
            "email",
            "mail",
            "correo",
            "technician",
            "tecnico",
            "tech",
            "agent",
            "agente",
            "assignee",
            "assign",
            "assign_to",
            "assignTo",
            "assigned_to",
            "assignedTo",
            "assignado_a",
            "asignado_a",
            "asignar_a",
            "requested_to",
            "requestedTo",
            "solicitado_a",
            "solicitadoA",
            "notificado_a",
            "notificadoA",
            "notify",
            "notif_to",
            "notifTo",
            "to_email",
            "toEmail",
            "target_email",
            "targetEmail",
            "dest_email",
            "destEmail",
            "destino_email",
            "destinoEmail",
            "mail_to",
            "mailTo",
            "user",
            "owner",
            "receiver",
            "receptor",
            "contact",
            "contacto",
            "contact_email",
            "contactEmail",
            "responsable",
            "responsable_email",
            "responsableEmail",
            "emails",
            "cc",
            "bcc",
            "copy",
            "copias",
            "req_by",
            "req_by_name"
          ];

          const intersectsTargets = (values) => {
            for (const token of collectTokens(values)) {
              if (targetTokens.has(token)) return true;
            }
            return false;
          };

          for (const req of Object.values(grouped)) {
            if (!req || (req.last?.phase || "").toUpperCase() !== "REQUEST") continue;
            const meta = req.last?.meta || {};

            let directed = false;
            for (const field of candidateFields) {
              if (field in meta && intersectsTargets(meta[field])) {
                directed = true;
                break;
              }
            }

            if (!directed && intersectsTargets(meta)) {
              directed = true;
            }

            if (!directed && intersectsTargets(req.last?.metaRaw || "")) {
              directed = true;
            }

            if (!directed && Array.isArray(req.phases)) {
              for (const phase of [...req.phases].reverse()) {
                if ((phase.phase || "").toUpperCase() !== "REQUEST") continue;
                if (intersectsTargets(phase.meta || {})) {
                  directed = true;
                  break;
                }
                if (intersectsTargets(phase.metaRaw || "")) {
                  directed = true;
                  break;
                }
              }
            }

            if (directed) out.push(req);
          }

          return out;
        }

        function hasDirectedPendingRequests(incident) {
          if (!incident || !currentTechnician?.email) return false;
          const split = getSplitContext(incident);
          const log = (split?.requests?.current || []).map(entry => entry.raw).join("\n");
          const who = currentTechnician.email || "";
          if (!who) return false;
          const arr = getPendingRequestsForTechnician(log, who);
          return Array.isArray(arr) && arr.length > 0;
        }
        
       // ¿Quién es el titular vigente de un nivel?
       function getCurrentOwnerByLevel(respRows, level){
          // último evento ASSIGNED de ese nivel → titular vigente
          const lastAssigned = respRows
            .filter(r => r.level === level && r.ev === 'ASSIGNED')
            .slice(-1)[0];
          return lastAssigned ? lastAssigned.email : null;
        }
        
        // Último rechazo (motivo) por nivel, opcional
        function getLastRejectReasonByLevel(respRows, level){
          // Busca el último evento REJECTED::<motivo> en ese nivel
          for (let i = respRows.length - 1; i >= 0; i--) {
            const r = respRows[i];
            if (r.level === level && typeof r.ev === 'string' && r.ev.startsWith('REJECTED::')) {
              return r.ev.replace('REJECTED::','').trim();
            }
          }
          return '';
        }

        // Última transferencia en la que participó el técnico
        function getLastTransferFor(respRows, email){
          const lower = (email || '').toLowerCase();
          for (let i = respRows.length - 1; i >= 0; i--) {
            const r = respRows[i];
            if (r.ev === 'TRANSFER') {
              if (r.from?.toLowerCase() === lower) return { ...r, type: 'from' };
              if (r.to?.toLowerCase() === lower) return { ...r, type: 'to' };
            }
          }
          return null;
        }

        // Última derivación registrada
        function getLastDerivation(respRows){
          return respRows.filter(r => r.ev === 'DERIVATION').slice(-1)[0] || null;
        }
        
        // ¿Cómo va el técnico logueado en este nivel?
        // Devuelve: 'working' | 'seguimiento' | 'pending'
        //   - working: si es titular vigente del nivel
        //   - seguimiento: si rechazó / fue reasignado / ya pasó su respuesta
        //   - pending: si está notificado y sin respuesta en plazo (fallback con tus campos si hace falta)
        function getTechnicianStateByLevel(incident, respRows, level, technicianEmail) {
          const owner = getCurrentOwnerByLevel(respRows, level);
          if (owner && owner.toLowerCase() === (technicianEmail||"").toLowerCase()) return 'working';
        
          // ¿rechazó?
          const myEvents = respRows.filter(r => r.level === level && r.email.toLowerCase() === (technicianEmail||"").toLowerCase());
          const lastMine = myEvents[myEvents.length - 1];
          if (lastMine?.ev.startsWith("REJECTED")) return 'seguimiento';
          if (lastMine?.ev === "REASSIGN_FROM") return 'seguimiento';
        
          // Fallback “pendiente” (si aún usa campos antiguos):
          // ver si está asignado/notificado en este nivel y con SLA vigente y "⭕ Sin Respuesta"
          const now = Date.now();
          const slaEnd = getSlaEndForLevel(incident, level);
          const slaOk = slaEnd ? (Date.parse(slaEnd) - now) > 0 : false;
        
          if (level === 0) {
            if ((incident.l0_technician||"").includes(technicianEmail) && incident.l0_response === '⭕ Sin Respuesta' && slaOk) return 'pending';
          } else if (level === 1) {
            if ((incident.l1_technician||"").includes(technicianEmail) && incident.l1_response === '⭕ Sin Respuesta' && slaOk) return 'pending';
          } else if (level === 2) {
            if ((incident.l2_technicians||"").includes(technicianEmail) && (incident.l2_responses||"").includes('⭕ Sin Respuesta') && slaOk) return 'pending';
          } else if (level === 3) {
            if ((incident.l3_technician||"").includes(technicianEmail) && incident.l3_response === '⭕ Sin Respuesta' && slaOk) return 'pending';
          }
        
          return 'seguimiento';
        }
        
        // Fecha a mostrar en la tarjeta (occurrence si existe, si no, reporte)
        function getBestDate(incident) {
          const occ = incident["Fecha-Ocurrencia"] || incident.occurrence_date || incident.fecha_ocurrencia;
          const rep = incident["Fecha-Reporte"] || incident.report_date || incident.fecha_reporte;
          return occ || rep || incident.created_at || incident.timestamp || "";
        }

        function parseNotesLog(text=""){
          const lines = String(text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
          const ROLE_META = {
            TECH: { icon:'🔧', class:'note-tech' },
            SUP: { icon:'👩‍💼', class:'note-sup' }
          };
          const out = []; // {when,email,role,text,icon,class,displayName}
          for(const line of lines){
            const m = line.match(/^\[(.+?)\]\s+NOTE#([^|]+)\|([^|]+)\|(.*)$/);
            if(!m) continue;
            const [, when, email, roleRaw, msg] = m;
            const role = (roleRaw||'').trim().toUpperCase();
            const meta = ROLE_META[role] || { icon:'', class:'' };
            const emailTrim = email.trim();
            out.push({
              when: new Date(when),
              email: emailTrim,
              role,
              text: (msg||"").trim(),
              displayName: formatNameFromEmail(emailTrim),
              icon: meta.icon || '',
              class: meta.class || ''
            });
          }
          out.sort((a,b)=> a.when - b.when);
          return out;
        }
        
        function renderNotesSection(inc){
          const t = ensureLogString(inc["Comentarios (log)"] || inc.comentarios_log);
          if(!t.trim()) return `<div class="muted">Sin notas ni mensajes</div>`;
          const rows = parseNotesLog(t).slice(-20);
          const items = rows.map(r => {
            return `<li class="note-item ${r.class}">
              <span class="t-time">${formatTimeOrDate(r.when)}</span>
              <span class="t-body"><span class="note-author"><span class="note-badge">${r.icon}</span>${safe(r.displayName)}</span>: ${safe(r.text)}</span>
            </li>`;
          }).join('');
          return `<ul class="timeline">${items}</ul>`;
        }


        // =============================
        // VALIDADORES DE LÍNEAS DE LOG
        // =============================
        
        // Regex estrictas (ISO con zona, categorías/fases controladas)
        const RX_SOL = /^\[(?:\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?(?:Z|[+\-]\d{2}:\d{2}))\]\s+(?:MATERIAL|DERIVACION|APOYO|TRASPASO|REASIGNACION)#[A-Za-z0-9_\-]+\|(REQUEST|APPROVED|REJECTED)\|.*$/;
        const RX_RESP = /^\[(?:\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?(?:Z|[+\-]\d{2}:\d{2}))\]\s+(?:RESP#L[0-3]#[^|@\s]+@[^|@\s]+\.[^|@\s]+\|(ASSIGNED|ACCEPTED|REASSIGN_TO|REASSIGN_FROM|NO_RESPONSE|REJECTED::.+?)\|.*|RESP#APOYO#[^|@\s]+@[^|@\s]+\.[^|@\s]+\|(ASSIGNED|ACCEPTED)(?:\|.*)?|RESP#TRANSFER\|from=[^;]+;to=[^;]+;reason=.*|RESP#DERIVATION\|from=[^;]+;to=[^;]+;reason=.*|RESP#UNASSIGN#[^|]+\|[^|]+(?:\|.*)?)$/;
        
        function validateLogLines({ lines, kind }) {
          // kind: 'SOL' (Solicitudes) | 'RESP' (Respuestas)
          const rx = kind === 'SOL' ? RX_SOL : RX_RESP;
          const accepted = [];
          const rejected = [];
          for (let raw of (lines || [])) {
            const line = String(raw || "").trim();
            if (!line) continue;
            if (rx.test(line)) {
              accepted.push(line);
            } else {
              rejected.push({ line, reason: 'Formato inválido para ' + (kind === 'SOL' ? 'Solicitudes' : 'Respuestas') });
            }
          }
          return { accepted, rejected };
        }
        
        // Genera el nuevo texto (append seguro) y devuelve también las rechazadas
        function safeAppendLog({ currentText, newLines, kind }) {
          const { accepted, rejected } = validateLogLines({ lines: newLines, kind });
          const base = (currentText || "").trim();
          const joined = accepted.join("\n");
          const nextText = joined ? (base ? base + "\n" + joined : joined) : base;
          return { text: nextText, rejected };
        }

        // ===========================
        // VALIDACIONES PENDIENTES
        // ===========================
       // ===== Validaciones derivadas solo desde "Solicitudes (log)" =====
        const VP = { MATERIALES: "📦 Materiales", DERIVACION: "🏢 Derivación de departamento", APOYO: "👥 Apoyo segundo técnico" };
        
        function getPendingValidations(incident) {
          const log = ensureLogString(incident["Solicitudes (log)"] ?? incident.solicitudes_log ?? "");
          if (!log || log === "{{emptystring}}") return [];
          const rows = parseSolicitudesLog(log);
          const grouped = groupByRequest(rows);

          const hasMatPending = Object.values(grouped).some(g => g.cat === "MATERIAL" && g.last?.phase === "REQUEST");
          const hasApoyoPending = Object.values(grouped).some(g => g.cat === "APOYO" && g.last?.phase === "REQUEST");
          const hasDerivPending = Object.values(grouped).some(g => g.cat === "DERIVACION" && g.last?.phase === "REQUEST");

          const out = [];
          if (hasMatPending) out.push(VP.MATERIALES);
          if (hasApoyoPending) out.push(VP.APOYO);
          if (hasDerivPending) out.push(VP.DERIVACION);
          return out;
        }
        function hasValidation(incident, label){ return getPendingValidations(incident).includes(label); }
        function canResolve(incident){ return !hasValidation(incident, VP.MATERIALES); }
        
        // ===== SLA (solo en pending, si no vencido) =====
        function getCurrentLevel(incident) {
          return parseInt(incident.escalation_level ?? 0, 10);
        }
        function getSlaEndForLevel(incident, level) {
          if (level === 0) return incident.sla_l0_end || incident.sla_L0_end || "";
          if (level === 1) return incident.sla_l1_backup_end || incident.sla_l1_end || "";
          if (level === 2) return incident.sla_l2_equipo_end || incident.sla_l2_end || "";
          if (level === 3) return incident.sla_l3_responsable_end || incident.sla_l3_end || "";
          return "";
        }
        function formatRemain(ms) {
          const s = Math.max(0, Math.floor(ms / 1000));
          const h = Math.floor(s / 3600);
          const m = Math.floor((s % 3600) / 60);
          return h > 0 ? `${h}h ${m}m` : `${m}m`;
        }
        
        function renderSlaChipIfPending(incident, state) {
          if (state !== "pending") return "";
          const end = getSlaEndForLevel(incident, getCurrentLevel(incident));
          if (!end) return "";
          const delta = Date.parse(end) - Date.now();
          if (delta <= 0) return ""; // vencido → no mostrar
          const mins = delta / 60000;
          const cls = mins <= 30 ? "sla-critical" : mins <= 120 ? "sla-warning" : "sla-good";
          return `<span class="sla-timer ${cls}">⏱️ ${formatRemain(delta)}</span>`;
        }

        function setIncidentBanner(card, html) {
          if (!card) return;
          let container = card.querySelector('.incident-banner');
          if (!container) {
            container = document.createElement('div');
            container.className = 'incident-banner';
            card.prepend(container);
          }
          container.innerHTML = html;
        }
        
        // ===== Banner para estado "seguimiento" =====
        function renderSeguimientoBanner(incident, state, card) {
        
          const L = getCurrentLevel(incident);
          if (state === "working") {
            const split = getSplitContext(incident);
            const respText = (split?.current || []).map(entry => entry.raw).join("\n");
            let acept = "";
            if (respText !== "{{emptystring}}") {
              const rows = parseRespLog(respText, incident);
              const lastAccepted = rows.filter(r => r.level === L && r.ev === "ACCEPTED").slice(-1)[0];
              if (lastAccepted) acept = new Date(lastAccepted.when).toLocaleString();
            }
            setIncidentBanner(card, `<div class="seguimiento-banner">Trabajando L${L}${acept ? ` · ${acept}` : ""}</div>`);
            return true;
          }
          if (state !== "seguimiento") return false;
            
          const end = getSlaEndForLevel(incident, L);
          const vencido = end ? (Date.now() > Date.parse(end)) : false;
        
          // Preferir motivo desde "Respuestas (log)"
          const split = getSplitContext(incident);
          const respText = (split?.current || []).map(entry => entry.raw).join("\n");
          let rows = [];
          let reject = null;
          if (respText.trim()) {
            rows = parseRespLog(respText, incident);
            reject = getLastRejectReasonByLevel(rows, L);
          } else {
            // Fallback a tus campos antiguos
            reject =
              (L===0 && incident.l0_reject_reason) ||
              (L===1 && incident.l1_reject_reason) ||
              (L===2 && incident.l2_reject_reasons) ||
              "";
          }

          // ¿Fue aceptado por otro técnico?
          const myEmail = (currentTechnician?.email || '').toLowerCase();
          const acceptedRows = rows.filter(r => r.level === L && r.ev === 'ACCEPTED');
          const acceptedByOther = acceptedRows.some(r => r.email.toLowerCase() !== myEmail);
          if (acceptedByOther) {
            setIncidentBanner(card, `<div class="seguimiento-banner">ℹ️ En seguimiento</div>`);
            return true;
          }
        
          const finTxt = end ? formatDate(end) : "";
          const hasAccepted = acceptedRows.length > 0;
          if (!hasAccepted && vencido) {
            setIncidentBanner(card, `<div class="seguimiento-banner">⏰ <strong>SLA vencido</strong> en L${L}${finTxt ? ` · ${finTxt}` : ''}</div>`);
            return true;
          }
          if (reject)  {
            setIncidentBanner(card, `<div class="seguimiento-banner">❌ <strong>Rechazado en L${L}</strong>${reject ? ` — Motivo: ${reject}` : ""}</div>`);
            return true;
          }
          if (L === 3) {
            let acept = "";
            const lastAccepted = rows.filter(r => r.level === L && r.ev === "ACCEPTED").slice(-1)[0];
            if (lastAccepted) acept = new Date(lastAccepted.when).toLocaleString();
            setIncidentBanner(card, `<div class="seguimiento-banner">Trabajando L3${acept ? ` · ${acept}` : ""}</div>`);
            return true;
          }
          setIncidentBanner(card, `<div class="seguimiento-banner">ℹ️ En seguimiento en L${L}</div>`);
          return true;
        }

        
        // ===== Botones por estado (usar SIEMPRE esta) =====
        function renderActionButtonsByState(state, incident) {
          const resolveDisabled = !canResolve(incident);
          const resolveAttr = resolveDisabled
            ? `title="Pendiente validar materiales" aria-label="Pendiente validar materiales"`
            : `title="Resolver incidencia" aria-label="Resolver incidencia"`;

          const incidentData = b64EncodeUnicode(JSON.stringify(incident));
          const receiverBlock = renderReceiverActionBlock(incident);
            
          const wrapStart = `<div class="action-buttons">`;
          const wrapEnd = `</div>`;
        
          if (state === "pending") {
          return `
             ${wrapStart}
              <button class="btn btn-primary" title="Aceptar incidencia" aria-label="Aceptar incidencia" onclick="aceptarIncidencia('${incident.id}')">✅ Aceptar</button>
              <button class="btn btn-secondary" title="Rechazar incidencia" aria-label="Rechazar incidencia" onclick="rechazarIncidencia('${incident.id}')">❌ Rechazar</button>
              <button class="btn btn-resource" title="Consultar recursos de referencia" aria-label="Consultar recursos de referencia" onclick="openResourcesModal(JSON.parse(decodeURIComponent(atob('${incidentData}'))))">📚 Recursos</button>
             ${receiverBlock}
            ${wrapEnd}`;
        }
          if (state === "working") {
            return `
               ${wrapStart}
                <button class="btn btn-secondary" title="Solicitar ayuda de otro técnico" aria-label="Solicitar ayuda de otro técnico" onclick="abrirAyuda('${incident.id}')">🛠️ Pedir ayuda</button>
                <button class="btn btn-secondary" title="Solicitar materiales" aria-label="Solicitar materiales" onclick="abrirMateriales('${incident.id}')">📦 Materiales</button>
                <button class="btn btn-primary" ${resolveDisabled ? "disabled" : ""} ${resolveAttr}
                onclick="!this.disabled && abrirResolver('${incident.id}')">✅ Resolver</button>
                ${shouldShowSolicitarTraspaso() ? `<button class="btn btn-secondary" title="Solicitar traspaso temporalmente" aria-label="Solicitar traspaso temporalmente" onclick="solicitarTraspaso('${incident.id}')">🕐 Solicitar traspaso</button>` : ''}
                <button class="btn btn-resource" title="Consultar recursos de referencia" aria-label="Consultar recursos de referencia" onclick="openResourcesModal(JSON.parse(decodeURIComponent(atob('${incidentData}'))))">📚 Recursos</button>
                ${receiverBlock}
              ${wrapEnd}`;
          }
          // seguimiento
          return `
            ${wrapStart}
              <button class="btn btn-primary" title="Solicitar asignación" aria-label="Solicitar asignación" onclick="solicitarAsignacion('${incident.id}')">📌 Solicitar asignación</button>
              <button class="btn btn-resource" title="Consultar recursos de referencia" aria-label="Consultar recursos de referencia" onclick="openResourcesModal(JSON.parse(decodeURIComponent(atob('${incidentData}'))))">📚 Recursos</button>
              ${receiverBlock}
            ${wrapEnd}`;
        }

        function renderReceiverActionBlock(incident) {
          if (!incident || !currentTechnician?.email) return "";
          const split = getSplitContext(incident);
          const log = (split?.requests?.current || []).map(entry => entry.raw).join("\n");
          const pending = getPendingRequestsForTechnician(log, currentTechnician.email);
          if (!pending.length) return "";

          const _lvl = getCurrentLevel(incident);
          const _deadline = getSlaEndForLevel(incident, _lvl) || "";

          const sorted = [...pending].sort((a, b) => {
            const aw = a?.last?.when ? Date.parse(a.last.when) : 0;
            const bw = b?.last?.when ? Date.parse(b.last.when) : 0;
            return aw - bw;
          });

          const items = sorted.map(req => renderReceiverActionItem(req, incident)).join("");
          const title = pending.length === 1
            ? "📥 Tienes 1 solicitud pendiente de tu respuesta"
            : `📥 Tienes ${pending.length} solicitudes pendientes de tu respuesta`;

          return `
            <div class="receiver-actions-wrapper">
              <div class="receiver-actions-title">${title}</div>
              ${_deadline ? `<div class="receiver-action-meta">Responder en <span class="countdown" data-deadline="${safe(_deadline)}"></span></div>` : ``}
              ${items}
            </div>
          `;
        }

        function renderReceiverActionItem(req, incident) {
          if (!req || !incident) return "";
          const info = REQUEST_CAT_INFO[req.cat] || { icon: "📥", label: req.cat };
          const summary = describeReceiverRequest(req);
          const when = req?.last?.when ? formatTimeOrDate(req.last.when) : "";
          const levelLabel = Number.isFinite(req?.level) ? `L${req.level}` : "";

          const payload = b64EncodeUnicode(JSON.stringify({
            cat: req.cat,
            id: req.id,
            req: req.req,
            level: req.level,
            when: req?.last?.when || null,
            meta: req?.last?.meta || {},
            metaRaw: req?.last?.metaRaw || "",
            summary: summary.plain
          }));

          const incidentIdJSON = JSON.stringify(incident.id ?? "");
          const payloadJSON = JSON.stringify(payload);

          const showDecisionButtons = (req?.last?.phase || '').toUpperCase() === 'REQUEST';

          if (!showDecisionButtons) {
            return `
            <div class="receiver-action-item">
              <div class="receiver-action-main">
                <div class="receiver-action-icon">${safe(info.icon || "📥")}</div>
                <div class="receiver-action-text">
                  <div class="receiver-action-label">${safe(info.label || req.cat)}${levelLabel ? ` · ${safe(levelLabel)}` : ""}</div>
                  <div class="receiver-action-detail">${summary.html}</div>
                  ${when ? `<div class="receiver-action-meta">Solicitada ${safe(when)}</div>` : ""}
                </div>
              </div>
              </div>`;
          }

          return `
                <div class="receiver-action-item">
                  <div class="receiver-action-main">
                    <div class="receiver-action-icon">${safe(info.icon || "📥")}</div>
                    <div class="receiver-action-text">
                      <div class="receiver-action-label">${safe(info.label || req.cat)}${levelLabel ? ` · ${safe(levelLabel)}` : ""}</div>
                      <div class="receiver-action-detail">${summary.html}</div>
                      ${when ? `<div class="receiver-action-meta">Solicitada ${safe(when)}</div>` : ""}
                    </div>
                  </div>
                  <div class="receiver-action-buttons">
                <button class="btn btn-primary" type="button" onclick="receiverDecision(${incidentIdJSON}, ${payloadJSON}, 'accept')">✅ Aceptar</button>
                <button class="btn btn-secondary" type="button" onclick="receiverDecision(${incidentIdJSON}, ${payloadJSON}, 'reject')">❌ Rechazar</button>
              </div>
               </div>
          `;
        }

        function initDirectedCountdowns(){
          document.querySelectorAll('.receiver-actions-wrapper .countdown').forEach(span => {
            if (!span || span.dataset.countdownInit === '1') return;
            const dd = span.dataset.deadline;
            if (!dd) return;
            const target = Date.parse(dd);
            if (Number.isNaN(target)) {
              span.textContent = '--:--';
              return;
            }
            span.dataset.countdownInit = '1';
            const box = span.closest('.receiver-actions-wrapper');
            if (!box) return;
            box.classList.remove('expired');
            box.classList.remove('blink');
            const tick = () => {
              const ms = target - Date.now();
              if (ms <= 0) {
                span.textContent = '00:00';
                box.classList.remove('blink');
                box.classList.add('expired');
                return;
              }
              const m = Math.floor(ms / 60000);
              const s = Math.floor((ms % 60000) / 1000);
              span.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
              box.classList.toggle('blink', ms <= 5 * 60 * 1000);
              requestAnimationFrame(tick);
            };
            tick();
          });
        }

        function describeReceiverRequest(req) {
          const meta = req?.last?.meta || {};
          const pick = (...keys) => {
            for (const key of keys) {
              if (!(key in meta)) continue;
              const value = meta[key];
              if (value === undefined || value === null) continue;
              const str = String(value).trim();
              if (!str || str === "{{emptystring}}") continue;
              return str;
            }
            return "";
          };

          const htmlParts = [];
          const plainParts = [];
          const pushPart = (value, opts = {}) => {
            if (!value) return;
            const cleaned = cleanLevelTags(String(value));
            if (!cleaned) return;
            const htmlValue = safe(cleaned);
            if (opts.prefix) {
              htmlParts.push(`${opts.prefix}${htmlValue}`);
              const plainPrefix = opts.prefixPlain || opts.prefix;
              plainParts.push(`${plainPrefix} ${cleaned}`.trim());
            } else {
              htmlParts.push(htmlValue);
              plainParts.push(cleaned);
            }
          };

          const cat = (req?.cat || "").toUpperCase();
          if (cat === "MATERIAL") {
            const name = pick("name", "material", "item", "code", "material_name", "label");
            const qty = pick("qty", "quantity", "qty_requested");
            const unit = pick("unit", "units", "unidad");
            let base = name;
            if (qty) {
              const quantity = unit ? `×${qty} ${unit}` : `×${qty}`;
              base = [base, quantity].filter(Boolean).join(" · ");
            }
            pushPart(base || pick("req"));
            pushPart(pick("reason", "detail", "detalle", "justification", "notes", "comment"));
          } else if (cat === "APOYO") {
            pushPart(pick("detail", "detalle", "reason", "comment", "notes", "justification"));
          } else if (["TRASPASO", "DERIVACION", "REASIGNACION"].includes(cat)) {
            pushPart(pick("to", "dest", "destino", "target", "name"));
            const shift = pick("shift", "turno");
            if (shift) pushPart(`Turno ${shift}`);
            pushPart(pick("reason", "detail", "detalle", "justification", "comment", "notes"));
            const origin = pick("from", "by", "requester", "requested_by", "solicitado_por", "origin");
            if (origin) pushPart(origin, { prefix: "👤 ", prefixPlain: "Solicitado por" });
          } else {
            pushPart(pick("detail", "detalle", "reason", "comment", "notes", "description", "info", "information"));
          }

          const requester = pick("from", "by", "requester", "requested_by", "solicitado_por", "owner", "contact");
          if (requester && !plainParts.some(part => part.includes(requester))) {
            pushPart(requester, { prefix: "👤 ", prefixPlain: "Solicitado por" });
          }

          if (!htmlParts.length) {
            const fallback = "Revisa y responde la solicitud.";
            return { html: safe(fallback), plain: fallback };
          }

          return {
            html: htmlParts.join(" · "),
            plain: plainParts.join(" · ")
          };
        }
        // ========================================
        //  INICIALIZACIÓN Y ACCESO DIRECTO URL
        // ========================================
        let incidentsContainer = null;
         document.addEventListener('DOMContentLoaded', async () => {
            incidentsContainer = document.querySelector('.incidents-section .incidents-list');
            checkDirectAccess();

            const matCode = document.getElementById('matCode');
            const matUnit = document.getElementById('matUnit');
            const matQty = document.getElementById('matQty');
            const addMatBtn = document.getElementById('addMat');
            const sendMatBtn = document.getElementById('sendMatReq');
            const matList = document.getElementById('matList');

            const handleMatInput = () => updateMatControls();
            [matCode, matUnit, matQty].forEach((input) => {
              if (!input) return;
              input.addEventListener('input', handleMatInput);
              input.addEventListener('change', handleMatInput);
            });
            if (addMatBtn) {
              addMatBtn.addEventListener('click', (event) => {
                event.preventDefault();
                addTmpMat();
              });
            }

            if (sendMatBtn) {
              sendMatBtn.addEventListener('click', (event) => {
                event.preventDefault();
                sendMaterialRequest();
              });
            }

            if (matList) {
              matList.addEventListener('click', (event) => {
                const btn = event.target.closest('button[data-remove]');
                if (!btn) return;
                const index = Number(btn.dataset.remove);
                if (Number.isInteger(index)) {
                  removeTmpMat(index);
                }
              });
            }
            renderTmpMat();
            updateMatControls();

            try {
              const inv = await loadInventoryLight();
              await setupMaterialAutocomplete();
              await setupFamilyAndNameSearch();
              inventoryLoadedOk = Array.isArray(inv) && inv.length > 0;
              if (!inventoryLoadedOk) {
                showToast('❌ Inventario no disponible. Ingresa los datos manualmente.');
              }
            } catch (err) {
              inventoryLoadedOk = false;
              showToast('❌ Inventario no disponible. Ingresa los datos manualmente.');
            }
            document.querySelectorAll('button[aria-label="Solicitar materiales"]').forEach(btn => btn.disabled = false);

            const emailInput = document.getElementById('emailInput');
            const loginBtn   = document.getElementById('loginBtn');
        
          emailInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginWithPIN();
          });
          loginBtn.addEventListener('click', loginWithPIN);
        });

        function checkDirectAccess() {
          const urlParams = new URLSearchParams(window.location.search);
          const incidentId = urlParams.get('incident_id');
          const action = urlParams.get('action');
        
          if (incidentId) {
            directIncidentId = incidentId;
            directScrollDone = false; // asegúrate de que haga scroll una sola vez tras render
        
            const directAccessInfo = document.createElement('div');
            directAccessInfo.style.cssText = `
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              background: #17a2b8;
              color: white;
              padding: 12px 20px;
              text-align: center;
              z-index: 10001;
              font-weight: 600;
            `;
            directAccessInfo.innerHTML = `
              📧 Acceso directo a incidencia: <strong>${incidentId}</strong>
              ${action ? ` | Acción: <strong>${action}</strong>` : ''}
            `;
            document.body.appendChild(directAccessInfo);
        
            if (action) pendingAction = action;
          }
        }


        // ========================================
        //  AYUDA / GESTIÓN - TARJETAS EXPANDIBLES
        // ========================================
        const ayudaOptions = [
          { id: "notes", title: "📝 Aportar notas",
            description: "Agrega más detalles sobre la incidencia.",
            fields: `<textarea id="infoExtra" class="form-control" rows="3" placeholder="Describe la información adicional..."></textarea>`
          },
          { id: "derivar_departamento", title: "🏢 Derivar a otro departamento",
        description: "Transferir incidencia a otro departamento.",
        fields: `
          <label class="form-label">Departamento:</label>
          <select id="departamentoSelect" class="form-control">
            <option value="">-- Selecciona --</option>
            <option value="operaciones">🏭 Operaciones</option>
            <option value="mtto_mecanico">🔧 Mtto-Mecánico</option>
            <option value="mtto_electrico">⚡ Mtto-Eléctrico</option>
          </select>
          <label class="form-label">Motivo:</label>
        <textarea id="motivoDerivacion" class="form-control" rows="3"></textarea> `
      },
        ...(
          shouldShowSolicitarTraspaso()
            ? [{ id: "solicitar_traspaso", title: "🕐 Solicitar traspaso",
                description: "Solicitar traspaso al siguiente turno o departamento.",
                fields: `
          <label class="form-label">Motivo:</label>
          <select id="solicitarTraspasoReason" class="form-control">
            <option value="">-- Selecciona --</option>
            <option value="fin_turno">Fin de turno</option>
            <option value="derivar_incidencia">Derivar incidencia</option>
          </select>
          <label class="form-label">Detalles:</label>
          <textarea id="solicitarTraspasoDetalles" class="form-control" rows="3" placeholder="Detalles..."></textarea>
      `}] : []
        ),
      { id: "apoyo_segundo_tecnico", title: "👥 Solicitar segundo técnico",
        description: "Pide apoyo de otro técnico.",
        fields: `<textarea id="detalleApoyo" class="form-control" rows="3" placeholder="Explica por qué necesitas apoyo."></textarea>`
      }
    ];
        
        let selectedAyuda = null;
        
        function loadAyudaOptions() {
          const container = document.getElementById('ayudaOptions');
          container.innerHTML = ayudaOptions.map(opt => `
            <div class="ayuda-card" data-id="${opt.id}" onclick="selectAyuda('${opt.id}', event)">
              <h4>${opt.title}</h4>
              <p>${opt.description}</p>
            </div>
          `).join('');
        }
        function solicitarTraspaso(id){
          if (!shouldShowSolicitarTraspaso()) return;
          showAyudaModal(id);
          // preselecciona la tarjeta de “solicitar_traspaso”
          setTimeout(() => {
            const card = document.querySelector('.ayuda-card[data-id="solicitar_traspaso"]');
            if (card) { card.click(); }
          }, 0);
        }

        
        // 2) Al seleccionar tarjeta, muestra botón que abre la URL específica si existe
        function selectAyuda(id, ev) {
          selectedAyuda = ayudaOptions.find(opt => opt.id === id);
          document.querySelectorAll('.ayuda-card').forEach(c => c.classList.remove('selected'));
          ev.currentTarget.classList.add('selected');
        
          const extra = document.getElementById('ayudaExtraFields');
          if (selectedAyuda.fields) {
            extra.innerHTML = `<div class="ayuda-extra active">${selectedAyuda.fields}</div>`;
          } else if (selectedAyuda.urlKey) {
            const inc = allIncidents.find(i => i.id === currentIncidentId);
            const targetURL = inc?.[selectedAyuda.urlKey] || inc?.url || '#';
            extra.innerHTML = `<div class="ayuda-extra active">
              <a href="${targetURL}" target="_blank" rel="noopener noreferrer" class="btn btn-info">🌐 Abrir en Notion</a>
            </div>`;
          } else {
            extra.innerHTML = '';
          }
        }
        
        function procesarAyuda() {
          if (!selectedAyuda) { showNotification('Selecciona una opción antes de continuar.', 'error'); return; }
        
          const id = selectedAyuda.id;
            
        // 1) Tarjetas que abren URL (si existieran con urlKey)
          if (selectedAyuda.urlKey) {
            const inc = allIncidents.find(i => i.id === currentIncidentId);
            const targetURL = inc?.[selectedAyuda.urlKey] || inc?.url;
           if (targetURL) window.open(targetURL, '_blank');
           closeModal('ayudaModal');
           return;
         }

          if (id === 'notes') {
            const info = (document.getElementById('infoExtra')?.value || '').trim();
            if (!info) { showNotification('Debes ingresar una nota antes de continuar.', 'error'); return; }
            handleAction('notes', currentIncidentId, {
              description: info
            });
            closeModal('ayudaModal');
            return;
          }
        
          if (id === 'derivar_departamento') {
            const depto = document.getElementById('departamentoSelect')?.value;
            const motivo = (document.getElementById('motivoDerivacion')?.value || '').trim();
            if (!depto) { showNotification('Selecciona el departamento destino', 'error'); return; }
            handleAction('derivar_departamento', currentIncidentId, {
              target_department: depto,
              derivation_reason: motivo
            });
            closeModal('ayudaModal');
            return;
          }
        
          if (id === 'apoyo_segundo_tecnico') {
            const motivo = (document.getElementById('detalleApoyo')?.value || '').trim();
            handleAction('solicitar_apoyo', currentIncidentId, {
              description: motivo
            });
            closeModal('ayudaModal');
            return;
          }
    
          if (id === 'solicitar_traspaso' && shouldShowSolicitarTraspaso()) {
            const reason = document.getElementById('solicitarTraspasoReason')?.value;
            const details = (document.getElementById('solicitarTraspasoDetalles')?.value || '').trim();
            if (!reason) { showNotification('Selecciona un motivo', 'error'); return; }
            if (reason === 'fin_turno') {
              // Validación de “últimos 15 minutos de turno”
              const now = new Date();
              const h = now.getHours(), m = now.getMinutes();
              const nearEnd = (h===13 && m>=45) || (h===21 && m>=45) || (h===5 && m>=45);
              if (!nearEnd) {
                showNotification('❌ Fin de turno solo disponible en los últimos 15 minutos del turno\n\nTurnos: 6-14h | 14-22h | 22-6h', 'error');
                return;
              }
            }
              handleAction('solicitar_traspaso', currentIncidentId, {
              reason,
              details
            });
            closeModal('ayudaModal');
            return;
          }
        }
        document.addEventListener("DOMContentLoaded", loadAyudaOptions);


            // ========================================
            //  SOLICITAR MATERIALES - SIMPLE
            // ========================================
            const __invByFamily = new Map();
            const __invByCode = new Map();
            let __matAutocompleteReady = false;
            let __familySearchReady = false;
            let __matHelperEl = null;

            function buildMaterialIndexes(items = []) {
                __invByFamily.clear();
                __invByCode.clear();
                if (!Array.isArray(items)) return;

                items.forEach((raw) => {
                    if (!raw) return;
                    const code = String(raw.code || '').trim();
                    if (!code) return;

                    const family = String(raw.family || 'Otros').trim() || 'Otros';
                    const normalizedCode = code.toUpperCase();
                    const unit = normalizeUnit(raw.unit) || raw.unit || '';
                    const name = String(raw.name || '').trim();
                    const item = {
                        ...raw,
                        code: normalizedCode,
                        unit,
                        name,
                        family,
                        searchable: `${normalizedCode} ${name}`.toUpperCase()
                    };

                    __invByCode.set(normalizedCode, item);
                    if (!__invByFamily.has(family)) {
                        __invByFamily.set(family, []);
                    }
                    __invByFamily.get(family).push(item);
                });

                __invByFamily.forEach((list) => {
                    list.sort((a, b) => a.code.localeCompare(b.code));
                });
            }

            function ensureMatCodeDatalist() {
                let datalist = document.getElementById('mat-code-options');
                if (datalist) return datalist;
                datalist = document.createElement('datalist');
                datalist.id = 'mat-code-options';
                document.body.appendChild(datalist);
                return datalist;
            }

            function ensureMatHelperElement() {
                if (__matHelperEl && document.body.contains(__matHelperEl)) return __matHelperEl;
                const codeInput = document.getElementById('matCode');
                if (!codeInput) return null;
                const container = codeInput.closest('.form-group');
                if (!container) return null;

                let helper = container.querySelector('.mat-helper');
                if (!helper) {
                    helper = document.createElement('div');
                    helper.className = 'mat-helper';
                    helper.style.fontSize = '0.75rem';
                    helper.style.marginTop = '4px';
                    helper.style.color = 'var(--gray-600)';
                    helper.style.minHeight = '1em';
                    helper.style.transition = 'color 0.2s ease';
                    container.appendChild(helper);
                }
                __matHelperEl = helper;
                return helper;
            }

            function updateMatHelper(item, term = '') {
                const helper = ensureMatHelperElement();
                if (!helper) return;
                if (item) {
                    const parts = [item.name || ''];
                    if (item.family) parts.push(item.family);
                    helper.textContent = parts.filter(Boolean).join(' · ');
                    helper.style.color = 'var(--gray-600)';
                } else if (term) {
                    helper.textContent = 'Código no encontrado en el inventario.';
                    helper.style.color = 'var(--danger-dark)';
                } else {
                    helper.textContent = '';
                    helper.style.color = 'var(--gray-600)';
                }
            }

            function refreshMaterialOptions() {
                const datalist = ensureMatCodeDatalist();
                if (!datalist) return;
                datalist.innerHTML = '';
                const fragment = document.createDocumentFragment();
                __invByFamily.forEach((items) => {
                    items.forEach((item) => {
                        const labelParts = [item.code];
                        if (item.name) labelParts.push(item.name);
                        if (item.family) labelParts.push(item.family);
                        const option = document.createElement('option');
                        const label = labelParts.join(' — ');
                        option.value = item.code;
                        option.label = label;
                        option.textContent = label;
                        fragment.appendChild(option);
                    });
                });
                datalist.appendChild(fragment);
            }

            function applyInventoryMaterial(item) {
                if (!item) return;
                const codeInput = document.getElementById('matCode');
                const unitInput = document.getElementById('matUnit');
                if (codeInput) {
                    codeInput.value = item.code;
                    codeInput.setAttribute('data-selected-code', item.code);
                    codeInput.title = item.name ? `${item.code} — ${item.name}` : item.code;
                }
                if (unitInput) {
                    unitInput.value = item.unit || '';
                }
                updateMatHelper(item);
                updateMatControls();
            }

            function handleMatCodeInput(ev) {
                const value = (ev.target?.value || '').trim();
                if (!value) {
                    updateMatHelper(null);
                    updateMatControls();
                    return;
                }
                const item = __invByCode.get(value.toUpperCase());
                if (item) {
                    applyInventoryMaterial(item);
                } else {
                    updateMatHelper(null, value);
                    updateMatControls();
                }
            }

            async function setupMaterialAutocomplete() {
                if (__matAutocompleteReady) return;
                const codeInput = document.getElementById('matCode');
                if (!codeInput) return;

                const items = Array.isArray(inventory) && inventory.length
                    ? inventory
                    : await loadInventoryLight();

                if (!Array.isArray(items) || !items.length) return;

                buildMaterialIndexes(items);
                refreshMaterialOptions();

                codeInput.setAttribute('list', 'mat-code-options');
                codeInput.setAttribute('autocomplete', 'off');

                codeInput.addEventListener('input', handleMatCodeInput);
                codeInput.addEventListener('change', handleMatCodeInput);
                codeInput.addEventListener('blur', handleMatCodeInput);
                codeInput.addEventListener('focus', () => {
                    const current = __invByCode.get((codeInput.value || '').trim().toUpperCase());
                    updateMatHelper(current || null);
                });
                codeInput.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter') {
                        const item = __invByCode.get((codeInput.value || '').trim().toUpperCase());
                        if (item) applyInventoryMaterial(item);
                    }
                });

                updateMatHelper(__invByCode.get((codeInput.value || '').trim().toUpperCase()) || null);
                __matAutocompleteReady = true;
            }

            async function setupFamilyAndNameSearch() {
                if (__familySearchReady) return;

                const matFamily = document.getElementById('matFamily');
                const matSearch = document.getElementById('matSearch');
                const matOptions = document.getElementById('matOptions');

                if (!matFamily || !matSearch || !matOptions) return;

                const items = Array.isArray(inventory) && inventory.length
                    ? inventory
                    : await loadInventoryLight();

                if (!Array.isArray(items) || !items.length) return;

                if (!__invByCode.size || !__invByFamily.size) {
                    buildMaterialIndexes(items);
                }

                const families = new Set();
                __invByFamily.forEach((_items, family) => {
                    if (family) families.add(family);
                });

                const sortedFamilies = Array.from(families).sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));

                matFamily.innerHTML = '';
                const allOption = document.createElement('option');
                allOption.value = '';
                allOption.textContent = 'Todas las familias';
                matFamily.appendChild(allOption);
                sortedFamilies.forEach((family) => {
                    const option = document.createElement('option');
                    option.value = family;
                    option.textContent = family;
                    matFamily.appendChild(option);
                });

                const allItems = Array.from(__invByCode.values());

                const renderOptions = () => {
                    const selectedFamily = matFamily.value;
                    const baseList = selectedFamily
                        ? (__invByFamily.get(selectedFamily) || [])
                        : allItems;

                    const uniqueByCode = new Map();
                    baseList.forEach((item) => {
                        if (!item || uniqueByCode.has(item.code)) return;
                        uniqueByCode.set(item.code, item);
                    });

                    const sortedItems = Array.from(uniqueByCode.values()).sort((a, b) => {
                        const nameA = (a.name || '').toLocaleLowerCase('es');
                        const nameB = (b.name || '').toLocaleLowerCase('es');
                        if (nameA === nameB) return a.code.localeCompare(b.code);
                        return nameA.localeCompare(nameB);
                    });

                    matOptions.innerHTML = '';
                    sortedItems.forEach((item) => {
                        const option = document.createElement('option');
                        const label = [item.name, item.code].filter(Boolean).join(' — ') || item.code;
                        option.value = item.code;
                        option.label = label;
                        option.textContent = label;
                        matOptions.appendChild(option);
                    });
                };

                renderOptions();

                matFamily.addEventListener('change', () => {
                    renderOptions();
                    matSearch.value = '';
                });

                matSearch.addEventListener('change', () => {
                    const rawTerm = (matSearch.value || '').trim();
                    if (!rawTerm) return;

                    const normalizedTerm = rawTerm.toUpperCase();
                    let item = __invByCode.get(normalizedTerm);

                    if (!item) {
                        item = allItems.find((candidate) => (candidate.name || '').toUpperCase() === rawTerm.toUpperCase());
                    }

                    if (!item && rawTerm.includes('—')) {
                        const parts = rawTerm.split('—');
                        const lastPart = parts[parts.length - 1]?.trim().toUpperCase();
                        if (lastPart) {
                            item = __invByCode.get(lastPart);
                        }
                    }

                    if (item) {
                        applyInventoryMaterial(item);
                    } else {
                        updateMatHelper(null, rawTerm);
                    }
                });

                __familySearchReady = true;
            }
        
            let tmpMat = [];
            
            function matFormValues() {
                const codeInput = document.getElementById('matCode');
                const unitInput = document.getElementById('matUnit');
                const qtyInput = document.getElementById('matQty');
                
                const code = (codeInput?.value || '').trim();
                const unitRaw = (unitInput?.value || '').trim();
                const qtyText = (qtyInput?.value || '').trim().replace(',', '.');
                const qty = Number(qtyText);

                return {
                    code,
                    unit: unitRaw,
                    qty,
                    hasValidCode: code.length > 0,
                    hasValidUnit: unitRaw.length > 0,
                    hasValidQty: Number.isFinite(qty) && qty > 0
                };
            }

            function resetMatForm() {
                const codeInput = document.getElementById('matCode');
                const unitInput = document.getElementById('matUnit');
                const qtyInput = document.getElementById('matQty');

                if (codeInput) codeInput.value = '';
                if (unitInput) unitInput.value = '';
                if (qtyInput) qtyInput.value = '';
            }

            function updateMatControls() {
                const addBtn = document.getElementById('addMat');
                if (!addBtn) return;

                const { hasValidCode, hasValidUnit, hasValidQty } = matFormValues();
                addBtn.disabled = !(hasValidCode && hasValidUnit && hasValidQty);
            }

            function renderTmpMat() {
                const table = document.getElementById('matList');
                const tbody = table ? table.querySelector('tbody') : null;
                if (!tbody) return;
                if (!Array.isArray(tmpMat) || tmpMat.length === 0) {
                    tbody.innerHTML = `<tr class="empty"><td colspan="4">Sin materiales añadidos.</td></tr>`;
                } else {
                  tbody.innerHTML = tmpMat.map((item, index) => `
                        <tr>
                            <td>${safe(item.code)}</td>
                            <td>${safe(item.unit)}</td>
                            <td class="num">${safe(String(item.qty))}</td>
                            <td style="width:40px;text-align:center;">
                                <button type="button" data-remove="${index}" title="Quitar material">✖️</button>
                            </td>
                        </tr>
                    `).join('');
                }

              const sendBtn = document.getElementById('sendMatReq');
                if (sendBtn) {
                    sendBtn.disabled = tmpMat.length === 0;
                }
            }
            function addTmpMat() {
                const { code, unit, qty, hasValidCode, hasValidUnit, hasValidQty } = matFormValues();
                if (!hasValidCode || !hasValidUnit || !hasValidQty) return;
                
                tmpMat.push({
                    code: code.toUpperCase(),
                    unit,
                    qty: Math.round(qty * 1000) / 1000
                });

                renderTmpMat();
                resetMatForm();
                updateMatControls();
            }

            function removeTmpMat(index) {
                if (!Number.isInteger(index) || index < 0 || index >= tmpMat.length) return;
                tmpMat.splice(index, 1);
                renderTmpMat();
            }

            async function sendMaterialRequest() {
                if (!Array.isArray(tmpMat) || tmpMat.length === 0) {
                    showNotification('No hay materiales para enviar.', 'error');
                    return;
                }
                const btn = document.getElementById('sendMatReq');
                if (btn) btn.disabled = true;

                const items = tmpMat.map(({ code, unit, qty }) => ({
                    code,
                    unit: normalizeUnit(unit) || unit,
                    qty: Number(qty)
                }));

                try {
                    const ok = await handleAction('request_materials', currentIncidentId, { items });
                    if (ok) {
                        tmpMat = [];
                        renderTmpMat();
                        closeModal('materialesModal');
                    } else {
                        showNotification('Error al enviar solicitud.', 'error');
                        if (btn) btn.disabled = tmpMat.length === 0;
                    }
                } catch (error) {
                    showNotification('Error al enviar solicitud.', 'error');
                    if (btn) btn.disabled = tmpMat.length === 0;
                }
            }
            
    // Estado en memoria
    let currentStatusFilter = 'all';   // 'all' | 'nueva' | 'asignada' | 'escalado' | 'seguimiento'
    
    // Spinner
    function showSpinner(){
      const el = document.getElementById('incidentsContainer');
      if (el) el.innerHTML = `<div class="loading-spinner">🔄 Cargando incidencias...</div>`;
    }

    // Helpers existentes (SLA / seguimiento / safe / fecha)
    const HTML_ESCAPE_MAP = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    };

    function safe(value){
      const str = String(value ?? '');
      if (str === '{{emptystring}}') return '';
      return str.replace(/[&<>"']/g, ch => HTML_ESCAPE_MAP[ch]);
    }
    function dateVisible(inc){
      return safe(inc.occurrence_date) || safe(inc.report_date) || '';
    }

    // Estado real calculado para *este* técnico
    function computeCardState(inc){
      try{
        return getIncidentRealState(inc, currentTechnician?.email || '');
      }catch(e){
        // Fallback conservador
        return 'seguimiento';
      }
    }
    
    function matchesStatus(inc, status){
      if (status === 'all') return true;
      return computeCardState(inc) === status; // 'pending' | 'working' | 'seguimiento'
    }

        // ---------- Handlers de botones de filtro (llamados desde el HTML con onclick) ----------
        function filterByStatus(status, element){
          currentStatusFilter = status;
          document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));
          if (element) element.classList.add('active');
          applyFiltersAndRender();
        }
        function countNewItems(inc){
          const ref = lastSeen;
          let notes = 0;

          const nlog = inc["Comentarios (log)"] || inc.comentarios_log || '';
            if(nlog){
              notes = parseNotesLog(nlog)
                .filter(r => r.when > ref && r.role === 'SUP').length;
            }
          return {notes};
        }

        function markNotesSeen(detailsEl){
          if(!detailsEl.open) return;
          lastSeen = new Date();
          localStorage.setItem('lastSeen', lastSeen.toISOString());
          const badge = detailsEl.querySelector('.badge-notes');
          if(badge) badge.remove();
        }
    

    // --------- RENDER NUEVO (no tocar) ----------
        function incidentCardHTML(inc, stateOverride) {
          const state = stateOverride ?? getIncidentRealState(inc, currentTechnician?.email || "");
          const news = countNewItems(inc);
          // Extrae prioridad desde el ID si viene incluida allí
          const idWithPriority = String(inc.id || '');
          const priorityFromId = idWithPriority.match(/\s*[—-]\s*(CRITICA|CRÍTICA|ALTA|MEDIA|BAJA)\s*$/i);
          let displayId = idWithPriority;
          let priority = inc.priority || '';
          if (!priority && priorityFromId) {
            priority = priorityFromId[1].toUpperCase();
            displayId = idWithPriority.slice(0, priorityFromId.index).trim();
          }
            
          const card = document.createElement('div');
          card.className = 'incident-card';
          card.dataset.incidentId = inc?.id != null ? String(inc.id) : '';

          card.innerHTML = `
              <div class="incident-banner"></div>
              <div class="incident-header">
                <div>
                 <div class="incident-title">
                  <span class="inc-title-id" title="${safe(inc.id)}">${safe(displayId)}</span>
                  ${priority ? `— ${safe(priority)}` : ''}
                </div>
                  <div class="incident-meta">
                    <span>⚙️ ${safe(inc.equipment)}</span>
                    <span>📍 ${safe(inc.zone)}</span>
                    <span>📅 ${formatDate(dateVisible(inc))}</span>
                  </div>
                </div>
                <div class="incident-header-right">
                <div class="state-sla">
                    <span class="state-badge">${getStateLabel(state)}</span>
                    ${renderSlaPillInHeader(inc, state, card)}
                  </div>
                </div>
              </div>
        
              <div class="chips">
                <div class="req-chips"></div>
              </div>
        
              <div class="section-title">Descripción incidencia</div>
              <div class="section-text">${safe(inc.description)}</div>

              <div class="section-title">Acciones tomadas</div>
              <div class="actions-taken">${safe(inc.actions_taken) || 'Sin acciones'}</div>

              <div class="incident-actions">
                 ${renderActionButtonsByState(state, inc)}
              </div>
              ${renderDetailsSection(inc, state, news)}
           `;

          const chipsWrapper = card.querySelector('.chips');
          const chipsMount = card.querySelector('.req-chips');
          renderRequestChips(inc["Solicitudes (log)"] || inc.solicitudes_log, chipsMount);
          if (chipsWrapper && (!chipsMount || !chipsMount.childElementCount)) {
            chipsWrapper.innerHTML = `<span class="chip">✔️ Sin validaciones pendientes</span>`;
          }

          return card;
        }
        
        function renderDetailsSection(inc, state, news) {
          const notesBadge = news?.notes
            ? `<span class="badge badge-notes">${news.notes}</span>`
            : '';
          return `
            <details>
              <summary>📇 Contactos</summary>
              ${renderContacts(inc)}
            </details>
            <details ontoggle="markNotesSeen(this)">
              <summary class="notes-summary"><span>📝 Notas</span>${notesBadge}</summary>
              ${renderNotesSection(inc)}
            </details>
            <details>
              <summary>📈 Historial de escalado</summary>
              ${renderEscalationHistory(inc)}
            </details>
             ${(() => {
              const split = getSplitContext(inc);
              if (!split.previous?.length) return '';
              const prev = split.previous.map(r => {
                const raw = String(r.raw || '');
                const body = raw.replace(/^\[[^\]]+\]\s*/, '');
                return `<li class="level-${r.level || 0}">
      <span class="t-time">${formatTimeOrDate(r.when)}</span>
      <span class="t-body">${safe(body)}</span>
    </li>`;
              }).join('');
              return `
    <details open>
      <summary class="notes-summary">📘 Ciclos anteriores</summary>
      <ul class="timeline">${prev}</ul>
    </details>`;
            })()}
            <details>
              <summary>📦 Solicitudes recientes</summary>
              ${renderSolicitudesResumen(inc)}
            </details>
          `;
        }

      function renderContacts(inc){
          const contactRow = (label, name, phone) => {
            const empty = !name || name === '{{emptystring}}';
            if(empty && !phone) return '';
            return `
              <div class="contact-row ${empty ? 'is-empty' : ''}">
                <span class="label">${label}:</span>
                <span class="value">${safe(name) || '—'}${phone ? `<a class="btn-tel" href="tel:${safe(phone)}">📞</a>` : ''}</span>
              </div>`;
          };

          
          const L = getCurrentLevel(inc);
          const split = getSplitContext(inc);
          const respText = (split?.current || []).map(e => e.raw).join("\n");
          const rowsRaw = parseRespLog(respText, inc) || [];
          const rows = Array.isArray(rowsRaw) ? rowsRaw : [];

          const reversed = [...rows].reverse();
          const lastAssigned = reversed.find(r => r.level === L && r.ev === "ASSIGNED");
          const hasAccepted = lastAssigned
            ? reversed.some(r => r.level === L && r.ev === "ACCEPTED" && (r.email || '').toLowerCase() === (lastAssigned.email || '').toLowerCase())
            : false;

          const assignedSafe = hasAccepted
            ? (nameFromEmail(lastAssigned?.email) || lastAssigned?.email || '')
            : '';
        return `
          <div class="detail-grid">
            <div class="contact-card">
              <div class="contact-title">👷 Equipo técnico</div>
              ${contactRow('Supervisor', inc.supervisor, inc.supervisor_phone)}
              ${contactRow('Encargado de zona', inc.zone_manager, inc.zone_manager_phone)}
              ${contactRow('Técnico asignado', assignedSafe || '', inc.assigned_technician_phone)}
            </div>
            
            <div class="contact-card">
              <div class="contact-title">📋 Reportante</div>
              ${contactRow('Reporta', inc.reporter, inc.reporter_phone)}
              <div class="contact-row"><span class="label">Fecha ocurrencia:</span><span class="value">${formatDate(inc.occurrence_date)}</span></div>
              <div class="contact-row"><span class="label">Fecha reporte:</span><span class="value">${formatDate(inc.report_date)}</span></div>
            </div>
          </div>`;
                }

        function buildEscalationTimeline(entries, incident) {
          if (!Array.isArray(entries) || !entries.length) return '';
          const text = entries
            .map(entry => entry?.raw)
            .filter(Boolean)
            .join('\n');
          if (!text.trim()) return '';

          const rows = parseRespLog(text, incident)
            .sort((a, b) => a.level - b.level || a.when - b.when);
          if (!rows.length) return '';

          const limited = Number.isFinite(MAX_LOG_ENTRIES) ? rows.slice(-MAX_LOG_ENTRIES) : rows;
          const items = formatEscalationTimelineItems(limited);
          return items ? `<ul class="timeline">${items}</ul>` : '';
        }

        function formatEscalationTimelineItems(rows) {
          return rows.map(r => {
            const time = formatTimeOrDate(r.when);
            const who = safe(r.name || nameFromEmail(r.email) || r.email);

            if (r.ev === 'TRANSFER' || r.ev === 'DERIVATION') {
              const title = r.ev === 'TRANSFER' ? 'Transferencia' : 'Derivación';
              const icon = r.ev === 'TRANSFER' ? '🔀' : '🏢';
              const phase = r.ev === 'TRANSFER' ? 'phase-transfer' : 'phase-derivation';
              const from = safe(r.from || r.kv?.from || '');
              const to = safe(r.to || r.kv?.to || '');
              const reason = safe(r.reason || r.detail || '');
              const mid = from && to ? `${from} → ${to}` : (from || to);
              const body = `${icon} ${title}${mid ? ' · ' + mid : ''}${reason ? ' · ' + reason : ''}`;
              return `<li class="${phase}"><span class="t-time">${time}</span><span class="t-body">${body}</span></li>`;
            }

            if (r.ev === 'APOYO_ASSIGNED' || r.ev === 'APOYO_ACCEPTED') {
              const map = { APOYO_ASSIGNED: 'Apoyo Asignado', APOYO_ACCEPTED: 'Apoyo Aceptado' };
              const title = map[r.ev] || r.ev;
              const body = `🤝 L${r.level} · ${safe(title)} · ${who}`;
              return `<li class="level-${r.level} phase-support"><span class="t-time">${time}</span><span class="t-body">${body}</span></li>`;
            }

            if (r.ev === 'UNASSIGN') {
              const parts = [who, safe(r.type), safe(r.detail)].filter(Boolean);
              const body = `🚫 Desasignado${parts.length ? ' · ' + parts.join(' · ') : ''}`;
              return `<li class="phase-unassign"><span class="t-time">${time}</span><span class="t-body">${body}</span></li>`;
            }

            if (r.ev && r.ev.startsWith('REASSIGN_')) {
              const map = { REASSIGN_TO: 'Reasignado a', REASSIGN_FROM: 'Reasignado de' };
              const icon = r.ev === 'REASSIGN_TO' ? '➡️' : (r.ev === 'REASSIGN_FROM' ? '⬅️' : '🔄');
              const title = safe(map[r.ev] || r.ev);
              const detail = safe(r.detail);
              const extras = [detail, who].filter(Boolean).join(' · ');
              const body = `${icon} ${title}${extras ? ' · ' + extras : ''}`;
              return `<li class="phase-reassign"><span class="t-time">${time}</span><span class="t-body">${body}</span></li>`;
            }

            let ev = r.ev || '';
            if (ev.startsWith('REJECTED::')) ev = 'Rechazado: ' + ev.split('::')[1];
            else {
              const map = {
                ASSIGNED: 'Asignado',
                ACCEPTED: 'Aceptado',
                NO_RESPONSE: 'Sin Respuesta'
              };
              ev = map[ev] || ev;
            }
            ev = safe(ev);
            const phase = r.ev?.startsWith('REJECTED') ? 'phase-rejected'
              : (r.ev === 'ASSIGNED' ? 'phase-pending' : 'phase-approved');
            return `<li class="level-${r.level} ${phase}"><span class="t-time">${time}</span><span class="t-body">L${r.level} · ${ev} · ${who}</span></li>`;
          }).join('');
        }

        function renderEscalationHistory(inc){
          const split = getSplitContext(inc);
          const currentTimeline = buildEscalationTimeline(split?.current, inc);
          const previousTimeline = buildEscalationTimeline(split?.previous, inc);

          const sections = [];
          if (currentTimeline) {
            sections.push(currentTimeline);
          } else if (previousTimeline) {
            sections.push('<div class="muted">Sin historial en el ciclo actual</div>');
          }

          if (previousTimeline) {
            sections.push(`
              <details class="previous-cycles">
                <summary>🔁 Ciclos anteriores</summary>
                ${previousTimeline}
              </details>
            `);
          }

          if (!sections.length) {
            return `<div class="muted">Sin historial</div>`;
          }

          return sections.join('');
        }
        
        function renderSolicitudesResumen(inc){
  const t = ensureLogString(inc["Solicitudes (log)"] || inc.solicitudes_log || "");
  if (t === "{{emptystring}}") return `<div class="muted">Sin solicitudes</div>`;

  const rows = parseSolicitudesLog(t);
  if (!rows.length) return `<div class="muted">Sin solicitudes</div>`;

  const grouped = groupByRequest(rows);
  const items = Object.values(grouped)
    .sort((a,b)=> new Date(b.last?.when||0) - new Date(a.last?.when||0))
    .map(g => {
      const info = REQUEST_CAT_INFO[g.cat] || { icon:"", label:g.cat };
      const reqPhase = g.phases.find(p => p.phase === 'REQUEST') || g.phases[0] || {};
      const meta = reqPhase.meta || {};
      let detail = '';
      if (g.cat === 'MATERIAL') {
        const name = (meta.name || meta.material || meta.item || '').trim();
        const qty  = (meta.qty || meta.quantity || '').toString().trim();
        const unit = (meta.unit || meta.units || meta.unidad || '').trim();
        detail = [name, qty ? `×${qty}${unit ? ' '+unit : ''}` : ''].filter(Boolean).join(' · ');
      } else if (g.cat === 'APOYO') {
        detail = (meta.detail || meta.detalle || meta.reason || meta.comment || meta.notes || '').trim();
      } else {
        const to = (meta.to || meta.dest || meta.destino || meta.target || '').trim();
        const why = (meta.reason || meta.detail || meta.detalle || '').trim();
        detail = [to, why].filter(Boolean).join(' · ');
      }
      detail = cleanLevelTags(detail);

      const metaForName = g.last?.meta || meta;
      const whoRaw = metaName(metaForName, 'req_by') || metaName(metaForName, 'by') || metaName(metaForName, 'to');
      const whoSafe = safe(whoRaw);
      const whoTag = whoSafe ? ` · <span class="muted">${whoSafe}</span>` : "";

      // clase por fase final
      const phase = (g.last?.phase || 'REQUEST').toUpperCase();
      const lineCls = phase === 'APPROVED' ? 'phase-approved'
                    : phase === 'REJECTED' ? 'phase-rejected'
                    : 'phase-pending';

      return `<li class="${lineCls}">
        <span class="t-time">${formatTimeOrDate(g.last?.when)}</span>
        <span class="t-body">${info.icon || ''} <strong>${info.label || g.cat}</strong>${detail ? ' — ' + safe(detail) : ''}${whoTag}</span>
      </li>`;
    }).join('');

  return `<ul class="timeline">${items}</ul>`;
}



    function renderIncidents(incidents) {
      const legacy = document.getElementById('incidentsContainer');
      if (legacy) legacy.innerHTML = '';
    
      incidentsContainer.innerHTML = '';
      if (!Array.isArray(incidents) || incidents.length === 0) {
        incidentsContainer.innerHTML = `
          <div class="no-incidents">
            <div class="no-incidents-icon">📭</div>
            <h3>Sin incidencias</h3>
            <p>No hay incidencias asignadas actualmente.</p>
          </div>`;
        return;
      }
    
      const frag = document.createDocumentFragment();
      incidents.forEach(inc => {
        const state = getIncidentRealState(inc, currentTechnician?.email || "");
        const card = incidentCardHTML(inc, state);
        if (!card) return;
          
        renderSeguimientoBanner(inc, state, card);
          
        frag.appendChild(card);
      });
    
      incidentsContainer.appendChild(frag);

      try {
      if (directIncidentId && !directScrollDone) {
        scrollToIncident(directIncidentId);
        directScrollDone = true;
        // dispara la acción si viene ?action=...
        if (pendingAction) {
          if (pendingAction === 'acepto') {
            // pide PIN si hace falta y ejecuta
            showActionPINModal('acepto', directIncidentId);
          } else if (pendingAction === 'materiales') {
            showMaterialesModal(directIncidentId);
          } else if (pendingAction === 'resolver') {
            showResolverModal(directIncidentId);
          } else if (pendingAction === 'rechazo') {
            showReasonModal('rechazo', directIncidentId);
          }
        }
      }
    } catch {}
    }
    
    // ---------- Aplicar filtros y pintar ----------
    function applyFiltersAndRender() {
      const tech = currentTechnician?.email || '';
      const list = allIncidents.filter(inc => {
        const st = getIncidentRealState(inc, tech);
        const directed = hasDirectedPendingRequests(inc);
        if (currentStatusFilter === 'all') return true;
        if (currentStatusFilter === 'pending') {
          return st === 'pending' || directed;
        }
        return st === currentStatusFilter;
      });
      renderIncidents(list);
      renderSlaStickyBar();
      initDirectedCountdowns();

      if (!window.__slaTick) {
        window.__slaTick = setInterval(() => {
          renderSlaStickyBar();
          document.querySelectorAll('.incident-card').forEach(card => {
            const id = card.dataset.incidentId || card.getAttribute('data-incident-id');
            const inc = allIncidents.find(i => String(i.id) === String(id));
            if (!inc) return;
            const state = getIncidentRealState(inc, currentTechnician?.email || "");
            const box = card.querySelector('.incident-header-right .state-sla');
            if (box) {
              box.innerHTML = `<span class="state-badge">${getStateLabel(state)}</span>${renderSlaPillInHeader(inc, state, card)}`;
            }
          });
        }, 15000);
      }
    }
    
    // Carga inicial
    showSpinner();
     // Expone funciones usadas por HTML inline
    window.loginWithPIN = loginWithPIN;
    window.verifyPIN = verifyPIN;
    window.showPINError = showPINError;
    window.closePINModal = closePINModal;
    window.loadDashboard = loadDashboard;
    window.refreshDashboard = refreshDashboard;
    window.filterByStatus = filterByStatus;
    window.handleAction = handleAction;
    window.showResolverModal = showResolverModal;
    window.showMaterialesModal = showMaterialesModal;
    window.showAyudaModal = showAyudaModal;
    window.openResourcesModal = openResourcesModal;
    window.closeModal = closeModal;
    window.aceptarIncidencia = aceptarIncidencia;
    window.rechazarIncidencia = rechazarIncidencia;
    window.abrirAyuda = abrirAyuda;
    window.abrirMateriales = abrirMateriales;
    window.abrirResolver = abrirResolver;
    window.solicitarAsignacion = solicitarAsignacion;
    window.solicitarTraspaso = solicitarTraspaso;
    window.receiverDecision = receiverDecision;
    window.confirmResolver = confirmResolver;
    window.confirmAction = confirmAction;
    window.selectReason = selectReason;
    window.confirmActionWithPIN = confirmActionWithPIN;
    window.closeActionPINModal   = closeActionPINModal;
        
    </script>
</body>
</html>
