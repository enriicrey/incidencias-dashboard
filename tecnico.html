<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Dashboard T√©cnico</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Login Screen */
        .login-container {
            background: white;
            border-radius: 16px;
            padding: 40px 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-top: 50px;
        }
        
        .login-title {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }
        
        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .verify-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 10px;
        }
        
        .verify-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        .verify-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .quick-access-btn {
            width: 100%;
            padding: 12px;
            background: #f8f9fa;
            color: #6c757d;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quick-access-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        
        .error-message {
            background: #fee;
            color: #c53030;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #fed7d7;
        }
        
        .success-message {
            background: #f0fff4;
            color: #22543d;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #c6f6d5;
        }
        
        /* Dashboard */
        .main-container {
            display: none;
        }
        
        .dashboard-header {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .dashboard-title {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .dashboard-subtitle {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .auth-status {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .auth-status.authenticated {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .auth-status.unauthenticated {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        /* SLA Timer */
        .sla-timer {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .sla-time {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .sla-critical { color: #e74c3c; }
        .sla-warning { color: #f39c12; }
        .sla-normal { color: #27ae60; }
        
        .sla-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        /* Incident Card */
        .incident-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .incident-header {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .incident-content {
            padding: 25px;
        }
        
        .incident-detail {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .detail-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .detail-value {
            color: #555;
        }
        
        .priority-critical { border-left-color: #e74c3c; }
        .priority-high { border-left-color: #f39c12; }
        .priority-medium { border-left-color: #f1c40f; }
        .priority-low { border-left-color: #27ae60; }
        
        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 25px;
        }
        
        .action-btn {
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .action-btn.locked {
            opacity: 0.6;
            cursor: not-allowed;
            background: #6c757d !important;
        }
        
        .btn-accept {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }
        
        .btn-reject {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-help {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
            grid-column: 1 / -1;
        }
        
        .action-btn:hover:not(.locked) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        /* PIN Modal */
        .pin-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .pin-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .pin-modal {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            transform: scale(0.8);
            transition: transform 0.3s;
        }
        
        .pin-modal-overlay.active .pin-modal {
            transform: scale(1);
        }
        
        .pin-modal-title {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .pin-modal-subtitle {
            color: #7f8c8d;
            margin-bottom: 25px;
        }
        
        .pin-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 18px;
            text-align: center;
            letter-spacing: 8px;
            margin-bottom: 20px;
        }
        
        .pin-input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .pin-actions {
            display: flex;
            gap: 15px;
        }
        
        .pin-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .pin-btn-cancel {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .pin-btn-verify {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }
        
        .pin-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Reason Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.8);
            transition: transform 0.3s;
        }
        
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        
        .modal-title {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .reason-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .reason-option {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .reason-option:hover {
            border-color: #3498db;
            background: #f8f9ff;
        }
        
        .reason-option.selected {
            border-color: #3498db;
            background: #e3f2fd;
        }
        
        .reason-icon {
            font-size: 24px;
            min-width: 30px;
        }
        
        .reason-text {
            flex: 1;
        }
        
        .reason-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 3px;
        }
        
        .reason-description {
            font-size: 13px;
            color: #7f8c8d;
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-cancel {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .btn-confirm {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn-confirm:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e9ecef;
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* No incidents */
        .no-incidents {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .no-incidents-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .no-incidents-title {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .no-incidents-description {
            color: #7f8c8d;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .btn-help {
                grid-column: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div class="container" id="loginContainer">
        <div class="login-container">
            <h1 class="login-title">üîß Dashboard T√©cnico</h1>
            <p class="login-subtitle">Accede con tu email para gestionar incidencias</p>
            
            <div class="input-group">
                <label class="input-label" for="emailInput">Email T√©cnico</label>
                <input type="email" 
                       class="input-field" 
                       id="emailInput" 
                       placeholder="ejemplo@empresa.com"
                       autocomplete="email">
            </div>
            
            <button onclick="loginWithPIN()" class="verify-btn" id="loginBtn">
                üîê Acceder con PIN (Dashboard Completo)
            </button>
            
            <button onclick="loginQuickAccess()" class="quick-access-btn" id="quickBtn">
                üëÅÔ∏è Ver incidencia espec√≠fica (desde email)
            </button>
            
            <div id="loginError" class="error-message" style="display: none;"></div>
            <div id="loginSuccess" class="success-message" style="display: none;"></div>
        </div>
    </div>

    <!-- Main Dashboard Container -->
    <div class="container main-container" id="mainContainer">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <h1 class="dashboard-title" id="dashboardTitle">üîß Dashboard T√©cnico</h1>
            <div class="dashboard-subtitle" id="dashboardSubtitle">Sistema de Respuesta a Incidencias</div>
        </div>

        <!-- Auth Status -->
        <div class="auth-status" id="authStatus">
            <div id="authMessage">‚ö†Ô∏è Solo lectura - Introduce PIN para responder</div>
        </div>

        <!-- SLA Timer -->
        <div class="sla-timer" id="slaTimer" style="display: none;">
            <div class="sla-time" id="slaTimeDisplay">--:--</div>
            <div class="sla-label">Tiempo restante para responder</div>
        </div>

        <!-- Incident Card -->
        <div id="incidentCard">
            <!-- Se llena din√°micamente -->
        </div>
    </div>

    <!-- PIN Modal -->
    <div class="pin-modal-overlay" id="pinModal">
        <div class="pin-modal">
            <h3 class="pin-modal-title">üîê Verificaci√≥n de Seguridad</h3>
            <p class="pin-modal-subtitle">Introduce tu PIN de 4 d√≠gitos para responder</p>
            <input type="password" 
                   class="pin-input" 
                   id="pinInput" 
                   maxlength="4" 
                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                   autocomplete="off">
            <div class="pin-actions">
                <button class="pin-btn pin-btn-cancel" onclick="closePINModal()">
                    Cancelar
                </button>
                <button class="pin-btn pin-btn-verify" id="verifyPinBtn" onclick="verifyPIN()" disabled>
                    Verificar
                </button>
            </div>
            <div id="pinError" class="error-message" style="display: none; margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Reason Selection Modal -->
    <div class="modal-overlay" id="reasonModal">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">Selecciona el motivo</h3>
            <div class="reason-options" id="reasonOptions">
                <!-- Se llena din√°micamente -->
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeReasonModal()">
                    Cancelar
                </button>
                <button class="modal-btn btn-confirm" id="confirmBtn" onclick="confirmAction()" disabled>
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <script>
        // === VARIABLES GLOBALES ===
        let currentIncident = null;
        let currentTechnician = null;
        let isAuthenticated = false;
        let slaInterval = null;
        let pendingAction = null;
        let selectedReason = null;
        let accessMode = 'none'; // 'none', 'read_only', 'full_access'

        // === MOTIVOS DE RESPUESTA ===
        const rejectReasons = [
            { id: 'ocupado_otra', icon: 'üîß', title: 'Ocupado con otra incidencia', description: 'Ya estoy resolviendo otra incidencia cr√≠tica' },
            { id: 'fuera_especialidad', icon: '‚ùì', title: 'Fuera de mi especialidad', description: 'No tengo experiencia con este tipo de equipo' },
            { id: 'no_disponible', icon: '‚è∞', title: 'No disponible ahora', description: 'Estoy en pausa, reuni√≥n o fuera de turno' },
            { id: 'falta_herramientas', icon: 'üî®', title: 'Faltan herramientas/repuestos', description: 'No tengo las herramientas necesarias disponibles' },
            { id: 'ubicacion_lejos', icon: 'üìç', title: 'Muy lejos de mi ubicaci√≥n', description: 'Estoy muy lejos de la zona de la incidencia' },
            { id: 'sobrecarga_trabajo', icon: '‚ö°', title: 'Sobrecarga de trabajo', description: 'Ya tengo demasiadas incidencias asignadas' }
        ];

        const helpReasons = [
            { id: 'apoyo_tecnico', icon: 'üë•', title: 'Necesito apoyo t√©cnico', description: 'Requiero asistencia de otro t√©cnico especializado' },
            { id: 'consulta_supervisor', icon: 'üéØ', title: 'Consulta con supervisor', description: 'Necesito autorizaci√≥n o gu√≠a del supervisor' },
            { id: 'herramientas_especiales', icon: 'üîß', title: 'Herramientas especiales', description: 'Requiero herramientas espec√≠ficas no disponibles' },
            { id: 'procedimiento_dudas', icon: 'üìã', title: 'Dudas sobre procedimiento', description: 'No estoy seguro del procedimiento correcto' },
            { id: 'seguridad_riesgo', icon: '‚ö†Ô∏è', title: 'Problema de seguridad', description: 'Hay riesgos de seguridad que requieren evaluaci√≥n' },
            { id: 'repuestos_urgentes', icon: 'üì¶', title: 'Repuestos urgentes', description: 'Necesito repuestos espec√≠ficos urgentemente' }
        ];

        // === INICIALIZACI√ìN ===
        window.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Dashboard T√©cnico iniciado');
            
            // Verificar si hay par√°metros en la URL (acceso desde email)
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('tecnico') || urlParams.get('technician_email');
            const nombre = urlParams.get('nombre') || urlParams.get('technician_name');
            const incidentId = urlParams.get('id') || urlParams.get('incident_id');
            
            if (email) {
                document.getElementById('emailInput').value = email;
                
                if (incidentId) {
                    // Acceso desde email - modo solo lectura inicialmente
                    console.log('üîó Acceso desde email detectado');
                    loginQuickAccess();
                }
                if (nombre) {
            currentTechnician = {
                email: email,
                name: decodeURIComponent(nombre) };
        }
            }
        });

        // === FUNCIONES DE LOGIN ===
        async function loginWithPIN() {
            const email = document.getElementById('emailInput').value.trim();
            
            if (!email || !email.includes('@')) {
                showError('Por favor ingresa un email v√°lido', document.getElementById('loginError'));
                return;
            }
            
            // Mostrar modal de PIN
            showPINModal('dashboard');
        }

        async function loginQuickAccess() {
            const email = document.getElementById('emailInput').value.trim();
            
            if (!email || !email.includes('@')) {
                showError('Por favor ingresa un email v√°lido', document.getElementById('loginError'));
                return;
            }
            
            // Acceso r√°pido sin PIN (solo lectura)
            accessMode = 'read_only';
            await loadTechnicianDashboard(email, false);
        }

        // === MODAL DE PIN ===
        function showPINModal(purpose = 'action') {
            const modal = document.getElementById('pinModal');
            const pinInput = document.getElementById('pinInput');
            const verifyBtn = document.getElementById('verifyPinBtn');
            
            pinInput.value = '';
            verifyBtn.disabled = true;
            hideMessage(document.getElementById('pinError'));
            
            // Configurar seg√∫n el prop√≥sito
            if (purpose === 'dashboard') {
                document.querySelector('.pin-modal-title').textContent = 'üîê Acceso al Dashboard';
                document.querySelector('.pin-modal-subtitle').textContent = 'Introduce tu PIN para acceso completo';
            } else {
                document.querySelector('.pin-modal-title').textContent = 'üîê Confirmar Acci√≥n';
                document.querySelector('.pin-modal-subtitle').textContent = 'Introduce tu PIN para responder';
            }
            
            modal.classList.add('active');
            pinInput.focus();
            
            // Eventos de teclado
            pinInput.oninput = function() {
                verifyBtn.disabled = this.value.length !== 4;
            };
            
            pinInput.onkeypress = function(e) {
                if (e.key === 'Enter' && this.value.length === 4) {
                    verifyPIN();
                }
            };
        }

        function closePINModal() {
            document.getElementById('pinModal').classList.remove('active');
            pendingAction = null;
        }

        async function verifyPIN() {
            const pin = document.getElementById('pinInput').value;
            const email = document.getElementById('emailInput').value;
            const verifyBtn = document.getElementById('verifyPinBtn');
            
            if (pin.length !== 4) {
                showError('Introduce un PIN de 4 d√≠gitos', document.getElementById('pinError'));
                return;
            }
            
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'üîÑ Verificando...';
            
            try {
                const response = await fetch('/api/webhook-respuesta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'validate_technician_pin',
                        technician_email: email,
                        technician_name: currentTechnician?.name || email.split('@')[0],
                        pin: pin
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    isAuthenticated = true;
                    accessMode = 'full_access';
                    closePINModal();
                    
                    if (pendingAction) {
                        // Continuar con la acci√≥n pendiente
                        if (pendingAction === 'acepto') {
                            confirmAction();
                        } else {
                            showReasonModal(pendingAction);
                        }
                    } else {
                        // Cargar dashboard completo
                        await loadTechnicianDashboard(email, true);
                        updateAuthStatus();
                    }
                } else {
                    showError(data.message || 'PIN incorrecto', document.getElementById('pinError'));
                }

            } catch (error) {
                console.error('Error verificando PIN:', error);
                showError('Error de conexi√≥n. Int√©ntalo m√°s tarde.', document.getElementById('pinError'));
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verificar';
            }
        }

        // === CARGAR DASHBOARD ===
        async function loadTechnicianDashboard(email, withPIN = false) {
            try {
                showLoading('Cargando tus incidencias...');

                const response = await fetch('/api/webhook-respuesta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'get_assigned_incidents',
                        technician_email: email,
                        technician_name: currentTechnician?.name || email.split('@')[0],
                        read_only: !withPIN
                    })
                });

                const data = await response.json();
                console.log('üìã Respuesta del servidor:', data);

                if (data.status === 'success') {
                    currentTechnician = { email: email, name: data.technician.name, department: data.technician.department, level: data.technician.level };
                    
                    // Mostrar dashboard
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';
                    
                    // Actualizar header
                    document.getElementById('dashboardTitle').textContent = `üîß Dashboard de ${currentTechnician.name}`;
                    
                    // Actualizar estado de autenticaci√≥n
                    updateAuthStatus();
                    
                    // Renderizar incidencias
                    renderIncidents(data.incidents || []);
                    
                } else {
                    throw new Error(data.message || 'Error cargando dashboard');
                }

            } catch (error) {
                console.error('Error cargando dashboard:', error);
                showError('Error de conexi√≥n. Int√©ntalo m√°s tarde.', document.getElementById('loginError'));
            } finally {
                hideLoading();
            }
        }

        // === ACTUALIZAR ESTADO DE AUTENTICACI√ìN ===
        function updateAuthStatus() {
            const statusDiv = document.getElementById('authStatus');
            const messageDiv = document.getElementById('authMessage');
            
            if (accessMode === 'full_access') {
                statusDiv.className = 'auth-status authenticated';
                messageDiv.innerHTML = '‚úÖ <strong>Autenticado</strong> - Puedes responder a incidencias';
            } else if (accessMode === 'read_only') {
                statusDiv.className = 'auth-status unauthenticated';
                messageDiv.innerHTML = 'üëÅÔ∏è <strong>Solo lectura</strong> - Introduce PIN para responder';
            } else {
                statusDiv.className = 'auth-status';
                messageDiv.innerHTML = '‚ö†Ô∏è Sin autenticar';
            }
        }

        // === RENDERIZADO DE INCIDENCIAS ===
        function renderIncidents(incidents) {
            const container = document.getElementById('incidentCard');
            const urlParams = new URLSearchParams(window.location.search);
            const specificIncidentId = urlParams.get('id') || urlParams.get('incident_id');
            
            // Si hay ID espec√≠fico en URL, mostrar solo esa incidencia
            if (specificIncidentId) {
                const specificIncident = incidents.find(inc => inc.incident_id === specificIncidentId);
                if (specificIncident) {
                    renderSingleIncident(specificIncident);
                    return;
                } else {
                    container.innerHTML = `
                        <div class="no-incidents">
                            <div class="no-incidents-icon">‚ùì</div>
                            <h3 class="no-incidents-title">Incidencia No Encontrada</h3>
                            <p class="no-incidents-description">
                                La incidencia ${specificIncidentId} no existe o no est√° asignada a ti
                            </p>
                        </div>
                    `;
                    return;
                }
            }
            
            // Filtrar incidencias pendientes de respuesta
            const pendingIncidents = incidents.filter(inc => 
                inc.requires_response === true || 
                (inc.assigned_technician !== currentTechnician.email && 
                 (inc.l0_technician === currentTechnician.email || 
                  inc.l1_technician === currentTechnician.email || 
                  (inc.l2_technicians_notified && inc.l2_technicians_notified.includes(currentTechnician.email))))
            );
            
            const workingIncidents = incidents.filter(inc => 
                inc.assigned_technician === currentTechnician.email
            );
            
            document.getElementById('dashboardSubtitle').textContent = 
                `${pendingIncidents.length} pendiente(s) ‚Ä¢ ${workingIncidents.length} trabajando`;
            
            if (pendingIncidents.length === 0 && workingIncidents.length === 0) {
                container.innerHTML = `
                    <div class="no-incidents">
                        <div class="no-incidents-icon">‚úÖ</div>
                        <h3 class="no-incidents-title">Sin Incidencias</h3>
                        <p class="no-incidents-description">No tienes incidencias pendientes ni asignadas en este momento</p>
                    </div>
                `;
                return;
            }
            
            // Mostrar lista de todas las incidencias
            if (accessMode === 'full_access') {
                renderAllIncidents(pendingIncidents, workingIncidents);
            } else {
                // Solo mostrar la primera pendiente
                if (pendingIncidents.length > 0) {
                    renderSingleIncident(pendingIncidents[0]);
                } else if (workingIncidents.length > 0) {
                    renderWorkingIncident(workingIncidents[0]);
                }
            }
        }

        function renderAllIncidents(pendingIncidents, workingIncidents) {
            const container = document.getElementById('incidentCard');
            
            let html = '';
            
            if (pendingIncidents.length > 0) {
                html += `
                    <div class="incident-card">
                        <div class="incident-header">
                            <h2>‚è≥ Pendientes de Respuesta (${pendingIncidents.length})</h2>
                        </div>
                        <div class="incident-content">
                `;
                
                pendingIncidents.forEach((incident, index) => {
                    const priorityClass = getPriorityClass(incident.priority);
                    html += `
                        <div class="incident-detail ${priorityClass}" style="cursor: pointer;" onclick="selectIncident('${incident.incident_id}')">
                            <div class="detail-label">üìã ${incident.incident_id}</div>
                            <div class="detail-value">
                                <strong>${incident.priority || 'Media'}</strong> | ${incident.zone || 'Sin zona'}<br>
                                ${incident.equipment || 'Sin equipo'}<br>
                                <small>${(incident.description || '').substring(0, 100)}...</small>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            if (workingIncidents.length > 0) {
                html += `
                    <div class="incident-card">
                        <div class="incident-header">
                            <h2>üîß Trabajando (${workingIncidents.length})</h2>
                        </div>
                        <div class="incident-content">
                `;
                
                workingIncidents.forEach((incident, index) => {
                    const priorityClass = getPriorityClass(incident.priority);
                    html += `
                        <div class="incident-detail ${priorityClass}" style="cursor: pointer;" onclick="selectIncident('${incident.incident_id}')">
                            <div class="detail-label">üîß ${incident.incident_id}</div>
                            <div class="detail-value">
                                <strong>${incident.priority || 'Media'}</strong> | ${incident.zone || 'Sin zona'}<br>
                                ${incident.equipment || 'Sin equipo'}<br>
                                <small>${(incident.description || '').substring(0, 100)}...</small>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function selectIncident(incidentId) {
            // Recargar la p√°gina con el incidente espec√≠fico
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('id', incidentId);
            window.location.href = currentUrl.toString();
        }

        function renderSingleIncident(incident) {
            currentIncident = incident;
            
            const priorityClass = getPriorityClass(incident.priority);
            const slaEnd = getSlaEndTime(incident);
            const canRespond = (accessMode === 'full_access');
            
            // Determinar tipo de incidencia
            const isWorking = incident.assigned_technician === currentTechnician?.email;
            const isPending = !isWorking && incident.requires_response;
            
            document.getElementById('incidentCard').innerHTML = `
                <div class="incident-card">
                    <div class="incident-header">
                        <h2>üìã ${incident.incident_id || 'Incidencia'}</h2>
                        <div>${isWorking ? 'Trabajando en esta incidencia' : 'Requiere tu respuesta'}</div>
                    </div>
                    <div class="incident-content">
                        <div class="incident-detail ${priorityClass}">
                            <div class="detail-label">üö® Prioridad</div>
                            <div class="detail-value">${incident.priority || 'Media'}</div>
                        </div>
                        
                        <div class="incident-detail">
                            <div class="detail-label">üìç Zona</div>
                            <div class="detail-value">${incident.zone || 'No especificada'}</div>
                        </div>
                        
                        <div class="incident-detail">
                            <div class="detail-label">üîß Equipo</div>
                            <div class="detail-value">${incident.equipment || 'No especificado'}</div>
                        </div>
                        
                        <div class="incident-detail">
                            <div class="detail-label">üìù Descripci√≥n</div>
                            <div class="detail-value">${incident.description || 'Sin descripci√≥n disponible'}</div>
                        </div>
                        
                        ${renderActionButtons(isWorking, isPending, canRespond)}
                    </div>
                </div>
            `;
            
            // Iniciar timer SLA si hay tiempo l√≠mite
            if (slaEnd) {
                startSlaTimer(slaEnd);
            }
        }

        function renderActionButtons(isWorking, isPending, canRespond) {
            if (isWorking) {
                // Ya est√° trabajando - solo puede pedir ayuda
                return `
                    <div class="action-buttons">
                        <button class="action-btn btn-help ${canRespond ? '' : 'locked'}" 
                                onclick="handleAction('ayuda')">
                            ${canRespond ? 'üÜò' : 'üîê'} Solicitar Ayuda
                        </button>
                    </div>
                `;
            } else if (isPending) {
                // Pendiente de respuesta - todas las opciones
                return `
                    <div class="action-buttons">
                        <button class="action-btn btn-accept ${canRespond ? '' : 'locked'}" 
                                onclick="handleAction('acepto')">
                            ${canRespond ? '‚úÖ' : 'üîê'} Acepto
                        </button>
                        <button class="action-btn btn-reject ${canRespond ? '' : 'locked'}" 
                                onclick="handleAction('rechazo')">
                            ${canRespond ? '‚ùå' : 'üîê'} Rechazo
                        </button>
                        <button class="action-btn btn-help ${canRespond ? '' : 'locked'}" 
                                onclick="handleAction('ayuda')">
                            ${canRespond ? 'üÜò' : 'üîê'} Solicitar Ayuda
                        </button>
                    </div>
                `;
            } else {
                return '<p style="text-align: center; color: #7f8c8d; margin-top: 20px;">Esta incidencia no requiere acci√≥n por tu parte.</p>';
            }
        }

        function renderWorkingIncident(incident) {
            renderSingleIncident(incident);
        }

        // === SLA TIMER ===
        function startSlaTimer(endTime) {
            const timerElement = document.getElementById('slaTimer');
            const timeDisplay = document.getElementById('slaTimeDisplay');
            
            if (!endTime) return;
            
            timerElement.style.display = 'block';
            
            function updateTimer() {
                const now = new Date();
                const end = new Date(endTime);
                const diff = end - now;
                
                if (diff <= 0) {
                    timeDisplay.textContent = '00:00';
                    timeDisplay.className = 'sla-time sla-critical';
                    clearInterval(slaInterval);
                    return;
                }
                
                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                
                timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (minutes < 5) {
                    timeDisplay.className = 'sla-time sla-critical';
                } else if (minutes < 15) {
                    timeDisplay.className = 'sla-time sla-warning';
                } else {
                    timeDisplay.className = 'sla-time sla-normal';
                }
            }
            
            updateTimer();
            slaInterval = setInterval(updateTimer, 1000);
        }

        // === MANEJO DE ACCIONES ===
        function handleAction(action) {
            if (accessMode !== 'full_access') {
                // Requiere PIN
                pendingAction = action;
                showPINModal('action');
                return;
            }
            
            // Ya autenticado, proceder
            if (action === 'acepto') {
                confirmAction();
            } else {
                showReasonModal(action);
            }
        }

        // === MODAL DE MOTIVOS ===
        function showReasonModal(action) {
            pendingAction = action;
            selectedReason = null;
            
            const modal = document.getElementById('reasonModal');
            const title = document.getElementById('modalTitle');
            const options = document.getElementById('reasonOptions');
            const confirmBtn = document.getElementById('confirmBtn');
            
            // Configurar t√≠tulo y motivos seg√∫n la acci√≥n
            let reasons = [];
            switch(action) {
                case 'rechazo':
                    title.textContent = '‚ùå Motivo del Rechazo';
                    reasons = rejectReasons;
                    confirmBtn.textContent = 'Rechazar';
                    break;
                    
                case 'ayuda':
                    title.textContent = 'üÜò Tipo de Ayuda Requerida';
                    reasons = helpReasons;
                    confirmBtn.textContent = 'Solicitar Ayuda';
                    break;
            }
            
            // Renderizar opciones de motivos
            options.innerHTML = reasons.map(reason => `
                <div class="reason-option" onclick="selectReason('${reason.id}')">
                    <div class="reason-icon">${reason.icon}</div>
                    <div class="reason-text">
                        <div class="reason-title">${reason.title}</div>
                        <div class="reason-description">${reason.description}</div>
                    </div>
                </div>
            `).join('');
            
            confirmBtn.disabled = true;
            modal.classList.add('active');
        }

        function selectReason(reasonId) {
            selectedReason = reasonId;
            
            // Actualizar UI
            document.querySelectorAll('.reason-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            event.currentTarget.classList.add('selected');
            document.getElementById('confirmBtn').disabled = false;
        }

        function closeReasonModal() {
            document.getElementById('reasonModal').classList.remove('active');
            pendingAction = null;
            selectedReason = null;
        }

        // === CONFIRMAR ACCI√ìN ===
        async function confirmAction() {
            if (!pendingAction || !currentIncident) return;
            
            const confirmBtn = document.getElementById('confirmBtn');
            const originalText = confirmBtn?.textContent || 'Confirmar';
            
            try {
                if (confirmBtn) {
                    confirmBtn.disabled = true;
                    confirmBtn.textContent = 'üîÑ Procesando...';
                }
                
                const response = await fetch('/api/webhook-respuesta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: pendingAction,
                        incident_id: currentIncident.incident_id,
                        technician_email: currentTechnician.email,
                        technician_name: currentTechnician.name,
                        reason: selectedReason,
                        escalation_level: getCurrentEscalationLevel()
                    })
                });

                const data = await response.json();
                console.log('üì§ Respuesta enviada:', data);

                if (data.status === 'success') {
                    closeReasonModal();
                    showSuccessAndReload(data);
                } else {
                    throw new Error(data.message || 'Error procesando respuesta');
                }

            } catch (error) {
                console.error('Error enviando respuesta:', error);
                showError('Error de conexi√≥n. Int√©ntalo m√°s tarde.');
            } finally {
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = originalText;
                }
            }
        }

        function showSuccessAndReload(data) {
            const messages = {
                'acepto': '‚úÖ Incidencia aceptada correctamente. ¬°Puedes empezar a trabajar!',
                'rechazo': '‚ùå Incidencia rechazada. Se escalar√° autom√°ticamente.',
                'ayuda': 'üÜò Ayuda solicitada. Un supervisor se pondr√° en contacto contigo.'
            };
            
            // Mostrar mensaje de √©xito
            document.getElementById('incidentCard').innerHTML = `
                <div class="incident-card">
                    <div class="incident-header" style="background: linear-gradient(45deg, #27ae60, #2ecc71);">
                        <h2>‚úÖ Acci√≥n Completada</h2>
                    </div>
                    <div class="incident-content" style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">
                            ${pendingAction === 'acepto' ? '‚úÖ' : pendingAction === 'rechazo' ? '‚ùå' : 'üÜò'}
                        </div>
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">
                            ${messages[pendingAction]}
                        </h3>
                        <p style="color: #7f8c8d; margin-bottom: 25px;">
                            ${data.next_step || 'La acci√≥n se ha procesado correctamente.'}
                        </p>
                        <button class="action-btn btn-accept" onclick="location.reload()" style="max-width: 200px; margin: 0 auto;">
                            üîÑ Actualizar Dashboard
                        </button>
                    </div>
                </div>
            `;
            
            // Ocultar SLA timer
            document.getElementById('slaTimer').style.display = 'none';
            if (slaInterval) {
                clearInterval(slaInterval);
            }
        }

        // === FUNCIONES AUXILIARES ===
        function getCurrentEscalationLevel() {
            if (!currentIncident) return 0;
            
            if (currentIncident.l0_technician === currentTechnician?.email) return 0;
            if (currentIncident.l1_technician === currentTechnician?.email) return 1;
            if (currentIncident.l2_technicians_notified?.includes?.(currentTechnician?.email)) return 2;
            
            return 0;
        }

        function getSlaEndTime(incident) {
            if (incident.l0_technician === currentTechnician?.email) {
                return incident.sla_l0_end;
            }
            if (incident.l1_technician === currentTechnician?.email) {
                return incident.sla_l1_backup_end;
            }
            if (incident.l2_technicians_notified?.includes?.(currentTechnician?.email)) {
                return incident.sla_l2_equipo_end;
            }
            return null;
        }

        function getPriorityClass(priority) {
            switch(priority?.toLowerCase()) {
                case 'cr√≠tica': case 'critical': return 'priority-critical';
                case 'alta': case 'high': return 'priority-high';
                case 'media': case 'medium': return 'priority-medium';
                case 'baja': case 'low': return 'priority-low';
                default: return 'priority-medium';
            }
        }

        function showLoading(message = 'Cargando...') {
            document.getElementById('incidentCard').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>${message}</div>
                </div>
            `;
        }

        function hideLoading() {
            // Se oculta cuando se renderiza contenido
        }

        function showError(message, element) {
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
            } else {
                console.error('Error:', message);
            }
        }

        function hideMessage(element) {
            if (element) {
                element.style.display = 'none';
            }
        }

        // === EVENTOS DE TECLADO ===
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.getElementById('loginContainer').style.display !== 'none') {
                const emailInput = document.getElementById('emailInput');
                if (emailInput.value.trim()) {
                    loginQuickAccess();
                }
            }
            
            if (e.key === 'Escape') {
                closeReasonModal();
                closePINModal();
            }
        });

        // Cerrar modales al hacer click fuera
        document.getElementById('reasonModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeReasonModal();
            }
        });

        document.getElementById('pinModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePINModal();
            }
        });
    </script>
</body>
</html>
