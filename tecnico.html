<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>📱 Dashboard Técnico</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
min-height: 100vh;
color: #333;
}

.container {
max-width: 500px;
margin: 0 auto;
padding: 20px;
min-height: 100vh;
display: flex;
flex-direction: column;
}

/* Login Screen */
.login-container {
background: white;
border-radius: 16px;
padding: 40px 30px;
text-align: center;
box-shadow: 0 20px 40px rgba(0,0,0,0.1);
margin-top: 50px;
}

.login-title {
font-size: 24px;
color: #2c3e50;
margin-bottom: 10px;
}

.login-subtitle {
color: #7f8c8d;
margin-bottom: 30px;
}

.input-group {
margin-bottom: 20px;
text-align: left;
}

.input-label {
display: block;
margin-bottom: 8px;
font-weight: 600;
color: #34495e;
}

.input-field {
width: 100%;
padding: 15px;
border: 2px solid #e9ecef;
border-radius: 8px;
font-size: 16px;
transition: border-color 0.3s;
}

.input-field:focus {
outline: none;
border-color: #3498db;
}

.verify-btn {
width: 100%;
padding: 15px;
background: linear-gradient(45deg, #3498db, #2980b9);
color: white;
border: none;
border-radius: 8px;
font-size: 16px;
font-weight: 600;
cursor: pointer;
transition: transform 0.2s;
margin-bottom: 10px;
}

.verify-btn:hover:not(:disabled) {
transform: translateY(-2px);
}

.verify-btn:disabled {
opacity: 0.6;
cursor: not-allowed;
}

.quick-access-btn {
width: 100%;
padding: 12px;
background: #f8f9fa;
color: #6c757d;
border: 2px solid #dee2e6;
border-radius: 8px;
font-size: 14px;
cursor: pointer;
transition: all 0.3s;
}

.quick-access-btn:hover {
background: #e9ecef;
border-color: #adb5bd;
}

.error-message {
background: #fee;
color: #c53030;
padding: 12px;
border-radius: 8px;
margin-top: 15px;
border: 1px solid #fed7d7;
}

.success-message {
background: #f0fff4;
color: #22543d;
padding: 12px;
border-radius: 8px;
margin-top: 15px;
border: 1px solid #c6f6d5;
}

/* Dashboard */
.main-container {
display: none;
}

.dashboard-header {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
border-radius: 16px;
padding: 25px;
margin-bottom: 20px;
text-align: center;
box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.dashboard-title {
font-size: 22px;
color: white;
margin-bottom: 8px;
font-weight: 700;
}

.dashboard-subtitle {
color: rgba(255,255,255,0.9);
font-size: 15px;
font-weight: 500;
}

.refresh-info {
background: linear-gradient(135deg, #e3f2fd, #f8f9ff);
border: 1px solid #bbdefb;
padding: 15px;
border-radius: 12px;
margin-bottom: 20px;
text-align: center;
font-size: 14px;
color: #1976d2;
box-shadow: 0 4px 12px rgba(25,118,210,0.1);
}

.refresh-btn {
background: linear-gradient(135deg, #2196f3, #1976d2);
color: white;
border: none;
padding: 8px 16px;
border-radius: 8px;
cursor: pointer;
font-size: 12px;
font-weight: 600;
margin-left: 10px;
transition: all 0.3s;
box-shadow: 0 2px 8px rgba(33,150,243,0.3);
}

.refresh-btn:hover {
transform: translateY(-1px);
box-shadow: 0 4px 12px rgba(33,150,243,0.4);
}

.auth-status {
background: linear-gradient(135deg, #fff3cd, #ffeaa7);
border: 1px solid #ffd54f;
padding: 16px;
border-radius: 12px;
margin-bottom: 20px;
text-align: center;
box-shadow: 0 4px 12px rgba(255,193,7,0.2);
}

.auth-status.authenticated {
background: linear-gradient(135deg, #d4edda, #c3e6cb);
border-color: #a5d6a7;
color: #155724;
box-shadow: 0 4px 12px rgba(76,175,80,0.2);
}

.auth-status.unauthenticated {
background: linear-gradient(135deg, #f8d7da, #f5c6cb);
border-color: #ef5350;
color: #721c24;
box-shadow: 0 4px 12px rgba(244,67,54,0.2);
}

/* Incident Sections */
.incidents-container {
background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
border-radius: 16px;
overflow: hidden;
margin-bottom: 20px;
box-shadow: 0 8px 32px rgba(0,0,0,0.12);
border: 1px solid rgba(102,126,234,0.1);
}

.section-header {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
padding: 20px 25px;
display: flex;
align-items: center;
justify-content: space-between;
}

.section-title {
font-size: 16px;
font-weight: 700;
display: flex;
align-items: center;
gap: 10px;
letter-spacing: 0.5px;
}

.section-count {
background: rgba(255,255,255,0.2);
color: white;
padding: 6px 14px;
border-radius: 20px;
font-size: 13px;
font-weight: 700;
backdrop-filter: blur(10px);
}

.section-count.pending { 
background: linear-gradient(135deg, #ff9800, #f57c00); 
box-shadow: 0 2px 8px rgba(255,152,0,0.3);
}
.section-count.working { 
background: linear-gradient(135deg, #4caf50, #388e3c); 
box-shadow: 0 2px 8px rgba(76,175,80,0.3);
}
.section-count.expired { 
background: linear-gradient(135deg, #f44336, #d32f2f); 
box-shadow: 0 2px 8px rgba(244,67,54,0.3);
animation: pulse 2s infinite;
}

@keyframes pulse {
0% { transform: scale(1); }
50% { transform: scale(1.05); }
100% { transform: scale(1); }
}

.section-content {
padding: 0;
background: white;
}

/* Incident Items */
.incident-item {
padding: 24px;
border-bottom: 1px solid #f5f7fa;
transition: all 0.3s ease;
position: relative;
}

.incident-item:hover {
background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
transform: translateY(-1px);
box-shadow: 0 4px 20px rgba(102,126,234,0.08);
}

.incident-item:last-child {
border-bottom: none;
}

.incident-item.expired {
background: linear-gradient(135deg, #fff5f5 0%, #ffebee 100%);
border-left: 4px solid #f44336;
position: relative;
}

.incident-item.expired::before {
content: '🚨';
position: absolute;
top: 10px;
right: 10px;
font-size: 20px;
animation: blink 2s infinite;
}

@keyframes blink {
0%, 50% { opacity: 1; }
51%, 100% { opacity: 0.3; }
}

.incident-item.working {
background: linear-gradient(135deg, #f0fff4 0%, #e8f5e8 100%);
border-left: 4px solid #4caf50;
}

.incident-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 12px;
}

.incident-id {
font-weight: 700;
color: #1a237e;
font-size: 15px;
background: linear-gradient(135deg, #e8eaf6, #c5cae9);
padding: 6px 12px;
border-radius: 8px;
border: 1px solid #9fa8da;
}

.priority-badge {
padding: 6px 12px;
border-radius: 12px;
font-size: 11px;
font-weight: 700;
text-transform: uppercase;
letter-spacing: 0.5px;
box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.priority-critica {
background: linear-gradient(135deg, #f44336, #d32f2f);
color: white;
animation: urgentPulse 3s infinite;
}

@keyframes urgentPulse {
0%, 100% { box-shadow: 0 2px 8px rgba(244,67,54,0.3); }
50% { box-shadow: 0 4px 16px rgba(244,67,54,0.6); }
}

.priority-alta {
background: linear-gradient(135deg, #ff9800, #f57c00);
color: white;
}

.priority-media {
background: linear-gradient(135deg, #ffc107, #ff8f00);
color: white;
}

.priority-baja {
background: linear-gradient(135deg, #4caf50, #388e3c);
color: white;
}

.incident-info {
margin-bottom: 16px;
}

.incident-equipment {
font-weight: 700;
color: #1565c0;
margin-bottom: 8px;
font-size: 16px;
}

.incident-zone {
color: #424242;
font-size: 13px;
margin-bottom: 8px;
background: #f5f5f5;
padding: 4px 8px;
border-radius: 6px;
display: inline-block;
}

.incident-description {
color: #616161;
font-size: 13px;
line-height: 1.5;
background: #fafafa;
padding: 10px;
border-radius: 8px;
border-left: 3px solid #e0e0e0;
}

/* SLA Timer */
.sla-timer {
background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
border-radius: 16px;
padding: 20px;
margin-bottom: 20px;
text-align: center;
border: 2px solid #e8eaf6;
box-shadow: 0 8px 24px rgba(102,126,234,0.12);
}

.sla-time {
font-size: 28px;
font-weight: 800;
margin-bottom: 8px;
font-family: 'Courier New', monospace;
text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.sla-time.good { 
color: #4caf50; 
text-shadow: 0 2px 8px rgba(76,175,80,0.3);
}
.sla-time.warning { 
color: #ff9800; 
text-shadow: 0 2px 8px rgba(255,152,0,0.3);
animation: warningPulse 2s infinite;
}
.sla-time.critical { 
color: #f44336; 
text-shadow: 0 2px 8px rgba(244,67,54,0.3);
animation: criticalPulse 1s infinite;
}

@keyframes warningPulse {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.02); }
}

@keyframes criticalPulse {
0%, 100% { transform: scale(1); }
25%, 75% { transform: scale(1.05); }
}

.sla-label {
color: #666;
font-size: 13px;
font-weight: 600;
margin-bottom: 8px;
}

.sla-level {
background: linear-gradient(135deg, #667eea, #764ba2);
color: white;
padding: 6px 12px;
border-radius: 12px;
font-size: 12px;
font-weight: 700;
display: inline-block;
letter-spacing: 0.5px;
box-shadow: 0 2px 8px rgba(102,126,234,0.3);
}

/* Expired Timer */
.expired-timer {
background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
border: 2px solid #ef5350;
border-radius: 16px;
padding: 20px;
margin-bottom: 20px;
text-align: center;
box-shadow: 0 8px 24px rgba(244,67,54,0.2);
animation: expiredGlow 3s infinite;
}

@keyframes expiredGlow {
0%, 100% { box-shadow: 0 8px 24px rgba(244,67,54,0.2); }
50% { box-shadow: 0 12px 32px rgba(244,67,54,0.4); }
}

.expired-time {
font-size: 24px;
font-weight: 800;
color: #d32f2f;
margin-bottom: 8px;
text-shadow: 0 2px 4px rgba(211,47,47,0.3);
}

.expired-label {
color: #d32f2f;
font-size: 13px;
font-weight: 700;
letter-spacing: 0.5px;
}

.escalation-info {
background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
padding: 16px;
border-radius: 12px;
margin-bottom: 20px;
font-size: 13px;
color: #e65100;
text-align: center;
border-left: 4px solid #ff9800;
font-weight: 600;
box-shadow: 0 4px 16px rgba(255,152,0,0.15);
}

/* Action Buttons */
.action-buttons {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 12px;
margin-top: 20px;
}

.action-btn {
padding: 14px 20px;
border: none;
border-radius: 12px;
font-size: 14px;
font-weight: 700;
cursor: pointer;
transition: all 0.3s ease;
display: flex;
align-items: center;
justify-content: center;
gap: 8px;
text-transform: uppercase;
letter-spacing: 0.5px;
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.action-btn.locked {
opacity: 0.6;
cursor: not-allowed;
background: linear-gradient(135deg, #9e9e9e, #757575) !important;
box-shadow: 0 2px 8px rgba(158,158,158,0.3) !important;
}

.btn-accept {
background: linear-gradient(135deg, #4caf50, #388e3c);
color: white;
}

.btn-accept:hover:not(.locked) {
background: linear-gradient(135deg, #66bb6a, #4caf50);
transform: translateY(-2px);
box-shadow: 0 8px 20px rgba(76,175,80,0.4);
}

.btn-reject {
background: linear-gradient(135deg, #f44336, #d32f2f);
color: white;
}

.btn-reject:hover:not(.locked) {
background: linear-gradient(135deg, #ef5350, #f44336);
transform: translateY(-2px);
box-shadow: 0 8px 20px rgba(244,67,54,0.4);
}

.btn-help {
background: linear-gradient(135deg, #ff9800, #f57c00);
color: white;
grid-column: 1 / -1;
}

.btn-help:hover:not(.locked) {
background: linear-gradient(135deg, #ffb74d, #ff9800);
transform: translateY(-2px);
box-shadow: 0 8px 20px rgba(255,152,0,0.4);
}

/* Phone Buttons */
.phone-buttons {
display: grid;
grid-template-columns: 1fr;
gap: 12px;
margin-top: 20px;
}

.phone-btn {
padding: 14px 20px;
background: linear-gradient(135deg, #2196f3, #1976d2);
color: white;
border: none;
border-radius: 12px;
font-size: 14px;
font-weight: 700;
cursor: pointer;
transition: all 0.3s ease;
display: flex;
align-items: center;
justify-content: center;
gap: 8px;
text-decoration: none;
text-transform: uppercase;
letter-spacing: 0.5px;
box-shadow: 0 4px 12px rgba(33,150,243,0.3);
}

.phone-btn:hover {
background: linear-gradient(135deg, #42a5f5, #2196f3);
transform: translateY(-2px);
box-shadow: 0 8px 20px rgba(33,150,243,0.4);
}

.phone-btn.supervisor {
background: linear-gradient(135deg, #9c27b0, #7b1fa2);
box-shadow: 0 4px 12px rgba(156,39,176,0.3);
}

.phone-btn.supervisor:hover {
background: linear-gradient(135deg, #ab47bc, #9c27b0);
box-shadow: 0 8px 20px rgba(156,39,176,0.4);
}-radius: 8px;
font-size: 14px;
font-weight: 600;
cursor: pointer;
transition: all 0.3s;
display: flex;
align-items: center;
justify-content: center;
gap: 6px;
text-decoration: none;
}

.phone-btn:hover {
transform: translateY(-1px);
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.phone-btn.supervisor {
background: linear-gradient(45deg, #805ad5, #9f7aea);
}

/* PIN Modal */
.pin-modal-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.7);
display: flex;
align-items: center;
justify-content: center;
z-index: 1000;
opacity: 0;
visibility: hidden;
transition: all 0.3s;
}

.pin-modal-overlay.active {
opacity: 1;
visibility: visible;
}

.pin-modal {
background: white;
border-radius: 16px;
padding: 30px;
max-width: 400px;
width: 90%;
text-align: center;
transform: scale(0.8);
transition: transform 0.3s;
}

.pin-modal-overlay.active .pin-modal {
transform: scale(1);
}

.pin-modal-title {
font-size: 20px;
color: #2c3e50;
margin-bottom: 10px;
}

.pin-modal-subtitle {
color: #7f8c8d;
margin-bottom: 25px;
}

.pin-input {
width: 100%;
padding: 15px;
border: 2px solid #e9ecef;
border-radius: 8px;
font-size: 18px;
text-align: center;
letter-spacing: 8px;
margin-bottom: 20px;
}

.pin-input:focus {
outline: none;
border-color: #3498db;
}

.pin-actions {
display: flex;
gap: 15px;
}

.pin-btn {
flex: 1;
padding: 15px;
border: none;
border-radius: 8px;
font-size: 16px;
font-weight: 600;
cursor: pointer;
transition: all 0.3s;
}

.pin-btn-cancel {
background: #f8f9fa;
color: #6c757d;
}

.pin-btn-verify {
background: linear-gradient(45deg, #3498db, #2980b9);
color: white;
}

.pin-btn:disabled {
opacity: 0.5;
cursor: not-allowed;
}

/* Reason Modal */
.modal-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.5);
display: flex;
align-items: center;
justify-content: center;
z-index: 1000;
opacity: 0;
visibility: hidden;
transition: all 0.3s;
}

.modal-overlay.active {
opacity: 1;
visibility: visible;
}

.modal-content {
background: white;
border-radius: 16px;
padding: 30px;
max-width: 450px;
width: 90%;
max-height: 80vh;
overflow-y: auto;
transform: scale(0.8);
transition: transform 0.3s;
}

.modal-overlay.active .modal-content {
transform: scale(1);
}

.modal-title {
font-size: 20px;
color: #2c3e50;
margin-bottom: 20px;
text-align: center;
}

.reason-options {
display: flex;
flex-direction: column;
gap: 12px;
margin-bottom: 25px;
}

.reason-option {
padding: 15px;
border: 2px solid #e9ecef;
border-radius: 12px;
cursor: pointer;
transition: all 0.3s;
display: flex;
align-items: center;
gap: 12px;
}

.reason-option:hover {
border-color: #3498db;
background: #f8f9ff;
}

.reason-option.selected {
border-color: #3498db;
background: #e3f2fd;
}

.reason-icon {
font-size: 24px;
min-width: 30px;
}

.reason-text {
flex: 1;
}

.reason-title {
font-weight: 600;
color: #2c3e50;
margin-bottom: 3px;
}

.reason-description {
font-size: 13px;
color: #7f8c8d;
}

.modal-actions {
display: flex;
gap: 15px;
}

.modal-btn {
flex: 1;
padding: 15px;
border: none;
border-radius: 8px;
font-size: 16px;
font-weight: 600;
cursor: pointer;
transition: all 0.3s;
}

.btn-cancel {
background: #f8f9fa;
color: #6c757d;
}

.btn-confirm {
background: linear-gradient(45deg, #3498db, #2980b9);
color: white;
}

.btn-confirm:disabled {
opacity: 0.5;
cursor: not-allowed;
}

/* Loading */
.loading {
text-align: center;
padding: 40px;
color: #7f8c8d;
}

.spinner {
width: 40px;
height: 40px;
border: 4px solid #e9ecef;
border-top-color: #3498db;
border-radius: 50%;
animation: spin 1s linear infinite;
margin: 0 auto 20px;
}

@keyframes spin {
to { transform: rotate(360deg); }
}

/* No incidents */
.no-incidents {
background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
border-radius: 20px;
padding: 50px 30px;
text-align: center;
box-shadow: 0 12px 40px rgba(102,126,234,0.15);
border: 1px solid rgba(102,126,234,0.1);
}

.no-incidents-icon {
font-size: 80px;
margin-bottom: 25px;
filter: drop-shadow(0 4px 12px rgba(102,126,234,0.2));
}

.no-incidents-title {
font-size: 22px;
color: #1a237e;
margin-bottom: 12px;
font-weight: 700;
}

.no-incidents-description {
color: #5c6bc0;
font-size: 16px;
line-height: 1.5;
}

/* Additional info styles */
.assigned-info, .closed-info, .status-info {
background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
padding: 10px 14px;
border-radius: 8px;
margin: 8px 0;
font-size: 13px;
color: #495057;
border-left: 4px solid #6c757d;
font-weight: 500;
}

.response-info {
background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 30%);
padding: 12px 16px;
border-radius: 10px;
margin: 10px 0;
font-size: 13px;
color: #0d47a1;
border-left: 4px solid #2196f3;
font-weight: 600;
box-shadow: 0 2px 8px rgba(33,150,243,0.15);
}

.reject-reason, .help-type {
background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 30%);
padding: 8px 12px;
border-radius: 6px;
margin: 6px 0;
font-size: 12px;
color: #e65100;
border-left: 3px solid #ff9800;
font-weight: 500;
}

.contact-info {
background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 30%);
padding: 12px 16px;
border-radius: 10px;
margin: 10px 0;
font-size: 13px;
color: #1b5e20;
border-left: 4px solid #4caf50;
text-align: center;
font-weight: 600;
box-shadow: 0 2px 8px rgba(76,175,80,0.15);
}

/* Responsive */
@media (max-width: 768px) {
.container {
padding: 15px;
}

.action-buttons {
grid-template-columns: 1fr;
}

.btn-help {
grid-column: 1;
}

.phone-buttons {
grid-template-columns: 1fr;
}
}
</style>
</head>
<body>
<!-- Login Container -->
<div class="container" id="loginContainer">
<div class="login-container">
<h1 class="login-title">📱 Dashboard Técnico</h1>
<p class="login-subtitle">Accede con tu email para gestionar incidencias</p>

<div class="input-group">
<label class="input-label" for="emailInput">Email Técnico</label>
<input type="email"
class="input-field"
id="emailInput"
placeholder="ejemplo@empresa.com"
autocomplete="email">
</div>

<button onclick="loginWithPIN()" class="verify-btn" id="loginBtn">
🔐 Acceder con PIN (Dashboard Completo)
</button>

<button onclick="loginQuickAccess()" class="quick-access-btn" id="quickBtn">
🔍 Ver incidencia específica (desde email)
</button>

<div id="loginError" class="error-message" style="display: none;"></div>
<div id="loginSuccess" class="success-message" style="display: none;"></div>
</div>
</div>

<!-- Main Dashboard Container -->
<div class="container main-container" id="mainContainer">
<!-- Dashboard Header -->
<div class="dashboard-header">
<h1 class="dashboard-title" id="dashboardTitle">📱 Dashboard Técnico</h1>
<div class="dashboard-subtitle" id="dashboardSubtitle">Sistema de Respuesta a Incidencias</div>
</div>

<!-- Refresh Info -->
<div class="refresh-info" id="refreshInfo">
🔄 Actualización manual
<button class="refresh-btn" onclick="refreshIncidents()">Actualizar</button>
</div>

<!-- Auth Status -->
<div class="auth-status" id="authStatus">
<div id="authMessage">⚠️ Solo lectura - Introduce PIN para responder</div>
</div>

<!-- Incidents Container -->
<div id="incidentsContainer">
<!-- Se llena dinámicamente -->
</div>
</div>

<!-- PIN Modal -->
<div class="pin-modal-overlay" id="pinModal">
<div class="pin-modal">
<h3 class="pin-modal-title">🔐 Verificación de Seguridad</h3>
<p class="pin-modal-subtitle">Introduce tu PIN de 4 dígitos para responder</p>
<input type="password"
class="pin-input"
id="pinInput"
maxlength="4"
placeholder="••••"
autocomplete="off">
<div class="pin-actions">
<button class="pin-btn pin-btn-cancel" onclick="closePINModal()">
Cancelar
</button>
<button class="pin-btn pin-btn-verify" id="verifyPinBtn" onclick="verifyPIN()" disabled>
Verificar
</button>
</div>
<div id="pinError" class="error-message" style="display: none; margin-top: 15px;"></div>
</div>
</div>

<!-- Reason Selection Modal -->
<div class="modal-overlay" id="reasonModal">
<div class="modal-content">
<h3 class="modal-title" id="modalTitle">Selecciona el motivo</h3>
<div class="reason-options" id="reasonOptions">
<!-- Se llena dinámicamente -->
</div>
<div class="modal-actions">
<button class="modal-btn btn-cancel" onclick="closeReasonModal()">
Cancelar
</button>
<button class="modal-btn btn-confirm" id="confirmBtn" onclick="confirmAction()" disabled>
Confirmar
</button>
</div>
</div>
</div>

<script>
// === VARIABLES GLOBALES ===
let currentIncident = null;
let currentTechnician = null;
let isAuthenticated = false;
let slaInterval = null;
let pendingAction = null;
let selectedReason = null;
let accessMode = 'none'; // 'none', 'read_only', 'full_access'
let refreshInterval = null;
let allIncidents = [];

// === MOTIVOS DE RESPUESTA ===
const rejectReasons = [
{ id: 'ocupado_otra', icon: '⚡', title: 'Ocupado con otra incidencia', description: 'Ya estoy resolviendo otra incidencia crítica' },
{ id: 'fuera_especialidad', icon: '❓', title: 'Fuera de mi especialidad', description: 'No tengo experiencia con este tipo de equipo' },
{ id: 'no_disponible', icon: '⏰', title: 'No disponible ahora', description: 'Estoy en pausa, reunión o fuera de turno' },
{ id: 'falta_herramientas', icon: '🔧', title: 'Faltan herramientas/repuestos', description: 'No tengo las herramientas necesarias disponibles' },
{ id: 'ubicacion_lejos', icon: '📍', title: 'Muy lejos de mi ubicación', description: 'Estoy muy lejos de la zona de la incidencia' },
{ id: 'sobrecarga_trabajo', icon: '⚡', title: 'Sobrecarga de trabajo', description: 'Ya tengo demasiadas incidencias asignadas' }
];

const helpReasons = [
{ id: 'apoyo_tecnico', icon: '🤝', title: 'Necesito apoyo técnico', description: 'Requiero asistencia de otro técnico especializado' },
{ id: 'consulta_supervisor', icon: '👨', title: 'Consulta con supervisor', description: 'Necesito autorización o guía del supervisor' },
{ id: 'herramientas_especiales', icon: '🔧', title: 'Herramientas especiales', description: 'Requiero herramientas específicas no disponibles' },
{ id: 'procedimiento_dudas', icon: '📖', title: 'Dudas sobre procedimiento', description: 'No estoy seguro del procedimiento correcto' },
{ id: 'seguridad_riesgo', icon: '⚠️', title: 'Problema de seguridad', description: 'Hay riesgos de seguridad que requieren evaluación' },
{ id: 'repuestos_urgentes', icon: '📦', title: 'Repuestos urgentes', description: 'Necesito repuestos específicos urgentemente' }
];

// === INICIALIZACIÓN ===
window.addEventListener('DOMContentLoaded', function() {
console.log('📱 Dashboard Técnico iniciado');

// Verificar si hay parámetros en la URL (acceso desde email)
const urlParams = new URLSearchParams(window.location.search);
const email = urlParams.get('tecnico') || urlParams.get('technician_email');
const nombre = urlParams.get('nombre') || urlParams.get('technician_name');
const incidentId = urlParams.get('id') || urlParams.get('incident_id');

if (email) {
document.getElementById('emailInput').value = email;

// Guardar nombre si viene en URL
if (nombre) {
currentTechnician = {
email: email,
name: decodeURIComponent(nombre)
};
}

if (incidentId) {
// Acceso desde email - modo solo lectura inicialmente
console.log('📧 Acceso desde email detectado');
loginQuickAccess();
}
}
});

// === FUNCIONES DE LOGIN ===
async function loginWithPIN() {
const email = document.getElementById('emailInput').value.trim();

if (!email || !email.includes('@')) {
showError('Por favor ingresa un email válido', document.getElementById('loginError'));
return;
}

// Mostrar modal de PIN
showPINModal('dashboard');
}

async function loginQuickAccess() {
const email = document.getElementById('emailInput').value.trim();

if (!email || !email.includes('@')) {
showError('Por favor ingresa un email válido', document.getElementById('loginError'));
return;
}

// Acceso rápido sin PIN (solo lectura)
accessMode = 'read_only';
await loadTechnicianDashboard(email, false);
}

// === MODAL DE PIN ===
function showPINModal(purpose = 'action') {
const modal = document.getElementById('pinModal');
const pinInput = document.getElementById('pinInput');
const verifyBtn = document.getElementById('verifyPinBtn');

pinInput.value = '';
verifyBtn.disabled = true;
hideMessage(document.getElementById('pinError'));

// Configurar según el propósito
if (purpose === 'dashboard') {
document.querySelector('.pin-modal-title').textContent = '🔐 Acceso al Dashboard';
document.querySelector('.pin-modal-subtitle').textContent = 'Introduce tu PIN para acceso completo';
} else {
document.querySelector('.pin-modal-title').textContent = '🔐 Confirmar Acción';
document.querySelector('.pin-modal-subtitle').textContent = 'Introduce tu PIN para responder';
}

modal.classList.add('active');
pinInput.focus();

// Eventos de teclado
pinInput.oninput = function() {
verifyBtn.disabled = this.value.length !== 4;
};

pinInput.onkeypress = function(e) {
if (e.key === 'Enter' && this.value.length === 4) {
verifyPIN();
}
};
}

function closePINModal() {
document.getElementById('pinModal').classList.remove('active');
pendingAction = null;
}

async function verifyPIN() {
const pin = document.getElementById('pinInput').value;
const email = document.getElementById('emailInput').value;
const verifyBtn = document.getElementById('verifyPinBtn');

if (pin.length !== 4) {
showError('Introduce un PIN de 4 dígitos', document.getElementById('pinError'));
return;
}

verifyBtn.disabled = true;
verifyBtn.textContent = '🔄 Verificando...';

try {
const response = await fetch('/api/webhook-respuesta', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
action: 'validate_technician_pin',
technician_email: email,
technician_name: currentTechnician?.name || email.split('@')[0],
pin: pin
})
});

const data = await response.json();

if (data.status === 'success') {
isAuthenticated = true;
accessMode = 'full_access';
closePINModal();

// Actualizar datos del técnico
currentTechnician = {
email: email,
name: data.technician.name,
department: data.technician.department,
level: data.technician.level
};

if (pendingAction) {
// Continuar con la acción pendiente
if (pendingAction === 'acepto') {
confirmAction();
} else {
showReasonModal(pendingAction);
}
} else {
// Cargar dashboard completo - CORRECCIÓN DEL ERROR
await loadTechnicianDashboard(email, true);
updateAuthStatus();
}
} else {
showError(data.message || 'PIN incorrecto', document.getElementById('pinError'));
}

} catch (error) {
console.error('Error verificando PIN:', error);
showError('Error de conexión. Inténtalo más tarde.', document.getElementById('pinError'));
} finally {
verifyBtn.disabled = false;
verifyBtn.textContent = 'Verificar';
}
}

// === CARGAR DASHBOARD ===
async function loadTechnicianDashboard(email, useFullAccess = false) {
try {
showLoading('Cargando tus incidencias...');

const response = await fetch('/api/webhook-respuesta', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
action: 'get_assigned_incidents',
technician_email: email,
technician_name: currentTechnician?.name || email.split('@')[0],
read_only: !useFullAccess
})
});

const data = await response.json();
console.log('📋 Respuesta del servidor:', data);

if (data.status === 'success') {
if (!currentTechnician) {
currentTechnician = {
email: email,
name: data.technician?.name || email.split('@')[0]
};
}

// Guardar incidencias
allIncidents = data.incidents || [];

// Mostrar dashboard
document.getElementById('loginContainer').style.display = 'none';
document.getElementById('mainContainer').style.display = 'block';

// Actualizar header
document.getElementById('dashboardTitle').textContent = '📱 Dashboard de ' + currentTechnician.name;

// Actualizar estado de autenticación
updateAuthStatus();

// Renderizar incidencias
renderIncidents(allIncidents);

// Configurar auto-refresh para críticas
setupAutoRefresh();

} else {
throw new Error(data.message || 'Error cargando dashboard');
}

} catch (error) {
console.error('Error cargando dashboard:', error);
showError('Error de conexión. Inténtalo más tarde.', document.getElementById('loginError'));
} finally {
hideLoading();
}
}

// === ACTUALIZAR ESTADO DE AUTENTICACIÓN ===
function updateAuthStatus() {
const statusDiv = document.getElementById('authStatus');
const messageDiv = document.getElementById('authMessage');

if (accessMode === 'full_access') {
statusDiv.className = 'auth-status authenticated';
messageDiv.innerHTML = '✅ <strong>Autenticado</strong> - Puedes responder a incidencias';
} else if (accessMode === 'read_only') {
statusDiv.className = 'auth-status unauthenticated';
messageDiv.innerHTML = '🔍 <strong>Solo lectura</strong> - Introduce PIN para responder';
} else {
statusDiv.className = 'auth-status';
messageDiv.innerHTML = '⚠️ Sin autenticar';
}
}

// === AUTO-REFRESH ===
function setupAutoRefresh() {
// Limpiar interval anterior
if (refreshInterval) {
clearInterval(refreshInterval);
}

// Verificar si hay incidencias críticas asignadas
const hasCritical = allIncidents.some(inc =>
inc.priority && inc.priority.includes('CRÍTICA') &&
isAssignedToMe(inc) &&
!inc.assigned_technician
);

if (hasCritical) {
// Auto-refresh cada 5 minutos para críticas
refreshInterval = setInterval(() => {
console.log('🔄 Auto-refresh por incidencias críticas');
refreshIncidents();
}, 5 * 60 * 1000);

const refreshInfo = document.getElementById('refreshInfo');
refreshInfo.innerHTML = '';
const autoText = document.createTextNode('🔄 Auto-actualización cada 5 min (incidencias críticas) ');
const refreshBtn = document.createElement('button');
refreshBtn.className = 'refresh-btn';
refreshBtn.textContent = 'Actualizar ahora';
refreshBtn.onclick = refreshIncidents;
refreshInfo.appendChild(autoText);
refreshInfo.appendChild(refreshBtn);
} else {
const refreshInfo = document.getElementById('refreshInfo');
refreshInfo.innerHTML = '';
const manualText = document.createTextNode('🔄 Actualización manual ');
const refreshBtn = document.createElement('button');
refreshBtn.className = 'refresh-btn';
refreshBtn.textContent = 'Actualizar';
refreshBtn.onclick = refreshIncidents;
refreshInfo.appendChild(manualText);
refreshInfo.appendChild(refreshBtn);
}
}

async function refreshIncidents() {
if (currentTechnician) {
await loadTechnicianDashboard(currentTechnician.email, accessMode === 'full_access');
}
}

// === RENDERIZADO DE INCIDENCIAS ===
function renderIncidents(incidents) {
const container = document.getElementById('incidentsContainer');
const urlParams = new URLSearchParams(window.location.search);
const specificIncidentId = urlParams.get('id') || urlParams.get('incident_id');

// Si hay ID específico en URL, mostrar solo esa incidencia
if (specificIncidentId) {
const specificIncident = incidents.find(inc => inc.id === specificIncidentId);
if (specificIncident) {
renderSingleIncident(specificIncident);
return;
} else {
container.innerHTML = createNoIncidentsHTML('Incidencia No Encontrada', '❓', 'La incidencia ' + specificIncidentId + ' no existe o no está asignada a ti');
return;
}
}

// Clasificar incidencias
const classified = classifyIncidents(incidents);
const pending = classified.pending;
const working = classified.working;
const expired = classified.expired;

// Actualizar subtitle
document.getElementById('dashboardSubtitle').textContent = pending.length + ' pendiente(s) • ' + working.length + ' trabajando • ' + expired.length + ' vencida(s)';

// Renderizar todas las secciones
if (pending.length === 0 && working.length === 0 && expired.length === 0) {
container.innerHTML = createNoIncidentsHTML('Sin Incidencias', '✅', 'No tienes incidencias asignadas en este momento');
return;
}

let html = '';

// Sección Pendientes
if (pending.length > 0) {
html += renderIncidentSection('pending', '⏳ PENDIENTES DE RESPUESTA', pending, pending.length);
}

// Sección Trabajando
if (working.length > 0) {
html += renderIncidentSection('working', '🔧 TRABAJANDO', working, working.length);
}

// Sección Vencidas
if (expired.length > 0) {
html += renderIncidentSection('expired', '🚨 VENCIDAS (Solo contacto telefónico)', expired, expired.length);
}

container.innerHTML = html;

// Iniciar timers SLA
startAllSLATimers();
}

function createNoIncidentsHTML(title, icon, description) {
return '<div class="no-incidents">' +
'<div class="no-incidents-icon">' + icon + '</div>' +
'<h3 class="no-incidents-title">' + title + '</h3>' +
'<p class="no-incidents-description">' + description + '</p>' +
'</div>';
}

function classifyIncidents(incidents) {
const pending = [];
const working = [];
const expired = [];

incidents.forEach(incident => {
// Verificar si está asignado a mí
if (!isAssignedToMe(incident)) return;

// Verificar si ya está trabajando (asignado definitivamente)
if (incident.assigned_technician && incident.assigned_technician !== 'Sin asignar' && incident.assigned_technician !== '' && incident.assigned_technician === currentTechnician.name) {
// Ya trabajando
working.push(incident);
} else {
// Verificar si SLA vencido basándose en time_elapsed y nivel de escalado
const timeElapsed = incident.time_elapsed || 0;
const escalationLevel = incident.escalation_level || 0;
const escalationPaused = incident.escalation_paused === 'true';
const status = incident.status || '';

// Determinar si está vencida
let isExpired = false;

// Si el escalado está pausado, no está vencida
if (escalationPaused) {
isExpired = false;
} else {
// Determinar SLA según el nivel del técnico
let slaMinutes = 30; // Default L0
if (getIncidentLevel(incident) === 'L1') slaMinutes = 45;
if (getIncidentLevel(incident) === 'L2') slaMinutes = 60;

isExpired = timeElapsed > slaMinutes;
}

// Verificar si ya ha respondido
let hasResponded = false;
const level = getIncidentLevel(incident);
if (level === 'L0' && incident.l0_response && incident.l0_response !== '⭕ Sin Respuesta') {
hasResponded = true;
} else if (level === 'L1' && incident.l1_response && incident.l1_response !== '⭕ Sin Respuesta') {
hasResponded = true;
} else if (level === 'L2' && incident.l2_responses && incident.l2_responses !== '') {
hasResponded = true;
}

if (hasResponded || isExpired || escalationLevel > getCurrentEscalationLevel()) {
expired.push(incident);
} else {
pending.push(incident);
}
}
});

return { pending, working, expired };
}

function isAssignedToMe(incident) {
const email = currentTechnician?.email;
if (!email) return false;

return (
incident.l0_technician === email ||
incident.l1_technician === email ||
(incident.l2_technicians_notified && incident.l2_technicians_notified.includes(email)) ||
incident.assigned_technician === email
);
}

function renderIncidentSection(type, title, incidents, count) {
return '<div class="incidents-container">' +
'<div class="section-header">' +
'<div class="section-title">' +
title +
'<span class="section-count ' + type + '">' + count + '</span>' +
'</div>' +
'</div>' +
'<div class="section-content">' +
incidents.map(incident => renderIncidentItem(incident, type)).join('') +
'</div>' +
'</div>';
}

function renderIncidentItem(incident, type) {
const priorityClass = getPriorityClass(incident.priority);
const level = getIncidentLevel(incident);

let actionContent = '';
let timerContent = '';

// Determinar información de respuesta según el nivel
let responseInfo = '';
if (level === 'L0') {
    if (incident.l0_response && incident.l0_response !== '⭕ Sin Respuesta') {
        responseInfo = `<div class="response-info">Respuesta L0: ${incident.l0_response}</div>`;
        if (incident.l0_response.includes('Rechazado') && incident.l0_reject_reason !== 'Sin motivo') {
            responseInfo += `<div class="reject-reason">Motivo: ${incident.l0_reject_reason}</div>`;
        }
        if (incident.l0_response.includes('Ayuda') && incident.l0_help_type !== 'Sin ayuda') {
            responseInfo += `<div class="help-type">Tipo ayuda: ${incident.l0_help_type}</div>`;
        }
    }
} else if (level === 'L1') {
    if (incident.l1_response && incident.l1_response !== '⭕ Sin Respuesta') {
        responseInfo = `<div class="response-info">Respuesta L1: ${incident.l1_response}</div>`;
        if (incident.l1_response.includes('Rechazado') && incident.l1_reject_reason !== 'Sin motivo') {
            responseInfo += `<div class="reject-reason">Motivo: ${incident.l1_reject_reason}</div>`;
        }
        if (incident.l1_response.includes('Ayuda') && incident.l1_help_type !== 'Sin ayuda') {
            responseInfo += `<div class="help-type">Tipo ayuda: ${incident.l1_help_type}</div>`;
        }
    }
} else if (level === 'L2') {
    if (incident.l2_responses && incident.l2_responses !== '') {
        responseInfo = `<div class="response-info">Respuestas L2: ${incident.l2_responses}</div>`;
        if (incident.l2_reject_reasons !== 'Sin motivos') {
            responseInfo += `<div class="reject-reason">Motivos: ${incident.l2_reject_reasons}</div>`;
        }
    }
}

if (type === 'pending') {
    // Botones de acción + timer SLA
    const canRespond = (accessMode === 'full_access');
    const acceptIcon = canRespond ? '✅' : '🔒';
    const rejectIcon = canRespond ? '❌' : '🔒';
    const helpIcon = canRespond ? '🆘' : '🔒';
    const lockClass = canRespond ? '' : ' locked';

    actionContent = '<div class="action-buttons">' +
    '<button class="action-btn btn-accept' + lockClass + '" onclick="handleAction(\'acepto\', \'' + incident.id + '\')">' +
    acceptIcon + ' Acepto</button>' +
    '<button class="action-btn btn-reject' + lockClass + '" onclick="handleAction(\'rechazo\', \'' + incident.id + '\')">' +
    rejectIcon + ' Rechazo</button>' +
    '<button class="action-btn btn-help' + lockClass + '" onclick="handleAction(\'ayuda\', \'' + incident.id + '\')">' +
    helpIcon + ' Solicitar Ayuda</button>' +
    '</div>';
    timerContent = renderSLATimer(incident, level);
} else if (type === 'working') {
    // Solo botón de ayuda
    const canRespond = (accessMode === 'full_access');
    const helpIcon = canRespond ? '🆘' : '🔒';
    const lockClass = canRespond ? '' : ' locked';
    actionContent = '<div class="action-buttons">' +
    '<button class="action-btn btn-help' + lockClass + '" onclick="handleAction(\'ayuda\', \'' + incident.id + '\')">' +
    helpIcon + ' Solicitar Ayuda</button>' +
    '</div>';
} else if (type === 'expired') {
    // Información de escalado y contacto telefónico
    const timeElapsed = incident.time_elapsed || 0;
    const hoursElapsed = Math.floor(timeElapsed / 60);
    const minutesElapsed = timeElapsed % 60;
    
    timerContent = '<div class="expired-timer">' +
    '<div class="expired-time">⏰ Hace ' + hoursElapsed + 'h ' + minutesElapsed + 'm</div>' +
    '<div class="expired-label">VENCIDA - SLA SUPERADO</div>' +
    '</div>';

    // Información de escalado
    const escalationLevel = incident.escalation_level || 0;
    const escalationPaused = incident.escalation_paused === 'true';
    
    let escalationInfo = '';
    if (escalationPaused) {
        escalationInfo = '🚦 Escalado pausado por supervisor';
    } else if (escalationLevel > 0) {
        escalationInfo = `⚠️ Escalado a nivel L${escalationLevel} - Contacta por teléfono para coordinar`;
    } else {
        escalationInfo = '⚠️ Incidencia vencida - Contacta por teléfono para coordinar';
    }
    
    if (escalationInfo) {
        timerContent += '<div class="escalation-info">' + escalationInfo + '</div>';
    }

    // Botones telefónicos
    actionContent = '<div class="phone-buttons">';
    
    // Prioridad: Supervisor -> Encargado -> Reportador
    let hasPhoneContact = false;
    
    if (incident.supervisor_phone && incident.supervisor_phone !== 'Sin teléfono') {
        actionContent += '<a href="tel:' + incident.supervisor_phone + '" class="phone-btn supervisor">📞 Supervisor</a>';
        hasPhoneContact = true;
    }
    
    if (incident.manager_phone && incident.manager_phone !== 'Sin teléfono') {
        actionContent += '<a href="tel:' + incident.manager_phone + '" class="phone-btn">📞 Encargado</a>';
        hasPhoneContact = true;
    }
    
    if (!hasPhoneContact && incident.reporter_phone && incident.reporter_phone !== 'Sin teléfono') {
        actionContent += '<a href="tel:' + incident.reporter_phone + '" class="phone-btn">📞 Reportador</a>';
        hasPhoneContact = true;
    }
    
    if (!hasPhoneContact) {
        actionContent += '<div class="contact-info">⚠️ No hay teléfonos disponibles</div>';
    }
    
    // Información de contacto adicional
    if (incident.supervisor && incident.supervisor !== 'Sin supervisor') {
        actionContent += '<div class="contact-info">👤 Supervisor: ' + incident.supervisor + '</div>';
    }
    
    if (incident.reporter && incident.reporter !== 'Sin reportador') {
        actionContent += '<div class="contact-info">📋 Reportador: ' + incident.reporter + '</div>';
    }
    
    actionContent += '</div>';
}

// Información adicional para contexto
let additionalInfo = '';
if (incident.assigned_technician && incident.assigned_technician !== 'Sin asignar' && incident.assigned_technician !== '') {
    additionalInfo += '<div class="assigned-info">👤 Asignado a: ' + incident.assigned_technician + '</div>';
}

if (incident.closed_by && incident.closed_by !== 'No cerrada') {
    additionalInfo += '<div class="closed-info">✅ Cerrado por: ' + incident.closed_by + '</div>';
}

// Estado de la incidencia
let statusInfo = '';
if (incident.status && incident.status !== '🆕 Nueva') {
    statusInfo = '<div class="status-info">Estado: ' + incident.status + '</div>';
}

return '<div class="incident-item ' + type + '" data-incident-id="' + incident.id + '">' +
'<div class="incident-header">' +
'<div class="incident-id">' + incident.id + '</div>' +
'<div class="priority-badge priority-' + priorityClass + '">' + (incident.priority || 'MEDIA') + '</div>' +
'</div>' +
'<div class="incident-info">' +
'<div class="incident-equipment">' + (incident.equipment || 'Equipo no especificado') + '</div>' +
'<div class="incident-zone">📍 ' + (incident.zone || 'Sin zona') + '</div>' +
'<div class="incident-description">' + ((incident.description || '').substring(0, 150)) + (incident.description && incident.description.length > 150 ? '...' : '') + '</div>' +
statusInfo +
additionalInfo +
responseInfo +
'</div>' +
timerContent +
actionContent +
'</div>';
}

function renderSLATimer(incident, level) {
const slaEnd = getSlaEndTime(incident);
if (!slaEnd) return '';

return '<div class="sla-timer" data-sla-end="' + slaEnd + '">' +
'<div class="sla-time" id="timer-' + incident.incident_id + '">--:--</div>' +
'<div class="sla-label">Tiempo restante para responder</div>' +
'<div class="sla-level">NIVEL ' + level + '</div>' +
'</div>';
}

function startAllSLATimers() {
document.querySelectorAll('.sla-timer[data-sla-end]').forEach(timer => {
const slaEnd = timer.getAttribute('data-sla-end');
const incidentId = timer.getAttribute('data-sla-end').split('-').pop();
startSLATimer(slaEnd, 'timer-' + incidentId);
});
}

function startSLATimer(slaEndTime, timerId) {
function updateTimer() {
const now = new Date();
const end = new Date(slaEndTime);
const diff = end - now;

const timerElement = document.getElementById(timerId);
if (!timerElement) return;

if (diff <= 0) {
timerElement.textContent = '00:00';
timerElement.className = 'sla-time critical';
return;
}

const totalMinutes = Math.floor(diff / 60000);
const hours = Math.floor(totalMinutes / 60);
const minutes = totalMinutes % 60;
const seconds = Math.floor((diff % 60000) / 1000);

let timeText;
if (hours > 0) {
timeText = hours + ':' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
} else {
timeText = minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
}

timerElement.textContent = timeText;

// Calcular porcentaje de tiempo restante (asumiendo SLA inicial de 30 min para cálculo)
const totalSLATime = 30 * 60 * 1000; // 30 minutos en ms
const percentage = (diff / totalSLATime) * 100;

if (percentage > 50) {
timerElement.className = 'sla-time good';
} else if (percentage > 20) {
timerElement.className = 'sla-time warning';
} else {
timerElement.className = 'sla-time critical';
}
}

updateTimer();
setInterval(updateTimer, 1000);
}

// === MANEJO DE ACCIONES ===
function handleAction(action, incidentId) {
// Encontrar la incidencia
currentIncident = allIncidents.find(inc => inc.id === incidentId);
if (!currentIncident) {
console.error('Incidencia no encontrada:', incidentId);
return;
}

if (accessMode !== 'full_access') {
// Requiere PIN
pendingAction = action;
showPINModal('action');
return;
}

// Ya autenticado, proceder
if (action === 'acepto') {
confirmAction();
} else {
showReasonModal(action);
}
}

function renderSingleIncident(incident) {
// Para vista de incidencia específica desde email
currentIncident = incident;

const container = document.getElementById('incidentsContainer');
const level = getIncidentLevel(incident);
const slaEnd = getSlaEndTime(incident);
const canRespond = (accessMode === 'full_access');

let actionContent = '';
if (!incident.assigned_technician || incident.assigned_technician !== currentTechnician?.email) {
// Pendiente de respuesta
const acceptIcon = canRespond ? '✅' : '🔒';
const rejectIcon = canRespond ? '❌' : '🔒';
const helpIcon = canRespond ? '🆘' : '🔒';
const lockClass = canRespond ? '' : ' locked';

actionContent = '<div class="action-buttons">' +
'<button class="action-btn btn-accept' + lockClass + '" onclick="handleAction(\'acepto\', \'' + incident.incident_id + '\')">' +
acceptIcon + ' Acepto</button>' +
'<button class="action-btn btn-reject' + lockClass + '" onclick="handleAction(\'rechazo\', \'' + incident.incident_id + '\')">' +
rejectIcon + ' Rechazo</button>' +
'<button class="action-btn btn-help' + lockClass + '" onclick="handleAction(\'ayuda\', \'' + incident.incident_id + '\')">' +
helpIcon + ' Solicitar Ayuda</button>' +
'</div>';
} else {
// Ya trabajando
const helpIcon = canRespond ? '🆘' : '🔒';
const lockClass = canRespond ? '' : ' locked';
actionContent = '<div class="action-buttons">' +
'<button class="action-btn btn-help' + lockClass + '" onclick="handleAction(\'ayuda\', \'' + incident.incident_id + '\')">' +
helpIcon + ' Solicitar Ayuda</button>' +
'</div>';
}

const priorityClass = getPriorityClass(incident.priority);

container.innerHTML = '<div class="incidents-container">' +
'<div class="section-header">' +
'<div class="section-title">📋 ' + incident.incident_id + '</div>' +
'</div>' +
'<div class="section-content">' +
'<div class="incident-item">' +
'<div class="incident-header">' +
'<div class="incident-id">' + incident.incident_id + '</div>' +
'<div class="priority-badge priority-' + priorityClass + '">' + (incident.priority || 'MEDIA') + '</div>' +
'</div>' +
'<div class="incident-info">' +
'<div class="incident-equipment">' + (incident.equipment || 'Equipo no especificado') + '</div>' +
'<div class="incident-zone">📍 ' + (incident.zone || 'Sin zona') + '</div>' +
'<div class="incident-description">' + (incident.description || 'Sin descripción disponible') + '</div>' +
'</div>' +
(slaEnd ? renderSLATimer(incident, level) : '') +
actionContent +
'</div>' +
'</div>' +
'</div>';

// Iniciar timer si hay SLA
if (slaEnd) {
startSLATimer(slaEnd, 'timer-' + incident.incident_id);
}
}

// === MODAL DE MOTIVOS ===
function showReasonModal(action) {
pendingAction = action;
selectedReason = null;

const modal = document.getElementById('reasonModal');
const title = document.getElementById('modalTitle');
const options = document.getElementById('reasonOptions');
const confirmBtn = document.getElementById('confirmBtn');

// Configurar título y motivos según la acción
let reasons = [];
switch(action) {
case 'rechazo':
title.textContent = '❌ Motivo del Rechazo';
reasons = rejectReasons;
confirmBtn.textContent = 'Rechazar';
break;

case 'ayuda':
title.textContent = '🆘 Tipo de Ayuda Requerida';
reasons = helpReasons;
confirmBtn.textContent = 'Solicitar Ayuda';
break;
}

// Renderizar opciones de motivos
options.innerHTML = reasons.map(reason => 
'<div class="reason-option" onclick="selectReason(\'' + reason.id + '\')">' +
'<div class="reason-icon">' + reason.icon + '</div>' +
'<div class="reason-text">' +
'<div class="reason-title">' + reason.title + '</div>' +
'<div class="reason-description">' + reason.description + '</div>' +
'</div>' +
'</div>'
).join('');

confirmBtn.disabled = true;
modal.classList.add('active');
}

function selectReason(reasonId) {
selectedReason = reasonId;

// Actualizar UI
document.querySelectorAll('.reason-option').forEach(option => {
option.classList.remove('selected');
});

event.currentTarget.classList.add('selected');
document.getElementById('confirmBtn').disabled = false;
}

function closeReasonModal() {
document.getElementById('reasonModal').classList.remove('active');
pendingAction = null;
selectedReason = null;
}

// === CONFIRMAR ACCIÓN ===
async function confirmAction() {
if (!pendingAction || !currentIncident) return;

const confirmBtn = document.getElementById('confirmBtn');
const originalText = confirmBtn?.textContent || 'Confirmar';

try {
if (confirmBtn) {
confirmBtn.disabled = true;
confirmBtn.textContent = '🔄 Procesando...';
}

const response = await fetch('/api/webhook-respuesta', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
action: pendingAction,
incident_id: currentIncident.id,
technician_email: currentTechnician.email,
technician_name: currentTechnician.name,
reason: selectedReason,
escalation_level: getCurrentEscalationLevel()
})
});

const data = await response.json();
console.log('✅ Respuesta enviada:', data);

if (data.status === 'success') {
closeReasonModal();
showSuccessAndReload(data);
} else {
throw new Error(data.message || 'Error procesando respuesta');
}

} catch (error) {
console.error('Error enviando respuesta:', error);
showError('Error de conexión. Inténtalo más tarde.');
} finally {
if (confirmBtn) {
confirmBtn.disabled = false;
confirmBtn.textContent = originalText;
}
}
}

function showSuccessAndReload(data) {
const messages = {
'acepto': '✅ Incidencia aceptada correctamente. ¡Puedes empezar a trabajar!',
'rechazo': '❌ Incidencia rechazada. Se escalará automáticamente.',
'ayuda': '🆘 Ayuda solicitada. Un supervisor se pondrá en contacto contigo.'
};

const actionIcon = pendingAction === 'acepto' ? '✅' : pendingAction === 'rechazo' ? '❌' : '🆘';

// Mostrar mensaje de éxito y recargar después de 2 segundos
document.getElementById('incidentsContainer').innerHTML = 
'<div class="incidents-container">' +
'<div class="section-header" style="background: linear-gradient(45deg, #38a169, #48bb78); color: white;">' +
'<div class="section-title">✅ Acción Completada</div>' +
'</div>' +
'<div class="section-content">' +
'<div style="text-align: center; padding: 40px;">' +
'<div style="font-size: 48px; margin-bottom: 20px;">' + actionIcon + '</div>' +
'<h3 style="color: #2c3e50; margin-bottom: 15px;">' + messages[pendingAction] + '</h3>' +
'<p style="color: #7f8c8d; margin-bottom: 25px;">' + (data.next_step || 'La acción se ha procesado correctamente.') + '</p>' +
'<button class="action-btn btn-accept" onclick="refreshIncidents()" style="max-width: 200px; margin: 0 auto;">🔄 Actualizar Dashboard</button>' +
'</div>' +
'</div>' +
'</div>';

// Auto-refresh después de 3 segundos
setTimeout(() => {
refreshIncidents();
}, 3000);
}

// === FUNCIONES AUXILIARES ===
function getCurrentEscalationLevel() {
if (!currentIncident) return 0;

if (currentIncident.l0_technician === currentTechnician?.email) return 0;
if (currentIncident.l1_technician === currentTechnician?.email) return 1;
if (currentIncident.l2_technicians_notified?.includes?.(currentTechnician?.email)) return 2;

return 0;
}

function getIncidentLevel(incident) {
if (incident.l0_technician === currentTechnician?.email) return 'L0';
if (incident.l1_technician === currentTechnician?.email) return 'L1';
if (incident.l2_technicians_notified?.includes?.(currentTechnician?.email)) return 'L2';
return 'L0';
}

function getSlaEndTime(incident) {
if (incident.l0_technician === currentTechnician?.email) {
return incident.sla_l0_end;
}
if (incident.l1_technician === currentTechnician?.email) {
return incident.sla_l1_backup_end;
}
if (incident.l2_technicians_notified?.includes?.(currentTechnician?.email)) {
return incident.sla_l2_equipo_end;
}
return incident.sla_l0_end; // Fallback
}

function getPriorityClass(priority) {
if (!priority) return 'media';
const p = priority.toLowerCase();
if (p.includes('crítica') || p.includes('critical')) return 'critica';
if (p.includes('alta') || p.includes('high')) return 'alta';
if (p.includes('media') || p.includes('medium')) return 'media';
if (p.includes('baja') || p.includes('low')) return 'baja';
return 'media';
}

function getExpiredTime(slaEnd) {
if (!slaEnd) return 'Tiempo indefinido';

const now = new Date();
const end = new Date(slaEnd);
const diff = now - end; // Diferencia positiva = vencido

if (diff <= 0) return 'No vencida';

const minutes = Math.floor(diff / 60000);
const hours = Math.floor(minutes / 60);

if (hours > 0) {
return 'Hace ' + hours + 'h ' + (minutes % 60) + 'm';
} else {
return 'Hace ' + minutes + 'm';
}
}

function getEscalationInfo(incident, currentLevel) {
const escalationLevel = parseInt(incident.escalation_level) || 0;

if (escalationLevel > getCurrentEscalationLevel()) {
return '⚠️ Esta incidencia ha escalado a L' + escalationLevel + ' - Ya no requiere tu respuesta';
}

return '⚠️ Incidencia vencida en ' + currentLevel + ' - Contacta por teléfono para coordinar';
}

function showLoading(message = 'Cargando...') {
document.getElementById('incidentsContainer').innerHTML = 
'<div class="incidents-container">' +
'<div class="section-content">' +
'<div class="loading">' +
'<div class="spinner"></div>' +
'<div>' + message + '</div>' +
'</div>' +
'</div>' +
'</div>';
}

function hideLoading() {
// Se oculta cuando se renderiza contenido
}

function showError(message, element) {
if (element) {
element.textContent = message;
element.style.display = 'block';
} else {
console.error('Error:', message);
}
}

function hideMessage(element) {
if (element) {
element.style.display = 'none';
}
}

// === EVENTOS DE TECLADO ===
document.addEventListener('keydown', function(e) {
if (e.key === 'Enter' && document.getElementById('loginContainer').style.display !== 'none') {
const emailInput = document.getElementById('emailInput');
if (emailInput.value.trim()) {
loginQuickAccess();
}
}

if (e.key === 'Escape') {
closeReasonModal();
closePINModal();
}
});

// Cerrar modales al hacer click fuera
document.getElementById('reasonModal').addEventListener('click', function(e) {
if (e.target === this) {
closeReasonModal();
}
});

document.getElementById('pinModal').addEventListener('click', function(e) {
if (e.target === this) {
closePINModal();
}
});

// === CLEANUP AL CERRAR ===
window.addEventListener('beforeunload', function() {
if (refreshInterval) {
clearInterval(refreshInterval);
}
if (slaInterval) {
clearInterval(slaInterval);
}
});
</script>
</body>
</html>
