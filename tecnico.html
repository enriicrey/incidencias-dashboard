 <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard T√©cnico - Sistema de Incidencias ABC.xyz</title>
    
    <style>
        /* ==========================================
           üßπ CSS LIMPIO Y ORGANIZADO - SIN DUPLICADOS
           ========================================== */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* ==========================================
           üîí LOGIN SCREEN
           ========================================== */
        
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .verify-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .verify-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .verify-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .error-message {
            background: #fee;
            color: #c0392b;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
        }

        /* ==========================================
           üì± HEADER PRINCIPAL
           ========================================== */
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .refresh-button {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .refresh-button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.25);
        }

        .refresh-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ==========================================
           üìä MAIN CONTAINER
           ========================================== */
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
            background: #f8fafc;
            min-height: calc(100vh - 80px);
        }

        /* ==========================================
           üìà STATS BAR (FILTROS CLICABLES)
           ========================================== */
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .stat-card.active {
            border-color: #3498db;
            background: linear-gradient(135deg, #e3f2fd, #ffffff);
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-number.pending { color: #f39c12; }
        .stat-number.working { color: #27ae60; }
        .stat-number.expired { color: #e74c3c; }

        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
            font-weight: 500;
        }

        /* ==========================================
           üéõÔ∏è FILTERS BAR
           ========================================== */
        
        .filters-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            background: white;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active, .filter-btn:hover {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        /* ==========================================
           üìã LAYOUT 2 COLUMNAS - GRID PRINCIPAL
           ========================================== */
        
        .incidents-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)) !important;
            gap: 25px !important;
            padding: 0 !important;
            width: 100% !important;
        }

        /* ==========================================
           üé¥ INCIDENT CARDS - DISE√ëO LIMPIO
           ========================================== */
        
        .incident-card {
            background: white !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 16px !important;
            padding: 25px !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05) !important;
            transition: all 0.3s ease !important;
            position: relative;
            overflow: hidden;
            break-inside: avoid;
            min-width: 450px;
            width: 100%;
        }

        .incident-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1) !important;
            transform: translateY(-3px) !important;
            border-color: #3498db !important;
        }

        .incident-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f3f4f6;
        }

        .incident-title h4 {
            margin: 0 0 10px 0;
            color: #1f2937;
            font-size: 1.2rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .priority-badge {
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .incident-id {
            font-size: 13px;
            color: #6b7280;
            background: #f9fafb;
            padding: 6px 10px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .incident-body {
            margin-bottom: 20px;
        }

        .zone {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #374151;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            background: #f3f4f6;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .description {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 15px;
            background: #fafbfc;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #e5e7eb;
        }

        /* ==========================================
           ‚è±Ô∏è SLA TIMERS - DISE√ëO MEJORADO
           ========================================== */
        
        .sla-info {
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sla-timer.sla-good {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border: 1px solid #10b981;
        }

        .sla-timer.sla-warning {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .sla-timer.sla-critical {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #991b1b;
            border: 1px solid #ef4444;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .sla-expired {
            background: linear-gradient(135deg, #fef2f2, #fee2e2) !important;
            color: #991b1b !important;
            padding: 12px 16px !important;
            border-radius: 10px !important;
            font-weight: 700 !important;
            border: 2px solid #ef4444 !important;
            animation: pulse 2s infinite;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ==========================================
           üìû INFORMACI√ìN ADICIONAL - T√âCNICOS Y CONTACTOS
           ========================================== */
        
        .technician-info {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 12px 16px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 14px;
            border-left: 4px solid #0ea5e9;
        }

        .technician-info.current-tech {
            background: linear-gradient(135deg, #ecfdf5, #d1fae5) !important;
            border-left-color: #10b981 !important;
            color: #065f46 !important;
            font-weight: 600 !important;
        }

        .contacts-info {
            background: linear-gradient(135deg, #fefce8, #fef3c7);
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid #eab308;
        }

        .contacts-header {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contacts-header:hover {
            color: #78350f;
        }

        .contacts-list {
            margin-top: 10px;
        }

        .contacts-list div {
            margin: 6px 0;
            font-size: 13px;
            color: #713f12;
        }

        .contacts-list a {
            color: #2563eb;
            text-decoration: none;
            font-weight: 600;
        }

        .contacts-list a:hover {
            text-decoration: underline;
        }

        .time-elapsed {
            background: linear-gradient(135deg, #fdf4ff, #fae8ff);
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 8px;
            color: #7c2d92;
            font-size: 14px;
            border-left: 4px solid #a855f7;
        }

        .actions-taken {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            color: #166534;
            font-size: 14px;
            line-height: 1.4;
            border-left: 4px solid #22c55e;
        }

        /* ==========================================
           üìä HISTORIAL DE ESCALADO
           ========================================== */

        .escalation-history {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            margin: 15px 0;
            overflow: hidden;
        }

        .escalation-header {
            background: #e2e8f0;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #475569;
            transition: background 0.3s ease;
        }

        .escalation-header:hover {
            background: #cbd5e1;
        }

        .escalation-content {
            display: none;
            padding: 15px;
        }

        .escalation-level {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }

        .escalation-level.completed {
            background: #f0f9ff;
            border-left: 4px solid #10b981;
        }

        .escalation-level.current {
            background: #fff7ed;
            border-left: 4px solid #f59e0b;
        }

        .escalation-level.pending {
            background: #f8fafc;
            border-left: 4px solid #94a3b8;
        }

        .escalation-level.expired {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
        }

        .escalation-level.escalated {
            background: #f3f4f6;
            border-left: 4px solid #6b7280;
        }

        .level-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .level-details {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.4;
        }

        /* ==========================================
           üéØ BOTONES DE ACCI√ìN
           ========================================== */
        
        .incident-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f3f4f6;
        }

        .incident-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .incident-actions .btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(34, 197, 94, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(245, 158, 11, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(59, 130, 246, 0.3);
        }

        .no-action-info {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 8px;
            color: #64748b;
            font-style: italic;
            border: 1px solid #e2e8f0;
        }

        /* ==========================================
           üì± NO INCIDENTS MESSAGE
           ========================================== */
        
        .no-incidents {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .no-incidents-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .no-incidents h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #374151;
        }

        .no-incidents p {
            font-size: 16px;
            color: #6b7280;
        }

        /* ==========================================
           üîí MODALES COMPLETOS DEL SISTEMA
           ========================================== */

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content, .pin-modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.8);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal-content,
        .modal-overlay.active .pin-modal {
            transform: scale(1);
        }

        .modal-title, .pin-modal-title {
            font-size: 20px;
            color: #1f2937;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
        }

        .reason-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }

        .reason-option {
            padding: 15px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .reason-option:hover {
            border-color: #374151;
            background: #f9fafb;
        }

        .reason-option.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .reason-icon { 
            font-size: 24px; 
            min-width: 30px; 
        }

        .reason-text { 
            flex: 1; 
        }

        .reason-title { 
            font-weight: 600; 
            color: #1f2937; 
            margin-bottom: 3px; 
        }

        .reason-description { 
            font-size: 13px; 
            color: #6b7280; 
        }

        .custom-reason-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            margin-top: 10px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .custom-reason-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .modal-actions, .pin-actions {
            display: flex;
            gap: 15px;
        }

        .modal-btn, .pin-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-cancel, .pin-btn-cancel {
            background: #f9fafb;
            color: #6b7280;
            border: 1px solid #d1d5db;
        }

        .btn-confirm, .pin-btn-verify {
            background: #374151;
            color: white;
        }

        .btn-confirm:disabled, .pin-btn-verify:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .pin-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 18px;
            text-align: center;
            letter-spacing: 8px;
            margin-bottom: 20px;
        }

        .pin-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        /* ==========================================
           üéâ SUCCESS OVERLAY
           ========================================== */

        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .success-message {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .success-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .success-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .success-description {
            color: #6b7280;
            margin-bottom: 20px;
        }

        .countdown {
            font-size: 14px;
            color: #9ca3af;
        }

        /* ==========================================
           üé® BADGES Y ESTADOS ADICIONALES
           ========================================== */
        
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }

        .bg-success { background: #22c55e; color: white; }
        .bg-warning { background: #f59e0b; color: white; }
        .bg-danger { background: #ef4444; color: white; }
        .bg-info { background: #3b82f6; color: white; }
        .bg-secondary { background: #6b7280; color: white; }
        .bg-light { background: #f3f4f6; color: #374151; }
        
        /* Estilos para las secciones colapsables */
        .toggle-icon {
            font-size: 14px;
            transition: transform 0.3s ease;
        }
        
        .escalation-header:hover .toggle-icon,
        .contacts-header:hover .toggle-icon {
            transform: scale(1.2);
        }

        /* ==========================================
           üì± RESPONSIVE DESIGN
           ========================================== */
        
        @media (max-width: 1200px) {
            .incidents-grid {
                grid-template-columns: 1fr !important;
            }
            
            .incident-card {
                min-width: auto;
                max-width: none;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 15px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .filters-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .incidents-grid {
                gap: 20px !important;
                padding: 10px !important;
            }
            
            .incident-card {
                padding: 20px !important;
            }
            
            .incident-actions {
                flex-direction: column;
            }
            
            .incident-actions .btn {
                min-width: auto;
            }
        }
              .sla-badge {
             padding: 4px 8px;
             border-radius: 12px;
             font-size: 11px;
             font-weight: 600;
             margin-left: 5px;
         }
         
         .sla-badge.sla-good {
             background: #22c55e;
             color: white;
         }
         
         .sla-badge.sla-warning {
             background: #f59e0b;
             color: white;
         }
         
         .sla-badge.sla-critical {
             background: #ef4444;
             color: white;
             animation: pulse 1s infinite;
         }

    </style>
</head>
<body>
    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <h1 class="login-title">
                <span>üîß</span>
                <span>Dashboard T√©cnico</span>
            </h1>
            <p class="login-subtitle">Accede con tu email para gestionar incidencias</p>
            <div class="input-group">
                <label class="input-label" for="emailInput">Email T√©cnico</label>
                <input type="email" class="input-field" id="emailInput" placeholder="ejemplo@empresa.com" autocomplete="email">
            </div>
            <button onclick="loginWithPIN()" class="verify-btn" id="loginBtn">
                üîí Acceder con PIN
            </button>
            <div id="loginError" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <!-- Header Principal -->
    <div class="header" id="mainHeader" style="display: none;">
        <div class="header-content">
            <div class="logo">
                <span>üîß</span>
                <span class="logo-text">ABC.xyz</span>
                <span id="dashboardTitle">Dashboard T√©cnico</span>
            </div>
            <div class="user-info">
                <div class="auth-status" id="authStatus">
                    <span id="authMessage">‚ö†Ô∏è Cargando...</span>
                </div>
                <button id="refreshBtn" class="refresh-button" onclick="refreshIncidents()">
                    üîÑ Actualizar
                </button>
                <p id="lastUpdate" class="last-update">--:--</p>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container" id="mainContainer" style="display: none;">
        <!-- Stats Bar (Clickeable como filtros) -->
        <div class="stats-bar">
            <div class="stat-card active" onclick="filterByStatus('all', this)">
                <div class="stat-number" id="totalCount" style="color: #6b7280;">0</div>
                <div class="stat-label">Todas</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('pending', this)">
                <div class="stat-number pending" id="pendingCount">0</div>
                <div class="stat-label">Pendientes</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('working', this)">
                <div class="stat-number working" id="workingCount">0</div>
                <div class="stat-label">Trabajando</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('expired', this)">
                <div class="stat-number expired" id="expiredCount">0</div>
                <div class="stat-label">Vencidas</div>
            </div>
           <div class="stat-card" onclick="filterByStatus('seguimiento', this)">
               <div class="stat-number" id="seguimientoCount" style="color: #8b5cf6;">0</div>
               <div class="stat-label">Seguimiento</div>
          </div>
        </div>

        <!-- Filters Bar - Solo Prioridad -->
        <div class="filters-bar">
            <div class="filter-group">
                <span class="filter-label">Prioridad:</span>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByPriority('all', this)">Todas</button>
                    <button class="filter-btn" onclick="filterByPriority('CR√çTICA', this)">üî¥ Cr√≠tica</button>
                    <button class="filter-btn" onclick="filterByPriority('ALTA', this)">üü† Alta</button>
                    <button class="filter-btn" onclick="filterByPriority('MEDIA', this)">üü° Media</button>
                    <button class="filter-btn" onclick="filterByPriority('BAJA', this)">üü¢ Baja</button>
                </div>
            </div>
        </div>

        <!-- Incidents Container -->
        <div id="incidentsContainer">
            <!-- Las incidencias se renderizan aqu√≠ -->
        </div>
    </div>

    <!-- PIN Modal -->
    <div class="modal-overlay" id="pinModal">
        <div class="pin-modal">
            <h3 class="pin-modal-title">üîí Verificaci√≥n de Seguridad</h3>
            <p style="text-align: center; color: #6b7280; margin-bottom: 25px;">Introduce tu PIN de 4 d√≠gitos</p>
            <input type="password" class="pin-input" id="pinInput" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
            <div class="pin-actions">
                <button class="pin-btn pin-btn-cancel" onclick="closePINModal()">Cancelar</button>
                <button class="pin-btn pin-btn-verify" id="verifyPinBtn" onclick="verifyPIN()" disabled>Verificar</button>
            </div>
            <div id="pinError" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <!-- Reason Modal -->
    <div class="modal-overlay" id="reasonModal">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">Selecciona el motivo</h3>
            <div class="reason-options" id="reasonOptions"></div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeReasonModal()">Cancelar</button>
                <button class="modal-btn btn-confirm" id="confirmBtn" onclick="confirmAction()" disabled>Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Success Overlay -->
    <div class="success-overlay" id="successOverlay" style="display: none;">
        <div class="success-message">
            <div class="success-icon" id="successIcon">‚úÖ</div>
            <div class="success-title" id="successTitle">Acci√≥n Completada</div>
            <div class="success-description" id="successDescription">La acci√≥n se ha procesado correctamente</div>
            <div class="countdown" id="countdown">Actualizando en 3 segundos...</div>
        </div>
    </div>

    <script>
        // ==========================================
        // üîß VARIABLES GLOBALES
        // ==========================================
        
        let allIncidents = [];
        let currentTechnician = null;
        let currentStatusFilter = 'all';
        let currentPriorityFilter = 'all';
        let refreshInterval = null;
        let slaTimerInterval = null;
        let pendingAction = null;
        let selectedReason = null;
        let customText = '';
        let currentIncident = null;
        let accessMode = 'read_only'; // 'read_only' o 'full_access'

        // ‚úÖ CORRECCI√ìN: Usar TUS APIs de Vercel, no URLs directas a Make
        const API_BASE_URL = '/api/webhook-respuesta';
        const API_RESPONSE = '/api/webhook-respuesta';

        // ==========================================
        // üéØ MOTIVOS DETALLADOS COMO EN TECNICO(12)
        // ==========================================

        // Motivos de RECHAZO
        const rejectReasons = [
            {
                id: 'ocupado_otra',
                icon: '‚ö†Ô∏è',
                title: 'Ocupado con otra incidencia',
                description: 'Actualmente atendiendo otra incidencia prioritaria'
            },
            {
                id: 'fuera_especialidad',
                icon: 'üîß',
                title: 'Fuera de mi especialidad',
                description: 'Requiere conocimientos espec√≠ficos que no poseo'
            },
            {
                id: 'no_disponible',
                icon: 'üö´',
                title: 'No disponible ahora',
                description: 'Fuera de horario o en descanso programado'
            },
            {
                id: 'falta_herramientas',
                icon: 'üõ†Ô∏è',
                title: 'Faltan herramientas/repuestos',
                description: 'No dispongo del equipamiento necesario'
            },
            {
                id: 'ubicacion_lejos',
                icon: 'üìç',
                title: 'Muy lejos de mi ubicaci√≥n',
                description: 'Distancia excesiva desde mi posici√≥n actual'
            },
            {
                id: 'sobrecarga_trabajo',
                icon: 'üìä',
                title: 'Sobrecarga de trabajo',
                description: 'Carga actual impide atender correctamente'
            }
        ];

        // Motivos de AYUDA INICIAL
        const helpReasonsInitial = [
            {
                id: 'apoyo_tecnico',
                icon: 'üë®‚Äçüîß',
                title: 'Necesito apoyo t√©cnico',
                description: 'Requiero asistencia de otro t√©cnico'
            },
            {
                id: 'consulta_supervisor',
                icon: 'üë®‚Äçüíº',
                title: 'Consulta con supervisor',
                description: 'Necesito autorizaci√≥n o consulta supervisorial'
            },
            {
                id: 'herramientas_especiales',
                icon: 'üî®',
                title: 'Herramientas especiales',
                description: 'Requiero equipamiento especializado'
            },
            {
                id: 'procedimiento_dudas',
                icon: '‚ùì',
                title: 'Dudas sobre procedimiento',
                description: 'Incertidumbre sobre el m√©todo a seguir'
            },
            {
                id: 'seguridad_riesgo',
                icon: '‚ö†Ô∏è',
                title: 'Problema de seguridad',
                description: 'Situaci√≥n de riesgo que requiere supervisi√≥n'
            },
            {
                id: 'repuestos_urgentes',
                icon: 'üì¶',
                title: 'Repuestos urgentes',
                description: 'Necesito componentes no disponibles localmente'
            }
        ];

        // Motivos de TRANSFERIR (estado trabajando)
        const transferReasons = [
            {
                id: 'fin_turno',
                icon: 'üïê',
                title: 'Fin de turno',
                description: 'Mi turno est√° finalizando, transferir a relevo'
            },
            {
                id: 'requiere_especialista',
                icon: 'üë®‚Äçüîß',
                title: 'Requiere especialista',
                description: 'Tras evaluaci√≥n, necesita t√©cnico con especializaci√≥n espec√≠fica'
            },
            {
                id: 'imposible_completar',
                icon: '‚õî',
                title: 'No puedo completar',
                description: 'Por circunstancias surgidas, no puedo finalizar la reparaci√≥n'
            },
            {
                id: 'otro_motivo_transferir',
                icon: '‚úèÔ∏è',
                title: 'Otro motivo',
                description: 'Especificar raz√≥n de transferencia',
                requiresText: true
            }
        ];

        // Motivos de SOLICITAR APOYO EN TRABAJO
        const supportReasonsWorking = [
            {
                id: 'recursos_adicionales',
                icon: 'üì¶',
                title: 'Recursos adicionales',
                description: 'Necesito herramientas, repuestos o equipamiento adicional'
            },
            {
                id: 'segundo_tecnico',
                icon: 'üë•',
                title: 'Segundo t√©cnico',
                description: 'Requiero apoyo de otro t√©cnico para completar la intervenci√≥n'
            },
            {
                id: 'autorizacion_procedimiento',
                icon: '‚úÖ',
                title: 'Autorizaci√≥n para proceder',
                description: 'Necesito autorizaci√≥n supervisor para el procedimiento a seguir'
            },
            {
                id: 'supervision_especializada',
                icon: 'üë®‚Äçüíº',
                title: 'Supervisi√≥n especializada',
                description: 'Requiero supervisi√≥n directa para intervenci√≥n cr√≠tica'
            },
            {
                id: 'otro_apoyo_trabajo',
                icon: '‚úèÔ∏è',
                title: 'Otro apoyo',
                description: 'Especificar tipo de apoyo requerido',
                requiresText: true
            }
        ];

        // ==========================================
        // üîí SISTEMA DE AUTENTICACI√ìN CON MODAL PIN
        // ==========================================
        
        async function loginWithPIN() {
            const email = document.getElementById('emailInput').value.trim();
            if (!email || !email.includes('@')) {
                showError('Email v√°lido requerido', document.getElementById('loginError'));
                return;
            }
            showPINModal();
        }

        function showPINModal() {
            const modal = document.getElementById('pinModal');
            const pinInput = document.getElementById('pinInput');
            const verifyBtn = document.getElementById('verifyPinBtn');
            
            pinInput.value = '';
            verifyBtn.disabled = true;
            modal.classList.add('active');
            pinInput.focus();
            
            pinInput.oninput = () => verifyBtn.disabled = pinInput.value.length !== 4;
            pinInput.onkeypress = (e) => {
                if (e.key === 'Enter' && pinInput.value.length === 4) verifyPIN();
            };
        }

        function closePINModal() {
            document.getElementById('pinModal').classList.remove('active');
            pendingAction = null;
        }

        async function verifyPIN() {
            const pin = document.getElementById('pinInput').value;
            const email = document.getElementById('emailInput').value;
            const verifyBtn = document.getElementById('verifyPinBtn');

            if (pin.length !== 4) {
                showError('PIN de 4 d√≠gitos requerido', document.getElementById('pinError'));
                return;
            }

            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Verificando...';

            try {
                // ‚úÖ CORRECCI√ìN: Usar tu API de Vercel
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'validate_technician_pin',
                        technician_email: email,
                        pin: pin
                    })
                });

                const data = await response.json();
                console.log('üîí PIN Response:', data);

                if (data.status === 'success') {
                    currentTechnician = {
                        email: email,
                        name: data.technician?.name || email.split('@')[0],
                        department: data.technician?.department || 'Sin departamento',
                        level: data.technician?.level || 1,
                        hasFullAccess: Boolean(data.technician?.hasFullAccess)
                    };

                    accessMode = data.technician?.hasFullAccess ? 'full_access' : 'read_only';
                    closePINModal();

                    // Si hab√≠a acci√≥n pendiente, ejecutar
                    if (pendingAction) {
                        executeAction();
                        return;
                    }

                    await loadDashboard();
                    
                    // Mostrar interfaz principal
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('mainHeader').style.display = 'block';
                    document.getElementById('mainContainer').style.display = 'block';
                    // AUTO-REFRESH ELIMINADO - Solo actualizaci√≥n manual
                } else {
                    showError(data.message || 'PIN incorrecto', document.getElementById('pinError'));
                }
            } catch (error) {
                console.error('Error verificando PIN:', error);
                showError('Error de conexi√≥n', document.getElementById('pinError'));
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verificar';
            }
        }

        function showError(message, element) {
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => element.style.display = 'none', 5000);
        }

        // ==========================================
        // üìä CARGA DE DATOS CORREGIDA
        // ==========================================

        async function loadDashboard() {
            try {
                console.log('üîÑ Cargando dashboard...');
                
                if (!currentTechnician?.email) {
                    throw new Error('No hay t√©cnico autenticado');
                }
                
                // ‚úÖ CORRECCI√ìN: Usar tu API de Vercel
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'get_assigned_incidents',
                        technician_email: currentTechnician.email
                    })
                });

                let data = null;
                try {
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                        data = await response.json();
                    } else {
                        console.warn('Respuesta no JSON en loadDashboard, usando datos vac√≠os');
                        data = { status: 'error', incidents: [] };
                    }
                } catch (parseError) {
                    console.error('Error parsing JSON en loadDashboard:', parseError);
                    data = { status: 'error', incidents: [] };
                }

                if (response.ok && data && data.status === 'success') {
                    allIncidents = adaptIncidentData(data);
                    renderIncidents();
                    updateStats();
                    
                    const hasFullAccess = currentTechnician?.hasFullAccess || false;
                    const technicianName = currentTechnician?.name || 'T√©cnico';
                    
                    // Actualizar informaci√≥n del header
                    document.getElementById('dashboardTitle').textContent = `Dashboard - ${technicianName}`;
                    document.getElementById('authMessage').textContent = hasFullAccess ? 
                        '‚úÖ Acceso completo' : 'üëÅÔ∏è Solo lectura';
                    document.getElementById('authMessage').style.color = hasFullAccess ? '#059669' : '#d97706';
                    
                    updateLastUpdateTime();
                } else {
                    console.error('Error en datos:', data?.message || 'Respuesta inv√°lida');
                    allIncidents = [];
                    renderIncidents();
                    updateStats();
                }
                
            } catch (error) {
                console.error('Error cargando dashboard:', error);
                allIncidents = [];
                renderIncidents();
                updateStats();
                
                // Mostrar mensaje de error en UI
                const container = document.getElementById('incidentsContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="no-incidents">
                            <div class="no-incidents-icon">‚ö†Ô∏è</div>
                            <h3>Error de conexi√≥n</h3>
                            <p>No se pudieron cargar las incidencias. Verifica tu conexi√≥n.</p>
                            <button onclick="loadDashboard()" style="margin-top: 15px; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                üîÑ Reintentar
                            </button>
                        </div>
                    `;
                }
            }
        }

        async function refreshIncidents() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'üîÑ Actualizando...';
            
            await loadDashboard();
            
            refreshBtn.disabled = false;
            refreshBtn.textContent = 'üîÑ Actualizar';
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('lastUpdate').textContent = timeString;
        }

        // ==========================================
        // üîß FUNCI√ìN ADAPTADOR DE DATOS MEJORADA
        // ==========================================

        function adaptIncidentData(data) {
            let incidents = [];
            
            try {
                if (data && data.incidents && Array.isArray(data.incidents)) {
                    incidents = data.incidents;
                } else if (data && data.data && Array.isArray(data.data)) {
                    incidents = data.data;
                } else if (Array.isArray(data)) {
                    incidents = data;
                } else {
                    console.warn('Formato de datos no reconocido:', data);
                    return [];
                }
                
                return incidents.map(incident => {
                    if (!incident || typeof incident !== 'object') {
                        console.warn('Incidencia inv√°lida:', incident);
                        return null;
                    }
                    
                    return {
                        id: incident.id || incident.incident_id || `INC-${Date.now()}`,
                        equipment: incident.equipment || incident.component || incident.equipo_afectado || 'Equipo no especificado',
                        component: incident.component || incident.equipment || '',
                        zone: incident.zone || incident.zona || 'Sin zona',
                        description: incident.description || incident.descripcion || 'Sin descripci√≥n',
                        priority: incident.priority || incident.prioridad || 'MEDIA',
                        escalation_level: parseInt(incident.escalation_level || incident.nivel_escalado || 0),
                        escalation_paused: String(incident.escalation_paused || incident.escalado_pausado || 'false'),
                        
                        // T√©cnicos
                        l0_technician: incident.l0_technician || incident.tecnico_l0 || '',
                        l1_technician: incident.l1_technician || incident.tecnico_l1_backup || '',
                        l2_technicians: incident.l2_technicians || incident.tecnicos_l2_equipo || '',
                        l3_supervisor: incident.l3_supervisor || incident.l3_responsable || '',
                        
                        // Respuestas
                        l0_response: incident.l0_response || incident.respuesta_tecnico_l0 || '',
                        l1_response: incident.l1_response || incident.respuesta_tecnico_l1 || '',
                        l2_response: incident.l2_response || incident.respuesta_tecnico_l2 || '',
                        l3_response: incident.l3_response || incident.respuesta_supervisor_l3 || '',
                        
                        // SLA
                        sla_l0_end: validateDate(incident.sla_l0_end || incident.sla_l0),
                        sla_l1_backup_end: validateDate(incident.sla_l1_backup_end || incident.sla_l1_backup),
                        sla_l2_equipo_end: validateDate(incident.sla_l2_equipo_end || incident.sla_l2_equipo),
                        sla_l3_responsable_end: validateDate(incident.sla_l3_responsable_end || incident.sla_l3_responsable),
                        
                        // Fechas
                        l0_acceptance_date: validateDate(incident.l0_acceptance_date || incident.fecha_aceptacion_l0),
                        l0_rejection_date: validateDate(incident.l0_rejection_date || incident.fecha_rechazo_l0),
                        l1_acceptance_date: validateDate(incident.l1_acceptance_date || incident.fecha_aceptacion_l1),
                        l1_rejection_date: validateDate(incident.l1_rejection_date || incident.fecha_rechazo_l1),
                        l2_acceptance_date: validateDate(incident.l2_acceptance_date || incident.fecha_aceptacion_l2),
                        
                        // Motivos
                        l0_rejection_reason: incident.l0_rejection_reason || incident.motivo_rechazo_l0 || '',
                        l1_rejection_reason: incident.l1_rejection_reason || incident.motivo_rechazo_l1 || '',
                        
                        // Contactos
                        reporter: incident.reporter || incident.reportador || '',
                        reporter_phone: incident.reporter_phone || incident.telefono_reporta || '',
                        supervisor: incident.supervisor || incident.supervisor_nombre || '',
                        supervisor_phone: incident.supervisor_phone || incident.telefono_supervisor || '',
                        zone_manager: incident.zone_manager || incident.encargado_zona || '',
                        zone_manager_phone: incident.zone_manager_phone || incident.telefono_encargado || '',
                        
                        // Informaci√≥n adicional
                        time_elapsed: parseInt(incident.time_elapsed || incident.tiempo_transcurrido || 0),
                        actions_taken: incident.actions_taken || incident.acciones_tomadas || '',
                        occurrence_date: validateDate(incident.occurrence_date || incident.fecha_ocurrencia),
                        report_date: validateDate(incident.report_date || incident.fecha_reporte),
                        assignment_notes: incident.assignment_notes || incident.nota_asignacion || ''
                    };
                }).filter(incident => incident !== null);
                
            } catch (error) {
                console.error('Error adaptando datos:', error);
                return [];
            }
        }

        function validateDate(dateString) {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return '';
                }
                return dateString;
            } catch (error) {
                console.warn('Fecha inv√°lida:', dateString);
                return '';
            }
        }
        
        // ==========================================
        // üé® FUNCI√ìN DE RENDERIZADO COMPLETA CON INFORMACI√ìN DETALLADA
        // ==========================================
        
        function renderIncidents() {
            const container = document.getElementById('incidentsContainer');
            const filteredIncidents = filterIncidents();
            const technicianEmail = currentTechnician?.email || '';
            
            console.log('üé® Renderizando', filteredIncidents.length, 'incidencias');
            
            if (filteredIncidents.length === 0) {
                container.innerHTML = `
                    <div class="no-incidents">
                        <div class="no-incidents-icon">üìã</div>
                        <h3>No hay incidencias</h3>
                        <p>No tienes incidencias ${currentStatusFilter === 'all' ? '' : 'con este estado'} en este momento.</p>
                    </div>
                `;
                return;
            }

            const incidentsHTML = filteredIncidents.map(incident => {
                const realState = getIncidentRealState(incident, technicianEmail);
                const canRespond = canTechnicianRespond(incident, technicianEmail);
                const escalationLevel = parseInt(incident.escalation_level) || 0;
                
                // =======================================
                // ‚è±Ô∏è DETERMINAR SLA APROPIADO Y NIVEL
                // =======================================
                let slaEnd = null;
                let slaLabel = '';
                if (incident.l0_technician === technicianEmail && incident.sla_l0_end) {
                    slaEnd = incident.sla_l0_end;
                    slaLabel = 'SLA L0';
                } else if (incident.l1_technician === technicianEmail && incident.sla_l1_backup_end) {
                    slaEnd = incident.sla_l1_backup_end;
                    slaLabel = 'SLA L1';
                } else if (escalationLevel === 2 && incident.sla_l2_equipo_end) {
                    slaEnd = incident.sla_l2_equipo_end;
                    slaLabel = 'SLA L2';
                } else if (escalationLevel === 3 && incident.sla_l3_responsable_end) {
                    slaEnd = incident.sla_l3_responsable_end;
                    slaLabel = 'SLA L3';
                } else {
                    // Mostrar SLA del nivel actual aunque no sea nuestro
                    switch(escalationLevel) {
                        case 0: 
                            if (incident.sla_l0_end) {
                                slaEnd = incident.sla_l0_end; 
                                slaLabel = 'SLA L0';
                            }
                            break;
                        case 1: 
                            if (incident.sla_l1_backup_end) {
                                slaEnd = incident.sla_l1_backup_end; 
                                slaLabel = 'SLA L1';
                            }
                            break;
                        case 2: 
                            if (incident.sla_l2_equipo_end) {
                                slaEnd = incident.sla_l2_equipo_end; 
                                slaLabel = 'SLA L2';
                            }
                            break;
                        case 3: 
                            if (incident.sla_l3_responsable_end) {
                                slaEnd = incident.sla_l3_responsable_end; 
                                slaLabel = 'SLA L3';
                            }
                            break;
                    }
                }
                
                // =======================================
                // ‚è∞ CALCULAR TIEMPO SLA RESTANTE
                // =======================================
                let slaInfo = '';
                if (slaEnd) {
                    const now = new Date();
                    const endTime = new Date(slaEnd);
                    const diffMinutes = Math.floor((endTime - now) / 1000 / 60);
                    
                    if (diffMinutes < 0) {
                        slaInfo = `<div class="sla-expired">‚è∞ VENCIDO hace ${Math.abs(diffMinutes)} min (${slaLabel})</div>`;
                    } else {
                        const hours = Math.floor(diffMinutes / 60);
                        const minutes = diffMinutes % 60;
                        let slaClass = '';
                        if (diffMinutes <= 30) slaClass = 'sla-critical';
                        else if (diffMinutes <= 60) slaClass = 'sla-warning';
                        else slaClass = 'sla-good';
                        
                        slaInfo = `<div class="sla-timer ${slaClass}" data-end="${slaEnd}">‚è±Ô∏è ${hours}h ${minutes.toString().padStart(2, '0')}m (${slaLabel})</div>`;
                    }
                }
                
                // =======================================
                // üè∑Ô∏è DETERMINAR BADGE DE ESTADO
                // =======================================
              // BADGES DEL HEADER MEJORADO
                 const priorityBadge = getPriorityBadge(incident.priority);
                 const levelBadge = `<span class="badge bg-info">L${escalationLevel} ACTIVO</span>`;
                 const slaBadge = slaInfo ? `<span class="sla-badge ${getSlaClass(slaEnd)}">${getSlaText(slaEnd)}</span>` : '';
                 const stateBadge = getStateBadge(realState);

                function getPriorityBadge(priority) {
                 const priorityText = priority.replace(/[üî¥üü†üü°üü¢]/g, '').trim();
                 const colors = {
                     'CR√çTICA': '#dc3545',
                     'ALTA': '#fd7e14', 
                     'MEDIA': '#ffc107',
                     'BAJA': '#28a745'
                 };
                 const color = colors[priorityText] || '#6c757d';
                 return `<span class="priority-badge" style="background: ${color}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">${priorityText}</span>`;
             }
             
             function getStateBadge(state) {
                 const badges = {
                     'pending': { text: 'PUEDES RESPONDER', class: 'bg-warning' },
                     'working': { text: 'TRABAJANDO', class: 'bg-success' },
                     'expired': { text: 'VENCIDA', class: 'bg-danger' },
                     'seguimiento': { text: 'SEGUIMIENTO', class: 'bg-info' }
                 };
                 const config = badges[state] || { text: 'DESCONOCIDO', class: 'bg-secondary' };
                 return `<span class="badge ${config.class}">${config.text}</span>`;
             }
             
             function getSlaClass(slaEnd) {
                 if (!slaEnd) return 'sla-good';
                 const diffMinutes = Math.floor((new Date(slaEnd) - new Date()) / 60000);
                 if (diffMinutes <= 30) return 'sla-critical';
                 if (diffMinutes <= 60) return 'sla-warning';
                 return 'sla-good';
             }
             
             function getSlaText(slaEnd) {
                 if (!slaEnd) return '';
                 const diffMinutes = Math.floor((new Date(slaEnd) - new Date()) / 60000);
                 if (diffMinutes < 0) return `${Math.abs(diffMinutes)}m vencido`;
                 const hours = Math.floor(diffMinutes / 60);
                 const minutes = diffMinutes % 60;
                 return hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
             }
                
                // =======================================
                // üë®‚Äçüîß INFORMACI√ìN DE T√âCNICOS ASIGNADOS
                // =======================================
                let technicianInfo = '';
                if (incident.l0_technician) {
                    const isCurrentTech = incident.l0_technician === technicianEmail;
                    technicianInfo = `
                        <div class="technician-info ${isCurrentTech ? 'current-tech' : ''}">
                            üë®‚Äçüîß L0: <strong>${incident.l0_technician.split('@')[0]}</strong>
                            ${isCurrentTech ? ' (T√ö)' : ''}
                            ${incident.l0_response ? ` - ${incident.l0_response}` : ''}
                            ${incident.l0_acceptance_date ? ` - ${new Date(incident.l0_acceptance_date).toLocaleString('es-ES')}` : ''}
                        </div>
                    `;
                }
                
                if (escalationLevel >= 1 && incident.l1_technician) {
                    const isCurrentTech = incident.l1_technician === technicianEmail;
                    technicianInfo += `
                        <div class="technician-info ${isCurrentTech ? 'current-tech' : ''}">
                            üë®‚Äçüîß L1: <strong>${incident.l1_technician.split('@')[0]}</strong>
                            ${isCurrentTech ? ' (T√ö)' : ''}
                            ${incident.l1_response ? ` - ${incident.l1_response}` : ''}
                            ${incident.l1_acceptance_date ? ` - ${new Date(incident.l1_acceptance_date).toLocaleString('es-ES')}` : ''}
                        </div>
                    `;
                }
                
                if (escalationLevel >= 2 && incident.l2_technicians) {
                    const l2Techs = incident.l2_technicians.split(',');
                    const isCurrentInL2 = l2Techs.some(tech => tech.trim() === technicianEmail);
                    technicianInfo += `
                        <div class="technician-info ${isCurrentInL2 ? 'current-tech' : ''}">
                            üë• L2: <strong>${l2Techs.map(t => t.split('@')[0]).join(', ')}</strong>
                            ${isCurrentInL2 ? ' (INCLUYE A TI)' : ''}
                            ${incident.l2_response ? ` - ${incident.l2_response}` : ''}
                        </div>
                    `;
                }
                
                // =======================================
                // üìû INFORMACI√ìN DE CONTACTOS (COLAPSABLE)
                // =======================================
                let contactsInfo = '';
                if (incident.supervisor_phone || incident.reporter_phone || incident.zone_manager_phone) {
                    contactsInfo = `
                        <div class="contacts-info">
                            <div class="contacts-header" onclick="toggleContacts('${incident.id}')">
                                üìû Contactos <span class="toggle-icon">‚ñº</span>
                            </div>
                            <div class="contacts-list" id="contacts-${incident.id}" style="display: none;">
                                ${incident.reporter && incident.reporter_phone ? 
                                    `<div>üìã Reportador: <strong>${incident.reporter}</strong> - <a href="tel:${incident.reporter_phone}">${incident.reporter_phone}</a></div>` : ''}
                                ${incident.supervisor && incident.supervisor_phone ? 
                                    `<div>üë®‚Äçüíº Supervisor: <strong>${incident.supervisor}</strong> - <a href="tel:${incident.supervisor_phone}">${incident.supervisor_phone}</a></div>` : ''}
                                ${incident.zone_manager && incident.zone_manager_phone ? 
                                    `<div>üè¢ Encargado Zona: <strong>${incident.zone_manager}</strong> - <a href="tel:${incident.zone_manager_phone}">${incident.zone_manager_phone}</a></div>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                // =======================================
                // ‚è±Ô∏è TIEMPO TRANSCURRIDO
                // =======================================
            // TIEMPO TRANSCURRIDO (solo en estado TRABAJANDO)
                 let timeInfo = '';
                 if (realState === 'working') {
                     timeInfo = calculateWorkingTime(incident, technicianEmail);
                 }

               function calculateWorkingTime(incident, technicianEmail) {
                let acceptanceDate = null;
                
                if (incident.l0_technician === technicianEmail && incident.l0_acceptance_date) {
                    acceptanceDate = incident.l0_acceptance_date;
                } else if (incident.l1_technician === technicianEmail && incident.l1_acceptance_date) {
                    acceptanceDate = incident.l1_acceptance_date;
                } else if (incident.l2_acceptance_date) {
                    acceptanceDate = incident.l2_acceptance_date;
                }
                
                if (!acceptanceDate) return '';
                
                const now = new Date();
                const accepted = new Date(acceptanceDate);
                const diffMinutes = Math.floor((now - accepted) / 60000);
                
                const hours = Math.floor(diffMinutes / 60);
                const minutes = diffMinutes % 60;
                
                return `<div class="time-elapsed">üîß Trabajando: ${hours}h ${minutes}m</div>`;
            }
                
                // =======================================
                // üìù NOTAS DE ASIGNACI√ìN
                // =======================================
                let assignmentNotes = '';
                if (incident.assignment_notes && incident.assignment_notes.trim()) {
                    assignmentNotes = `
                        <div class="actions-taken">
                            üìù <strong>Notas de asignaci√≥n:</strong> ${incident.assignment_notes}
                        </div>
                    `;
                }
                
                // =======================================
                // üìä HISTORIAL COMPLETO DE ESCALADO
                // =======================================
                let escalationHistory = '';
                
                // Construir historial de todos los niveles
                const historyLevels = [];
                
                // L0
                let l0Status = 'pending';
                if (incident.l0_response === 'acepto') l0Status = 'completed';
                else if (incident.l0_response === 'rechazo' || incident.l0_response === 'solicitar_ayuda') l0Status = 'escalated';
                else if (escalationLevel > 0) l0Status = 'expired';
                
                historyLevels.push({
                    level: 'L0',
                    technician: incident.l0_technician,
                    status: l0Status,
                    response: incident.l0_response,
                    sla_end: incident.sla_l0_end,
                    acceptance_date: incident.l0_acceptance_date,
                    rejection_date: incident.l0_rejection_date,
                    reason: incident.l0_rejection_reason
                });
                
                // L1
                if (escalationLevel >= 1) {
                    let l1Status = escalationLevel === 1 ? 'current' : 'completed';
                    if (incident.l1_response === 'acepto') l1Status = 'completed';
                    else if (incident.l1_response === 'rechazo' || incident.l1_response === 'solicitar_ayuda') l1Status = 'escalated';
                    else if (escalationLevel > 1) l1Status = 'expired';
                    
                    historyLevels.push({
                        level: 'L1',
                        technician: incident.l1_technician,
                        status: l1Status,
                        response: incident.l1_response,
                        sla_end: incident.sla_l1_backup_end,
                        acceptance_date: incident.l1_acceptance_date,
                        rejection_date: incident.l1_rejection_date,
                        reason: incident.l1_rejection_reason
                    });
                }
                
                // L2
                if (escalationLevel >= 2) {
                    let l2Status = escalationLevel === 2 ? 'current' : 'completed';
                    if (incident.l2_response) l2Status = 'completed';
                    else if (escalationLevel > 2) l2Status = 'expired';
                    
                    historyLevels.push({
                        level: 'L2',
                        technician: incident.l2_technicians,
                        status: l2Status,
                        response: incident.l2_response,
                        sla_end: incident.sla_l2_equipo_end,
                        acceptance_date: incident.l2_acceptance_date
                    });
                }
                
                // L3
                if (escalationLevel >= 3) {
                    historyLevels.push({
                        level: 'L3',
                        technician: incident.l3_supervisor,
                        status: 'current',
                        response: incident.l3_response,
                        sla_end: incident.sla_l3_responsable_end
                    });
                }
                
                // Generar HTML del historial
                const historyHTML = historyLevels.map(level => {
                    const isCurrentTech = level.technician === technicianEmail || 
                                         (level.technician && level.technician.includes && level.technician.includes(technicianEmail));
                    
                    let statusClass = level.status;
                    let statusText = '';
                    switch(level.status) {
                        case 'completed': statusText = '‚úÖ Completado'; break;
                        case 'current': statusText = 'üîÑ Activo'; break;
                        case 'expired': statusText = '‚è∞ Vencido'; break;
                        case 'escalated': statusText = 'üîº Escalado'; break;
                        case 'pending': statusText = '‚è≥ Pendiente'; break;
                    }
                    
                    return `
                        <div class="escalation-level ${statusClass}">
                            <div class="level-header">
                                ${level.level} - ${statusText} ${isCurrentTech ? '(T√ö)' : ''}
                            </div>
                            <div class="level-details">
                                <strong>T√©cnico:</strong> ${level.technician ? level.technician.split('@')[0] : 'No asignado'}<br>
                                ${level.response ? `<strong>Respuesta:</strong> ${level.response}<br>` : ''}
                                ${level.reason ? `<strong>Motivo:</strong> ${level.reason}<br>` : ''}
                                ${level.sla_end ? `<strong>SLA:</strong> ${new Date(level.sla_end).toLocaleString('es-ES')}<br>` : ''}
                                ${level.acceptance_date ? `<strong>Fecha aceptaci√≥n:</strong> ${new Date(level.acceptance_date).toLocaleString('es-ES')}<br>` : ''}
                                ${level.rejection_date ? `<strong>Fecha rechazo:</strong> ${new Date(level.rejection_date).toLocaleString('es-ES')}` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                escalationHistory = `
                    <div class="escalation-history">
                        <div class="escalation-header" onclick="toggleEscalationHistory('${incident.id}')">
                            üìä Historial de Escalado <span class="toggle-icon">‚ñº</span>
                        </div>
                        <div class="escalation-content" id="escalation-${incident.id}">
                            ${historyHTML}
                        </div>
                    </div>
                `;
                
                // =======================================
                // üé® COLOR DE PRIORIDAD
                // =======================================
                let priorityColor = '#6c757d';
                const priority = incident.priority.replace(/üî¥|üü†|üü°|üü¢/g, '').trim();
                switch (priority) {
                    case 'CR√çTICA': priorityColor = '#dc3545'; break;
                    case 'ALTA': priorityColor = '#fd7e14'; break;
                    case 'MEDIA': priorityColor = '#ffc107'; break;
                    case 'BAJA': priorityColor = '#28a745'; break;
                }
                
                // =======================================
                // üéØ BOTONES DE ACCI√ìN - PREPARADO PARA MAKE
                // =======================================
                let actionButtons = '';
                
                if (canRespond) {
                    // ESTADO PENDIENTE - Botones iniciales
                    actionButtons = `
                        <div class="incident-actions">
                            <button class="btn btn-success" onclick="handleAction('acepto', '${incident.id}')">
                                ‚úÖ Acepto
                            </button>
                            <button class="btn btn-danger" onclick="handleAction('rechazo', '${incident.id}')">
                                ‚ùå Rechazo
                            </button>
                            <button class="btn btn-warning" onclick="handleAction('solicitar_ayuda', '${incident.id}')">
                                üÜò Ayuda
                            </button>
                        </div>
                    `;
                } else if (realState === 'working') {
                    // ESTADO TRABAJANDO - Botones de progreso (preparado para Make)
                    actionButtons = `
                        <div class="incident-actions">
                            <button class="btn btn-success" onclick="handleAction('completar', '${incident.id}')">
                                ‚úÖ Completar
                            </button>
                            <button class="btn btn-warning" onclick="handleAction('solicitar_apoyo', '${incident.id}')">
                                üÜò Solicitar Apoyo
                            </button>
                            <button class="btn btn-info" onclick="handleAction('transferir', '${incident.id}')">
                                üîÑ Transferir
                            </button>
                        </div>
                    `;
                } else if (realState === 'seguimiento' || realState === 'expired') {
                   actionButtons = `
                       <div class="incident-actions">
                           <button class="btn btn-info" onclick="handleAction('solicitar_cargo', '${incident.id}')">
                               üôã‚Äç‚ôÇÔ∏è SOLICITAR HACERSE CARGO
                           </button>
                       </div>
                    `;
                 } else {
    // OTROS ESTADOS - Sin acci√≥n posible
    let reason = '';
    if (realState === 'paused') {
        reason = '‚è∏Ô∏è Escalado pausado por supervisor';
    } else if (realState === 'not_mine') {
        reason = `üë§ No es tu responsabilidad (L${escalationLevel})`;
    } else {
        reason = '‚ùì Estado desconocido';
    }
    
    actionButtons = `
        <div class="no-action-info">
            <span class="badge bg-light">${reason}</span>
        </div>
    `;
}
    
                // =======================================
                // üèóÔ∏è RENDERIZADO FINAL DE LA CARD
                // =======================================
                return `
                    <div class="incident-card">
                        <div class="incident-header">
                            <div class="incident-title">
                                <h4>${incident.equipment || incident.component || 'Equipo no especificado'}</h4>
                               <div class="badges">
                               <span class="priority-badge" style="background-color: ${priorityColor}; color: white;">${priority}</span>
                               <span class="level-badge" style="background: #3b82f6; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">L${escalationLevel} ACTIVO</span>
                               ${getSLABadge(slaEnd)}
                               ${stateBadge}
                           </div>
                            </div>
                            <div class="incident-id">${incident.id}</div>
                        </div>
                        
                        <div class="incident-body">
                            <div class="zone">üìç <strong>${incident.zone}</strong></div>
                            <div class="description">${incident.description}</div>
                            
                            ${technicianInfo}
                            ${slaInfo}
                            ${timeInfo}
                            ${assignmentNotes}
                            
                            ${incident.actions_taken && incident.actions_taken !== 'Sin acciones' && incident.actions_taken !== '' ? 
                                `<div class="actions-taken">üîß <strong>Acciones tomadas:</strong> ${incident.actions_taken}</div>` : ''
                            }
                            
                            ${contactsInfo}
                            ${escalationHistory}
                        </div>
                        
                        <div class="incident-footer">
                            ${actionButtons}
                        </div>
                    </div>
                `;
            }).join('');
            
            // =======================================
            // üé® APLICAR LAYOUT DE 2 COLUMNAS
            // =======================================
            container.innerHTML = `
                <div class="incidents-grid">
                    ${incidentsHTML}
                </div>
            `;
            // =======================================
            // ‚è±Ô∏è INICIAR TIMERS SLA EN TIEMPO REAL
            // =======================================
            startSLATimers();
        }
     
     // ==========================================
// ‚è±Ô∏è FUNCI√ìN PARA ACTUALIZAR TIMERS SLA EN TIEMPO REAL
// ==========================================
function startSLATimers() {
    // Limpiar cualquier timer anterior
    if (window.slaTimer) {
        clearInterval(window.slaTimer);
    }
    
    // Actualizar timers cada 30 segundos
    window.slaTimer = setInterval(function() {
        const slaElements = document.querySelectorAll('.sla-timer[data-end]');
        
        slaElements.forEach(function(element) {
            const endTime = new Date(element.dataset.end);
            const now = new Date();
            const diffMinutes = Math.floor((endTime - now) / 1000 / 60);
            
            if (diffMinutes < 0) {
                // SLA vencido
                element.className = 'sla-expired';
                element.innerHTML = `‚è∞ VENCIDO hace ${Math.abs(diffMinutes)} min`;
            } else {
                // SLA activo
                const hours = Math.floor(diffMinutes / 60);
                const minutes = diffMinutes % 60;
                
                // Determinar clase seg√∫n tiempo restante
                let slaClass = 'sla-timer ';
                if (diffMinutes <= 30) slaClass += 'sla-critical';
                else if (diffMinutes <= 60) slaClass += 'sla-warning';
                else slaClass += 'sla-good';
                
                element.className = slaClass;
                element.innerHTML = `‚è±Ô∏è ${hours}h ${minutes.toString().padStart(2, '0')}m restantes`;
            }
        });
    }, 30000); // Actualizar cada 30 segundos
    
    console.log('‚è±Ô∏è Timers SLA iniciados - actualizaci√≥n cada 30 segundos');
}

        // ==========================================
        // üéØ FUNCIONES DE TOGGLE PARA SECCIONES COLAPSABLES
        // ==========================================

        function toggleContacts(incidentId) {
            const contactsList = document.getElementById(`contacts-${incidentId}`);
            if (!contactsList) return;
            
            const toggleIcon = contactsList.parentElement.querySelector('.toggle-icon');
            const isVisible = contactsList.style.display !== 'none';
            
            contactsList.style.display = isVisible ? 'none' : 'block';
            if (toggleIcon) {
                toggleIcon.textContent = isVisible ? '‚ñº' : '‚ñ≤';
            }
        }

        function toggleEscalationHistory(incidentId) {
            const historyContent = document.getElementById(`escalation-${incidentId}`);
            if (!historyContent) return;
            
            const toggleIcon = historyContent.parentElement.querySelector('.toggle-icon');
            const isVisible = historyContent.style.display !== 'none';
            
            historyContent.style.display = isVisible ? 'none' : 'block';
            if (toggleIcon) {
                toggleIcon.textContent = isVisible ? '‚ñº' : '‚ñ≤';
            }
        }

        // ==========================================
        // üéõÔ∏è FUNCIONES DE FILTRADO
        // ==========================================
        
        function filterIncidents() {
            return allIncidents.filter(incident => {
                // Filtro por estado
                if (currentStatusFilter !== 'all') {
                    const realState = getIncidentRealState(incident, currentTechnician.email);
                    if (realState !== currentStatusFilter) {
                        return false;
                    }
                }
                
                // Filtro por prioridad
                if (currentPriorityFilter !== 'all') {
                    const priority = incident.priority.replace(/üî¥|üü†|üü°|üü¢/g, '').trim();
                    if (priority !== currentPriorityFilter) {
                        return false;
                    }
                }
                
                return true;
            });
        }

        function filterByStatus(status, element) {
            currentStatusFilter = status;
            
            // Actualizar UI de filtros
            document.querySelectorAll('.stat-card').forEach(card => {
                card.classList.remove('active');
            });
            element.classList.add('active');
            
            renderIncidents();
        }

        function filterByPriority(priority, element) {
            currentPriorityFilter = priority;
            
            // Actualizar UI de filtros
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            element.classList.add('active');
            
            renderIncidents();
        }

        // ==========================================
        // üéØ L√ìGICA DE ESTADOS Y PERMISOS
        // ==========================================
        
function getIncidentRealState(incident, technicianEmail) {
    const escalationLevel = parseInt(incident.escalation_level) || 0;
    
    // Si est√° pausado
    if (incident.escalation_paused === 'true') {
        return 'paused';
    }
    
    // 1. ¬øEst√° asignado en el nivel actual?
    const isCurrentlyAssigned = checkCurrentAssignment(incident, technicianEmail, escalationLevel);
    
    if (isCurrentlyAssigned) {
        // Verificar si ya respondi√≥
        if (hasAcceptedAtLevel(incident, technicianEmail, escalationLevel)) {
            return 'working';
        }
        
        if (hasRejectedAtLevel(incident, technicianEmail, escalationLevel)) {
            return 'seguimiento';
        }
        
        // Verificar SLA del nivel actual
        const currentSLA = getCurrentLevelSLA(incident, escalationLevel);
        if (currentSLA && new Date(currentSLA) < new Date()) {
            return 'expired';
        }
        
        return 'pending';
    }
    
    // 2. ¬øParticip√≥ en niveles anteriores?
    if (hasParticipatedBefore(incident, technicianEmail)) {
        return 'seguimiento';
    }
    
    return 'not_mine';
}
     function checkCurrentAssignment(incident, technicianEmail, level) {
    switch (level) {
        case 0: return incident.l0_technician === technicianEmail;
        case 1: return incident.l1_technician === technicianEmail;
        case 2: return incident.l2_technicians && incident.l2_technicians.includes(technicianEmail);
        case 3: return incident.l3_supervisor === technicianEmail;
        default: return false;
    }
}

function hasAcceptedAtLevel(incident, technicianEmail, level) {
    switch (level) {
        case 0: return incident.l0_response === 'Aceptado' && incident.l0_technician === technicianEmail;
        case 1: return incident.l1_response === 'Aceptado' && incident.l1_technician === technicianEmail;
        case 2: return incident.l2_responses && incident.l2_responses.includes('Aceptado');
        case 3: return incident.l3_response === 'Aceptado';
        default: return false;
    }
}

function hasRejectedAtLevel(incident, technicianEmail, level) {
    switch (level) {
        case 0: return (incident.l0_response === 'Rechazado' || incident.l0_response === 'Ayuda') && incident.l0_technician === technicianEmail;
        case 1: return (incident.l1_response === 'Rechazado' || incident.l1_response === 'Ayuda') && incident.l1_technician === technicianEmail;
        case 2: return incident.l2_responses && (incident.l2_responses.includes('Rechazado') || incident.l2_responses.includes('Ayuda'));
        default: return false;
    }
}

function hasParticipatedBefore(incident, technicianEmail) {
    return (incident.l0_technician === technicianEmail && incident.l0_response !== '‚≠ï Sin Respuesta') ||
           (incident.l1_technician === technicianEmail && incident.l1_response !== '‚≠ï Sin Respuesta');
}

function getCurrentLevelSLA(incident, level) {
    switch (level) {
        case 0: return incident.sla_l0_end;
        case 1: return incident.sla_l1_backup_end;
        case 2: return incident.sla_l2_equipo_end;
        case 3: return incident.sla_l3_responsable_end;
        default: return null;
    }
}
     
     function getSLABadge(slaEnd) {
             if (!slaEnd) return '';
             
             const now = new Date();
             const endTime = new Date(slaEnd);
             const diffMinutes = Math.floor((endTime - now) / 60000);
             
             let text, bgColor;
             if (diffMinutes < 0) {
                 text = `${Math.abs(diffMinutes)}m vencido`;
                 bgColor = '#ef4444';
             } else {
                 const hours = Math.floor(diffMinutes / 60);
                 const minutes = diffMinutes % 60;
                 text = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                 
                 if (diffMinutes <= 30) bgColor = '#ef4444';
                 else if (diffMinutes <= 60) bgColor = '#f59e0b';
                 else bgColor = '#22c55e';
             }
             
             return `<span class="sla-badge" style="background: ${bgColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">‚è∞ ${text}</span>`;
         }

        function canTechnicianRespond(incident, technicianEmail) {
            const state = getIncidentRealState(incident, technicianEmail);
            return state === 'pending';
        }

        // ==========================================
        // üìä ACTUALIZAR ESTAD√çSTICAS
        // ==========================================
        
function updateStats() {
    const technicianEmail = currentTechnician?.email || '';
    
    let pendingCount = 0;
    let workingCount = 0;
    let expiredCount = 0;
    let seguimientoCount = 0;
    
    allIncidents.forEach(incident => {
        const state = getIncidentRealState(incident, technicianEmail);
        switch (state) {
            case 'pending':
                pendingCount++;
                break;
            case 'working':
                workingCount++;
                break;
            case 'expired':
                expiredCount++;
                break;
            case 'seguimiento':
                seguimientoCount++;
                break;
        }
    });
    
    document.getElementById('totalCount').textContent = allIncidents.length;
    document.getElementById('pendingCount').textContent = pendingCount;
    document.getElementById('workingCount').textContent = workingCount;
    document.getElementById('expiredCount').textContent = expiredCount;
    
    // Actualizar contador de seguimiento
    const seguimientoElement = document.getElementById('seguimientoCount');
    if (seguimientoElement) {
        seguimientoElement.textContent = seguimientoCount;
    }
}

        // ==========================================
        // üéØ MANEJO DE ACCIONES CON MODALES COMPLETOS
        // ==========================================
        
        function handleAction(action, incidentId) {
            currentIncident = allIncidents.find(inc => inc.id === incidentId);
            if (!currentIncident) {
                console.error('Incidencia no encontrada:', incidentId);
                return;
            }

            if (accessMode !== 'full_access') {
                pendingAction = action;
                showPINModal();
                return;
            }

            if (action === 'acepto') {
                // Acepto directo sin modal
                pendingAction = action;
                confirmAction();
            } else if (action === 'completar') {
                // Completar con descripci√≥n obligatoria
                showCompletionModal();
            } else {
                // Mostrar modal de motivos
                showReasonModal(action);
            }
        }

        function executeAction() {
            if (!pendingAction) return;
            
            if (pendingAction === 'acepto') {
                confirmAction();
            } else if (pendingAction === 'completar') {
                showCompletionModal();
            } else {
                showReasonModal(pendingAction);
            }
        }

        function showReasonModal(action) {
            pendingAction = action;
            selectedReason = null;
            customText = '';

            const modal = document.getElementById('reasonModal');
            const title = document.getElementById('modalTitle');
            const options = document.getElementById('reasonOptions');
            const confirmBtn = document.getElementById('confirmBtn');

            let reasons = [];
            let modalTitle = '';
            let buttonText = '';

            switch(action) {
                case 'rechazo':
                    modalTitle = '‚ùå Motivo del Rechazo';
                    buttonText = 'Rechazar';
                    reasons = rejectReasons;
                    break;
                case 'solicitar_ayuda':
                    modalTitle = 'üÜò Tipo de Ayuda Inicial';
                    buttonText = 'Solicitar Ayuda';
                    reasons = helpReasonsInitial;
                    break;
                case 'transferir':
                    modalTitle = 'üîÑ Motivo de Transferencia';
                    buttonText = 'Transferir';
                    reasons = transferReasons;
                    break;
                case 'solicitar_apoyo':
                    modalTitle = 'üÜò Tipo de Apoyo en Trabajo';
                    buttonText = 'Solicitar Apoyo';
                    reasons = supportReasonsWorking;
                    break;
                default:
                    console.error('Acci√≥n no reconocida:', action);
                    return;
            }

            title.textContent = modalTitle;
            confirmBtn.textContent = buttonText;
            confirmBtn.disabled = true;

            // Generar opciones de motivos
            const reasonsHTML = reasons.map(reason => {
                return `
                    <div class="reason-option" onclick="selectReason('${reason.id}', ${reason.requiresText || false})">
                        <div class="reason-icon">${reason.icon}</div>
                        <div class="reason-text">
                            <div class="reason-title">${reason.title}</div>
                            <div class="reason-description">${reason.description}</div>
                        </div>
                    </div>
                `;
            }).join('');

            options.innerHTML = reasonsHTML;
            modal.classList.add('active');
        }

        function selectReason(reasonId, requiresText = false) {
            selectedReason = reasonId;
            customText = '';
            
            // Marcar opci√≥n seleccionada
            document.querySelectorAll('.reason-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Si requiere texto personalizado, mostrar textarea
            const options = document.getElementById('reasonOptions');
            const existingTextarea = options.querySelector('.custom-reason-input');
            if (existingTextarea) {
                existingTextarea.remove();
            }
            
            if (requiresText) {
                const textarea = document.createElement('textarea');
                textarea.className = 'custom-reason-input';
                textarea.placeholder = 'Especifica los detalles...';
                textarea.oninput = () => {
                    customText = textarea.value.trim();
                    updateConfirmButton();
                };
                options.appendChild(textarea);
                textarea.focus();
            } else {
                updateConfirmButton();
            }
        }

        function updateConfirmButton() {
            const confirmBtn = document.getElementById('confirmBtn');
            const requiresText = selectedReason && (selectedReason.includes('otro') || selectedReason === 'otro_motivo_transferir' || selectedReason === 'otro_apoyo_trabajo');
            
            if (selectedReason) {
                if (requiresText) {
                    confirmBtn.disabled = customText.length < 10;
                } else {
                    confirmBtn.disabled = false;
                }
            } else {
                confirmBtn.disabled = true;
            }
        }

        function closeReasonModal() {
            document.getElementById('reasonModal').classList.remove('active');
            selectedReason = null;
            customText = '';
            pendingAction = null;
        }

        function showCompletionModal() {
            const modal = document.getElementById('reasonModal');
            const title = document.getElementById('modalTitle');
            const options = document.getElementById('reasonOptions');
            const confirmBtn = document.getElementById('confirmBtn');

            title.textContent = '‚úÖ Completar Incidencia';
            confirmBtn.textContent = 'Completar';
            
            options.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #374151; font-weight: 600; margin-bottom: 10px;">
                        Describe las acciones realizadas para resolver la incidencia:
                    </p>
                    <textarea 
                        class="custom-reason-input" 
                        placeholder="Ejemplo: Reemplazada bomba defectuosa, verificado funcionamiento correcto, sistema operativo..." 
                        maxlength="500"
                        oninput="updateCompletionText(this.value)"
                        style="height: 120px;"></textarea>
                    <div style="text-align: right; font-size: 12px; color: #6b7280; margin-top: 5px;">
                        M√≠nimo 20 caracteres
                    </div>
                </div>
            `;

            confirmBtn.disabled = true;
            modal.classList.add('active');
            
            // Focus en textarea
            setTimeout(() => {
                const textarea = options.querySelector('textarea');
                if (textarea) textarea.focus();
            }, 100);
        }

        function updateCompletionText(text) {
            customText = text.trim();
            document.getElementById('confirmBtn').disabled = customText.length < 20;
        }

        async function confirmAction() {
            if (!pendingAction || !currentIncident) {
                console.error('No hay acci√≥n pendiente o incidencia seleccionada');
                return;
            }

            const reasonText = selectedReason ? 
                (customText || selectedReason.replace(/_/g, ' ')) : 
                (customText || 'Confirmado');

            try {
                const response = await fetch(API_RESPONSE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        incident_id: currentIncident.id,
                        technician_email: currentTechnician.email,
                        technician_name: currentTechnician.name,
                        action: pendingAction,
                        reason: reasonText,
                        timestamp: new Date().toISOString()
                    })
                });

                let data = null;
                try {
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                        data = await response.json();
                    } else {
                        throw new Error('Respuesta no es JSON v√°lido');
                    }
                } catch (parseError) {
                    console.error('Error parsing respuesta de acci√≥n:', parseError);
                    throw new Error('Error procesando respuesta del servidor');
                }
                
                if (response.ok && data && data.status === 'success') {
                    const successMessages = {
                        'acepto': '‚úÖ Incidencia aceptada correctamente. ¬°Puedes empezar a trabajar!',
                        'rechazo': '‚ùå Incidencia rechazada. Se escalar√° autom√°ticamente.',
                        'solicitar_ayuda': 'üÜò Ayuda solicitada. Un supervisor se pondr√° en contacto.',
                        'completar': '‚úÖ Incidencia completada exitosamente.',
                        'transferir': 'üîÑ Incidencia transferida correctamente.',
                        'solicitar_apoyo': 'üÜò Apoyo solicitado. Un supervisor gestionar√° tu petici√≥n.'
                    };
                    
                    showSuccessOverlay(
                        successMessages[pendingAction] || `${pendingAction.toUpperCase()} registrado correctamente`,
                        pendingAction === 'acepto' ? 'üîÑ' : '‚úÖ'
                    );
                    
                    closeReasonModal();
                    await loadDashboard(); // Recargar datos
                } else {
                    const errorMsg = (data && data.message) || `Error ${response.status}: No se pudo registrar la respuesta`;
                    alert(errorMsg);
                }
                
            } catch (error) {
                console.error('Error enviando respuesta:', error);
                alert('Error de conexi√≥n: ' + error.message);
            } finally {
                pendingAction = null;
                currentIncident = null;
                selectedReason = null;
                customText = '';
            }
        }

        function showSuccessOverlay(message, icon = '‚úÖ') {
            const overlay = document.getElementById('successOverlay');
            const iconEl = document.getElementById('successIcon');
            const titleEl = document.getElementById('successTitle');
            const descEl = document.getElementById('successDescription');
            const countdownEl = document.getElementById('countdown');
            
            iconEl.textContent = icon;
            titleEl.textContent = 'Acci√≥n Completada';
            descEl.textContent = message;
            
            overlay.style.display = 'flex';
            
            let seconds = 3;
            countdownEl.textContent = `Actualizando en ${seconds} segundos...`;
            
            const countdown = setInterval(() => {
                seconds--;
                if (seconds > 0) {
                    countdownEl.textContent = `Actualizando en ${seconds} segundos...`;
                } else {
                    clearInterval(countdown);
                    overlay.style.display = 'none';
                }
            }, 1000);
        }

        // ==========================================
        // üöÄ INICIALIZACI√ìN AL CARGAR LA P√ÅGINA
        // ==========================================
        
        window.addEventListener('DOMContentLoaded', function() {
            console.log('üîß ABC.xyz Dashboard T√©cnico iniciado');
            
            // Verificar par√°metros URL para login autom√°tico
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('tecnico') || urlParams.get('technician_email');
            const nombre = urlParams.get('nombre') || urlParams.get('technician_name');
            const incidentId = urlParams.get('id') || urlParams.get('incident_id');
            
            if (email) {
                document.getElementById('emailInput').value = email;
                if (nombre) {
                    currentTechnician = { 
                        email: email, 
                        name: decodeURIComponent(nombre) 
                    };
                }
                if (incidentId) {
                    accessMode = 'read_only';
                }
                document.getElementById('emailInput').focus();
            } else {
                document.getElementById('emailInput').focus();
            }
            
            // Enter key en el campo email
            document.getElementById('emailInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loginWithPIN();
                }
            });
        });

        // ==========================================
        // üéØ EVENTOS Y CONTROLES ADICIONALES
        // ==========================================
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.getElementById('loginContainer').style.display !== 'none') {
                const input = document.getElementById('emailInput');
                if (input.value.trim()) loginWithPIN();
            }
            if (e.key === 'Escape') {
                closeReasonModal();
                closePINModal();
            }
        });

        document.getElementById('reasonModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeReasonModal();
        });

        document.getElementById('pinModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closePINModal();
        });

        // Limpiar intervals al cerrar la p√°gina
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) clearInterval(refreshInterval);
            if (slaTimerInterval) clearInterval(slaTimerInterval);
        });

        // ==========================================
        // üì± RESPONSIVE Y DEBUGGING
        // ==========================================
        
        console.log('üîß Dashboard ABC.xyz - Versi√≥n Profesional cargada');
        console.log('üìã Motivos configurados:', {
            rechazo: rejectReasons.length,
            ayuda_inicial: helpReasonsInitial.length,
            transferir: transferReasons.length,
            apoyo_trabajo: supportReasonsWorking.length
        });

    </script>
</body>
</html>
            
          
