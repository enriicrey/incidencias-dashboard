<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ABC.xyz - Dashboard T√©cnico</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
background: #f8f9fa;
min-height: 100vh;
color: #333;
}

/* Header Profesional */
.header {
background: linear-gradient(135deg, #1e3a8a, #3b82f6);
color: white;
padding: 20px 0;
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
position: sticky;
top: 0;
z-index: 100;
}

.header-content {
max-width: 1400px;
margin: 0 auto;
padding: 0 20px;
display: flex;
justify-content: space-between;
align-items: center;
}

.logo {
font-size: 24px;
font-weight: 700;
display: flex;
align-items: center;
gap: 12px;
}

.logo-text {
background: linear-gradient(135deg, #3b82f6, #8b5cf6);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
font-weight: 800;
font-size: 26px;
}

.user-info {
display: flex;
align-items: center;
gap: 15px;
}

.auth-status {
background: rgba(255,255,255,0.15);
padding: 10px 16px;
border-radius: 20px;
font-size: 14px;
font-weight: 600;
}

.auth-status.authenticated {
background: rgba(34,197,94,0.2);
border: 1px solid rgba(34,197,94,0.3);
}

.auth-status.read-only {
background: rgba(251,146,60,0.2);
border: 1px solid rgba(251,146,60,0.3);
}

.refresh-button {
background: rgba(255, 255, 255, 0.15);
border: 1px solid rgba(255, 255, 255, 0.3);
color: white;
padding: 10px 18px;
border-radius: 8px;
font-size: 14px;
font-weight: 600;
cursor: pointer;
transition: all 0.3s;
}

.refresh-button:hover {
background: rgba(255, 255, 255, 0.25);
}

.last-update {
font-size: 12px;
opacity: 0.8;
}

/* Container Principal */
.main-container {
display: none;
max-width: 1400px;
margin: 0 auto;
padding: 30px 20px;
}

/* Stats Bar */
.stats-bar {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 20px;
margin-bottom: 30px;
}

.stat-card {
background: white;
border-radius: 12px;
padding: 20px;
text-align: center;
box-shadow: 0 2px 8px rgba(0,0,0,0.08);
border: 1px solid #e5e7eb;
transition: transform 0.3s;
}

.stat-card:hover {
transform: translateY(-2px);
}

.stat-number {
font-size: 32px;
font-weight: 800;
margin-bottom: 5px;
}

.stat-number.pending { color: #f59e0b; }
.stat-number.working { color: #10b981; }
.stat-number.expired { color: #ef4444; }

.stat-label {
font-size: 14px;
color: #6b7280;
font-weight: 600;
text-transform: uppercase;
letter-spacing: 0.5px;
}

/* Filters Bar */
.filters-bar {
background: white;
border-radius: 12px;
padding: 20px;
margin-bottom: 30px;
box-shadow: 0 2px 8px rgba(0,0,0,0.08);
border: 1px solid #e5e7eb;
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
gap: 15px;
}

.filter-group {
display: flex;
align-items: center;
gap: 10px;
}

.filter-label {
font-size: 14px;
font-weight: 600;
color: #374151;
}

.filter-buttons {
display: flex;
gap: 8px;
}

.filter-btn {
padding: 8px 16px;
border: 2px solid #d1d5db;
background: white;
color: #6b7280;
border-radius: 8px;
font-size: 14px;
font-weight: 500;
cursor: pointer;
transition: all 0.3s;
}

.filter-btn:hover {
border-color: #374151;
color: #374151;
}

.filter-btn.active {
background: #374151;
color: white;
border-color: #374151;
}

/* Incidents Grid */
.incidents-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
gap: 25px;
}

.incident-card {
background: white;
border-radius: 12px;
padding: 25px;
box-shadow: 0 2px 8px rgba(0,0,0,0.08);
border: 1px solid #e5e7eb;
transition: all 0.3s ease;
position: relative;
}

.incident-card::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 4px;
}

.incident-card.pending::before {
background: linear-gradient(135deg, #f59e0b, #d97706);
}

.incident-card.working::before {
background: linear-gradient(135deg, #10b981, #059669);
}

.incident-card.expired::before {
background: linear-gradient(135deg, #ef4444, #dc2626);
}

.incident-card:hover {
transform: translateY(-3px);
box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.incident-header {
display: flex;
justify-content: space-between;
align-items: flex-start;
margin-bottom: 18px;
}

.incident-id {
background: #f9fafb;
color: #374151;
padding: 8px 14px;
border-radius: 8px;
font-weight: 700;
font-size: 13px;
border: 1px solid #d1d5db;
}

.priority-badge {
padding: 6px 12px;
border-radius: 16px;
font-size: 11px;
font-weight: 700;
text-transform: uppercase;
letter-spacing: 0.5px;
}

.priority-critica { background: #ef4444; color: white; }
.priority-alta { background: #f59e0b; color: white; }
.priority-media { background: #eab308; color: #000; }
.priority-baja { background: #10b981; color: white; }

.incident-content {
margin-bottom: 20px;
}

.incident-title {
font-size: 18px;
font-weight: 700;
color: #1f2937;
margin-bottom: 10px;
line-height: 1.3;
}

.incident-zone {
color: #6b7280;
font-size: 14px;
margin-bottom: 10px;
background: #f9fafb;
padding: 6px 12px;
border-radius: 6px;
display: inline-block;
}

.incident-description {
color: #374151;
font-size: 14px;
line-height: 1.5;
margin-bottom: 15px;
background: #f9fafb;
padding: 12px;
border-radius: 8px;
border-left: 3px solid #d1d5db;
}

/* Info Sections */
.info-row {
display: flex;
justify-content: space-between;
align-items: center;
padding: 8px 12px;
margin: 6px 0;
border-radius: 6px;
font-size: 13px;
}

.info-row.status {
background: #dbeafe;
color: #1d4ed8;
font-weight: 600;
}

.info-row.assigned {
background: #d1fae5;
color: #065f46;
font-weight: 600;
}

.info-row.response {
background: #fed7aa;
color: #c2410c;
font-weight: 600;
}

/* SLA Timer */
.sla-section {
background: #f8fafc;
border-radius: 12px;
padding: 18px;
text-align: center;
margin: 15px 0;
border: 1px solid #e2e8f0;
}

.sla-time {
font-size: 24px;
font-weight: 800;
margin-bottom: 6px;
font-family: 'Courier New', monospace;
}

.sla-time.good { color: #10b981; }
.sla-time.warning { color: #f59e0b; }
.sla-time.critical { color: #ef4444; }

.sla-label {
font-size: 12px;
color: #6b7280;
font-weight: 600;
}

.sla-level {
background: #374151;
color: white;
padding: 4px 10px;
border-radius: 10px;
font-size: 10px;
font-weight: 700;
margin-top: 8px;
display: inline-block;
}

/* Expired Timer */
.expired-section {
background: #fef2f2;
border-radius: 12px;
padding: 18px;
text-align: center;
margin: 15px 0;
border: 1px solid #fecaca;
}

.expired-time {
font-size: 18px;
font-weight: 800;
color: #b91c1c;
margin-bottom: 6px;
}

.expired-label {
font-size: 11px;
color: #b91c1c;
font-weight: 700;
text-transform: uppercase;
}

.escalation-info {
background: #fffbeb;
padding: 12px;
border-radius: 8px;
margin: 10px 0;
font-size: 13px;
color: #d97706;
font-weight: 600;
text-align: center;
border: 1px solid #fed7aa;
}

/* Action Buttons */
.actions-section {
margin-top: 20px;
}

.action-buttons {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 12px;
margin-bottom: 12px;
}

.action-btn {
padding: 12px 20px;
border: none;
border-radius: 8px;
font-size: 14px;
font-weight: 600;
cursor: pointer;
transition: all 0.3s;
text-transform: uppercase;
letter-spacing: 0.3px;
}

.action-btn.locked {
opacity: 0.6;
cursor: not-allowed;
background: #6b7280 !important;
}

.btn-accept { background: #10b981; color: white; }
.btn-reject { background: #ef4444; color: white; }
.btn-help { background: #f59e0b; color: white; grid-column: 1 / -1; }

.action-btn:hover:not(.locked) {
transform: translateY(-1px);
box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* Phone Section */
.phone-section {
margin-top: 15px;
}

.contact-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 8px 12px;
margin: 4px 0;
background: #f9fafb;
border-radius: 6px;
border: 1px solid #e5e7eb;
}

.contact-name {
font-size: 13px;
color: #374151;
font-weight: 500;
}

.phone-btn {
background: #3b82f6;
color: white;
padding: 6px 12px;
border: none;
border-radius: 6px;
font-weight: 600;
text-decoration: none;
font-size: 12px;
transition: all 0.3s;
}

.phone-btn.supervisor {
background: #8b5cf6;
}

.phone-btn:hover {
transform: translateY(-1px);
}

/* Success Overlay */
.success-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.5);
display: flex;
align-items: center;
justify-content: center;
z-index: 2000;
}

.success-message {
background: white;
border-radius: 12px;
padding: 30px;
text-align: center;
max-width: 400px;
margin: 20px;
box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.success-icon { font-size: 60px; margin-bottom: 20px; }
.success-title { font-size: 20px; font-weight: 700; color: #1f2937; margin-bottom: 15px; }
.success-description { color: #6b7280; font-size: 16px; margin-bottom: 20px; }
.countdown { font-size: 14px; color: #10b981; font-weight: 600; }

/* Loading */
.loading {
text-align: center;
padding: 60px;
color: #6b7280;
}

.spinner {
width: 40px;
height: 40px;
border: 3px solid #e5e7eb;
border-top-color: #374151;
border-radius: 50%;
animation: spin 1s linear infinite;
margin: 0 auto 20px;
}

@keyframes spin {
to { transform: rotate(360deg); }
}

/* Login Container */
.login-container {
background: white;
border-radius: 12px;
padding: 40px;
text-align: center;
box-shadow: 0 10px 30px rgba(0,0,0,0.1);
max-width: 450px;
margin: 50px auto;
border: 1px solid #e5e7eb;
}

.login-title {
font-size: 28px;
color: #1f2937;
margin-bottom: 15px;
font-weight: 700;
display: flex;
align-items: center;
justify-content: center;
gap: 10px;
}

.login-logo {
background: linear-gradient(135deg, #3b82f6, #8b5cf6);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
font-weight: 800;
font-size: 24px;
}

.login-subtitle {
color: #6b7280;
margin-bottom: 30px;
font-size: 16px;
}

.input-group {
margin-bottom: 25px;
text-align: left;
}

.input-label {
display: block;
margin-bottom: 8px;
font-weight: 600;
color: #374151;
}

.input-field {
width: 100%;
padding: 15px;
border: 2px solid #d1d5db;
border-radius: 8px;
font-size: 16px;
transition: border-color 0.3s;
}

.input-field:focus {
outline: none;
border-color: #3b82f6;
}

.verify-btn {
width: 100%;
padding: 15px;
border: none;
border-radius: 8px;
font-size: 16px;
font-weight: 700;
cursor: pointer;
margin-bottom: 15px;
transition: all 0.3s;
background: linear-gradient(135deg, #374151, #4b5563);
color: white;
}

.verify-btn:hover {
transform: translateY(-2px);
}

/* No incidents */
.no-incidents {
background: white;
border-radius: 12px;
padding: 60px;
text-align: center;
box-shadow: 0 2px 8px rgba(0,0,0,0.08);
border: 1px solid #e5e7eb;
}

.no-incidents-icon { font-size: 60px; margin-bottom: 20px; }
.no-incidents-title { font-size: 20px; color: #1f2937; margin-bottom: 15px; font-weight: 700; }
.no-incidents-description { color: #6b7280; font-size: 16px; }

/* Modals */
.modal-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.7);
display: flex;
align-items: center;
justify-content: center;
z-index: 1000;
opacity: 0;
visibility: hidden;
transition: all 0.3s;
}

.modal-overlay.active {
opacity: 1;
visibility: visible;
}

.modal-content, .pin-modal {
background: white;
border-radius: 12px;
padding: 30px;
max-width: 500px;
width: 90%;
max-height: 80vh;
overflow-y: auto;
transform: scale(0.8);
transition: transform 0.3s;
}

.modal-overlay.active .modal-content,
.modal-overlay.active .pin-modal {
transform: scale(1);
}

.modal-title, .pin-modal-title {
font-size: 20px;
color: #1f2937;
margin-bottom: 20px;
text-align: center;
font-weight: 700;
}

.reason-options {
display: flex;
flex-direction: column;
gap: 12px;
margin-bottom: 25px;
}

.reason-option {
padding: 15px;
border: 2px solid #d1d5db;
border-radius: 8px;
cursor: pointer;
transition: all 0.3s;
display: flex;
align-items: center;
gap: 12px;
}

.reason-option:hover {
border-color: #374151;
background: #f9fafb;
}

.reason-option.selected {
border-color: #3b82f6;
background: #eff6ff;
}

.reason-icon { font-size: 24px; min-width: 30px; }
.reason-text { flex: 1; }
.reason-title { font-weight: 600; color: #1f2937; margin-bottom: 3px; }
.reason-description { font-size: 13px; color: #6b7280; }

.modal-actions, .pin-actions {
display: flex;
gap: 15px;
}

.modal-btn, .pin-btn {
flex: 1;
padding: 15px;
border: none;
border-radius: 8px;
font-size: 16px;
font-weight: 700;
cursor: pointer;
transition: all 0.3s;
}

.btn-cancel, .pin-btn-cancel {
background: #f9fafb;
color: #6b7280;
border: 1px solid #d1d5db;
}

.btn-confirm, .pin-btn-verify {
background: #374151;
color: white;
}

.pin-input {
width: 100%;
padding: 15px;
border: 2px solid #d1d5db;
border-radius: 8px;
font-size: 18px;
text-align: center;
letter-spacing: 8px;
margin-bottom: 20px;
}

.error-message {
background: #fef2f2;
color: #b91c1c;
padding: 12px;
border-radius: 8px;
margin-top: 15px;
border: 1px solid #fecaca;
}

/* Responsive */
@media (max-width: 768px) {
.header-content {
flex-direction: column;
gap: 15px;
text-align: center;
}
.incidents-grid {
grid-template-columns: 1fr;
}
.filters-bar {
flex-direction: column;
align-items: stretch;
}
.stats-bar {
grid-template-columns: repeat(3, 1fr);
}
.action-buttons {
grid-template-columns: 1fr;
}
.main-container {
padding: 20px 15px;
}
}
</style>
</head>
<body>
<!-- Login Container -->
<div class="container" id="loginContainer">
<div class="login-container">
<h1 class="login-title">
<span>üîß</span>
<span class="login-logo">ABC.xyz</span>
<span>Dashboard T√©cnico</span>
</h1>
<p class="login-subtitle">Accede con tu email para gestionar incidencias</p>
<div class="input-group">
<label class="input-label" for="emailInput">Email T√©cnico</label>
<input type="email" class="input-field" id="emailInput" placeholder="ejemplo@empresa.com" autocomplete="email">
</div>
<button onclick="loginWithPIN()" class="verify-btn" id="loginBtn">
üîí Acceder con PIN
</button>
<div id="loginError" class="error-message" style="display: none;"></div>
</div>
</div>

<!-- Header Principal -->
<div class="header" id="mainHeader" style="display: none;">
<div class="header-content">
<div class="logo">
<span>üîß</span>
<span class="logo-text">ABC.xyz</span>
<span id="dashboardTitle">Dashboard T√©cnico</span>
</div>
<div class="user-info">
<div class="auth-status" id="authStatus">
<span id="authMessage">‚ö†Ô∏è Cargando...</span>
</div>
<button id="refreshBtn" class="refresh-button" onclick="refreshIncidents()">
üîÑ Actualizar
</button>
<p id="lastUpdate" class="last-update">--:--</p>
</div>
</div>
</div>

<!-- Main Container -->
<div class="main-container" id="mainContainer">
<!-- Stats Bar -->
<div class="stats-bar">
<div class="stat-card">
<div class="stat-number pending" id="pendingCount">0</div>
<div class="stat-label">Pendientes</div>
</div>
<div class="stat-card">
<div class="stat-number working" id="workingCount">0</div>
<div class="stat-label">Trabajando</div>
</div>
<div class="stat-card">
<div class="stat-number expired" id="expiredCount">0</div>
<div class="stat-label">Vencidas</div>
</div>
</div>

<!-- Filters Bar -->
<div class="filters-bar">
<div class="filter-group">
<span class="filter-label">Estado:</span>
<div class="filter-buttons">
<button class="filter-btn active" onclick="filterByStatus('all', this)">Todos</button>
<button class="filter-btn" onclick="filterByStatus('pending', this)">Pendientes</button>
<button class="filter-btn" onclick="filterByStatus('working', this)">Trabajando</button>
<button class="filter-btn" onclick="filterByStatus('expired', this)">Vencidas</button>
</div>
</div>
<div class="filter-group">
<span class="filter-label">Prioridad:</span>
<div class="filter-buttons">
<button class="filter-btn active" onclick="filterByPriority('all', this)">Todas</button>
<button class="filter-btn" onclick="filterByPriority('CR√çTICA', this)">Cr√≠tica</button>
<button class="filter-btn" onclick="filterByPriority('ALTA', this)">Alta</button>
<button class="filter-btn" onclick="filterByPriority('MEDIA', this)">Media</button>
<button class="filter-btn" onclick="filterByPriority('BAJA', this)">Baja</button>
</div>
</div>
</div>

<!-- Incidents Grid -->
<div class="incidents-grid" id="incidentsContainer">
<!-- Contenido din√°mico -->
</div>
</div>

<!-- Success Overlay -->
<div class="success-overlay" id="successOverlay" style="display: none;">
<div class="success-message">
<div class="success-icon" id="successIcon">‚úÖ</div>
<div class="success-title" id="successTitle">Acci√≥n Completada</div>
<div class="success-description" id="successDescription">La acci√≥n se ha procesado correctamente</div>
<div class="countdown" id="countdown">Actualizando en 3 segundos...</div>
</div>
</div>

<!-- PIN Modal -->
<div class="modal-overlay" id="pinModal">
<div class="pin-modal">
<h3 class="pin-modal-title">üîê Verificaci√≥n de Seguridad</h3>
<p style="text-align: center; color: #6b7280; margin-bottom: 25px;">Introduce tu PIN de 4 d√≠gitos</p>
<input type="password" class="pin-input" id="pinInput" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
<div class="pin-actions">
<button class="pin-btn pin-btn-cancel" onclick="closePINModal()">Cancelar</button>
<button class="pin-btn pin-btn-verify" id="verifyPinBtn" onclick="verifyPIN()" disabled>Verificar</button>
</div>
<div id="pinError" class="error-message" style="display: none;"></div>
</div>
</div>

<!-- Reason Modal -->
<div class="modal-overlay" id="reasonModal">
<div class="modal-content">
<h3 class="modal-title" id="modalTitle">Selecciona el motivo</h3>
<div class="reason-options" id="reasonOptions"></div>
<div class="modal-actions">
<button class="modal-btn btn-cancel" onclick="closeReasonModal()">Cancelar</button>
<button class="modal-btn btn-confirm" id="confirmBtn" onclick="confirmAction()" disabled>Confirmar</button>
</div>
</div>
</div>

<script>
// Variables globales
let currentIncident = null;
let currentTechnician = null;
let isAuthenticated = false;
let pendingAction = null;
let selectedReason = null;
let accessMode = 'none';
let allIncidents = [];
let currentStatusFilter = 'all';
let currentPriorityFilter = 'all';

// Motivos de respuesta
const rejectReasons = [
{ id: 'ocupado_otra', icon: '‚ö°', title: 'Ocupado con otra incidencia', description: 'Ya estoy resolviendo otra incidencia cr√≠tica' },
{ id: 'fuera_especialidad', icon: '‚ùì', title: 'Fuera de mi especialidad', description: 'No tengo experiencia con este tipo de equipo' },
{ id: 'no_disponible', icon: '‚è∞', title: 'No disponible ahora', description: 'Estoy en pausa, reuni√≥n o fuera de turno' },
{ id: 'falta_herramientas', icon: 'üîß', title: 'Faltan herramientas/repuestos', description: 'No tengo las herramientas necesarias disponibles' },
{ id: 'ubicacion_lejos', icon: 'üìç', title: 'Muy lejos de mi ubicaci√≥n', description: 'Estoy muy lejos de la zona de la incidencia' },
{ id: 'sobrecarga_trabajo', icon: '‚ö°', title: 'Sobrecarga de trabajo', description: 'Ya tengo demasiadas incidencias asignadas' }
];

const helpReasons = [
{ id: 'apoyo_tecnico', icon: 'ü§ù', title: 'Necesito apoyo t√©cnico', description: 'Requiero asistencia de otro t√©cnico especializado' },
{ id: 'consulta_supervisor', icon: 'üë®', title: 'Consulta con supervisor', description: 'Necesito autorizaci√≥n o gu√≠a del supervisor' },
{ id: 'herramientas_especiales', icon: 'üîß', title: 'Herramientas especiales', description: 'Requiero herramientas espec√≠ficas no disponibles' },
{ id: 'procedimiento_dudas', icon: 'üìñ', title: 'Dudas sobre procedimiento', description: 'No estoy seguro del procedimiento correcto' },
{ id: 'seguridad_riesgo', icon: '‚ö†Ô∏è', title: 'Problema de seguridad', description: 'Hay riesgos de seguridad que requieren evaluaci√≥n' },
{ id: 'repuestos_urgentes', icon: 'üì¶', title: 'Repuestos urgentes', description: 'Necesito repuestos espec√≠ficos urgentemente' }
];

// === INICIALIZACI√ìN ===
window.addEventListener('DOMContentLoaded', function() {
console.log('ABC.xyz Dashboard iniciado');
const urlParams = new URLSearchParams(window.location.search);
const email = urlParams.get('tecnico') || urlParams.get('technician_email');
const nombre = urlParams.get('nombre') || urlParams.get('technician_name');
const incidentId = urlParams.get('id') || urlParams.get('incident_id');

if (email) {
document.getElementById('emailInput').value = email;
if (nombre) {
currentTechnician = { email: email, name: decodeURIComponent(nombre) };
}
if (incidentId) {
accessMode = 'read_only';
loadTechnicianDashboard(email, false);
}
}
});

// === LOGIN ===
async function loginWithPIN() {
const email = document.getElementById('emailInput').value.trim();
if (!email || !email.includes('@')) {
showError('Email v√°lido requerido', document.getElementById('loginError'));
return;
}
showPINModal();
}

function showPINModal() {
const modal = document.getElementById('pinModal');
const pinInput = document.getElementById('pinInput');
const verifyBtn = document.getElementById('verifyPinBtn');
pinInput.value = '';
verifyBtn.disabled = true;
modal.classList.add('active');
pinInput.focus();
pinInput.oninput = () => verifyBtn.disabled = pinInput.value.length !== 4;
pinInput.onkeypress = (e) => {
if (e.key === 'Enter' && pinInput.value.length === 4) verifyPIN();
};
}

function closePINModal() {
document.getElementById('pinModal').classList.remove('active');
pendingAction = null;
}

async function verifyPIN() {
const pin = document.getElementById('pinInput').value;
const email = document.getElementById('emailInput').value;
const verifyBtn = document.getElementById('verifyPinBtn');

if (pin.length !== 4) {
showError('PIN de 4 d√≠gitos requerido', document.getElementById('pinError'));
return;
}

verifyBtn.disabled = true;
verifyBtn.textContent = 'Verificando...';

try {
const response = await fetch('/api/webhook-respuesta', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
action: 'validate_technician_pin',
technician_email: email,
technician_name: currentTechnician?.name || email.split('@')[0],
pin: pin
})
});

const data = await response.json();

if (data.status === 'success') {
isAuthenticated = true;
accessMode = 'full_access';
closePINModal();
currentTechnician = {
email: email,
name: data.technician?.name || email.split('@')[0],
department: data.technician?.department || 'N/A'
};

if (pendingAction) {
if (pendingAction === 'acepto') confirmAction();
else showReasonModal(pendingAction);
} else {
await loadTechnicianDashboard(email, true);
updateAuthStatus();
setTimeout(() => refreshIncidents(), 2000);
}
} else {
showError(data.message || 'PIN incorrecto', document.getElementById('pinError'));
}
} catch (error) {
showError('Error de conexi√≥n', document.getElementById('pinError'));
} finally {
verifyBtn.disabled = false;
verifyBtn.textContent = 'Verificar';
}
}

// === DASHBOARD ===
async function loadTechnicianDashboard(email, useFullAccess = false) {
try {
showLoading('Cargando...');
const response = await fetch('/api/webhook-respuesta', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
action: 'get_assigned_incidents',
technician_email: email,
technician_name: currentTechnician?.name || email.split('@')[0],
read_only: !useFullAccess
})
});

const data = await response.json();

if (data.status === 'success') {
if (!currentTechnician) {
currentTechnician = { email: email, name: data.technician?.name || email.split('@')[0] };
}
allIncidents = data.incidents || [];
document.getElementById('loginContainer').style.display = 'none';
document.getElementById('mainHeader').style.display = 'block';
document.getElementById('mainContainer').style.display = 'block';
document.getElementById('dashboardTitle').textContent = `- ${currentTechnician.name}`;
updateAuthStatus();
updateLastUpdate();
applyFilters();
} else {
throw new Error(data.message || 'Error cargando');
}
} catch (error) {
showError('Error de conexi√≥n', document.getElementById('loginError'));
} finally {
hideLoading();
}
}

function updateAuthStatus() {
const statusDiv = document.getElementById('authStatus');
const messageDiv = document.getElementById('authMessage');
if (accessMode === 'full_access') {
statusDiv.className = 'auth-status authenticated';
messageDiv.textContent = '‚úÖ Autenticado';
} else if (accessMode === 'read_only') {
statusDiv.className = 'auth-status read-only';
messageDiv.textContent = 'üëÅÔ∏è Solo lectura';
} else {
statusDiv.className = 'auth-status';
messageDiv.textContent = '‚ö†Ô∏è Sin autenticar';
}
}

function updateLastUpdate() {
const now = new Date();
const timeString = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
document.getElementById('lastUpdate').textContent = timeString;
}

// === FILTROS ===
function filterByStatus(status, btn) {
currentStatusFilter = status;
btn.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
btn.classList.add('active');
applyFilters();
}

function filterByPriority(priority, btn) {
currentPriorityFilter = priority;
btn.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
btn.classList.add('active');
applyFilters();
}

function applyFilters() {
const urlParams = new URLSearchParams(window.location.search);
const specificIncidentId = urlParams.get('id') || urlParams.get('incident_id');

if (specificIncidentId) {
const incident = allIncidents.find(inc => inc.id === specificIncidentId);
if (incident) {
renderSingleIncident(incident);
return;
} else {
document.getElementById('incidentsContainer').innerHTML = 
createNoIncidentsHTML('No Encontrada', '‚ùì', `Incidencia ${specificIncidentId} no existe`);
return;
}
}

const classified = classifyIncidents(allIncidents);
let toShow = [];

if (currentStatusFilter === 'pending') toShow = classified.pending;
else if (currentStatusFilter === 'working') toShow = classified.working;
else if (currentStatusFilter === 'expired') toShow = classified.expired;
else toShow = [...classified.pending, ...classified.working, ...classified.expired];

if (currentPriorityFilter !== 'all') {
toShow = toShow.filter(inc => inc.priority && inc.priority.includes(currentPriorityFilter));
}

toShow.sort((a, b) => {
const dateA = new Date(a.date_reported || '2024-01-01');
const dateB = new Date(b.date_reported || '2024-01-01');
return dateB - dateA;
});

updateStats(classified);
renderIncidentsGrid(toShow, classified);
}

function classifyIncidents(incidents) {
const pending = [];
const working = [];
const expired = [];

incidents.forEach(incident => {
if (!isAssignedToMe(incident)) return;

if (incident.assigned_technician && incident.assigned_technician !== 'Sin asignar' &&
incident.assigned_technician !== '' && incident.assigned_technician === currentTechnician.name) {
working.push(incident);
} else {
const timeElapsed = incident.time_elapsed || 0;
const escalationLevel = incident.escalation_level || 0;
const escalationPaused = incident.escalation_paused === 'true';

let isExpired = false;
if (!escalationPaused) {
let slaMinutes = 30;
if (getIncidentLevel(incident) === 'L1') slaMinutes = 45;
if (getIncidentLevel(incident) === 'L2') slaMinutes = 60;
isExpired = timeElapsed > slaMinutes;
}

let hasResponded = false;
const level = getIncidentLevel(incident);
if (level === 'L0' && incident.l0_response && incident.l0_response !== '‚≠ï Sin Respuesta') {
hasResponded = true;
} else if (level === 'L1' && incident.l1_response && incident.l1_response !== '‚≠ï Sin Respuesta') {
hasResponded = true;
} else if (level === 'L2' && incident.l2_responses && incident.l2_responses !== '') {
hasResponded = true;
}

if (hasResponded || isExpired || escalationLevel > getCurrentEscalationLevel(incident)) {
expired.push(incident);
} else {
pending.push(incident);
}
}
});

return { pending, working, expired };
}

function isAssignedToMe(incident) {
const email = currentTechnician?.email;
if (!email) return false;

return (
incident.l0_technician === email ||
incident.l1_technician === email ||
(incident.l2_technicians_notified && incident.l2_technicians_notified.includes(email)) ||
(incident.l2_technicians && incident.l2_technicians.includes(email)) ||
incident.assigned_technician === email
);
}

function getIncidentLevel(incident) {
const email = currentTechnician?.email;
if (!email) return 'L0';

if (incident.l0_technician === email) return 'L0';
if (incident.l1_technician === email) return 'L1';
if (incident.l2_technicians_notified && incident.l2_technicians_notified.includes(email)) return 'L2';
if (incident.l2_technicians && incident.l2_technicians.includes(email)) return 'L2';
return 'L0';
}

function getCurrentEscalationLevel(incident) {
const email = currentTechnician?.email;
if (incident.l0_technician === email) return 0;
if (incident.l1_technician === email) return 1;
if (incident.l2_technicians_notified && incident.l2_technicians_notified.includes(email)) return 2;
if (incident.l2_technicians && incident.l2_technicians.includes(email)) return 2;
return 0;
}

function updateStats(classified) {
document.getElementById('pendingCount').textContent = classified.pending.length;
document.getElementById('workingCount').textContent = classified.working.length;
document.getElementById('expiredCount').textContent = classified.expired.length;
}

// === RENDERIZADO ===
function renderIncidentsGrid(incidents, classified) {
const container = document.getElementById('incidentsContainer');

if (incidents.length === 0) {
container.innerHTML = createNoIncidentsHTML('Sin Incidencias', '‚úÖ', 'No hay incidencias que coincidan con los filtros aplicados');
return;
}

let html = '';
incidents.forEach(incident => {
const type = classified.pending.includes(incident) ? 'pending' :
classified.working.includes(incident) ? 'working' : 'expired';
html += renderIncidentCard(incident, type);
});

container.innerHTML = html;
startAllSLATimers();
}

function renderSingleIncident(incident) {
const container = document.getElementById('incidentsContainer');
currentIncident = incident;

const classified = classifyIncidents([incident]);
const type = classified.pending.includes(incident) ? 'pending' :
classified.working.includes(incident) ? 'working' : 'expired';

container.innerHTML = renderIncidentCard(incident, type);
startAllSLATimers();
}

function renderIncidentCard(incident, type) {
const priorityClass = getPriorityClass(incident.priority);
const level = getIncidentLevel(incident);

// Informaci√≥n de respuesta
let responseInfo = '';
if (level === 'L0' && incident.l0_response && incident.l0_response !== '‚≠ï Sin Respuesta') {
responseInfo += `<div class="info-row response"><span>Respuesta L0:</span><span>${incident.l0_response}</span></div>`;
if (incident.l0_response.includes('Rechazado') && incident.l0_reject_reason !== 'Sin motivo') {
responseInfo += `<div class="info-row"><span>Motivo:</span><span>${incident.l0_reject_reason}</span></div>`;
}
} else if (level === 'L1' && incident.l1_response && incident.l1_response !== '‚≠ï Sin Respuesta') {
responseInfo += `<div class="info-row response"><span>Respuesta L1:</span><span>${incident.l1_response}</span></div>`;
if (incident.l1_response.includes('Rechazado') && incident.l1_reject_reason !== 'Sin motivo') {
responseInfo += `<div class="info-row"><span>Motivo:</span><span>${incident.l1_reject_reason}</span></div>`;
}
} else if (level === 'L2' && incident.l2_responses && incident.l2_responses !== '') {
responseInfo += `<div class="info-row response"><span>Respuestas L2:</span><span>${incident.l2_responses}</span></div>`;
}

// Timer/Estado
let timerContent = '';
if (type === 'pending') {
const slaEnd = getSlaEndTime(incident);
if (slaEnd) {
timerContent = `
<div class="sla-section">
<div class="sla-time" id="timer-${incident.id}">--:--</div>
<div class="sla-label">Tiempo restante para responder</div>
<div class="sla-level">NIVEL ${level}</div>
</div>`;
}
} else if (type === 'expired') {
const timeElapsed = incident.time_elapsed || 0;
const hoursElapsed = Math.floor(timeElapsed / 60);
const minutesElapsed = timeElapsed % 60;

timerContent = `
<div class="expired-section">
<div class="expired-time">‚è∞ Hace ${hoursElapsed}h ${minutesElapsed}m</div>
<div class="expired-label">VENCIDA - SLA SUPERADO</div>
</div>`;

const escalationLevel = incident.escalation_level || 0;
const escalationPaused = incident.escalation_paused === 'true';

let escalationInfo = '';
if (escalationPaused) {
escalationInfo = 'üö¶ Escalado pausado por supervisor';
} else if (escalationLevel > 0) {
escalationInfo = `‚ö†Ô∏è Escalado a nivel L${escalationLevel} - Contacta por tel√©fono`;
} else {
escalationInfo = '‚ö†Ô∏è Incidencia vencida - Contacta por tel√©fono';
}

if (escalationInfo) {
timerContent += `<div class="escalation-info">${escalationInfo}</div>`;
}
}

// Botones de acci√≥n
let actionContent = '';
if (type === 'pending') {
const canRespond = (accessMode === 'full_access');
const lockClass = canRespond ? '' : ' locked';
const acceptText = canRespond ? '‚úÖ ACEPTO' : 'üîí ACEPTO';
const rejectText = canRespond ? '‚ùå RECHAZO' : 'üîí RECHAZO';
const helpText = canRespond ? 'üÜò AYUDA' : 'üîí AYUDA';

actionContent = `
<div class="actions-section">
<div class="action-buttons">
<button class="action-btn btn-accept${lockClass}" onclick="handleAction('acepto', '${incident.id}')">
${acceptText}
</button>
<button class="action-btn btn-reject${lockClass}" onclick="handleAction('rechazo', '${incident.id}')">
${rejectText}
</button>
</div>
<button class="action-btn btn-help${lockClass}" onclick="handleAction('ayuda', '${incident.id}')">
${helpText}
</button>
</div>`;
} else if (type === 'working') {
const canRespond = (accessMode === 'full_access');
const lockClass = canRespond ? '' : ' locked';
const helpText = canRespond ? 'üÜò SOLICITAR AYUDA' : 'üîí AYUDA';

actionContent = `
<div class="actions-section">
<button class="action-btn btn-help${lockClass}" onclick="handleAction('ayuda', '${incident.id}')">
${helpText}
</button>
</div>`;
} else if (type === 'expired') {
actionContent = '<div class="phone-section">';

const contacts = [];
if (incident.supervisor_phone && incident.supervisor_phone !== 'Sin tel√©fono') {
contacts.push({
name: incident.supervisor || 'Supervisor',
phone: incident.supervisor_phone,
type: 'supervisor',
icon: 'üë®‚Äçüíº'
});
}

if (incident.manager_phone && incident.manager_phone !== 'Sin tel√©fono') {
contacts.push({
name: incident.manager || 'Encargado',
phone: incident.manager_phone, 
type: 'manager',
icon: 'üëî'
});
}

if (incident.reporter_phone && incident.reporter_phone !== 'Sin tel√©fono') {
contacts.push({
name: incident.reporter || 'Reportador',
phone: incident.reporter_phone,
type: 'reporter', 
icon: 'üìã'
});
}

contacts.forEach(contact => {
const btnClass = contact.type === 'supervisor' ? 'supervisor' : '';
actionContent += `
<div class="contact-item">
<span class="contact-name">
${contact.icon} ${contact.name}
</span>
<a href="tel:${contact.phone}" class="phone-btn ${btnClass}">
üìû Llamar
</a>
</div>`;
});

if (contacts.length === 0) {
actionContent += '<div class="contact-item"><span class="contact-name">‚ö†Ô∏è No hay tel√©fonos disponibles</span></div>';
}

actionContent += '</div>';
}

// Info adicional
let additionalInfo = '';
if (incident.status && incident.status !== 'üÜï Nueva') {
additionalInfo += `<div class="info-row status"><span>Estado:</span><span>${incident.status}</span></div>`;
}
if (incident.assigned_technician && incident.assigned_technician !== 'Sin asignar' && incident.assigned_technician !== '') {
additionalInfo += `<div class="info-row assigned"><span>üë§ Asignado:</span><span>${incident.assigned_technician}</span></div>`;
}

return `
<div class="incident-card ${type}" data-incident-id="${incident.id}">
<div class="incident-header">
<div class="incident-id">${incident.id}</div>
<div class="priority-badge priority-${priorityClass}">${incident.priority || 'MEDIA'}</div>
</div>

<div class="incident-content">
<div class="incident-title">${incident.equipment || 'Equipo no especificado'}</div>
<div class="incident-zone">üìç ${incident.zone || 'Sin zona'}</div>
<div class="incident-description">${incident.description || 'Sin descripci√≥n disponible'}</div>

<div class="info-section">
${additionalInfo}
${responseInfo}
</div>
</div>

${timerContent}
${actionContent}
</div>`;
}

function getPriorityClass(priority) {
if (!priority) return 'media';
const p = priority.toLowerCase();
if (p.includes('cr√≠tica') || p.includes('critical')) return 'critica';
if (p.includes('alta') || p.includes('high')) return 'alta';
if (p.includes('media') || p.includes('medium')) return 'media';
if (p.includes('baja') || p.includes('low')) return 'baja';
return 'media';
}

function getSlaEndTime(incident) {
const level = getIncidentLevel(incident);
if (level === 'L0') return incident.sla_l0_end;
if (level === 'L1') return incident.sla_l1_backup_end;
if (level === 'L2') return incident.sla_l2_equipo_end;
return incident.sla_l0_end;
}

// === TIMERS ===
function startAllSLATimers() {
document.querySelectorAll('[id^="timer-"]').forEach(timer => {
const incidentId = timer.id.replace('timer-', '');
const incident = allIncidents.find(inc => inc.id === incidentId);
if (incident) {
const slaEnd = getSlaEndTime(incident);
if (slaEnd) {
startSLATimer(slaEnd, timer.id);
}
}
});
}

function startSLATimer(slaEndTime, timerId) {
function updateTimer() {
const now = new Date();
const end = new Date(slaEndTime);
const diff = end - now;

const timerElement = document.getElementById(timerId);
if (!timerElement) return;

if (diff <= 0) {
timerElement.textContent = '00:00';
timerElement.className = 'sla-time critical';
return;
}

const totalMinutes = Math.floor(diff / 60000);
const hours = Math.floor(totalMinutes / 60);
const minutes = totalMinutes % 60;
const seconds = Math.floor((diff % 60000) / 1000);

let timeText;
if (hours > 0) {
timeText = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
} else {
timeText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

timerElement.textContent = timeText;

const totalSLATime = 30 * 60 * 1000;
const percentage = (diff / totalSLATime) * 100;

if (percentage > 50) {
timerElement.className = 'sla-time good';
} else if (percentage > 20) {
timerElement.className = 'sla-time warning';
} else {
timerElement.className = 'sla-time critical';
}
}

updateTimer();
setInterval(updateTimer, 1000);
}

// === ACCIONES ===
function handleAction(action, incidentId) {
currentIncident = allIncidents.find(inc => inc.id === incidentId);
if (!currentIncident) {
console.error('Incidencia no encontrada:', incidentId);
return;
}

if (accessMode !== 'full_access') {
pendingAction = action;
showPINModal();
return;
}

if (action === 'acepto') {
confirmAction();
} else {
showReasonModal(action);
}
}

function showReasonModal(action) {
pendingAction = action;
selectedReason = null;

const modal = document.getElementById('reasonModal');
const title = document.getElementById('modalTitle');
const options = document.getElementById('reasonOptions');
const confirmBtn = document.getElementById('confirmBtn');

let reasons = [];
switch(action) {
case 'rechazo':
title.textContent = '‚ùå Motivo del Rechazo';
reasons = rejectReasons;
confirmBtn.textContent = 'Rechazar';
break;
case 'ayuda':
title.textContent = 'üÜò Tipo de Ayuda Requerida';
reasons = helpReasons;
confirmBtn.textContent = 'Solicitar Ayuda';
break;
}

options.innerHTML = reasons.map(reason => `
<div class="reason-option" onclick="selectReason('${reason.id}')">
<div class="reason-icon">${reason.icon}</div>
<div class="reason-text">
<div class="reason-title">${reason.title}</div>
<div class="reason-description">${reason.description}</div>
</div>
</div>
`).join('');

confirmBtn.disabled = true;
modal.classList.add('active');
}

function selectReason(reasonId) {
selectedReason = reasonId;

document.querySelectorAll('.reason-option').forEach(option => {
option.classList.remove('selected');
});

event.currentTarget.classList.add('selected');
document.getElementById('confirmBtn').disabled = false;
}

function closeReasonModal() {
document.getElementById('reasonModal').classList.remove('active');
pendingAction = null;
selectedReason = null;
}

async function confirmAction() {
if (!pendingAction || !currentIncident) return;

const confirmBtn = document.getElementById('confirmBtn');
const originalText = confirmBtn?.textContent || 'Confirmar';

try {
if (confirmBtn) {
confirmBtn.disabled = true;
confirmBtn.textContent = 'Procesando...';
}

const response = await fetch('/api/webhook-respuesta', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
action: pendingAction,
incident_id: currentIncident.id,
technician_email: currentTechnician.email,
technician_name: currentTechnician.name,
reason: selectedReason,
escalation_level: getCurrentEscalationLevel(currentIncident)
})
});

const data = await response.json();

if (data.status === 'success') {
closeReasonModal();
showSuccessMessage(data);
} else {
throw new Error(data.message || 'Error procesando respuesta');
}

} catch (error) {
console.error('Error enviando respuesta:', error);
showError('Error de conexi√≥n. Int√©ntalo m√°s tarde.');
} finally {
if (confirmBtn) {
confirmBtn.disabled = false;
confirmBtn.textContent = originalText;
}
}
}

function showSuccessMessage(data) {
const messages = {
'acepto': '‚úÖ Incidencia aceptada correctamente. ¬°Puedes empezar a trabajar!',
'rechazo': '‚ùå Incidencia rechazada. Se escalar√° autom√°ticamente.',
'ayuda': 'üÜò Ayuda solicitada. Un supervisor se pondr√° en contacto contigo.'
};

const icons = {
'acepto': '‚úÖ',
'rechazo': '‚ùå', 
'ayuda': 'üÜò'
};

const makeMessage = data.message || messages[pendingAction];
const actionIcon = icons[pendingAction];

const overlay = document.getElementById('successOverlay');
const iconElement = document.getElementById('successIcon');
const titleElement = document.getElementById('successTitle');
const descriptionElement = document.getElementById('successDescription');
const countdownElement = document.getElementById('countdown');

iconElement.textContent = actionIcon;
titleElement.textContent = 'Acci√≥n Completada';
descriptionElement.textContent = makeMessage;

let countdown = 5;
countdownElement.textContent = `Actualizando en ${countdown} segundos...`;

overlay.style.display = 'flex';

const countdownInterval = setInterval(() => {
countdown--;
if (countdown > 0) {
countdownElement.textContent = `Actualizando en ${countdown} segundos...`;
} else {
clearInterval(countdownInterval);
overlay.style.display = 'none';
refreshIncidents();
}
}, 1000);

overlay.onclick = function(e) {
if (e.target === overlay) {
clearInterval(countdownInterval);
overlay.style.display = 'none';
refreshIncidents();
}
};
}

// === UTILIDADES ===
async function refreshIncidents() {
if (!currentTechnician) return;
const btn = document.getElementById('refreshBtn');
btn.disabled = true;
btn.textContent = 'Actualizando...';
try {
await loadTechnicianDashboard(currentTechnician.email, accessMode === 'full_access');
} finally {
btn.disabled = false;
btn.textContent = 'üîÑ Actualizar';
}
}

function showLoading(msg = 'Cargando...') {
document.getElementById('incidentsContainer').innerHTML = `<div class="loading"><div class="spinner"></div><div>${msg}</div></div>`;
}

function hideLoading() {}

function createNoIncidentsHTML(title, icon, desc) {
return `<div class="no-incidents"><div class="no-incidents-icon">${icon}</div><h3 class="no-incidents-title">${title}</h3><p class="no-incidents-description">${desc}</p></div>`;
}

function showError(msg, el) {
if (el) {
el.textContent = msg;
el.style.display = 'block';
} else {
console.error('Error:', msg);
}
}

// === EVENTOS ===
document.addEventListener('keydown', (e) => {
if (e.key === 'Enter' && document.getElementById('loginContainer').style.display !== 'none') {
const input = document.getElementById('emailInput');
if (input.value.trim()) loginWithPIN();
}
if (e.key === 'Escape') {
closeReasonModal();
closePINModal();
}
});

document.getElementById('reasonModal').addEventListener('click', (e) => {
if (e.target === e.currentTarget) closeReasonModal();
});

document.getElementById('pinModal').addEventListener('click', (e) => {
if (e.target === e.currentTarget) closePINModal();
});

console.log('Dashboard ABC.xyz cargado');
</script>
</body>
</html>
