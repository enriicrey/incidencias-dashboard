<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard T√©cnico - Sistema de Incidencias ABC.xyz</title>
    <style>
        /* ========================================
           VARIABLES CSS Y RESET
        ======================================== */
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2c3e50;
            --success-color: #22c55e;
            --success-dark: #16a34a;
            --warning-color: #f59e0b;
            --warning-dark: #d97706;
            --danger-color: #ef4444;
            --danger-dark: #dc2626;
            --info-color: #3b82f6;
            --info-dark: #2563eb;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --border-radius: 12px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.15);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-800);
        }

        /* ========================================
           LOGIN COMPONENTS
        ======================================== */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow-lg);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: var(--gray-500);
            margin-bottom: 30px;
            font-size: 16px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 14px;
        }

        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--gray-200);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .verify-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .verify-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .verify-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .error-message {
            background: #fee;
            color: var(--danger-color);
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
        }

        /* ========================================
           HEADER
        ======================================== */
        .header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 20px 0;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .refresh-button {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .refresh-button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.25);
        }

        .refresh-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ========================================
           MAIN CONTAINER
        ======================================== */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
            background: #f8fafc;
            min-height: calc(100vh - 80px);
        }

        /* ========================================
           STATS BAR
        ======================================== */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-card.active {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, #e3f2fd, #ffffff);
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-number.pending { color: var(--warning-color); }
        .stat-number.working { color: var(--success-color); }
        .stat-number.expired { color: var(--danger-color); }
        .stat-number.seguimiento { color: var(--info-color); }

        .stat-label {
            color: var(--gray-500);
            font-size: 14px;
            font-weight: 500;
        }

        /* ========================================
           FILTERS BAR
        ======================================== */
        .filters-bar {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-label {
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 14px;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--gray-300);
            border-radius: 20px;
            background: white;
            color: var(--gray-500);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-btn.active,
        .filter-btn:hover {
            background: var(--info-color);
            border-color: var(--info-color);
            color: white;
        }

        /* ========================================
           INCIDENTS GRID
        ======================================== */
        .incidents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            width: 100%;
        }

        /* ========================================
           INCIDENT CARDS
        ======================================== */
        .incident-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            min-width: 450px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .incident-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-3px);
            border-color: var(--primary-color);
        }

        .incident-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-100);
        }

        .incident-title h4 {
            margin: 0 0 10px 0;
            color: var(--gray-800);
            font-size: 1.2rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .priority-badge {
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .incident-id {
            font-size: 13px;
            color: var(--gray-500);
            background: var(--gray-50);
            padding: 6px 10px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .incident-body {
            margin-bottom: 20px;
        }

        .zone {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray-700);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            background: var(--gray-100);
            padding: 8px 12px;
            border-radius: 8px;
        }

        .description {
            color: var(--gray-500);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 15px;
            background: #fafbfc;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid var(--gray-200);
        }

        /* ========================================
           INFO COMPONENTS
        ======================================== */
        .technician-info {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 12px 16px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 14px;
            border-left: 4px solid #0ea5e9;
        }

        .technician-info.current-tech {
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            border-left-color: var(--success-color);
            color: #065f46;
            font-weight: 600;
        }

        .contacts-info {
            background: linear-gradient(135deg, #fefce8, #fef3c7);
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid #eab308;
        }

        .contacts-header {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contacts-header:hover {
            color: #78350f;
        }

        .contacts-list {
            margin-top: 10px;
            display: none;
        }

        .contacts-list div {
            margin: 6px 0;
            font-size: 13px;
            color: #713f12;
        }

        .contacts-list a {
            color: var(--info-dark);
            text-decoration: none;
            font-weight: 600;
        }

        .contacts-list a:hover {
            text-decoration: underline;
        }

        .time-elapsed {
            background: linear-gradient(135deg, #fdf4ff, #fae8ff);
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 8px;
            color: #7c2d92;
            font-size: 14px;
            border-left: 4px solid #a855f7;
        }

        .actions-taken {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            color: #166534;
            font-size: 14px;
            line-height: 1.4;
            border-left: 4px solid var(--success-color);
        }

        /* ========================================
           ESCALATION HISTORY
        ======================================== */
        .escalation-history {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            margin: 15px 0;
            overflow: hidden;
        }

        .escalation-header {
            background: #e2e8f0;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #475569;
            transition: background 0.3s ease;
        }

        .escalation-header:hover {
            background: #cbd5e1;
        }

        .escalation-content {
            display: none;
            padding: 15px;
        }

        .escalation-level {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }

        .escalation-level.completed {
            background: #f0f9ff;
            border-left: 4px solid var(--success-color);
        }

        .escalation-level.current {
            background: #fff7ed;
            border-left: 4px solid var(--warning-color);
        }

        .escalation-level.pending {
            background: #f8fafc;
            border-left: 4px solid #94a3b8;
        }

        .escalation-level.expired {
            background: #fef2f2;
            border-left: 4px solid var(--danger-color);
        }

        .escalation-level.escalated {
            background: #f3f4f6;
            border-left: 4px solid var(--gray-500);
        }

        .level-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--gray-700);
        }

        .level-details {
            font-size: 14px;
            color: var(--gray-500);
            line-height: 1.4;
        }

        /* ========================================
           SLA TIMERS
        ======================================== */
        .sla-timer {
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sla-timer.sla-good {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border: 1px solid var(--success-color);
        }

        .sla-timer.sla-warning {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border: 1px solid var(--warning-color);
        }

        .sla-timer.sla-critical {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #991b1b;
            border: 1px solid var(--danger-color);
            animation: pulse 2s infinite;
        }

        .sla-expired {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            color: #991b1b;
            padding: 12px 16px;
            border-radius: 10px;
            font-weight: 700;
            border: 2px solid var(--danger-color);
            animation: pulse 2s infinite;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* ========================================
           ACTION BUTTONS
        ======================================== */
        .incident-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-100);
        }

        .incident-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .incident-actions .btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), var(--success-dark));
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(34, 197, 94, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), var(--danger-dark));
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), var(--warning-dark));
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(245, 158, 11, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color), var(--info-dark));
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(59, 130, 246, 0.3);
        }

        .no-action-info {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 8px;
            color: #64748b;
            font-style: italic;
            border: 1px solid var(--gray-200);
        }

        /* ========================================
           NO INCIDENTS MESSAGE
        ======================================== */
        .no-incidents {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-500);
        }

        .no-incidents-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .no-incidents h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--gray-700);
        }

        .no-incidents p {
            font-size: 16px;
            color: var(--gray-500);
        }

        /* ========================================
           MODALS
        ======================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content,
        .pin-modal {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.8);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal-content,
        .modal-overlay.active .pin-modal {
            transform: scale(1);
        }

        .modal-title,
        .pin-modal-title {
            font-size: 20px;
            color: var(--gray-800);
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
        }

        .reason-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }

        .reason-option {
            padding: 15px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .reason-option:hover {
            border-color: var(--gray-700);
            background: var(--gray-50);
        }

        .reason-option.selected {
            border-color: var(--info-color);
            background: #eff6ff;
        }

        .reason-icon {
            font-size: 24px;
            min-width: 30px;
        }

        .reason-text {
            flex: 1;
        }

        .reason-title {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 3px;
        }

        .reason-description {
            font-size: 13px;
            color: var(--gray-500);
        }

        .custom-reason-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            margin-top: 10px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .custom-reason-input:focus {
            outline: none;
            border-color: var(--info-color);
        }

        .modal-actions,
        .pin-actions {
            display: flex;
            gap: 15px;
        }

        .modal-btn,
        .pin-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-cancel,
        .pin-btn-cancel {
            background: var(--gray-50);
            color: var(--gray-500);
            border: 1px solid var(--gray-300);
        }

        .btn-confirm,
        .pin-btn-verify {
            background: var(--gray-700);
            color: white;
        }

        .btn-confirm:disabled,
        .pin-btn-verify:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }

        .pin-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            font-size: 18px;
            text-align: center;
            letter-spacing: 8px;
            margin-bottom: 20px;
        }

        .pin-input:focus {
            outline: none;
            border-color: var(--info-color);
        }

        /* ========================================
           SUCCESS OVERLAY
        ======================================== */
        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .success-message {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .success-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .success-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 10px;
        }

        .success-description {
            color: var(--gray-500);
            margin-bottom: 20px;
        }

        .countdown {
            font-size: 14px;
            color: var(--gray-400);
        }

        /* ========================================
           BADGES
        ======================================== */
        .badge {
            padding: 4px 8px;
            border-radius: var(--border-radius);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }

        .bg-success { background: var(--success-color); color: white; }
        .bg-warning { background: var(--warning-color); color: white; }
        .bg-danger { background: var(--danger-color); color: white; }
        .bg-info { background: var(--info-color); color: white; }
        .bg-secondary { background: var(--gray-500); color: white; }
        .bg-light { background: var(--gray-100); color: var(--gray-700); }

        .toggle-icon {
            font-size: 14px;
            transition: transform 0.3s ease;
        }

        .escalation-header:hover .toggle-icon,
        .contacts-header:hover .toggle-icon {
            transform: scale(1.2);
        }

        .sla-badge {
            padding: 4px 8px;
            border-radius: var(--border-radius);
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }

        .sla-badge.sla-good {
            background: var(--success-color);
            color: white;
        }

        .sla-badge.sla-warning {
            background: var(--warning-color);
            color: white;
        }

        .sla-badge.sla-critical {
            background: var(--danger-color);
            color: white;
            animation: pulse 1s infinite;
        }

        /* ========================================
           RESPONSIVE DESIGN
        ======================================== */
        @media (max-width: 1200px) {
            .incidents-grid {
                grid-template-columns: 1fr;
            }

            .incident-card {
                min-width: auto;
                max-width: none;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 15px;
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .filters-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .incidents-grid {
                gap: 20px;
            }

            .incident-card {
                padding: 20px;
            }

            .incident-actions {
                flex-direction: column;
            }

            .incident-actions .btn {
                min-width: auto;
            }
        }

        /* ========================================
           UTILITY CLASSES
        ======================================== */
        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .text-center {
            text-align: center;
        }

        .mt-4 { margin-top: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .p-4 { padding: 1rem; }
    </style>
</head>
<body>
    <!-- LOGIN CONTAINER -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <h1 class="login-title">
                <span>üîß</span>
                <span>Dashboard T√©cnico</span>
            </h1>
            <p class="login-subtitle">Sistema de Incidencias ABC.xyz</p>

            <div class="input-group">
                <label class="input-label" for="emailInput">Email corporativo</label>
                <input 
                    type="email" 
                    id="emailInput" 
                    class="input-field" 
                    placeholder="tecnico@abc.xyz"
                    autocomplete="email"
                >
            </div>

            <button class="verify-btn" id="loginBtn" onclick="loginWithPIN()">
                Acceder con PIN
            </button>

            <div id="loginError" class="error-message hidden">
                Error de autenticaci√≥n. Verifica tus credenciales.
            </div>
        </div>
    </div>

    <!-- DASHBOARD PRINCIPAL -->
    <div id="dashboardContainer" class="hidden">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span>üîß</span>
                    <span>Dashboard T√©cnico ABC.xyz</span>
                </div>
                <div class="user-info">
                    <span id="userEmail">usuario@abc.xyz</span>
                    <span>|</span>
                    <span id="userRole">T√©cnico L0</span>
                    <button class="refresh-button" id="refreshBtn" onclick="refreshDashboard()">
                        üîÑ Actualizar
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Container -->
        <main class="main-container">
            <!-- Stats Bar -->
            <section class="stats-bar">
                <div class="stat-card active" onclick="filterByStatus('all', this)">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card" onclick="filterByStatus('pending', this)">
                    <div class="stat-number pending" id="pendingCount">0</div>
                    <div class="stat-label">Pendientes</div>
                </div>
                <div class="stat-card" onclick="filterByStatus('working', this)">
                    <div class="stat-number working" id="workingCount">0</div>
                    <div class="stat-label">Trabajando</div>
                </div>
                <div class="stat-card" onclick="filterByStatus('expired', this)">
                    <div class="stat-number expired" id="expiredCount">0</div>
                    <div class="stat-label">Vencidas</div>
                </div>
                <div class="stat-card" onclick="filterByStatus('seguimiento', this)">
                    <div class="stat-number seguimiento" id="seguimientoCount">0</div>
                    <div class="stat-label">Seguimiento</div>
                </div>
            </section>

            <!-- Filters Bar -->
            <section class="filters-bar">
                <div class="filter-group">
                    <span class="filter-label">Prioridad:</span>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterByPriority('all', this)">Todas</button>
                        <button class="filter-btn" onclick="filterByPriority('CR√çTICA', this)">Cr√≠tica</button>
                        <button class="filter-btn" onclick="filterByPriority('ALTA', this)">Alta</button>
                        <button class="filter-btn" onclick="filterByPriority('MEDIA', this)">Media</button>
                        <button class="filter-btn" onclick="filterByPriority('BAJA', this)">Baja</button>
                    </div>
                </div>
            </section>

            <!-- Incidents Container -->
            <section id="incidentsContainer">
                <div class="no-incidents">
                    <div class="no-incidents-icon">üìã</div>
                    <h3>Cargando incidencias...</h3>
                    <p>Por favor, espera mientras se cargan tus incidencias.</p>
                </div>
            </section>
        </main>
    </div>

    <!-- MODAL PARA MOTIVOS -->
    <div class="modal-overlay" id="reasonModal">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">Selecciona un motivo</h3>
            <div class="reason-options" id="reasonOptions">
                <!-- Opciones generadas din√°micamente -->
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeReasonModal()">Cancelar</button>
                <button class="modal-btn btn-confirm" id="confirmBtn" onclick="confirmAction()" disabled>Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PIN -->
    <div class="modal-overlay" id="pinModal">
        <div class="pin-modal">
            <h3 class="pin-modal-title">Verificaci√≥n de Identidad</h3>
            <p style="text-align: center; color: var(--gray-500); margin-bottom: 20px;">
                Ingresa tu PIN de 4 d√≠gitos para continuar
            </p>
            <input type="password" class="pin-input" id="pinInput" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <div class="pin-actions">
                <button class="pin-btn pin-btn-cancel" onclick="closePINModal()">Cancelar</button>
                <button class="pin-btn pin-btn-verify" id="verifyPinBtn" onclick="verifyPIN()" disabled>Verificar</button>
            </div>
            <div id="pinError" class="error-message hidden">PIN incorrecto. Intenta de nuevo.</div>
        </div>
    </div>

    <!-- SUCCESS OVERLAY -->
    <div class="success-overlay" id="successOverlay" style="display: none;">
        <div class="success-message">
            <div class="success-icon" id="successIcon">‚úÖ</div>
            <div class="success-title" id="successTitle">Acci√≥n Completada</div>
            <div class="success-description" id="successDescription">La operaci√≥n se ha realizado correctamente.</div>
            <div class="countdown" id="countdown">Actualizando en 3 segundos...</div>
        </div>
    </div>

    <script>
        /* ========================================
           CONFIGURACI√ìN GLOBAL Y CONSTANTES
        ======================================== */
        const CONFIG = {
            API_INCIDENTS: '/api/webhook-respuesta',
            API_RESPONSE: '/api/webhook-respuesta',
            REFRESH_INTERVAL: 60000,
            SLA_UPDATE_INTERVAL: 30000,
            MAX_RETRY_ATTEMPTS: 3,
            RETRY_DELAY: 2000
        };

        // Variables globales
        let allIncidents = [];
        let currentTechnician = null;
        let currentStatusFilter = 'all';
        let currentPriorityFilter = 'all';
        let refreshInterval = null;
        let slaTimerInterval = null;
        let pendingAction = null;
        let currentIncident = null;
        let selectedReason = null;
        let customText = '';
        let accessMode = 'full';

        /* ========================================
           CONFIGURACI√ìN DE MOTIVOS
        ======================================== */
        const rejectReasons = [
            {
                id: 'no_tengo_herramientas',
                icon: 'üîß',
                title: 'No tengo las herramientas necesarias',
                description: 'Requiere herramientas espec√≠ficas que no est√°n disponibles'
            },
            {
                id: 'no_tengo_conocimiento',
                icon: 'üìö',
                title: 'No tengo el conocimiento t√©cnico',
                description: 'La incidencia requiere conocimientos especializados'
            },
            {
                id: 'fuera_de_horario',
                icon: 'üïê',
                title: 'Est√° fuera de mi horario laboral',
                description: 'La incidencia se asign√≥ fuera del horario de trabajo'
            },
            {
                id: 'sobrecarga_trabajo',
                icon: 'üìä',
                title: 'Tengo sobrecarga de trabajo',
                description: 'Actualmente trabajando en m√∫ltiples incidencias cr√≠ticas'
            },
            {
                id: 'ubicacion_lejana',
                icon: 'üìç',
                title: 'Ubicaci√≥n muy lejana',
                description: 'La ubicaci√≥n est√° fuera de mi zona de cobertura'
            },
            {
                id: 'otro_motivo_rechazo',
                icon: 'üí¨',
                title: 'Otro motivo',
                description: 'Especifica el motivo del rechazo',
                requiresText: true
            }
        ];

        const helpReasonsInitial = [
            {
                id: 'dudas_diagnostico',
                icon: 'üîç',
                title: 'Tengo dudas sobre el diagn√≥stico',
                description: 'Necesito orientaci√≥n para identificar la causa'
            },
            {
                id: 'procedimiento_complejo',
                icon: '‚öôÔ∏è',
                title: 'El procedimiento es muy complejo',
                description: 'Requiero supervisi√≥n para realizar la reparaci√≥n'
            },
            {
                id: 'componente_desconocido',
                icon: '‚ùì',
                title: 'No conozco este componente',
                description: 'Es la primera vez que trabajo con este equipo'
            },
            {
                id: 'riesgo_seguridad',
                icon: '‚ö†Ô∏è',
                title: 'Hay riesgos de seguridad',
                description: 'La intervenci√≥n presenta riesgos que requieren supervisi√≥n'
            },
            {
                id: 'otra_ayuda_inicial',
                icon: 'üí¨',
                title: 'Otro tipo de ayuda',
                description: 'Especifica qu√© tipo de ayuda necesitas',
                requiresText: true
            }
        ];

        const transferReasons = [
            {
                id: 'especialista_requerido',
                icon: 'üë®‚Äçüî¨',
                title: 'Se requiere un especialista',
                description: 'La incidencia necesita conocimientos espec√≠ficos'
            },
            {
                id: 'equipo_especializado',
                icon: 'üîß',
                title: 'Se necesita equipo especializado',
                description: 'Requiere herramientas que no est√°n disponibles'
            },
            {
                id: 'fuera_de_competencia',
                icon: 'üö´',
                title: 'Fuera de mi √°rea de competencia',
                description: 'No tengo las habilidades necesarias'
            },
            {
                id: 'escalacion_necesaria',
                icon: 'üìà',
                title: 'Requiere escalaci√≥n inmediata',
                description: 'La criticidad requiere atenci√≥n de nivel superior'
            },
            {
                id: 'otro_motivo_transferir',
                icon: 'üí¨',
                title: 'Otro motivo',
                description: 'Especifica el motivo de la transferencia',
                requiresText: true
            }
        ];

        const supportReasonsWorking = [
            {
                id: 'repuesto_no_disponible',
                icon: 'üì¶',
                title: 'Repuesto no disponible',
                description: 'Se necesita autorizar/conseguir un repuesto espec√≠fico'
            },
            {
                id: 'segunda_opinion',
                icon: 'üë•',
                title: 'Necesito una segunda opini√≥n',
                description: 'Quiero confirmar el diagn√≥stico con un supervisor'
            },
            {
                id: 'acceso_restringido',
                icon: 'üîí',
                title: '√Årea de acceso restringido',
                description: 'Necesito autorizaci√≥n para acceder a la zona'
            },
            {
                id: 'tiempo_insuficiente',
                icon: '‚è∞',
                title: 'Tiempo insuficiente para completar',
                description: 'La reparaci√≥n tomar√° m√°s tiempo del estimado'
            },
            {
                id: 'otro_apoyo_trabajo',
                icon: 'üí¨',
                title: 'Otro tipo de apoyo',
                description: 'Especifica qu√© apoyo necesitas',
                requiresText: true
            }
        ];

        /* ========================================
           SISTEMA DE AUTENTICACI√ìN
        ======================================== */
        async function loginWithPIN() {
            const email = document.getElementById('emailInput').value.trim();
            
            if (!email) {
                showLoginError('Por favor, ingresa tu email corporativo');
                return;
            }

            if (!isValidEmail(email)) {
                showLoginError('Email no v√°lido');
                return;
            }

            currentTechnician = { email: email, name: email.split('@')[0], authenticated: false };
            showPINModal();
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function showLoginError(message) {
            const errorElement = document.getElementById('loginError');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            setTimeout(() => {
                errorElement.classList.add('hidden');
            }, 5000);
        }

        function showPINModal() {
            const modal = document.getElementById('pinModal');
            const pinInput = document.getElementById('pinInput');
            const verifyBtn = document.getElementById('verifyPinBtn');
            const pinError = document.getElementById('pinError');

            pinInput.value = '';
            verifyBtn.disabled = true;
            pinError.classList.add('hidden');

            modal.classList.add('active');
            setTimeout(() => pinInput.focus(), 100);

            pinInput.oninput = function() {
                verifyBtn.disabled = this.value.length !== 4;
            };

            pinInput.onkeypress = function(e) {
                if (e.key === 'Enter' && this.value.length === 4) {
                    verifyPIN();
                }
                if (!/[0-9]/.test(e.key) && e.key !== 'Backspace') {
                    e.preventDefault();
                }
            };
        }

        function closePINModal() {
            document.getElementById('pinModal').classList.remove('active');
        }

        async function verifyPIN() {
            const pin = document.getElementById('pinInput').value;
            const pinError = document.getElementById('pinError');

            if (pin.length !== 4) {
                showPINError('PIN debe tener 4 d√≠gitos');
                return;
            }
            if (!currentTechnician) {
                    showPINError('Error de sesi√≥n. Intenta nuevamente.');
                    return;
                }

            try {
                const isValid = await validatePIN(currentTechnician.email, pin);
                
                if (isValid) {
                    currentTechnician.authenticated = true;
                    document.getElementById('pinModal').classList.remove('active');
                    showDashboard();
                    await loadDashboard();
                } else {
                    showPINError('PIN incorrecto');
                    document.getElementById('pinInput').value = '';
                    document.getElementById('verifyPinBtn').disabled = true;
                }
            } catch (error) {
                console.error('Error validando PIN:', error);
                showPINError('Error de conexi√≥n');
            }
        }

        async function validatePIN(email, pin) {
                try {
                    const response = await fetch('/api/webhook-respuesta', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'validate_pin',
                            technician_email: email,
                            pin: pin
                        })
                    });
                    
                    const data = await response.json();
                    return data.status === 'success' && data.valid === true;
                } catch (error) {
                    console.error('Error validating PIN:', error);
                    return false;
                }
            }

        function showPINError(message) {
            const pinError = document.getElementById('pinError');
            pinError.textContent = message;
            pinError.classList.remove('hidden');
            setTimeout(() => {
                pinError.classList.add('hidden');
            }, 3000);
        }

        function showDashboard() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('dashboardContainer').classList.remove('hidden');
            document.getElementById('userEmail').textContent = currentTechnician.email;
        }

        /* ========================================
           CARGA Y GESTI√ìN DE DATOS
        ======================================== */
        async function loadDashboard() {
            if (!currentTechnician?.authenticated) {
                console.error('Usuario no autenticado');
                return;
            }

            showLoadingState();

            try {
               const response = await fetchWithRetry(
                        `/api/webhook-respuesta?action=get_assigned_incidents&technician_email=${encodeURIComponent(currentTechnician.email)}`
                    );
                
                const data = await response.json();
                
               if (data && data.incidents && Array.isArray(data.incidents)) {
                    allIncidents = data.incidents;
                   console.log(`üìä Cargadas ${allIncidents.length} incidencias`);
                    
                    updateStatistics();
                    renderIncidents();
                    startAutoRefresh();
                    startSLATimers();
                } else {
                    throw new Error('Datos inv√°lidos recibidos del servidor');
                }
            } catch (error) {
                console.error('Error cargando dashboard:', error);
                showErrorState(error.message);
            }
        }

        async function fetchWithRetry(url, options = {}, attempt = 1) {
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return response;
            } catch (error) {
                if (attempt < CONFIG.MAX_RETRY_ATTEMPTS) {
                    console.warn(`Intento ${attempt} fall√≥, reintentando en ${CONFIG.RETRY_DELAY * attempt}ms...`);
                    await delay(CONFIG.RETRY_DELAY * attempt);
                    return fetchWithRetry(url, options, attempt + 1);
                }
                throw error;
            }
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function showLoadingState() {
            const container = document.getElementById('incidentsContainer');
            container.innerHTML = `
                <div class="no-incidents">
                    <div class="no-incidents-icon">‚è≥</div>
                    <h3>Cargando incidencias...</h3>
                    <p>Obteniendo los datos m√°s recientes del servidor...</p>
                </div>
            `;
        }

        function showErrorState(errorMessage = 'Error desconocido') {
            const container = document.getElementById('incidentsContainer');
            container.innerHTML = `
                <div class="no-incidents">
                    <div class="no-incidents-icon">‚ùå</div>
                    <h3>Error al cargar datos</h3>
                    <p>No se pudieron cargar las incidencias: ${errorMessage}</p>
                    <button class="btn btn-info mt-4" onclick="loadDashboard()" style="padding: 10px 20px; border-radius: 8px;">
                        üîÑ Reintentar
                    </button>
                </div>
            `;
        }

        /* ========================================
           GESTI√ìN DE ESTAD√çSTICAS
        ======================================== */
        function updateStatistics() {
            const stats = calculateStatistics();
            
            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('pendingCount').textContent = stats.pending;
            document.getElementById('workingCount').textContent = stats.working;
            document.getElementById('expiredCount').textContent = stats.expired;
            document.getElementById('seguimientoCount').textContent = stats.seguimiento;
        }

        function calculateStatistics() {
            const technicianEmail = currentTechnician?.email || '';
            
            const relevantIncidents = allIncidents.filter(incident => {
                const state = getIncidentRealState(incident, technicianEmail);
                return ['pending', 'working', 'expired', 'seguimiento'].includes(state);
            });

            return {
                total: relevantIncidents.length,
                pending: relevantIncidents.filter(i => getIncidentRealState(i, technicianEmail) === 'pending').length,
                working: relevantIncidents.filter(i => getIncidentRealState(i, technicianEmail) === 'working').length,
                expired: relevantIncidents.filter(i => getIncidentRealState(i, technicianEmail) === 'expired').length,
                seguimiento: relevantIncidents.filter(i => getIncidentRealState(i, technicianEmail) === 'seguimiento').length
            };
        }

        /* ========================================
           L√ìGICA DE ESTADOS DE INCIDENCIAS
        ======================================== */
        function getIncidentRealState(incident, technicianEmail) {
            const escalationLevel = parseInt(incident.escalation_level) || 0;
            
            if (incident.escalation_paused === 'true') {
                return 'paused';
            }
            
            const isCurrentlyAssigned = checkCurrentAssignment(incident, technicianEmail, escalationLevel);
            
            if (isCurrentlyAssigned) {
                if (hasAcceptedAtLevel(incident, technicianEmail, escalationLevel)) {
                    return 'working';
                }
                
                if (hasRejectedAtLevel(incident, technicianEmail, escalationLevel)) {
                    return 'seguimiento';
                }
                
                const currentSLA = getCurrentLevelSLA(incident, escalationLevel);
                if (currentSLA && new Date(currentSLA) < new Date()) {
                    return 'expired';
                }
                
                return 'pending';
            }
            
            if (hasParticipatedBefore(incident, technicianEmail)) {
                return 'seguimiento';
            }
            
            return 'not_mine';
        }

        function checkCurrentAssignment(incident, technicianEmail, level) {
            switch (level) {
                case 0: return incident.l0_technician === technicianEmail;
                case 1: return incident.l1_technician === technicianEmail;
                case 2: return incident.l2_technicians && incident.l2_technicians.includes(technicianEmail);
                case 3: return incident.l3_supervisor === technicianEmail;
                default: return false;
            }
        }

        function hasAcceptedAtLevel(incident, technicianEmail, level) {
            switch (level) {
                case 0: return incident.l0_response === 'acepto' && incident.l0_technician === technicianEmail;
                case 1: return incident.l1_response === 'acepto' && incident.l1_technician === technicianEmail;
                case 2: return incident.l2_responses && incident.l2_responses.includes('acepto');
                case 3: return incident.l3_response === 'acepto';
                default: return false;
            }
        }

        function hasRejectedAtLevel(incident, technicianEmail, level) {
            switch (level) {
                case 0: return ['rechazo', 'solicitar_ayuda'].includes(incident.l0_response) && incident.l0_technician === technicianEmail;
                case 1: return ['rechazo', 'solicitar_ayuda'].includes(incident.l1_response) && incident.l1_technician === technicianEmail;
                case 2: return incident.l2_responses && (incident.l2_responses.includes('rechazo') || incident.l2_responses.includes('solicitar_ayuda'));
                default: return false;
            }
        }

        function hasParticipatedBefore(incident, technicianEmail) {
            return (incident.l0_technician === technicianEmail && incident.l0_response !== '‚≠ï Sin Respuesta') ||
                   (incident.l1_technician === technicianEmail && incident.l1_response !== '‚≠ï Sin Respuesta');
        }

        function getCurrentLevelSLA(incident, level) {
            switch (level) {
                case 0: return incident.sla_l0_end;
                case 1: return incident.sla_l1_backup_end;
                case 2: return incident.sla_l2_equipo_end;
                case 3: return incident.sla_l3_responsable_end;
                default: return null;
            }
        }

        function canTechnicianRespond(incident, technicianEmail) {
            const state = getIncidentRealState(incident, technicianEmail);
            return state === 'pending';
        }

        /* ========================================
           FUNCIONES DE RENDERIZADO
        ======================================== */
        function executeAction() {
                if (!pendingAction) return;
                
                if (pendingAction === 'acepto') {
                    confirmAction();
                } else if (pendingAction === 'completar') {
                    showCompletionModal();
                } else {
                    showReasonModal(pendingAction);
                }
            }
        
          function filterIncidents() {
            const technicianEmail = currentTechnician?.email || '';
            
            return allIncidents.filter(incident => {
                const realState = getIncidentRealState(incident, technicianEmail);
                
                if (realState === 'not_mine') return false;
                
                if (currentStatusFilter !== 'all' && realState !== currentStatusFilter) {
                    return false;
                }
                
                if (currentPriorityFilter !== 'all') {
                    const priority = incident.priority.replace(/üî¥|üü†|üü°|üü¢/g, '').trim();
                    if (priority !== currentPriorityFilter) return false;
                }
                
                return true;
            });
        }
        
        function renderIncidents() {
            const filteredIncidents = filterIncidents();

            if (filteredIncidents.length === 0) {
                showNoIncidentsMessage();
                return;
            }

            const incidentsHTML = filteredIncidents.map(incident => renderIncidentCard(incident)).join('');
            
            document.getElementById('incidentsContainer').innerHTML = `
                <div class="incidents-grid">
                    ${incidentsHTML}
                </div>
            `;

            startSLATimers();
        }

               function renderIncidentCard(incident) {
            const technicianEmail = currentTechnician?.email || '';
            const realState = getIncidentRealState(incident, technicianEmail);
            const escalationLevel = parseInt(incident.escalation_level) || 0;
            
            const priorityColor = getPriorityColor(incident.priority);
            const priority = incident.priority.replace(/üî¥|üü†|üü°|üü¢/g, '').trim();
            
            return `
                <div class="incident-card" data-incident-id="${incident.id}">
                    ${renderIncidentHeader(incident, priority, priorityColor, escalationLevel, realState)}
                    ${renderIncidentBody(incident, technicianEmail, escalationLevel)}
                    ${renderIncidentFooter(incident, realState, technicianEmail)}
                </div>
            `;
        }

        function renderIncidentHeader(incident, priority, priorityColor, escalationLevel, realState) {
            return `
                <div class="incident-header">
                    <div class="incident-title">
                        <h4>${incident.equipment || incident.component || 'Equipo no especificado'}</h4>
                        <div class="badges">
                            <span class="priority-badge" style="background-color: ${priorityColor};">${priority}</span>
                            <span class="badge bg-info">L${escalationLevel} ACTIVO</span>
                            ${getStateBadge(realState)}
                            ${renderSLABadge(incident, escalationLevel)}
                        </div>
                    </div>
                    <div class="incident-id">${incident.id}</div>
                </div>
            `;
        }

        function renderIncidentBody(incident, technicianEmail, escalationLevel) {
            return `
                <div class="incident-body">
                    <div class="zone">üìç <strong>${incident.zone}</strong></div>
                    <div class="description">${incident.description}</div>
                    
                    ${renderTechnicianInfo(incident, technicianEmail)}
                    ${renderSLATimer(incident, escalationLevel)}
                    ${renderTimeElapsed(incident, technicianEmail)}
                    ${renderAssignmentNotes(incident)}
                    ${renderActionsTaken(incident)}
                    ${renderContactsInfo(incident)}
                    ${renderEscalationHistory(incident, technicianEmail)}
                </div>
            `;
        }

        function renderIncidentFooter(incident, realState, technicianEmail) {
            return `
                <div class="incident-footer">
                    ${renderActionButtons(incident, realState, technicianEmail)}
                </div>
            `;
        }

        function getPriorityColor(priority) {
            const priorityText = priority.replace(/üî¥|üü†|üü°|üü¢/g, '').trim();
            const colors = {
                'CR√çTICA': '#dc3545',
                'ALTA': '#fd7e14',
                'MEDIA': '#ffc107',
                'BAJA': '#28a745'
            };
            return colors[priorityText] || '#6c757d';
        }

        function getStateBadge(state) {
            const badges = {
                'pending': { text: 'PUEDES RESPONDER', class: 'bg-warning' },
                'working': { text: 'TRABAJANDO', class: 'bg-success' },
                'expired': { text: 'VENCIDA', class: 'bg-danger' },
                'seguimiento': { text: 'SEGUIMIENTO', class: 'bg-info' }
            };
            const config = badges[state] || { text: 'DESCONOCIDO', class: 'bg-secondary' };
            return `<span class="badge ${config.class}">${config.text}</span>`;
        }

        function renderSLABadge(incident, escalationLevel) {
            const slaEnd = getCurrentLevelSLA(incident, escalationLevel);
            if (!slaEnd) return '';
            
            const now = new Date();
            const endTime = new Date(slaEnd);
            const diffMinutes = Math.floor((endTime - now) / 60000);
            
            let text, bgColor;
            if (diffMinutes < 0) {
                text = `${Math.abs(diffMinutes)}m vencido`;
                bgColor = '#ef4444';
            } else {
                const hours = Math.floor(diffMinutes / 60);
                const minutes = diffMinutes % 60;
                text = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                
                if (diffMinutes <= 30) bgColor = '#ef4444';
                else if (diffMinutes <= 60) bgColor = '#f59e0b';
                else bgColor = '#22c55e';
            }
            
            return `<span class="sla-badge" style="background: ${bgColor}; color: white;">‚è∞ ${text}</span>`;
        }

        function renderTechnicianInfo(incident, userEmail) {
            let techInfo = '';
            
            if (incident.l0_technician) {
                const isCurrentTech = incident.l0_technician === userEmail;
                techInfo += `
                    <div class="technician-info ${isCurrentTech ? 'current-tech' : ''}">
                        üë®‚Äçüîß L0: <strong>${incident.l0_technician.split('@')[0]}</strong>
                        ${isCurrentTech ? ' (T√ö)' : ''}
                        ${incident.l0_response ? ` - ${incident.l0_response}` : ''}
                        ${incident.l0_acceptance_date ? ` - ${new Date(incident.l0_acceptance_date).toLocaleString('es-ES')}` : ''}
                    </div>
                `;
            }
            
            if (parseInt(incident.escalation_level) >= 1 && incident.l1_technician) {
                const isCurrentTech = incident.l1_technician === userEmail;
                techInfo += `
                    <div class="technician-info ${isCurrentTech ? 'current-tech' : ''}">
                        üë®‚Äçüîß L1: <strong>${incident.l1_technician.split('@')[0]}</strong>
                        ${isCurrentTech ? ' (T√ö)' : ''}
                        ${incident.l1_response ? ` - ${incident.l1_response}` : ''}
                        ${incident.l1_acceptance_date ? ` - ${new Date(incident.l1_acceptance_date).toLocaleString('es-ES')}` : ''}
                    </div>
                `;
            }
            
            if (parseInt(incident.escalation_level) >= 2 && incident.l2_technicians) {
                const l2Techs = incident.l2_technicians.split(',');
                const isCurrentInL2 = l2Techs.some(tech => tech.trim() === userEmail);
                techInfo += `
                    <div class="technician-info ${isCurrentInL2 ? 'current-tech' : ''}">
                        üë• L2: <strong>${l2Techs.map(t => t.split('@')[0]).join(', ')}</strong>
                        ${isCurrentInL2 ? ' (INCLUYE A TI)' : ''}
                        ${incident.l2_response ? ` - ${incident.l2_response}` : ''}
                    </div>
                `;
            }
            
            return techInfo;
        }

        function renderSLATimer(incident, escalationLevel) {
            const slaEnd = getCurrentLevelSLA(incident, escalationLevel);
            if (!slaEnd) return '';
            
            const slaClass = getSLAClass(slaEnd);
            const slaText = getSLAText(slaEnd);
            
            return `
                <div class="sla-timer ${slaClass}" data-end="${slaEnd}">
                    ‚è∞ ${slaText}
                </div>
            `;
        }

        function getSLAClass(slaEnd) {
            if (!slaEnd) return 'sla-good';
            const diffMinutes = Math.floor((new Date(slaEnd) - new Date()) / 60000);
            if (diffMinutes <= 30) return 'sla-critical';
            if (diffMinutes <= 60) return 'sla-warning';
            return 'sla-good';
        }

        function getSLAText(slaEnd) {
            if (!slaEnd) return '';
            const diffMinutes = Math.floor((new Date(slaEnd) - new Date()) / 60000);
            if (diffMinutes < 0) return `${Math.abs(diffMinutes)}m vencido`;
            const hours = Math.floor(diffMinutes / 60);
            const minutes = diffMinutes % 60;
            return hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
        }

        function renderTimeElapsed(incident, technicianEmail) {
            let acceptanceDate = null;
            
            if (incident.l0_technician === technicianEmail && incident.l0_acceptance_date) {
                acceptanceDate = incident.l0_acceptance_date;
            } else if (incident.l1_technician === technicianEmail && incident.l1_acceptance_date) {
                acceptanceDate = incident.l1_acceptance_date;
            } else if (incident.l2_acceptance_date) {
                acceptanceDate = incident.l2_acceptance_date;
            }
            
            if (!acceptanceDate) return '';
            
            const now = new Date();
            const accepted = new Date(acceptanceDate);
            const diffMinutes = Math.floor((now - accepted) / 60000);
            
            const hours = Math.floor(diffMinutes / 60);
            const minutes = diffMinutes % 60;
            
            return `<div class="time-elapsed">üîß Trabajando: ${hours}h ${minutes}m</div>`;
        }

        function renderAssignmentNotes(incident) {
            if (!incident.assignment_notes || !incident.assignment_notes.trim()) return '';
            
            return `
                <div class="actions-taken">
                    üìù <strong>Notas de asignaci√≥n:</strong> ${incident.assignment_notes}
                </div>
            `;
        }

        function renderActionsTaken(incident) {
            if (!incident.actions_taken || incident.actions_taken === 'Sin acciones' || !incident.actions_taken.trim()) return '';
            
            return `
                <div class="actions-taken">
                    üîß <strong>Acciones tomadas:</strong> ${incident.actions_taken}
                </div>
            `;
        }

        function renderContactsInfo(incident) {
            if (!incident.supervisor_phone && !incident.reporter_phone && !incident.zone_manager_phone) {
                return '';
            }
            
            let contacts = '';
            if (incident.reporter && incident.reporter_phone) {
                contacts += `<div>üìã Reportador: <strong>${incident.reporter}</strong> - <a href="tel:${incident.reporter_phone}">${incident.reporter_phone}</a></div>`;
            }
            if (incident.supervisor && incident.supervisor_phone) {
                contacts += `<div>üë®‚Äçüíº Supervisor: <strong>${incident.supervisor}</strong> - <a href="tel:${incident.supervisor_phone}">${incident.supervisor_phone}</a></div>`;
            }
            if (incident.zone_manager && incident.zone_manager_phone) {
                contacts += `<div>üè¢ Encargado Zona: <strong>${incident.zone_manager}</strong> - <a href="tel:${incident.zone_manager_phone}">${incident.zone_manager_phone}</a></div>`;
            }
            
            return `
                <div class="contacts-info">
                    <div class="contacts-header" onclick="toggleContacts('${incident.id}')">
                        üìû Contactos <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="contacts-list" id="contacts-${incident.id}">
                        ${contacts}
                    </div>
                </div>
            `;
        }

        function renderEscalationHistory(incident, userEmail) {
            const historyLevels = buildEscalationHistory(incident, userEmail);
            const historyHTML = historyLevels.map(level => renderEscalationLevel(level, userEmail)).join('');
            
            return `
                <div class="escalation-history">
                    <div class="escalation-header" onclick="toggleEscalationHistory('${incident.id}')">
                        üìä Historial de Escalado <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="escalation-content" id="escalation-${incident.id}">
                        ${historyHTML}
                    </div>
                </div>
            `;
        }

        function buildEscalationHistory(incident, userEmail) {
            const historyLevels = [];
            const currentLevel = parseInt(incident.escalation_level) || 0;
            
            // L0
            let l0Status = 'pending';
            if (incident.l0_response === 'acepto') l0Status = 'completed';
            else if (['rechazo', 'solicitar_ayuda'].includes(incident.l0_response)) l0Status = 'escalated';
            else if (currentLevel > 0) l0Status = 'expired';
            
            historyLevels.push({
                level: 'L0',
                technician: incident.l0_technician,
                status: l0Status,
                response: incident.l0_response,
                sla_end: incident.sla_l0_end,
                acceptance_date: incident.l0_acceptance_date,
                rejection_date: incident.l0_rejection_date,
                reason: incident.l0_rejection_reason
            });
            
            // L1, L2, L3 similar logic...
            if (currentLevel >= 1) {
                let l1Status = currentLevel === 1 ? 'current' : 'completed';
                if (incident.l1_response === 'acepto') l1Status = 'completed';
                else if (['rechazo', 'solicitar_ayuda'].includes(incident.l1_response)) l1Status = 'escalated';
                else if (currentLevel > 1) l1Status = 'expired';
                
                historyLevels.push({
                    level: 'L1',
                    technician: incident.l1_technician,
                    status: l1Status,
                    response: incident.l1_response,
                    sla_end: incident.sla_l1_backup_end,
                    acceptance_date: incident.l1_acceptance_date,
                    rejection_date: incident.l1_rejection_date,
                    reason: incident.l1_rejection_reason
                });
            }
            
            return historyLevels;
        }

        function renderEscalationLevel(level, userEmail) {
            const isCurrentTech = level.technician === userEmail || 
                                 (level.technician && level.technician.includes && level.technician.includes(userEmail));
            
            let statusClass = level.status;
            let statusText = '';
            switch(level.status) {
                case 'completed': statusText = '‚úÖ Completado'; break;
                case 'current': statusText = 'üîÑ Activo'; break;
                case 'expired': statusText = '‚è∞ Vencido'; break;
                case 'escalated': statusText = 'üîº Escalado'; break;
                case 'pending': statusText = '‚è≥ Pendiente'; break;
            }
            
            return `
                <div class="escalation-level ${statusClass}">
                    <div class="level-header">
                        ${level.level} - ${statusText} ${isCurrentTech ? '(T√ö)' : ''}
                    </div>
                    <div class="level-details">
                        <strong>T√©cnico:</strong> ${level.technician ? level.technician.split('@')[0] : 'No asignado'}<br>
                        ${level.response ? `<strong>Respuesta:</strong> ${level.response}<br>` : ''}
                        ${level.reason ? `<strong>Motivo:</strong> ${level.reason}<br>` : ''}
                        ${level.sla_end ? `<strong>SLA:</strong> ${new Date(level.sla_end).toLocaleString('es-ES')}<br>` : ''}
                        ${level.acceptance_date ? `<strong>Fecha aceptaci√≥n:</strong> ${new Date(level.acceptance_date).toLocaleString('es-ES')}<br>` : ''}
                        ${level.rejection_date ? `<strong>Fecha rechazo:</strong> ${new Date(level.rejection_date).toLocaleString('es-ES')}` : ''}
                    </div>
                </div>
            `;
        }

        function renderActionButtons(incident, state, userEmail) {
            if (state === 'pending') {
                return `
                    <div class="incident-actions">
                        <button class="btn btn-success" onclick="handleAction('acepto', '${incident.id}')">
                            ‚úÖ Acepto
                        </button>
                        <button class="btn btn-danger" onclick="handleAction('rechazo', '${incident.id}')">
                            ‚ùå Rechazo
                        </button>
                        <button class="btn btn-warning" onclick="handleAction('solicitar_ayuda', '${incident.id}')">
                            üÜò Ayuda
                        </button>
                    </div>
                `;
            } else if (state === 'working') {
                return `
                    <div class="incident-actions">
                        <button class="btn btn-success" onclick="handleAction('completar', '${incident.id}')">
                            ‚úÖ Completar
                        </button>
                        <button class="btn btn-warning" onclick="handleAction('solicitar_apoyo', '${incident.id}')">
                            üÜò Solicitar Apoyo
                        </button>
                        <button class="btn btn-info" onclick="handleAction('transferir', '${incident.id}')">
                            üîÑ Transferir
                        </button>
                    </div>
                `;
            } else if (['seguimiento', 'expired'].includes(state)) {
                return `
                    <div class="incident-actions">
                        <button class="btn btn-info" onclick="handleAction('solicitar_cargo', '${incident.id}')">
                            üôã‚Äç‚ôÇÔ∏è SOLICITAR HACERSE CARGO
                        </button>
                    </div>
                `;
            } else {
                let reason = state === 'paused' ? '‚è∏Ô∏è Escalado pausado por supervisor' : '‚ùì Estado desconocido';
                return `
                    <div class="no-action-info">
                        <span class="badge bg-light">${reason}</span>
                    </div>
                `;
            }
        }

        function showNoIncidentsMessage() {
            const container = document.getElementById('incidentsContainer');
            container.innerHTML = `
                <div class="no-incidents">
                    <div class="no-incidents-icon">üìã</div>
                    <h3>No hay incidencias</h3>
                    <p>No tienes incidencias ${currentStatusFilter === 'all' ? '' : 'con este estado'} en este momento.</p>
                </div>
            `;
        }

        /* ========================================
           MANEJO DE ACCIONES
        ======================================== */
        function handleAction(action, incidentId) {
            currentIncident = allIncidents.find(inc => inc.id === incidentId);
            if (!currentIncident) {
                console.error('Incidencia no encontrada:', incidentId);
                return;
            }

            if (!currentTechnician?.authenticated) {
                pendingAction = action;
                showPINModal();
                return;
            }

            if (action === 'acepto') {
                pendingAction = action;
                confirmAction();
            } else if (action === 'completar') {
                showCompletionModal();
            } else {
                showReasonModal(action);
            }
        }

        function showReasonModal(action) {
            pendingAction = action;
            selectedReason = null;
            customText = '';

            const modal = document.getElementById('reasonModal');
            const title = document.getElementById('modalTitle');
            const options = document.getElementById('reasonOptions');
            const confirmBtn = document.getElementById('confirmBtn');

            let reasons = [];
            let modalTitle = '';
            let buttonText = '';

            switch(action) {
                case 'rechazo':
                    modalTitle = '‚ùå Motivo del Rechazo';
                    buttonText = 'Rechazar';
                    reasons = rejectReasons;
                    break;
                case 'solicitar_ayuda':
                    modalTitle = 'üÜò Tipo de Ayuda Inicial';
                    buttonText = 'Solicitar Ayuda';
                    reasons = helpReasonsInitial;
                    break;
                case 'transferir':
                    modalTitle = 'üîÑ Motivo de Transferencia';
                    buttonText = 'Transferir';
                    reasons = transferReasons;
                    break;
                case 'solicitar_apoyo':
                    modalTitle = 'üÜò Tipo de Apoyo en Trabajo';
                    buttonText = 'Solicitar Apoyo';
                    reasons = supportReasonsWorking;
                    break;
                default:
                    console.error('Acci√≥n no reconocida:', action);
                    return;
            }

            title.textContent = modalTitle;
            confirmBtn.textContent = buttonText;
            confirmBtn.disabled = true;

            const reasonsHTML = reasons.map(reason => {
                return `
                    <div class="reason-option" onclick="selectReason('${reason.id}', ${reason.requiresText || false})">
                        <div class="reason-icon">${reason.icon}</div>
                        <div class="reason-text">
                            <div class="reason-title">${reason.title}</div>
                            <div class="reason-description">${reason.description}</div>
                        </div>
                    </div>
                `;
            }).join('');

            options.innerHTML = reasonsHTML;
            modal.classList.add('active');
        }

        function selectReason(reasonId, requiresText = false) {
            selectedReason = reasonId;
            customText = '';
            
            document.querySelectorAll('.reason-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            const options = document.getElementById('reasonOptions');
            const existingTextarea = options.querySelector('.custom-reason-input');
            if (existingTextarea) {
                existingTextarea.remove();
            }
            
            if (requiresText) {
                const textarea = document.createElement('textarea');
                textarea.className = 'custom-reason-input';
                textarea.placeholder = 'Especifica los detalles...';
                textarea.oninput = () => {
                    customText = textarea.value.trim();
                    updateConfirmButton();
                };
                options.appendChild(textarea);
                textarea.focus();
            } else {
                updateConfirmButton();
            }
        }

        function updateConfirmButton() {
            const confirmBtn = document.getElementById('confirmBtn');
            const requiresText = selectedReason && selectedReason.includes('otro');
            
            if (selectedReason) {
                if (requiresText) {
                    confirmBtn.disabled = customText.length < 10;
                } else {
                    confirmBtn.disabled = false;
                }
            } else {
                confirmBtn.disabled = true;
            }
        }

        function closeReasonModal() {
            document.getElementById('reasonModal').classList.remove('active');
            selectedReason = null;
            customText = '';
            pendingAction = null;
        }

        function showCompletionModal() {
            const modal = document.getElementById('reasonModal');
            const title = document.getElementById('modalTitle');
            const options = document.getElementById('reasonOptions');
            const confirmBtn = document.getElementById('confirmBtn');

            title.textContent = '‚úÖ Completar Incidencia';
            confirmBtn.textContent = 'Completar';
            
            options.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #374151; font-weight: 600; margin-bottom: 10px;">
                        Describe las acciones realizadas para resolver la incidencia:
                    </p>
                    <textarea 
                        class="custom-reason-input" 
                        placeholder="Ejemplo: Reemplazada bomba defectuosa, verificado funcionamiento correcto, sistema operativo..." 
                        maxlength="500"
                        oninput="updateCompletionText(this.value)"
                        style="height: 120px;"></textarea>
                    <div style="text-align: right; font-size: 12px; color: #6b7280; margin-top: 5px;">
                        M√≠nimo 20 caracteres
                    </div>
                </div>
            `;

            confirmBtn.disabled = true;
            modal.classList.add('active');
            
            setTimeout(() => {
                const textarea = options.querySelector('textarea');
                if (textarea) textarea.focus();
            }, 100);
        }

        function updateCompletionText(text) {
            customText = text.trim();
            document.getElementById('confirmBtn').disabled = customText.length < 20;
        }

        async function confirmAction() {
            if (!pendingAction || !currentIncident) {
                console.error('No hay acci√≥n pendiente o incidencia seleccionada');
                return;
            }

            const reasonText = selectedReason ? 
                (customText || selectedReason.replace(/_/g, ' ')) : 
                (customText || 'Confirmado');

            try {
               const response = await fetch('/api/webhook-respuesta', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        incident_id: pendingAction,
                        technician_email: currentTechnician.email,
                        technician_name: currentTechnician.name,
                        action: pendingAction,
                        reason: reasonText,
                        timestamp: new Date().toISOString()
                    })
                });

                let data = null;
                try {
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                        data = await response.json();
                    } else {
                        throw new Error('Respuesta no es JSON v√°lido');
                    }
                } catch (parseError) {
                    console.error('Error parsing respuesta de acci√≥n:', parseError);
                    throw new Error('Error procesando respuesta del servidor');
                }
                
                if (response.ok && data && data.status === 'success') {
                    const successMessages = {
                        'acepto': '‚úÖ Incidencia aceptada correctamente. ¬°Puedes empezar a trabajar!',
                        'rechazo': '‚ùå Incidencia rechazada. Se escalar√° autom√°ticamente.',
                        'solicitar_ayuda': 'üÜò Ayuda solicitada. Un supervisor se pondr√° en contacto.',
                        'completar': '‚úÖ Incidencia completada exitosamente.',
                        'transferir': 'üîÑ Incidencia transferida correctamente.',
                        'solicitar_apoyo': 'üÜò Apoyo solicitado. Un supervisor gestionar√° tu petici√≥n.'
                    };
                    
                    showSuccessOverlay(
                        successMessages[pendingAction] || `${pendingAction.toUpperCase()} registrado correctamente`,
                        pendingAction === 'acepto' ? 'üîÑ' : '‚úÖ'
                    );
                    
                    closeReasonModal();
                    await loadDashboard();
                } else {
                    const errorMsg = (data && data.message) || `Error ${response.status}: No se pudo registrar la respuesta`;
                    alert(errorMsg);
                }
                
            } catch (error) {
                console.error('Error enviando respuesta:', error);
                alert('Error de conexi√≥n: ' + error.message);
            } finally {
                pendingAction = null;
                currentIncident = null;
                selectedReason = null;
                customText = '';
            }
        }

        function showSuccessOverlay(message, icon = '‚úÖ') {
            const overlay = document.getElementById('successOverlay');
            const iconEl = document.getElementById('successIcon');
            const titleEl = document.getElementById('successTitle');
            const descEl = document.getElementById('successDescription');
            const countdownEl = document.getElementById('countdown');
            
            iconEl.textContent = icon;
            titleEl.textContent = 'Acci√≥n Completada';
            descEl.textContent = message;
            
            overlay.style.display = 'flex';
            
            let seconds = 3;
            countdownEl.textContent = `Actualizando en ${seconds} segundos...`;
            
            const countdown = setInterval(() => {
                seconds--;
                if (seconds > 0) {
                    countdownEl.textContent = `Actualizando en ${seconds} segundos...`;
                } else {
                    clearInterval(countdown);
                    overlay.style.display = 'none';
                }
            }, 1000);
        }

        /* ========================================
           FUNCIONES DE UTILIDAD Y EVENTOS
        ======================================== */
        function filterByStatus(status, element) {
            currentStatusFilter = status;
            
            document.querySelectorAll('.stat-card').forEach(card => {
                card.classList.remove('active');
            });
            element.classList.add('active');
            
            renderIncidents();
        }

        function filterByPriority(priority, element) {
            currentPriorityFilter = priority;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            element.classList.add('active');
            
            renderIncidents();
        }

        function toggleContacts(incidentId) {
            const contactsList = document.getElementById(`contacts-${incidentId}`);
            if (!contactsList) return;
            
            const toggleIcon = contactsList.parentElement.querySelector('.toggle-icon');
            const isVisible = !contactsList.classList.contains('hidden');
            
            if (isVisible) {
                contactsList.classList.add('hidden');
                toggleIcon.textContent = '‚ñº';
            } else {
                contactsList.classList.remove('hidden');
                toggleIcon.textContent = '‚ñ≤';
            }
        }

        function toggleEscalationHistory(incidentId) {
            const historyContent = document.getElementById(`escalation-${incidentId}`);
            if (!historyContent) return;
            
            const toggleIcon = historyContent.parentElement.querySelector('.toggle-icon');
            const isVisible = historyContent.style.display !== 'none';  
            
             historyContent.style.display = isVisible ? 'none' : 'block';
            if (toggleIcon) {
                toggleIcon.textContent = isVisible ? '‚ñº' : '‚ñ≤';
            }
        }

        function refreshDashboard() {
            const refreshBtn = document.getElementById('refreshBtn');
            const originalText = refreshBtn.innerHTML;
            
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = 'üîÑ Actualizando...';
            
            loadDashboard().finally(() => {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = originalText;
            });
        }

        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(() => {
                console.log('üîÑ Auto-refresh ejecut√°ndose...');
                loadDashboard();
            }, CONFIG.REFRESH_INTERVAL);
            
            console.log(`‚è∞ Auto-refresh configurado cada ${CONFIG.REFRESH_INTERVAL / 1000} segundos`);
        }

        function startSLATimers() {
            if (slaTimerInterval) {
                clearInterval(slaTimerInterval);
            }
            
            slaTimerInterval = setInterval(function() {
                const slaElements = document.querySelectorAll('.sla-timer[data-end]');
                
                slaElements.forEach(function(element) {
                    const endTime = new Date(element.dataset.end);
                    const now = new Date();
                    const diffMinutes = Math.floor((endTime - now) / 1000 / 60);
                    
                    if (diffMinutes < 0) {
                        element.className = 'sla-expired';
                        element.innerHTML = `‚è∞ VENCIDO hace ${Math.abs(diffMinutes)} min`;
                    } else {
                        const hours = Math.floor(diffMinutes / 60);
                        const minutes = diffMinutes % 60;
                        
                        let slaClass = 'sla-timer ';
                        if (diffMinutes <= 30) slaClass += 'sla-critical';
                        else if (diffMinutes <= 60) slaClass += 'sla-warning';
                        else slaClass += 'sla-good';
                        
                        element.className = slaClass;
                        element.innerHTML = `‚è∞ ${hours}h ${minutes.toString().padStart(2, '0')}m restantes`;
                    }
                });
            }, CONFIG.SLA_UPDATE_INTERVAL);
            
            console.log('‚è∞ Timers SLA iniciados - actualizaci√≥n cada 30 segundos');
        }

        function validateDate(dateString) {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return '';
                }
                return dateString;
            } catch (error) {
                console.warn('Fecha inv√°lida:', dateString);
                return '';
            }
        }

        /* ========================================
           INICIALIZACI√ìN DE LA APLICACI√ìN
        ======================================== */
        function initializeApp() {
            console.log('üîß Dashboard T√©cnico ABC.xyz iniciado');
            
            // Configurar par√°metros URL
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('tecnico') || urlParams.get('technician_email');
            const nombre = urlParams.get('nombre') || urlParams.get('technician_name');
            const incidentId = urlParams.get('id') || urlParams.get('incident_id');
            
            if (email) {
                document.getElementById('emailInput').value = email;
                if (nombre) {
                    currentTechnician = { 
                        email: email, 
                        name: decodeURIComponent(nombre),
                        authenticated: false
                    };
                }
                if (incidentId) {
                    accessMode = 'read_only';
                }
            }

            // Configurar eventos del login
            const emailInput = document.getElementById('emailInput');
            const loginBtn = document.getElementById('loginBtn');

            emailInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loginWithPIN();
                }
            });

            emailInput.addEventListener('input', () => {
                loginBtn.disabled = !emailInput.value.trim();
            });

            // Eventos globales
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeReasonModal();
                    closePINModal();
                }
                if (e.key === 'Enter' && document.getElementById('loginContainer').style.display !== 'none') {
                    const input = document.getElementById('emailInput');
                    if (input.value.trim()) loginWithPIN();
                }
            });

            // Eventos de modales
            document.getElementById('reasonModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeReasonModal();
            });

            document.getElementById('pinModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closePINModal();
            });

            // Limpieza al cerrar la ventana
            window.addEventListener('beforeunload', () => {
                if (refreshInterval) clearInterval(refreshInterval);
                if (slaTimerInterval) clearInterval(slaTimerInterval);
            });

            // Auto-foco en el input de email
            emailInput.focus();

            console.log('‚úÖ Inicializaci√≥n de la aplicaci√≥n completa');
            console.log('üìã Motivos configurados:', {
                rechazo: rejectReasons.length,
                ayuda_inicial: helpReasonsInitial.length,
                transferir: transferReasons.length,
                apoyo_trabajo: supportReasonsWorking.length
            });
        }

        /* ========================================
           FUNCIONES DE EVENTOS GLOBALES
        ======================================== */
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Exposici√≥n de funciones globales para onclick handlers
        window.loginWithPIN = loginWithPIN;
        window.refreshDashboard = refreshDashboard;
        window.filterByStatus = filterByStatus;
        window.filterByPriority = filterByPriority;
        window.handleAction = handleAction;
        window.toggleContacts = toggleContacts;
        window.toggleEscalationHistory = toggleEscalationHistory;
        window.closeReasonModal = closeReasonModal;
        window.closePINModal = closePINModal;
        window.confirmAction = confirmAction;
        window.selectReason = selectReason;
        window.updateCompletionText = updateCompletionText;
        window.verifyPIN = verifyPIN;

        console.log('üîß Dashboard ABC.xyz - Versi√≥n Completa Reorganizada cargada');
    </script>
</body>
</html>   
