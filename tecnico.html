<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard T√©cnico - ABC.xyz</title>
    <style>
        /* Reset y Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1f2937;
        }

        /* Container Principal */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login */
        .login-container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            margin: 50px auto;
        }

        .login-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .login-logo { color: #3b82f6; }
        .login-subtitle { color: #6b7280; margin-bottom: 30px; }

        .input-group {
            text-align: left;
            margin-bottom: 25px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .verify-btn {
            width: 100%;
            padding: 15px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .verify-btn:hover {
            background: #2563eb;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
        }

        .logo-text { color: #3b82f6; }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .auth-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .refresh-button {
            padding: 10px 20px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .last-update {
            font-size: 12px;
            color: #6b7280;
        }

        /* Main Container */
        .main-container {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .stat-card.active {
            background: #3b82f6;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }

        .stat-card.active .stat-number {
            color: white !important;
        }

        .stat-card.active .stat-label {
            color: rgba(255, 255, 255, 0.9);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-number.pending { color: #f59e0b; }
        .stat-number.working { color: #10b981; }
        .stat-number.expired { color: #ef4444; }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 600;
        }

        /* Filters */
        .filters-bar {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .filter-label {
            font-weight: 600;
            color: #374151;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            background: white;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active, .filter-btn:hover {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        /* Incidents Grid - 2 columnas en desktop, 1 en m√≥vil */
        .incidents-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .incident-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s;
        }

        .incident-card:hover {
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .incident-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .incident-id {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }

        .priority-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .priority-critica { background: #fef2f2; color: #991b1b; }
        .priority-alta { background: #fef3c7; color: #92400e; }
        .priority-media { background: #f0f9ff; color: #1e40af; }
        .priority-baja { background: #f0fdf4; color: #166534; }

        /* SLA Timer */
        .sla-section {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin: 15px 0;
        }

        .sla-time {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .sla-time.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .sla-time.critical {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .sla-label, .sla-level {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Expired Section */
        .expired-section {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin: 15px 0;
        }

        .expired-time {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .expired-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .escalation-info {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
        }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        .action-buttons.working-state {
            grid-template-columns: repeat(3, 1fr);
        }

        .action-btn {
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .btn-accept {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-accept:hover {
            background: linear-gradient(135deg, #059669, #047857);
        }

        .btn-reject {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-reject:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }

        .btn-help {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-help:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
        }

        .btn-complete {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-transfer {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-support {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .btn-disabled {
            background: #f3f4f6 !important;
            color: #9ca3af !important;
            cursor: not-allowed !important;
        }

        /* Info Rows */
        .incident-info {
            margin: 15px 0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-row span:first-child {
            font-weight: 600;
            color: #374151;
        }

        .info-row span:last-child {
            color: #6b7280;
            text-align: right;
            flex: 1;
            margin-left: 10px;
        }

        .info-row.response span:last-child {
            color: #059669;
            font-weight: 600;
        }

        /* Contacts */
        .contacts-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .contacts-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
        }

        .contact-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .contact-name {
            font-weight: 600;
            color: #1f2937;
        }

        .contact-phone {
            background: #3b82f6;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 12px;
            font-weight: 600;
        }

        .contact-phone:hover {
            background: #2563eb;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content, .pin-modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.8);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal-content,
        .modal-overlay.active .pin-modal {
            transform: scale(1);
        }

        .modal-title, .pin-modal-title {
            font-size: 20px;
            color: #1f2937;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
        }

        .reason-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }

        .reason-option {
            padding: 15px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .reason-option:hover {
            border-color: #374151;
            background: #f9fafb;
        }

        .reason-option.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .reason-icon { 
            font-size: 24px; 
            min-width: 30px; 
        }

        .reason-text { 
            flex: 1; 
        }

        .reason-title { 
            font-weight: 600; 
            color: #1f2937; 
            margin-bottom: 3px; 
        }

        .reason-description { 
            font-size: 13px; 
            color: #6b7280; 
        }

        .custom-reason-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            margin-top: 10px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .custom-reason-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .modal-actions, .pin-actions {
            display: flex;
            gap: 15px;
        }

        .modal-btn, .pin-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-cancel, .pin-btn-cancel {
            background: #f9fafb;
            color: #6b7280;
            border: 1px solid #d1d5db;
        }

        .btn-confirm, .pin-btn-verify {
            background: #374151;
            color: white;
        }

        .btn-confirm:disabled, .pin-btn-verify:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .pin-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 18px;
            text-align: center;
            letter-spacing: 8px;
            margin-bottom: 20px;
        }

        /* Success Overlay */
        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .success-message {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .success-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .success-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .success-description {
            color: #6b7280;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .countdown {
            font-size: 14px;
            color: #9ca3af;
        }

        /* Loading & Utilities */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-incidents {
            text-align: center;
            padding: 60px 20px;
        }

        .no-incidents-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .no-incidents-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .no-incidents-description {
            color: #6b7280;
            font-size: 16px;
        }

        .error-message {
            background: #fef2f2;
            color: #b91c1c;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #fecaca;
        }

        /* Escalation History Styles */
        .escalation-history {
            background: #f8fafc;
            margin: 15px -10px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .escalation-title {
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 15px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .escalation-level {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #e5e7eb;
        }

        .escalation-level:last-child {
            margin-bottom: 0;
        }

        .escalation-level-title {
            font-weight: 600;
            color: #374151;
            font-size: 13px;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #e5e7eb;
        }

        .escalation-detail {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .escalation-detail:last-child {
            margin-bottom: 0;
        }
            .container {
                padding: 15px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .filters-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .incidents-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons.working-state {
                grid-template-columns: 1fr;
            }
            
            .main-container {
                padding: 20px;
            }
            
            .incident-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div class="container" id="loginContainer">
        <div class="login-container">
            <h1 class="login-title">
                <span>üîß</span>
                <span class="login-logo">ABC.xyz</span>
                <span>Dashboard T√©cnico</span>
            </h1>
            <p class="login-subtitle">Accede con tu email para gestionar incidencias</p>
            <div class="input-group">
                <label class="input-label" for="emailInput">Email T√©cnico</label>
                <input type="email" class="input-field" id="emailInput" placeholder="ejemplo@empresa.com" autocomplete="email">
            </div>
            <button onclick="loginWithPIN()" class="verify-btn" id="loginBtn">
                üîê Acceder con PIN
            </button>
            <div id="loginError" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <!-- Header Principal -->
    <div class="header" id="mainHeader" style="display: none;">
        <div class="header-content">
            <div class="logo">
                <span>üîß</span>
                <span class="logo-text">ABC.xyz</span>
                <span id="dashboardTitle">Dashboard T√©cnico</span>
            </div>
            <div class="user-info">
                <div class="auth-status" id="authStatus">
                    <span id="authMessage">‚ö†Ô∏è Cargando...</span>
                </div>
                <button id="refreshBtn" class="refresh-button" onclick="refreshIncidents()">
                    üîÑ Actualizar
                </button>
                <p id="lastUpdate" class="last-update">--:--</p>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container" id="mainContainer">
        <!-- Stats Bar (Clickeable como filtros) -->
        <div class="stats-bar">
            <div class="stat-card" onclick="filterByStatus('all', this)">
                <div class="stat-number" id="totalCount" style="color: #6b7280;">0</div>
                <div class="stat-label">Todas</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('pending', this)">
                <div class="stat-number pending" id="pendingCount">0</div>
                <div class="stat-label">Pendientes</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('working', this)">
                <div class="stat-number working" id="workingCount">0</div>
                <div class="stat-label">Trabajando</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('expired', this)">
                <div class="stat-number expired" id="expiredCount">0</div>
                <div class="stat-label">Vencidas</div>
            </div>
        </div>

        <!-- Filters Bar - Solo Prioridad -->
        <div class="filters-bar">
            <div class="filter-group">
                <span class="filter-label">Prioridad:</span>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByPriority('all', this)">Todas</button>
                    <button class="filter-btn" onclick="filterByPriority('CR√çTICA', this)">Cr√≠tica</button>
                    <button class="filter-btn" onclick="filterByPriority('ALTA', this)">Alta</button>
                    <button class="filter-btn" onclick="filterByPriority('MEDIA', this)">Media</button>
                    <button class="filter-btn" onclick="filterByPriority('BAJA', this)">Baja</button>
                </div>
            </div>
        </div>

        <!-- Incidents Grid -->
        <div class="incidents-grid" id="incidentsContainer">
            <!-- Contenido din√°mico -->
        </div>
    </div>

    <!-- Success Overlay -->
    <div class="success-overlay" id="successOverlay" style="display: none;">
        <div class="success-message">
            <div class="success-icon" id="successIcon">‚úÖ</div>
            <div class="success-title" id="successTitle">Acci√≥n Completada</div>
            <div class="success-description" id="successDescription">La acci√≥n se ha procesado correctamente</div>
            <div class="countdown" id="countdown">Actualizando en 3 segundos...</div>
        </div>
    </div>

    <!-- PIN Modal -->
    <div class="modal-overlay" id="pinModal">
        <div class="pin-modal">
            <h3 class="pin-modal-title">üîê Verificaci√≥n de Seguridad</h3>
            <p style="text-align: center; color: #6b7280; margin-bottom: 25px;">Introduce tu PIN de 4 d√≠gitos</p>
            <input type="password" class="pin-input" id="pinInput" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
            <div class="pin-actions">
                <button class="pin-btn pin-btn-cancel" onclick="closePINModal()">Cancelar</button>
                <button class="pin-btn pin-btn-verify" id="verifyPinBtn" onclick="verifyPIN()" disabled>Verificar</button>
            </div>
            <div id="pinError" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <!-- Reason Modal -->
    <div class="modal-overlay" id="reasonModal">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">Selecciona el motivo</h3>
            <div class="reason-options" id="reasonOptions"></div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeReasonModal()">Cancelar</button>
                <button class="modal-btn btn-confirm" id="confirmBtn" onclick="confirmAction()" disabled>Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // üéØ VARIABLES GLOBALES
        // ==========================================
        let currentIncident = null;
        let currentTechnician = null;
        let isAuthenticated = false;
        let pendingAction = null;
        let selectedReason = null;
        let customText = '';
        let accessMode = 'none';
        let allIncidents = [];
        let currentStatusFilter = 'all';
        let currentPriorityFilter = 'all';

        // ==========================================
        // üîß MOTIVOS PROFESIONALES ACTUALIZADOS
        // ==========================================

        // ESTADO PENDIENTE - Motivos de RECHAZO
        const rejectReasons = [
            {
                id: 'ocupado_incidencia_critica',
                icon: 'üö®',
                title: 'Ocupado con incidencia cr√≠tica',
                description: 'Atendiendo incidencia prioritaria que no puedo abandonar'
            },
            {
                id: 'equipo_no_operativo',
                icon: 'üîß',
                title: 'Equipo/veh√≠culo no operativo',
                description: 'Mi equipo de trabajo presenta fallas que impiden intervenci√≥n'
            },
            {
                id: 'motivo_personal_urgente',
                icon: '‚ö†Ô∏è',
                title: 'Motivo personal urgente',
                description: 'Situaci√≥n personal que impide aceptar la asignaci√≥n'
            },
            {
                id: 'otro_motivo_rechazo',
                icon: '‚úèÔ∏è',
                title: 'Otro motivo',
                description: 'Especificar raz√≥n del rechazo',
                requiresText: true
            }
        ];

        // ESTADO PENDIENTE - Motivos de AYUDA INICIAL
        const helpReasonsInitial = [
            {
                id: 'fuera_especialidad',
                icon: 'üë®‚Äçüîß',
                title: 'Fuera de mi especialidad',
                description: 'Requiero apoyo de t√©cnico especializado para esta intervenci√≥n'
            },
            {
                id: 'recursos_no_disponibles',
                icon: 'üì¶',
                title: 'Recursos no disponibles',
                description: 'Necesito herramientas, repuestos o equipamiento espec√≠fico'
            },
            {
                id: 'apoyo_tecnico_necesario',
                icon: 'ü§ù',
                title: 'Apoyo t√©cnico necesario',
                description: 'Requiero segundo t√©cnico o supervisi√≥n especializada'
            },
            {
                id: 'otro_tipo_ayuda',
                icon: '‚úèÔ∏è',
                title: 'Otro tipo de ayuda',
                description: 'Especificar necesidad de apoyo',
                requiresText: true
            }
        ];

        // ESTADO TRABAJANDO - Motivos de TRANSFERIR
        const transferReasons = [
            {
                id: 'fin_turno',
                icon: '‚è∞',
                title: 'Fin de turno',
                description: 'Mi turno est√° finalizando, transferir a relevo'
            },
            {
                id: 'requiere_especialista',
                icon: 'üë®‚Äçüîß',
                title: 'Requiere especialista',
                description: 'Tras evaluaci√≥n, necesita t√©cnico con especializaci√≥n espec√≠fica'
            },
            {
                id: 'imposible_completar',
                icon: '‚õî',
                title: 'No puedo completar',
                description: 'Por circunstancias surgidas, no puedo finalizar la reparaci√≥n'
            },
            {
                id: 'otro_motivo_transferir',
                icon: '‚úèÔ∏è',
                title: 'Otro motivo',
                description: 'Especificar raz√≥n de transferencia',
                requiresText: true
            }
        ];

        // ESTADO TRABAJANDO - Motivos de APOYO DURANTE TRABAJO
        const supportReasonsWorking = [
            {
                id: 'recursos_adicionales',
                icon: 'üì¶',
                title: 'Recursos adicionales',
                description: 'Necesito herramientas, repuestos o equipamiento adicional'
            },
            {
                id: 'segundo_tecnico',
                icon: 'üë•',
                title: 'Segundo t√©cnico',
                description: 'Requiero apoyo de otro t√©cnico para completar la intervenci√≥n'
            },
            {
                id: 'autorizacion_procedimiento',
                icon: '‚úÖ',
                title: 'Autorizaci√≥n para proceder',
                description: 'Necesito autorizaci√≥n supervisor para el procedimiento a seguir'
            },
            {
                id: 'supervision_especializada',
                icon: 'üë®‚Äçüíº',
                title: 'Supervisi√≥n especializada',
                description: 'Requiero supervisi√≥n directa para intervenci√≥n cr√≠tica'
            },
            {
                id: 'otro_apoyo_trabajo',
                icon: '‚úèÔ∏è',
                title: 'Otro apoyo',
                description: 'Especificar tipo de apoyo requerido',
                requiresText: true
            }
        ];

        // ==========================================
        // üìã FUNCIONES DE INICIALIZACI√ìN
        // ==========================================
        window.addEventListener('DOMContentLoaded', function() {
            console.log('üîß ABC.xyz Dashboard T√©cnico iniciado');
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('tecnico') || urlParams.get('technician_email');
            const nombre = urlParams.get('nombre') || urlParams.get('technician_name');
            const incidentId = urlParams.get('id') || urlParams.get('incident_id');

            if (email) {
                document.getElementById('emailInput').value = email;
                if (nombre) {
                    currentTechnician = { email: email, name: decodeURIComponent(nombre) };
                }
                if (incidentId) {
                    accessMode = 'read_only';
                    loadTechnicianDashboard(email, false);
                }
            }
        });

        // ==========================================
        // üîê FUNCIONES DE LOGIN
        // ==========================================
        async function loginWithPIN() {
            const email = document.getElementById('emailInput').value.trim();
            if (!email || !email.includes('@')) {
                showError('Email v√°lido requerido', document.getElementById('loginError'));
                return;
            }
            showPINModal();
        }

        function showPINModal() {
            const modal = document.getElementById('pinModal');
            const pinInput = document.getElementById('pinInput');
            const verifyBtn = document.getElementById('verifyPinBtn');
            
            pinInput.value = '';
            verifyBtn.disabled = true;
            modal.classList.add('active');
            pinInput.focus();
            
            pinInput.oninput = () => verifyBtn.disabled = pinInput.value.length !== 4;
            pinInput.onkeypress = (e) => {
                if (e.key === 'Enter' && pinInput.value.length === 4) verifyPIN();
            };
        }

        function closePINModal() {
            document.getElementById('pinModal').classList.remove('active');
            pendingAction = null;
        }

        async function verifyPIN() {
            const pin = document.getElementById('pinInput').value;
            const email = document.getElementById('emailInput').value;
            const verifyBtn = document.getElementById('verifyPinBtn');

            if (pin.length !== 4) {
                showError('PIN de 4 d√≠gitos requerido', document.getElementById('pinError'));
                return;
            }

            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Verificando...';

            try {
                // Usar webhook existente para verificar PIN
                const response = await fetch('/api/webhook-respuesta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'validate_technician_pin',
                        technician_email: email,
                        pin: pin
                    })
                });

                const data = await response.json();
                console.log('üîê Respuesta verificaci√≥n PIN:', data);

                if (data.status === 'success') {
                    accessMode = 'full_access';
                    isAuthenticated = true;
                    
                    // Extraer nombre del t√©cnico correctamente
                    let technicianName = 'T√©cnico Autorizado';
                    if (data.technician && data.technician.name) {
                        // Si viene procesado desde Make
                        technicianName = data.technician.name;
                    } else if (data.technician_name) {
                        // Si viene como campo directo
                        technicianName = data.technician_name;
                    }
                    
                    currentTechnician = { 
                        email: email, 
                        name: technicianName,
                        department: data.technician?.department || 'No especificado',
                        level: data.technician?.level || 'No especificado'
                    };
                    
                    closePINModal();
                    await loadTechnicianDashboard(email, true);
                    
                    if (pendingAction) {
                        handleAction(pendingAction, currentIncident?.id);
                    }
                } else {
                    throw new Error(data.message || 'PIN incorrecto');
                }
            } catch (error) {
                console.error('Error verificando PIN:', error);
                showError('PIN incorrecto o error de conexi√≥n', document.getElementById('pinError'));
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verificar';
            }
        }

        // ==========================================
        // üìä FUNCIONES DE DASHBOARD
        // ==========================================
        async function loadTechnicianDashboard(email, fullAccess) {
            try {
                showLoading('Cargando incidencias...');
                
                // Usar webhook existente para obtener incidencias
                const response = await fetch('/api/webhook-respuesta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'get_assigned_incidents',
                        technician_email: email,
                        read_only: !fullAccess
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('üìä Datos incidencias recibidos:', data);
                    
                    allIncidents = data.incidents || [];
                    
                    // Si no se estableci√≥ currentTechnician en verifyPIN, usar datos de respuesta
                    if (!currentTechnician || !currentTechnician.name || currentTechnician.name === 'T√©cnico Autorizado') {
                        currentTechnician = {
                            email: email,
                            name: data.technician?.name || email.split('@')[0] || 'T√©cnico',
                            department: data.technician?.department,
                            level: data.technician?.level
                        };
                    }
                } else {
                    console.log('‚ö†Ô∏è Error cargando incidencias, mostrando vac√≠o');
                    allIncidents = [];
                }

                updateUI();
                renderIncidents();
                updateStats();
                
                // Mostrar dashboard
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainHeader').style.display = 'block';
                document.getElementById('mainContainer').style.display = 'block';
                
                // Actualizar header con nombre real del t√©cnico
                document.getElementById('dashboardTitle').textContent = `Dashboard - ${currentTechnician.name}`;
                document.getElementById('authMessage').textContent = fullAccess ? 
                    '‚úÖ Acceso completo' : 'üëÅÔ∏è Solo lectura';
                document.getElementById('authMessage').style.color = fullAccess ? '#059669' : '#d97706';
                
                updateLastUpdateTime();
                
            } catch (error) {
                console.error('Error cargando dashboard:', error);
                // En caso de error, mostrar sin incidencias
                allIncidents = [];
                renderIncidents();
                updateStats();
            }
        }

        // ==========================================
        // üé® FUNCIONES DE RENDERIZADO
        // ==========================================
        function renderIncidents() {
            const container = document.getElementById('incidentsContainer');
            let filteredIncidents = filterIncidents();
            
            console.log('üìä Total incidencias:', allIncidents.length);
            console.log('üîç Filtradas:', filteredIncidents.length);
            console.log('üìã Estados:', {
                pending: allIncidents.filter(i => getIncidentState(i) === 'pending').length,
                working: allIncidents.filter(i => getIncidentState(i) === 'working').length,
                expired: allIncidents.filter(i => getIncidentState(i) === 'expired').length
            });
            
            if (filteredIncidents.length === 0) {
                container.innerHTML = createNoIncidentsHTML(
                    'No hay incidencias',
                    'üìã',
                    'No se encontraron incidencias con los filtros seleccionados'
                );
                return;
            }

            const html = filteredIncidents.map(incident => renderIncidentCard(incident)).join('');
            container.innerHTML = html;
            
            // Iniciar timers SLA
            startAllSLATimers();
        }

        function renderIncidentCard(incident) {
            const priorityClass = getPriorityClass(incident.priority);
            const incidentState = getIncidentState(incident);
            const isWorking = incident.l0_response === '‚úÖ Aceptado';
            const escalationLevel = parseInt(incident.escalation_level) || 0;
            
            // INFORMACI√ìN ACTUAL DEL NIVEL (solo lo relevante)
            let currentLevelInfo = '';
            
            // Mostrar solo la informaci√≥n del nivel actual
            if (escalationLevel === 0) {
                if (incident.l0_response !== '‚≠ï Sin Respuesta') {
                    currentLevelInfo = `
                        <div class="info-row response">
                            <span>üìã Estado actual L0:</span>
                            <span>${incident.l0_response}</span>
                        </div>`;
                    
                    if (incident.l0_response === '‚ùå Rechazado' && incident.l0_reject_reason !== 'Sin motivo') {
                        currentLevelInfo += `
                            <div class="info-row">
                                <span>‚ùå Motivo rechazo:</span>
                                <span>${incident.l0_reject_reason}</span>
                            </div>`;
                    } else if (incident.l0_response === 'üü° Ayuda' && incident.l0_help_type !== 'Sin ayuda') {
                        currentLevelInfo += `
                            <div class="info-row">
                                <span>üÜò Tipo de ayuda:</span>
                                <span>${incident.l0_help_type}</span>
                            </div>`;
                    }
                }
            } else if (escalationLevel === 1) {
                if (incident.l1_response !== '‚≠ï Sin Respuesta') {
                    currentLevelInfo = `
                        <div class="info-row response">
                            <span>üìã Estado actual L1:</span>
                            <span>${incident.l1_response}</span>
                        </div>`;
                } else {
                    currentLevelInfo = `
                        <div class="info-row">
                            <span>üìã Estado actual L1:</span>
                            <span>‚è≥ Esperando respuesta t√©cnico backup</span>
                        </div>`;
                }
            } else if (escalationLevel === 2) {
                if (incident.l2_responses && incident.l2_responses !== '') {
                    currentLevelInfo = `
                        <div class="info-row response">
                            <span>üìã Estado actual L2:</span>
                            <span>${incident.l2_responses}</span>
                        </div>`;
                } else {
                    currentLevelInfo = `
                        <div class="info-row">
                            <span>üìã Estado actual L2:</span>
                            <span>‚è≥ Esperando respuesta equipo (${incident.l2_technicians_notified ? incident.l2_technicians_notified.split(',').length : 0} t√©cnicos notificados)</span>
                        </div>`;
                }
            } else if (escalationLevel >= 3) {
                currentLevelInfo = `
                    <div class="info-row response">
                        <span>üë®‚Äçüíº Estado actual L3:</span>
                        <span>${incident.l3_response || '‚è≥ Esperando decisi√≥n supervisor'}</span>
                    </div>`;
            }

            const infoRows = `
                <div class="incident-info">
                    <div class="info-row">
                        <span>üîß Equipo:</span>
                        <span>${incident.equipment}</span>
                    </div>
                    <div class="info-row">
                        <span>üè≠ Zona:</span>
                        <span>${incident.zone}</span>
                    </div>
                    <div class="info-row">
                        <span>üìù Estado:</span>
                        <span>${incident.status}</span>
                    </div>
                    <div class="info-row">
                        <span>üìà Nivel escalado:</span>
                        <span>L${escalationLevel} ${incident.escalation_paused === 'true' ? '(‚è∏Ô∏è Pausado)' : '(üîÑ Activo)'}</span>
                    </div>
                    <div class="info-row">
                        <span>‚è±Ô∏è Tiempo transcurrido:</span>
                        <span>${Math.floor(parseInt(incident.time_elapsed || 0) / 60)}h ${parseInt(incident.time_elapsed || 0) % 60}m</span>
                    </div>
                    ${currentLevelInfo}
                    <div class="info-row">
                        <span>üìã Descripci√≥n:</span>
                        <span style="font-size: 13px;">${incident.description}</span>
                    </div>
                    <div class="info-row" style="cursor: pointer;" onclick="toggleEscalationHistory('${incident.id}')">
                        <span style="color: #3b82f6;">üìä Ver historial completo escalado ‚ñº</span>
                        <span style="font-size: 12px; color: #6b7280;">Mostrar/ocultar</span>
                    </div>
                </div>
            `;

            // HISTORIAL COMPLETO DE ESCALADO (oculto por defecto)
            let fullEscalationHistory = '';
            
            // L0 Details
            if (incident.l0_response !== '‚≠ï Sin Respuesta') {
                fullEscalationHistory += `
                    <div class="escalation-level">
                        <div class="escalation-level-title">üìã NIVEL L0</div>`;
                
                fullEscalationHistory += `<div class="escalation-detail">Respuesta: ${incident.l0_response}</div>`;
                
                if (incident.l0_response === '‚ùå Rechazado' && incident.l0_reject_reason !== 'Sin motivo') {
                    fullEscalationHistory += `<div class="escalation-detail">Motivo: ${incident.l0_reject_reason}</div>`;
                }
                
                if (incident.l0_response === 'üü° Ayuda' && incident.l0_help_type !== 'Sin ayuda') {
                    fullEscalationHistory += `<div class="escalation-detail">Tipo ayuda: ${incident.l0_help_type}</div>`;
                }
                
                if (incident.l0_acceptance_date) {
                    fullEscalationHistory += `<div class="escalation-detail">Fecha aceptaci√≥n: ${new Date(incident.l0_acceptance_date).toLocaleString('es-ES')}</div>`;
                }
                
                if (incident.l0_rejection_date) {
                    fullEscalationHistory += `<div class="escalation-detail">Fecha rechazo: ${new Date(incident.l0_rejection_date).toLocaleString('es-ES')}</div>`;
                }
                
                fullEscalationHistory += `</div>`;
            }

            // L1 Details
            if (escalationLevel >= 1) {
                fullEscalationHistory += `
                    <div class="escalation-level">
                        <div class="escalation-level-title">üìã NIVEL L1 - BACKUP</div>`;
                
                if (incident.l1_response !== '‚≠ï Sin Respuesta') {
                    fullEscalationHistory += `<div class="escalation-detail">Respuesta: ${incident.l1_response}</div>`;
                    
                    if (incident.l1_response === '‚ùå Rechazado' && incident.l1_reject_reason !== 'Sin motivo') {
                        fullEscalationHistory += `<div class="escalation-detail">Motivo: ${incident.l1_reject_reason}</div>`;
                    }
                    
                    if (incident.l1_response === 'üü° Ayuda' && incident.l1_help_type !== 'Sin ayuda') {
                        fullEscalationHistory += `<div class="escalation-detail">Tipo ayuda: ${incident.l1_help_type}</div>`;
                    }
                } else {
                    fullEscalationHistory += `<div class="escalation-detail">Estado: ‚è≥ Sin respuesta</div>`;
                }
                
                fullEscalationHistory += `</div>`;
            }

            // L2 Details
            if (escalationLevel >= 2) {
                fullEscalationHistory += `
                    <div class="escalation-level">
                        <div class="escalation-level-title">üìã NIVEL L2 - EQUIPO</div>`;
                
                if (incident.l2_responses && incident.l2_responses !== '') {
                    fullEscalationHistory += `<div class="escalation-detail">Respuestas: ${incident.l2_responses}</div>`;
                } else {
                    fullEscalationHistory += `<div class="escalation-detail">Estado: ‚è≥ Sin respuestas</div>`;
                }
                
                if (incident.l2_reject_reasons !== 'Sin motivos') {
                    fullEscalationHistory += `<div class="escalation-detail">Motivos rechazo: ${incident.l2_reject_reasons}</div>`;
                }
                
                if (incident.l2_technicians_notified && incident.l2_technicians_notified !== 'Ninguno') {
                    const techCount = incident.l2_technicians_notified.split(',').length;
                    fullEscalationHistory += `<div class="escalation-detail">T√©cnicos notificados (${techCount}): ${incident.l2_technicians_notified}</div>`;
                }
                
                fullEscalationHistory += `</div>`;
            }

            // L3 Details
            if (escalationLevel >= 3) {
                fullEscalationHistory += `
                    <div class="escalation-level">
                        <div class="escalation-level-title">üë®‚Äçüíº NIVEL L3 - SUPERVISOR</div>`;
                
                if (incident.l3_response !== '‚≠ï Sin Respuesta') {
                    fullEscalationHistory += `<div class="escalation-detail">Decisi√≥n: ${incident.l3_response}</div>`;
                } else {
                    fullEscalationHistory += `<div class="escalation-detail">Estado: ‚è≥ Esperando decisi√≥n</div>`;
                }
                
                fullEscalationHistory += `</div>`;
            }

            // Acciones tomadas
            if (incident.actions_taken !== 'Sin acciones') {
                fullEscalationHistory += `
                    <div class="escalation-level">
                        <div class="escalation-level-title">‚ö° ACCIONES REALIZADAS</div>
                        <div class="escalation-detail">${incident.actions_taken}</div>
                    </div>`;
            }

            // Secci√≥n de escalado oculta
            const escalationHistorySection = `
                <div class="escalation-history" id="escalation-${incident.id}" style="display: none; background: #f8fafc; margin: 15px -10px; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <div class="escalation-title">üìä HISTORIAL COMPLETO DE ESCALADO</div>
                    ${fullEscalationHistory}
                </div>
            `;

            // CONTACTOS CORREGIDOS: Manager (Encargado zona) y Reporter (Reportador) son diferentes
            const contactsSection = `
                <div class="contacts-section">
                    <div class="contacts-title">üìû Contactos</div>
                    ${incident.manager ? `
                    <div class="contact-item">
                        <span class="contact-name">üëî Encargado zona: ${incident.manager}</span>
                        <a href="tel:${incident.manager_phone}" class="contact-phone">Llamar</a>
                    </div>` : ''}
                    ${incident.reporter ? `
                    <div class="contact-item">
                        <span class="contact-name">üìã Reportador: ${incident.reporter}</span>
                        <a href="tel:${incident.reporter_phone}" class="contact-phone">Llamar</a>
                    </div>` : ''}
                    <div class="contact-item" style="cursor: pointer;" onclick="toggleSupervisorContact('${incident.id}')">
                        <span class="contact-name" style="color: #3b82f6;">
                            üë®‚Äçüíº Ver supervisor ‚ñº
                        </span>
                        <span style="font-size: 12px; color: #6b7280;">Mostrar/ocultar</span>
                    </div>
                    <div class="contact-item supervisor-contact" id="supervisor-${incident.id}" style="display: none; background: #f8fafc; margin-left: 10px; border-radius: 4px; padding: 8px;">
                        <span class="contact-name">üë®‚Äçüíº Supervisor: ${incident.supervisor}</span>
                        <a href="tel:${incident.supervisor_phone}" class="contact-phone">Llamar</a>
                    </div>
                </div>
            `;

            // Timer SLA seg√∫n nivel de escalado
            let timerContent = '';
            if (incidentState === 'pending') {
                let slaField = 'sla_l0_end';
                if (escalationLevel === 1) slaField = 'sla_l1_backup_end';
                else if (escalationLevel === 2) slaField = 'sla_l2_equipo_end';
                else if (escalationLevel === 3) slaField = 'sla_l3_responsable_end';
                
                const slaEnd = incident[slaField];
                
                if (slaEnd && slaEnd !== '') {
                    timerContent = `
                        <div class="sla-section">
                            <div class="sla-time" id="timer-${incident.id}" data-sla-end="${slaEnd}">--:--</div>
                            <div class="sla-label">Tiempo restante para responder</div>
                            <div class="sla-level">NIVEL L${escalationLevel}</div>
                        </div>
                    `;
                }
            } else if (incidentState === 'expired') {
                const timeElapsed = parseInt(incident.time_elapsed) || 0;
                const hoursElapsed = Math.floor(timeElapsed / 60);
                const minutesElapsed = timeElapsed % 60;
                timerContent = `
                    <div class="expired-section">
                        <div class="expired-time">‚è∞ Vencida hace ${hoursElapsed}h ${minutesElapsed}m</div>
                        <div class="expired-label">SLA SUPERADO - NIVEL L${escalationLevel}</div>
                        <div class="escalation-info">‚ö†Ô∏è ${incident.escalation_paused === 'true' ? 'Escalado pausado por supervisor' : 'Contacta por tel√©fono'}</div>
                    </div>
                `;
            }

            // Botones de acci√≥n
            const actionButtons = renderActionButtons(incident, isWorking);

            return `
                <div class="incident-card">
                    <div class="incident-header">
                        <div class="incident-id">${incident.id}</div>
                        <div class="priority-badge ${priorityClass}">${incident.priority.replace(/üî¥|üü†|üü°|üü¢/g, '').trim()}</div>
                    </div>
                    ${infoRows}
                    ${escalationHistorySection}
                    ${contactsSection}
                    ${timerContent}
                    ${actionButtons}
                </div>
            `;
        }

        function renderActionButtons(incident, isWorking) {
            const canRespond = (accessMode === 'full_access');
            const lockClass = canRespond ? '' : 'btn-disabled';
            
            if (isWorking) {
                // Estado TRABAJANDO - 3 botones
                return `
                    <div class="action-buttons working-state">
                        <button class="action-btn btn-complete ${lockClass}" 
                                onclick="handleAction('completar', '${incident.id}')" 
                                ${!canRespond ? 'disabled' : ''}>
                            ‚úÖ COMPLETAR
                        </button>
                        <button class="action-btn btn-transfer ${lockClass}" 
                                onclick="handleAction('transferir', '${incident.id}')" 
                                ${!canRespond ? 'disabled' : ''}>
                            üîÑ TRANSFERIR
                        </button>
                        <button class="action-btn btn-support ${lockClass}" 
                                onclick="handleAction('solicitar_apoyo', '${incident.id}')" 
                                ${!canRespond ? 'disabled' : ''}>
                            üÜò SOLICITAR APOYO
                        </button>
                    </div>
                `;
            } else {
                // Estado PENDIENTE - 3 botones
                return `
                    <div class="action-buttons">
                        <button class="action-btn btn-accept ${lockClass}" 
                                onclick="handleAction('acepto', '${incident.id}')" 
                                ${!canRespond ? 'disabled' : ''}>
                            ‚úÖ ACEPTO
                        </button>
                        <button class="action-btn btn-reject ${lockClass}" 
                                onclick="handleAction('rechazo', '${incident.id}')" 
                                ${!canRespond ? 'disabled' : ''}>
                            ‚ùå RECHAZO
                        </button>
                        <button class="action-btn btn-help ${lockClass}" 
                                onclick="handleAction('solicitar_ayuda', '${incident.id}')" 
                                ${!canRespond ? 'disabled' : ''}>
                            üÜò SOLICITAR AYUDA
                        </button>
                    </div>
                `;
            }
        }

        // ==========================================
        // üîÑ FUNCIONES DE ACCI√ìN
        // ==========================================
        function handleAction(action, incidentId) {
            currentIncident = allIncidents.find(inc => inc.id === incidentId);
            if (!currentIncident) {
                console.error('Incidencia no encontrada:', incidentId);
                return;
            }

            if (accessMode !== 'full_access') {
                pendingAction = action;
                showPINModal();
                return;
            }

            if (action === 'acepto') {
                // Acepto directo sin modal
                confirmAction();
            } else if (action === 'completar') {
                // Completar con descripci√≥n obligatoria
                showCompletionModal();
            } else {
                // Mostrar modal de motivos
                showReasonModal(action);
            }
        }

        function showReasonModal(action) {
            pendingAction = action;
            selectedReason = null;
            customText = '';

            const modal = document.getElementById('reasonModal');
            const title = document.getElementById('modalTitle');
            const options = document.getElementById('reasonOptions');
            const confirmBtn = document.getElementById('confirmBtn');

            let reasons = [];
            let modalTitle = '';
            let buttonText = '';

            switch(action) {
                case 'rechazo':
                    modalTitle = '‚ùå Motivo del Rechazo';
                    buttonText = 'Rechazar';
                    reasons = rejectReasons;
                    break;
                case 'solicitar_ayuda':
                    modalTitle = 'üÜò Tipo de Ayuda Inicial';
                    buttonText = 'Solicitar Ayuda';
                    reasons = helpReasonsInitial;
                    break;
                case 'transferir':
                    modalTitle = 'üîÑ Motivo de Transferencia';
                    buttonText = 'Transferir';
                    reasons = transferReasons;
                    break;
                case 'solicitar_apoyo':
                    modalTitle = 'üÜò Tipo de Apoyo Necesario';
                    buttonText = 'Solicitar Apoyo';
                    reasons = supportReasonsWorking;
                    break;
            }

            title.textContent = modalTitle;
            confirmBtn.textContent = buttonText;

            options.innerHTML = reasons.map(reason => `
                <div class="reason-option" onclick="selectReason('${reason.id}', ${reason.requiresText || false})">
                    <div class="reason-icon">${reason.icon}</div>
                    <div class="reason-text">
                        <div class="reason-title">${reason.title}</div>
                        <div class="reason-description">${reason.description}</div>
                    </div>
                </div>
                ${reason.requiresText ? `
                    <div class="custom-reason-input-container" id="customInput-${reason.id}" style="display: none;">
                        <textarea class="custom-reason-input" 
                                placeholder="Especifica el motivo..." 
                                maxlength="200"
                                oninput="updateCustomText(this.value)"></textarea>
                    </div>
                ` : ''}
            `).join('');

            confirmBtn.disabled = true;
            modal.classList.add('active');
        }

        function selectReason(reasonId, requiresText = false) {
            selectedReason = reasonId;
            customText = '';

            // Limpiar selecciones anteriores
            document.querySelectorAll('.reason-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            document.querySelectorAll('.custom-reason-input-container').forEach(container => {
                container.style.display = 'none';
            });

            // Seleccionar nueva opci√≥n
            event.currentTarget.classList.add('selected');
            
            if (requiresText) {
                const customContainer = document.getElementById(`customInput-${reasonId}`);
                if (customContainer) {
                    customContainer.style.display = 'block';
                    const textarea = customContainer.querySelector('textarea');
                    textarea.focus();
                }
                document.getElementById('confirmBtn').disabled = true;
            } else {
                document.getElementById('confirmBtn').disabled = false;
            }
        }

        function updateCustomText(text) {
            customText = text.trim();
            document.getElementById('confirmBtn').disabled = customText.length < 10;
        }

        function closeReasonModal() {
            document.getElementById('reasonModal').classList.remove('active');
            pendingAction = null;
            selectedReason = null;
            customText = '';
        }

        async function confirmAction() {
            if (!pendingAction || !currentIncident) return;

            const confirmBtn = document.getElementById('confirmBtn');
            const originalText = confirmBtn?.textContent || 'Confirmar';

            try {
                if (confirmBtn) {
                    confirmBtn.disabled = true;
                    confirmBtn.textContent = 'Procesando...';
                }

                // Payload para Make
                const payload = {
                    timestamp: new Date().toISOString(),
                    action: pendingAction,
                    incident_id: currentIncident.id,
                    technician_email: currentTechnician.email,
                    technician_name: currentTechnician.name,
                    escalation_level: getCurrentEscalationLevel(currentIncident),
                    reason_id: selectedReason,
                    custom_text: customText,
                    current_state: currentIncident.status === 'Trabajando' ? 'trabajando' : 'pendiente',
                    user_agent: navigator.userAgent,
                    ip_address: 'client-side' // Se obtiene en servidor
                };

                console.log('üì§ Enviando a Make:', payload);

                const response = await fetch('/api/webhook-respuesta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.status === 'success') {
                    closeReasonModal();
                    showSuccessMessage(data);
                } else {
                    throw new Error(data.message || 'Error procesando respuesta');
                }

            } catch (error) {
                console.error('Error enviando respuesta:', error);
                showError('Error de conexi√≥n. Int√©ntalo m√°s tarde.');
            } finally {
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = originalText;
                }
            }
        }

        // ==========================================
        // üìä FUNCIONES AUXILIARES
        // ==========================================
        function filterIncidents() {
            return allIncidents.filter(incident => {
                const statusMatch = currentStatusFilter === 'all' || 
                    getIncidentState(incident) === currentStatusFilter;
                const priorityMatch = currentPriorityFilter === 'all' || 
                    incident.priority === currentPriorityFilter;
                return statusMatch && priorityMatch;
            });
        }

        function getIncidentState(incident) {
            if (incident.status === 'Trabajando') return 'working';
            if (incident.sla_end && new Date(incident.sla_end) < new Date()) return 'expired';
            return 'pending';
        }

        function getCurrentEscalationLevel(incident) {
            return incident.escalation_level === 0 ? 'L0' : 
                   incident.escalation_level === 1 ? 'L1' : 
                   incident.escalation_level === 2 ? 'L2' : 'L3';
        }

        function getPriorityClass(priority) {
            // Limpiar emojis y obtener solo el texto
            const cleanPriority = priority.replace(/üî¥|üü†|üü°|üü¢/g, '').trim();
            
            const priorityMap = {
                'CR√çTICA': 'priority-critica',
                'ALTA': 'priority-alta', 
                'MEDIA': 'priority-media',
                'BAJA': 'priority-baja'
            };
            return priorityMap[cleanPriority] || 'priority-media';
        }

        function getIncidentState(incident) {
            // Determinar estado basado en datos reales de Notion
            if (incident.l0_response === '‚úÖ Aceptado') {
                return 'working';
            }
            
            // Si el escalado est√° pausado y hay respuesta, considerarla working
            if (incident.escalation_paused === 'true' && incident.l0_response !== '‚≠ï Sin Respuesta') {
                return 'working';
            }
            
            // Si tiene tiempo transcurrido muy alto, considerarla vencida
            const timeElapsed = parseInt(incident.time_elapsed) || 0;
            const hoursElapsed = timeElapsed / 60;
            
            // Si tiene m√°s de 2 horas o SLA vencido
            if (hoursElapsed > 2) {
                return 'expired';
            }
            
            // Verificar si hay SLA espec√≠fico vencido
            const escalationLevel = parseInt(incident.escalation_level) || 0;
            let slaField = 'sla_l0_end';
            if (escalationLevel === 1) slaField = 'sla_l1_backup_end';
            else if (escalationLevel === 2) slaField = 'sla_l2_equipo_end';
            else if (escalationLevel === 3) slaField = 'sla_l3_responsable_end';
            
            const slaEnd = incident[slaField];
            if (slaEnd && new Date(slaEnd) < new Date()) {
                return 'expired';
            }
            
            // Si no tiene respuesta y no est√° vencida, es pendiente
            if (incident.l0_response === '‚≠ï Sin Respuesta') {
                return 'pending';
            }
            
            // Por defecto, pendiente
            return 'pending';
        }

        function updateStats() {
            const totalCount = allIncidents.length;
            const pendingCount = allIncidents.filter(i => getIncidentState(i) === 'pending').length;
            const workingCount = allIncidents.filter(i => getIncidentState(i) === 'working').length;
            const expiredCount = allIncidents.filter(i => getIncidentState(i) === 'expired').length;

            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('workingCount').textContent = workingCount;
            document.getElementById('expiredCount').textContent = expiredCount;
        }

        // ==========================================
        // üìû FUNCIONES CONTACTOS Y ESCALADO DROPDOWN
        // ==========================================
        function toggleSupervisorContact(incidentId) {
            const supervisorDiv = document.getElementById(`supervisor-${incidentId}`);
            const isVisible = supervisorDiv.style.display !== 'none';
            
            supervisorDiv.style.display = isVisible ? 'none' : 'block';
            
            // Actualizar texto del bot√≥n
            const toggleButton = supervisorDiv.previousElementSibling.querySelector('.contact-name');
            if (toggleButton) {
                toggleButton.textContent = isVisible ? 
                    'üë®‚Äçüíº Ver supervisor ‚ñº' : 
                    'üë®‚Äçüíº Ocultar supervisor ‚ñ≤';
            }
        }

        function toggleEscalationHistory(incidentId) {
            const historyDiv = document.getElementById(`escalation-${incidentId}`);
            const isVisible = historyDiv.style.display !== 'none';
            
            historyDiv.style.display = isVisible ? 'none' : 'block';
            
            // Actualizar texto del bot√≥n
            const toggleButton = historyDiv.previousElementSibling.querySelector('[onclick*="toggleEscalationHistory"]');
            if (toggleButton) {
                const span = toggleButton.querySelector('span');
                if (span) {
                    span.textContent = isVisible ? 
                        'üìä Ver historial completo escalado ‚ñº' : 
                        'üìä Ocultar historial escalado ‚ñ≤';
                }
            }
        }

        function startAllSLATimers() {
            allIncidents.forEach(incident => {
                if (incident.sla_end && getIncidentState(incident) === 'pending') {
                    startSLATimer(incident.id, incident.sla_end);
                }
            });
        }

        function startSLATimer(incidentId, slaEnd) {
            const timerElement = document.getElementById(`timer-${incidentId}`);
            if (!timerElement) return;

            function updateTimer() {
                const now = new Date().getTime();
                const end = new Date(slaEnd).getTime();
                const diff = end - now;

                if (diff <= 0) {
                    timerElement.textContent = '‚è∞ VENCIDA';
                    timerElement.className = 'sla-time critical';
                    return;
                }

                const minutes = Math.floor(diff / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                const timeText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                timerElement.textContent = timeText;

                const totalSLATime = 30 * 60 * 1000; // 30 minutos
                const percentage = (diff / totalSLATime) * 100;

                if (percentage > 50) {
                    timerElement.className = 'sla-time good';
                } else if (percentage > 20) {
                    timerElement.className = 'sla-time warning';
                } else {
                    timerElement.className = 'sla-time critical';
                }
            }

            updateTimer();
            setInterval(updateTimer, 1000);
        }

        // ==========================================
        // üîÑ FUNCIONES DE FILTRO ACTUALIZADAS
        // ==========================================
        function filterByStatus(status, buttonElement) {
            currentStatusFilter = status;
            
            // Actualizar visual de las tarjetas stats
            document.querySelectorAll('.stat-card').forEach(card => {
                card.classList.remove('active');
            });
            buttonElement.classList.add('active');
            
            renderIncidents();
        }

        function filterByPriority(priority, buttonElement) {
            currentPriorityFilter = priority;
            
            buttonElement.closest('.filter-buttons').querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            buttonElement.classList.add('active');
            
            renderIncidents();
        }

        // ==========================================
        // ‚ú® FUNCIONES DE UI
        // ==========================================
        function showSuccessMessage(data) {
            const messages = {
                'acepto': '‚úÖ Incidencia aceptada correctamente. ¬°Puedes empezar a trabajar!',
                'rechazo': '‚ùå Incidencia rechazada. Se escalar√° autom√°ticamente.',
                'solicitar_ayuda': 'üÜò Ayuda solicitada. Un supervisor se pondr√° en contacto.',
                'completar': '‚úÖ Incidencia completada exitosamente.',
                'transferir': 'üîÑ Incidencia transferida correctamente.',
                'solicitar_apoyo': 'üÜò Apoyo solicitado. Un supervisor gestionar√° tu petici√≥n.'
            };

            const icons = {
                'acepto': '‚úÖ',
                'rechazo': '‚ùå', 
                'solicitar_ayuda': 'üÜò',
                'completar': '‚úÖ',
                'transferir': 'üîÑ',
                'solicitar_apoyo': 'üÜò'
            };

            const makeMessage = data.message || messages[pendingAction];
            const actionIcon = icons[pendingAction];

            const overlay = document.getElementById('successOverlay');
            const iconElement = document.getElementById('successIcon');
            const titleElement = document.getElementById('successTitle');
            const descriptionElement = document.getElementById('successDescription');
            const countdownElement = document.getElementById('countdown');

            iconElement.textContent = actionIcon;
            titleElement.textContent = 'Acci√≥n Completada';
            descriptionElement.textContent = makeMessage;

            let countdown = 5;
            countdownElement.textContent = `Actualizando en ${countdown} segundos...`;

            overlay.style.display = 'flex';

            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    countdownElement.textContent = `Actualizando en ${countdown} segundos...`;
                } else {
                    clearInterval(countdownInterval);
                    overlay.style.display = 'none';
                    refreshIncidents();
                }
            }, 1000);

            // Click para cerrar
            overlay.onclick = function(e) {
                if (e.target === overlay) {
                    clearInterval(countdownInterval);
                    overlay.style.display = 'none';
                    refreshIncidents();
                }
            };
        }

        function updateUI() {
            updateLastUpdateTime();
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('lastUpdate').textContent = `√öltima actualizaci√≥n: ${timeString}`;
        }

        async function refreshIncidents() {
            if (!currentTechnician) return;
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.textContent = 'üîÑ Actualizando...';
            try {
                await loadTechnicianDashboard(currentTechnician.email, accessMode === 'full_access');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ Actualizar';
            }
        }

        function showLoading(msg = 'Cargando...') {
            document.getElementById('incidentsContainer').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>${msg}</div>
                </div>`;
        }

        function createNoIncidentsHTML(title, icon, desc) {
            return `
                <div class="no-incidents">
                    <div class="no-incidents-icon">${icon}</div>
                    <h3 class="no-incidents-title">${title}</h3>
                    <p class="no-incidents-description">${desc}</p>
                </div>`;
        }

        function showError(msg, el = null) {
            if (el) {
                el.textContent = msg;
                el.style.display = 'block';
                setTimeout(() => el.style.display = 'none', 5000);
            } else {
                console.error('Error:', msg);
                alert(msg); // Fallback
            }
        }

        // ==========================================
        // üéØ EVENTOS Y CONTROLES
        // ==========================================
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.getElementById('loginContainer').style.display !== 'none') {
                const input = document.getElementById('emailInput');
                if (input.value.trim()) loginWithPIN();
            }
            if (e.key === 'Escape') {
                closeReasonModal();
                closePINModal();
            }
        });

        document.getElementById('reasonModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeReasonModal();
        });

        document.getElementById('pinModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closePINModal();
        });

        // ==========================================
        // üìù MODAL DE COMPLETAR (con textarea obligatorio)
        // ==========================================
        function showCompletionModal() {
            const modal = document.getElementById('reasonModal');
            const title = document.getElementById('modalTitle');
            const options = document.getElementById('reasonOptions');
            const confirmBtn = document.getElementById('confirmBtn');

            title.textContent = '‚úÖ Completar Incidencia';
            confirmBtn.textContent = 'Completar';
            
            options.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #374151; font-weight: 600; margin-bottom: 10px;">
                        Describe las acciones realizadas para resolver la incidencia:
                    </p>
                    <textarea 
                        class="custom-reason-input" 
                        placeholder="Ejemplo: Reemplazada bomba defectuosa, verificado funcionamiento correcto, sistema operativo..." 
                        maxlength="500"
                        oninput="updateCompletionText(this.value)"
                        style="height: 120px;"></textarea>
                    <div style="text-align: right; font-size: 12px; color: #6b7280; margin-top: 5px;">
                        M√≠nimo 20 caracteres
                    </div>
                </div>
            `;

            confirmBtn.disabled = true;
            modal.classList.add('active');
            
            // Focus en textarea
            setTimeout(() => {
                const textarea = options.querySelector('textarea');
                if (textarea) textarea.focus();
            }, 100);
        }

        function updateCompletionText(text) {
            customText = text.trim();
            document.getElementById('confirmBtn').disabled = customText.length < 20;
        }

        // ==========================================
        // üì± RESPONSIVE Y DEBUGGING
        // ==========================================
        console.log('üîß Dashboard ABC.xyz - Versi√≥n Profesional cargada');
        console.log('üìã Motivos configurados:', {
            rechazo: rejectReasons.length,
            ayuda_inicial: helpReasonsInitial.length,
            transferir: transferReasons.length,
            apoyo_trabajo: supportReasonsWorking.length
        });

    </script>
</body>
</html>
